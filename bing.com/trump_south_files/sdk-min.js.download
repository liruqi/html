var clienttelemetry_build;(function(e){e.version="2.7.1"})(clienttelemetry_build||(clienttelemetry_build={}));var Microsoft;(function(e){var t;(function(e){(function(e){e[e["BT_STOP"]=0]="BT_STOP";e[e["BT_STOP_BASE"]=1]="BT_STOP_BASE";e[e["BT_BOOL"]=2]="BT_BOOL";e[e["BT_UINT8"]=3]="BT_UINT8";e[e["BT_UINT16"]=4]="BT_UINT16";e[e["BT_UINT32"]=5]="BT_UINT32";e[e["BT_UINT64"]=6]="BT_UINT64";e[e["BT_FLOAT"]=7]="BT_FLOAT";e[e["BT_DOUBLE"]=8]="BT_DOUBLE";e[e["BT_STRING"]=9]="BT_STRING";e[e["BT_STRUCT"]=10]="BT_STRUCT";e[e["BT_LIST"]=11]="BT_LIST";e[e["BT_SET"]=12]="BT_SET";e[e["BT_MAP"]=13]="BT_MAP";e[e["BT_INT8"]=14]="BT_INT8";e[e["BT_INT16"]=15]="BT_INT16";e[e["BT_INT32"]=16]="BT_INT32";e[e["BT_INT64"]=17]="BT_INT64";e[e["BT_WSTRING"]=18]="BT_WSTRING";e[e["BT_UNAVAILABLE"]=127]="BT_UNAVAILABLE"})(e.BondDataType||(e.BondDataType={}));var t=e.BondDataType;(function(e){e[e["MARSHALED_PROTOCOL"]=0]="MARSHALED_PROTOCOL";e[e["MAFIA_PROTOCOL"]=17997]="MAFIA_PROTOCOL";e[e["COMPACT_PROTOCOL"]=16963]="COMPACT_PROTOCOL";e[e["JSON_PROTOCOL"]=21322]="JSON_PROTOCOL";e[e["PRETTY_JSON_PROTOCOL"]=20554]="PRETTY_JSON_PROTOCOL";e[e["SIMPLE_PROTOCOL"]=20563]="SIMPLE_PROTOCOL"})(e.ProtocolType||(e.ProtocolType={}));var n=e.ProtocolType})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var Microsoft;(function(e){var t;(function(e){var t;(function(e){var t=function(){function e(){this._buffer=[]}e.prototype.Add=function(e){var t=0;for(;t<this._buffer.length;++t){if(this._buffer[t]==e){break}}if(t==this._buffer.length){this._buffer.push(e)}};e.prototype.Count=function(){return this._buffer.length};e.prototype.GetBuffer=function(){return this._buffer};return e}();e.Set=t;var n=function(){function e(){this._buffer=[]}e.prototype.Add=function(e,t){if(this._getIndex(e)==-1){this._buffer.push({Key:e,Value:t})}};e.prototype.AddOrReplace=function(e,t){var n=this._getIndex(e);if(n>=0){this._buffer[n]={Key:e,Value:t}}else{this._buffer.push({Key:e,Value:t})}};e.prototype.Remove=function(e){var t=this._getIndex(e);if(t>=0){this._buffer.splice(t,1)}};e.prototype.Count=function(){return this._buffer.length};e.prototype.GetBuffer=function(){return this._buffer};e.prototype.ContainsKey=function(e){if(this._getIndex(e)>=0){return true}return false};e.prototype.Get=function(e){var t=this._getIndex(e);if(t>=0){return this._buffer[t].Value}return null};e.prototype._getIndex=function(e){var t=0;var n=-1;for(;t<this._buffer.length;++t){if(this._buffer[t].Key==e){n=t;break}}return n};return e}();e.Map=n})(t=e.Collections||(e.Collections={}))})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var Microsoft;(function(e){var t;(function(t){var n;(function(e){var n=function(){function e(){}e.GetBytes=function(e){var t=[];for(var n=0;n<e.length;++n){var r=e.charCodeAt(n);if(r<128){t.push(r)}else if(r<2048){t.push(192|r>>6,128|r&63)}else if(r<55296||r>=57344){t.push(224|r>>12,128|r>>6&63,128|r&63)}else{r=65536+((r&1023)<<10|e.charCodeAt(++n)&1023);t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|r&63)}}return t};return e}();e.Utf8=n;var r=function(){function e(){}e.GetString=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var n=[];var r=e.length%3;var i,a,o;var s=function(e){return[t.charAt(e>>18&63),t.charAt(e>>12&63),t.charAt(e>>6&63),t.charAt(e&63)].join("")};for(i=0,o=e.length-r;i<o;i+=3){a=(e[i]<<16)+(e[i+1]<<8)+e[i+2];n.push(s(a))}switch(r){case 1:a=e[e.length-1];n.push(t.charAt(a>>2));n.push(t.charAt(a<<4&63));n.push("==");break;case 2:a=(e[e.length-2]<<8)+e[e.length-1];n.push(t.charAt(a>>10));n.push(t.charAt(a>>4&63));n.push(t.charAt(a<<2&63));n.push("=");break}return n.join("")};return e}();e.Base64=r;var a=function(){function e(){}e.GetBytes=function(e){var t=[];while(e&4294967168){t.push(e&127|128);e>>>=7}t.push(e&127);return t};return e}();e.Varint=a;var o=function(){function e(){}e.GetBytes=function(e){var t=e.low;var n=e.high;var r=[];while(n||4294967168&t){r.push(t&127|128);t=(n&127)<<25|t>>>7;n>>>=7}r.push(t&127);return r};return e}();e.Varint64=o;var s=function(){function e(){}e.GetBytes=function(e){if(t.BrowserChecker.IsDataViewSupport()){var n=new DataView(new ArrayBuffer(4));n.setFloat32(0,e,true);var r=[];for(var a=0;a<4;++a){r.push(n.getUint8(a))}return r}else{return i.ConvertNumberToArray(e,false)}};return e}();e.Float=s;var u=function(){function e(){}e.GetBytes=function(e){if(t.BrowserChecker.IsDataViewSupport()){var n=new DataView(new ArrayBuffer(8));n.setFloat64(0,e,true);var r=[];for(var a=0;a<8;++a){r.push(n.getUint8(a))}return r}else{return i.ConvertNumberToArray(e,true)}};return e}();e.Double=u;var c=function(){function e(){}e.EncodeZigzag16=function(e){e=t.Number.ToInt16(e);return e<<1^e>>2*8-1};e.EncodeZigzag32=function(e){e=t.Number.ToInt32(e);return e<<1^e>>4*8-1};e.EncodeZigzag64=function(e){var n=e.low;var r=e.high;var i=r<<1|n>>>31;var a=n<<1;if(r&2147483648){i=~i;a=~a}var o=new t.UInt64("0");o.low=a;o.high=i;return o};return e}();e.Zigzag=c})(n=t.Encoding||(t.Encoding={}));var r;(function(n){var r=function(){function e(){}e.GetString=function(e){var t=[];for(var n=0;n<e.length;++n){var r=e[n];if(r<=191){t.push(String.fromCharCode(r))}else if(r<=223){var i=e[++n];t.push(String.fromCharCode((r&31)<<6|i&63))}else if(r<=239){var i=e[++n];var a=e[++n];t.push(String.fromCharCode((r&15)<<12|(i&63)<<6|a&63))}else{var i=e[++n];var a=e[++n];var o=e[++n];r=(r&7)<<18|(i&63)<<12|(a&63)<<6|o&63;r-=65536;t.push(String.fromCharCode(55296|r>>10&1023));t.push(String.fromCharCode(56320|r&1023))}}return t.join("")};return e}();n.Utf8=r;var a=function(){function e(){}e.GetBytes=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var n=[];for(var r=0;r<e.length;++r){var i=t.indexOf(e.charAt(r++));var a=t.indexOf(e.charAt(r++));var o=t.indexOf(e.charAt(r++));var s=t.indexOf(e.charAt(r));n.push(i<<2|a>>4);if(o>=0){n.push(a<<4&240|o>>2);if(s>=0){n.push(o<<6&192|s)}}}return n};return e}();n.Base64=a;var o=function(){function t(){}t.GetInt64=function(t){var n=new e.Bond.Int64("0");var r=this._Read(t);n.low=r[0];if(r.length>1){n.high=r[1]}return n};t.GetNumber=function(e){return this._Read(e)[0]};t._Read=function(e){var t=[];var n=0;var r=true;var i=0;while(r){var a=e.shift();r=(a&128)!=0;a=a&127;if(i<28){n|=a<<i;i+=7}else{n|=a<<i;t.push(n);n=a>>4;i=3;break}}while(r){var a=e.shift();r=(a&128)!=0;a=a&127;n|=a<<i;i+=7;if(i>=32){break}}t.push(n);return t};return t}();n.Varint=o;var s=function(){function e(){}e.GetNumber=function(e){if(t.BrowserChecker.IsDataViewSupport()){var n=new DataView(new ArrayBuffer(4));for(var r=0;r<4;++r){n.setUint8(r,e[r])}return n.getFloat32(0,true)}else{return i.ConvertArrayToNumber(e,false)}};return e}();n.Float=s;var u=function(){function e(){}e.GetNumber=function(e){if(t.BrowserChecker.IsDataViewSupport()){var n=new DataView(new ArrayBuffer(8));for(var r=0;r<8;++r){n.setUint8(r,e[r])}return n.getFloat64(0,true)}else{return i.ConvertArrayToNumber(e,true)}};return e}();n.Double=u;var c=function(){function t(){}t.DecodeZigzag16=function(e){return((65535&e)>>>1^-(e&1))<<16>>16};t.DecodeZigzag32=function(e){return e>>>1^-(e&1)};t.DecodeZigzag64=function(t){var n=t.high&1;var r=t.high>>>1;var i=t.low&1;var a=t.low>>>1;a=n<<31|a;if(i){a^=4294967295;r^=4294967295}var o=new e.Bond.UInt64("0");o.low=a;o.high=r;return o};return t}();n.Zigzag=c})(r=t.Decoding||(t.Decoding={}));var i=function(){function e(){}e.ConvertNumberToArray=function(e,t){if(!e){return t?this._doubleZero:this._floatZero}var n=t?11:8;var r=t?52:23;var i=(1<<n-1)-1;var a=1-i;var o=i;var s=e<0?1:0;e=Math.abs(e);var u=Math.floor(e);var c=e-u;var d=2*(i+2)+r;var l=new Array(d);var f=0;while(f<d){l[f++]=0}f=i+2;while(f&&u){l[--f]=u%2;u=Math.floor(u/2)}f=i+1;while(f<d-1&&c>0){c*=2;if(c>=1){l[++f]=1;--c}else{l[++f]=0}}var p=0;for(;p<d&&!l[p];++p);var v=i+1-p;var h=p+r;if(l[h+1]){for(f=h;f>p;--f){if(l[f]=1-l[f]){break}}if(f==p){++v}}if(v>o||u){if(s){return t?this._doubleNegInifinity:this._floatNegInifinity}else{return t?this._doubleInifinity:this._floatInifinity}}else if(v<a){return t?this._doubleZero:this._floatZero}if(t){var m=0;for(f=0;f<20;++f){m=m<<1|l[++p]}var g=0;for(;f<52;++f){g=g<<1|l[++p]}m|=v+i<<20;m=s<<31|m&2147483647;var y=[g&255,g>>8&255,g>>16&255,g>>>24,m&255,m>>8&255,m>>16&255,m>>>24];return y}else{var S=0;for(f=0;f<23;++f){S=S<<1|l[++p]}S|=v+i<<23;S=s<<31|S&2147483647;var y=[S&255,S>>8&255,S>>16&255,S>>>24];return y}};e.ConvertArrayToNumber=function(e,n){var r=n?11:8;var i=(1<<r-1)-1;var a=(e[n?7:3]&128)!=0;var o=n?(e[7]&127)<<4|(e[6]&240)>>4:(e[3]&127)<<1|(e[2]&128)>>7;if(o==255){throw new t.Exception("Not a valid float/double buffer.")}var s=1;var u=1;if(n){var c=(e[6]&15)<<28|(e[5]&255)<<20|(e[4]&255)<<12;var d=e[3]<<24|(e[2]&255)<<16|(e[1]&255)<<8|e[0]&255;if(!o&&!c&&!d){return 0}for(var l=0;l<20;++l){u/=2;if(c<0){s+=u}c<<=1}for(var l=0;l<32;++l){u/=2;if(d<0){s+=u}d<<=1}}else{var f=(e[2]&127)<<25|(e[1]&255)<<17|(e[0]&255)<<9;if(!o&&!f){return 0}for(var l=0;l<23;++l){u/=2;if(f<0){s+=u}f<<=1}}s*=Math.pow(2,o-i);return a?0-s:s};e._floatZero=[0,0,0,0];e._doubleZero=[0,0,0,0,0,0,0,0];e._floatInifinity=[0,0,128,127];e._floatNegInifinity=[0,0,128,255];e._doubleInifinity=[0,0,0,0,0,0,240,127];e._doubleNegInifinity=[0,0,0,0,0,0,240,255];return e}()})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var Microsoft;(function(e){var t;(function(e){var t;(function(t){var n=function(){function t(){this._buffer=[]}t.prototype.WriteByte=function(t){this._buffer.push(e.Number.ToByte(t))};t.prototype.Write=function(e,t,n){while(n--){this.WriteByte(e[t++])}};t.prototype.GetBuffer=function(){return this._buffer};return t}();t.MemoryStream=n})(t=e.IO||(e.IO={}))})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var Microsoft;(function(e){var t;(function(e){var t=function(){function e(e,t){this.Type=e;this.Id=t}return e}();e.FieldTag=t;var n=function(){function e(e,t){this.ElementType=e;this.Size=t}return e}();e.ContainerTag=n;var r=function(){function e(e,t,n){this.KeyType=e;this.ValueType=t;this.Size=n}return e}();e.KeyValueContainerTag=r;var i=function(){function e(){}return e}();e.Bonded=i;var a=function(){function e(e){this.low=0;this.high=0;this.low=parseInt(e);if(this.low<0){this.high=-1}}e.prototype.Equals=function(t){var n=new e(t);return this.low==n.low&&this.high==n.high};return e}();e.Int64=a;var o=function(){function e(e){this.low=0;this.high=0;this.low=parseInt(e)}e.prototype.Equals=function(t){var n=new e(t);return this.low==n.low&&this.high==n.high};return e}();e.UInt64=o;var s=function(){function e(){}e.ToByte=function(e){return this.ToUInt8(e)};e.ToInt8=function(e){var t=(e&128)<<24>>24;return e&127|t};e.ToInt16=function(e){var t=(e&32768)<<16>>16;return e&32767|t};e.ToInt32=function(e){var t=e&2147483648;return e&2147483647|t};e.ToUInt8=function(e){return e&255};e.ToUInt16=function(e){return e&65535};e.ToUInt32=function(e){return e&4294967295};return e}();e.Number=s;var u=function(){function e(e){this.Message=e}return e}();e.Exception=u;var c=function(){function e(){}return e}();e.KeyValuePair=c;var d=function(){function e(){}e.IsDataViewSupport=function(){return typeof ArrayBuffer!="undefined"&&typeof DataView!="undefined"};return e}();e.BrowserChecker=d})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var Microsoft;(function(e){var t;(function(e){var t=function(){function t(e){this._stream=e}t.prototype.WriteBlob=function(e){this._stream.Write(e,0,e.length)};t.prototype.WriteBool=function(e){this._stream.WriteByte(e?1:0)};t.prototype.WriteContainerBegin=function(e,t){this.WriteUInt8(t);this.WriteUInt32(e)};t.prototype.WriteMapContainerBegin=function(e,t,n){this.WriteUInt8(t);this.WriteUInt8(n);this.WriteUInt32(e)};t.prototype.WriteContainerEnd=function(){};t.prototype.WriteDouble=function(t){var n=e.Encoding.Double.GetBytes(t);this._stream.Write(n,0,n.length)};t.prototype.WriteFloat=function(t){var n=e.Encoding.Float.GetBytes(t);this._stream.Write(n,0,n.length)};t.prototype.WriteFieldBegin=function(e,t,n){if(t<=5){this._stream.WriteByte(e|t<<5)}else if(t<=255){this._stream.WriteByte(e|6<<5);this._stream.WriteByte(t)}else{this._stream.WriteByte(e|7<<5);this._stream.WriteByte(t);this._stream.WriteByte(t>>8)}};t.prototype.WriteFieldEnd=function(){};t.prototype.WriteFieldOmitted=function(e,t,n){};t.prototype.WriteInt16=function(t){t=e.Encoding.Zigzag.EncodeZigzag16(t);this.WriteUInt16(t)};t.prototype.WriteInt32=function(t){t=e.Encoding.Zigzag.EncodeZigzag32(t);this.WriteUInt32(t)};t.prototype.WriteInt64=function(t){this.WriteUInt64(e.Encoding.Zigzag.EncodeZigzag64(t))};t.prototype.WriteInt8=function(t){this._stream.WriteByte(e.Number.ToInt8(t))};t.prototype.WriteString=function(t){if(t==""){this.WriteUInt32(0)}else{var n=e.Encoding.Utf8.GetBytes(t);this.WriteUInt32(n.length);this._stream.Write(n,0,n.length)}};t.prototype.WriteStructBegin=function(e,t){};t.prototype.WriteStructEnd=function(t){this.WriteUInt8(t?e.BondDataType.BT_STOP_BASE:e.BondDataType.BT_STOP)};t.prototype.WriteUInt16=function(t){var n=e.Encoding.Varint.GetBytes(e.Number.ToUInt16(t));this._stream.Write(n,0,n.length)};t.prototype.WriteUInt32=function(t){var n=e.Encoding.Varint.GetBytes(e.Number.ToUInt32(t));this._stream.Write(n,0,n.length)};t.prototype.WriteUInt64=function(t){var n=e.Encoding.Varint64.GetBytes(t);this._stream.Write(n,0,n.length)};t.prototype.WriteUInt8=function(t){this._stream.WriteByte(e.Number.ToUInt8(t))};t.prototype.WriteWString=function(e){this.WriteUInt32(e.length);for(var t=0;t<e.length;++t){var n=e.charCodeAt(t);this._stream.WriteByte(n);this._stream.WriteByte(n>>>8)}};return t}();e.CompactBinaryProtocolWriter=t;var n=function(){function e(){}return e}();e.CompactBinaryProtocolReader=n})(t=e.Bond||(e.Bond={}))})(Microsoft||(Microsoft={}));var sct;(function(e){var t=function(){function t(){}t.IsSafari=function(){if(t._isSafari===null){if(typeof navigator!=="undefined"&&navigator.userAgent){var e=navigator.userAgent.toLowerCase();if(e.indexOf("safari")>=0&&e.indexOf("chrome")<0){t._isSafari=true}else{t._isSafari=false}}else{t._isSafari=false}}return t._isSafari};t.IsReactNative=function(){if(t._isReactNative===null){if(typeof navigator!=="undefined"&&navigator.product){t._isReactNative=navigator.product==="ReactNative"}else{t._isReactNative=false}}return t._isReactNative};t.IsUint8ArrSupported=function(){return!e.Utils.IsSafari()&&typeof Uint8Array!=="undefined"&&!e.Utils.IsReactNative()};t.ajax=function(e,n){var r=t._createConnection();if(e.headers){var i="qsp=true";for(var a in e.headers){i+="&";i+=encodeURIComponent(a);i+="=";i+=encodeURIComponent(e.headers[a])}if(e.url.indexOf("?")<0){e.url+="?"}else{e.url+="&"}e.url+=i}r.open(e.type,e.url,!n);if(e.complete){r.onload=function(){if(typeof r.status=="undefined"){r.status=200}e.complete(r)};r.ontimeout=function(){if(typeof r.status=="undefined"){r.status=500}e.complete(r)};r.onerror=function(){e.complete(r)}}r.send(e.data)};t.keys=function(e){if(Object.keys){return Object.keys(e)}else{var t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push(n)}}return t}};t.IsUsingXDomainRequest=function(){if(t._usingXDomainRequest==null){var e=new XMLHttpRequest;if(typeof e.withCredentials=="undefined"&&typeof XDomainRequest!="undefined"){t._usingXDomainRequest=true}else{t._usingXDomainRequest=false}}return t._usingXDomainRequest};t._createConnection=function(){var e=new XMLHttpRequest;if(t.IsUsingXDomainRequest()){return new XDomainRequest}return e};t._isSafari=null;t._isReactNative=null;t._usingXDomainRequest=null;return t}();e.Utils=t})(sct||(sct={}));var microsoft;(function(e){var t;(function(e){var t;(function(e){var t;(function(t){var n=function(){function e(){}e.GetGuid=function(){var e=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1,5)};return[e(),e(),"-",e(),"-",e(),"-",e(),"-",e(),e(),e()].join("")};e.GetTimeStamp=function(){var e=(new Date).getTime();var t=new Microsoft.Bond.Int64("0");t.low=e&4294967295;t.high=Math.floor(e/4294967296);return t};e.GetTimeStampWithValue=function(e){var t=new Microsoft.Bond.Int64("0");t.low=e&4294967295;t.high=Math.floor(e/4294967296);return t};return e}();t.utils=n;(function(e){e[e["NotSet"]=0]="NotSet";e[e["Event"]=1]="Event";e[e["PerformanceCounter"]=2]="PerformanceCounter";e[e["Anomaly"]=3]="Anomaly";e[e["Prediction"]=4]="Prediction";e[e["TraceLog"]=5]="TraceLog";e[e["EventSourceLog"]=6]="EventSourceLog";e[e["HttpLog"]=7]="HttpLog";e[e["PerformanceCounterAzure"]=8]="PerformanceCounterAzure";e[e["PerformanceCounterGfs"]=9]="PerformanceCounterGfs"})(t.RecordType||(t.RecordType={}));var r=t.RecordType;(function(e){e[e["NotSet"]=0]="NotSet";e[e["O365"]=1]="O365";e[e["SkypeBI"]=2]="SkypeBI";e[e["SkypeData"]=3]="SkypeData"})(t.PIIScrubber||(t.PIIScrubber={}));var i=t.PIIScrubber;(function(e){e[e["NotSet"]=0]="NotSet";e[e["DistinguishedName"]=1]="DistinguishedName";e[e["GenericData"]=2]="GenericData";e[e["IPV4Address"]=3]="IPV4Address";e[e["IPv6Address"]=4]="IPv6Address";e[e["MailSubject"]=5]="MailSubject";e[e["PhoneNumber"]=6]="PhoneNumber";e[e["QueryString"]=7]="QueryString";e[e["SipAddress"]=8]="SipAddress";e[e["SmtpAddress"]=9]="SmtpAddress";e[e["Identity"]=10]="Identity";e[e["Uri"]=11]="Uri";e[e["Fqdn"]=12]="Fqdn";e[e["IPV4AddressLegacy"]=13]="IPV4AddressLegacy"})(t.PIIKind||(t.PIIKind={}));var a=t.PIIKind;(function(e){e[e["Unknown"]=0]="Unknown";e[e["MSACID"]=1]="MSACID";e[e["MSAPUID"]=2]="MSAPUID";e[e["ANID"]=3]="ANID";e[e["OrgIdCID"]=4]="OrgIdCID";e[e["OrgIdPUID"]=5]="OrgIdPUID";e[e["UserObjectId"]=6]="UserObjectId";e[e["Skype"]=7]="Skype";e[e["Yammer"]=8]="Yammer";e[e["EmailAddress"]=9]="EmailAddress";e[e["PhoneNumber"]=10]="PhoneNumber";e[e["SipAddress"]=11]="SipAddress";e[e["MUID"]=12]="MUID"})(t.UserIdType||(t.UserIdType={}));var o=t.UserIdType;var s=function(){function t(){this.ScrubType=e.datamodels.PIIScrubber.NotSet;this.Kind=e.datamodels.PIIKind.NotSet;this.RawContent=""}t.prototype.Write=function(e){this.WriteImpl(e,false)};t.prototype.WriteImpl=function(t,n){t.WriteStructBegin(null,n);if(this.ScrubType!=e.datamodels.PIIScrubber.NotSet){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT32,1,null);t.WriteInt32(this.ScrubType);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT32,1,null)}if(this.Kind!=e.datamodels.PIIKind.NotSet){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT32,2,null);t.WriteInt32(this.Kind);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT32,2,null)}if(this.RawContent!=""){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,3,null);t.WriteString(this.RawContent);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,3,null)}t.WriteStructEnd(n)};t.prototype.Read=function(e){this.ReadImpl(e,false)};t.prototype.ReadImpl=function(e,t){};return t}();t.PII=s;var u=function(){function t(){this.Id=n.GetGuid();this.Timestamp=n.GetTimeStamp();this.Type="";this.EventType="";this.Extension=new Microsoft.Bond.Collections.Map;this.RecordType=e.datamodels.RecordType.NotSet;this.PIIExtensions=new Microsoft.Bond.Collections.Map}t.prototype.AddOrReplacePII=function(t,n,r){var i=new e.datamodels.PII;i.RawContent=n;i.Kind=r;i.ScrubType=e.datamodels.PIIScrubber.O365;this.PIIExtensions.AddOrReplace(t,i)};t.prototype.Write=function(e){this.WriteImpl(e,false)};t.prototype.WriteImpl=function(t,n){t.WriteStructBegin(null,n);if(this.Id!=""){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,1,null);t.WriteString(this.Id);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,1,null)}if(!this.Timestamp.Equals("0")){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT64,3,null);t.WriteInt64(this.Timestamp);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT64,3,null)}if(this.Type!=""){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,5,null);t.WriteString(this.Type);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,5,null)}if(this.EventType!=""){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,6,null);t.WriteString(this.EventType);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,6,null)}if(this.Extension.Count()){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_MAP,13,null);t.WriteMapContainerBegin(this.Extension.Count(),Microsoft.Bond.BondDataType.BT_STRING,Microsoft.Bond.BondDataType.BT_STRING);for(var r=0;r<this.Extension.GetBuffer().length;++r){t.WriteString(this.Extension.GetBuffer()[r].Key);t.WriteString(this.Extension.GetBuffer()[r].Value)}t.WriteContainerEnd();t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_MAP,13,null)}if(this.RecordType!=e.datamodels.RecordType.NotSet){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT32,24,null);t.WriteInt32(this.RecordType);t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT32,24,null)}if(this.PIIExtensions.Count()){t.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_MAP,30,null);t.WriteMapContainerBegin(this.PIIExtensions.Count(),Microsoft.Bond.BondDataType.BT_STRING,Microsoft.Bond.BondDataType.BT_STRUCT);for(var i=0;i<this.PIIExtensions.GetBuffer().length;++i){t.WriteString(this.PIIExtensions.GetBuffer()[i].Key);this.PIIExtensions.GetBuffer()[i].Value.WriteImpl(t,false)}t.WriteContainerEnd();t.WriteFieldEnd()}else{t.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_MAP,30,null)}t.WriteStructEnd(n)};t.prototype.Read=function(e){this.ReadImpl(e,false)};t.prototype.ReadImpl=function(e,t){};return t}();t.Record=u;var c=function(){function e(){this.Source="";this.DataPackageId="";this.Timestamp=new Microsoft.Bond.Int64("0");this.Records=[]}e.prototype.Write=function(e){this.WriteImpl(e,false)};e.prototype.WriteImpl=function(e,t){e.WriteStructBegin(null,t);if(this.Source!=""){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,2,null);e.WriteString(this.Source);e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,2,null)}if(this.DataPackageId!=""){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_STRING,5,null);e.WriteString(this.DataPackageId);e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_STRING,5,null)}if(!this.Timestamp.Equals("0")){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT64,6,null);e.WriteInt64(this.Timestamp);e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT64,6,null)}if(this.Records.length){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_LIST,8,null);e.WriteContainerBegin(this.Records.length,Microsoft.Bond.BondDataType.BT_STRUCT);for(var n=0;n<this.Records.length;++n){this.Records[n].WriteImpl(e,false)}e.WriteContainerEnd();e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_LIST,8,null)}e.WriteStructEnd(t)};e.prototype.Read=function(e){this.ReadImpl(e,false)};e.prototype.ReadImpl=function(e,t){};return e}();t.DataPackage=c;var d=function(){function e(){this.DataPackages=[];this.RequestRetryCount=0}e.prototype.Write=function(e){this.WriteImpl(e,false)};e.prototype.WriteImpl=function(e,t){e.WriteStructBegin(null,t);if(this.DataPackages.length){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_LIST,1,null);e.WriteContainerBegin(this.DataPackages.length,Microsoft.Bond.BondDataType.BT_STRUCT);for(var n=0;n<this.DataPackages.length;++n){this.DataPackages[n].WriteImpl(e,false)}e.WriteContainerEnd();e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_LIST,1,null)}if(this.RequestRetryCount!=0){e.WriteFieldBegin(Microsoft.Bond.BondDataType.BT_INT32,2,null);e.WriteInt32(this.RequestRetryCount);e.WriteFieldEnd()}else{e.WriteFieldOmitted(Microsoft.Bond.BondDataType.BT_INT32,2,null)}e.WriteStructEnd(t)};e.prototype.Read=function(e){this.ReadImpl(e,false)};e.prototype.ReadImpl=function(e,t){};return e}();t.ClientToCollectorRequest=d})(t=e.datamodels||(e.datamodels={}))})(t=e.telemetry||(e.telemetry={}))})(t=e.applications||(e.applications={}))})(microsoft||(microsoft={}));var microsoft;(function(e){var t;(function(e){var t;(function(e){var t;(function(t){(function(e){e[e["SENT"]=0]="SENT";e[e["SEND_FAILED"]=1]="SEND_FAILED"})(t.CallbackEventType||(t.CallbackEventType={}));var n=t.CallbackEventType;(function(e){e[e["DATARV_ERROR_OK"]=0]="DATARV_ERROR_OK";e[e["DATARV_ERROR_INVALID_EVENT"]=1]="DATARV_ERROR_INVALID_EVENT";e[e["DATARV_ERROR_INVALID_CONFIG"]=2]="DATARV_ERROR_INVALID_CONFIG";e[e["DATARV_ERROR_INVALID_DEPENDENCIES"]=3]="DATARV_ERROR_INVALID_DEPENDENCIES";e[e["DATARV_ERROR_INVALID_STATUS"]=4]="DATARV_ERROR_INVALID_STATUS";e[e["DATARV_ERROR_INVALID_ARG"]=5]="DATARV_ERROR_INVALID_ARG"})(t.DATARV_ERROR||(t.DATARV_ERROR={}));var r=t.DATARV_ERROR;var i=function(){function e(e){this._errorCode=r.DATARV_ERROR_OK;this._errorCode=e}e.prototype.ErrorCode=function(){return this._errorCode};e.prototype.toString=function(){switch(this._errorCode){case r.DATARV_ERROR_OK:return"DATARV_ERROR_OK";case r.DATARV_ERROR_INVALID_EVENT:return"Event is invalid. Either event.Id is empty, or event.Timestamp is empty, or event.EventType is empty.";case r.DATARV_ERROR_INVALID_CONFIG:return"Invalid configuration. CollectorUrl is missing.";case r.DATARV_ERROR_INVALID_DEPENDENCIES:return"DATARV_ERROR_INVALID_DEPENDENCIES";case r.DATARV_ERROR_INVALID_STATUS:return"Telemetry Manager is not initialized.";case r.DATARV_ERROR_INVALID_ARG:return"TenantToken is null or empty, or events is null.";default:return"Unknown error"}};return e}();t.Exception=i;var a=function(){function e(){}return e}();t.TelemetryConfig=a;var o=function(){function e(){}e.CreateTelemetryManager=function(){return new c};return e}();t.TelemetryManagerFactory=o;var s=function(){function e(){}e.MaxPackageSizeInBytes=function(){return 3*1e3*1e3};e.TimeIntervalForNextSendInMS=function(){return 1*1e3};return e}();var u;(function(e){e[e["Created"]=0]="Created";e[e["Initialized"]=1]="Initialized";e[e["Started"]=2]="Started"})(u||(u={}));var c=function(){function t(){this._MaxPackageSizeInBytes=s.MaxPackageSizeInBytes();this._listeners=[];this._status=u.Created;this._etag=null;this._testServerResponseHook=null;this._isPaused=false}t.prototype.Initialize=function(e){if(this._status!=u.Created){throw new i(r.DATARV_ERROR_INVALID_STATUS)}if(!e||!e.collectorUrl){throw new i(r.DATARV_ERROR_INVALID_CONFIG)}this._config=e;this._Reset();this._status=u.Initialized;this._Verbose("Initialize() done")};t.prototype.AddListener=function(e){if(this._status<u.Initialized){throw new i(r.DATARV_ERROR_INVALID_STATUS)}this._Verbose(["AddListener(), status: ",this._status," old length: ",this._listeners.length," func: ",e].join(""));for(var t=0;t<this._listeners.length;++t){if(this._listeners[t]==e){this._Verbose("the listener has been added already, index: "+t);return}}this._listeners.push(e);this._Verbose("AddListener() done, the new length: "+this._listeners.length)};t.prototype.RemoveListener=function(e){if(this._status<u.Initialized){throw new i(r.DATARV_ERROR_INVALID_STATUS)}this._Verbose(["RemoveListener(), status: ",this._status," old length: ",this._listeners.length," func: ",e].join(""));for(var t=0;t<this._listeners.length;++t){if(this._listeners[t]==e){if(this._listeners.length==1){this._listeners=[]}else if(t==this._listeners.length-1){this._listeners.pop()}else{this._listeners[t]=this._listeners.pop()}this._Verbose(["this listener has been found, index: ",t,"new length: ",this._listeners.length].join(""));return}}this._Verbose("listener isn't been found, new length"+this._listeners.length)};t.prototype.Start=function(){if(this._status<u.Initialized){throw new i(r.DATARV_ERROR_INVALID_STATUS)}this._Verbose(["Start(), status:",this._status,"tag:",t._tag].join(" "));if(this._status>=u.Started){this._Verbose("Start() already, ignore")}++t._tag;this._status=u.Started;this._Verbose(["Start() done, status: ",this._status,"tag: ",t._tag].join(""))};t.prototype.Stop=function(){if(this._status<u.Initialized){throw new i(r.DATARV_ERROR_INVALID_STATUS)}this._Verbose("Stop(), status: "+this._status);if(this._status==u.Initialized){this._Verbose("Stop() already, ignore");return}this._Reset();this._status=u.Initialized;this._Verbose("Stop() done, status: "+this._status)};t.prototype.Pause=function(){this._isPaused=true;this._CleanTimer()};t.prototype.Resume=function(){this._isPaused=false;if(!this._eventsCache.IsEmpty()&&!this._timer){this._ScheduleTimer(false)}};t.prototype.Flush=function(e){if(!this._eventsCache.IsEmpty()){this._WorkThread(e,true)}};t.prototype.SendAsync=function(e,n){if(this._status<u.Initialized){throw new i(r.DATARV_ERROR_INVALID_STATUS)}this._Verbose(["SendAsync(), status:",this._status,"tenantToken:",e,"count:",n.length].join(" "));if(this._status<u.Started){this._Info("SendAsync(), not started, ignore, return false");return false}if(!e||!n){this._Error("SendAsync(), tenantToken or events is null or empty");throw new i(r.DATARV_ERROR_INVALID_ARG)}for(var a=0;a<n.length;++a){if(!n[a].Id||!t._eventTypeRegex.test(n[a].EventType)||n[a].Timestamp.Equals("0")){this._Error(["eventId:",n[a].Id,"eventType:",n[a].EventType,"timestamp high:",n[a].Timestamp.high,"timestamp low:",n[a].Timestamp.low].join(""));throw new i(r.DATARV_ERROR_INVALID_EVENT)}}this._eventsCache.AddEvents(e,n);this._Verbose(["SendAsync(), currentTimer: ",this._timer,"eventsCacheIsEmpty",this._eventsCache.IsEmpty()].join(" "));if(!this._eventsCache.IsEmpty()&&!this._timer){this._ScheduleTimer(false)}this._Verbose("SendAsync() done");return true};t.prototype._WorkThread=function(e,n){var r=this;try{this._Verbose("_WorkThread, status: "+this._status);if(this._status<u.Started){this._Verbose("_WorkThread, status is not started, return");return}var i=this._eventsCache.DequeuEvents();if(i==null){this._Verbose("_WorkThread, No events found, return");this._CleanTimer();return}var a=this._PackEvents(i.tenantToken,i.events);this._eventsCache.AddEvents(i.tenantToken,a.remainedEvents);if(a.buffer==null||a.buffer.length==0){if(!this._eventsCache.IsEmpty()){this._Verbose("eventsCache is not empty, schedule for next run");this._ScheduleTimer(false)}else{this._Verbose("eventsCache is empty, stop schedule");this._CleanTimer()}return}if(this._testServerResponseHook){var o=this._testServerResponseHook();setTimeout(this._SendCallback(c,i.tenantToken,a.sendEvents,o,false,null),100);return}var s={type:"POST",url:this._config.collectorUrl,processData:false,headers:{"content-type":"application/bond-compact-binary","client-id":"NO_AUTH","sdk-version":"ACT-Web-JS-"+clienttelemetry_build.version},complete:function(t){return r._SendCallback(c,i.tenantToken,a.sendEvents,t,n,e)}};if(!sct.Utils.IsUint8ArrSupported()){this._Verbose("Uint8Array is undefined, send with base64 encode.");s["data"]=Microsoft.Bond.Encoding.Base64.GetString(a.buffer);s["headers"]["content-encoding"]="base64"}else{this._Verbose("Uint8Array is defined, send with binary format directly.");s["data"]=new Uint8Array(a.buffer)}if(i.tenantToken){s["headers"]["x-apikey"]=i.tenantToken}var c=t._tag;this._lastActiveTime=(new Date).getTime();sct.Utils.ajax(s,n);this._Verbose("_Workthread, send via jquery, tag: "+c)}catch(e){this._Error("_WorkThread, exception: "+e)}};t.prototype._PackEvents=function(t,n){this._Verbose("_PackageEvents, total Count: "+n.length);var r=new e.datamodels.ClientToCollectorRequest;var i=new e.datamodels.DataPackage;i.Source="JS_default_source";i.DataPackageId=e.datamodels.utils.GetGuid();i.Timestamp=e.datamodels.utils.GetTimeStamp();var a;var o=n;n=[];while(true){i.Records=[];i.Records.push.apply(i.Records,o);r.DataPackages=[];r.DataPackages.push(i);a=this._Serialize(r);this._Verbose(["_PackageEvents, sendEvents.length:",o.length,"buffer.length:",a.length,"MaxPackageSize:",this._MaxPackageSizeInBytes].join(""));if(a.length<this._MaxPackageSizeInBytes){break}else if(o.length==1){o=[];a=null;break}var s=o.splice(0,Math.floor(o.length/2));this._Verbose("_PackageEvents, too large, package again");n.push.apply(n,o);o=s}
this._Verbose(["_PakcageEvents done, sendEventsCount:",o.length,"buffer.length:",a==null?0:a.length,"remained events:",n.length].join(""));return{buffer:a,sendEvents:o,remainedEvents:n}};t.prototype._Serialize=function(e){var t=new Microsoft.Bond.IO.MemoryStream;var n=new Microsoft.Bond.CompactBinaryProtocolWriter(t);e.Write(n);return t.GetBuffer()};t.prototype._SendCallback=function(e,r,i,a,o,s){this._Verbose(["_SendCallback","tag:",e,"current tag:",t._tag,"tenantToken:",r,"events count:",i.length,"jqXHR:",a].join(""));if(s){s(a?a.status:0,r,i)}if(o){return}var c=a!=null&&a.status>=200&&a.status<300;if(this._status<u.Started||e<t._tag){this._Verbose("_SendCallback, is not started, or tag is not the same, return");return}if(!c&&(!a||a.status&&a.status!=400)){this._Verbose("retry statusCode: "+(a?a.status:0));this._eventsCache.AddEvents(r,i);this._ScheduleTimer(true);return}for(var d=0;d<this._listeners.length;++d){this._listeners[d](c?n.SENT:n.SEND_FAILED,a?a.status:0,r,i)}if(!this._eventsCache.IsEmpty()){this._Verbose("eventsCache is not empty, schedule for next run");this._ScheduleTimer(false)}else{this._Verbose("eventsCache is empty, stop schedule");this._CleanTimer()}};t.prototype._CleanTimer=function(){this._Verbose("_CleanTimer(), timer: "+this._timer);if(this._timer){clearTimeout(this._timer);this._timer=null}};t.prototype._ScheduleTimer=function(e){var t=this;if(!this._isPaused){this._Verbose("_ScheduleTimer: isRetry: "+e);this._CleanTimer();if(!e){var n=0;var r=(new Date).getTime();var i=r-this._lastActiveTime;if(i>s.TimeIntervalForNextSendInMS()){n=0}else{n=s.TimeIntervalForNextSendInMS()-i}this._timer=setTimeout(function(){return t._WorkThread(null,false)},n);this._Verbose("_ScheduleTimer, next try: "+n);this._rescheduleFactor=1}else{this._Verbose("_ScheduleTimer, current factor: "+this._rescheduleFactor);var n=Math.floor(5*this._rescheduleFactor*(1+Math.random()));this._timer=setTimeout(function(){return t._WorkThread(null,false)},n*1e3);this._Verbose("_ScheduleTimer, next try (s): "+n);this._rescheduleFactor<<=1;if(this._rescheduleFactor>64){this._rescheduleFactor=1}}}};t.prototype._Verbose=function(e){if(this._config.log){this._config.log.Verbose("[TelemetryManagerImpl]: "+e)}};t.prototype._Info=function(e){if(this._config.log){this._config.log.Info("[TelemetryManagerImpl]: "+e)}};t.prototype._Error=function(e){if(this._config.log){this._config.log.Error("[TelemetryManagerImpl]: "+e)}};t.prototype._Reset=function(){this._Verbose("Reset()");this._CleanTimer();this._lastActiveTime=0;this._rescheduleFactor=1;this._sendingEvents=[];this._eventsCache=new d};t.prototype.__GetListenerArray=function(){return this._listeners};t.prototype.__GetTotalEventsCount=function(){return this._eventsCache.GetTotalEventsCount()};t.prototype.__IsScheduled=function(){return this._timer!=null};t.prototype.__ChageMaxPackageSizeInKB=function(e){this._MaxPackageSizeInBytes=e*1024};t.prototype.__SetTestServerResponseHook=function(e){this._testServerResponseHook=e};t._eventTypeRegex=/^[a-zA-Z0-9]([a-zA-Z0-9]|_){2,98}[a-zA-Z0-9]$/;t._tag=0;return t}();var d=function(){function e(){this._events={};this._tokens=[]}e.prototype.AddEvents=function(e,t){if(!t.length){return}if(!this._events[e]){this._events[e]=[];this._tokens.push(e)}this._events[e].push.apply(this._events[e],t)};e.prototype.IsEmpty=function(){return this._tokens.length==0};e.prototype.DequeuEvents=function(){if(this._tokens.length==0){return null}var e=this._tokens.shift();var t=this._events[e];delete this._events[e];return{tenantToken:e,events:t}};e.prototype.GetTotalEventsCount=function(){var e=0;for(var t in this._events){e+=this._events[t].length}return e};return e}()})(t=e._sender||(e._sender={}))})(t=e.telemetry||(e.telemetry={}))})(t=e.applications||(e.applications={}))})(microsoft||(microsoft={}));var microsoft;(function(e){var t;(function(t){var n;(function(t){var n=t._sender.TelemetryManagerFactory.CreateTelemetryManager();var r=function(){function e(){this.collectorUrl=null;this.enableAutoUserSession=false;this.browserOverrides=new i}return e}();t.LogConfiguration=r;var i=function(){function e(){this.onSaveData=null;this.onGetData=null}return e}();t.LogConfigurationBrowserOverrides=i;var a=function(){function e(){this.value=null;this.pii=null}e._isPii=function(e){if(e===null||e===undefined||e===t.datamodels.PIIKind.NotSet||isNaN(e)){return false}return t.datamodels.PIIKind[e]!==undefined};return e}();var o=function(){function e(){this.name=null;this.timestamp=null;this.properties={};this.eventType=null}e.prototype.setProperty=function(n,r,i){if(!n||!e._propertyNameRegex.test(n)){throw new u(s.INVALID_PROPERTY_NAME)}if(i){this.properties[n]={value:r,pii:i!=t.datamodels.PIIKind.NotSet?i:null}}else{this.properties[n]={value:r,pii:null}}};e._propertyNameRegex=/^[a-zA-Z0-9](([a-zA-Z0-9|_|\.]){0,98}[a-zA-Z0-9])?$/;return e}();t.EventProperties=o;(function(e){e[e["INVALID_TENANT_TOKEN"]=1]="INVALID_TENANT_TOKEN";e[e["MISSING_EVENT_PROPERTIES_NAME"]=2]="MISSING_EVENT_PROPERTIES_NAME";e[e["INVALID_PROPERTY_NAME"]=3]="INVALID_PROPERTY_NAME";e[e["MISSING_FAILURE_SIGNATURE"]=5]="MISSING_FAILURE_SIGNATURE";e[e["MISSING_FAILURE_DETAIL"]=6]="MISSING_FAILURE_DETAIL";e[e["MISSING_PAGEVIEW_ID"]=7]="MISSING_PAGEVIEW_ID";e[e["MISSING_PAGEVIEW_NAME"]=8]="MISSING_PAGEVIEW_NAME";e[e["INVALID_SESSION_STATE"]=9]="INVALID_SESSION_STATE";e[e["INVALID_CONFIGURATION_USE_CUSTOM_GET_SET"]=10]="INVALID_CONFIGURATION_USE_CUSTOM_GET_SET"})(t.TelemetryError||(t.TelemetryError={}));var s=t.TelemetryError;var u=function(){function e(e){this.errorCode=null;this.errorCode=e}e.prototype.ErrorCode=function(){return this.errorCode};e.prototype.toString=function(){switch(this.errorCode){case s.INVALID_TENANT_TOKEN:return"Invalid tenant token";case s.MISSING_EVENT_PROPERTIES_NAME:return"Eventproperties.name can not be null or empty";case s.INVALID_PROPERTY_NAME:return"Invalid Key. Key does not conform to regular expression ^[a-zA-Z0-9](([a-zA-Z0-9|_|.]){0,98}[a-zA-Z0-9])?$";case s.MISSING_FAILURE_SIGNATURE:return"Failure signature can't be null or empty.";case s.MISSING_FAILURE_DETAIL:return"Failure detail can't be null or empty.";case s.MISSING_PAGEVIEW_ID:return"Pageview id can't be null or empty.";case s.MISSING_PAGEVIEW_NAME:return"Pageview name can't be null or empty.";case s.INVALID_SESSION_STATE:return"Session state has to be a value from the SessionState enum.";case s.INVALID_CONFIGURATION_USE_CUSTOM_GET_SET:return"Invalid configuration provided during initialization. Both onGetConfigData and onSaveConfigData must be provided together.  These are manditory when running in a non-brower enviornment";default:return"Unknown error"}};return e}();t.Exception=u;var c=function(){function n(e){this.contextMap={};this.piiKind=t.datamodels.PIIKind.NotSet;this._allowDeviceInfoFields=false;this._allowDeviceInfoFields=e}n.prototype.setAppId=function(e){if(e){this.contextMap["AppInfo.Id"]=e}};n.prototype.setAppVersion=function(e){if(e){this.contextMap["AppInfo.Version"]=e}};n.prototype.setAppLanguage=function(e){if(e){this.contextMap["AppInfo.Language"]=e}};n.prototype.setDeviceId=function(e){if(e&&this._allowDeviceInfoFields){this.contextMap["DeviceInfo.Id"]=e;d.checkAndUpdateDeviceId(e)}};n.prototype.setDeviceOsName=function(e){if(e&&this._allowDeviceInfoFields){this.contextMap["DeviceInfo.OsName"]=e}};n.prototype.setDeviceOsVersion=function(e){if(e&&this._allowDeviceInfoFields){this.contextMap["DeviceInfo.OsVersion"]=e}};n.prototype.setDeviceBrowserName=function(e){if(e&&this._allowDeviceInfoFields){this.contextMap["DeviceInfo.BrowserName"]=e}};n.prototype.setDeviceBrowserVersion=function(e){if(e&&this._allowDeviceInfoFields){this.contextMap["DeviceInfo.BrowserVersion"]=e}};n.prototype.setUserId=function(t,n,r){if(t){this.contextMap["UserInfo.Id"]=t}if(r){this.contextMap["UserInfo.IdType"]=r}else{var i;switch(n){case e.applications.telemetry.datamodels.PIIKind.SipAddress:i=e.applications.telemetry.datamodels.UserIdType.SipAddress;break;case e.applications.telemetry.datamodels.PIIKind.PhoneNumber:i=e.applications.telemetry.datamodels.UserIdType.PhoneNumber;break;case e.applications.telemetry.datamodels.PIIKind.SmtpAddress:i=e.applications.telemetry.datamodels.UserIdType.EmailAddress;break;default:i=e.applications.telemetry.datamodels.UserIdType.Unknown;break}this.contextMap["UserInfo.IdType"]=i}if(n){if(a._isPii(n)){this.piiKind=n}}else{var o;switch(r){case e.applications.telemetry.datamodels.UserIdType.Skype:o=e.applications.telemetry.datamodels.PIIKind.Identity;break;case e.applications.telemetry.datamodels.UserIdType.EmailAddress:o=e.applications.telemetry.datamodels.PIIKind.SmtpAddress;break;case e.applications.telemetry.datamodels.UserIdType.PhoneNumber:o=e.applications.telemetry.datamodels.PIIKind.PhoneNumber;break;case e.applications.telemetry.datamodels.UserIdType.SipAddress:o=e.applications.telemetry.datamodels.PIIKind.SipAddress;break;default:o=e.applications.telemetry.datamodels.PIIKind.NotSet;break}if(a._isPii(o)){this.piiKind=o}}};n.prototype.setUserMsaId=function(e){if(e){this.contextMap["UserInfo.MsaId"]=e}};n.prototype.setUserANID=function(e){if(e){this.contextMap["UserInfo.ANID"]=e}};n.prototype.setUserAdvertisingId=function(e){if(e){this.contextMap["UserInfo.AdvertisingId"]=e}};n.prototype.setUserTimeZone=function(e){if(e){this.contextMap["UserInfo.TimeZone"]=e}};n.prototype.setUserLanguage=function(e){if(e){this.contextMap["UserInfo.Language"]=e}};return n}();t.SemanticContext=c;var d=function(){function e(){}e.initialize=function(n){this._overrides=n;var r=e._getAppLanguage();if(r){e.semanticContext.setAppLanguage(r)}var i=e._getUserLanguage();if(i){e.semanticContext.setUserLanguage(i)}var a=(new Date).getTimezoneOffset();var o=a%60;var s=(a-o)/60;var u="+";if(s>0){u="-"}s=Math.abs(s);o=Math.abs(o);e.semanticContext.setUserTimeZone(u+(s<10?"0"+s:s.toString())+":"+(o<10?"0"+o:o.toString()));var c=e._getUserAgent();if(c){e.semanticContext.setDeviceBrowserName(e._getBrowserName());e.semanticContext.setDeviceBrowserVersion(e._getBrowserVersion());e.semanticContext.setDeviceOsName(e._getOsName());e.semanticContext.setDeviceOsVersion(e._getOsVersion())}var d=e._getData(e.DEVICE_ID_COOKIE);if(!d||d==""){d=t.datamodels.utils.GetGuid()}e.semanticContext.setDeviceId(d)};e.checkAndUpdateDeviceId=function(t){var n=e._getData(e.DEVICE_ID_COOKIE);if(n!=t){e._saveData(e.DEVICE_ID_COOKIE,t);e._saveData(e.FIRST_LAUNCH_TIME_COOKIE,(new Date).getTime().toString())}var r=e._getData(e.FIRST_LAUNCH_TIME_COOKIE);e.firstLaunchTime=parseInt(r)};e._saveData=function(e,t){if(this._overrides.onSaveData){this._overrides.onSaveData(e,t)}else if(typeof document!=="undefined"&&document.cookie){var n="expires=Mon, 31 Dec 2029 23:59:59 GMT";document.cookie=e+"="+t+"; "+n}};e._getData=function(e){if(this._overrides.onGetData){return this._overrides.onGetData(e)||""}else if(typeof document!=="undefined"&&document.cookie){var t=e+"=";var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];var a=0;while(i.charAt(a)==" "){a++}i=i.substring(a);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}}return""};e._getUserAgent=function(){if(typeof navigator!=="undefined"){return navigator.userAgent||""}return""};e._getAppLanguage=function(){if(typeof document!=="undefined"&&document.documentElement){return document.documentElement.lang}return null};e._getUserLanguage=function(){if(typeof navigator!=="undefined"){return navigator.userLanguage||navigator.language}return null};e._userAgentContainsString=function(t){return e._getUserAgent().indexOf(t)>-1};e._isIe=function(){return e._userAgentContainsString("Trident")};e._isEdge=function(){return e._userAgentContainsString(e.BROWSERS.EDGE)};e._isOpera=function(){return e._userAgentContainsString("OPR/")};e._getBrowserName=function(){if(e._isOpera()){return e.BROWSERS.UNKNOWN}if(e._userAgentContainsString(e.BROWSERS.PHANTOMJS)){return e.BROWSERS.PHANTOMJS}if(e._isEdge()){return e.BROWSERS.EDGE}if(e._userAgentContainsString(e.BROWSERS.ELECTRON)){return e.BROWSERS.ELECTRON}if(e._userAgentContainsString(e.BROWSERS.CHROME)){return e.BROWSERS.CHROME}if(e._userAgentContainsString(e.BROWSERS.FIREFOX)){return e.BROWSERS.FIREFOX}if(e._userAgentContainsString(e.BROWSERS.SAFARI)){return e.BROWSERS.SAFARI}if(e._userAgentContainsString(e.BROWSERS.SKYPE_SHELL)){return e.BROWSERS.SKYPE_SHELL}if(e._isIe()){return e.BROWSERS.MSIE}return e.BROWSERS.UNKNOWN};e._getBrowserVersion=function(){if(e._isIe()){return t()}else{return n(e._getBrowserName())}function t(){var t,n=e._getUserAgent(),r=n.match(new RegExp(e.BROWSERS.MSIE+" "+e.REGEX_VERSION));if(r){return r[1]}else{t=n.match(new RegExp("rv:"+e.REGEX_VERSION));if(t){return t[1]}}}function n(t){var n;if(t===e.BROWSERS.SAFARI){t="Version"}n=e._getUserAgent().match(new RegExp(t+"/"+e.REGEX_VERSION));if(n){return n[1]}return e.UNKNOWN_VERSION}};e._getOsName=function(){var t=/(windows|win32)/i,n=/ arm;/i,r=/windows\sphone\s\d+\.\d+/i,i=/(macintosh|mac os x)/i,a=/(iPad|iPhone|iPod)(?=.*like Mac OS X)/i,o=/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,s=/android/i;if(e._getUserAgent().match(r)){return e.OPERATING_SYSTEMS.WINDOWS_PHONE}if(e._getUserAgent().match(n)){return e.OPERATING_SYSTEMS.WINDOWS_RT}if(e._getUserAgent().match(a)){return e.OPERATING_SYSTEMS.IOS}if(e._getUserAgent().match(s)){return e.OPERATING_SYSTEMS.ANDROID}if(e._getUserAgent().match(o)){return e.OPERATING_SYSTEMS.LINUX}if(e._getUserAgent().match(i)){return e.OPERATING_SYSTEMS.MACOSX}if(e._getUserAgent().match(t)){return e.OPERATING_SYSTEMS.WINDOWS}return e.OPERATING_SYSTEMS.UNKNOWN};e._getOsVersion=function(){if(e._getOsName()===e.OPERATING_SYSTEMS.WINDOWS){return t()}if(e._getOsName()===e.OPERATING_SYSTEMS.MACOSX){return n()}return e.UNKNOWN_VERSION;function t(){var t=e._getUserAgent().match(new RegExp("Windows NT "+e.REGEX_VERSION));if(t&&e.VERSION_MAPPINGS[t[1]]){return e.VERSION_MAPPINGS[t[1]]}return e.UNKNOWN_VERSION}function n(){var t=e._getUserAgent().match(new RegExp(e.OPERATING_SYSTEMS.MACOSX+" "+e.REGEX_VERSION_MAC));if(t){var n=t[1].replace(/_/g,".");var i=[];if(n){var a=r(n);if(a){i=n.split(a);return i[0]}else{return n}}}return e.UNKNOWN_VERSION}function r(e){if(e.indexOf(".")>-1){return"."}if(e.indexOf("_")>-1){return"_"}return null}};e.semanticContext=new c(true);e.firstLaunchTime=-1;e.BROWSERS={MSIE:"MSIE",CHROME:"Chrome",FIREFOX:"Firefox",SAFARI:"Safari",EDGE:"Edge",ELECTRON:"Electron",SKYPE_SHELL:"SkypeShell",PHANTOMJS:"PhantomJS",UNKNOWN:"Unknown"};e.OPERATING_SYSTEMS={WINDOWS:"Windows",MACOSX:"Mac OS X",WINDOWS_PHONE:"Windows Phone",WINDOWS_RT:"Windows RT",IOS:"iOS",ANDROID:"Android",LINUX:"Linux",UNKNOWN:"Unknown"};e.VERSION_MAPPINGS={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"};e.REGEX_VERSION="([\\d,.]+)";e.REGEX_VERSION_MAC="([\\d,_,.]+)";e.UNKNOWN_VERSION="Unknown";e.DEVICE_ID_COOKIE="MicrosoftApplicationsTelemetryDeviceId";e.FIRST_LAUNCH_TIME_COOKIE="MicrosoftApplicationsTelemetryFirstLaunchTime";return e}();(function(e){e[e["STARTED"]=0]="STARTED";e[e["ENDED"]=1]="ENDED"})(t.SessionState||(t.SessionState={}));var l=t.SessionState;var f=function(){function e(){}e.initialize=function(t,r){if(!e._initialized){if(!t){throw new u(s.INVALID_TENANT_TOKEN)}e._defaultToken=t;e._tmConfig.collectorUrl="https://browser.pipe.aria.microsoft.com/Collector/3.0/";e._configuration=r;if(typeof window==="undefined"&&(!r||!r.browserOverrides||!r.browserOverrides.onGetData)){throw new u(s.INVALID_CONFIGURATION_USE_CUSTOM_GET_SET)}var a=new i;if(r){if(r.collectorUrl){e._tmConfig.collectorUrl=r.collectorUrl}if(r.browserOverrides){if(!!r.browserOverrides.onGetData?!r.browserOverrides.onSaveData:!!r.browserOverrides.onSaveData){throw new u(s.INVALID_CONFIGURATION_USE_CUSTOM_GET_SET)}a.onGetData=r.browserOverrides.onGetData;a.onSaveData=r.browserOverrides.onSaveData}}n.Initialize(e._tmConfig);n.Start();d.initialize(a);e._initialized=true;if(typeof window!=="undefined"&&window.addEventListener){if(r&&r.enableAutoUserSession){e._logger=new p;e._logger.logSession(l.STARTED)}window.addEventListener("beforeunload",e._teardown)}}};e.pauseTransmission=function(){n.Pause()};e.resumeTransmission=function(){n.Resume()};e.flush=function(e){n.Flush(e)};e.addCallbackListener=function(t){if(e._initialized){n.AddListener(t)}};e.setContext=function(t,n,r){e._contextProperties.setProperty(t,n,r)};e.isInitialized=function(){return e._initialized};e.getDefaultToken=function(){return e._defaultToken};e.getSemanticContext=function(){return e._semanticContext};e._getInitIdForToken=function(n){if(!e._initIdMap[n]){e._initIdMap[n]=t.datamodels.utils.GetGuid()}return e._initIdMap[n]};e._getSequenceForToken=function(t){if(!e._sequenceMap[t]){e._sequenceMap[t]=0}e._sequenceMap[t]++;return e._sequenceMap[t]};e._teardown=function(){if(e._logger){e._logger.logSession(l.ENDED)}e.flush()};e.__backToUninitialized=function(){e._tmConfig=new t._sender.TelemetryConfig;e._semanticContext=new c(true);e._contextProperties=new o;e._configuration=null;n=t._sender.TelemetryManagerFactory.CreateTelemetryManager();e._initialized=false;e._initIdMap={};e._sequenceMap={}};e._initialized=false;e._defaultToken=null;e._tmConfig=new t._sender.TelemetryConfig;e._logger=null;e._initIdMap={};e._sequenceMap={};e._configuration=null;e._contextProperties=new o;e._semanticContext=new c(true);return e}();t.LogManager=f;var p=function(){function e(e){this._initId=null;this._tenantToken=null;this._contextProperties=new o;this._semanticContext=new c(false);this._sessionStartTime=0;this._sessionId=null;if(!e){this._tenantToken=f.getDefaultToken()}else{this._tenantToken=e}this._initId=f._getInitIdForToken(this._tenantToken)}e.prototype.logEvent=function(e){if(!e.name){throw new u(s.MISSING_EVENT_PROPERTIES_NAME)}var t=this._createEventRecord(e.name,e.eventType);this._addPropertiesAndSendEvent(t,e)};e.prototype.logFailure=function(e,t,n,r,i){if(!e){throw new u(s.MISSING_FAILURE_SIGNATURE)}if(!t){throw new u(s.MISSING_FAILURE_DETAIL)}var a=this._createEventRecord("failure","failure");a.Extension.Add("Failure.Signature",e);a.Extension.Add("Failure.Detail",t);if(n){a.Extension.Add("Failure.Category",n)}if(r){a.Extension.Add("Failure.Id",r)}this._addPropertiesAndSendEvent(a,i)};e.prototype.logPageView=function(e,t,n,r,i,a){if(!e){throw new u(s.MISSING_PAGEVIEW_ID)}if(!t){throw new u(s.MISSING_PAGEVIEW_NAME)}var o=this._createEventRecord("pageview","pageview");o.Extension.Add("PageView.Id",e);o.Extension.Add("PageView.Name",t);if(n){o.Extension.Add("PageView.Category",n)}if(r){o.Extension.Add("PageView.Uri",r)}if(i){o.Extension.Add("PageView.ReferrerUri",i)}this._addPropertiesAndSendEvent(o,a)};e.prototype.logSession=function(e,n){if(e!==l.STARTED&&e!==l.ENDED){throw new u(s.INVALID_SESSION_STATE)}var r=this._createEventRecord("session","session");if(e===l.STARTED){if(this._sessionStartTime>0){return}this._sessionStartTime=(new Date).getTime();this._sessionId=t.datamodels.utils.GetGuid();r.Extension.Add("Session.Id",this._sessionId);r.Extension.Add("Session.State","Started")}else if(e===l.ENDED){if(this._sessionStartTime==0){return}var i=Math.floor(((new Date).getTime()-this._sessionStartTime)/1e3);r.Extension.Add("Session.Duration",i.toString());r.Extension.Add("Session.DurationBucket",this._getSessionDurationFromTime(i));r.Extension.Add("Session.Id",this._sessionId);r.Extension.Add("Session.State","Ended");this._sessionId=null;this._sessionStartTime=0}r.Extension.Add("Session.FirstLaunchTime",this._getISOString(new Date(d.firstLaunchTime)));this._addPropertiesAndSendEvent(r,n)};e.prototype.getSessionId=function(){return this._sessionId};e.prototype.setContext=function(e,t,n){this._contextProperties.setProperty(e,t,n)};e.prototype.getSemanticContext=function(){return this._semanticContext};e.prototype._getSessionDurationFromTime=function(e){if(e<0){return"Undefined"}else if(e<=3){return"UpTo3Sec"}else if(e<=10){return"UpTo10Sec"}else if(e<=30){return"UpTo30Sec"}else if(e<=60){return"UpTo60Sec"}else if(e<=180){return"UpTo3Min"}else if(e<=600){return"UpTo10Min"}else if(e<=1800){return"UpTo30Min"}return"Above30Min"};e.prototype._createEventRecord=function(e,n){var r=new t.datamodels.Record;if(!n){n="custom"}r.EventType=e.toLowerCase();r.Type=n.toLowerCase();r.Extension.Add("EventInfo.Source","JS_default_source");r.Extension.Add("EventInfo.InitId",this._initId);r.Extension.Add("EventInfo.Sequence",f._getSequenceForToken(this._tenantToken).toString());r.Extension.Add("EventInfo.Name",e.toLowerCase());var i=new Date;r.Timestamp=t.datamodels.utils.GetTimeStampWithValue(i.getTime());r.Extension.Add("EventInfo.Time",this._getISOString(i));r.Extension.Add("EventInfo.SdkVersion","ACT-Web-JS-"+clienttelemetry_build.version);return r};e.prototype._getISOString=function(e){function t(e){return e<10?"0"+e:e.toString()}function n(e){if(e<10){return"00"+e}else if(e<100){return"0"+e}return e.toString()}return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+n(e.getUTCMilliseconds())+"Z"};e.prototype._addCustomPropertiesToEvent=function(e,t){this._addSemanticContext(e,d.semanticContext);this._addSemanticContext(e,f._semanticContext);this._addSemanticContext(e,this._semanticContext);if(this._sessionId){e.Extension.Add("Session.Id",this._sessionId)}this._addEventPropertiesToEvent(e,f._contextProperties);this._addEventPropertiesToEvent(e,this._contextProperties);this._addEventPropertiesToEvent(e,t)};e.prototype._addSemanticContext=function(e,n){if(n&&n.contextMap){var r=n.contextMap;for(var i in n.contextMap){if(i=="UserInfo.Id"&&n.piiKind!=t.datamodels.PIIKind.NotSet){e.AddOrReplacePII(i,r[i],n.piiKind)}else{e.Extension.AddOrReplace(i,r[i])}}}};e.prototype._addEventPropertiesToEvent=function(e,n){if(n){if(n.timestamp&&n.timestamp>=new Date("1/1/2000").getTime()){e.Timestamp=t.datamodels.utils.GetTimeStampWithValue(n.timestamp);e.Extension.AddOrReplace("EventInfo.Time",this._getISOString(new Date(n.timestamp)))}if(n.name){e.EventType=n.name.toLowerCase();e.Extension.AddOrReplace("EventInfo.Name",n.name.toLowerCase())}var r=n.properties;if(r){for(var i in r){if(i&&(r[i].value||r[i].value===false||r[i].value==0||r[i].value=="")){if(a._isPii(r[i].pii)){e.AddOrReplacePII(i,r[i].value.toString(),r[i].pii);e.Extension.Remove(i)}else{e.Extension.AddOrReplace(i,r[i].value.toString());e.PIIExtensions.Remove(i)}}}}}};e.prototype._addPropertiesAndSendEvent=function(e,t){this._addCustomPropertiesToEvent(e,t);if(f.isInitialized()){this._sanitizeName(e);n.SendAsync(this._tenantToken,[e])}};e.prototype._sanitizeName=function(e){var t=e.EventType.replace(/\./g,"_");e.EventType=t;e.Extension.AddOrReplace("EventInfo.Name",t)};return e}();t.Logger=p})(n=t.telemetry||(t.telemetry={}))})(t=e.applications||(e.applications={}))})(microsoft||(microsoft={}));if(typeof module!="undefined"){module.exports=microsoft.applications.telemetry}var Skype;!function e(t){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i))e[i]=t[i]}return e};var r=this&&this.__decorate||function(e,t,n,r){var i=arguments.length,a=i<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,n):r,o;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)if(o=e[s])a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a;return i>3&&a&&Object.defineProperty(t,n,a),a};var i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r["throw"](e))}catch(e){a(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}u((r=r.apply(e,t)).next())})};var a=this&&this.__generator||function(e,t){var n={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,i,a;return{next:o(0),throw:o(1),return:o(2)};function o(e){return function(t){return s([e,t])}}function s(o){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,i&&(a=i[o[0]&2?"return":o[0]?"throw":"next"])&&!(a=a.call(i,o[1])).done)return a;if(i=0,a)o=[0,a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:n.label++;return{value:o[1],done:false};case 5:n.label++;i=o[1];o=[0];continue;case 7:o=n.ops.pop();n.trys.pop();continue;default:if(!(a=n.trys,a=a.length>0&&a[a.length-1])&&(o[0]===6||o[0]===2)){n=0;continue}if(o[0]===3&&(!a||o[1]>a[0]&&o[1]<a[3])){n.label=o[1];break}if(o[0]===6&&n.label<a[1]){n.label=a[1];a=o;break}if(a&&n.label<a[2]){n.label=a[2];n.ops.push(o);break}if(a[2])n.ops.pop();n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e];i=0}finally{r=a=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true}}};var o=this&&this.__extends||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n];function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)};"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}console.log.apply(console,["[TTT]"].concat(e))}e.log=t;(function(e){function t(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}console.warn.apply(console,["[TTT]"].concat(e))}e.warn=t})(t=e.log||(e.log={}))})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){e.$window=window})(t||(t={}));(function(e){var t;(function(t){var n;(function(t){t.sId=n("id");t.sModel=n("model");t.sWrapper=n("wrapper");function n(t){return t+":"+e.$window.Math.random().toString(16).slice(2)}function r(e){if(!e){debugger}}t.assert=r;function i(e,t){for(var n in t)e[n]=t[n];return e}t.extend=i;function a(){var e=Error().stack;return e&&e.toString().split("\n").join("\n")}t.stack=a;Error.stackTraceLimit=Infinity;function o(e){return e&&JSON.parse(JSON.stringify(e))}t.clone=o})(n=t.TTT||(t.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t){var n=[undefined,null,"",true,false,[],{}].map(function(e){return JSON.stringify(e)});var r=[];var i=t.map(function(t){var i=t[0],a=t.slice(1);r.push(e.RecordType[i]);return a.map(function(e){if(typeof e=="number"&&(e|0)==e&&e>=0)return e;if(e===null)return-1;if(e===undefined)return-2;var t=JSON.stringify(e);for(var r=0;r<n.length;r++)if(n[r]==t)return-(r+1);n.push(t);return-n.length})});return[n,r,i]}e.pack=t;function n(t){var n=t[0],r=t[1],i=t[2];var a=new Array(r.length);for(var o=0;o<r.length;o++){var s=e.RecordType[r[o]];var u=i[o].map(function(e){if(e>=0)return e;if(e==-1)return undefined;return JSON.parse(n[-e-1])});a[o]=[s].concat(u)}return a}e.unpack=n})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){e.Sync="sync";e.SetProp="set-prop";e.FireEvent="on-message";e.FireTimer="fire-timer";e.SetTimer="set-timer";e.ClearTimer="clear-timer";e.GetDate="date";e.CreateElemenet="create-element";e.AppendChild="append-child";e.RemoveChild="remove-child";e.PostMessage="post-message";e.AddEventListener="add-listener";e.Fetch=".get()";e.Set="set(...)";e.Then=".then()";e.Catch=".catch()";e.Finally=".finally()";e.Cancel=".cancel(...)";e.Subscribe=".subscribe()";e.Dispose=".dispose()";e.Invoke=".call(...)";e.AddItem=".add(...)";e.RemoveItem=".remove(...)";e.LoadFrame="on-load";e.CreateRoot="new Application(...)";e.XhrSend="xhr-send";e.XhrRecv="xhr-recv";e.XhrStop="xhr-stop";e.SSGetItem="ss-get-item";e.SSSetItem="ss-set-item";e.SSRemoveItem="ss-remove-item";e.LSGetItem="ls-get-item";e.LSSetItem="ls-set-item";e.LSRemoveItem="ls-remove-item"})(t=e.RecordType||(e.RecordType={}));var n=1;for(var r in t)t[t[n]=t[r]]=n++})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(t){var n;(function(n){n.version="1.0.0";var r=function(){function t(){this.version=n.version;this.sdk_ver="";this.debug=false;this.packed=false;this.randseed=0;this.timestamp=0;this.records=[];try{this.debug=!!JSON.parse(e.$window.localStorage.getItem("lwsdk.ttt.debug"))}catch(e){this.debug=false}}return t}();n.TraceData=r;var i=function(){function i(e){if(e===void 0){e=new r}this.data=e;this.index=0;this.turn=0;this.recording=true;n.assert(e.version==n.version);this.recording=this.size==0;if(e.packed){e.records=n.unpack(e.records);e.packed=false}}Object.defineProperty(i.prototype,"size",{get:function(){return this.data.records.length},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"debug",{get:function(){return this.data.debug},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"current",{get:function(){var e=this.data.records[this.index];return!this.debug?e:e&&e[1]},enumerable:true,configurable:true});i.prototype.write=function(e){var t=[];for(var r=1;r<arguments.length;r++){t[r-1]=arguments[r]}if(!this.debug){this.data.records.push([e].concat(t))}else{var i=this.turn+"/"+this.size;var a=n.stack().split("\n").slice(1).map(function(e){return e.replace(/^\s*(at )?/,"").replace(/\(https?:\/\/.+\/(.+\.js:\d+:\d+)\)/,"($1)")});this.data.records.push([i,[e].concat(t),a])}this.index++;return this.current};i.prototype.read=function(e){var t=this.current;if(e&&t[0]!=e){n.log(e+" expected at "+this.index);n.assert(false)}this.index++;return t.slice(1)};i.prototype.toJSON=function(r){var i=n.clone(this.data);i.sdk_ver=t.version;if(!this.debug){i.records=n.pack(i.records);i.packed=true}if(!r)return i;n.log("Compressing logs asynchronously with "+r+"...");var a=e.$window;var o=a.Date.now();var s=a.Math.random().toString(16).slice(2);var u=a.document;var c=u.createElement("iframe");c.id="tzip-"+s;c.src=r;c.style.display="none";u.body.appendChild(c);c.onload=function(){var e=i.records.map(function(e){return JSON.stringify(e)});var t=e.reduce(function(e,t){return e+t.length},0)/Math.pow(2,20);n.log("Sending "+t.toFixed(2)+" MB logs to the compressor...");var r={id:s,type:"compress",data:e};c.contentWindow.postMessage(r,"*")};var d=[];a.addEventListener("message",function e(t){var r=t.data;if(r&&r.id==s){a.removeEventListener("message",e);u.body.removeChild(c);var l=r.data.length/Math.pow(2,20);var f=(a.Date.now()-o)/1e3;n.log("Received "+l.toFixed(2)+" MB compressed logs in "+f.toFixed(1)+"s");i.records=r.data;var p=[];p.push("ttt_trace = {\n");for(var v in i){p.push(v);p.push(": ");if(v=="records"){p.push("(function () {");p.push(r.data);p.push("})()")}else{p.push(JSON.stringify(i[v]))}p.push(",\n")}p.pop();p.push("\n}");var h=p.join("");for(var m=0,g=d;m<g.length;m++){var y=g[m];y(h)}}});return{then:function(e){d.push(e)}}};return i}();n.Trace=i})(n=t.TTT||(t.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){function n(e,t,n){Object.defineProperty(e,t,{value:n,enumerable:false})}function r(t){return function(){var n=[];for(var r=0;r<arguments.length;r++){n[r]=arguments[r]}return e["Utils"][t].apply(this,n)}}var i=r("isProperty");var a=r("isCollection");var o=r("isFunction");var s=r("isArray");var u=r("Model");var c=r("ConstProperty");var d=r("isPromise");var l=r("isModel");var f=r("map");var p=r("foreach");function v(e,r,v){var h=[];var m={};var g=1;function y(e,t){if(e)r.setTimeout(t,0);else t()}function S(r,s){function u(i,a,o){if(i(r)){var u=g++;if(e.debug){u=""+o+u+"="+s;t.log("wrap",u)}var c=a(r,u,s);t.assert(c);n(c,t.sModel,r);n(r,t.sWrapper,c);n(c,t.sId,u);h[u]=c;return c}}t.assert(!r||!r[t.sModel]);var c=r&&r[t.sWrapper];if(c&&c[t.sModel]!==r)c=null;return c||u(i,M,"p")||u(a,C,"c")||u(o,A,"f")||u(d,_,"t")||u(l,I,"m")}function b(e){return e&&e[t.sId]}function w(e){return b(e)||t.clone(e)}function E(e){return h[e]||e}function T(e){return e&&e[t.sModel]||e}function I(n,r,i){var a=u();p(n,function(e,t){var n=S(e,i+"."+t);if(n)a[t]=n})
;if(a.keywords&&a.getMore){var o=a.keywords;var s="id";Object.defineProperty(o,s,{get:function(){return T(o)[s]},set:function(n){if(e.recording)e.write(t.RecordType.SetProp,b(o),s,n);T(o)[s]=n}})}if(n.changed){n.changed(function(){p(a,function(e,t){if(!n[t])delete a[t]});p(n,function(e,t){if(!a[t]){var n=S(e,i+"."+t);if(n)a[t]=n}})})}return a}function M(n,r,a){var o,s=true,u=false;var c=n.constructor({get:function(){if(e.recording)e.write(t.RecordType.Fetch,r);return n.get().then(function(e){return S(e,a+".get()")||e})},set:function(i,o){if(e.recording)e.write(t.RecordType.Set,r,i,o,u);return n.set(i,o).then(function(e){return S(e,a+".set()")||e})},subscribed:function(){if(e.recording)e.write(t.RecordType.Subscribe,r);o=n.subscribe();m[r]=o},unsubscribed:function(){if(e.recording)e.write(t.RecordType.Dispose,r);o.dispose()}});p(n,function(e,t){if(i(e)&&!c[t]&&!/^_/.test(t))c[t]=S(e,a+"."+t)});n.changed(function(t,n){y(!s&&e.recording,function(){c._set(t,n)})});s=false;var d=c.get;c.get=function(){var e=d.call(c);return S(e,a+".get()")};var l=c.set;c.set=function(e,t){u=true;var n=l.call(c,e,t);u=false;return S(n,a+".set()")};c.set.enabled=l.enabled;return c}function C(n,r,i){var a,o=true;var s=n.constructor({get:function(){if(e.recording)e.write(t.RecordType.Fetch,r);return n.get().then(function(e){return e.map(function(e){return S(e,i+".get()")||e})})},subscribed:function(){if(e.recording)e.write(t.RecordType.Subscribe,r);a=n.subscribe();m[r]=a},unsubscribed:function(){if(e.recording)e.write(t.RecordType.Dispose,r);a.dispose()}});n.added(function(t,n,r){var a=S(t,i+"["+r+"]")||t;y(!o&&e.recording,function(){s.add(a,n,r)})});n.removed(function(t,n){y(e.recording,function(){s.remove(n)})});o=false;var u=s.asWritable({add:function(i){if(e.recording)e.write(t.RecordType.AddItem,r,b(i)||i);return n.add(T(i))},remove:function(i){if(e.recording)e.write(t.RecordType.RemoveItem,r,b(i)||i);return n.remove(T(i))}});var c=u.get;u.get=function(e){return S(c.call(u,e),i+".get()")};return u}v.push(function(e,n,r){if(e==t.RecordType.AddItem){var i=h[n];t.assert(i);i.add(h[r]||r);return true}});v.push(function(e,n,r){if(e==t.RecordType.RemoveItem){var i=h[n];t.assert(i);i.remove(h[r]||r);return true}});function A(n,r,i){function a(){var a=[];for(var o=0;o<arguments.length;o++){a[o]=arguments[o]}var u=f(a,w);if(t.nopii&&/\.chatService\.(sendMessage|shouldNotify)$/.test(i)&&typeof u[0]=="string")u[0]="#<message-text>";var c=e.recording&&e.write(t.RecordType.Invoke,r,u);var l=n.apply(null,a.map(T));if(d(l)){l=l.then(function(e){if(s(e))return e.map(function(e,t){return S(e,i+"()["+t+"]")||e});return S(e,i+"()")||e})}var p=S(l,i+"()")||l;c&&c.push(b(p));return p}return t.extend(a,{enabled:S(n.enabled||c(true),i+".enabled"),bind:null})}v.push(function(e,n,r,i){if(e==t.RecordType.Invoke){var a=h[n];t.assert(a);var o=a.apply(null,r.map(E));t.assert(!i||i==b(o));return true}});function _(n,r,i){return{then:function(a,o,s){var u=e.recording&&e.write(t.RecordType.Then,r);var c=n.then(function(t){try{if(e.debug)u&&u.push(e.size);return a(t)}finally{if(e.debug)u&&u.push(e.size)}},o,s);return S(c,i+".then()")},catch:function(a){if(e.recording)e.write(t.RecordType.Catch,r);var o=n.catch(a);return S(o,i+".catch()")},finally:function(a){if(e.recording)e.write(t.RecordType.Finally,r);var o=n.finally(a);return S(o,i+".finally()")},cancel:function(i){if(e.recording)e.write(t.RecordType.Cancel,r,t.clone(i));n.cancel(i)}}}v.push(function(e,n){if(e==t.RecordType.Then){var r=h[n];t.assert(r);r.then();return true}});v.push(function(e,n){if(e==t.RecordType.Catch){var r=h[n];t.assert(r);r.catch();return true}});v.push(function(e,n){if(e==t.RecordType.Finally){var r=h[n];t.assert(r);r.finally();return true}});v.push(function(e,n,r){if(e==t.RecordType.Cancel){var i=h[n];t.assert(i);i.cancel(r);return true}});v.push(function(e,n){if(e==t.RecordType.Fetch){var r=h[n];t.assert(r);r.get();return true}});v.push(function(e,n,r,i,a){if(e==t.RecordType.Set){var o=h[n];t.assert(o);if(a)o.set(r,i);else o(r,i);return true}});v.push(function(e,n){if(e==t.RecordType.Subscribe){var r=h[n];t.assert(r);r.subscribe();return true}});v.push(function(e,n){if(e==t.RecordType.Dispose){var r=h[n];t.assert(r);m[n].dispose();return true}});v.push(function(e,n,r,i){if(e==t.RecordType.SetProp){var a=h[n];t.assert(a);a[r]=i;return true}});return{wrap:S}}t.Wrapper=v})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,r,i){return n({Date:e.createDateProxy(t,r),Math:e.createMathProxy(t,r)},e.createTimerProxy(t,r,i),e.createMessageProxy(t,r,i),{document:e.createDocumentProxy(t,r,i),sessionStorage:e.createStorageProxy(t,r,r.sessionStorage,e.RecordType.SSGetItem,e.RecordType.SSSetItem,e.RecordType.SSRemoveItem),localStorage:e.createStorageProxy(t,r,r.localStorage,e.RecordType.LSGetItem,e.RecordType.LSSetItem,e.RecordType.RemoveItem),XMLHttpRequest:e.createXhrProxy(t,r,i),WeakMap:r["WeakMap"],navigator:r.navigator,location:r.location})}e.createWindowProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n,r,i,a,o){return{setItem:function(n,i){if(t.recording){r.setItem(n,i);t.write(a,n)}else{var o=t.read(a)[0];e.assert(o==n)}},getItem:function(n){if(t.recording){var a=r.getItem(n);t.write(i,n,a);return a}else{var o=t.read(i),s=o[0],a=o[1];e.assert(s==n);return a}},removeItem:function(n){if(t.recording){r.removeItem(n);t.write(o,n)}else{var i=t.read(o)[0];e.assert(i==n)}}}}e.createStorageProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n){var r=n.Date;if(t.recording)t.data.timestamp=r.now();var i=t.data.timestamp;function a(n){e.assert(this instanceof a);e.assert(arguments.length<2);e.assert(/number|undefined|string/.test(typeof n));if(n)return new r(n);if(t.recording){var o=new r;t.write(e.RecordType.GetDate,+o-i);i=+o;return o}else{var s=t.read(e.RecordType.GetDate)[0];i+=s;return new r(i)}}return e.extend(a,{now:function(){return+new this}})}e.createDateProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(e,t,n){return{next:function(){return e=t*e+n|0},random:function(){var e=this.next()/2147483648;return e<0?-e:e}}}function n(e,n){var r=n.Math;if(e.recording)e.data.randseed=r.random()*1073741824|0;var i=t(e.data.randseed,1664525,1013904223);return{log:function(e){return r.log(e)},pow:function(e,t){return r.pow(e,t)},max:function(e,t){return r.max(e,t)},min:function(e,t){return r.min(e,t)},floor:function(e){return r.floor(e)},round:function(e){return r.round(e)},random:function(){return i.random()}}}e.createMathProxy=n})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n,r){var i=n.XMLHttpRequest;var a={};var o=1;var s=function(){function n(){this.headers={};this.id=o++;if(t.recording)this.xhr=new i;a[this.id]=this}n.prototype.open=function(e,n,r){if(r===void 0){r=true}if(t.recording){this.type=e;this.url=n;if(!r)throw Error("XHR requests must be async");this.xhr.open(e,n,r)}};n.prototype.abort=function(){if(t.recording){t.write(e.RecordType.XhrStop,this.id);this.xhr.abort()}else{var n=t.read(e.RecordType.XhrStop)[0];e.assert(n==this.id)}};n.prototype.setRequestHeader=function(e,n){if(t.recording){this.headers[e]=n;this.xhr.setRequestHeader(e,n)}};n.prototype.getAllResponseHeaders=function(){return this.responseHeaders};n.prototype.send=function(n){var r=this;if(t.recording){var i=this.xhr;i.onreadystatechange=function(){if(i.readyState!=4)return;r.readyState=i.readyState;r.status=i.status;r.statusText=i.statusText;r.responseHeaders=i.getAllResponseHeaders();r.responseText=i.responseText;t.turn++;t.write(e.RecordType.XhrRecv,r.id,{status:r.status,statusText:r.statusText,headers:r.responseHeaders.split("\r\n"),data:r.responseText});r.xhr=null;r.onreadystatechange()};t.write(e.RecordType.XhrSend,this.id,{type:this.type,url:this.url,headers:this.headers,data:n});this.xhr.send(n)}else{var a=t.read(e.RecordType.XhrSend)[0];e.assert(a==this.id)}};n.prototype.recv=function(e){var t=e.status,n=e.statusText,r=e.headers,i=e.data;this.readyState=4;this.status=t;this.statusText=n;this.responseHeaders=r.join("\r\n");this.responseText=i;this.onreadystatechange()};return n}();r.push(function(t,n,r){if(t==e.RecordType.XhrRecv){a[n].recv(r);return true}});return s}e.createXhrProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n,r){var i=n.document;var a=n.setTimeout;var o={};var s=1;r.push(function(t,n){if(t==e.RecordType.LoadFrame){o[n].onload();return true}});return{createElement:function(n){e.assert(n=="iframe");if(t.recording){var r=i.createElement(n);r[e.sId]=s++;t.write(e.RecordType.CreateElemenet,r[e.sId]);return r}else{var a=t.read(e.RecordType.CreateElemenet);var u=a[0];var r={style:{},contentWindow:{postMessage:function(){}}};r[e.sId]=u;e.assert(!o[u]);o[u]=r;return r}},body:{appendChild:function(n){if(t.recording){e.assert(n[e.sId]);t.write(e.RecordType.AppendChild,n[e.sId]);var r=n.onload;n.onload=function(){a(function(){t.turn++;t.write(e.RecordType.LoadFrame,n[e.sId]);r.call(n)},0)};i.body.appendChild(n)}else{var o=t.read(e.RecordType.AppendChild)[0];e.assert(o==n[e.sId])}},removeChild:function(n){if(t.recording){t.write(e.RecordType.RemoveChild,n[e.sId]);i.body.removeChild(n)}else{var r=t.read(e.RecordType.RemoveChild)[0];e.assert(r==n[e.sId])}}},cookie:""}}e.createDocumentProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n,r){var i=n.setTimeout;var a=n.setInterval;var o=n.clearTimeout;var s=n.clearInterval;var u=[];r.push(function(t,n){if(t==e.RecordType.FireTimer){u[n].call();return true}});return{setTimeout:function(n,r){if(t.recording){var a=i(function(){t.turn++;t.write(e.RecordType.FireTimer,a);n()},r);t.write(e.RecordType.SetTimer,a,r,0);return a}else{var o=t.read(e.RecordType.SetTimer),s=o[0],c=o[1],d=o[2];e.assert(c==r);e.assert(!d);e.assert(!u[s]);u[s]=n;return s}},clearTimeout:function(n){if(!n)return;if(t.recording){t.write(e.RecordType.ClearTimer,n);o(n)}else{var r=t.read(e.RecordType.ClearTimer)[0];e.assert(r==n);if(u[n])u[n]=null;else e.log.warn("Timer "+n+" has been cleared again.")}},setInterval:function(n,r){if(t.recording){var i=a(function(){t.turn++;t.write(e.RecordType.FireTimer,i);n()},r);t.write(e.RecordType.SetTimer,i,r,1);return i}else{var o=t.read(e.RecordType.SetTimer),s=o[0],c=o[1],d=o[2];e.assert(c==r);e.assert(d);e.assert(!u[s]);u[s]=n;return s}},clearInterval:function(n){if(!n)return;if(t.recording){t.write(e.RecordType.ClearTimer,n);s(n)}else{var r=t.read(e.RecordType.ClearTimer)[0];e.assert(r==n);if(u[n])u[n]=null;else e.log.warn("Timer "+n+" has been cleared again.")}}}}e.createTimerProxy=t})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){function n(t){return"#<text:"+t.length+":"+e.Utils.hash(t)+">"}function r(e,r,i){var a={};var o=1;i.push(function(e,n,r){if(e==t.RecordType.FireEvent){a[n].call(null,{data:r});return true}});return{addEventListener:function(i,s){t.assert(i=="message");if(e.recording){var u=o++;e.write(t.RecordType.AddEventListener,u);r.addEventListener("message",function(r){try{e.turn++;var i=r.data;if(t.nopii&&typeof i=="string"){i=i.replace(/(\\"(?:html|plain)Message\\":{\\"href\\":\\"data:text\/(?:html|plain);charset=utf-8,)(.*?)(\\"}})/gm,function(e,t,r,i){return t+n(r)+i});i=i.replace(/(\\"previewMessage\\":\\")(.*?)(\\")/gm,function(e,t,r,i){return t+n(r)+i});i=i.replace(/\b(cwt=)([\w-]+)\b/gm,function(e,t,r){return t+n(r)});e.write(t.RecordType.FireEvent,u,i)}s(r)}catch(e){}})}else{var c=e.read(t.RecordType.AddEventListener)[0];t.assert(c==o);t.assert(!a[o]);a[o]=s;o++}},attachEvent:function(e,t){this.addEventListener("on"+e,t)},postMessage:function(n,i){t.assert(i=="*");if(e.recording){r.postMessage(n,i);e.write(t.RecordType.PostMessage,n)}else{e.read(t.RecordType.PostMessage)}}}}t.createMessageProxy=r})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(t){var n;(function(n){var r;(function(r){function i(i,a){var o=!a;var s=new Array;var u=new r.Trace(a);var c=r.Wrapper(u,i,s);function d(){return t.$window.Math.random().toString(16).slice(2,8)}function l(n){var r={};r[n+".src"]=new Blob(["var Skype; !"+e+"(Skype = window.Skype || {});"],{type:"application/javascript"});var i=u.toJSON();r[n+".json"]=new Blob(["ttt_trace = ",JSON.stringify(i,null,"\t")],{type:"application/json"});r[n+".html"]=new Blob(["<!doctype html>","<html>","<head>","<title>"+(new t.$window.Date).toJSON().slice(0,-8)+"</title>",'<script type="text/javascript" src="'+n+'.json"><\/script>','<script type="text/javascript" src= "'+n+'.src"><\/script>',"</head>",'<body><button onclick="this.disabled = true; Skype.ttt.play();">Replay</button></body>',"</html>"],{type:"text/html"});return r}function f(e,t){if(e===void 0){e=d()}var n=l(e);p(t,n)}function p(e,t){var n=new i.FormData;var r=new i.XMLHttpRequest;for(var a in t)n.append(a,t[a],a);r.open("POST",e||"/ttt");r.send(n)}function v(){var e=t.$window.Date.now();var n=d();var i=l(n);var a=t.$window.Date.now()-e;r.log("Files generated in "+a+" ms");for(var o in i)h(o,i[o])}function h(e,t){var n=document.createElement("a");n.href=URL.createObjectURL(t);n.download=e;n.click()}if(a)r.log("Invoke ttt.play() to replay the recorded trace.");return{window:r.createWindowProxy(u,i,s),save:v,send:f,sync:function(e){if(!u.debug)return;if(u.recording){u.write(r.RecordType.Sync,e)}else{var t=u.read(r.RecordType.Sync)[0];r.assert(t==e)}},play:function(){e:while(u.current){var e=u.index;this.tick=u.index;var t=u.current,n=t[0],i=t.slice(1);u.index++;if(n==r.RecordType.CreateRoot){this.root(i[0])}else{try{for(var a=0,o=s;a<o.length;a++){var c=o[a];if(c.apply(void 0,[n].concat(i)))continue e}}catch(t){r.log.apply(void 0,[e,n].concat(i));throw t}r.log("Record #"+e+" "+n+" is not an action.");r.assert(false)}}},toJSON:function(e){return u.toJSON(e)},ctor:null,root:function(e){if(o){r.log("Recording. Invoke ttt.save() to get the recorded trace.");u.write(r.RecordType.CreateRoot,r.clone(e))}n.Utils.defer.mode="setTimeout";n.Utils.defer.duration=0;var t=new this.ctor(e||undefined);return c.wrap(t,"app")}}}r.Recorder=i})(r=n.TTT||(n.TTT={}))})(n=t.Web||(t.Web={}))})(t||(t={}));"use strict";var t;(function(e){function t(e){try{return e()}catch(e){}}var n=false||t(function(){return/\bttt$/.test(location.hash)})||t(function(){return/\bttt$/.test(location.search)})||t(function(){return JSON.parse(sessionStorage.getItem("lwsdk.ttt"))})||t(function(){return JSON.parse(localStorage.getItem("lwsdk.ttt"))});var r=window.navigator&&window.navigator.userAgent;e.ttt=typeof ttt_trace!="undefined"?e.Web.TTT.Recorder(window,ttt_trace):r&&n&&e.Web.TTT.Recorder(window);e.ttt&&e.$window.setTimeout(function(){e.$window["ttt"]=e.ttt},1e3)})(t||(t={}));(function(e){var t;(function(t){t.window=e.ttt?e.ttt.window:e.$window;try{Object.defineProperty(t,"sessionStorage",{get:function(){return t.window.sessionStorage}});Object.defineProperty(t,"localStorage",{get:function(){return t.window.localStorage}});Object.defineProperty(t,"XMLHttpRequest",{get:function(){return t.window.XMLHttpRequest}});Object.defineProperty(t,"Date",{get:function(){return t.window.Date}});Object.defineProperty(t,"Math",{get:function(){return t.window.Math}});Object.defineProperty(t,"setTimeout",{get:function(){return t.window.setTimeout.bind(null)}});Object.defineProperty(t,"setInterval",{get:function(){return t.window.setInterval.bind(null)}});Object.defineProperty(t,"clearTimeout",{get:function(){return t.window.clearTimeout.bind(null)}});Object.defineProperty(t,"clearInterval",{get:function(){return t.window.clearInterval.bind(null)}})}catch(e){}})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(e){e.nopii=true})(t=e.TTT||(e.TTT={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){e.isUnitTested=!!e["isUnitTested"]})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(e){e.dbgBreak=false})(t=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){"use strict";t.replacePrototype=true;t.noop=function(){};t.sIsAsync=o("async");function n(e){return e&&e[t.sIsAsync]}t.isAsyncFunction=n;function r(e,n,i){if(V(e)){var a=e[t.sIsAsync]?e:function(){try{return t.Task.wait(e.apply(this,arguments),n)}catch(e){return(new t.Task).reject(e).promise}};u(a,t.sIsAsync,true);return a}else if(typeof e==="object"&&typeof i==="object"){var o=s(i);o.value=r(i.value,this);return o}else{I(false)}}t.async=r;function i(e,t,n){n.enumerable=false}t.hidden=i;function a(e,t,n){var r=n.value;n=s(n);n.value=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}try{return r.apply(this,e)}catch(e){}};return n}t.nothrow=a;function o(t,n){if(t===void 0){t=d()}if(n===void 0){n=!e.isUnitTested}return!n?"_s_"+t:t+"_"+d()}t.Symbol=o;function s(e,t,n){var r={};e=e||{};t=t||{};for(var i in t){if(!(i in e)||n!="append")r[i]={value:t[i],writable:true,enumerable:true,configurable:true}}return Object.create(e,r)}t.inherit=s;function u(e,t,n,r){if(r===void 0){r=false}try{Object.defineProperty(e,t,{value:n,configurable:true,enumerable:false,writable:!r})}catch(r){e[t]=n}}t.setHiddenProperty=u;function c(e){var t=[];for(var n=1;n<arguments.length;n++){t[n-1]=arguments[n]}var r,i,a,o=t[t.length-1];e=e||{};o=N(o)?o:"";for(i=0;i<t.length;i++){r=t[i]||{};if(r!==o){for(a in r){if(o!="append"||!(a in e))e[a]=r[a]}}}return e}t.extend=c;function d(){return e.Math.random().toString(16).slice(2)}t.random=d;function l(e,n){if(t.replacePrototype){if(e.__proto__)e.__proto__=n;else if(Object.setPrototypeOf)Object.setPrototypeOf(e,n);else c(e,n)}else{c(e,n)}}t.setPrototypeOrExtend=l;function f(n,r){r=c({code:n},r);return c(Error(this===e.window||this===t||!this||this==""?n:this),r)}t.Exception=f;function p(e,t){var n=e+" is not a "+t;return f.call(n,"WrongType",{value:e})}t.EWrongType=p;function v(e,t,n){var r="`"+e+"` = "+t+" is not a "+n;return f.call(r,"WrongArgType",{arg:e,value:t})}t.EWrongArgType=v;function h(e,t){var n=e+" != "+t;return f.call(n,"DoesNotEqual",{lhs:e,rhs:t})}t.EDoesNotEqual=h;function m(e,t){var n="`"+e+"` is invalid: "+t;return f.call(n,"InvalidArgument",{arg:e,reason:t})}t.EInvalidArgument=m;function g(e,t){var n="Invalid state: "+e+" (expected "+t+")";return f.call(n,"InvalidState",{actual:e,expected:t})}t.EInvalidState=g;function y(e,t){var n="the `"+e+"` property is missing";return f.call(n,"KeyMissing",{key:e,object:t})}t.EKeyMissing=y;function S(e){return f("AlreadyExists",{item:e})}t.EAlreadyExists=S;function b(e){return f("DoesNotExist",{item:e})}t.EDoesNotExist=b;function w(e){return f("NotSupported",{reason:e})}t.ENotSupported=w;function E(e){return f("NotFoundError",{reason:e})}t.ENotFound=E;function T(e){return f("Canceled",{reason:e})}t.ECanceled=T;function I(t,n,r){if(!t){if(!e.isUnitTested&&e.Settings.dbgBreak){debugger}throw f(n||"AssertionFailed",r)}}t.assert=I;function M(e,t,n){if(!e)throw f(t||"RuntimeCheckFailed",n)}t.check=M;(function(e){function t(e,t){if(e!=t)throw h(e,t)}e.equals=t;function n(e,t){if(D(t)){if(C(t,e)==-1)throw g(e,t)}else if(e!=t)throw g(e,t)}e.state=n;function r(e,t){if(!(e in t))throw y(e,t)}e.belongs=r})(M=t.check||(t.check={}));function C(e,t){var n;if(e.indexOf){return e.indexOf(t)}else{for(n=0;n<e.length;n++){if(e[n]==t)return n}return-1}}t.indexOf=C;function A(e){return e instanceof t.Promise}t.isPromise=A;function _(e){return e&&e.constructor===t.Collection}t.isCollection=_;function R(e){return e instanceof t.Model}t.isModel=R;function P(e){return e&&e.constructor===t.Property}t.isProperty=P;function k(e){return e&&e.constructor===t.Command}t.isCommand=k;function O(e){return e&&Object.prototype.toString.call(e)=="[object Object]"}t.isObject=O;function x(e){return O(e)}t.isDictionary=x;function D(e){return Object.prototype.toString.call(e)=="[object Array]"}t.isArray=D;function U(e,t){if(!D(e))return false;for(var n=0;n<e.length;n++)if(!t(e[n]))return false;return true}t.isArrayOf=U;function N(e){return Object.prototype.toString.call(e)=="[object String]"}t.isString=N;function L(e){return Object.prototype.toString.call(e)=="[object Number]"}t.isNumber=L;function V(e){return Object.prototype.toString.call(e)=="[object Function]"}t.isFunction=V;function W(e){return Object.prototype.toString.call(e)=="[object Boolean]"}t.isBoolean=W;function B(e){return N(e)&&e.length>0}t.isNotEmptyString=B;function j(e){return e===null||e===undefined}t.isVoid=j;function F(e){return j(e)||W(e)||L(e)||N(e)}t.isPrimitive=F;function G(e){return L(e)&&(e|0)==e}t.isInteger=G;function H(e,t){return G(e)&&D(t)&&e>=0&&e<t.length}t.isArrayIndex=H;function q(e,t,n){return L(n)&&n>=e&&n<=t}t.isInRange=q;function z(e){return O(e)&&B(e.type)&&B(e.url)}t.isAjaxRequest=z;function Y(e){return x(e)&&"status"in e}t.isAjaxResponse=Y;function X(e){for(var t in e)if(e.hasOwnProperty(t))return false;return true}t.isEmptyObject=X;function J(e){return e&&e.code&&e instanceof Error}t.isException=J;function K(e,t){var n,r=t.split("|");for(n=0;n<r.length;n++)if(r[n]in K.types&&K.types[r[n]](e))return true;return false}t.is=K;function Q(e){return e&&V(e.then)}t.isThenable=Q;(function(e){e.types={String:N,NotEmptyString:B,Function:V,Dictionary:x,Object:O,Array:D,Boolean:W,Void:j,Number:L,Exception:J}})(K=t.is||(t.is={}));function $(e){var t=[];for(var n=1;n<arguments.length;n++){t[n-1]=arguments[n]}var r=this;return e.bind?e.bind.apply(e,[r].concat(t)):function(){return e.apply(r,t.concat([].slice.call(arguments,0)))}}t.bind=$;function Z(e,t){e.splice(t,1)}t.removeAt=Z;function ee(e,t,n){e.splice(t,0,n)}t.insertAt=ee;function te(e,t){var n,r,i;if(D(e)){for(r=0;r<e.length;++r)t(e[r],r)}else{for(i in e){n=t(e[i],i);I(n===void 0)}}}t.foreach=te;function ne(e,t,n){var r,i;if(D(e)){r=[];for(i=0;i<e.length;i++)r.push(t.call(n,e[i],i,e))}else if(x(e)){r={};for(i in e)r[i]=t.call(n,e[i],i,e)}return r}t.map=ne;function re(e){I(x(e));var t=[];te(e,function(e){t.push(e)});return t}t.values=re;function ie(e,t){I(D(e)||x(e));I(V(t));var n;if(D(e)){for(n=0;n<e.length;++n){if(t(e[n],n))return true}}else{for(n in e){if(t(e[n],n))return true}}return false}t.contains=ie;function ae(t,n){var r,i=typeof t,a=typeof n;if(t===n)return true;if(i!==a||i!=="object"&&i!=="function")return false;if(t===null||n===null)return t===n;if(t instanceof e.Date&&n instanceof e.Date)return+t==+n;for(r in t){if(!(r in n)||t[r]!==n[r])return false}for(r in n){if(!(r in t)||t[r]!==n[r])return false}return true}t.deepEqual=ae;function oe(e,t){for(var n=0;n<e.length;n++){if(t(e[n])){Z(e,n);return n}}}t.removeItem=oe;function se(e,t,n){var r=0,i=e.length;while(r<i&&!n(t,e[r]))r++;ee(e,r,t);return r}t.insertItem=se})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=[];var r='{"websdk":"'+t.random()+'"}';function i(){var t=n.slice(0);n.length=0;var a=o.duration&&e.Date.now();while(t.length>0){var s=t.shift(),u=s[0],c=s[1],d=s[2];try{u.apply(c,d)}catch(e){}if(o.duration&&e.Date.now()>a+o.duration)break}if(t.length>0){n.unshift.apply(n,t);if(o.mode=="setTimeout")e.setTimeout(i,0);if(o.mode=="postMessage")e.window.postMessage(r,"*")}}function a(e){if(e.data==r){o.mode="postMessage";i()}}function o(t){var s=this;var u=[];for(var c=1;c<arguments.length;c++){u[c-1]=arguments[c]}if(e.isUnitTested){t.apply(this,u);return}if(!o.duration&&o.mode=="setTimeout"){e.setTimeout(function(){return t.apply(s,u)},0);return}n.push([t,this,u]);if(n.length>1)return;if(o.mode=="setTimeout"){e.setTimeout(i,0);return}if(o.mode=="postMessage"){e.window.postMessage(r,"*");return}if(!o.mode){try{o.mode="postMessage-probing";e.window.postMessage(r,"*");if(e.window.addEventListener)e.window.addEventListener("message",a);else e.window.attachEvent("onmessage",a);e.setTimeout(function(){if(o.mode)return;o.mode="setTimeout";i()},0)}catch(t){o.mode="setTimeout";e.setTimeout(i,0)}}}t.defer=o;(function(e){e.duration=16})(o=t.defer||(t.defer={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=e.isException;var n=e.ECanceled;var r=e.Symbol("task");var i=e.Symbol("error");var a=e.Symbol("result");function o(t){if(e.isPromise(t))return t;var n=t!==true&&t!==false&&t!==null&&t!==undefined&&typeof t!=="number"&&typeof t!=="string"&&t.then;if(typeof n==="function")return new u(e.bind.call(t,n))}var s=function(){function t(n,i){var a=this;if(!(this instanceof t))return new t(n,i);if(!e.isString(n)){i=n;n=void 0}var o=i||{};this._={leafs:[],state:"pending",status:e.Property({value:n}),promise:e.inherit(u.prototype)};var s=this._;if(o.mode)s.mode=o.mode;if(o.cancel)s.fnCancel=o.cancel;e.setHiddenProperty(s.promise,r,this);this.state=function(){return s.state};this.status=s.status;this.promise=s.promise;this.status.changed(function(){return a.notify()})}t.prototype.resolve=function(e){var t=this,n=t._;if(n.state!="pending")return t;n.value=e;n.state="resolved";return t._complete()};t.prototype.reject=function(e){var t=this,n=t._;if(n.state!="pending")return t;n.value=e;n.state="rejected";return t._complete()};t.prototype.from=function(e){var n=this,i=n._;if(i.promise[t.sLocked])return i.target.from(e);i.source=e;var a=i.source.then(function(e){n.resolve(e);return e},function(e){n.reject(e);throw e},i.status);i.fnCancel=function(e){return i.source.cancel(e)};if(i.source[t.sLocked])i.source[r]._.target=n;return a};t.prototype._complete=function(){var e=this,t=e._;t.status(null);for(var n=0,r=t.leafs;n<r.length;n++){var i=r[n];this.exec(i)}t.fnCancel=null;return e};t.prototype.exec=function(t,n){var r=this._;if(r.mode!="sync"&&n!="sync"){e.defer.call(this,this.exec,t,"sync");return}this.exec2(t,r.state,r.value)};t.prototype.exec2=function(t,n,r){var i=this;if(n=="resolved")try{var a=o(r);if(a){a.then(function(e){return i.exec2(t,"resolved",e)},function(e){return i.exec2(t,"rejected",e)});return}}catch(e){n="rejected";r=e}var s=t.done,u=t.fail,c=t.task;var d;try{if(n=="resolved")d=e.isFunction(s)?s(r):r;else if(e.isFunction(u))d=u(r);else throw r}catch(e){c.reject(e);return}if(d===c.promise)c.reject(new TypeError);else try{var l=o(d);if(l)c.from(l);else c.resolve(d)}catch(e){c.reject(e)}};t.prototype.notify=function(){var t=this._;if(t.state!="pending")return;var n=this.status();var r=this.status.reason;if(n===undefined&&r===undefined)return;for(var i=0,a=t.leafs;i<a.length;i++){var o=a[i],s=o.task,u=o.info;s.status(n,r);if(e.isFunction(u))u(n,r)}};t.prototype.detach=function(n,r){var i=this._;var a=n.task,o=n.fail;if(i.leafs.length<2){i.promise.cancel(r)}else{e.removeAt(i.leafs,e.indexOf(i.leafs,n));try{if(e.isFunction(o))a.from(t.wait(o(r)));else a.reject(r)}catch(e){a.reject(e)}}};return t}();s.sLocked=e.Symbol("locked");e.Task=s;var u=function(){function o(e){if(!(this instanceof o))return new o(e);var t=new s;try{e(function(e){return t.resolve(e)},function(e){return t.reject(e)},t.status)}catch(e){try{t.reject(e)}catch(e){}}return t.promise}o.prototype.cancel=function(e){var i=this[r],a=i._;if(a.state!="pending")return;var o=t(e)&&e.code=="Canceled"?e:n(e);if(a.fnCancel)a.fnCancel(o);else i.reject(o)};o.prototype.then=function(e,t,n){var i=this[r];var a=new s({cancel:function(e){return i.detach(o,e)}});var o={task:a,done:e,fail:t,info:n};if(i.state()=="pending"){i._.leafs.push(o);i.notify()}else{i.exec(o)}return a.promise};o.prototype.catch=function(t){return this.then(null,t||e.noop)};o.prototype.finally=function(e){return this.then(function(t){return o.resolve(e()).then(function(){return t})},function(t){return o.resolve(e()).then(function(){throw t})})};Object.defineProperty(o.prototype,a,{get:function(){var e=this[r]._;if(e.state=="resolved")return e.value},enumerable:true,configurable:true});Object.defineProperty(o.prototype,i,{get:function(){var e=this[r]._;if(e.state=="rejected")return e.value},enumerable:true,configurable:true});return o}();e.Promise=u;(function(t){function n(n){var r=n.length;var i=new t({cancel:s});var a=i.promise;var o=[];if(r==1)a=t.wait(n[0]);else if(r==0)i.reject(Error());else{e.foreach(n,function(t,n){t.then(function(t){r--;if(i){i.resolve(t);i=null;s(e.Exception("CompetingTaskResolved"))}},function(e){r--;if(!r){i.reject(e);i=null}},function(e){if(!i)return;o[n]=e||"#"+n;i.status(o.join(" || "))})})}function s(e){for(var t=0,r=n;t<r.length;t++){var i=r[t];try{i.cancel(e)}catch(e){}}}return a}t.waitAny=n;function r(n){var r=n.length;var a=new t({cancel:f});var o=a.promise;if(r==0){a.resolve([])}else if(r==1){o=t.wait(n[0]).then(function(e){return[e]})}else{var s=true;var u=n.map(i);var c=n.map(function(e){return null});var d=[];var l=function(){return!s&&a&&a.status(d.filter(function(e,t){return!!u[t]}).join(" && "))};n=n.map(i);e.foreach(n,function(e,t){e.then(function(e){c[t]=e;u[t]=null;l();r--;if(!r){a.resolve(c);a=null}},function(e){u[t]=null;r--;if(a){a.reject(e);a=null;f(e)}},function(e){d[t]=e||"#"+t;l()})});s=false;l()}function f(e){for(var t=0,r=n;t<r.length;t++){var i=r[t];try{i.cancel(e)}catch(e){}}}return o}t.waitAll=r;function i(e,n){try{return o(e)||new t({mode:n}).resolve(e).promise}catch(e){return u.reject(e)}}t.wait=i;function a(e){try{return t.wait(e(),"sync")}catch(e){return(new t).reject(e).promise}}t.run=a})(s=e.Task||(e.Task={}));(function(e){e.all=s.waitAll;e.race=s.waitAny;e.reject=function(e){return(new s).reject(e).promise};e.resolve=s.wait})(u=e.Promise||(e.Promise={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(e){if(typeof exports=="object"){exports.deferred=e.Task;exports.resolved=e.Promise.resolve;exports.rejected=e.Promise.reject}})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(n,r){var i=function(){var t=i.enabled;if(t())return n.apply(this,arguments);var r=e.Exception("CommandDisabled",{reason:t.reason});if(e.isAsyncFunction(n))return(new e.Task).reject(r).promise;else throw r};function a(){return"[Command: enabled = "+i.enabled()+"]"}function o(e){return t(function(){return i.apply(e,arguments)},i.enabled)}if(n&&n[e.sIsAsync])e.setHiddenProperty(i,e.sIsAsync,true);return e.extend(i,{constructor:t,enabled:r&&r.asReadOnly(),bind:o,toString:a})}e.Command=t;function n(n,r){return t(e.async(n),r)}e.AsyncCommand=n;function r(n){return e.extend(n,{constructor:t,toString:function(){return"[Command: enabled = true]"},enabled:e.ConstProperty(true)})}e.EnabledCommand=r;function i(t){return r(e.async(t||function(){return null}))}e.EnabledAsyncCommand=i;(function(e){e.async=i})(r=e.EnabledCommand||(e.EnabledCommand={}));function a(n){if(n!==void 0)return t(e.noop,e.ConstProperty(false,n));if(!a.instance)a.instance=t(e.noop,e.ConstProperty(false));return a.instance}e.DisabledCommand=a;(function(e){})(a=e.DisabledCommand||(e.DisabledCommand={}));function o(n){if(n!==void 0)return t(e.async(e.noop),e.ConstProperty(false,n));if(!o.instance)o.instance=t(e.async(e.noop),e.ConstProperty(false));return o.instance}e.DisabledAsyncCommand=o;(function(e){})(o=e.DisabledAsyncCommand||(e.DisabledAsyncCommand={}));(function(e){e.async=n;e.enabled=r;e.disabled=a})(t=e.Command||(e.Command={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict"
;var n=function(){function n(e){if(e===void 0){e={}}if(!(this instanceof n))return new n(e);t.extend(this,e);this._listeners=[];this._modes=[];this._locked=false;this.observer=n.Observer(this)}n.prototype.fire=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var n=this;if(n._enqueue(n,n._fire,arguments))return;n._fire.apply(n,arguments);n._dequeue()};n.prototype._invoke=function(r,i,a){var o=this;if(a=="async"&&!e.isUnitTested){t.defer.call(o,o._invoke,r,i,"sync")}else{try{r.apply(null,i)}catch(e){n.uncaught["_event"].fire(e);if(e!=n._ie){if(console&&console.log){console.log(e&&e.stack||e);console.log(Error().stack)}}}}};n.prototype.observed=function(){return this._listeners.length>0};n.prototype._fire=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var n,r=this;for(n=0;n<r._listeners.length;n++)r._invoke(r._listeners[n],arguments,r._modes[n])};n.prototype._enqueue=function(e,t,n){var r=this;if(r._locked){r._queue=r._queue||[];r._queue.push([e,t,n])}else{r._locked=true}return r._queue&&r._queue.length>0};n.prototype._dequeue=function(){var e,t=this;if(t._queue){while(e=t._queue.shift())e[1].apply(e[0],e[2]);t._queue=null}t._locked=false};return n}();t.Event=n;(function(e){var n=function(){function e(e,t){this.event=e;this.listener=t}e.prototype.dispose=function(){this.event.off(this.listener)};return e}();e.Subscription=n;var r=function(){function n(n){var r=function(n,i){r.on(n,i);if(t.isFunction(i))i(this);return new e.Subscription(r,n)};t.setPrototypeOrExtend(r,e.Observer.prototype);r._event=n;return r}n.prototype.toString=function(){var e=this._event._listeners.length;return"[Event"+(e?": "+e+" listener"+(e==1?"":"s"):"")+"]"};n.prototype.on=function(e,t){var n=this._event;if(n._enqueue(this,this._addListener,[e,t]))return;this._addListener(e,t);n._dequeue()};n.prototype._addListener=function(e,n){var r=this._event;t.assert(t.isFunction(e));if(r.adding)r.adding.call(r.context,e);r._listeners.push(e);r._modes.push(n);if(r.added)r.added.call(r.context,e);if(r._listeners.length==1&&r.subscribed)r.subscribed.call(r.context)};n.prototype.off=function(e){var t=this._event;if(t._enqueue(this,this._removeListener,[e]))return;this._removeListener(e);t._dequeue()};n.prototype._removeListener=function(e){var n=this._event;var r=t.indexOf(n._listeners,e);if(r>=0){n._listeners.splice(r,1);n._modes.splice(r,1);if(n._listeners.length==0&&n.unsubscribed)n.unsubscribed.call(n.context)}};return n}();function i(e){return r(e)}e.Observer=i;i.prototype=r.prototype;e.uncaught=(new e).observer})(n=t.Event||(t.Event={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=function(){function e(e){this.dispose=e}return e}();t.Subscription=n;var r=function(){function r(e){this._callbacks=e;this._subscriptions=[];this._period=Infinity;this._timer=null}r.prototype.subscribe=function(e){var r=this;if(e===void 0){e=0}var i=new n(function(){if(!i)throw t.Exception("AlreadyDisposed");t.removeItem(r._subscriptions,function(e){return e.sub===i});i=null;r._update()});t.insertItem(this._subscriptions,{sub:i,dt:e},function(e,t){return e.dt<t.dt});this._update();return i};r.prototype._update=function(){var t=this._subscriptions.length>0?this._subscriptions[0].dt:Infinity;var n=this._callbacks;if(t!=this._period){if(this._timer)e.clearInterval(this._timer);this._timer=null;if(t==0&&n.subscribed)n.subscribed();if(this._period==0&&n.unsubscribed)n.unsubscribed();this._period=t;if(this._period>0&&this._period<Infinity&&n.updated)this._timer=e.setInterval(n.updated,this._period*1e3|0)}};return r}();t.RefCountedSubscription=r})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=function(){function e(e){if(e===void 0){e="wm"}this._sTag=t.Symbol(e,true)}e.prototype.get=function(e){return e[this._sTag]};e.prototype.set=function(e,n){t.setHiddenProperty(e,this._sTag,n)};e.prototype.has=function(e){return this._sTag in e};e.prototype.delete=function(e){delete e[this._sTag]};return e}();t.WeakMap=n;t.WeakMap=!e.isUnitTested&&e.window["WeakMap"]||n})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(e){return o(e)}t.Property=n;var i;var a=new t.WeakMap;var o=function(){function r(e){var r=u;var a=e&&e.get;var o=e&&e.set;var s=e&&e.readOnly;if(e&&e.value!==void 0)r._value=e.value;if(e&&e.reason!==void 0)r.reason=e.reason;if(e&&e.check)r._check=e.check;if(a)r._getter=t.async(a);if(s)r._ro=r;if(o)r._setter=t.async(o,"sync");if(e&&e.subscribed)r._subscribed=e.subscribed;if(e&&e.unsubscribed)r._unsubscribed=e.unsubscribed;t.setPrototypeOrExtend(r,n.prototype);t.extend(r,{get:t.isCommand(a)?t.Command(r._getAsync,a.enabled):t.EnabledCommand(r._getAsync),set:s?t.DisabledAsyncCommand():t.isCommand(o)?t.Command(r._setAsync,o.enabled):t.EnabledCommand(r._setAsync)});Object.defineProperty(r,"changed",{get:r._getChanged});function u(e,t){if(arguments.length==0){if(i)i.push(r);return r._value}else{r._write(e,t);return this}}return r}r.prototype.toString=function(){return"[Property: value = "+this._value+"]"};r.prototype.or=function(e){return d([this,e],function(e,t){return e||t})};r.prototype.and=function(e){return d([this,e],function(e,t){return e&&t})};r.prototype.map=function(e,r){var i=this,a,o=n({get:t.Command(function(){return i.get().then(e)},i.get.enabled),subscribed:function(){return a=i.subscribe()},unsubscribed:function(){return a.dispose()}});i.changed(function(t,n){o(e(t),n)});return o.fork(t.Command(function(t){return i.set(r(t)).then(e)},r?i.set.enabled:s(false)))};r.prototype.when=function(e,n){var r=this.changed;var i={dispose:function(){return r.off(o)}};var a=t.isFunction(e)?e:function(t){return t===e};function o(e,t,r){if(a(e))n.call(i,t,r)}r(o);return i};r.prototype.once=function(e,t){return this.when(e,function(){this.dispose();t.apply(null,arguments)})};r.prototype.equals=function(e){return this.map(function(t){return t==e})};r.prototype.equalsAny=function(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}return this.map(function(n){return t.contains(e,function(e){return e==n})})};r.prototype.fork=function(e){var r=this;var i;var a=t.isProperty(e)?e:e.enabled||s(true);var o=a===s(false);var u=n({value:r._value,reason:r.reason,readOnly:o,set:o?null:t.isProperty(e)?t.Command(function(e,t){return r.set(e,t)},a):t.Command(function(n,i){return t.async(e)(n,i).then(function(e){return r.set(e,i)})},a),get:r.get.bind(r),subscribed:function(){return i=r.subscribe()},unsubscribed:function(){return i.dispose()}});(r._forks=r._forks||[]).push(u);return u};r.prototype.asReadOnly=function(){var e=this;if(!e._ro)e._ro=e.fork(t.DisabledAsyncCommand());return e._ro};r.prototype.observed=function(){var e=this,t=e._changed;return t&&t.observed()};r.prototype.subscribe=function(e){var n=this;var r=new t.RefCountedSubscription({unsubscribed:n._unsubscribed,subscribed:n._subscribed,updated:function(){return n.get()}});n.subscribe=function(e){return r.subscribe(e)};return n.subscribe(e)};r.prototype._set=function(e,t){var n=this,r=n._value,i,a=n._forks,o=n._changed;if(!n._same(e,t)){n._value=e;n.reason=t;if(o)o.fire(e,t,r);if(a){for(i=0;i<a.length;i++)a[i]._set(e,t)}}return e};r.prototype._same=function(e,n){var r=this;return t.deepEqual(e,r._value)&&t.deepEqual(n,r.reason)};r.prototype._getChanged=function(){var e=this;if(!e._changed){e._changed=new t.Event({context:e,added:e._listenerAdded})}return e._changed.observer};r.prototype._listenerAdded=function(e){var t=this,n=t._changed,r=t._value,i=t.reason;if(r!==void 0)n._invoke(e,[r,i])};r.prototype._getAsync=function(){var e=this,t=e._getter,n=e._value;if(!t)return n;if(!e._dfdget)e._dfdget=t.call(e,n,e.reason);return e._dfdget.then(function(t){e._dfdget=null;e._set(t,e.reason);return e._value},function(t){e._dfdget=null;throw t})};r.prototype._setAsync=function(e,n){var r=this,i=r._check,a=r._setter;t.assert(arguments.length>0);this._scheck(e);if(r._same(e,n))return e;if(i)i(e);return a?this._sinvoke(e,n):r._set(e,n)};r.prototype._write=function(e,t){var r=this,i=r._check,a=r._setter;this._scheck(e);if(r._same(e,t))return;if(i)i(e);if(!r.set.enabled())throw Error("This is a read-only property.");return a&&t!==n.sUpdated?this._sinvoke(e,t):r._set(e,t)};r.prototype._scheck=function(e){if(a.get(this)){try{console.warn("Property::set("+e+") is not re-entrant: simultaneous calls interfere with each other.")}catch(e){}}};r.prototype._sinvoke=function(t,r){var i=this;var o=this._setter(t,r).then(function(e){return i._set(e,r)});if(!e.isUnitTested&&n.srcheck){var s=a.get(this)||0;a.set(this,s+1);o.finally(function(){var e=a.get(i);if(e==1)a.delete(i);else a.set(i,e-1)})}return o};return r}();r([t.async],o.prototype,"_getAsync",null);r([t.async.bind("sync")],o.prototype,"_setAsync",null);n.prototype=t.extend(function(){},o.prototype,{constructor:n});(function(e){e.srcheck=false})(n=t.Property||(t.Property={}));function s(e,t){if(t===void 0){if(e===null)return n["null"];if(e===true)return n["true"];if(e===false)return n["false"]}return n({value:e,reason:t,readOnly:true})}t.ConstProperty=s;(function(e){e.sUpdated={};var n=e({value:true,readOnly:true});var r=e({value:false,readOnly:true});e["true"]=n;e["false"]=r;n.get.enabled=n;n.set.enabled=r;r.get.enabled=n;r.set.enabled=r;t.DisabledAsyncCommand.instance.enabled=r;var i=e({value:null,readOnly:true});e["null"]=i})(n=t.Property||(t.Property={}));(function(e){function n(e,n){if(e.length==0){r(n);return new t.Subscription(t.noop)}var i=e.map(function(t){return t.changed(function(){var t=e.map(function(e){return e()});n.apply(null,t)})});return new t.Subscription(function(){for(var e=0,t=i;e<t.length;e++){var n=t[e];n.dispose()}})}e.observe=n;function r(e){var n=[];function r(){t.assert(!i);i=[];e();var a=i;i=null;for(var o=0,s=n;o<s.length;o++){var u=s[o];if(a.indexOf(u)<0)u.changed.off(r)}for(var c=0,d=a;c<d.length;c++){var u=d[c];if(n.indexOf(u)<0)u.changed.on(r)}n=a}r()}})(n=t.Property||(t.Property={}));function u(e,t){var r=n({value:e,reason:t});r.inc=function(){return r(r()+1)};r.dec=function(){return r(r()-1)};return r}t.NumProperty=u;function c(e,t){var r=n({value:e,reason:t});r.not=function(){return r.map(function(e){return!e})};return r}t.BoolProperty=c;function d(e,r){var i;var a=n({get:function(){var n=t.map(e,function(e){return e.get()});return t.Task.waitAll(n).then(function(e){return r.apply(null,e)})},subscribed:function(){i=t.map(e,function(e){return e.subscribe()})},unsubscribed:function(){t.foreach(i,function(e){return e.dispose()})}});n.observe(e,function(){a(r.apply(null,arguments))});return a.asReadOnly()}t.ComputedProperty=d;(function(e){e.computed=d;e.bool=c;e.just=function(t){return e({value:t})};e.readonly=s;e.numeric=u})(n=t.Property||(t.Property={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(t){var n;(function(n){"use strict";function r(e){return i(e)}n.Collection=r;var i=function(){function i(e){var t=a;t._=n.extend({},e);var i=t._;if(e&&e.get)i.get=n.async(e.get);i.vals=[];i.keys=[];i.idxs={};function a(e){if(arguments.length==0){return t._asArray()}else if(n.isArray(e)){t.empty();t._addArray(e);return this}else{return t._getFromCache(e)}}n.setPrototypeOrExtend(t,r.prototype);t._init();return t}i.prototype.subscribe=function(e){var t=this,r=t._;var i=new n.RefCountedSubscription({unsubscribed:r.unsubscribed,subscribed:r.subscribed,updated:function(){return t.get()}});t.subscribe=function(e){return i.subscribe(e)};return t.subscribe(e)};i.prototype.observed=function(){var e=this._,t=e.added,n=e.removed,r=e.changed;return t&&t.observed()||n&&n.observed()||r&&r.observed()};i.prototype.add=function(e,t,r){var i=this._,a=i.vals.length;t=t||(i.key?i.key(e):n.random());if(t in i.idxs)throw n.EAlreadyExists(t);r=n.isInteger(r)?r:a;if(r<0)r=0;if(r>a)r=a;this._insert(e,t,r);if(i.size)i.size.inc();if(i.added)i.added.fire(e,t,r);if(i.changed)i.changed.fire();return t};i.prototype.remove=function(e){var t=this._,r,i,a;if(n.isInteger(e)){r=e;e=t.keys[r]}else{r=t.idxs[e]}i=t.vals[r];if(r>=0&&r<t.vals.length){for(a=r+1;a<t.keys.length;a++)t.idxs[t.keys[a]]--;n.removeAt(t.vals,r);n.removeAt(t.keys,r);delete t.idxs[e];if(t.size)t.size.dec();if(t.removed)t.removed.fire(i,e,r);if(t.changed)t.changed.fire()}};i.prototype.removeAll=function(e){var t=this._,n=t.vals.length,r=[];for(var i=0;i<n;i++){var a=t.vals[i];var o=t.keys[i];if(e(a))r.push(o)}for(var s=0,u=r;s<u.length;s++){var c=u[s];this.remove(c)}return r.length};i.prototype.get=function(e){var t=this,r=t._,i=r.get,a;if(i&&!r.dfdget)r.dfdget=i();if(r.dfdget){a=r.dfdget.then(function(e){r.dfdget=null;return t._setNewItems(e)},function(e){r.dfdget=null;throw e})}return n.Task.wait(a).then(function(){return n.isVoid(e)?t._asArray():t._getFromCache(e)})};i.prototype.index=function(e){return this._.idxs[e]};i.prototype.key=function(e){return this._.keys[e]};i.prototype.empty=function(){var e=this._,t;if(e.removed){for(t=0;t<e.vals.length;t++)e.removed.fire(e.vals[t],e.keys[t])}e.vals=[];e.keys=[];e.idxs={};if(e.size)e.size(0);if(e.changed)e.changed.fire()};i.prototype.asReadOnly=function(){var e=this,t=r;function r(t){return arguments.length==0?e._asArray():e._getFromCache(t)}n.setPrototypeOrExtend(t,e);t._init();t.add=null;t.remove=null;t.empty=null;return t};i.prototype.fork=function(e){var t=this;var r=a;function i(e){return n.isCommand(e)?n.Command(n.async(e),e.enabled):n.isFunction(e)?n.EnabledCommand(n.async(e)):n.DisabledAsyncCommand(n.ENotSupported())}function a(e){return arguments.length==0?t():t(e)}n.setPrototypeOrExtend(r,t);n.extend(r,{add:i(e.add),remove:i(e.remove)});r._init();return r};i.prototype.asWritable=function(e){return this.fork(e)};i.prototype.toString=function(){return"[Collection: "+this.size()+" items]"};i.prototype.each=function(e){var t=this._;for(var n=0;n<t.vals.length;n++)e(t.vals[n],t.keys[n]);return this};i.prototype.contains=function(e){var t=false;this.each(function(n){if(e(n))t=true});return t};i.prototype.observe=function(n){var r,i=this,a={},o={};var s=e["$window"]||t.window,u=s.setTimeout,c=s.clearTimeout;function d(e,t){a[t]=e;delete o[t];f()}function l(e,t){o[t]=e;delete a[t];f()}function f(){if(!r){r=u(function(){var e=a,t=o;a={};o={};r=null;n(e,t)},0)}}function p(){if(r){c(r);r=null}}i.added(d);i.removed(l);return{dispose:function(){p();i.added.off(d);i.removed.off(l)}}};i.prototype.map=function(e){var t=this,n,i=r({get:function(e){return t.get().then(function(){return i(e)})},subscribed:function(){n=t.subscribe()},unsubscribed:function(){n.dispose()}});t.added(function(t,n,r){i.add(e(t),n,r)});t.removed(function(e,t){i.remove(t)});return i.asReadOnly()};i.prototype.filter=function(e){var t=this,n,i=r({get:function(e){return t.get().then(function(){return i(e)})},subscribed:function(){n=t.subscribe()},unsubscribed:function(){n.dispose()}});t.added(function(n,r,a){if(!e(n))return;var o=a+1;var s=t.size();while(o<s&&!e(t(o)))o++;var u=o<s?i.index(t.key(o)):i.size();i.add(n,r,u)});t.removed(function(e,t){i.remove(t)});return i.asReadOnly()};i.prototype.sort=function(e){var t=this,n,i=r({get:function(e){return t.get().then(function(){return i(e)})},subscribed:function(){n=t.subscribe()},unsubscribed:function(){n.dispose()}});function a(t,n){return e(t,n)||!e(n,t)}t.added(function(e,n,r){var o=i.size(),s=0;while(s<o&&!a(e,i(s)))s++;while(s<o&&a(i(s),e)&&t.index(i.key(s))<r)s++;i.add(e,n,s)});t.removed(function(e,t){i.remove(t)});return i.asReadOnly()};i.prototype.reduce=function(e,t){var r=this;var i=n.Property();var a=this._.vals;n.Property.observe([],function(){r.size();var n=a.reduce(e,t);i(n)});return i.asReadOnly()};i.prototype._init=function(){var e=this;Object.defineProperties(e,{added:{enumerable:true,get:e._initAddedEvent},removed:{enumerable:true,get:e._initRemovedEvent},changed:{enumerable:true,get:e._initChangedEvent},size:{enumerable:true,get:e._initSizeProperty}})};i.prototype._getFromCache=function(e){var t=this._;return n.isString(e)?t.vals[t.idxs[e]]:t.vals[e]};i.prototype._setNewItems=function(e){var t=this,r=t._,i;if(!n.isDictionary(e))return;for(i in r.idxs)if(!(i in e)||r.vals[r.idxs[i]]!==e[i])t.remove(i);for(i in e)if(!(i in r.idxs))t.add(e[i],i)};i.prototype._initAddedEvent=function(){var e=this,t=e._,r="added",i;t[r]=t[r]||new n.Event({context:e,adding:e._addedListenerAdding});i=t[r].observer;return i};i.prototype._addedListenerAdding=function(e){var t=this,r=t._,i=r.added;n.foreach(r.vals,function(t,n){i._invoke(e,[t,r.keys[n],n])})};i.prototype._initRemovedEvent=function(){var e=this,t=e._,r="removed",i;t[r]=t[r]||new n.Event;i=t[r].observer;return i};i.prototype._initChangedEvent=function(){var e=this,t=e._,r="changed",i;t[r]=t[r]||new n.Event({context:e,added:e._changedListenerAdded});i=t[r].observer;return i};i.prototype._changedListenerAdded=function(e){var t=this,n=t._,r=n.changed;r._invoke(e,[])};i.prototype._initSizeProperty=function(){var e=this,t=e._,r="size",i;t[r]=t[r]||n.NumProperty(t.vals.length);i=t[r].asReadOnly();return i};i.prototype._insert=function(e,t,r){var i,a=this._,o=a.vals.length;for(i=r;i<o;i++)a.idxs[a.keys[i]]++;n.insertAt(a.vals,r,e);n.insertAt(a.keys,r,t);a.idxs[t]=r};i.prototype._addArray=function(e){for(var t=0;t<e.length;t++)this.add(e[t])};i.prototype._asArray=function(){return this._.vals.slice(0)};return i}();r.prototype=n.extend(function(){},i.prototype,{constructor:r});(function(e){e.empty=e().asReadOnly()})(r=n.Collection||(n.Collection={}));function a(e){var t=r();t(e);return t.asReadOnly()}n.ConstCollection=a})(n=t.Utils||(t.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t){var n,r,i,a=false,o=e.Property({value:false}),s=[];var u=e.Property({get:function(){return n&&n.get()},set:e.Command(function(t,r){function i(e,t){return n.set(e,t).then(function(){return u()})}if(!n)return;var a=s.length==0?e.Promise.resolve(null,"sync"):s[s.length-1].promise;s.push(new e.Task);return a.then(function(){return i(t,r)}).finally(function(){s.shift().resolve()})},o),subscribed:function(){a=true;r=n&&n.subscribe()},unsubscribed:function(){a=false;if(r){r.dispose();r=null}}});u.setSource=function(t){e.assert(e.isProperty(t)||!t);if(n===t)return;n=t;o(!!n);if(i){i.dispose();i=null}if(n){i=n.changed(function(e,t){u._set(e,t)});if(n()===void 0)u._set(n())}if(r){r.dispose();r=null}if(a&&n)r=n.subscribe();if(!n)u._set(void 0)};u.setSource(t);return u}e.SourcedProperty=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(){var t,n=e.SourcedProperty();n.setSource(e.ConstProperty(false));var r=e.Command(function(){return t.apply(null,arguments)},n);r.setSource=function(r){e.assert(e.isCommand(r)||!r);t=r;n.setSource(t?t.enabled:e.ConstProperty(false))};return r}e.SourcedCommand=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(n){var r=e.Model(e.map(n,function(n){return e.isProperty(n)?e.SourcedProperty():e.isModel(n)?t(n):e.isCommand(n)?e.SourcedCommand():e.assert(false)}));e.setHiddenProperty(r,"setSource",function(e){for(var t in r)r[t].setSource(e&&e[t])});return r}e.SourcedModel=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(e){return t.inherit(n.prototype,e)}t.Model=n;function i(n,r){if(t.isModel(n))return n.toJSON(r);if(t.isCollection(n))return t.map(n(),function(e){return i(e,r)});if(t.isProperty(n))return i(n(),r);if(t.isCommand(n))return{enabled:!!n.enabled()};if(t.isFunction(n))return{enabled:true};if(n instanceof e.Date)return n.toJSON();return n}var a=function(){function e(){}e.prototype.toJSON=function(e){return t.map(this,function(t,n){if(n=="constructor")return undefined;var r=e&&e[n];if(e&&!r)return undefined;return i(t,r===true?null:r)})};e.prototype.toString=function(e){if(e===void 0){e=4}return JSON.stringify(this.toJSON(),null,e).replace(/{\s*\n\s*("\w+"):\s*(\w+)\s*\n\s*}/gm,"{ $1: $2 }")};return e}();r([t.hidden],a.prototype,"toJSON",null);r([t.hidden],a.prototype,"toString",null);t.BaseModel=a;n.prototype=a.prototype})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=function(){function e(e){this._exec=e}e.prototype.exec=function(e,t){if(t===void 0){t=0}var n=this._exec(e,t);if(arguments.length==2)return n;if(!n||n[1]!=e.length)return null;return n[0]};e.prototype.then=function(t){var n=this;return new e(function(e,r){var i=n.exec(e,r);if(!i)return null;var a=i[0],o=i[1];return[t(a,e,r,o),o]})};e.prototype.text=function(){return this.then(function(e,t,n,r){return t.slice(n,r)})};e.prototype.select=function(e){return this.then(function(t){return t[e]})};e.prototype.merge=function(e){if(e===void 0){e=""}return this.then(function(t){return t.join(e)})};e.prototype.join=function(e,t){return this.then(function(n){var r={};for(var i=0,a=n;i<a.length;i++){var o=a[i];r[o[e]]=o[t]}return r})};return e}();e.Pattern=t;function n(e){return new t(function(t,n){if(t.slice(n,n+e.length)==e)return[e,n+e.length]})}e.txt=n;function r(e){return new t(function(t,n){var r=e.exec(t.slice(n));if(r&&r.index==0)return[r[0],n+r[0].length]})}e.rgx=r;function i(e,n){return new t(function(t,r){return e.exec(t,r)||[n,r]})}e.opt=i;function a(e,n){return new t(function(t,r){return!n.exec(t,r)&&e.exec(t,r)})}e.exc=a;function o(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}return new t(function(t,n){var r=[];for(var i=0,a=e;i<a.length;i++){var o=a[i];var s=o.exec(t,n);if(!s)return;r.push(s[0]);n=s[1]}return[r,n]})}e.seq=o;function s(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}return new t(function(t,n){for(var r=0,i=e;r<i.length;r++){var a=i[r];var o=a.exec(t,n);if(o)return o}})}e.any=s;function u(e){return new t(function(t,n){var r,i=[];while(r=e.exec(t,n)){i.push(r[0]);n=r[1]}return[i,n]})}e.rep=u;function c(e,t){var n=o(t,e).select(1);var r=o(e,u(n)).then(function(e){return[e[0]].concat(e[1])});return i(r,[])}e.sep=c;function d(e,t){var n=r(/\\./).then(function(e){return e.slice(1)});var i=s(n,a(r(/./),t));return o(e,u(i),t).select(1).merge()}e.quoted=d})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=function(){function e(t){var n=this;var r;if(!(this instanceof e))return new e(t);r=e.pattern.exec((t||"")+"");if(!r)throw new SyntaxError("Invalid URI: "+t);function i(e){var t=function(t){if(arguments.length==0)return(r[e]||"")+"";r[e]=(t||"")+"";return this};t.toString=function(){return t()};return t}this.scheme=i("scheme");this.user=i("user");this.host=i("host");this.port=i("port");this.path=i("path");this.query=i("query");this.hash=i("hash");this.query.get=function(t){return e.Query(n.query())[t]};this.query.set=function(t,r){var i=e.Query(n.query());i[t]=r;n.query(i+"")};this.origin=function(){var e=function(e,t){return t?e+t:""};var t=(!n.user()?"":n.user()+"@")+(n.host()||"")+e(":",n.port());return(n.scheme()?n.scheme()+":":"")+e("//",t)}}e.prototype.toString=function(){var e=function(e,t){return t?e+t:""};var t=(!this.user()?"":this.user()+"@")+(this.host()||"")+e(":",this.port());return(this.scheme()?this.scheme()+":":"")+e("//",t)+this.path()+e("?",this.query())+e("#",this.hash())};return e}();e.URI=t;(function(t){t.pattern={regexp:/^(?:([a-zA-Z][\w+-.]*):)?(?:\/\/(?:([^\/@]*)@)?([^:\/?#]*)(?:\:(\d*))?)?([^?#]*)(?:\?([^#]*))?(?:#(.*))?$/,exec:function(e){var t=this.regexp.exec(e);return t&&{scheme:t[1],user:t[2],host:t[3],port:t[4],path:t[5],query:t[6],hash:t[7]}}};function n(t){if(!(this instanceof n))return new n(t);var r=this;if(e.isString(t)){e.foreach(t.split("&"),function(t){var n,i,a=t.indexOf("=");if(a<0){n=t;i=""}else{n=t.slice(0,a);i=t.slice(a+1)}if(n)r[e.DataUri.decodeData(n)]=e.DataUri.decodeData(i)})}else if(t){e.foreach(e.clone(t),function(e,t){r[t]=e})}}t.Query=n;n.prototype.toString=function(){var t=[];e.foreach(e.clone(this),function(n,r){t.push(n?e.DataUri.encodeData(r)+"="+e.DataUri.encodeData(n):e.DataUri.encodeData(r))});return t.join("&")};Object.defineProperty(n.prototype,"toString",{enumerable:false});function r(e,n){if(!n)return e;var r=new t(e);var i=t.Query(r.query());for(var a in n)if(n[a]!==undefined)i[a]=n[a];r.query(i+"");return r+""}t.mergeQuery=r})(t=e.URI||(e.URI={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(e){var n=t.pattern.exec(e);if(!n)throw new SyntaxError("Invalid data URL: "+e);return n}e.DataUri=t;(function(e){function t(e){return encodeURIComponent(e).replace(/%20/gm,"+")}e.encodeData=t;function n(e){return decodeURIComponent(e.replace(/\+/gm," "))}e.decodeData=n})(t=e.DataUri||(e.DataUri={}));(function(t){var n=e.rgx(/[^()<>@,;:\\\x22\/\[\]?=\s]+/);var r=e.seq(n,e.txt("/"),n).merge();var i=e.rgx(/[^\uffff]*/).then(t.decodeData);var a=e.quoted(e.txt('"'),e.txt('"'));var o=e.seq(e.rgx(/\s*=\s*/),e.any(a,n)).select(1);var s=e.seq(e.rgx(/\s*;\s*/),n,e.opt(o,true));t.pattern=e.seq(e.txt("data:"),e.opt(r),e.rep(s).join(1,2),e.rgx(/\s*,\s*/),i).then(function(e){var t=e[1],n=e[2],r=e[4];return{mime:t,attributes:n,data:r,base64:!!n["base64"]}})})(t=e.DataUri||(e.DataUri={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(n){if(!(this instanceof t))return new t(n);var r=t.pattern.exec(n);if(!r)throw new SyntaxError("Invalid CSS style: "+n);e.extend(this,r)}e.Style=t;(function(t){var n=e.rgx(/[\x00-\x20]+/);var r=e.rgx(/[,\x00-\x20]+/);var i=e.rgx(/#[\da-fA-F]+/i);var a=e.rgx(/[+-]?(\d+[\.]?\d*|\.\d+)/);var o=e.seq(a,e.opt(e.rgx(/%|[a-z]+/i))).text();var s=e.any(e.quoted(e.txt('"'),e.txt('"')),e.quoted(e.txt("'"),e.txt("'")));var u=e.rgx(/[a-z][a-z-]*[a-z]|[a-z]/i);var c=e.any(o,s,u,i).text();var d=e.seq(u.text(),e.opt(n),e.txt(":"),e.opt(n),e.sep(c,r));var l=e.seq(e.opt(n),e.txt(";"),e.opt(n));var f=e.seq(e.sep(d,l),e.opt(l)).select(0);t.pattern=f.join(0,4)})(t=e.Style||(e.Style={}));e.setHiddenProperty(t.prototype,"toString",function(){var e,t=[],n=this;for(e in n)t.push(e+":"+n[e].join(" "));return t.join(";")})})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t={lt:"<",gt:">",amp:"&",nbsp:" ",quot:'"'};function n(e){return e.replace(/&(#?\w+);/gm,function(e,n){return n.charAt(0)=="#"?String.fromCharCode(+n.slice(1)):t[n]})}function r(t){if(!(e.isString(t)||t&&t.ast))throw new Error("Invalid argument: "+t);if(!(this instanceof r))return new r(t);var n,i;try{n=t.ast||r.pattern.exec(t);if(!n)throw void 0}catch(e){i=new SyntaxError("Invalid XML: "+t);i.reason=e;throw i}var a=n.attrs||{};var o=(n.nodes||[]).map(function(t){return r({ast:e.isString(t)?{text:t}:t})});var s=function(e,t){return e+t.text()};var u=function(){return n.name};var c=function(){return n.text||o.reduce(s,"")};this.attrs=a;this.nodes=o;this.name=u;this.text=c}e.XmlNode=r;r.prototype.toString=function(){var t="",n="",r=this,i=r.name();e.foreach(r.attrs,function(n,r){t+=" "+r;if(!e.isVoid(n))t+='="'+n.replace(/\x22/gm,"&quot;")+'"'});e.foreach(r.nodes,function(e){n+=e});n=n||r.text().replace(/</gm,"&lt;").replace(/>/gm,"&gt;");return!i?n:!n?"<"+i+t+"/>":"<"+i+t+">"+n+"</"+i+">"};r.prototype.attr=function(t){e.assert(t in this.attrs,"Attribute does not exist: "+this.name()+"."+t);return this.attrs[t]};r.prototype.selectOne=function(t,n){var r=e.filter(this.nodes,e.isFunction(t)?t:function(e){var r,i;if(n){for(r in n){i=r.toLowerCase();if(n[i]!=e.attrs[i])return false}}return e.name()==t.toLowerCase()});e.assert(r.length==1,"Single node expected: "+t);return r[0]};(function(t){var r=e.rgx(/[\x00-\x20]*/);var i=e.rgx(/\x22[^\x22]*\x22/).then(function(e){return e.slice(+1,-1)});var a=e.rgx(/[^\s<>\x22]+/);var o=e.any(i,a).then(n);var s=e.rgx(/[^<]+/m).then(n);var u=e.rgx(/[\w:-]+/).then(function(e){return e.toLowerCase()});var c=e.seq(u,e.opt(e.seq(r,e.txt("="),r,o).select(3)));var d=e.sep(c,r).join(0,1);var l=e.seq(e.txt("<"),r);var f=e.seq(r,e.txt(">"));var p=e.rgx(/<!--[\s\S]*?-->/m).then(function(e){return{name:"--"}});var v=e.seq(l,u,r,d,f).then(function(e){return{name:e[1],attrs:e[3]}});var h=e.seq(l,u,r,d,e.seq(r,e.txt("/>"))).then(function(e){return{name:e[1],attrs:e[3]}});var m=e.seq(e.txt("</"),r,u,f).select(2);var g=new e.Pattern(function(e,n){return t.pattern.exec(e,n)});var y=e.seq(v,e.rep(e.any(g,s,p)),m).then(function(e){var t=e[0],n=e[1],r=e[2];if(t.name!=r)throw new SyntaxError("</"+r+"> does not match <"+t.name+">");return{name:r,nodes:n,attrs:t.attrs}});t.pattern=e.any(y,h)})(r=e.XmlNode||(e.XmlNode={}));function i(t){return{root:r(e.trim(t.replace(/^<\?.+?\?>/,"")))}}e.XmlDoc=i})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=/^(body|b|i|u|s|span|table|tr|td|th|br|div|hr|p|h\d|font|a)$/i;var n=/^(style|width|height|color|face|size|href)$/i;var r=/^(font(-[a-z]+)?|margin(-[a-z]+)?|line(-[a-z]+)?|color)$/i;function i(t){var n=t.replace(/<(br|meta)\b(.*?)\/?>/gim,"<$1$2/>");n=/^\s*<html\b[\s\S]*<\/html>\s*$/gim.test(n)?e.trim(n):"<html><body>"+n+"</body></html>";return e.XmlNode(n).selectOne("body")}function a(e){return e.replace(/[<>&;#\/]/gm,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/\r\n|\n/gm,function(){return"<br>"})}e.convertTextToHtml=a;function o(e){return i(e.replace(/<br\s*\/?>/gi,"\r\n").replace(/&(nbsp|#160);/gi," ")).text()}e.convertHtmlToText=o;function s(a){function o(e){var t,r=e.attrs;for(t in r){if(!n.test(t))delete r[t]}}function s(t){var n,i,a=t.attrs.style;if(a){n=e.Style(a);for(i in n){if(!r.test(i))delete n[i]}t.attrs.style=n+""}}function c(n){var r,i,a=n.nodes;o(n);s(n);for(r=0;r<a.length;r++){i=a[r].name();if(i&&!t.test(i))e.removeAt(a,r--);else c(a[r])}return n}try{return a&&c(i(a)).nodes.join("")}catch(e){return u(a)}}e.sanitizeHtml=s;function u(e){return e&&e.replace(/</gm,"〈").replace(/>/gm,"〉")}e.disableHtmlInText=u})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(e){var n=t.pattern.exec(e||"");if(n)return n;throw new SyntaxError("Invalid WWW-Authenticate header:\n"+e)}e.WWWAuthenticateHeader=t;(function(t){var n=e.rgx(/[\s,]*/);var r=e.rgx(/[^\s,=]+/);var i=e.quoted(e.txt('"'),e.txt('"'));var a=e.seq(r,e.rgx(/\s*=\s*/),i);var o=e.sep(a,n).join(0,2);var s=e.seq(r,n,o);t.pattern=e.sep(s,n).join(0,2)})(t=e.WWWAuthenticateHeader||(e.WWWAuthenticateHeader={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t;(function(e){function t(e){return 200<=e&&e<300}e.isSuccess=t})(t=e.Http||(e.Http={}));function n(t){var n={};var r=function(e){return e.toLowerCase().replace(/\b(\w)/g,function(e){return e.toUpperCase()})};function i(t){e.assert(e.isString(t));var n=t.split("\r\n");var r,i,a,o;for(var u=0;u<n.length;u++){if(o=e.trim(n[u])){r=o.indexOf(":");if(r>=0){i=e.trim(o.substr(0,r));a=e.trim(o.substr(r+1));s(i,a)}}}}function a(t){e.assert(e.isDictionary(t));for(var n in t)s(n,t[n]+"")}function o(t){e.assert(e.isNotEmptyString(t));return n[r(t)]}function s(t,i){e.assert(e.isNotEmptyString(t));t=r(t);if(n[t])n[t]+="\n"+i;else n[t]=i}function u(){
var e,t,r,i="";for(t in n){r=n[t].split("\n");for(e=0;e<r.length;e++)if(r[e])i+=t+": "+r[e]+"\r\n"}return i+"\r\n"}if(e.isNotEmptyString(t))i(t);else if(e.isDictionary(t))a(t);return{raw:n,get:o,add:s,toString:u}}e.HttpHeaders=n;(function(e){e.parse=function(t){return e(t).raw}})(n=e.HttpHeaders||(e.HttpHeaders={}));function r(t){var n=e.DataUri("data:"+t.replace(/\s/g,"")+",");return{mimeType:n.mime,attributes:n.attributes}}e.ContentTypeHeader=r})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(e,t,n){return t in e?e[t]:n}t.getOption=n;function r(e){var n;if(Object.keys){n=Object.keys(e)}else{n=[];t.foreach(e,function(e,t){n.push(t)})}return n}t.keys=r;function i(e,t){for(var n in e)if(!t(e[n],n))return false;return true}t.all=i;function a(n,r,i){var a,o=i||e.window,s=n.split(".");for(a=0;a<s.length;a++)o=o[s[a]]||(o[s[a]]={});for(a in r){t.assert(!(a in o),n+"."+a+" already exists");o[a]=r[a]}return o}t.namespace=a;function o(e,t){var n={};n[t]=e[t];return n}t.take=o;function s(e,n){var r;if(t.isArray(e)){r=[];t.foreach(e,function(e,t){if(n(e,t))r.push(e)})}else{r={};t.foreach(e,function(e,t){if(n(e,t))r[t]=e})}return r}t.filter=s;function u(e){t.assert(t.isArray(e)||t.isDictionary(e));return t.isArray(e)?e.length:r(e).length}t.size=u;function c(e,n){if(t.isArray(e)){for(var r=0;r<e.length;++r){if(n(e[r],r))return e[r]}}else{for(var r in e){if(n(e[r],r))return e[r]}}return null}t.find=c;function d(e,t){for(var n=0;n<e.length;++n){if(t(e[n],n))return n}return-1}t.findIndex=d;function l(e,n){function r(e,n){for(var r=0;r<e.length;r++){if(t.indexOf(n,e[r])<0){return false}}return true}return r(e,n)&&r(n,e)}t.setEqual=l;function f(e,t){var n=[];for(var r in e)if(t(e[r]))n.push(r);for(var i=0,a=n;i<a.length;i++){var r=a[i];delete e[r]}}t.removeAll=f;function p(e,t){var n={};try{for(var r=0,i=t;r<i.length;r++){var a=i[r];var o=a.split(".").filter(function(e){return e.trim()!=""});var s=true;var u=e;for(var c=0,d=o;c<d.length;c++){var l=d[c];if(!(l in u)){s=false;break}u=u[l]}if(s){var f=n;u=e;var p=0;for(;p<o.length-1;p++){f[o[p]]=f[o[p]]||{};f=f[o[p]];u=u[o[p]]}f[o[p]]=u[o[p]]}}}catch(e){}return n}t.pick=p;function v(n,r,i){if(i===void 0){i=function(e){return[]}}var a={};var o=[];(function n(s){for(var u=0,c=Object.keys(s).concat(i(s));u<c.length;u++){var d=c[u];o.push(d);var l=s[d];if(t.isPrimitive(l)||l instanceof e.Date)a[r(o)]=l;else n(l);o.pop()}})(n);return a}t.flatten=v})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t){var n=e.Property({value:t}),r=e.Property({value:t}),i={},a,o;function s(n,r){e.assert(!i[n]);e.assert(n>t);e.assert(e.isFunction(r));i[n]=e.async(r)}function u(){n(t);r(t);if(o)d(e.Exception("Reset"));a=null;o=null}function c(t){e.check(t>=r(),"InvalidTargetState",{currentTarget:r(),requestedTarget:t});if(t==n())return;if(t>r()){a=new e.Task("advancing to target state "+t,{cancel:d});r.set(t);l(a)}return a.promise}function d(e){o.cancel(e);o=null}function l(e){if(o)return;var t=n()+1;e.status("advancing to state "+t);o=i[t].call(null);o.then(function(i){o=null;n.set(t);if(n()<r())l(e);else e.resolve(i)},function(t){o=null;e.reject(t)})}return{defineState:s,reset:u,advanceTo:e.async(c),state:n.asReadOnly(),target:r.asReadOnly()}}e.SequentialStateMachine=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(n){return e.async(n)().then(function(){return e.extend(t(n),(r={},r[e.Task.sLocked]=true,r));var r})}e.repeat=t;function n(n){var r=[null];function i(e){r[0]=e;throw r}return t(e.bind(n,i)).catch(function(e){if(e===r)return r[0];throw e})}e.repeatAndExit=n;function r(n,r){e.assert(e.isNumber(r)&&r>0);var i=e.async(n);return t(function(){return i().then(e.bind(e.sleep,r))})}e.repeatDelayed=r})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t,n){e.assert(e.isFunction(t));e.assert(n>0);t=e.async(t);var r=0;var i=[];var a={};var o={};var s=[];var u={};function c(){e.assert(r<=n);while(r<n&&i.length>0)d()}function d(){var e=i.splice(0,1)[0];var n=o[e];var d=a[e];delete o[e];delete a[e];s.splice(0,1);r++;u[e]=t(n);u[e].then(function(e){return d.resolve(e)},function(e){return d.reject(e)},d.status).then(function(){r--;delete u[e];c()})}function l(e,t){var n=s.length;while(n>0&&t>s[n-1])n--;s.splice(n,0,t);i.splice(n,0,e)}function f(e,t){var n;if(u[e]){u[e].cancel(t)}else{a[e].reject(t);delete o[e];delete a[e];for(n=0;n<i.length;n++){if(i[n]==e){i.splice(n,1);s.splice(n,1);break}}}}return function(n,r){if(r==Infinity)return t(n);var i=e.random();var s=new e.Task("Waiting in the throttling queue.",{cancel:e.bind(f,i)});a[i]=s;o[i]=n;l(i,r);c();return s.promise}}e.throttle=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(e){var n,r,i=t.async(e);return function(){if(!r){n=r=i();r.finally(function(){r=null})}return n}}t.debounced=n;function r(t,n){var r,i;return function(a,o,s){if(r!=a){r=a;e.clearTimeout(i);i=e.setTimeout(function(){n(a,o,s)},t)}}}t.debounce=r})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(n,r){if(r===void 0){r=Infinity}var i=[];var a;function o(e,n,r){t.assert(t.isNumber(e));t.assert(r instanceof t.Task);var a=0;while(a<i.length&&e>i[a].priority)a++;i.splice(a,0,{priority:e,request:n,task:r})}function s(e){t.assert(e>0);t.assert(i.length>0);var n,r=[],a=[];for(n=i.length-1;n>=0&&r.length<e;n--){r.push(i[n].request);a.push(i[n].task)}i.splice(n+1,e);return{requests:r,tasks:a}}function u(e,t){var n;for(n=0;n<i.length;n++)if(i[n].task===e)break;if(n<i.length){i.splice(n,1);e.reject(t)}else{e.cancelled=true;e.reject(t)}}function c(){var e=s(r);function i(n){t.foreach(e.tasks,function(e,t){if(!e.cancelled)n(e,t)})}t.Task.wait(n(e.requests)).then(function(e){i(function(n,r){var i=t.isArray(e)?e[r]:e;t.Task.wait(i).then(function(e){return n.resolve(e)},function(e){return n.reject(e)},n.status)})},function(e){i(function(t){t.reject(e)})},function(e){i(function(t){t.status(e)})})}return function n(r,s){if(s===void 0){s=0}var d=new t.Task("Waiting in the batching queue.",{cancel:function(e){u(d,e)}});if(!a){a=e.setTimeout(function(){a=null;while(i.length>0)c()},0)}o(s,r,d);return d.promise}}t.batched=n})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function n(e,t){return(e%t+t)%t}var r;(function(t){function n(t){e.assert(e.isArray(t));var n="",r,i,a,o,s=0;while(s<t.length){r=t[s];if(r<0||r>255)throw new Error("Unexpected utf8 byte");if(r<128){n+=String.fromCharCode(r);s++}else if((r&224)==192){if(s+1>=t.length)throw new Error("Unexpected end of array");i=t[s+1];if(i<0||i>255||(i&192)!=128)throw new Error("Unexpected utf8 byte");n+=String.fromCharCode((r&31)<<6|i&63);s+=2}else if((r&240)==224){if(s+1>=t.length||s+2>=t.length)throw new Error("Unexpected end of array");i=t[s+1];a=t[s+2];if(i<0||i>255||(i&192)!=128)throw new Error("Unexpected utf8 byte");if(a<0||a>255||(a&192)!=128)throw new Error("Unexpected utf8 byte");n+=String.fromCharCode((r&15)<<12|(i&63)<<6|a&63);s+=3}else if((r&248)==240){if(s+1>=t.length||s+2>=t.length||s+3>=t.length)throw new Error("Unexpected end of array");i=t[s+1];a=t[s+2];o=t[s+3];if(i<0||i>255||(i&192)!=128)throw new Error("Unexpected utf8 byte");if(a<0||a>255||(a&192)!=128)throw new Error("Unexpected utf8 byte");if(o<0||o>255||(o&192)!=128)throw new Error("Unexpected utf8 byte");var u=(r&7)<<18|(i&63)<<12|(a&63)<<6|o&63;var c=55296-(65536>>10);var d=c+(u>>10);var l=56320+(u&1023);n+=String.fromCharCode(d);n+=String.fromCharCode(l);s+=4}else{throw new Error("Illegal utf8 converter input")}}return n}t.byteArrayToString=n;function r(t){e.assert(e.isString(t));var n=[];var r=0;while(r<t.length){var i=t.charCodeAt(r);if(i<128){n.push(i);r++}else if(i<2048){n.push(192|i>>6);n.push(128|i&63);r++}else if(55296<=i&&i<=56319){var a=i;if(r+1>=t.length)throw new Error("High Surrogate at the end of string");var o=t.charCodeAt(r+1);if(!(56320<=o&&o<=57343))throw new Error("High Surrogate followed by invalid low surrogate");var s=65536-(55296<<10)-56320;var u=(a<<10)+o+s;n.push(240|u>>18);n.push(128|u>>12&63);n.push(128|u>>6&63);n.push(128|u&63);r=r+2}else if(56320<=i&&i<=57343){throw new Error("Low Surrogate not preceded by high surrogate")}else if(i<65536){n.push(224|i>>12);n.push(128|i>>6&63);n.push(128|i&63);r++}else{throw new Error("Illegal utf8 converter input")}}return n}t.stringToByteArray=r})(r=e.ByteArray||(e.ByteArray={}));var i;(function(i){function a(t){if(e.isNotEmptyString(t)){var n=r.stringToByteArray(t);return s(n)}else return t}i.encode=a;function o(t){if(e.isNotEmptyString(t)){var n=u(t);return r.byteArrayToString(n)}else return t}i.decode=o;function s(r){e.assert(e.isArray(r));var i="";var a,o,s,u,c,d,l,f=0;while(f<r.length){a=r[f++];o=f<r.length?r[f++]:0;s=f<r.length?r[f++]:0;u=a>>2;c=(a&3)<<4|o>>4;d=(o&15)<<2|s>>6;l=s&63;if(f==r.length){if(n(r.length,3)==1){d=64;l=64}else if(n(r.length,3)==2){l=64}}i+=t.charAt(u)+t.charAt(c)+t.charAt(d)+t.charAt(l)}return i}i.encodeBytes=s;function u(n){e.assert(e.isNotEmptyString(n));var r=[];var i,a,o,s,u,c,d,l=0;while(l<n.length){s=t.indexOf(n.charAt(l++));u=t.indexOf(n.charAt(l++));c=t.indexOf(n.charAt(l++));d=t.indexOf(n.charAt(l++));i=s<<2|u>>4;a=(u&15)<<4|c>>2;o=(c&3)<<6|d;r.push(i);if(c!=64)r.push(a);if(d!=64)r.push(o)}return r}i.decodeBytes=u})(i=e.Base64||(e.Base64={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=function(){function e(e){this.radix=e}e.prototype.digits=function(e){var t=this.radix;var n=[];while(e>t){var r=e%t;e=(e-r)/t;n.push(r)}n.push(e);return n};e.prototype.number=function(e){var t=0;for(var n=e.length-1;n>=0;n--)t=t*this.radix+e[n];return t};return e}();e.Radix=t})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=e.Math.random()*16|0;var r=t=="x"?n:n&3|8;return r.toString(16)})}t.guid=n;(function(e){function t(e){var t=[];for(var n=0,r=e.split("-");n<r.length;n++){var i=r[n];for(var a=0;a<i.length;a+=2)t.push(parseInt(i.slice(a,a+2),16))}return t}e.bytes=t;function n(e){return e.map(function(e,t){var n=(256|e).toString(16).slice(1,3);return t==4||t==6||t==8||t==10?"-"+n:n}).join("")}e.parse=n})(n=t.guid||(t.guid={}))})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(e,t,n){if(e.length>=t)return e;else return e+new Array(t-e.length+1).join(n)}function n(e){var n=[1578336022,36261640,872437806,2915948275];e=t(e,e.length+16-e.length%16,"0");for(var r=0;r<e.length;r+=4){for(var i=0;i<4;i++){var a=e.charCodeAt(r)<<24;var o=e.charCodeAt(r+1)<<16;var s=e.charCodeAt(r+2)<<8;var u=e.charCodeAt(r+3);var c=a+o+s+u;n[i]=(n[i]<<5)+n[i]^c}}var d=n.map(function(e){return(4294967296+e).toString(16).slice(-8)});return[d[0],d[1].substr(0,4),d[1].substr(4,4),d[2].substr(0,4),d[2].substr(4,4)+d[3]].join("-")}e.hash=n})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=e.Exception;var n=e.async;var r=function(){function e(e){this.code=e}e.prototype.synchronized=function(e){var r=n(e),i=this;return function e(){var n=[];for(var a=0;a<arguments.length;a++){n[a]=arguments[a]}if(i.dfd){return i.dfd.then(function(e){throw t(i.code)},function(t){if(t&&t.code=="Canceled")throw t;i.dfd=null;return e.apply(void 0,n)})}else{var o=i.dfd=r.apply(void 0,n);return o}}};return e}();e.SyncLock=r})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){function t(t,n,r){var i=function(){return r().catch(function(r){if(!n(r))throw r;var a=t(r);if(a>=0)return e.sleep(a).then(i);throw r})};return i()}e.retry=t;function n(e,t,n){if(n===void 0){n=1.5}var r=e;var i=0;return function(){if(i++<t){var e=r;r*=n;return e}}}e.expdelay=n})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var s=function(){if(typeof document!=="undefined"){try{throw new Error}catch(t){if(t.stack){var e=/\w+:\/\/(.+?\/)*.+\.js/.exec(t.stack);return e&&e.length>0?e[0]:null}}}else if(typeof self!=="undefined"){return self.location.href}return null}();var u=false;var c=typeof Worker!=="undefined";var d=typeof importScripts!=="undefined";var l=typeof Uint8Array!=="undefined";var f=function(){try{Object.defineProperty({},"oncomplete",{});return true}catch(e){return false}}();var p=c;var v=function(e,t,n,r,i){if(!f){e[t]=n;return}var a={};r&&(a.get=r);i&&(a.set=i);Object.defineProperty(e,t,a)};var h={};"use strict";var m=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var t=typeof btoa!=="undefined";function n(n,r){var i="";if(!r){r=false}if(n.pop||n.subarray){n=String.fromCharCode.apply(null,n)}if(t){i=btoa(n)}else{var a,o,s,u,c,d,l;var f;for(f=0;f<n.length;f+=3){a=n.charCodeAt(f);o=n.charCodeAt(f+1);s=n.charCodeAt(f+2);u=a>>2;c=(a&3)<<4|o>>4;d=(o&15)<<2|s>>6;l=s&63;if(isNaN(o)){d=l=64}else if(isNaN(s)){l=64}i=i+e.charAt(u)+e.charAt(c)+e.charAt(d)+e.charAt(l)}}if(r){return i.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}return i}function r(e){if(t){e=e.replace(/-/g,"+").replace(/_/g,"/");while(e.length%4!==0){e+="="}return atob(e)}return String.fromCharCode.apply(null,i(e))}function i(t){t=t.replace(/-/g,"+").replace(/_/g,"/");while(t.length%4!==0){t+="="}var n=[];var r,i,a;var o,s,u,c;var d;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(d=0;d<t.length;d+=4){o=e.indexOf(t.charAt(d));s=e.indexOf(t.charAt(d+1));u=e.indexOf(t.charAt(d+2));c=e.indexOf(t.charAt(d+3));r=o<<2|s>>4;i=(s&15)<<4|u>>2;a=(u&3)<<6|c;n.push(r);if(u!==64){n.push(i)}if(c!==64){n.push(a)}}return n}function a(e){return Object.prototype.toString.call(e).slice(8,-1)}function o(e,t){var n="";if(typeof t==="undefined"){t=false}for(var r=0;r<e.length;r++){if(t&&r%4===0&&r!==0){n+="-"}var i=e[r].toString(16).toUpperCase();if(i.length===1){n+="0"}n+=i}return n}function s(e,t){t=t||0;return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function u(e){var t=new Array(e.length);for(var n=0;n<t.length;n++){t[n]=e.charCodeAt(n)}return t}function c(e){e=e.replace(/\-/g,"");var t=[];while(e.length>=2){t.push(parseInt(e.substring(0,2),16));e=e.substring(2,e.length)}return t}function d(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t}function l(e,t,n){var r=i(e),a=[],o;if(isNaN(t)){return r}else{for(o=0;o<r.length;o+=t){a.push(r.slice(o,o+t))}}if(n){for(o=0;o<a.length;o++){a[o]=(a[o][0]<<24)+(a[o][1]<<16)+(a[o][2]<<8)+a[o][3]}}return a}function f(e){return[e>>>24&255,e>>>16&255,e>>>8&255,e&255]}function p(e){var t=[];for(var n=0;n<e.length;n++){t=t.concat(f(e[n]))}return t}function v(e,t){var n=Math.min(e.length,t.length),r=new Array(n);for(var i=0;i<n;i+=1){r[i]=e[i]^t[i]}return r}function h(e,t){t||(t=0);var n=new Array(e);for(var r=0;r<e;r+=1){n[r]=t}return n}function m(e){if(!e){return[]}if(e.pop){return e}if(e.isView){e=Uint8Array(e)}return e.length===1?[e[0]]:Array.apply(null,e)}function g(e,t,n){while(e.length<n){e.push(t)}return e}function y(e,t,n){while(e.length<n){e.unshift(t)}return e}function S(e,t){var n=true;if(e.length!==t.length){n=false}for(var r=0;r<e.length;r++){if(e[r]!==t[r]){n=false}}return n}function b(e){if(a(e)!=="Array"){return false}var t;for(var n=0;n<e.length;n++){t=e[n];if(isNaN(t)||t<0||t>255){return false}}return true}return{toBase64:n,base64ToString:r,base64ToBytes:i,getObjectType:a,bytesToHexString:o,bytesToInt32:s,stringToBytes:u,unpackData:l,hexToBytesArray:c,int32ToBytes:f,int32ArrayToBytes:p,toArray:m,arraysEqual:S,clone:d,xorVectors:v,padEnd:g,padFront:y,getVector:h,verifyByteArray:b}}();"use strict";var g={};g.register=function(e,t,n){if(!g[e]){g[e]={}}var r=g[e];if(!r[t]){r[t]=n}};g.exists=function(e,t){if(!g[e]){return false}return g[e][t]?true:false};"use strict";function y(e,t,n,r,i){return[]}var S=function(e,t,n,r,i,a,o){var s=m;var u=n.slice(),c=new Array(i),d=[],l=0;function f(e){var t=Math.floor(e.length/i);for(var n=0;n<t;n++){a(e,n,u,r,c)}l+=t;return e.slice(t*i)}function p(){var e=[];for(var t=0;t<u.length;t++){e=e.concat(s.int32ToBytes(u[t]))}e.length=o/8;return e}function v(e){var t=i-e.length%i;t<=i/8&&(t+=i);var n=s.getVector(t);n[0]=128;var r=(e.length+l*i)*8;n[t-4]=r>>>24&255;n[t-3]=r>>>16&255;n[t-2]=r>>>8&255;n[t-1]=r&255;return e.concat(n)}function h(e){d=f(e);return y()}function g(e){d=d.concat(e);if(d.length>=i){d=f(d)}return}function y(){if(f(v(d)).length!==0){throw new Error("buffer.length !== 0")}var e=p();d=[];u=n.slice();l=0;return e}return{name:e,computeHash:h,process:g,finish:y,der:t,hashLen:o,maxMessageSize:4294967295}};"use strict";var b=function(){var e=m;function t(t,n,r,i,a){var o,s,u,c,d,l=64,f=4294967295;var p=r[0],v=r[1],h=r[2],m=r[3],g=r[4],y=r[5],S=r[6],b=r[7];for(s=0;s<16;s++){a[s]=e.bytesToInt32(t,n*l+s*4)}for(o=16;o<64;o++){c=a[o-15];d=a[o-2];a[o]=((d>>>17|d<<15)^(d>>>19|d<<13)^d>>>10)+a[o-7]+((c>>>7|c<<25)^(c>>>18|c<<14)^c>>>3)+a[o-16];a[o]=a[o]&f}for(s=0;s<64;s++){u=b+((g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&y^~g&S)+i[s]+a[s];m+=u;u+=((p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10))+(p&(v^h)^v&h);b=S;S=y;y=g;g=m;m=h;h=v;v=p;p=u}r[0]+=p&f;r[1]+=v&f;r[2]+=h&f;r[3]+=m&f;r[4]+=g&f;r[5]+=y&f;r[6]+=S&f;r[7]+=b&f;return r}var n,r,i,a,o,s=e.unpackData;r=s("wQWe2DZ81QcwcN0X9w5ZOf/ACzFoWBURZPmPp776T6Q",4,1);i=s("agnmZ7tnroU8bvNypU/1OlEOUn+bBWiMH4PZq1vgzRk",4,1);n=s("QoovmHE3RJG1wPvP6bXbpTlWwltZ8RHxkj+CpKscXtXYB6qYEoNbASQxhb5VDH3Dcr5ddIDesf6b3AanwZvxdOSbacHvvkeGD8GdxiQMocwt6SxvSnSEqlywqdx2+YjamD5RUqgxxm2wAyfIv1l/x8bgC/PVp5FHBspjURQpKWcntwqFLhshOE0sbfxTOA0TZQpzVHZqCruBwskuknIshaK/6KGoGmZLwkuLcMdsUaPRkugZ1pkGJPQONYUQaqBwGaTBFh43bAgnSHdMNLC8tTkcDLNO2KpKW5zKT2gub/N0j4LueKVjb4TIeBSMxwIIkL7/+qRQbOu++aP3xnF48g",4,1);a=s("MC0wDQYJYIZIAWUDBAIEBQAEHA");o=s("MDEwDQYJYIZIAWUDBAIBBQAEIA");return{sha224:S("SHA-224",a,r,n,64,t,224),sha256:S("SHA-256",o,i,n,64,t,256)}}();if(typeof g!=="undefined"){b.hash256=function(e){if(e.operationSubType==="process"){b.sha256.process(e.buffer);return}if(e.operationSubType==="finish"){return b.sha256.finish()}return b.sha256.computeHash(e.buffer)};b.hash224=function(e){if(e.operationSubType==="process"){b.sha224.process(e.buffer);return}if(e.operationSubType==="finish"){return b.sha224.finish()}return b.sha224.computeHash(e.buffer)};g.register("digest","sha-224",b.hash224);g.register("digest","sha-256",b.hash256)}h["sha-224"]=b.sha224;h["sha-256"]=b.sha256;"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t){var r=e.ByteArray.stringToByteArray(t);var i=g["digest"]["sha-256"]({buffer:r});var a="";i.forEach(function(e){a+=n(e.toString(16))});return a}e.sha256Hash=t;function n(t){e.assert(t.length<=2&&t.length>0);return t.length==2?t:"0"+t}})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){function t(e,t){var n=e.getItem(t);if(n!==null&&n!==undefined)return JSON.parse(n);var r=[];for(var i in e)if(i.slice(0,t.length+1)==t+".")r.push(i);if(!r.length)return;var a={};for(var o=0,s=r;o<s.length;o++){var i=s[o];var u=JSON.parse(e.getItem(i));var c=i.slice(t.length+1).split(".");var d=a;for(var l=0;l<c.length-1;l++){var f=c[l];d[f]=d[f]||{};d=d[f]}d[c[c.length-1]]=u}return a}var n=function(){function n(e,t){this.path=e;this.prep=t}n.prototype.get=function(){var n;try{n=t(e.localStorage,this.path)}catch(e){}return this.prep(n)};return n}();var r;(function(e){e.ctor=new n("lwsdk.ctor",function(e){return e||{}});e.logs=new n("lwsdk.logs",function(e){return!!e});e.cfmt=new n("lwsdk.cfmt",function(e){return e});e.pref=new n("lwsdk.pref",function(e){return e});var t;(function(e){e.ctor=new n("lwsdk.bp.ctor",function(e){return!!e})})(t=e.bp||(e.bp={}))})(r=e.ls||(e.ls={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";t.BROWSERS={MSIE:"MSIE",CHROME:"Chrome",FIREFOX:"Firefox",SAFARI:"Safari",EDGE:"Edge",ELECTRON:"Electron",SKYPE_SHELL:"SkypeShell",PHANTOMJS:"PhantomJS",UNKNOWN:"Unknown"},t.OPERATING_SYSTEMS={WINDOWS:"Windows",MACOSX:"Mac OS X",WINDOWS_PHONE:"Windows Phone",WINDOWS_RT:"Windows RT",IOS:"iOS",ANDROID:"Android",LINUX:"Linux",UNKNOWN:"Unknown"},t.DEVICE_TYPES={DESKTOP:1,MOBILE:2,TABLET:8},t.VERSION_MAPPINGS={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},t.CSS_PROPERTIES={OBJECT_FIT:"objectFit"},t.UNKNOWN_VERSION="U",t.CHROME_NPAPI_NOT_SUPPORTED_VERSION_MAJOR="42",t.REGEX_VERSION="([\\d,.]+)",t.REGEX_VERSION_MAC="([\\d,_,.]+)";var n=function(){function n(){}n.getHostname=function(){return location.hostname};n.getUserAgent=function(){return e.window.navigator.userAgent};n.userAgentContainsString=function(e){return this.getUserAgent().indexOf(e)>-1};n.isIe=function(){return this.userAgentContainsString("Trident")};n.isEdge=function(){return this.userAgentContainsString(t.BROWSERS.EDGE)};n.isOpera=function(){return this.userAgentContainsString("OPR/")};n.getBrowserName=function(){if(this.isOpera()){return t.BROWSERS.UNKNOWN}if(this.userAgentContainsString(t.BROWSERS.PHANTOMJS)){return t.BROWSERS.PHANTOMJS}if(this.isEdge()){return t.BROWSERS.EDGE}if(this.userAgentContainsString(t.BROWSERS.ELECTRON)){return t.BROWSERS.ELECTRON}if(this.userAgentContainsString(t.BROWSERS.CHROME)){return t.BROWSERS.CHROME}if(this.userAgentContainsString(t.BROWSERS.FIREFOX)){return t.BROWSERS.FIREFOX}if(this.userAgentContainsString(t.BROWSERS.SAFARI)){return t.BROWSERS.SAFARI}if(this.userAgentContainsString(t.BROWSERS.SKYPE_SHELL)){return t.BROWSERS.SKYPE_SHELL}if(this.isIe()){return t.BROWSERS.MSIE}return t.BROWSERS.UNKNOWN};n.getBrowserVersion=function(){if(this.isIe()){return e.call(this)}else{return n.call(this,this.getBrowserName())}function e(){var e,n=this.getUserAgent(),r=n.match(new RegExp(t.BROWSERS.MSIE+" "+t.REGEX_VERSION));if(r){return r[1]}else{e=n.match(new RegExp("rv:"+t.REGEX_VERSION));if(e){return e[1]}}return undefined}function n(e){var n;if(e===t.BROWSERS.SAFARI){e="Version"}n=this.getUserAgent().match(new RegExp(e+"/"+t.REGEX_VERSION));if(n){return n[1]}return t.UNKNOWN_VERSION}};n.deviceType=function(){var e=/(android|ipod|windows phone|wpdesktop|windows ce|blackberry\w*|meego|webos|palm|symbian|pda|\w*?mobile\w*?|\w*?phone\w*?)/i,n=/tablet|ipad/i;if(this.getUserAgent().match(e)){return t.DEVICE_TYPES.MOBILE}if(this.getUserAgent().match(n)){return t.DEVICE_TYPES.TABLET}return t.DEVICE_TYPES.DESKTOP};n.getOsName=function(){var e=/(windows|win32)/i,n=/ arm;/i,r=/windows\sphone\s\d+\.\d+/i,i=/(macintosh|mac os x)/i,a=/(iPad|iPhone|iPod)(?=.*like Mac OS X)/i,o=/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|cros)/i,s=/android/i;var u=this.getUserAgent();if(u.match(r)){return t.OPERATING_SYSTEMS.WINDOWS_PHONE}if(u.match(n)){return t.OPERATING_SYSTEMS.WINDOWS_RT}if(u.match(a)){return t.OPERATING_SYSTEMS.IOS}if(u.match(s)){return t.OPERATING_SYSTEMS.ANDROID}if(u.match(o)){return t.OPERATING_SYSTEMS.LINUX}if(u.match(i)){return t.OPERATING_SYSTEMS.MACOSX}if(u.match(e)){return t.OPERATING_SYSTEMS.WINDOWS}return t.OPERATING_SYSTEMS.UNKNOWN};n.getOsVersion=function(){if(this.getOsName()===t.OPERATING_SYSTEMS.WINDOWS){return e.call(this)}if(this.getOsName()===t.OPERATING_SYSTEMS.MACOSX){return n.call(this)}return t.UNKNOWN_VERSION;function e(){var e=this.getUserAgent().match(new RegExp("Windows NT "+t.REGEX_VERSION));if(e&&t.VERSION_MAPPINGS[e[1]]){return t.VERSION_MAPPINGS[e[1]]}return t.UNKNOWN_VERSION}function n(){var e=this.getUserAgent().match(new RegExp(t.OPERATING_SYSTEMS.MACOSX+" "+t.REGEX_VERSION_MAC));if(e){return i(e[1].replace(/_/g,".")).getMajor()}return t.UNKNOWN_VERSION}};n.mapWindowsVersion=function(e){if(t.VERSION_MAPPINGS[e])return t.VERSION_MAPPINGS[e];else return e};n.castSWXConstToWebSDK=function(e){switch(e){case t.BROWSERS.EDGE:return"Microsoft Edge";case t.BROWSERS.MSIE:return"IExplorer";case t.OPERATING_SYSTEMS.MACOSX:return"Mac OSX";case t.UNKNOWN_VERSION:return"Unknown";default:return e}};return n}();t.EnvInfo=n;var r=function(){function e(e){this.unknownVersionString="U";this.isVersionValid=true;this.versionString=e;this.parseComponents()}e.prototype.getMajor=function(){return this.components[0]};e.prototype.getMinor=function(){return this.components[1]};e.prototype.getAllComponents=function(){return this.components};e.prototype.getOriginalString=function(){return this.versionString};e.prototype.isValid=function(){return this.isVersionValid};e.prototype.compareTo=function(e){var t=0,n=0,r=e.getAllComponents();if(!this.isValid()||!e.isValid()){throw new Error("Invalid version cannot be compared")}for(var i=0;i<r.length;++i){t=parseInt(this.components[i],10);n=parseInt(r[i],10);if(!t||t<n){return-1}else if(t>n){return 1}}return 0};e.prototype.parseComponents=function(){if(!this.versionString){this.components=[this.unknownVersionString,this.unknownVersionString];this.isVersionValid=false;return}var e=this.getDelimiter();if(e){this.components=this.versionString.split(e);this.validateComponents()}else{this.components=[this.versionString,this.unknownVersionString];this.isVersionValid=false}};e.prototype.validateComponents=function(){for(var e=0;e<this.components.length;++e){if(!this.components[e]||isNaN(parseInt(this.components[e],10))){this.components.push(this.unknownVersionString);this.isVersionValid=false;break}}};e.prototype.getDelimiter=function(){if(this.versionString.indexOf(".")>-1){return"."}if(this.versionString.indexOf("_")>-1){return"_"}return null};return e}();var i=function(e){return new r(e)}})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){e.version="0.4.596 master".replace(/[{}]/g,"");var t=function(){function e(e){this.value=e}e.prototype.map=function(t){return new e(t(this.value))};return e}();e.Identity=t;var n;(function(e){e.timestamps=false;e.saveConsole=false;e.logSize=0})(n=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){"use strict";var n=t.sha256Hash;var r;(function(n){n.debugInfo={};var r;function i(){r=t.extend([],{size:0,maxSize:e.Settings.logSize||Math.pow(2,22)})}function a(){var e="";function t(t,n){if(n!==undefined)e+=t+": "+n+"\r\n"}Object.keys(n.debugInfo).forEach(function(e){if(e=="correlation_ids"){Object.keys(n.debugInfo[e]).forEach(function(r){t("cid_"+r,n.debugInfo[e][r])})}else{t(e,n.debugInfo[e])}});return e}function o(){console.log(a())}n.dumpDebugInfo=o;function s(){var n=[];for(var a=0;a<arguments.length;a++){n[a]=arguments[a]}if(!e.Settings.saveConsole)throw Error("Logging to file is disabled");if(!r)i();var o=n.map(function(e){return t.isObject(e)?JSON.stringify(e):e+""}).join(" ")+"\r\n";r.push(o);r.size+=o.length*2;var s=r.size,u=0;while(s>r.maxSize){s-=r[u].length*2;u++}r.size=s;r.splice(0,u)}function u(n){if(n===void 0){n=(new e.Date).toJSON()+".log"}if(!e.Settings.saveConsole)throw Error("Logging to file is disabled.");r.splice(0,0,a());var i=t.EnvInfo.getBrowserName();if(i==t.BROWSERS.MSIE||i==t.BROWSERS.EDGE){var o=new Blob(r,{type:"text/plain"});navigator.msSaveOrOpenBlob(o,n)}else if(i==t.BROWSERS.SAFARI){if(!(e.window&&e.window.onclick)){throw Error("Cannot save to console - browser not supported")}var o=new Blob(r,{type:"text/plain"});var s=URL.createObjectURL(o);var u=e.window.onclick;e.window.onclick=function(){e.window.open(s);e.window.onclick=u;URL.revokeObjectURL(s)}}else{var o=new Blob(r,{type:"text/plain"});var c=document.createElement("a");c.href=URL.createObjectURL(o);c["download"]=n;c.click()}}n.saveConsole=u;function c(){var n=[];for(var r=0;r<arguments.length;r++){n[r]=arguments[r]}var i=new e.Date;var a=i.toTimeString();a=a.slice(0,8)+":"+i.getMilliseconds()+" ";if(t.isString(n[0]))a+=n.splice(0,1)[0];n.splice(0,0,a);return n}function d(){var n=[];for(var r=0;r<arguments.length;r++){n[r]=arguments[r]}if(!e.isUnitTested){try{if(t.isString(n[0])&&t.isString(n[1])&&n[1].indexOf("%c")!=-1)n.splice(0,2,n[0]+n[1]);if(/\b(Trident)|(Edge)\b/i.test(navigator.userAgent)){n=n.map(function(e){return t.isPrimitive(e)?e:JSON.stringify(e)});if(typeof n[0]=="string"){var i=n[0];var a=1;for(var o=0;o<i.length;o++){if(i[o]=="%"&&/^[a-z]$/i.test(i[o+1])){if(i[o+1]=="c"){i=i.slice(0,o)+i.slice(o+2);n.splice(a,1);o--;a--}a++}}n[0]=i}}console.log.apply(console,n)}catch(e){}}}function l(t,n,r){r.changed(function(r,i,a){if(a===void 0)return;var o=[n+": %c "+a+" -> "+r,"color:green;font-weight:bold"];if(i){o.push("Reason:");o.push(i)}var u=c(o);if(t){if(e.Settings.timestamps)d.apply(void 0,u);else d.apply(void 0,o)}if(e.Settings.saveConsole)s.apply(void 0,u)})}n.watch=l;function f(t){var n=[];for(var r=1;r<arguments.length;r++){n[r-1]=arguments[r]}var i=c.apply(void 0,n);if(t){if(e.Settings.timestamps)d.apply(void 0,i);else d.apply(void 0,n)}if(e.Settings.saveConsole)s.apply(void 0,i)}n.log=f})(r=t.debug||(t.debug={}));var i;(function(e){e.test=function(e){return/\^sips?:/i}})(i=t.SipUri||(t.SipUri={}));t.cleanwsp=function(e){return e.replace(/\s*\n\s*/gm,"")};var a;(function(e){function n(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}return t.cleanwsp(e.join(""))}e.merge=n})(a=t.TSTags||(t.TSTags={}));function o(n){t.assert(n>=0);var r=new t.Task(n+" sec timeout",{cancel:function(t){e.clearTimeout(i);r.reject(t)}});var i=e.setTimeout(function(){return r.resolve()},n*1e3|0);return r.promise}t.sleep=o;function s(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/gm,"")}t.trim=s;function u(e){return Object.freeze?Object.freeze(e):e}t.freeze=u;function c(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var n={},r,i;for(i=0;i<e.length;i++){r=e[i];n[r]=r}return u(n)}t.StringEnum=c;function d(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}var r,i;if(e.length==1&&t.isDictionary(e[0])){r=arguments[0]}else{r={};for(i=0;i<e.length;i++)r[e[i]]=i}return u(r)}t.Enum=d;function l(e,t){for(var n in e){if(e[n]==t)return n}return""}t.enumName=l;function f(e){return e&&JSON.parse(JSON.stringify(e))}t.clone=f;function p(e){t.assert(t.isFunction(e));var n=null;return function(){return n||(n=e())}}t.singleton=p;function v(t){if(!t){return t}var n=/\d+/.exec(t);return new e.Date(n&&+n[0])}t.timeStampToDate=v;function h(e){if(!e){return e}return"/Date("+ +e+")/"}t.dateToTimeStamp=h;function m(){return e.Date.now()+(new e.Date).getTimezoneOffset()*60*1e3}t.currentUTCms=m;t.max=function(e,t){return e>t?e:t};t.min=function(e,t){return e<t?e:t};function g(e,n){var r=function(e,t){return r[e+","+t]};for(var i=0;i<=e.length;i++)for(var a=0;a<=n.length;a++)r[i+","+a]=!i||!a?i||a:t.min(r(i-1,a-1)+(e[i-1]!=n[a-1]),1+t.min(r(i-1,a),r(i,a-1)));return r(e.length,n.length)}t.sdist=g;function y(e,t){if(t===void 0){t="Authorization"}var r=function(e){return"<hash:"+e.length+":"+n(e).slice(0,6)+">"};var i=e&&e.headers&&e.headers[t];try{if(i)e.headers[t]=i.replace(/\b(Bearer [a-z]+=|Bearer |cwt=|psat=)([.\w-]+)/gim,function(e,t,n){return"_"+t+r(n)})}catch(n){if(i)e.headers[t]="<hashed>"}return e}t.obscureAuthHeader=y;function S(e,t){for(var n=e.length-1;n>=0;n--){var r=e[n];if(r)t=r(t)}return t}
t.decorated=S})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(t){var i=t.Utils.guid;var a=t.Utils.extend;var o=t.Utils.sha256Hash;var s=t.Utils.flatten;var u=t.Utils.nothrow;var c=t.Utils.isFunction;var d=t.Utils.isPrimitive;var l=t.Utils.EnvInfo;var f="afe05df65cc74b958837195cd87d2ff0-e0f88ee6-25f5-49b5-ae35-25c6b40faa7f-7176";var p=function(e){return"<hash:"+e.length+":"+o(e).slice(0,6)+">"};var v="ttt_trace";function h(e){try{return c(e)?e():e}catch(e){return{}}}var m=function(){function r(e,n,r,i,a){if(n===void 0){n=f}this.telemetryManager=e;this.tenantToken=n;this.disabled=r;this.ttt_events=i;this.tzip_url=a;this.defaults={hostName:l.getHostname(),sdkVersion:t.version};this.cidProps={};this.excluded={};this.collectOII=true;this.knownSafeReasonProperties=new RegExp("\\b("+"reason"+"|[\\w\\d_]*stack"+"|[\\w_]*code"+"|[\\w_]*subcode"+"|[\\w_]*message"+"|code"+"|[\\w_]*status"+"|[\\w_]*statusText"+"|[\\w_]*headers_Date"+"|[\\w_]*headers_X_Ms_Correlation_Id"+")\\b","i")}r.prototype.addCorrelationIds=function(e){if(!e||!e.correlationIds){return}var t=128,n=10;var i=0;for(var a in e.correlationIds){var o=e.correlationIds[a];if(i<n&&o&&d(o)&&(o.length?o.length<=t:true)){i++;if(a=="upn")this.cidProps["cid_"+a]=[o,e.dogfood==true?r.PIIType.NotSet:r.PIIType.Identity];else this.cidProps["cid_"+a]=o}}};r.prototype.checkValue=function(e){return typeof e==="string"||typeof e==="number"||typeof e==="boolean"};r.prototype.addDashboardProps=function(e){e.response_status=e.reason.rsp&&e.reason.rsp.status||e.reason.response&&e.reason.response.status||e.reason.reason&&e.reason.reason.response&&e.reason.reason.response.status;e.srv_err_code=e.reason.rsp&&e.reason.rsp.data&&e.reason.rsp.data.code||e.reason.reason&&e.reason.reason.code;e.srv_err_subcode=e.reason.rsp&&e.reason.rsp.data&&e.reason.rsp.data.subcode||e.reason.subcode||e.reason.reason&&e.reason.reason.subcode;e.srv_err_msg=e.reason.rsp&&e.reason.rsp.data&&e.reason.rsp.data.message||e.reason.message||e.reason.reason&&e.reason.reason.message};r.prototype.discardInvalidProperties=function(e){for(var t in e){var n=e[t];if(Array.isArray(n)){if(!this.checkValue(n[0])||n[1]&&typeof n[1]!=="number")delete e[t]}else{if(!this.checkValue(n))delete e[t]}}};r.prototype.oiiPropertyValue=function(e){return{value:e,isOII:true}};r.prototype.removeOIIReasonProperties=function(e){for(var t in e){if(!this.knownSafeReasonProperties.test(t))delete e[t]}return e};r.prototype.removeOIIProperties=function(e){if(c(e)||d(e))return e;for(var t in e){var n=e[t];if(n&&n.isOII){if(!this.collectOII)delete e[t];else e[t]=n.value}else if(n&&!d(n)){e[t]=this.removeOIIProperties(e[t])}}return e};r.prototype.processReason=function(e,t){var n=s(e.reason,function(e){return e.join("_").replace(/[^\w]/gm,"_")},function(e){return e.stack?["stack"]:[]});if(!this.collectOII&&t)n=this.removeOIIReasonProperties(n);delete e.reason;for(var r in n)e["reason_"+r]=n[r];return e};r.prototype.clean=function(e){if(typeof e==="string"){e=e.replace(/\b(Bearer [a-z]+=|Bearer |cwt=|psat=)([.\w-]+)/gim,function(e,t,n){return t+p(n)}).replace(/(?:sip(?:%3A|:))?([\w.+-]+(?:@|%40)[\w.+-]+)/gim,function(e,t){return p(t)});for(var t in this.excluded)if(t.trim().length>4)e=e.split(t.trim()).join(p(t.trim()));return e}if(d(e))return e;for(var n in e)if(n!=v)e[n]=this.clean(e[n]);return e};r.prototype.matches=function(e,t,n){if(!n)return false;for(var r in n){if(!/^[_|*a-z]+$/.test(r))continue;var i=r.replace(/\*/g,".*");if(!new RegExp("^("+i+")$").test(e))continue;var a=n[r]||[];e:for(var o=0,s=a instanceof Array?a:[a];o<s.length;o++){var u=s[o];for(var c in u){var d=u[c];var l=t[c];if(typeof d==="number"||typeof d==="string"||d===null){if(d!==l)continue e}else if(d instanceof RegExp){if(!d.test(l))continue e}else if(d instanceof Array){if(d.indexOf(l)<0)continue e}else{continue e}}return true}}return false};r.prototype.record=function(e,n){if(n===void 0){n={}}if(!this.telemetryManager)this.telemetryManager=new g;if(this.matches(e,n,this.disabled))return;if(this.matches(e,n,this.ttt_events))this.send_ttt(n);var r;try{n=h(n);this.removeOIIProperties(n);if(n.reason&&!d(n.reason)){if(n.reason.monitorFailed){n.reason=n.reason.value;if(!d(n.reason)){this.addDashboardProps(n);this.processReason(n,true)}}else{this.addDashboardProps(n);this.processReason(n)}}this.clean(n);r=JSON.parse(JSON.stringify(n))}catch(n){try{var i=a({},this.defaults,this.cidProps,{event:e,error:n&&n.toString(),stack:n&&n.stack&&n.stack.toString()});this.telemetryManager.sendEvent(this.tenantToken,t.TelemetryEvent.Error,i)}catch(e){}}var o=a({},this.defaults,this.cidProps,r);this.removeOIIProperties(o);this.discardInvalidProperties(o);this.telemetryManager.sendEvent(this.tenantToken,e,o)};r.prototype.send_ttt=function(r){var i=this;e.ttt.toJSON(this.tzip_url).then(function(e){var a=/sdk_ver: "(.+?)"/.exec(e)[1];var o=a=="0.0.0"?"/jLync/target/sdk.js":"https://latest-swx.cdn.skype.com/jLync/"+a.split(" ").reverse().join("_")+"/sdk.js";var s=["<!doctype html>","<html>","<head>","</head>","<script>"+e+"<\/script>",'<script src= "'+o+'"><\/script>','<body><button onclick="this.disabled = true; Skype.ttt.play();">Replay</button></body>',"</html>"].join("\n");if(typeof r!=="string"){i.record(t.TelemetryEvent.TTT,n({},r,(d={},d[v]=s,d)))}else{var u=new Blob([s],{type:"text/html"});var c=document.createElement("a");c.href=URL.createObjectURL(u);c.download=r+".html";c.click()}var d})};r.prototype.timeout=function(e,n,r){var i=this;if(r===void 0){r={}}r.timeout=e;var a=t.setTimeout(function(){i.record(n,r)},e);return{cancel:function(){t.clearTimeout(a)}}};r.prototype.monitored=function(e,t){var n=this;if(t===void 0){t={}}return function(r){return function(){var i=[];for(var a=0;a<arguments.length;a++){i[a]=arguments[a]}return n.monitor(r.apply(void 0,i),e,t)}}};r.prototype.monitor=function(e,n,r,i){var o=this;if(r===void 0){r={}}if(i===void 0){i={}}if(e){var s,u;if(i.sendEndEventOnly){var c=t.Date.now();u=function(e,i){if(i===void 0){i={}}var s=t.Date.now();o.record(n,a({},h(r),i,{result:e,duration:s-c}))}}else{u=this.begin(n,r)}var d=i.timeout&&t.setTimeout(function(){u("timeout",{timeout:i.timeout,timeout_status:s})},i.timeout);e.then(function(e){return u("succeeded",r)},function(e){return u("failed",{reason:{value:e,monitorFailed:true}})},function(e){s=e}).finally(function(){d&&t.clearTimeout(d)})}return e};r.prototype.begin=function(e,n){var r=this;if(n===void 0){n={}}var o=i();var s=t.Date.now();var u=a({},h(n),{traceId:o,result:"started"});this.record(e,u);return function(n,i){if(i===void 0){i={}}var c=t.Date.now();var d=a({},h(i),{traceId:o,result:n,duration:c-s});r.record(e,a({},u,d))}};return r}();r([u],m.prototype,"record",null);r([u],m.prototype,"send_ttt",null);r([u],m.prototype,"timeout",null);r([u],m.prototype,"monitored",null);r([u],m.prototype,"monitor",null);r([u],m.prototype,"begin",null);t.TelemetryRecorder=m;(function(e){var t;(function(e){e[e["NotSet"]=0]="NotSet";e[e["DistinguishedName"]=1]="DistinguishedName";e[e["GenericData"]=2]="GenericData";e[e["IPV4Address"]=3]="IPV4Address";e[e["IPv6Address"]=4]="IPv6Address";e[e["MailSubject"]=5]="MailSubject";e[e["PhoneNumber"]=6]="PhoneNumber";e[e["QueryString"]=7]="QueryString";e[e["SipAddress"]=8]="SipAddress";e[e["SmtpAddress"]=9]="SmtpAddress";e[e["Identity"]=10]="Identity";e[e["Uri"]=11]="Uri";e[e["Fqdn"]=12]="Fqdn";e[e["IPv4AddressLegacy"]=13]="IPv4AddressLegacy"})(t=e.PIIType||(e.PIIType={}))})(m=t.TelemetryRecorder||(t.TelemetryRecorder={}));t.TelemetryEvent={Activity:"activity",AudioMuteUnmuteRemoteFailed:"audio_mute_unmute_remote_failed",ApplicationChanged:"app_changed",ApplicationCreate:"create_app",ApplicationDelete:"delete_app",Call:"call",Chat:"chat",ChatMessageDecodingError:"chat_message_decoding_error",Communication:"communication",ConfAck:"conf_ack",Conversation:"conversation",ConversationExtension:"conversation_extension",ContactAdd:"contact_add",ContactManager:"contact_manager",ContactRemove:"contact_remove",ContactsAutoPopulate:"contacts_autopopulate",ContactsLoad:"contacts_load",ConvLogs:"conv_logs",CorsFailed:"cors_failed",CreateApplicationCompleted:"create_application_completed",DevicesInit:"devices_init",Endpoint:"endpoint",EndpointResume:"endpoint_resume",EndpointSuspend:"endpoint_suspend",Error:"error",EventChannel:"event_channel",GraphFetchPeople:"graph_fetch_people",GraphFetchSip:"graph_fetch_sip",GraphApiFailed:"graph_api_failed",GroupAdd:"group_add",GroupCreate:"group_create",GroupRemove:"group_remove",GroupRename:"group_rename",GroupsLoad:"groups_load",Heartbeat:"heartbeat",MeMakeAvailable:"me_make_available",MeSet:"me_set",OAuthCwtFailed:"oauth_cwt_failed",OAuthTimeout:"oauth_timeout",PresenceSubscribe:"presence_subscribe",PluginManager:"plugin_manager",PluginComponent:"plugin_component",ReplayMessage:"replay_message",ReportActivityStopped:"report_activity_stopped",RequestFailed:"request_failed",ScheduleMeeting:"schedule_meeting",Search:"search",SigninUseSnapshot:"signin_use_snapshot",SignIn:"signin",SignOut:"signout",TTT:"ttt_logs",UcwaUninitException:"ucwa_uninit_exception",UseAuth:"use_auth",UnmappedError:"unmapped_error",XFrameTimeout:"xframe_timeout",ClientPolicyFailed:"client_policy_failed"};var g=function(){function e(){this.env={};this.loggers={};this.versionString="sdk_tm_v0.1";this.browserName=l.castSWXConstToWebSDK(l.getBrowserName());this.browserVersion=l.castSWXConstToWebSDK(l.getBrowserVersion());this.osName=l.castSWXConstToWebSDK(l.getOsName());this.osVersion=l.castSWXConstToWebSDK(l.getOsVersion());this.env["telemetryManager"]=this.versionString;this.env["browserName"]=this.browserName;this.env["browserVersion"]=this.browserVersion;this.env["osName"]=this.osName;this.env["osVersion"]=this.osVersion}e.prototype.sendEvent=function(e,n,r){try{if(Object.keys(this.loggers).length==0)t.window["microsoft"].applications.telemetry.LogManager.initialize(e);if(!this.loggers[e]){this.loggers[e]=new t.window["microsoft"].applications.telemetry.Logger(e)}var i=new t.window["microsoft"].applications.telemetry.EventProperties;i.name=n;this.addProperties(i,this.env);this.addProperties(i,r);this.loggers[e].logEvent(i)}catch(e){}};e.prototype.addProperties=function(e,t){for(var n in t){var r=t[n];if(Array.isArray(r))e.setProperty(n,r[0],r[1]);else e.setProperty(n,r)}};return e}()})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";e.AutoD={"O365-Public-MT":function(e){return["https://webdir.online.lync.com/autodiscover/autodiscoverservice.svc/root?originalDomain="+e,"https://lyncdiscover."+e,"https://lyncdiscoverinternal."+e]},"O365-Public-MT-Pilot":function(e){return["https://webdir.online.lync.com/autodiscover/autodiscoverservice.svc/root?originalDomain="+e,"https://webdir.tip.lync.com/autodiscover/autodiscoverservice.svc/root?originalDomain="+e,"https://lyncdiscover."+e,"https://lyncdiscoverinternal."+e]},"O365-Public-Gallatin":function(e){return["https://webdir.lync.partners.cn/autodiscover/autodiscoverservice.svc/root?originalDomain="+e,"https://lyncdiscover."+e]}}})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.Http;var r=e.Utils.URI;var i=e.Utils.guid;var a=e.Utils.cleanwsp;var o=e.Utils.Exception;var s=e.Utils.XmlDoc;var u=e.Utils.HttpHeaders;var c=e.Utils.Base64.encode;var d=function(){function e(e,t){this.ticket=e;this.expires=t}e.prototype.toString=function(){return this.ticket};return e}();t.WebTicket=d;var l=function(e){var t=e.context,n=e.scope,r=e.conf_uri,i=r===void 0?"":r;return a('\n        <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">\n            <s:Body>\n                <RequestSecurityToken xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" Context="'+t+'" xmlns="http://docs.oasis-open.org/ws-sx/ws-trust/200512">\n                    <TokenType>urn:component:Microsoft.Rtc.WebAuthentication.2010:user-cwt-1</TokenType>\n                    <RequestType>http://schemas.xmlsoap.org/ws/2005/02/trust/Issue</RequestType>\n                    <AppliesTo xmlns="http://schemas.xmlsoap.org/ws/2004/09/policy">\n                        <EndpointReference xmlns="http://www.w3.org/2005/08/addressing">\n                            <Address>'+n+"</Address>\n                        </EndpointReference>\n                    </AppliesTo>\n                    "+(!i?"":'<Claims Dialect="urn:component:Microsoft.Rtc.WebAuthentication.2010:authclaims">\n                        <ClaimType Uri="http://schemas.microsoft.com/ws/2005/05/identity/claims/conferenceuri" Optional="false" xmlns="http://schemas.xmlsoap.org/ws/2006/12/authorization">\n                            <Value>'+i+"</Value>\n                        </ClaimType>\n                    </Claims>")+"\n                </RequestSecurityToken>\n            </s:Body>\n        </s:Envelope>")};var f=function(e){var t=e.context,n=e.scope,r=e.conf_uri,i=e.conf_key,o=e.cwt;return a('\n        <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">\n          <s:Header>\n            <Security s:mustUnderstand="1" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" xmlns="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">\n              <UsernameToken>\n                <Username>'+c(r)+'</Username>\n                <Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">'+c(i)+'</Password>\n              </UsernameToken>\n            </Security>\n          </s:Header>\n          <s:Body>\n            <RequestSecurityToken xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" Context="'+t+'" xmlns="http://docs.oasis-open.org/ws-sx/ws-trust/200512">\n              <TokenType>urn:component:Microsoft.Rtc.WebAuthentication.2010:user-cwt-1</TokenType>\n              <RequestType>http://schemas.xmlsoap.org/ws/2005/02/trust/Issue</RequestType>\n              <AppliesTo xmlns="http://schemas.xmlsoap.org/ws/2004/09/policy">\n                <EndpointReference xmlns="http://www.w3.org/2005/08/addressing">\n                  <Address>'+n+'</Address>\n                </EndpointReference>\n              </AppliesTo>\n              <Claims Dialect="urn:component:Microsoft.Rtc.WebAuthentication.2010:authclaims">\n                <ClaimType Uri="http://schemas.microsoft.com/ws/2005/05/identity/claims/conferenceuri" Optional="false" xmlns="http://schemas.xmlsoap.org/ws/2006/12/authorization">\n                  <Value>'+r+"</Value>\n                </ClaimType>\n              </Claims>\n              <KeyType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/SymmetricKey</KeyType>\n              "+(!o?"":'<RenewTarget>\n                <UserToken xmlns="urn:component:Microsoft.Rtc.WebAuthentication.2010">'+o+"</UserToken>\n              </RenewTarget>")+"\n            </RequestSecurityToken>\n          </s:Body>\n        </s:Envelope>")};var p=function(){function t(e,t,n,r){if(r===void 0){r=""}this.root=e;this.send=t;this.context=n;this.conf_uri=r}t.prototype.getPassiveAuthUrl=function(){var e=this;return this.getConfigXml().then(function(e){return/\bpassiveauthpage="(.+?)"/i.exec(e)[1]}).catch(function(t){return e.root+"/PassiveAuth/PassiveAuth.aspx"})};t.prototype.getOAuthUrl=function(){return this.getConfigXml().then(function(e){return/\bauthorizationUri="(.+?)"/i.exec(e)[1]})};t.prototype.getWsFedPassivePath=function(){var e=this;return this.getConfigXml().then(function(e){var t=s(e).root.selectOne("wsdl:service",{name:"WebTicketService"}).selectOne("wsdl:port",{name:"WsFedPassive"}).selectOne("soap:address");return new r(t.attr("location")).path()}).catch(function(t){return e.svc+"/WsFed_passive"})};t.prototype.getOAuthPath=function(){var e=this;return this.getConfigXml().then(function(e){var t=s(e).root.selectOne("wsdl:service",{name:"WebTicketService"}).selectOne("wsdl:port",{name:"OAuth"}).selectOne("soap:address");return new r(t.attr("location")).path()}).catch(function(t){return e.svc+"/OAuth"})};t.prototype.getAnonPath=function(){var e=this;return this.getConfigXml().then(function(e){var t=s(e).root.selectOne("wsdl:service",{name:"WebTicketService"}).selectOne("wsdl:port",{name:"WebTicketServiceAnon"}).selectOne("soap:address");return new r(t.attr("location")).path()}).catch(function(t){return e.svc+"/Anon"})};t.prototype.getWebTicket=function(t,r){return this.send({type:"POST",url:t,headers:{SOAPAction:"http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue","Content-Type":"text/xml; charset=utf-8"},data:r||l({scope:this.root,conf_uri:this.conf_uri,context:this.context||i()})}).then(function(t){if(!n.isSuccess(t.status))throw o("WsFedRequestFailed",{rsp:t});var r=t.responseText;var i=/<(?:a:)?UserToken.*?>(.+?)<\/(?:a:)?UserToken>/i.exec(r)[1];var a=/<Expires.*?>(.+?)<\/Expires>/i.exec(r);return new d(i,a&&new e.Date(a[1]))})};t.prototype.getAnonWebTicket=function(e,t,n){var r=this;return this.getAnonPath().then(function(a){var o=f({conf_uri:e,conf_key:t,scope:r.root,cwt:n,context:r.context||i()});return r.getWebTicket(a,o).catch(function(e){if(e&&e.code=="WsFedRequestFailed")e.cwt=n;throw e})})};t.prototype.getWebTicketServicePath=function(){var e=this;var t="/WebTicket/WebTicketService.svc";return this.send({type:"GET",url:"/Autodiscover/AutodiscoverService.svc/root/user",timeout:3}).then(function(n){var i=u(n.headers).get("X-MS-WebTicketURL");e.svc=new r(i).path()||t}).catch(function(n){e.svc=t})};t.prototype.getConfigXml=function(){var e=this;return this.mex=this.mex||this.getWebTicketServicePath().then(function(){return e.send({type:"GET",url:e.svc+"/mex",timeout:3})}).then(function(e){if(n.isSuccess(e.status))return e.responseText;else throw o("MexRequestFailed",{response:e})})};return t}();t.WebTicketService=p})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.Http;var r=e.Utils.bind;var i=e.Utils.async;var a=e.Utils.check;var o=e.Utils.Exception;var s=e.Utils.WWWAuthenticateHeader;var u=e.Utils.HttpHeaders;t.sW3A="WWW-Authenticate";t.sMSD="X-MS-Diagnostics";function c(e,t){var n="grant_type="+e+" is not in the list: ["+t.grant_type+"]";return o.call(n,"GrantTypeNotSupported",{grant_type:e,msra:t})}function d(n,a,o){if(a===void 0){a="Authorization"}if(o===void 0){o=false}var c=i(n instanceof Function?n:r(d.get,n));var l;var f;var p=false;return function n(r,i){if(l){if(!r.headers)r.headers={};r.headers[a]=l+""}return i(r).then(function d(v,h){if(h===void 0){h=false}var m=u(v.headers);var g=m.get(t.sW3A);var y=m.get(t.sMSD);var S=y&&y.split(";")[0];var b;try{b=g&&s(g)}catch(e){b=null}if(v.status==401&&b&&b.MsRtcOAuth){if(p)return v;(function t(){return f=f||c(i,b.MsRtcOAuth).then(function(n){l=n;p=true;if(o&&n.expires){e.setTimeout(function(){if(l==n)t()},+n.expires-e.Date.now())}}).finally(function(){f=null})})();return f.then(function(){return n(r,i)}).then(function(e){e.webTicketRenewed=true;return e})}if(v.status==401||/^(28032|28072|28077)$/.test(S)){if(h)return v;if(p)return v;return i({type:"GET",url:"/Autodiscover/AutodiscoverService.svc/root/oauth/user"}).then(function(e){if(r.headers)delete r.headers[a];return d(e,true)})}p=false;return v})}}t.MsRtcOAuth=d;(function(e){function r(e,r,i){if(i.grant_type.indexOf(e.grant_type)<0)throw c(e.grant_type,i);return r({type:"POST",url:i.href,data:e}).then(function(e){if(!n.isSuccess(e.status))throw o("InvalidCreds",{response:e});var r=JSON.parse(e.responseText);a.belongs("token_type",r);a.belongs("access_token",r);return new t.WebTicket(r.token_type+" "+r.access_token)})}e.get=r})(d=t.MsRtcOAuth||(t.MsRtcOAuth={}))})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.extend;var r=e.Utils.random;var i=e.Utils.URI;var a=e.Utils.WWWAuthenticateHeader;var o=e.Utils.Task;var s=e.Utils.Promise;var u=e.Utils.Exception;var c=e.Utils.HttpHeaders;function d(e,t){var r=t&&t.error;if(r&&t.error_description)r+=" ("+t.error_description+")";return u.call(r,"OAuthFailed",n({url:e},t))}t.EOAuthFailed=d;function l(e){var t=(e||"").split(";");return{code:+t[0]}}function f(n){var s=n.xframe,d=n.client_id,l=n.oauth_uri,p=n.state,v=p===void 0?r():p,h=n.context,m=n.use_cwt,g=m===void 0?true:m,y=n.cwt_format,S=n.redirect_uri,b=n.tm,w=n.hostProperty;var E={};var T,I="",M=1;var C=typeof g==="string"?g:null;var A;var _;function R(e){var n=c(e.headers);var r=a(n.get(t.sW3A))["Bearer"];return r&&r.authorization_uri}var P="Authorization";var k="X-MS-WebTicket";var O="X-Ms-SDK-Host";return function n(r,a){var c=new i(r.url).host()||new i(f.baseurl(s.src())).host();function p(e,t){if(t===void 0){t=false}if(E[c]){e.headers=e.headers||{};delete e.headers[P];delete e.headers[k];e.headers[I]=E[c];e.headers[O]=w}return a(e).then(function(e){if(t)e["webTicketRenewed"]=t;return e})}return o.wait(T).then(function(){return p(r)}).then(function m(O){if(!f.isAuthRequired(O))return O;if(T)return n(r,a);E[c]=null;A=undefined;_=undefined;I=null;var x=f.baseurl(s.src());var D=f.getAudience(O)||x;var U=new t.WebTicketService(new i(x).path("").query("").hash("")+"",p,h,C);T=o.wait(l||R(O)||U.getOAuthUrl()).catch(function(){var e=r.headers||{};e["Authorization"]="Bearer";e["X-Ms-SDK-Host"]=w;return p({type:"GET",url:"/Autodiscover/AutodiscoverService.svc/root/oauth/user",headers:e}).then(function(e){return R(e)})}).then(function(t){if(!t)throw u("NoOAuthUri",{rsp:O,src:x});var n=new i(t);var r=i.Query(n.query());r.response_type="token";r.client_id=d;r.redirect_uri=S||x;r.resource=new i(D).path("/").query("").hash("")+"";r.state=v+"."+M++;r.prompt="none";n.query(r+"");A=new e.Date;return a({type:"GET:TOKEN",url:n+""}).then(function(t){E[c]=t.responseText;I=P;return g&&U.getOAuthPath().then(function(t){_=new e.Date;return U.getWebTicket(t)}).then(function(e){if(C&&y!="Bearer"){E[c]=""+e;I=k}else{E[c]="Bearer "+e;I=P}}).catch(function(e){})})}).finally(function(){T=null});return o.wait(T).then(function(){return p(r,true)}).then(function(t){if(f.isAuthRequired(t)){t.token_issued=A;t.cwt_issued=_;var n=new e.Date,r=3600*1e3;if(A&&+n>+A+r/2||_&&+n>+_+r/2){b&&b.record("slow_401",{rsp:t});return m(t)}}return t})})}}t.OAuth=f;(function(n){function r(t,n,r){if(n===void 0){n=e.window.location}if(r===void 0){r=e.window.document}return new s(function(e,a,o){var s=new i(t.query.get("redirect_uri"));if(!s.host())t.query.set("redirect_uri",new i(n.href).path(s.path()).query("").hash("")+"");var u=r.createElement("iframe");u.style.display="none";u.src=t+"";r.body.appendChild(u);u.onload=function(){try{var n=i.Query(u.contentWindow.location.hash.slice(1));r.body.removeChild(u);if(n.error){a(d(t+"",n))}else{e(n.token_type+" "+n.access_token)}}catch(e){}};o("GET "+t)})}n.getToken=r;function o(e){var t=new i(e);return i.Query(t.query()).redirect_uri||e}n.baseurl=o;function u(e){var t=new i(e);var n=i.Query(t.query()).resource;return new i(n).host()}n.audfqdn=u;function f(e){if(e.status==401)return true;if(e.status==500||e.status==403){var n=c(e.headers);var r=l(n.get(t.sMSD));var i=r.code;return i==28032||i==28033||i==28072||i==28077||i==28055||!!n.get(t.sW3A)}return false}n.isAuthRequired=f;function p(e){var n=c(e.headers);var r=a(n.get(t.sW3A))["Bearer"];return r&&r.audience}n.getAudience=p})(f=t.OAuth||(t.OAuth={}))})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.URI;var r=e.Utils.Task;var i=e.Utils.Exception;function a(a){var o=a||e.window.document;return t.MsRtcOAuth(function(e,a){var s,u,c=new n(a.href).path("")+"",d=new t.WebTicketService(c,e);return r.wait(0).then(function(){return r.waitAll([d.getPassiveAuthUrl().then(function(e){s=e}),d.getWsFedPassivePath().then(function(e){u=e})])}).then(function(){var e=0,n=[];function i(e){n[e]=new r("waiting for the "+e+"-th onload event from iframe at "+s);return n[e].promise}var a=o.createElement("iframe");a.style.display="none";a.src=s;a.onload=function(){n[++e].resolve()};o.body.appendChild(a);return r.waitAny([r.wait(0).then(function(){return d.getWebTicket(u)}),i(1).then(function(){return d.getWebTicket(u)}),i(2).then(function(){return d.getWebTicket(u)})]).then(function(e){return new t.WebTicket("Bearer "+e)}).finally(function(){o.body.removeChild(a)})}).catch(function(e){throw s?i("NotSignedIn",{aspx:s,reason:e}):e})})}t.ADFS=a})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t,n){return e.MsRtcOAuth({grant_type:"password",username:t,password:n})}e.Basic=t})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(){return e.MsRtcOAuth({grant_type:"urn:microsoft.rtc:windows"})}e.Integrated=t})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(t,n){return e.MsRtcOAuth({grant_type:"urn:microsoft.rtc:anonmeeting",ms_rtc_conferenceuri:t,password:n||t.match(/:(\w+)$/)[1]})}e.AnonMeeting=t})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.URI;function r(r,i){if(i===void 0){i=r.match(/:(\w+)$/)[1]}var a;return t.MsRtcOAuth(function(o,s){var u=new n(s.href).path("")+"";var c=new t.WebTicketService(u,o);return c.getAnonWebTicket(r,i,a).then(function(t){t.expires=t.expires&&new e.Date(+t.expires-10*60*1e3);return a=t})},"X-MS-WebTicket",true)}t.AnonMeetingInternal=r})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";function t(e,t){return function(n,r){if(n.url!=t)n.headers["Authorization"]=e;return r(n)}}e.Token=t})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.URI;var r=e.Utils.Http;var i=e.Utils.Task;var a=e.Utils.random;var o=e.Utils.Exception;var s=function(){function t(t,r,i,a){if(r===void 0){r=5e3}if(i===void 0){i=e.window}if(a===void 0){a=document}this.oauthCallback=t;this.timeout=r;this._window=i;this._document=a;this.oauth_callback_origin=new n(this.oauthCallback).origin();this.iframe=a.createElement("iframe");this.iframe.style.display="none";this.iframe.src=t;a.body.appendChild(this.iframe);if(i.addEventListener)i.addEventListener("message",this.processMessage.bind(this));else i.attachEvent("onmessage",this.processMessage.bind(this))}t.prototype.processMessage=function(e){try{if(e.origin!=this.oauth_callback_origin)return;var t=JSON.parse(e.data);if(t.id!=this.requestId)return;if(!r.isSuccess(t.status))this.tRequest&&this.tRequest.reject(t.error);else{switch(t.code){case"GETTOKEN":this.tRequest&&this.tRequest.resolve(t.token_type+" "+t.access_token);break}}}catch(e){}};t.prototype.post=function(e){this.requestId=a();e.id=this.requestId;this.iframe.contentWindow.postMessage(JSON.stringify(e),"*")};t.prototype.getToken=function(t){var n=this;return i.wait(this.pRequest).catch().then(function(){if(n.pRequest)return n.getToken(t);n.tRequest=new i;n.pRequest=n.tRequest.promise;var r=function(i){n.post({type:"GETTOKEN",uri:t+""});n.timerId=e.setTimeout(function(){if(!i)return r(true);n.tRequest&&n.tRequest.reject(o("OAuthCallbackTimeout",{reason:{uri:t}}))},n.timeout)};r(false);return n.pRequest.then(function(t){e.clearTimeout(n.timerId);return{status:200,responseText:t}}).finally(function(){n.tRequest=null;n.pRequest=null;e.clearTimeout(n.timerId)})})};t.prototype.reset=function(){try{if(this.iframe){this._document.body.removeChild(this.iframe);this.iframe.onload=null;this.iframe=null;e.clearTimeout(this.timerId)}}catch(e){}};return t}();t.OAuthTokenRetriever=s})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";"use strict";var t;(function(e){var t;(function(e){var t="SkypeWebSDK";var n;(function(n){var r=function(){function n(n,r){this.path=n;this.storage=r;try{if(!this.storage)this.storage=e.sessionStorage}catch(e){}this.key=[t].concat(this.path).join("//")}Object.defineProperty(n.prototype,"json",{get:function(){var e=this.storage.getItem(this.key);return e&&JSON.parse(e)},set:function(e){this.storage.setItem(this.key,JSON.stringify(e))},enumerable:true,configurable:true});n.prototype.remove=function(){this.storage.removeItem(this.key)};return n}();n.StorageItem=r})(n=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.map;var r=e.Utils.pick;var i=e.Utils.clone;var a=e.Utils.assert;var o=e.Utils.extend;var s=e.Utils.foreach;var u=e.Utils.isArray;var c=e.Utils.isEmptyObject;var d=e.Utils.Event;var l=e.Utils.Exception;var f=e.Utils.Collection;var p=e.Utils.BoolProperty;function v(e,t){var n=e.rel+"/"+t+" link does not exist";return l.call(n,"LinkMissing",{resource:r(e,["rel","href"]),rel:t})}function h(e,t){var n="one "+e.rel+"/"+t+" link expected, "+e.links(t).length+" found";return l.call(n,"SingleLinkExpected",{resource:r(e,["rel","href"]),rel:t})}function m(e,t){var n=e.rel+"."+t+" property does not exist";return l.call(n,"AttrMissing",{resource:r(e,["rel","href"]),name:t})}var g=function(){function e(t){var r={toString:O};var l=p(false);var g=false;var y,S,b;var w={};var E={};var T={};var I=f();var M=new d({added:function(e){e()}});var C=new d({added:function(e){if(g)e()}});if(arguments.length>1){t={rel:arguments[1],_links:{self:{href:arguments[0]}}};if(arguments[2]>1){b=arguments[2];t._links.self.revision=b}}A();y=t.rel||null;b=t._links.self.revision;function A(){try{S=t._links.self.href}catch(e){throw v(t,"self")}for(var n in t._links){var r=t._links[n];if(!u(r))r=[r];w[n]=r}if(t._embedded){for(var i in t._embedded){var a=t._embedded[i];if(!u(a))a=[a];for(var o=0,s=a;o<s.length;o++){var c=s[o];var d=new e(c);d.rel=d.rel||i;if(d.rel=="mediaRelay"&&d.href==S)d.href+="/"+d.properties.host+"/"+d.properties.location;E[d.href]=d;if(!w[i])w[i]=[];if(!V(i,d.href))w[i].push({href:d.href})}}}for(var l in t)T[l]=t[l];delete T.rel;delete T._links;delete T._embedded}function _(e){if(!g){g=true;C.fire(e)}}function R(t){a(r.href==t.href);r.related=w=i(t.related);r.properties=T=i(t.properties);r.embedded=E=n(t.embedded,function(t){return new e(t.getSnapshot())});l(false);M.fire()}function P(e){var t=w[e];if(t)return t[0].href}function k(e){var t={rel:y,_links:{}};for(var n in T)t[n]=T[n];for(var n in w){if(n!="self"&&e&&!e(n))continue;var r=w[n];if(r.length>0)t._links[n]=r.length>1?r:r[0]}return i(t)}function O(e){if(e===void 0){e=4}var t=k();if(!c(E))t._embedded={};for(var n in E){var r=void 0,i=void 0;e:for(r in t._links){var a=t._links[r];if(u(a)){for(i=0;i<a.length;i++){if(a[i].href==n)break e}}else if(a.href==n){i=0;break}}var o=JSON.parse(E[n]+"");if(!o.rel)delete o.rel;t._embedded=t._embedded||{};t._embedded[r]=t._embedded[r]||[];t._embedded[r].push(o);if(u(t._links[r]))t._links[r].splice(i,1);if(!u(t._links[r])||!t._links[r].length)delete t._links[r]}for(var s in t._embedded)if(t._embedded[s].length==1)t._embedded[s]=t._embedded[s][0];return JSON.stringify(t,null,e).replace(/{\s*\n\s*("href"):\s*(".+?")\s*\n\s*}/gm,"{ $1: $2 }")}function x(e){s(w,function(t,n){s(t,function(t){if(!E[t.href])e(t,n)})});s(E,function(t){t.forEachLink(e)})}function D(e,t){if(!V(e,t)){if(!w[e])w[e]=[];w[e].push({href:t});M.fire()}return r}function U(e,t){var n=w[e];if(n){for(var i=0;i<n.length;i++){if(n[i].href==t){n.splice(i,1);M.fire();break}}}return r}function N(e){var t=w[e]
;if(!t||t.length==0)throw v(r,e);if(t.length>1)throw h(r,e);return t[0]}function L(e){return w[e]||[]}function V(e,t){var n=w[e]||[];if(!t)return n.length>0;for(var r=0;r<n.length;r++)if(n[r].href==t)return true;return false}function W(e,t){T[e]=t;M.fire();return r}function B(e,t){if(!e)return i(T);if(e=="href")return S;if(e in T)return T[e];if(arguments.length==1)throw m(r,e);return t}function j(e){return e=="href"||e in T}return o(r,{href:S,rel:y,revision:b,memberships:I,properties:T,related:w,embedded:E,remove:_,updateFrom:R,relatedHref:P,updated:M.observer,deleted:C.observer,forEachLink:x,getSnapshot:k,dirty:l,addLink:D,removeLink:U,hasLink:V,link:N,links:L,has:j,set:W,get:B})}return e}();t.Resource=g})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.extend;var r=e.Utils.foreach;var i=e.Utils.isFunction;var a=function(){function e(t){if(t===void 0){t={}}if(!(this instanceof e))return new e(t);n(this,t)}e.prototype.toString=function(){var e=[];r(this,function(t,n){if(n=="resource"){if(t)e.push('    "resource": '+t)}else if(!i(t))e.push('    "'+n+'": '+JSON.stringify(t))});return"{\n"+e.reverse().join(",\n")+"\n}"};return e}();t.ResourceEvent=a})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.map;var r=e.Utils.clone;var i=e.Utils.assert;var a=e.Utils.extend;var o=e.Utils.values;var s=e.Utils.filter;var u=e.Utils.foreach;var c=e.Utils.indexOf;var d=e.Utils.isArray;var l=e.Utils.isString;var f=e.Utils.isFunction;var p=e.Utils.isNotEmptyString;var v=e.Utils.Event;var h=function(){function e(e){var d=e===void 0?{}:e,l=d.connection,h=d.snapshot;var m={toString:C};var g=new v({added:function(e){return e()}});var y={};var S={};if(l){l.event(b);l.connected.when(false,function(){u(y,function(e){if(e.rel=="me")E(e.href)})})}if(h){u(h,function(e,n){u(e,function(e){e=r(e);e.rel=n;w(new t.Resource(e))})})}function b(e){var n=e.type;var r=e.sender;var i=e.target;var a=e["in"];w(new t.Resource(r.href,r.rel),true);if(e.resource){w(e.resource);e.resource=y[e.resource.href]}else{w(new t.Resource(i.href,i.rel),true);if(n=="updated")y[i.href].dirty(true)}if(a){w(new t.Resource(a.href,a.rel),true);if(n=="added"){y[a.href].addLink(i.rel,i.href);if(!y[i.href].memberships(a.href))y[i.href].memberships.add(y[a.href],a.href)}if(n=="deleted"){y[a.href].removeLink(i.rel,i.href);if(y[i.href].memberships(a.href))y[i.href].memberships.remove(a.href)}}if(n=="deleted"||n=="completed"){if(!a)E(i.href,e.reason)}}function w(e,n){if(n===void 0){n=false}if(!e.links)e=new t.Resource(e);if(!e.rel||!e.href)return;var r,a,o,s,u;var d=!y[e.href];g.fire();if(d){e.isLink=n;y[e.href]=e;if(n)e.dirty(true);if(!S[e.rel])S[e.rel]=[];S[e.rel].push(e.href)}for(a in e.related){for(s=0;s<e.related[a].length;s++){o=e.related[a][s];r=o.href;if(!y[r]&&!e.embedded[r])w(new t.Resource(r,a,o.revision),true)}}for(r in e.embedded)w(e.embedded[r]);if(!d&&!n){y[e.href].updateFrom(e);if(y[e.href].isLink&&y[e.href].rel!=e.rel){u=S[y[e.href].rel];i(u);u.splice(c(u,e.href),1);if(u.length==0)delete S[y[e.href].rel];if(!S[e.rel])S[e.rel]=[];S[e.rel].push(e.href);y[e.href].rel=e.rel}}}function E(e,t){i(p(e));var n=y[e];if(n){var r=S[n.rel];r.splice(c(r,e),1);delete y[e];n.remove(t);g.fire()}}function T(e){i(p(e));if(y[e])return[y[e]];if(S[e]){var t=S[e];var n=[];for(var r=0,a=t;r<a.length;r++){var o=a[r];n.push(y[o])}return n}return[]}function I(e){return o(s(y,e))}function M(e){var t=f(e)?s(S,function(t,n){return e(n)}):S;return n(t,function(t){return n(t,function(t){var n=y[t].getSnapshot(e);delete n.rel;return n})})}function C(e){return JSON.stringify(M(),null,e)}return a(m,{put:w,get:T,find:I,remove:E,updated:g.observer,getSnapshot:M,toString:C})}return e}();t.Repository=h;(function(e){function t(e){e=r(e);u(e,function(t,n){if(!d(t))e[n]=t=[t];u(t,function(e,n){if(l(e))t[n]=e={_links:{self:{href:e}}}})});return e}e.expandSnapshot=t})(h=t.Repository||(t.Repository={}))})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.check;function r(e){var r=[];for(var i=0,a=e;i<a.length;i++){var o=a[i];for(var s=0,u=o.events;s<u.length;s++){var c=u[s];var d=null;if(c._embedded)for(var l in c._embedded){n(!d,"Only one resource is expected in _embedded");n(!d,"AlreadyExists",{item:"embedded resource",resource:c});d=new t.Resource(c._embedded[l]);d.rel=d.rel||l}var f={resource:d,sender:{rel:o.rel,href:o.href},target:c.link};for(var p in c)f[p]=c[p];delete f["_embedded"];delete f["link"];r.push(new t.ResourceEvent(f))}}return r}t.EventCollection=r})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.Event;var r=e.Utils.Property;var i=e.Utils.Exception;var a=e.Utils.BoolProperty;var o=function(){function o(s,u,c){var d;var l=new n;var f=new n;var p=a();var v=r();function h(n,r){var a=++d.channelId;function l(n,r,h,g){if(h&&g){c&&c.record(e.TelemetryEvent.EventChannel,{action:h,instance:r,source:g,target:n})}s.ajax({type:"GET",url:n,instanceId:r,query:{timeout:d.timeout},channel:a,resend:d.timeout&&d.timeout*1.2,priority:1e4}).then(function(e){if(a!=d.channelId)return;if(e.hasLink("next"))l(e.link("next").href,r);else if(e.hasLink("resume"))l(e.link("resume").href,r,"resume",n);else if(e.hasLink("resync"))l(e.link("resync").href,r,"resync",n);else throw i("NextEventLinkMissing",{resource:e,debug:e.debug});p(true);try{m(e.properties["sender"],e.debug)}catch(e){f.fire(e)}}).catch(function(e){if(a!=d.channelId)return;if(o.is409Error(e)){u(true,e)}else if(!t.Endpoint.is410Error(e)){p(false,e)}}).then(null,null,function(e){v(e)})}l(n,r)}function m(e,n){var r={},i=t.EventCollection(e||[]);for(var a=0,o=i;a<o.length;a++){var s=o[a];var u=s+"";if(!r[u]){r[u]=true;if(n&&s)Object.defineProperty(s,"debug",{value:n});l.fire(s)}}}return d={channelId:0,timeout:undefined,status:v.asReadOnly(),connect:h,connected:p.asReadOnly(),error:f.observer,event:l.observer}}return o}();t.EventChannel=o;(function(e){e.is409=function(e){return e&&e.status==409&&e.data&&e.data.subcode=="PGetReplaced"};e.is409Error=function(t){return t&&t.code=="RequestFailed"&&e.is409(t.rsp)}})(o=t.EventChannel||(t.EventChannel={}))})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.assert;var i=e.Utils.foreach;var a=e.Utils.isVoid;var o=e.Utils.isString;var s=e.Utils.isDictionary;var u=e.Utils.Http;var c=e.Utils.HttpHeaders;function d(e){if(a(e.data)||e.type=="GET")return"";if(o(e.data))return e.data+"";if(s(e.data))return JSON.stringify(e.data);return e.data+""}function l(e){var t=c(e.headers);if(s(e.data))t.add("Content-Type","application/json");t.add("Host","Host");return t+""}function f(e){var t="";if(e.type=="GET"){i(e.data||{},function(e,n){t+=(t?"&":"?")+n+"="+e})}return e.url+t}function p(e){var t=l(e);var n=d(e);var r=f(e);return e.type+" "+r+" HTTP/1.1\r\n"+t+n}function v(e,t){var n=[];for(var r=0,i=e;r<i.length;r++){var a=i[r];var o=p(a);n.push("--"+t);n.push("Content-Type: application/http; msgtype=request");n.push("");n.push(o)}return n.join("\r\n")+"\r\n--"+t+"--\r\n"}function h(e){var t;for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i.priority>t||t===undefined)t=i.priority}return t}function m(e){e=e.substring(2,e.length-2);var t=e.indexOf("\r\n\r\n");var n=e.indexOf("\r\n",t+4);var i=e.indexOf("\r\n\r\n",t+4);r(t>0&&n>0&&i>0);return{outer:e.substring(0,t),status:e.substring(t+4,n),inner:e.substring(n+2,i),body:e.substring(i+4)}}var g=function(){function e(e){this.url=e}e.prototype.compose=function(e){var t=n();var r=v(e,t);var i=h(e);return{type:"POST",priority:i,url:this.url,data:r,headers:{"Content-Type":"multipart/batching;boundary="+t,Accept:"multipart/batching"}}};e.prototype.parse=function(e){var t=c(e.headers);var n=t.get("Content-Type").match(/boundary="(.*?)"/i)[1];var i=e.responseText.split("--"+n);r(i.length>2);r(i[i.length-1]=="--\r\n");var a=[];for(var o=0,s=i.slice(+1,-1);o<s.length;o++){var u=s[o];try{var d=m(u);var l=+d.status.match(/(\d{3})/)[1];r(l>=0);a.push({status:l,headers:c.parse(d.inner),responseText:d.body})}catch(e){a.push({status:417,headers:{},responseText:e+""})}}return a};return e}();t.Batch=g})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.random;var i=e.Utils.foreach;var a=e.Utils.URI;var o=e.Utils.Task;var s=e.Utils.Property;var u=e.Utils.Exception;var c=e.Utils.HttpHeaders;var d=e.Auth.EOAuthFailed;function l(e){var t="Insecure resource at "+e+" cannot be loaded.";return u.call(t,"MixedContent",{url:e})}var f=function(){function t(t,f,p,v){var h=t||e.window;var m=h.document;var g;var y={};var S={};var b={};var w={};var E={};var T=s({set:function(t){var r=new a(t);if(r.scheme()!="https")throw l(t);T._set(t);var i=f&&f.timeout(5e3,e.TelemetryEvent.XFrameTimeout,{url:t});return n(M)(t).then(function(){i&&i.cancel();return t})}});function I(){var e=u("Reset");function t(t){try{t.reject(e)}catch(e){}}i(b,t);i(w,t);i(E,t);i(y,P);if(g)g.onload=null;g=null;S={};b={};w={};E={}}function M(t){var n="ucwa-"+r();var i=new o("iframe at "+t);var a=new o("xframe at "+t);if(g&&!S[g.id])k(g.id);g=m.createElement("iframe");g.style.display="none";g.title=(new e.Date).toJSON();g.src=t;g.id=n;g.onload=function(){if(i){i.resolve();i=null}if(this.contentWindow){A(this,{type:"PING",url:"/"})}else{a.reject()}};m.body.appendChild(g);y[n]=g;S[n]=0;b[n]=i;w[n]=a;return a.promise}function C(e){var t=g;if(!t)throw u("NoTarget");var n=t.id+":"+r();var i=new o({cancel:function(e){_(n);i.reject(e)}});E[n]=i;S[t.id]++;if(!e.headers)e.headers={};if(!e.headers["X-Ms-SDK-Host"])e.headers["X-Ms-SDK-Host"]=v;b[t.id].promise.then(function(){var r=e.type+" "+e.url;var a=e.headers&&e.headers["Client-Request-Id"];if(a)r+=" creqid:"+a;i.status(r);A(t,e,n)},null,i.status);return i.promise}function A(e,t,n){t.messageId=n||e.id+":"+r();e.contentWindow.postMessage(JSON.stringify(t),"*")}function _(e){var t=e.split(":")[0];delete E[e];S[t]--;if(t!=g.id&&!S[t])k(t)}function R(e){try{var t=JSON.parse(e.data);var n=t.messageId;var r=n.split(":")[0];var i=E[n];if(i){_(n);delete t.messageId;t.headers=c.parse(t.headers||"");i.resolve(t)}if(w[r]){if(t.oauth2&&t.oauth2.error){w[r].reject(d(T(),t.oauth2))}else{var a=t.headers||{};a["Authorization"]=null;a["X-Ms-SDK-Host"]=v;A(y[r],{type:"GET",url:"/ucwa/oauth",headers:a});w[r].resolve()}w[r]=null}}catch(e){return}}function P(e){try{m.body.removeChild(e)}catch(e){}}function k(e){P(y[e]);delete y[e];delete S[e];delete b[e];delete w[e]}if(h.addEventListener)h.addEventListener("message",R);else h.attachEvent("onmessage",R);return{src:T,send:n(C),reset:I}}return t}();t.XFrame=f})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.URI;var r=e.Utils.Promise;var i=e.Utils.Property;var a=e.Utils.HttpHeaders;var o=function(){function t(e,t,n,r){this.XHR=e;this.tm=t;this.creds=n;this.hostProperty=r;this.src=i()}t.prototype.reset=function(){};t.prototype.send=function(t){var i=this;return new r(function(r,o,s){var u=new n(t.url);if(!u.host()){if(!i.src())throw Error("The target FQDN must be set to send relative requests.");var c=new n(i.src());u.scheme(c.scheme()).host(c.host()).port(c.port());t.url=u+""}t.headers=t.headers||{};if(!t.headers["X-Ms-SDK-Host"])t.headers["X-Ms-SDK-Host"]=i.hostProperty;if(!t.headers["Accept"])t.headers["Accept"]="*/*";if(t.data&&typeof t.data!="string"){t.data=n.Query(t.data)+"";t.headers["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"}if(t.type=="GET"&&t.data){t.url=/^[^#]*/.exec(t.url)[0];t.url+=(t.url.indexOf("?")<0?"?":"&")+t.data;delete t.data}var d=new(i.XHR||e.XMLHttpRequest);d.open(t.type,t.url,true);for(var l in t.headers)d.setRequestHeader(l,t.headers[l]+"");if(i.creds!==false)d.withCredentials=t.creds;d.onreadystatechange=function(){if(d.readyState==4){if(!d.status&&i.tm)i.tm.record(e.TelemetryEvent.CorsFailed,{type:t.type,url:t.url,withCreds:t.creds});r({status:d.status==1223?204:d.status,statusText:d.statusText,headers:a.parse(d.getAllResponseHeaders()),responseText:d.responseText})}};var f=t.headers&&t.headers["X-MS-Correlation-Id"];var p=t.headers&&t.headers["Client-Request-Id"];s(t.type+" "+t.url+" "+f+"/"+p);d.send(t.data||null)})};return t}();t.XHR=o})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.sleep;var r=e.Utils.throttle;var i=e.Utils.removeAll;var a=e.Utils.repeatAndExit;var o=e.Utils.Exception;var s=e.Utils.HttpHeaders;function u(e,t,r,i){return function(o){var s=t();return a(function(t){return e(o).then(function(e){if(e.status!=r||i&&!i(e))throw t(e);var a=s();if(a>=0)return n(a);throw t(e)})})}}var c=function(){function t(t,a){var c=a===void 0?{}:a,d=c.tm,l=c.buffer,f=c.version,p=c.session,v=c.hostProperty,h=c.fmax,m=c.fmin,g=m===void 0?Math.pow(2,-64):m,y=c.delay,S=y===void 0?[]:y,b=c.retry,w=c.now,E=w===void 0?function(){return e.Date.now()}:w;var T=new e.Identity(function(e){return t.send(e)}).map(function(t){return function(n){var r=t(n);var i=n.timeout;if(i>0){var a=e.setTimeout(function(){var e=o("RequestTimeout",{request:n});try{r.cancel(e)}catch(e){}},i*1e3|0);r.finally(function(){e.clearTimeout(a)})}return r}}).map(function(t){if(!h)return t;var r={};var a=function(t){return e.Math.log(t)/e.Math.log(2)};var o=0;return function e(s){var u=E();var c=(u-o)/1e3;for(var d in r)r[d]/=Math.pow(2,c);i(r,function(e){return e<g});o=u;var l=s.type+" "+s.url;var f=r[l]||0;if(f+1>h){var p=a(f/(h-1));return n(p).then(function(){return e(s)})}else{r[l]=f+1;return t(s)}}}).map(function(e){return function(t){t.headers=t.headers||{};if(f)t.headers["X-Ms-SDK-Version"]=f;if(p)t.headers["X-Ms-SDK-Session"]=p;return e(t)}}).map(function(e){if(!l)return e;var t=r(e,l);return function(e){return t(e,e.priority)}}).map(function(e){return!S[0]?e:u(e,S[0],0)}).map(function(e){return!S[404]?e:u(e,S[404],404,function(e){var t=e.headers||{};return!/^application\/.+/.test(t["Content-Type"])&&(t["Server"]||t["X-Ms-Server-Fqdn"])})}).map(function(e){return!S[502]?e:u(e,S[502],502,function(e){return!e.headers||/^application\/.*(json|xml)/.test(s(e.headers).get("Content-Type"))})}).map(function(e){return!S[503]?e:u(e,S[503],503)}).map(function(t){if(b&&b[483]===null)return t;return u(t,function(){var t=1,n=3,r=15*60,i=e.Date.now();return function(){t*=1.5;if(t>=r){t=r;n--;if(n<1)throw o("Recurring483",{duration:e.Date.now()-i})}return t}},483)}).map(function(e){if(!b)return e;var t=function(e){return function(){var t=0;return function(){return e[t++]}}};for(var n in b){var r=b[n];e=u(e,t(r),n)}return e}).value;return{ajax:T}}return t}();t.Transport=c})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.map;var r=e.Utils.async;var i=e.Utils.repeatAndExit;var a=e.Utils.Task;var o=e.Utils.Exception;function s(e,t,n){var r="UCWA not found on "+e;return o.call(r,"DiscoveryFailed",{response:t,root:e,reason:n})}function u(e){var o=e.domain;var u=e.origins;var c=e.Transport||t.Transport;var d=e.XFrame||t.XFrame;var l=e.xframe;var f=e.hostProperty;function p(e){var n=e.internal;var r=e.xframe;var a=e.origin;var o=new d(undefined,undefined,undefined,f);var u=new c(o,{hostProperty:f});o.src(r);return u.ajax({type:"GET",url:a}).then(function(e){var r;try{r=new t.Resource(JSON.parse(e.responseText))}catch(t){throw s(a,e,t)}return i(function(e){if(!r.hasLink("redirect"))return e();o.src(r.link("xframe").href);return u.ajax({type:"GET",url:r.link("redirect").href}).then(function(e){try{r=new t.Resource(JSON.parse(e.responseText))}catch(t){throw s(a,e,t)}})}).then(function(){r.rel=r.rel||"root";r.set("internal",n);if(r.hasLink("xframe"))o.src(r.link("xframe").href);else r.addLink("xframe",o.src());return r})}).finally(function(){o.reset()})}function v(){if(!u){u=[];u.push({internal:true,origin:"https://lyncdiscoverinternal."+o,xframe:"https://lyncdiscoverinternal."+o+"/xframe"});u.push({internal:false,origin:"https://lyncdiscover."+o,xframe:"https://lyncdiscover."+o+"/xframe"});u.push({internal:true,origin:"http://lyncdiscoverinternal."+o,xframe:"http://lyncdiscoverinternal."+o+"/xframe"});u.push({internal:false,origin:"http://lyncdiscover."+o,xframe:"http://lyncdiscover."+o+"/xframe"})}return a.waitAny(n(u,r(p)))}return{root:v().then(function(e){l.src(e.link("xframe").href);return e})}}t.AutoDiscovery=u})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.HttpHeaders;function r(e){var r=[];var i={};for(var a=0,o=e;a<o.length;a++){var s=o[a];var u=s.responseText;var c=n(s.headers);var d=c.get("Content-ID");var l=c.get("Content-Type");if(!d)r.push(new t.Resource(JSON.parse(u)));else{i["cid:"+d]={data:u,mime:l.replace(/\s/g,"")}}}for(var f=0,p=r;f<p.length;f++){var v=p[f];v.forEachLink(function(e){var t=i[e.href];if(t)e.href="data:"+t.mime+","+t.data})}return r}t.parseMultipartResources=r})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.check;var r=e.Utils.Exception;var i=e.Utils.HttpHeaders;var a=e.Utils.ContentTypeHeader;var o=/(\r\n|\n){2}/;var s=/^(\r\n|\n)/;var u=/(\r\n|\n)$/;var c=/--\s*$/;function d(e){try{var t=a(i(e.headers).get("Content-Type"));n.equals(t.mimeType,"multipart/related");n.belongs("boundary",t.attributes);var d=e.responseText.split("--"+t.attributes["boundary"]);n(c.test(d[d.length-1]));n(d.length>=3);return d.slice(+1,-1).map(function(e,t){var n=o.exec(e);if(!n)throw r("SingleHeaderExpected",{part:e,index:t});var i=e.substr(0,n.index);var a=e.substr(n.index+n[0].length);return{headers:i.replace(s,""),responseText:a.replace(u,"")}})}catch(t){throw r("InvalidMultipartRelatedResponse",{response:e,reason:t})}}t.parseMultipartRelatedResponse=d})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.keys;var r=e.Utils.check;var i=e.Utils.filter;var a=e.Utils.values;var o=e.Utils.isObject;function s(e){var s=i(e,o);r(a(s).length==1,"single root expected");var u=n(s)[0];var c=s[u];var d=i(c.Links,function(e){return e.token=="Self"});r(d.length==1,"single self href expected");var l=d[0].href;var f=new t.Resource(l,u.toLowerCase());for(var p=0,v=c.Links;p<v.length;p++){var h=v[p];if(h.href!=l)f.addLink(h.token.toLowerCase(),h.href)}return f}t.parseAutodiscoverResource=s})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.map;var r=e.Utils.bind;var i=e.Utils.guid;var a=e.Utils.pick;var o=e.Utils.async;var s=e.Utils.clone;var u=e.Utils.sleep;var c=e.Utils.assert;var d=e.Utils.foreach;var l=e.Utils.isObject;var f=e.Utils.isString;var p=e.Utils.debounced;var v=e.Utils.getOption;var h=e.Utils.obscureAuthHeader;var m=e.Utils.URI;var g=e.Utils.Http;var y=e.Utils.Task;var S=e.Utils.Event;var b=e.Utils.Property;var w=e.Utils.Exception;var E=e.Utils.HttpHeaders;function T(e,t){var n=e.type+" "+e.url+" failed: "+(t.statusText||t.status);if(e){e=s(e);delete e.data;e=h(e)}return w.call(n,"RequestFailed",{req:e,rsp:t})}t.ERequestFailed=T;var I=function(){function h(I){var M=new S;var C=I.transport;var A=I.batchRetryDelay||3;var _=o(I.auth);var R=I.restore&&p(I.restore);var P=I.replace&&p(I.replace);var k=v(I,"enableInternalNS",true);var O=I.tm;var x=I.user;var D=I.anon;var U=e.Date.now();x&&x.isActive.changed(function(){return U=e.Date.now()});var N=false;var L;var V;var W=b({value:false,set:function(t,n){if(t){O&&O.record(e.TelemetryEvent.EndpointSuspend,{reason:n});c(!L);V=new y(n+"");L=V.promise;L.finally(function(){L=null;V=null});return true}else{O&&O.record(e.TelemetryEvent.EndpointResume,{reason:n});c(L);L=null;N=true;return V.from(P()).then(function(){N=false;return false})}}});var B=p(function(){var t=e.Date.now()-U;if(D||x&&x.isActive()||x&&t<x.inactivityTimeout||x&&x.inactivityTimeout==-1)return R();var n=i();W(true,w("UserInactive",{inactiveDuration:t,inactivityTimeout:x&&x.inactivityTimeout,suspensionId:n}));return L.then(function(){O&&O.record(e.TelemetryEvent.Endpoint,{action:"restore",reason:"useractive",suspensionId:n})})});function j(e,t){d(t,G);var n=e.compose(t);return z(n).then(function(r){if(r.status==429){return u(A).then(function(){return j(e,t)})}if(!g.isSuccess(r.status))throw T(n,r);return F(e,t,r)})}function F(e,t,r){var i=e.parse(r);c(t.length==i.length);return n(t,o(function(e,n){return q(t[n],i[n])}))}function G(e){e.url=m.mergeQuery(e.url,e.query);if(!e.headers)e.headers={};e.headers["Accept"]="application/json";if(e.version>1)e.headers["X-MS-RequiresMinResourceVersion"]=e.version;if(f(e.data)){e.headers["Content-Type"]=e.headers["Content-Type"]||"text/plain"}else if(l(e.data)){if(e.type=="POST"||e.type=="PUT"){if(e.type=="PUT")e.headers["If-Match"]='"'+e.data.etag+'"';e.data=JSON.stringify(e.data);e.headers["Content-Type"]="application/json"}}}function H(e){try{e.data=JSON.parse(e.responseText)}catch(e){}}function q(e,n){c(n);var r,i,o=E(n.headers);H(n);if(!g.isSuccess(n.status)){throw T(e,n)}else if(!n.responseText){return new t.Resource(o.get("Location"),null)}else{try{r=n.data;i=o.get("Content-Type")=="application/vnd.microsoft.rtc.autodiscover+json; v=1"?t.parseAutodiscoverResource(r):new t.Resource(r)}catch(e){r=t.parseMultipartRelatedResponse(n);i=t.parseMultipartResources(r)[0]}Object.defineProperty(i,"debug",{value:{rsp:n&&a(n,["status","statusText","headers"])}});return i}}var z=new e.Identity(o(C.ajax)).map(function(t){return function(n){n.headers=n.headers||{};if(k)n.headers["X-Ms-Namespace"]="internal";var r=(e.Math.random()*2147483648|0)+"";n.headers["X-MS-Correlation-Id"]=r;n.headers["Client-Request-Id"]="WebSDK/"+r;return t(n)}}).map(function(e){return function(t){return _(t,e).then(function(e){if(e["webTicketRenewed"])M.fire(t,e);return e})}}).map(function(e){return function(t){return e(t).then(function(e){H(e);return e})}}).map(function(t){if(!O)return t;return function(n){return t(n).then(function(t){if(n.type=="POST"&&/\/applications$/.test(n.url))O&&O.record(e.TelemetryEvent.CreateApplicationCompleted,{status:t.status,reason:{rsp:t&&a(t,["status","statusText","headers","data.endpointId","data.id","data.type","data._links.events.href"])}});return t})}}).map(function(e){return function t(n){return L?L.then(function(){return t(n)}):e(n).then(function(r){if(!h.is404(r))return r;if(N&&n.instanceId)return r;O&&O.record("apps_404",{reason:{req:n,rsp:r}});return B().then(function(t){if(n.instanceId&&n.channel)return r;return e(n)},function(e){if(!h.is410Error(e))throw e;W(true,e);if(n.instanceId)throw e;return t(n)})})}}).value;var Y=new e.Identity(z).map(function(e){return function(t){G(t);return e(t).then(r(q,t))}}).map(function(t){return function(n){var r=t(n);if(!n.resend)return r;var i=new y;var a=false;var o=e.setTimeout(function(){a=true;n=s(n);n["resent"]=1;t(n).then(function(e){return i.resolve(e)},function(e){return i.reject(e)},function(e){return i.status(e)})},n.resend*1e3|0);r.finally(function(){return e.clearTimeout(o)}).then(function(e){return!a&&i.resolve(e)},function(e){return!a&&i.reject(e)},function(e){return!a&&i.status(e)});return i.promise}}).value;return{suspended:W,renewed:M.observer,ajax:Y,batch:j}}return h}();t.Endpoint=I;(function(e){e.is404=function(e){return e&&e.status==404&&e.data&&e.data.subcode=="ApplicationNotFound"};e.is410=function(e){return e&&e.status==410&&e.data&&e.data.subcode=="LimitExceeded"};e.is410Error=function(t){return t&&t.code=="RequestFailed"&&e.is410(t.rsp)}})(I=t.Endpoint||(t.Endpoint={}))})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.async;var o=e.Utils.random;var s=e.Utils.batched;var u=e.Utils.URI;var c=e.Utils.Task;var d=e.Utils.Promise;var l=e.Utils.Exception;var f=e.Utils.BoolProperty;var p=e.Utils.ConstProperty;var v=function(){function v(v){var h=v.repository;var m=v.xframe;var g=v.endpoint;var y=v.connection;var S=v.maxBatchSize||0;var b=v.name;var w=v.anon;var E=b?void 0:v.id||n();var T=v.appType;var I=v.dwiid;var M=T=="Desktop"?I&&v.id&&n():v.id&&n();var C=v.version;var A=v.culture;var _=v.supportsWebRtc;var R=v.root;var P=v.tm;var k;var O;var x=false;var D=false;var U=true;var N=v.lock;var L=v.imdn;var V=v.ecws;var W=v.cors;var B=f(false);var j=v.soac==void 0?true:v.soac;v=null;function F(e){return c.wait(e).then(function(e){var t=N.synchronized(z);if(e){h.put(e);return H(e).then(function(){return t()})}var n=h.get("application")[0];if(n){M=n.get("instanceId",M);return K()}return t()}).then(function(e){U=false;!D&&Q(e)})}function G(e){var t=new u(e);return t.scheme()=="http"?t.scheme("https")+"":e}function H(e){return i(this,void 0,d,function(){var t,n,r;return a(this,function(i){switch(i.label){case 0:return[4,g.ajax({type:"GET",url:e.link("user").href})];case 1:t=i.sent();n=b?t.hasLink("anonApplications"):t.hasLink("applications");if(!!n)return[3,7];return[4,g.ajax({type:"GET",url:e.link("user").href,headers:{Accept:"application/vnd.microsoft.rtc.autodiscover+json; v=1"}})];case 2:r=i.sent();r.rel=r.rel||"user";if(r.hasLink("xframe"))m.src(G(r.link("xframe").href));i.label=3;case 3:if(!r.hasLink("redirect"))return[3,5];return[4,g.ajax({type:"GET",url:G(r.link("redirect").href)})];case 4:r=i.sent();r.rel=r.rel||"redirect";if(r.hasLink("xframe"))m.src(r.link("xframe").href);return[3,3];case 5:return[4,g.ajax({type:"GET",url:r.link("user").href})];case 6:t=i.sent();i.label=7;case 7:t.rel=t.rel||"user";h.put(t);if(t.hasLink("xframe"))m.src(t.link("xframe").href);return[2,t]}})})}function q(t){if(h.get("application").length>0){var n=new u(h.get("application")[0].href).path();var r=new u(t.href).path();if(n!=r){var i=l("HrefChanged",{old:n,new:r,rsp:t.debug&&t.debug.rsp});P&&P.record(e.TelemetryEvent.ApplicationChanged,{reason:i});B(true,i);throw i}}}var z=function(){if(x)throw l("AppIsDeleted");var n=b?h.get("anonApplications")[0]:h.get("applications")[0];var r=(M||L)&&n.revision>=2?2:1;return c.run(function(){if(!w)return;var e=new u(m.src());var t=new u(n.href);if(e.host()!=t.host())return m.src(t.path("/xframe")+"")}).then(function(){var t=g.ajax({type:"POST",url:n.href,version:r,creds:W&&!w,data:{AnonymousDisplayName:b,RemoteEventChannel:V||undefined,UserAgent:C,Culture:A,EndpointId:E,InstanceId:r>=2?M:void 0,webRtcCapability:_?"Supported":void 0,EnableImdn:L,type:T}});P&&P.monitor(t,e.TelemetryEvent.ApplicationCreate,{anon:!!b,href:n.href,version:r},{sendEndEventOnly:true});return t}).then(function(e){O=e.href;if(!U&&j)q(e);h.put(e);return e}).catch(function(e){if(t.Endpoint.is410Error(e))$();throw e})};function Y(){x=true;var t=g.ajax({type:"DELETE",url:O,nobatch:true}).then(function(){});P&&P.monitor(t,e.TelemetryEvent.ApplicationDelete,{href:O},{sendEndEventOnly:true});return t}function X(){M=n();$();return J()}function J(){y&&y.channelId++;return z().then(Q)}function K(){return g.ajax({type:"GET",url:h.get("application")[0].href,creds:W&&!w,instanceId:M,headers:{"X-Ms-Get-App":o(),"If-None-Match":'"'+o()+'"'}}).then(function(e){h.put(e);O=e.href;return e})}function Q(e){D=true;if(e.hasLink("batch")&&!k)k=new t.Batch(e.link("batch").href);if(e.hasLink("events"))y&&y.connect(e.link("events").href,M)}function $(){var e=h.get("application")[0];e&&h.remove(e.href);var t=h.get("events")[0];t&&h.remove(t.href)}function Z(){if(h.get("events").length>0){var e=h.get("events")[0];e&&h.remove(e.href);if(h.get("application").length>0){var t=h.get("application")[0];t.removeLink("events",e.href)}}if(h.get("reportMyActivity").length>0){var n=h.get("reportMyActivity")[0];n&&h.remove(n.href)}}function ee(e){return g.ajax(e).then(function(e){h.put(e);return e.href&&h.get(e.href)[0]||e})}function te(e){if(e.length==1||!k||!S)return c.wait(e.map(ee));return g.batch(k,e).then(function(e){for(var t=0,n=e;t<n.length;t++){var r=n[t];c.wait(r).then(h.put)}return e})}g.renewed(function(){if(h.get("application").length==1)K()});var ne=new e.Identity(r(ee)).map(function(e){var t=!S?e:s(r(te),S);return function(n){n.priority=n.priority||0;return n.nobatch?e(n):t(n,n.priority)}}).map(function(e){var t={};return function(n){if(n.type!="GET")return e(n);var r=JSON.stringify(n);t[r]=t[r]||e(n).finally(function(){return delete t[r]});return t[r]}}).value;return{ajax:ne,id:p(E),restore:J,replace:X,remove:Y,ready:F(R),invalid:B.asReadOnly(),removeEventChannel:Z}}return v}();t.Application=v})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.find;var r=e.Utils.clone;var i=e.Utils.random;var a=e.Utils.URI;var o=e.Utils.Exception;var s=e.Auth.OAuth;var u=e.Auth.OAuthTokenRetriever;var c=function(){function e(e,t){var c=t.location,d=t.window,l=t.document,f=t.xframector,p=t.cors,v=t.tm,h=t.get_oauth_token,m=t.oauth_cb,g=t.oauth_cb_timeout,y=t.hostProperty;var S={};S[i()]=e;var b=m&&new u(m,g,d,l);return{reset:function(){b&&b.reset()},send:function(t){if(t.type=="GET:TOKEN"){var u=new a(t.url);if(m){return b.getToken(u)}else if(h){var d=u.query.get("resource");return h(d).then(function(e){return{status:200,responseText:e}},function(e){v&&v.record("get_oauth_token",{result:"failed",resource:d,url:t.url,reason:e});throw o("GetOAuthTokenFailed",{reason:e})})}else if(p){return s.getToken(u,c,l).then(function(e){return{status:200,responseText:e}})}else{var g=s.audfqdn(t.url);var w=n(S,function(e){return s.audfqdn(e.src())==g})||n(S,function(e){return new a(s.baseurl(e.src())).host()==g})||new f(undefined,v,undefined,y);return w.src.set(u+"").then(function(){var e=t.headers||{};e["Authorization"]=null;e["X-Ms-SDK-Host"]=y;if(new a(s.baseurl(w.src())).host()!=g)return w.send({type:"GET",url:"/ucwa/oauth",headers:e})}).then(function(){var e=i();S[e]=w;return{status:200,responseText:e}})}}else{var E=n(S,function(e,n){return t.headers&&t.headers["Authorization"]==n});if(E){t=r(t);delete t.headers["Authorization"]}return(E||e).send(t)}}}}return e}();t.OAuthTokenIssuer=c})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=e.Utils.URI;var r=e.Utils.Task;var i=e.Utils.Http;var a=e.Utils.isString;var o=e.Utils.Exception;var s=function(){function s(s){var u=s.ms_graph_uri;var c=s.azure_graph_uri;var d=s.graph_oauth_uri;var l=s.get_oauth_token;var f=s.client_id;var p=s.redirect_uri;var v=s.tm;var h=s.xframector;var m=s.xframe_uri_for_graph;var g=s.location;var y=s.document;var S=s.hostProperty;var b=new n(d);b.query.set("response_type","token");b.query.set("client_id",f);b.query.set("prompt","none");var w;var E;var T={};function I(e,t,i,s){if(s===void 0){s={}}if(!e)throw o("NoGraphUri");if(!d)throw o("NoGraphOAuthUri");var u=new n(e);u.path(u.path()+i);for(var c in s)u.query.set(c,s[c]);function l(e){return r.run(function(){if(!w){w=new h(void 0,v,undefined,S);return w.src.set(m)}}).then(function(){return w.send({type:t,headers:{Authorization:a(e)?e:void 0},url:u+""})})}var f=new n(e).path("").query("").hash("")+"";return l(T[f]).then(function(e){if(e.status==401){delete T[f];return M(f).then(function(e){T[f]=e;return l(e)})}else return e})}function M(t){b.query.set("resource",t)
;b.query.set("redirect_uri",p||e.Auth.OAuth.baseurl(w.src()));if(l)return l(t);else if(p)return e.Auth.OAuth.getToken(b,g,y);else{return w.src.set(b+"").then(function(){return w.send({type:"GET",url:"/ucwa/oauth",headers:{Authorization:"Bearer","X-Ms-SDK-Host":S}})}).then(function(){return void 0})}}function C(){return r.run(function(){return E||I(c,"GET","/me").then(function(e){if(!i.isSuccess(e.status))throw t.ERequestFailed({url:"/me"},e);E=JSON.parse(e.responseText).sipProxyAddress;return E})}).catch(function(t){v&&v.record(e.TelemetryEvent.GraphFetchSip,{result:"failed",reason:t});throw t})}function A(n){return r.run(function(){return I(u,"GET","/me/people",{$top:n,$select:"displayName,scoredEmailAddresses,personType"}).then(function(e){if(!i.isSuccess(e.status))throw t.ERequestFailed({url:"/me/people"},e);return JSON.parse(e.responseText).value})}).catch(function(t){v&&v.record(e.TelemetryEvent.GraphFetchPeople,{result:"failed",reason:t});throw t})}function _(){w&&w.reset()}return{getSipProxyAddress:C,getTopNContacts:A,reset:_}}return s}();t.Graph=s})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){t.logHttp=e.ls.logs.get();t.logMode=/\blm=ut\b/.test(e.window.location&&e.window.location.hash)?"ut":null;t.logPrefix=e.ls.pref.get()===undefined?true:!!e.ls.pref.get()})(t=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){var n=e.version;var i=e.Utils.all;var a=e.Utils.hash;var o=e.Utils.async;var s=e.Utils.clone;var u=e.Utils.debug;var c=e.Utils.assert;var d=e.Utils.extend;var l=e.Utils.random;var f=e.Utils.batched;var p=e.Utils.isObject;var v=e.Utils.isString;var h=e.Utils.getOption;var m=e.Utils.isFunction;var g=e.Utils.URI;var y=e.Utils.Task;var S=e.Utils.Event;var b=e.Utils.Symbol;var w=e.Utils.XmlDoc;var E=e.Utils.Property;var T=e.Utils.SyncLock;var I=e.Utils.Exception;var M=e.Utils.BoolProperty;var C=e.Utils.SourcedProperty;var A=b("GET");function _(e,t,n){var r=h(e,t,n);return r<=n?r:n}var R=function(){function r(n){if(n===void 0){n={}}this.eEvent=new S;this.eRestored=new S;this.pConnected=M(false);this.pECStatus=E();this.event=this.eEvent.observer;this.restored=this.eRestored.observer;this.connected=this.pConnected.asReadOnly();this.ecstatus=this.pECStatus.asReadOnly();this.suspended=C();this.nReq=0;this.tInit=new y;this.pAppDeleted=M(false);this.appDeleted=this.pAppDeleted.asReadOnly();this.tm=n.tm;if(e.Settings.logMode=="ut"||n.logs){this.logs=d([],{size:0,maxsize:e.Settings.logMode=="ut"?Infinity:n.logs.size||Math.pow(2,20)})}if(e.Settings.logHttp)t.initConsoleFormatters()}Object.defineProperty(r.prototype,"fqdn",{get:function(){var e=this._repository.get("applications")[0].href;return new g(e).host()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"app",{get:function(){return this.get("application")},enumerable:true,configurable:true});r.prototype.init=function(e){if(e){if(this.tInit.state()!="pending")this.tInit=new y;c(!this.pInit);this.connect(e)}return this.tInit.promise};r.prototype.uninit=function(t){try{if(this.pInit)this.pInit.cancel(t);if(this._xframe)this._xframe.reset();this.pInit=null;this.tInit=new y;this._xframe=null;this._repository=null;this._application=null;this._uninit_reason=t}catch(t){this.tm&&this.tm.record(e.TelemetryEvent.UcwaUninitException,{reason:t});throw t}};r.prototype.removeEventChannel=function(){try{this._application.removeEventChannel()}catch(t){this.tm&&this.tm.record(e.TelemetryEvent.UcwaUninitException,{reason:t});throw t}};r.prototype.deleteApp=function(e){var t=this;return this._application.remove().then(function(){t.pAppDeleted(true,e);try{t.ssItem.remove()}catch(e){}})};r.prototype.deleteAppTemp=function(){return this._application.remove()};r.prototype.send=function(t,n,r){var i=this;var a=v(n)?n:this.get(n).href;var o=++this.nReq;var u=d(s(r||{}),{type:t,url:a});var c=e.Settings.logHttp&&g.mergeQuery(a,u.query);if(e.Settings.logMode=="ut"){this.logRequest("req["+o+'] = ucwa.request("'+t+" "+c+'");');if(u.data){var l=JSON.stringify(u.data,null,4);this.logRequest("assert.equal(req["+o+"].data, "+l+");")}}else{var f=[];f.push(c);if(r&&r.query)f.push(r.query);if(u.data)f.push(JSON.stringify(u.data));this.logRequest.apply(this,["%c -> "+o+" "+t,"color:blue;font-weight:bold"].concat(f))}if(!this._application)throw I("AppUninitialized");var p=this._application.ajax(u);p.then(function(n){if(e.Settings.logMode=="ut"){i.logRequest("//",t,c);i.logRequest("req["+o+"].resolve("+(n.href?n+"":"")+");")}else{var r=[];r.push(c);if(n.href){var a=JSON.parse(n+"");delete a.userName;delete a.password;r.push(a)}i.logRequest.apply(i,["%c <- "+o+" "+t,"color:green;font-weight:bold"].concat(r))}},function(n){var r=n&&n.rsp||{};if(e.Settings.logMode=="ut"){var a=JSON.stringify(r,null,4);i.logRequest("req["+o+"].reject("+a+");")}else{i.logRequest("%c <- "+o+" "+t,"color:red;font-weight:bold",c,r.status,r.statusText);i.logRequest(n)}i.tm&&i.tm.record(e.TelemetryEvent.RequestFailed,{req:u,reason:n})});return p};r.prototype.get=function(e,t){var n=this.find(e);if(!n||n.length<1){if(t===null)return null;throw I("ResourceNotFound",{selector:e})}if(n.length>1)throw I("AmbiguousResource",{selector:e});return n[0]};r.prototype.find=function(e){if(!this._repository)throw I("Disconnected",{reason:this._uninit_reason});return m(e)?this._repository.find(e):this._repository.get(v(e)?e:e.rel)};r.prototype.exists=function(e){return this.find(e).length>0};r.prototype.getSnapshot=function(e){var t=this._repository.getSnapshot(e);var n=new g(t.applications[0]._links.self.href).path("/xframe").query("").hash("").toString();t.xframe=[{_links:{self:{href:n}}}];return t};r.prototype.getRevisionOf=function(e){var t=this;var n=e.link("self");return y.run(function(){return+n.revision||e[A]||(e[A]=t.send("GET",e.href))}).then(function(){return+n.revision||1})};r.prototype.wait=function(e){var t=this;var n=e.resource;var r=e.target;var a=e.type;var o=e.status;var s=e.sender;function u(e){var t=e.resource;var u=e.target;var c=e.type;var d=e.status;var l=e.sender;return!(c!=a||o&&o!=d||u.rel!=r.rel||r.href&&u.href!=r.href||m(n)&&!n(t)||p(n)&&!i(n,function(e,n){return t.has(n)&&t.get(n)==e})||m(s)&&!s(l)||s&&s.rel&&l.rel!=s.rel||s&&s.href&&l.href!=s.href)}var c=new y(r.rel+" "+a,{mode:"sync",cancel:function(e){t.event.off(d);c.reject(e)}});function d(e){if(u(e)){t.event.off(d);c.resolve(e)}}t.event(d);return c.promise};r.prototype.observe=function(e,t){var n=/^(\w+) (\w+)$/.exec(e),r=n[1],i=n[2];return this.event(function(e){if(e.type==i&&e.target.rel==r)t(e)})};r.prototype.connect=function(r){var i=this;var s=r.events;var u=r.auth;var d=r.id;var p=a(JSON.stringify(r,function(e,t){return/^(window|document|location)$/.test(e)?undefined:t}));var S=r.client_id;var b=r.redirect_uri;var E=r.oauth_uri;var M=r.state;var C=r.use_cwt;var A=r.cwt_format;var R=r.username;var P=r.password;var k=r.token;var O="https://graph.microsoft.com/v1.0";var x=r.azure_graph_uri||"https://graph.windows.net?api-version=1.6";var D=r.graph_oauth_uri||"https://login.microsoftonline.com/common/oauth2/authorize";var U=r.xframe_uri_for_graph||"https://webdir.online.lync.com/xframe";var N=r.name;var L=r.domain;var V=r.origins;var W=r.meeting;var B=r.conf_key;var j=r.join_url;var F=r.join_url_mode;var G=r.xmscwt;var H=r.root;var q=r.snapshot;var z=new RegExp(r.ssrels||"root|xframe|applications?");var Y=r.culture||"en-us";var X="SkypeWeb/"+n+(r.version?" "+r.version:"");var J=r.supportsWebRtc;var K=h(r,"throttle",5);var Q=!!r.enableInternalNS;var $=r.cors;var Z=r.XFrame||($?t.XHR:t.XFrame);var ee=r.window;var te=r.document;var ne=r.location;var re=h(r,"batchRetryDelay",5);var ie=_(r,"maxBatchSize",20);var ae=!W&&!j&&!!d&&q!==null;var oe=l();var se=new T("CreateApp");var ue=r.user;var ce=r.retry;var de=r.ecws;var le=r.appType;var fe=le=="Desktop"?false:r.withCreds;var pe=!!N&&$&&!!H&&!!k;var ve=!u&&r.get_oauth_token&&m(r.get_oauth_token)&&o(r.get_oauth_token);var he=r.hostProperty;var me=r.soac;var ge=r.dwiid;var ye=r.eopd;var Se=r.oauth_cb;var be=r.oauth_cb_t;var we=r.imdn;this.ssItem=new t.StorageItem(["Snapshot",p]);this.pAppDeleted(false);var Ee=r.delay000||function(){return function(){return $?100:3}};var Te=r.delay502||function(){var e=30;var t=15*60;var n=0;return function(){if(e*n++>t)throw I("MaxRetryDelayReached");else return e}};var Ie=r.delay404||function(){var e=1;return function(){if(e>3600)throw I("MaxRetryDelayReached");else return e*=2}};var Me=r.delay503||function(){var e=1;return function(){if(e>600)throw I("MaxRetryDelayReached");else return e*=1.5}};if($){if(C===void 0)C=false;if(b===void 0)b="/"+S+"/oauth2/token"}if(v(V)){if(!L)throw new Error("`domain` is required when `origins` is an env name");V=t.AutoD[V](L);L=null}try{if(ae&&!q)q=this.ssItem.json}catch(e){}var Ce=function(n){var a=new Z(void 0,i.tm,fe,he);var o=new t.OAuthTokenIssuer(a,{cors:$,tm:i.tm,xframector:Z,window:ee,document:te,location:ne,get_oauth_token:ve,oauth_cb:Se,oauth_cb_timeout:be,hostProperty:he});function l(e,t){if(!$){var n=new g(e);n.path("/autodiscover/xframe/xframe.html").query("").hash("");a.src(n+"")}return a.send({type:"GET",url:e,headers:{Accept:"Application/vnd.microsoft.lync.meeting+"+(t?"json":"xml")+";ver=14"}}).then(function(n){var r=t?JSON.parse(n.responseText):w(n.responseText).root;var i=function(e){return t?r[e.replace(/-/g,"")]:r.selectOne(e).text()};var a=t&&i("redirect");if(a)return l(a,t);W=i("conf-uri").trim();B=i("conf-key").trim();var o;try{o=i("ucwa-public-url").trim()}catch(e){o=i("ucwa-url");if(!G&&o.indexOf("/ucwa/oauth/")<0)o=o.replace("/ucwa/","/ucwa/oauth/")}q={applications:o,"ms:rtc:saas:discover":{conferenceId:W,conferenceKey:B,_links:{self:{href:e}}}}})}var p=function(){if(q){q=t.Repository.expandSnapshot(q);if(!q.xframe){var l=(q.applications||q.user)[0]._links.self.href;q.xframe=[{_links:{self:{href:""+new g(l).path("/xframe").query("")}}}]}}if(v(n)){if(n.indexOf("://")<0)n="https://"+n+"/Autodiscover/AutodiscoverService.svc/root";n={origin:n}}if(n&&!n.xframe)n.xframe=new g(n.origin).path("/xframe").query("").hash("")+"";var p;if(q){i.tm&&i.tm.record(e.TelemetryEvent.SigninUseSnapshot);a.src(q.xframe[0]._links.self.href)}else if(!H){if(!L){L=R?R.match(/@(.+?)$/)[1]:W?W.match(/@(.+?);/)[1]:null;if(!L&&!n)throw I("NoFQDN")}p=t.AutoDiscovery({XFrame:Z,xframe:a,domain:L,hostProperty:he,origins:n&&[n]}).root}else{c(H.user,"root.user URL is missing");H.xframe=H.xframe||new g(H.user).path("/xframe").query("")+"";a.src(H.xframe);p=new t.Resource("//root","root").addLink("user",H.user).addLink("xframe",H.xframe).set("internal",!!H.internal)}var h;if(m(u)){h=u.bind(a)}else if(k){h=e.Auth.Token(k,pe&&H.user)}else if(P){h=e.Auth.Basic(R,P)}else if(W){h=G?e.Auth.AnonMeetingInternal(W,B):e.Auth.AnonMeeting(W,B)}else if(S){h=e.Auth.OAuth({xframe:a,client_id:S,oauth_uri:E,state:M,use_cwt:C,cwt_format:A,tm:i.tm,redirect_uri:Se||b,hostProperty:he})}else if(u=="passive"||C){h=e.Auth.ADFS()}else{h=e.Auth.Integrated()}var y=o.send.bind(o);var w=new t.Transport({send:y},{fmax:!e.isUnitTested&&3,tm:i.tm,buffer:K,retry:ce,version:X,session:oe,hostProperty:he,delay:{0:Ee,503:Me,502:Te,404:Ie}});var T=new t.Endpoint({tm:i.tm,batchRetryDelay:re,transport:w,auth:h,enableInternalNS:Q,user:ue,anon:!!N||!!W,replace:function(){return F.replace()},restore:function(){return F.restore().then(function(){i.eRestored.fire()})}});var _=s===false?null:new t.EventChannel(T,T.suspended,i.tm);if(s&&typeof s==="object")_.timeout=s.timeout;r=null;var V=new t.Repository({snapshot:q,connection:_});var F=new t.Application({tm:i.tm,maxBatchSize:ie,xframe:a,endpoint:T,repository:V,connection:_,imdn:we,root:p,name:j?undefined:N,anon:!!N||!!W,id:d,ecws:de,culture:Y,version:X,supportsWebRtc:J,lock:se,appType:le,cors:$,soac:me,dwiid:ge});return F.ready.then(function(){_&&_.event(function(t){var n=t["in"];var r=t.target.rel+" "+t.type+(n?" in "+n.rel:"");if(e.Settings.logMode=="ut"){i.logEvent("// "+r);i.logEvent("ucwa.fire("+(t+"")+");")}else{if(e.Settings.customFmt)i.logEvent(JSON.parse(t+""));else i.logEvent("%c "+r,"color:magenta;font-weight:bold",JSON.parse(t+""))}i.eEvent.fire(t)});if(_){_.connected.changed(i.pConnected);_.status.changed(i.pECStatus)}if(ae){var r=f(function(){try{var e=i.getSnapshot(function(e){return z.test(e)});if(!i.pAppDeleted())i.ssItem.json=e}catch(e){}});V.updated(r)}i.suspended.setSource(T.suspended);i._xframe=a;i._repository=V;i._application=F;i._application.invalid.once(true,function(e){i.deleteApp(e)});i.graph=new t.Graph({client_id:S,get_oauth_token:ve,ms_graph_uri:n&&n.graph_uri||O,azure_graph_uri:n&&n.azure_graph_uri||x,graph_oauth_uri:n&&n.graph_oauth_uri||D,redirect_uri:b,tm:i.tm,xframector:Z,xframe_uri_for_graph:U,location:ne,document:te,hostProperty:he})})};return y.run(function(){if(j)return l(j,F=="json")}).then(p).catch(function(e){a.reset();o.reset();throw e})};var Ae=function(e){if(!ye||q||H)return;if(v(e))e={origin:e};if(e&&!e.xframe)e.xframe=new g(e.origin).path("/xframe").query("").hash("")+"";var n=new t.Graph({client_id:S,get_oauth_token:ve,ms_graph_uri:e&&e.graph_uri||O,azure_graph_uri:e&&e.azure_graph_uri||x,graph_oauth_uri:e&&e.graph_oauth_uri||D,redirect_uri:b,tm:i.tm,xframector:Z,xframe_uri_for_graph:e&&e.xframe||U,location:ne,document:te,hostProperty:he});var r=n.getSipProxyAddress();r.finally(function(){return n.reset()});var a=[];var o=function(e){a.push(r.then(function(t){return Ce(e+t.split("@")[1])}))};for(var s=0,u=["https://lyncdiscover.","https://lyncdiscoverinternal."];s<u.length;s++){var c=u[s];o(c)}return a};var _e=function(e){var t=[];for(var n=0,r=q||!e?[null]:e;n<r.length;n++){var i=r[n];t.push.apply(t,Ae(i));t.push(Ce(i))}return t};this.pInit=y.waitAny(_e(V)).catch(function(e){if(q&&(t.Endpoint.is410Error(e)||V&&e&&e.code=="RequestFailed"&&e.req.headers&&e.req.headers["X-Ms-Get-App"]&&/^(404|502)$/.test(e.rsp.status))){q=null;return y.waitAny(_e(V))}throw e}).finally(function(){i.pInit=null});this.pInit.then(function(e){return i.tInit.resolve(e)},function(e){return i.tInit.reject(e)},this.tInit.status)};r.prototype.logEvent=function(){var t=[];for(var n=0;n<arguments.length;n++){t[n]=arguments[n]}if(e.Settings.logPrefix)u.log.apply(u,[e.Settings.logHttp,"[EVENT] "].concat(t));else u.log.apply(u,[e.Settings.logHttp].concat(t))};r.prototype.logRequest=function(){var t=[];for(var n=0;n<arguments.length;n++){t[n]=arguments[n]}if(e.Settings.logPrefix)u.log.apply(u,[e.Settings.logHttp,"[REQUEST] "].concat(t));else u.log.apply(u,[e.Settings.logHttp].concat(t))};return r}();r([o],R.prototype,"init",null);r([o],R.prototype,"send",null);t.UCWA=R})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){t.customFmt=e.ls.cfmt.get()===undefined?true:e.ls.cfmt.get()})(t=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){var n=function(e){return e&&e.rel&&e._links};var r=function(e){return e&&e.type&&e.sender&&e.target};function i(e){var t={};for(var n in e)if(!/^(rel|_links|_embedded)$/.test(n))t[n]=e[n];var r=[];for(var n in t){var i=t[n];r.push(["span",{},n]);r.push(["span",{},": "]);if(i===null||i===undefined)r.push(["span",{style:"color:lightgray"},i]);else r.push(["span",{},["object",{object:i}]]);r.push(["span",{},", "])}r.pop();return r}var a=false;function o(){if(a)return;a=true;var t=e.window["devtoolsFormatters"]=e.window["devtoolsFormatters"]||[];t.push({header:function(t){if(!e.Settings.customFmt||!n(t))return;var r=i(t);return["div",{style:"font-style:italic"},["span",{style:"font-weight:bold"},t.rel],["span",{}," {"]].concat(r,[["span",{},"}"]])},hasBody:function(e){return n(e)},body:function(e){return["span",{},JSON.stringify(e,null,2)]}});t.push({header:function(t){if(!e.Settings.customFmt||!r(t))return;var n=t["in"];var a=t.target.rel+" "+t.type+(n?" in "+n.rel:"");var o=i(t.resource||{});return["div",{style:"font-style:italic"},["span",{style:"font-weight:bold;color:magenta"},a],["span",{}," {"]].concat(o,[["span",{},"}"]])},hasBody:function(e){return r(e)},body:function(e){return["span",{},JSON.stringify(e,null,2)]}})}t.initConsoleFormatters=o})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){"use strict";e.Internal=e})(t=e.Stack||(e.Stack={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){e.logModel=false;e.mediaAgent=null})(t=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.debug;var r=e.Utils.extend;var i=e.Utils.Exception;var a=e.Utils.Symbol;function o(e,t){if(t===void 0){t={}}var n=e&&e.message;return i.call(n,"InvitationFailed",r({reason:e},t))}t.EInvitationFailed=o;var s;(function(e){var t;(function(e){e.Disconnected="Disconnected";e.Disconnecting="Disconnecting";e.Connecting="Connecting";e.Ringing="Ringing";e.Connected="Connected";e.Notified="Notified";e.Created="Created"})(t=e.State||(e.State={}))})(s=t.Modality||(t.Modality={}));t.sHref=a("href");t.sInternal=a("internal");function u(){var t=[];for(var r=0;r<arguments.length;r++){t[r]=arguments[r]}n.log.apply(n,[e.Settings.logModel,"[MODEL] "].concat(t))}t.log=u;function c(t,r){n.watch(e.Settings.logModel,"[MODEL] "+t,r)}t.watch=c})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.singleton;var r=e.Utils.Enum;t.UserAgent=n(function(){var t=r("Unknown","Windows","Mac","Linux","Mobile"),n=r("Unknown","Win32","Wow64","Win64"),i=r("IE","Other");var a=i.Other,o=n.Unknown,s=t.Unknown;var u=false;function c(){if(u)return;var r=e.window.navigator.userAgent.toLowerCase();var c=e.window.navigator.platform?e.window.navigator.platform.toLowerCase():"";if(r.match(/msie \d+\.\d+/)){a=i.IE}else if(r.match(/trident\/\d+\.\d+/)&&r.match(/\brv:\d+\.\d+/)){a=i.IE}if(r.match(/wow64/))o=n.Wow64;else if(c.match(/win64/)||r.match(/win64/))o=n.Win64;else if(c.match(/win32/))o=n.Win32;if(r.match(/mobi/))s=t.Mobile;else if(r.match(/windows nt/)||o!=n.Unknown)s=t.Windows;else if(c.match(/mac/)||r.match(/macintosh/))s=t.Mac;else if(c.match(/linux/)||r.match(/linux/))s=t.Linux;u=true}function d(){c();return a==i.IE}function l(){return d()&&document.documentMode}function f(){c();return s==t.Windows}function p(){c();return s==t.Mac}function v(){c();return o==n.Win64}function h(){c();return o==n.Win32||o==n.Wow64}function m(){a=i.Other;o=n.Unknown;s=t.Unknown;u=false}c();return{isIE:d,isSupportedIE:l,isWindows:f,isMac:p,is64bit:v,is32bit:h,reset:m}})})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.isVoid;var i=e.Utils.Event;var a=e.Utils.Property;var o=e.Utils.Exception;var s=e.Utils.StringEnum;function u(e){var t=[];for(var n=1;n<arguments.length;n++){t[n-1]=arguments[n]}if(arguments.length==0)throw new Error("Invalid arguments");return e.replace(/{(\d+)}/g,function(e,n){return n in t?t[n]:e})}t.formatString=u;function c(s){var d=a({value:c.State.None}),l=(s&&s.id||"_plugin")+"_"+c.nextCount(),f=s&&s.managerId?s.managerId:"_",p=new i,v,h,m=false,g=false,y;function S(){return d()==c.State.Attached?h:null}function b(){return f=="_"}function w(e){t.log("PluginObject::createInnerObject "+l);n(e);n(!r(e.hide));n(!r(e.hookEvents));n(d()==c.State.None,"invalid state");var i=P({id:l,managerId:f,logLevel:t.UserAgent().isIE()?1:0});v=e.hide?k(i):O(i);t.log("PluginObject::createInnerObject "+l+" "+v);d.set(c.State.Created);if(e.hide){I(document.body,e.hookEvents)}}function E(){t.log("PluginObject::destroyInnerObject "+l);T();d.set(c.State.Destroyed)}function T(){t.log("PluginObject::cleanup "+l);try{if(v)v.parentNode.removeChild(v)}catch(e){t.log(e.message)}v=null;h=null;m=false;g=false}function I(e,i){t.log("PluginObject::attach "+l);n(d()==c.State.Created);n(!r(i));try{e.appendChild(v);h=v.firstChild;if(r(h))throw new Error("object missing")}catch(e){T();d.set(c.State.AttachFailed);return}g=i;if(b()){m=true;M()}}function M(){t.log("PluginObject::validateAndAttachEvents "+l);if(!h||!m)return;try{if(!h.CheckExistence()){T();d.set(c.State.ExistenceCheckFailed);return}}catch(e){T();d.set(c.State.NotInstalled,e);return}if(g){try{h.OnEvent=_;h.OnPing=R}catch(e){T();d.set(c.State.AttachFailed,e);return}}d.set(c.State.Attached)}function C(){t.log("PluginObject::onObjectLoaded "+l);if(!b()){m=true;e.window.setTimeout(M,0)}}function A(){t.log("PluginObject::onObjectUnloaded "+l);if(!b()){m=false;E()}}function _(e,t){p.fire(e,t)}function R(){try{h.PingResponse();p.fire("__FxPing","")}catch(e){E();return false}return true}function P(e){n(e);var r;if(!t.PluginManager().isPluginInstalled()){d.set(c.State.NotInstalled);throw o("PluginNotInstalled")}if(t.UserAgent().isIE()){n(t.UserAgent().isWindows());r=c.IE_HTML_TEMPLATE}else{n(t.UserAgent().isWindows()||t.UserAgent().isMac());r=c.FF_HTML_TEMPLATE}return u(r,e.id,t.PluginManager().installedPlugin().MIME_TYPE,e.managerId,e.logLevel,true,true)}function k(e){var t=document.createElement("div");t.style.position="absolute";t.style.width="1px";t.style.height="1px";t.style.left="-100px";t.style.top="0px";t.style.overflow="hidden";t.style.visibility="hidden";t.innerHTML=e;return t}function O(e){var t=document.createElement("div");t.style.width="100%";t.style.height="100%";t.innerHTML=e;return t}y={id:function(){return l},state:d.asReadOnly(),innerObject:S,createInnerObject:w,destroyInnerObject:E,attach:I,event:p.observer,onObjectLoaded:C,onObjectUnloaded:A};return y}t.PluginObject=c;(function(e){e.nextCount=function(){var e=0;return function(){return e++}}();e.State=s("None","ConfigNotSupported","NotInstalled","CreateFailed","ExistenceCheckFailed","AttachFailed","Created","Attached","Destroyed");e.IE_HTML_TEMPLATE='<object id="{0}" type="{1}" width="100%" height="100%"><param name="managerID" value="{2}" /><param name="componentID" value="{0}" /><param name="logLevel" value="{3}" /><param name="structuredArguments" value="{4}" /><param name="windowless" value="{5}" /></object>';e.FF_HTML_TEMPLATE='<embed id="{0}" type="{1}" width="100%" height="100%" managerID="{2}" componentID="{0}" logLevel="{3}" structuredArguments="{4}" windowless="{5}"></embed>'})(c=t.PluginObject||(t.PluginObject={}))})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.check;var r=e.Utils.assert;var i=e.Utils.isVoid;var a=e.Utils.isNumber;var o=e.Utils.isNotEmptyString;var s=e.Utils.Enum;var u=e.Utils.Task;var c=e.Utils.Event;var d=e.Utils.Property;var l=e.Utils.Exception;t.PluginLoadResult=s("LoadSuccessful","NoInstanceManager","ComponentNotFound","ComponentLoadFailed","ComponentInitFailed","ComponentLoadCancelled");function f(e){var t,n="0x",r=e[0];for(t=7;t>=0;t--)n+=(r>>t*4&15).toString(16);e.hresultstr=n;e.succeeded=e[0]>=0;e.failed=e[0]<0;e.hresult=e[0];return e}t.PluginMethodResult=f;function p(s){r(s.type=="MediaPlatformConfig"||s.type=="AVComponent"||s.type=="VideoUI"||s.type=="TuningWizard"||s.type=="AppShareCore"||s.type=="AppShareViewerUI");var v=d({value:p.State.Unloaded}),h=new c,m,g,y,S,b=[],w,E=false;m=s.pluginManager;y=s.tm;g=t.PluginObject({id:"_"+s.type,managerId:m.id()});g.event(R,"async");g.state.changed(P);function T(){return g&&g.id()||""}function I(){t.log("PluginComponent::load "+T());r(v()==p.State.Unloaded,"invalid component state");r(m.state()==t.PluginManager.State.Initialized);r(!w||w.state()!="pending");v.set(p.State.Loading);w=new u("Loading "+s.type+".",{cancel:function(e){t.log("PluginComponent::load canceled "+T());E=true;M();w.reject(e)}});b=[].slice.call(arguments,0);try{g.createInnerObject({hide:s.hide,hookEvents:true})}catch(t){y&&y.record(e.TelemetryEvent.PluginComponent,{action:"loadPluginComponent",id:T(),state:v(),result:"failed",reason:t});if(w.state()=="pending")w.reject(t)}return w.promise}function M(){t.log("PluginComponent::unload "+T());if(v()==p.State.Loading||v()==p.State.Loaded){v.set(p.State.Unloading);try{g.innerObject().UnLoad()}catch(e){O(e);v.set(p.State.Unloaded)}}}function C(){t.log("PluginComponent::onLoaded "+T());r(g);g.onObjectLoaded()}function A(){t.log("PluginComponent::onUnloaded "+T());r(g);g.onObjectUnloaded()}function _(e){n(!s.hide,"setContainer called for a hidden component");n(v()!=p.State.Loaded,"setContainer called after component is already loaded");S=e;if(v()==p.State.Loading&&g.state()==t.PluginObject.State.Created)g.attach(S,true)}function R(e,n){var i;t.log("%c"+T()+" "+e,"color:blue",n);switch(e){case"__FxLoadComplete":r(n.length==1);i=n[0];r(a(i));if(i==t.PluginLoadResult.LoadSuccessful&&v()==p.State.Loading){if(!E)w.resolve();v.set(p.State.Loaded);D(1|2)}else{O(i);if(!E)w.reject(i);v.set(p.State.Unloaded)}break;case"__FxUnLoadComplete":r(n.length==0);O();v.set(p.State.Unloaded);break;default:h.fire({type:e,args:n});break}}function P(n){t.log("PluginComponent::onPluginObjectState "+T()+" "+n);y&&y.record(e.TelemetryEvent.PluginComponent,{action:"onPluginObjectState",id:T(),reason:n});switch(n){case t.PluginObject.State.None:break;case t.PluginObject.State.Created:if(!s.hide&&!i(S))g.attach(S,true);break;case t.PluginObject.State.Attached:e.window.setTimeout(k,0);break;case t.PluginObject.State.Destroyed:v.set(p.State.Unloaded);break;default:O(n);v.set(p.State.Unloaded)}}function k(){t.log("PluginComponent::loadComponent "+T());r(v()==p.State.Loading);r(g.state()==t.PluginObject.State.Attached);try{g.innerObject().Load(s.type,b)}catch(e){O(e);v.set(p.State.Unloaded)}}function O(n){t.log("PluginComponent::cleanupPluginObject "+T());y&&y.record(e.TelemetryEvent.PluginComponent,{action:"cleanupPluginObjectInComponent",id:T(),state:v(),reason:n});if(g){g.event.off(R);g.state.changed.off(P);g.destroyInnerObject();g=null}}function x(n){r(g);r(o(n));r(v()==p.State.Loaded);var i=[].slice.call(arguments,1),a,s;t.log("PluginComponent::invoke %c"+n,"color:red",i,T());y&&y.record(e.TelemetryEvent.PluginComponent,{action:n,args:i&&i.join(),id:T(),state:v(),result:"started"});try{a=g.innerObject().ProcessMethod(n,i);s=f(a)}catch(r){t.log(T()+" error executing "+n+" "+r.message);y&&y.record(e.TelemetryEvent.PluginComponent,{action:n,state:v(),result:"failed",reason:r});throw l("PCInvoke",{method:n,args:i&&i.join()})}if(s&&s.failed){y&&y.record(e.TelemetryEvent.PluginComponent,{action:n,state:v(),result:"ret.failed",reason:s.hresultstr});throw l.call(n+":"+s.hresultstr,"PCInvoke",{method:n,args:i&&i.join()})}else{y&&y.record(e.TelemetryEvent.PluginComponent,{action:n,state:v(),result:"succeeded",reason:s&&s.hresultstr})}return s}function D(e){n(e>0&&e<=7,"Invalid level");if(g)try{g.innerObject().SetLogLevel(e)}catch(n){t.log("SetLogLevel("+e+") failed: ",n)}}return{id:T,state:v.asReadOnly(),load:I,unload:M,onLoaded:C,onUnloaded:A,event:h.observer,setContainer:_,setLogLevel:D,invoke:x}}t.PluginComponent=p;(function(e){e.State=s("Unloaded","Unloading","Loading","Loaded");e.UnloadReason=s("None","CreateFailed","LoadFailed","UserInitiated","PluginInitiated","PluginClosedUnexpectedly")})(p=t.PluginComponent||(t.PluginComponent={}))})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.isString;var i=e.Utils.isNumber;var a=e.Utils.isBoolean;function o(e,t,o){var s=0,u=0,c=false;if(arguments.length==1){if(r(arguments[0]))f(arguments[0]);else if(i(arguments[0]))v(arguments[0]);else throw new Error("invalid argument")}else if(arguments.length>=2){n(i(arguments[0]));n(i(arguments[1]));n(!arguments[2]||a(arguments[2]));s=arguments[0];u=arguments[1];c=arguments[2]||false}function d(){s=0;u=0;c=false}function l(){return s+","+u+","+c}function f(e){n(r(e));var t=e.split(",");if(t.length<2)throw new Error("invalid argument format");d();s=parseInt(t[0]);u=parseInt(t[1]);c=p(t[2])}function p(e){var t=false;if(e===undefined)return false;n(r(e));switch(e){case"true":t=true;break;case"false":t=false;break;default:throw new Error("invalid argument format")}return t}function v(e){n(i(e));if(e>2147483648||e<=-2147483648){throw new RangeError("out of range")}s=0;c=false;if(e<0){e=-e;c=true}u=e&4294967295}return{toString:l,fromString:f,empty:d}}t.BigInt=o})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.async;var i=e.Utils.assert;var a=e.Utils.extend;var o=e.Utils.isNumber;var s=e.Utils.isString;var u=e.Utils.isBoolean;var c=e.Utils.singleton;var d=e.Utils.StringEnum;var l=e.Utils.Task;var f=e.Utils.Property;var p=e.Utils.Exception;var v=e.Utils.Collection;t.PluginManager=c(function(){var c={},d=null,h=f({value:t.PluginManager.State.Uninitialized}),m,g,y,S=0,b=5e3,w=0,E=6e3,T;var I=f();var M=f({get:Y});var C=v({get:K});var A=f({get:function(){return _().then(J)}});t.watch("PluginManager::state",h);function _(r){y&&y.record(e.TelemetryEvent.PluginManager,{action:"init",state:h()});if(h()==t.PluginManager.State.Uninitialized){var a="__mainPluginManager_"+n().replace(/-/g,"_");t.log("PluginManager::init - id = "+a);m=r&&r.language||"en-us";g=r&&r.rtl||false;var o=r&&r.PluginObject||t.PluginObject;y=r&&r.tm;i(!T||T.state()!="pending");T=new l("Loading the media plugin.",{cancel:function(e){t.log("PluginManager::init canceled "+a);B();P(e);T.reject(e)}});y&&y.monitor(T.promise,e.TelemetryEvent.PluginManager,{action:"initPluginMgr",state:h(),id:a});h.set(t.PluginManager.State.Initializing);M.get().then(function(e){if(!e)throw p("PluginNotInstalled");d=o({id:a,managerId:"_"});d.event(U,"async");d.state.changed(N);t.watch("pluginObject("+a+")::state",h);t.log("PluginManager::init - creating inner object");try{d.createInnerObject({hide:true,hookEvents:true})}catch(e){h.set(t.PluginManager.State.Uninitialized);if(T.state()=="pending")T.reject(e)}}).catch(function(e){h.set(t.PluginManager.State.Uninitialized);if(T.state()=="pending")T.reject(e)})}else{i(T)}return T.promise}function R(){t.log("PluginManager::uninit");i(!T||T.state()!="pending");T=new l("Unloading the media plugin.");try{y&&y.monitor(T.promise,e.TelemetryEvent.PluginManager,{action:"uninit",state:h(),id:n});for(var n in c)c[n].unload();if(d){h.set(t.PluginManager.State.Uninitializing);d.innerObject().UnLoad()}P();T.resolve()}catch(e){P(e);T.reject(e)}B();G();return T.promise}function P(e){X();k(e);h.set(t.PluginManager.State.Uninitialized)}function k(n){t.log("PluginManager::cleanupPluginObject",n||"");if(!d)return;y&&y.record(e.TelemetryEvent.PluginManager,{action:"cleanupPluginObject",reason:n});d.event.off(U);d.state.changed.off(N);d.destroyInnerObject();d=null}function O(e){E=e}function x(){i(d);return d.id()}function D(n){i(n);i(s(n.type));i(u(n.hide));i(h()==t.PluginManager.State.Initialized);t.log("PluginManager::createComponent "+n.type);y&&y.record(e.TelemetryEvent.PluginManager,{action:"createComponent",specs:JSON.stringify(n)});a(n,{pluginManager:t.PluginManager(),tm:y});var r=t.PluginComponent(n);var o=r.id();var d=function(e){t.log("PluginManager::onComponentState "+e);if(e==t.PluginComponent.State.Unloaded){if(c[o]){c[o].state.changed.off(d);delete c[o]}}else if(e==t.PluginComponent.State.Loaded){}};r.state.changed(d);c[o]=r;return r}function U(n,r){var a;switch(n){case"__FxLoadComplete":i(r.length==1);a=r[0];i(o(a));t.log("PluginManager::onPluginObjectEvent "+n+" "+a);B();if(a==t.PluginLoadResult.LoadSuccessful&&h()==t.PluginManager.State.Initializing){y&&y.record(e.TelemetryEvent.PluginManager,{action:"pluginObjectLoadSuccessful"})
;h.set(t.PluginManager.State.Initialized);F();J();T.resolve()}else{y&&y.record(e.TelemetryEvent.PluginManager,{action:"pluginObjectLoadError",reason:a});k(Error(a));h.set(t.PluginManager.State.Uninitialized);if(T.state()=="pending")T.reject(p.call("onPluginObjectEvent failed with result "+a,e.Utils.enumName(t.PluginLoadResult,a)))}break;case"__FxUnLoadComplete":t.log("PluginManager::onPluginObjectEvent "+n);y&&y.record(e.TelemetryEvent.PluginManager,{action:"pluginObjectUnloadComplete"});B();G();P();T.resolve();break;case"__FxComponentLoadComplete":y&&y.record(e.TelemetryEvent.PluginManager,{action:"pluginObjectComponentLoadComplete",reason:r[0]});i(r.length==1);a=r[0];i(s(a));t.log("PluginManager::onPluginObjectEvent "+n+" "+a);if(c[a]){c[a].onLoaded()}break;case"__FxComponentUnLoadComplete":y&&y.record(e.TelemetryEvent.PluginManager,{action:"pluginObjectComponentUnloadComplete",reason:r[0]});i(r.length==1);a=r[0];i(s(a));t.log("PluginManager::onPluginObjectEvent "+n+" "+a);if(c[a])c[a].onUnloaded();break;case"__FxPing":F();break}}function N(n){t.log("PluginManager::onPluginObjectState "+n);y&&y.record(e.TelemetryEvent.PluginManager,{action:"onPluginObjectState",id:x(),state:n});switch(n){case t.PluginObject.State.None:break;case t.PluginObject.State.Created:break;case t.PluginObject.State.Attached:e.window.setTimeout(L,0);break;case t.PluginObject.State.NotInstalled:var r=p("PluginNotInstalled");k(r);h.set(t.PluginManager.State.Uninitialized);if(T.state()=="pending")T.reject(r);break;default:B();k();h.set(t.PluginManager.State.Uninitialized)}}function L(){t.log("PluginManager::loadManager");if(h()!=t.PluginManager.State.Initializing||d.state()!=t.PluginObject.State.Attached)return;try{W();d.innerObject().Load("__pluginFx",[m,g])}catch(e){B();k(e);h.set(t.PluginManager.State.Uninitialized)}}function V(){var t=false;try{t=d.innerObject().CheckExistence()}catch(t){y&&y.record(e.TelemetryEvent.PluginManager,{action:"CheckExistence",state:h(),result:"failed",reason:t,id:x()})}return t}function W(){B();S=e.window.setTimeout(j,b)}function B(){if(S!=0){e.window.clearTimeout(S);S=0}}function j(){if(V()){W()}else{B();k(Error("TimedOut"));h.set(t.PluginManager.State.Uninitialized)}}function F(){G();w=e.window.setTimeout(H,E)}function G(){if(w!=0){e.window.clearTimeout(w);w=0}}function H(){if(t.UserAgent().isMac()){F()}else{G()}if(!V()){R();t.log("PluginManager::onPingTimeout - uninit due to missed ping");y&&y.record(e.TelemetryEvent.PluginManager,{action:"uninitPluginMgr",reason:"pingMissed"})}}function q(e){for(var t=0,n=e;t<n.length;t++){var r=n[t];try{var i=new ActiveXObject(r.VERSION_QUERY);I(r);return i}catch(e){}}}function z(t){e.window.navigator.plugins.refresh();for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i.MIME_TYPE in e.window.navigator.mimeTypes){I(i);return true}}return false}function Y(){var n=false,r,i;var a=[t.PluginManager.LYNC_PLUGINS.LATEST];var o=t.PluginManager.LYNC_PLUGINS.COMPATIBLE;var s=t.PluginManager.LYNC_PLUGINS.OBSOLETE;if(t.UserAgent().isIE()){if(i=q(a)){n=true}else if(i=q(o)){n=true;r="CompatiblePluginInstalled"}else if(i=q(s)){r="ObsoletePluginInstalled"}else{r="NoPluginInstalled"}}else if(e.window.navigator.mimeTypes){if(z(a)){n=true}else if(z(o)){n=true;r="CompatiblePluginInstalled"}else if(z(s)){r="ObsoletePluginInstalled"}else{r="NoPluginInstalled"}}else{r="NoPluginInstalled"}J(i);K();M(n,r);return n}function X(){M(void 0);I(void 0);C.removeAll(function(){return true});A(void 0)}function J(e){var t;if(d&&d.innerObject()){try{t=d.innerObject().GetVersion()}catch(e){}}if(!t&&e){try{t=e.GetVersion()}catch(e){}}if(t){t=t.replace(/@/g,".");A(t)}return t}function K(){var e=t.PluginManager.LYNC_PLUGINS.LATEST;if(e.DOWNLOAD.MSI&&!(C.index("msi")>=0))C.add(e.DOWNLOAD.MSI,"msi");if(e.DOWNLOAD.PKG&&!(C.index("pkg")>0))C.add(e.DOWNLOAD.PKG,"pkg");if(e.DOWNLOAD.DMG&&!(C.index("dmg")>0))C.add(e.DOWNLOAD.DMG,"dmg");return C()}return{init:r(_),uninit:r(R),createComponent:D,isPluginInstalled:M.asReadOnly(),installedPlugin:I,pluginDownloadLinks:C.asReadOnly(),installedVersion:A.asReadOnly(),state:h.asReadOnly(),id:x,setPingTimeout:O}});t.PluginManager.State=d("Uninitialized","Uninitializing","Initializing","Initialized");t.PluginManager.LYNC_PLUGINS={LATEST:{MIME_TYPE:"application/x-skypeforbusiness-plugin-16.2",MIME_TYPE_VERSION:"application/x-skypeforbusiness-version-16.2",SHELLAPP_URL_SCHEME:"sfb",SHELLAPP_ID:"com.microsoft.skypeforbusiness.shellapp",VERSION_QUERY:"Microsoft.SkypeForBusinessPlugin16.2.VersionQuery",DOWNLOAD:{MSI:"to-be-filled: latest msi plugin download link in CDN",PKG:"to-be-filled: latest pkg plugin download link in CDN",DMG:"to-be-filled: latest dmg plugin download link in CDN"}},COMPATIBLE:[{MIME_TYPE:"application/x-skypeforbusiness-plugin-16.1",MIME_TYPE_VERSION:"application/x-skypeforbusiness-version-16.1",SHELLAPP_URL_SCHEME:"sfb-16.1",SHELLAPP_ID:"com.microsoft.skypeforbusiness.shellapp.16.1",VERSION_QUERY:"Microsoft.SkypeForBusinessPlugin16.1.VersionQuery"},{MIME_TYPE:"application/x-skypeforbusiness-plugin-16.0",MIME_TYPE_VERSION:"application/x-skypeforbusiness-version-16.0",SHELLAPP_URL_SCHEME:"sfb-16.0",SHELLAPP_ID:"com.microsoft.skypeforbusiness.shellapp.16.0",VERSION_QUERY:"Microsoft.SkypeForBusinessPlugin16.0.VersionQuery"}],OBSOLETE:[{MIME_TYPE:"application/x-lwa-nativeplugin15.8",MIME_TYPE_VERSION:"application/x-lwa-nativeplugin-version15.8",SHELLAPP_URL_SCHEME:"sfb-w16-v2",SHELLAPP_ID:"com.microsoft.skypeforbusiness.shellapp",VERSION_QUERY:"Microsoft.LWA64Plugin15.8.VersionQuery"}]}})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){e.logMedia=false;e.dbgPlugin=false})(t=e.Settings||(e.Settings={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.debug;function r(){var t=[];for(var r=0;r<arguments.length;r++){t[r]=arguments[r]}n.log.apply(n,[e.Settings.logMedia,"[MEDIA] "].concat(t))}t.log=r;function i(t,r){n.watch(e.Settings.logMedia,"[MEDIA] "+t,r)}t.watch=i;function a(){return!e.Settings.dbgPlugin&&t.MediaAgent.isPlatformSupported()}t.useBrowserMedia=a;function o(){return typeof RTCIceGatherer!="undefined"&&!e.Settings.mediaAgent}t.isOrtc=o;function s(){return typeof RTCPeerConnection!="undefined"&&typeof RTCIceGatherer=="undefined"&&!e.Settings.mediaAgent}t.isWebRtc=s})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=function(){function t(t){function n(e){var t=+e|0;return t==e?t:e}return e.ObservableResource(t,{rel:"mediaPolicies"},function(e){e.property("bandwidthControl");e.property("fipsCompliantMedia");e.property("poorDeviceWarnings");e.property("poorNetworkWarnings");e.property("portRange");e.property("qualityOfService");e.property("audioVideoEncryption");e.property("audioBitRate",n);e.property("audioBypass");e.property("audioBypassId");e.property("internalAudioBypassMode");e.property("externalAudioBypassMode");e.property("minimumAudioPort",n);e.property("maximumAudioPort",n);e.property("minimumVideoPort",n);e.property("maximumVideoPort",n);e.property("maximumVideoRateAllowed");e.property("multiViewJoin");e.property("totalReceivedVideoBitRateKB",n);e.property("video");e.property("videoBitRate",n);e.property("applicationSharingBitRate",n);e.property("applicationSharingEncryption");e.property("minimumApplicationSharingPort",n);e.property("maximumApplicationSharingPort",n);e.property("highPerformanceApplicationSharingInOnlineMeeting")})}return t}();e.MediaPolicies=t})(t=e.Internal||(e.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.check;var i=e.Utils.Promise;var a=e.Media.PluginManager;var o=function(){function e(e,o,s){var u,c,d;function l(){var n;if(!u){n=p().then(function(){return e.init()}).then(function(){u=t.MediaConfig({ucwa:e,mediaPlugin:y,tm:o});return u.init()})}else if(u.mrasTokenExpired()){n=u.renewMrasToken()}else n=i.resolve();return n.then(function(){return u})}function f(e){return c||p(e).then(l).then(function(){c=t.AppSharing({mediaConfig:u,component:g({type:"AppShareCore",hide:true})});return c.init()}).then(function(){return c})}function p(e){if(e===void 0){e="en-us"}r(a,"NoMedia");d=d||a().state.changed(function(e,t,n){if(e==a.State.Uninitialized){h();m()}});if(s&&s.pluginPingTimeout){a().setPingTimeout(s.pluginPingTimeout)}var t=false;return a().init({language:e,rtl:t,tm:o})}function v(){h();m();if(d){d.dispose();d=null}return a().uninit()}function h(){if(u){u.uninit();u=null}}function m(){if(c){c.uninit();c=null}}function g(e){return a().createComponent(e)}var y={getMediaConfig:n(l),getAppSharing:n(f),initMedia:n(p),uninitMedia:n(v),uninitAppSharing:n(m),createComponent:g};return y}return e}();t.MediaPlugin=o})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.assert;var i=e.Utils.Task;var a=e.Utils.Property;var o=e.Utils.EWrongType;var s=e.Utils.StringEnum;var u=e.Media.log;function c(t){var d=t.ucwa,l=t.mediaPlugin,f=d.get({rel:"root"},null)?!!d.get({rel:"root"}).get("internal",false):false,p,v=a({value:c.ProxyDetection.None}),h={},m=t.tm,g=0,y=s("Enforced","Supported","NotSupported");t=null;function S(){p=l.createComponent({type:"MediaPlatformConfig",hide:true});p.event(w);p.state.changed(function(e){u("pcMediaConfig.state = "+e)});var e=p.load().then(E).catch(function(e){u("MediaConfig::init rejected");b();throw e});return e}function b(){if(p){p.event.off(w);p=null}}function w(e){if(e.type=="ProxyDetectionCompleted"){h[e.args[0]]=e.args[1]=="true"?c.ProxyDetection.Succeeded:c.ProxyDetection.Failed;var t=true,n=c.ProxyDetection.Failed;for(var r in h){switch(r){case c.ProxyDetection.None:case c.ProxyDetection.Started:t=false;break;case c.ProxyDetection.Succeeded:n=c.ProxyDetection.Succeeded;break}}if(t)v(n)}}function E(){return i.waitAll([d.send("GET",{rel:"mediaPolicies"}).then(function(){return I()}).catch(function(t){u("MediaConfig::getMediaPolicies error: ",t);m&&m.record(e.TelemetryEvent.Call,{action:"getMediaPolicies",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"failed",reason:t})}),T()])}function T(){var t=d.send("GET",{rel:"mediaRelayAccessToken"}).then(function(){return M()}).catch(function(t){u("MediaConfig::getMediaRelayAccessToken error: ",t);m&&m.record(e.TelemetryEvent.Call,{action:"getMediaRelayAccessToken",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"failed",reason:t})});m&&m.monitor(t,e.TelemetryEvent.Call,{action:"renewMrasToken",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin"});return t}function I(){m&&m.record(e.TelemetryEvent.Call,{action:"setMediaPolicies",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"started"});var t=d.get(d.app.relatedHref("communication")),n=d.get(t.link("mediaPolicies").href);if(n.properties.portRange=="Enabled"){p.invoke("SetPortRanges",n.properties["minimumAudioPort"],n.properties["maximumAudioPort"],n.properties["minimumVideoPort"],n.properties["maximumVideoPort"],n.properties["minimumApplicationSharingPort"],n.properties["maximumApplicationSharingPort"])}p.invoke("SetMediaPlatformConfig",n.properties["qualityOfService"]=="Enabled",f);p.invoke("SetMediaSettings",true,true,parseInt(n.properties["audioBitRate"])||-1,parseInt(n.properties["videoBitRate"])||-1,parseInt(n.properties["applicationSharingBitRate"])||-1,-1,parseInt(n.properties["totalReceivedVideoBitRateKB"])||-1,n.properties["fipsCompliantMedia"]=="Required");p.invoke("SetStereoAudioRendering",false);m&&m.record(e.TelemetryEvent.Call,{action:"setMediaPolicies",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"succeeded"})}function M(){m&&m.record(e.TelemetryEvent.Call,{action:"setMras",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"started"});var t=d.get(d.app.relatedHref("communication")),n=d.get(t.link("mediaRelayAccessToken").href);var r=n.properties["userName"];var i=n.properties["password"];var a,o,s,l,y="*";p.invoke("ClearIceServers");for(var S=0,b=n.related.mediaRelay.length;S<b;S++){a=d.get(n.related.mediaRelay[S].href);if(f&&a.properties["location"]=="Internet"||!f&&a.properties["location"]=="Intranet")continue;l=a.properties["host"];o=a.properties["tcpPort"]||-1;s=a.properties["udpPort"]||-1;p.invoke("AddProxyServer",l);h[l]=c.ProxyDetection.Started;if(v()==c.ProxyDetection.None)v(c.ProxyDetection.Started);if(s!=-1){try{p.invoke("AddIceServer",1,l,s,r,y,i)}catch(e){u(e.message+" : UDP "+l+":"+s)}}if(o!=-1){try{p.invoke("AddIceServer",2,l,o,r,y,i)}catch(e){u(e.message+" : TCP "+l+":"+o)}}}var w=n.properties["duration"]||0;w=w>2?w-2:0;g=e.Date.now()+w*6e4;m&&m.record(e.TelemetryEvent.Call,{action:"setMras",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",result:"succeeded"})}function C(){r(p);p.invoke("SetDefaultDevices")}function A(){var e=d.get(d.app.relatedHref("communication")),t=d.get(e.link("mediaPolicies").href),n,r;if(t){n=t.properties["audioVideoEncryption"];switch(n){case y.Enforced:r=3;break;case void 0:case y.Supported:r=2;break;case y.NotSupported:r=1;break;default:throw o(n,"EnforcementPolicy")}}return r}function _(){var e=d.get(d.app.relatedHref("communication")),t=d.get(e.link("mediaPolicies").href),n,r;if(t){n=t.properties["applicationSharingEncryption"];switch(n){case y.Enforced:r=3;break;case void 0:case y.Supported:r=2;break;case y.NotSupported:r=1;break;default:throw o(n,"EnforcementPolicy")}}return r}function R(){var e=p.invoke("GetMaxVideoChannelCount");return e[1]<6?e[1]:6}return{init:n(S),uninit:b,isInternal:function(){return f},audioVideoSecurityLevel:A,applicationSharingSecurityLevel:_,maxVideoChannelCount:R,proxyDetection:v.asReadOnly(),setDefaultDevices:C,mrasTokenExpired:function(){return e.Date.now()>g},renewMrasToken:T}}t.MediaConfig=c;(function(e){e.ProxyDetection=s("None","Started","Succeeded","Failed")})(c=t.MediaConfig||(t.MediaConfig={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.DataUri;var i=e.Utils.async;var a=e.Utils.extend;var o=e.Utils.indexOf;var s=e.Utils.guid;var u=e.Utils.Property;var c=e.Utils.check;var d=e.Utils.Exception;var l=e.Utils.Task;var f=e.Utils.Command;var p=e.Utils.Model;var v=e.Media.log;function h(e){var h=p(),m=e.ucwa,g=e.invitation,y=e.rConversation,S=e.participants,b=u({value:g?t.Modality.State.Notified:t.Modality.State.Created}),w=e.threadId,E=e.mediaPlugin,T=e.sharedResources,I,M,C,A,_,R,P,k,O,x=e.resource,D={},U,N;e=null;var L=u({value:null,get:function(){return A},set:function(e){return J(e).then(function(){return e})}});a(h,{state:b.asReadOnly(),shared:L});if(g)h.from=g.from;b.changed(function(e,t,n){v("AppSharingModality::state: %c"+n+" -> "+e,"color:green;font-weight:bold","Reason: ",t)});m.event(W);function V(e,t,n){var r=u();b.changed(function(e){r(o(t,e)>=0)});h[e]=f(i(n),r)}function W(e){var t=e.target.rel+" "+e.type;var n=B[t];if(n){n(e.status,e.resource,e)}}var B={"applicationSharingInvitation started":function(e,t){if(t.properties.direction=="Outgoing"&&t.properties.threadId==w){x=t;R.status('awaiting "applicationSharingNegotiation started" event from UCWA')}},"applicationSharingNegotiation started":function(e,t){var n,i;if(t.relatedHref("applicationSharingInvitation")==x.href){n=r(t.relatedHref("mediaProvisionalAnswer")).data;i=t.get("remoteEndpoint");M.setProvisionalAnswer(true,true,i,n);R.status('awaiting "applicationSharingNegotiation completed" event from UCWA')}},"applicationSharingNegotiation completed":function(e,t,n){if(n.sender.href==x.href){switch(e){case"Success":Q(t,t.get("remoteEndpoint"));R.status('awaiting "applicationSharingInvitation completed" event from UCWA');break;case"Failure":R.status(n.reason&&n.reason.message);break}}},"applicationSharingSession added":function(e,t){if(x.relatedHref("conversation")==t.relatedHref("conversation"))k=t},"applicationSharingInvitation completed":function(e,n){if(x&&x.href==n.href){if(x.get("direction","")=="Outgoing"){}else if(x.get("direction","")=="Incoming"){if(e=="Success"){try{$(e);_.resolve();b(t.Modality.State.Connected)}catch(e){_.reject(e);b(t.Modality.State.Disconnected,e)}}}}},"applicationSharingRenegotiation started":function(e,t){var n,i="";if(t.properties.direction=="Incoming"&&t.relatedHref("conversation")==x.relatedHref("conversation")){n=r(t.relatedHref("mediaOffer")).data;v("Incoming SDP offer:\n"+n);l.wait(null).then(function(){if(b()==="Connected"&&A)return J(null)}).then(function(){M.setOffer(false,1,n,i)});O=t}},"applicationSharingRenegotiation completed":function(e,t){if(t.relatedHref("conversation")==x.relatedHref("conversation")){if(t.get("direction")=="Outgoing")Q(t,k.get("remoteEndpoint"));$(e)}},"applicationSharing updated":function(e,n){if(x&&n.href==x.relatedHref("applicationSharing")&&n.get("state")=="Disconnected"){if(n.hasLink("applicationSharer")){k=null;J(null)}else{X();b(t.Modality.State.Disconnected)}}},"conversation updated":function(e,t){if(x&&t.href==x.relatedHref("conversation")&&(t.get("state")=="Connected"||t.get("state")=="Conferenced")){var n=o(t.get("activeModalities"),"ApplicationSharing")>=0;if(n){}}}};function j(e){v("pcAS.event %c "+e.type,"color:blue",e.args);var t=F[e.type];if(t){t.apply(null,e.args!==""?e.args:null)}}var F={OFFER_READY:function(e,n,r){var i,a=[];try{for(i=0;i<r;i++){a.push({sdp:arguments[3+i*2],id:arguments[3+i*2+1]})}if(a.length==0)throw d("NoSdpOffers",{diagCode:n});if(k){te(a[0].sdp)}else{ee(a).then(function(){R.resolve();b(t.Modality.State.Connected)},function(e){R.reject(e);b(t.Modality.State.Disconnected,e);X()},R.status)}}catch(e){if(R)R.reject(e)}},ANSWER_READY:function(e,n){if(O){m.send("POST",O.link("answer").href,{headers:{"Content-Type":"application/sdp"},data:n,nobatch:true})}else{_.status("sending answer to UCWA");g.acceptWithAnswer(n).then(function(){_.status('awaiting a "applicationSharingInvitation completed" event from UCWA')},function(e){b(t.Modality.State.Disconnected,e);_.reject(e)},_.status)}},StopSharing:function(){h.stop()}};function G(){return I?l.wait(I):E.getMediaConfig().then(function(e){I=e;return I})}function H(){n(!C);C=E.createComponent({type:"AppShareViewerUI",hide:false});C.setContainer(U);C.event(z,"async");return C.load()}function q(e){function t(){return T.init().then(E.getAppSharing).then(function(e){M=e;M.event(j,"async")})}function n(){return l.wait(null).then(function(){T.windows.each(function(e){T.setShared(e.id(),false)});T.monitors.each(function(e){T.setShared(e.id(),false);e.selected(false)});T.setShared(A.id(),true);M.setCallConfig();M.setMediaConfig(3,2)})}function r(){return l.wait(null).then(function(){if(!C)return H()}).then(function(){C.invoke("CreateAppShareViewerUI");var e=C.invoke("GetViewerWindow");if(e.length===2&&e[1])N=e[1];M.setCallConfig();M.initializeViewer(N);M.connectViewer("connectString");M.setSmartSizingViewer(true);M.setViewerWindowSize(U.offsetWidth,U.offsetHeight);if(Y()){M.setMediaConfig(3,1)}else{M.createViewerStream()}})}if(e===2){if(M){return n()}else{return t().then(n)}}else{return l.wait(null).then(function(){if(M){return r()}else{return t().then(r)}})}}function z(e){v("pcASUI.event %c "+e.type,"color:blue",e.args);if(e.type=="SIZE_CHANGED"&&M)M.setViewerWindowSize(e.args[0],e.args[1])}function Y(){return y&&(y.get("state","")=="Conferenced"||y.get("state","")=="Conferencing")}V("start",[t.Modality.State.Created],function(e){b(t.Modality.State.Connecting);e=e||{};U=e.container;if(!Y()){P=P||e.to;if(!P){S.each(function(e){if(!e.local())P=e.uri()})}c(P,"the remote participant URI is not specified")}A=e.window||e.monitor;return G().then(function(){return E.getAppSharing().then(function(e){M=e;M.event(j,"async");q(A?2:1);n(!R);R=new l("awaiting an OFFER_READY event from the media plugin");return R.promise}).then(null,function(e){if(x&&x.hasLink("cancel")&&(x.get("state","")=="Connecting"||x.get("state","")=="Alerting"))m.send("POST",x.link("cancel").href,{nobatch:true});b(t.Modality.State.Disconnected,e);throw e})})});function X(){m.event.off(W);if(M){M.event.off(j);if(A)T.setShared(A.id(),false);M.disposeSharer();T.uninit()}if(C){M.disposeViewer();C.event.off(z);C.unload()}C=null;E.uninitAppSharing().then(function(){M=null;return T.init()})}V("stop",[t.Modality.State.Connected],function(){X();return m.send("GET",x.link("applicationSharing").href).then(function(e){return m.send("POST",e.link("stopScreenSharing").href)}).then(function(){b(t.Modality.State.Disconnected);x=null;k=null})});V("accept",[t.Modality.State.Notified],function(e){n(e&&e.container);b(t.Modality.State.Connecting);U=e.container;return G().then(function(){return E.getAppSharing().then(function(e){M=e;M.event(j,"async");return q(1).then(function(){K(g.offers)})})}).then(function(){n(!_);_=new l;_.status("awaiting an ANSWER_READY event from the media plugin");return _.promise}).then(null,function(e){b(t.Modality.State.Disconnected,e);X();throw e})});function J(e){c.state(b(),t.Modality.State.Connected);function n(){if(!Y()){M.setCallConfig();M.setMediaConfig(3,2)}M.disposeViewer();C.event.off(z);C.unload();C=null;if(Y()){return E.uninitAppSharing().then(function(){M=null;T.uninit()}).then(function(){A=e;return q(2)})}else{T.setShared(e.id(),true);A=e}}function r(){M.disposeSharer();return E.uninitAppSharing().then(function(){M=null;T.uninit()}).then(function(){return q(1)})}if(A){T.setShared(A.id(),false)}if(C){return n()}else if(e){T.setShared(e.id(),true);A=e}else{return r()}}V("decline",[t.Modality.State.Notified],function(){return g.decline().then(function(){b(t.Modality.State.Disconnected)})});function K(e){n(e.length>=0);var t,r,i=[false,e.length];for(t=0;t<e.length;t++){r=e[t];n("sdp"in r);n("id"in r);i.push(r.sdp);i.push(r.id)}M.setOffer.apply(M,i)}function Q(e,t){var n=e.relatedHref("mediaAnswer"),i=r(n).data;v("Final answer from the remote party:\n"+i);M.setFinalAnswer(t,i)}function $(e){var n=e=="Success"?t.MediaEnum.NegotiationStatus.NS_SUCCESS:t.MediaEnum.NegotiationStatus.NS_LOCAL_INTERNAL_ERROR;M.completeNegotiation(n)}function Z(){if(!y){var e=m.get(m.app.relatedHref("communication")).link("startScreenSharing");e.rel="startScreenSharing";return e}var e=y.link("applicationSharing");return m.send("GET",e.href).then(function(e){var t=e.link("addScreenSharing");t.rel="addScreenSharing";return t})}function ee(e){n(e.length>0);var a="data:application/sdp;charset=utf-8,"+r.encodeData(e[0].sdp);return i(Z).call(null).then(function(e){var n,r,i=s(),o;if(Y()){o={operationId:i,threadId:w,mediaOffer:a}}else{o={to:e.rel=="addScreenSharing"?void 0:P,operationId:i,sessionContext:s(),threadId:w,mediaOffer:a}}n=m.send("POST",e.href,{data:o}).then(function(e){x=e});r=m.wait({type:"completed",target:{rel:"applicationSharingInvitation"},resource:function(e){return e.get("direction")=="Outgoing"&&(e.get("threadId")==w||e.get("operationId")==i)}}).then(function(e){if(e.status=="Failure")throw t.EInvitationFailed(e.reason);$(e.status)});return l.waitAll([n,r])})}function te(e){var t=k.relatedHref("renegotiations");n(t,'"renegotiations" link is missing');var r=s();D[r]="";return m.send("POST",t,{headers:{"Content-Type":"application/sdp"},query:{operationId:r},data:e,nobatch:true})}return h}t.AppSharingModality=h})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.ConstProperty;var i=e.Utils.Model;function a(e){var t=e.mediaPlugin,a=e.resource,o=e.shared;a.filter=2;function s(e){return t.getAppSharing().then(function(t){return t.getResourcePreview(a,e)})}return i({id:r(a.id),title:r(a.name),shared:o,preview:n(s)})}t.ShareableWindow=a})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.ConstProperty;var r=e.Utils.Property;var i=e.Utils.Model;function a(e){var t=e.mediaPlugin,a=e.resource,o=e.shared;if(a.id!==-1)a.name="Monitor #"+a.id;else a.name="Desktop Sharing";a.filter=1;var s=r({value:false,set:function(e){return t.getAppSharing().then(function(t){if(e)t.drawTrackingChrome(a.id);else t.removeTrackingChrome(a.id);return e})}});return i({id:n(a.id),title:n(a.name),shared:o,selected:s})}t.ShareableMonitor=a})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.async;var i=e.Utils.foreach;var a=e.Utils.Property;var o=e.Utils.Collection;var s=e.Utils.Model;var u=e.Media.UserAgent;function c(e){var c,d,l=o({get:v,subscribed:v}),f=o({get:v,subscribed:v}),p={};function v(){return d?d:d=e.initMedia().then(function(){return e.getAppSharing()}).then(function(e){n(!c);c=e;c.event(m,"async");if(!u().isMac()){var t=[],r=[],a=c.getShareableResources();i(a,function(e){if(e.type===1){r.push(e)}else if(e.type===3){t.push(e)}});S(t,l);S(r,f)}g()})}function h(){if(c)c.event.off(m);c=null;d=null}function m(n){if(n.type=="ResourceUpdated"){var r=n.args.splice(7,1)[0],i=n.args[0],a,o={type:n.args[0],id:n.args[1],appId:n.args[2],name:n.args[3],isShared:n.args[4],flags:n.args[5],isResourceAsIsShareable:n.args[6],fIsImmersiveModeApp:n.args[7]},s;if(i===1){a=y(o,f);if(r===1){if(!a){s=b(o);p[o.id]=s;f.add(t.ShareableMonitor({resource:o,mediaPlugin:e,shared:s.asReadOnly()}))}}else if(r===2){if(a){f.remove(a);delete p[o.id]}}g()}else if(i===3){a=y(o,l);if(r===1){if(!a&&o.isResourceAsIsShareable){s=b(o);p[o.id]=s;l.add(t.ShareableWindow({resource:o,mediaPlugin:e,shared:s.asReadOnly()}))}}else if(r===2){if(a){l.remove(a);delete p[o.id]}}}}}function g(){var n,r={type:4,id:-1,appId:-1},i;f.each(function(e,t){if(e.title()==="Desktop Sharing"){n=t}});if(n){f.remove(n);delete p[r.id]}i=b(r);p[r.id]=i;f.add(t.ShareableMonitor({resource:r,mediaPlugin:e,shared:i.asReadOnly()}))}function y(e,t){var n;t.each(function(t,r){if(t.id()===e.id){n=r;return}});return n}function S(n,r){i(n,function(n){var i=false;r.each(function(e){if(n.id===e.id()){i=true}});if(!i){var a=b(n);p[n.id]=a;if(n.type===1){r.add(t.ShareableMonitor({resource:n,mediaPlugin:e,shared:a.asReadOnly()}))}else{r.add(t.ShareableWindow({resource:n,mediaPlugin:e,shared:a.asReadOnly()}))}}})}function b(t){return a({value:false,set:function(n){return e.getAppSharing().then(function(e){var r={type:t.type,id:t.id,appId:t.appId,filter:t.filter};if(n)e.shareResource(r);else e.unshareResource(r);return n})}})}function w(e,t){if(p[e]){p[e](t)}}return s({init:r(v),uninit:h,windows:l.asReadOnly(),monitors:f.asReadOnly(),setShared:w})}t.SharedResources=c})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.DataUri;var r=e.Utils.async;var i=e.Utils.extend;var a=e.Utils.guid;var o=e.Utils.map;var s=e.Utils.check;var u=e.Utils.HttpHeaders;var c=e.Stack.parseMultipartRelatedResponse;function d(e){var t=e.ucwa,d=e.resource,l=e.createParticipant;s.equals(d.rel,"applicationSharingInvitation");var f={acceptWithAnswer:r(h),decline:r(m),offers:p(),from:v()};i(f,d.properties);f.sessionContext=f.sessionContext||a();function p(){var e,t,r;e=d.relatedHref("mediaOffer");if(!e)return[];t=n(e);try{r=c({status:null,responseText:t.data,headers:{"Content-Type":"multipart/related;boundary="+t.attributes.boundary}});return o(r,function(e){var t=u(e.headers);return{sdp:e.responseText,id:t.get("Content-ID")}})}catch(e){return[{sdp:t.data,id:""}]}}function v(){var e=d.relatedHref("from");return e&&l(d.embedded[e])}function h(e){var n=d.link("acceptWithAnswer").href;return t.send("POST",n,{headers:{"Content-Type":"application/sdp"},query:{sessionContext:f.sessionContext},data:e,nobatch:true})}function m(){return t.send("POST",d.link("decline").href,{data:{reason:"Local"}})}return f}t.AppSharingInvitation=d})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.guid;var i=e.Utils.Exception;var a=e.Utils.EInvalidArgument;function o(e){var o=e.mediaConfig,s=e.component;var u=false;function c(){return s.load("","",r(),false,o.maxVideoChannelCount(),o.applicationSharingSecurityLevel()).then(function(){s.invoke("InitializeSharer");s.setLogLevel(3);u=true})}function d(){if(s){s.unload();s=null;u=false}}function l(){if(!u)throw i.call("Not Initialized","NotInitialized")}function f(){l();s.invoke("SetCallConfig",o.isInternal()?t.MediaEnum.PreferredMediaAddressType.Direct:t.MediaEnum.PreferredMediaAddressType.Relay)}function p(e,t){l();s.invoke("SetMediaConfig",e,t)}function v(e){l();s.invoke("InitializeViewer",e)}function h(e){l();s.invoke("ConnectViewer",e)}function m(){l();s.invoke("CreateViewerStream",3)}function g(e,t){l();s.invoke("SIZE_CHANGED",e,t)}function y(e){l();s.invoke("SetSmartSizingViewer",e)}function S(e){l();s.invoke("PublishFullScreenState",e)}function b(e,t){l();if(t<1)throw a("count","No Offers Provided");var n=["SetOffer",e,t].concat([].slice.call(arguments,2));s.invoke.apply(s,n)}function w(e,t){l();s.invoke("SetFinalAnswer",e,t)}function E(e,t,n,r){l();s.invoke("SetProvisionalAnswer",e,t,n,r)}function T(e){l();s.invoke("CompleteNegotiation",e)}function I(){l();var e=[],t,n,r=0;s.invoke("LockFetchResources");t=s.invoke("GetResources");s.invoke("UnlockFetchResources");if(t){n=t[t.length-1];t=t.slice(1,-1);for(var i=0;i<n;i++){if(t[r+4]!==1&&(t[r]===1||t[r]===3&&t[r+6]!==0)){e.push({type:t[r],id:t[r+1],appId:t[r+2],name:t[r+3],isShared:t[r+4],flags:t[r+5],isResourceAsIsShareable:t[r+6],fIsImmersiveModeApp:t[r+7]})}r+=8}}return e}function M(e){l();s.invoke("DrawMonitorTrackingChrome",e)}function C(e){l();s.invoke("RemoveMonitorTrackingChrome",e)}function A(e,t){l();var n;if(e.type===1){}else{var r=s.invoke("GetApplicationPreview",e.appId,e.id,t.width,t.height);n="data:image/png;base64,"+r[1]}return n}function _(e){l();s.invoke("SetControlAllowed",1,true,true);if(e.id!==-1){s.invoke("SetResourceFilter",e.filter,1);s.invoke("SetResourceSharedState",e.type,e.id,e.appId,1)}else{s.invoke("DisableFilters")}s.invoke("CanStopSharing",true)}function R(e){l();s.invoke("SetResourceSharedState",e.type,e.id,e.appId,0)}function P(){l();s.invoke("DisposeSharer")}function k(){l();s.invoke("DisposeViewerCore")}return{init:n(c),uninit:d,setCallConfig:f,setMediaConfig:p,initializeViewer:v,connectViewer:h,createViewerStream:m,setViewerWindowSize:g,setSmartSizingViewer:y,publishFullScreenState:S,setOffer:b,setFinalAnswer:w,setProvisionalAnswer:E,completeNegotiation:T,getShareableResources:I,drawTrackingChrome:M,removeTrackingChrome:C,getResourcePreview:A,shareResource:_,unshareResource:R,disposeSharer:P,disposeViewer:k,event:s.event}}t.AppSharing=o})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.find;var r=e.Utils.guid;var i=e.Utils.check;var a=e.Utils.async;var o=e.Utils.assert;var s=e.Utils.extend;var u=e.Utils.random;var c=e.Utils.values;var d=e.Utils.filter;var l=e.Utils.foreach;var f=e.Utils.isEmptyObject;var p=e.Utils.isNotEmptyString;var v=e.Utils.currentUTCms
;var h=e.Utils.Task;var m=e.Utils.Event;var g=e.Utils.Symbol;var y=e.Utils.DataUri;var S=e.Utils.Promise;var b=e.Utils.Property;var w=e.Utils.Exception;var E=e.Utils.Collection;var T=e.Utils.StringEnum;var I=e.Utils.EDoesNotExist;var M=e.Utils.EInvalidState;var C=e.Utils.ENotSupported;var A=e.Utils.EInvalidArgument;var _=e.Utils.setHiddenProperty;var R=e.Media.log;var P=e.Media.watch;var k=e.Media.PluginManager;var O=e.Media.PluginComponent;t.sEscalation=g("escalation");var x=function(){function g(g){var x=new m,D=new m,U=new m,N={},L,V,W=g.mediaPlugin,B=g.devices,j=g.ucwa,F=g.tm,G=g.context,H=g.contextType,q=g.settings,z=g.participants,Y=g.selfParticipant,X=g.conversation,J=g.rConversation,K=g.rAVInvitation,Q,$={},Z=g.invitation,ee=g.rInvitation,te=g.operationId||r(),ne=g.sessionContext||r(),re={},ie=g.localUri,ae,oe=b({value:Z||ee&&ee.rel=="onlineMeetingInvitation"?t.Modality.State.Notified:t.Modality.State.Disconnected}),se=b({value:nt()||rt()?t.Modality.State.Notified:t.Modality.State.Disconnected}),ue=b({value:rt()?t.Modality.State.Notified:t.Modality.State.Disconnected}),ce,de={},le={audio:false,video:false},fe,pe=new t.MediaStream({mediaPlugin:W,type:t.MediaEnum.StreamType.MainRender}),ve=new t.MediaStream({mediaPlugin:W,type:t.MediaEnum.StreamType.Preview}),he=E(),me,ge,ye,Se,be,we=new h,Ee=false,Te=w("skipping outgoing renegotiation because of pending incoming renegotiation"),Ie={},Me=0,Ce=g.callId||u(),Ae={Unknown:0,HoldOffered:1,HoldAnswered:2,HoldCompleted:3,ResumeOffered:4,ResumeAnswered:5,ResumeCompleted:6},_e=T("Inactive","ReceiveOnly","SendOnly","SendReceive","Unknown"),Re=Ae.Unknown,Pe=g.escalateAudioVideoUri,ke=b({value:Pe?2:0}),Oe=b(),xe,De,Ue,Ne,Le,Ve,We=Y.audio.isUnmuteRequested,Be=b({value:false});o(X);we.resolve();function je(e){L.invoke("MuteOrUnMute",t.MediaEnum.MediaDeviceType.MIC,e,false)}var Fe=b({value:false,get:function(){i.state(L.state(),O.State.Loaded);if(qe())return Fe();var e=L.invoke("GetMuteStatus",t.MediaEnum.MediaDeviceType.MIC,false);return e[1]},set:function(e){i.state(L.state(),O.State.Loaded);var n;if(qe()){var r=e?"muteAudio":"unmuteAudio",a=j.get(Y[t.sInternal].audioLink);if(!e&&We()){We(false);je(e);n=S.resolve(e)}else{n=h.run(function(){if(!a||!a.hasLink(r))return j.send("GET",Y[t.sInternal].audioLink);else return a}).then(function(e){return j.send("POST",e.link(r).href)}).then(function(){if(!e&&We())We(false);return e})}}else{je(e);n=S.resolve(e)}return n}});var Ge=b({value:false,get:function(){i.state(L.state(),O.State.Loaded);return Ge()},set:function(e){i.state(L.state(),O.State.Loaded);if(!qe()&&z.size()>0){if(z(0).audio.isOnHold()&&!Ge())return e}var n=e?4:3;var r=le.video&&qe();return we.promise.then(function(){if(Ee)throw Te;we=new h;Me=le.video?e?4:Y[t.sInternal].videoStartedBeforeHold()?3:2:0;L.invoke("SetMediaConfig",n,Me,r?V.maxVideoChannelCount()-1:0,r?e?4:2:0,0);be=e;Y[t.sInternal].videoStartedBeforeHold(e?Y.video.channels(0).isStarted():undefined);Y[t.sInternal].audioOnHold(e);return bt()}).then(function(){return Ke(e)}).then(function(){return e}).catch(function(e){R(e);wt("reject",e);if(we.state()=="pending")we.resolve();throw e})}});g=null;j.event(Et);Ne=k().state.changed(function(e,n,r){if(e==k.State.Uninitialized&&r!=void 0){var i="PluginUninited";if(me&&me.state()=="pending")me.reject(i);else if(ge&&ge.state()=="pending")ge.reject(i);else{ht(i);oe(t.Modality.State.Disconnected)}}});P("AudioVideoSession("+Ce+")::state:",oe);P("AudioVideoSession("+Ce+")::audioState:",se);P("AudioVideoSession("+Ce+")::videoState:",ue);oe.when(t.Modality.State.Disconnected,function(){se(t.Modality.State.Disconnected);ue(t.Modality.State.Disconnected)});ue.when(t.Modality.State.Disconnected,et);z.removed(function(e){var n=e[t.sInternal].audioSourceId();delete de[n];if(ce==n)ce=-1;$e(e)});Je(ve,true);if(!qe())Je(pe,false);s(N,{state:oe.asReadOnly(),audioState:se.asReadOnly(),videoState:ue.asReadOnly(),start:a(ct),stop:a(lt),cleanup:ht,sendDtmf:ft,changed:x.observer,escalated:D.observer,errorOccured:U.observer,muted:Fe,onHold:Ge,selfVideoStream:ve,showParticipantVideo:pt,removeParticipantVideo:vt,removeVideo:a(Ze),escalationState:ke,preEscalationVideoConfig:Oe,isClean:Be.asReadOnly()});if(Z){s(N,{from:Z.from,accept:a(dt)})}function He(){return V?h.wait(V):W.getMediaConfig().then(function(e){V=e;return V})}function qe(){J=J||ze();var e=J&&J.get("state","");return e=="Conferencing"||e=="Conferenced"}function ze(){var e=X&&X[t.sHref];return e?j.get(e):null}function Ye(){var e,t,n=d(c($),function(e){return e.negotiated});if(n.length>0){o(n.length==1);t=n[0];e=t.resumeAudioVideoUri||t.resource.link("renegotiations").href;o(e)}return e}function Xe(e){l($,function(t){if(t.resource.get("sessionContext")==e)t.negotiated=true})}function Je(n,r){n._isFlowing.changed(function(e,t,i){R("AudioVideoSession("+Ce+")::isFlowing changed:isPreview="+r,i+"=>"+e,t);if(e)mt(n,r);else gt(n,r)});n.source.sink.container.changed(function(e,t,i){R("AudioVideoSession("+Ce+")::container changed:isPreview="+r,i+"=>"+e,t);if(n._isFlowing()){if(i)gt(n,r);if(e)mt(n,r)}});n.source.sink.format.changed(function(i,a,o){var s=n.source.sink;R("AudioVideoSession("+Ce+")::format changed:isPreview="+r,o+"=>"+i,a);if(i&&n._id()&&s._videoWindow()&&n._isFlowing()){L.invoke("SetVideoDisplayOptions",r?t.MediaEnum.MediaDeviceType.PREVIEW:t.MediaEnum.MediaDeviceType.RENDER,s._videoWindow(),s._format(),1);F&&F.record(e.TelemetryEvent.Call,{action:"SetVideoDisplayOptions",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),oldFormat:o,newFormat:i,reason:a,mediaDeviceType:r?"preview":"render",callId:Ce})}})}function Ke(e){var n=[];if(e){var r=function(e){var r=Ie[e];var i=vt(r,true).then(function(){return r[t.sInternal].setVideoStarted(false)});n.push(i)};for(var i in Ie){r(i)}}else{var a=function(e){var r=Ie[e];var i=pt(r,true).then(function(){return r[t.sInternal].setVideoStarted(true)});n.push(i)};for(var i in Ie){a(i)}}return h.waitAll(n)}function Qe(e){o(e);Ie[e[t.sHref]]=e}function $e(e){o(e);delete Ie[e[t.sHref]]}function Ze(e){R("AudioVideoSession("+Ce+")::removeAllVideo",e);gt(pe,false);gt(ve,true);pe._isFlowing(false);ve._isFlowing(false);if(e!==t.sEscalation){Y[t.sInternal].setVideoStream(null)}if(z.size()>0){z(0)[t.sInternal].setVideoStream(null);z(0)[t.sInternal].setVideoStarted(false)}}function et(e){R("AudioVideoSession("+Ce+")::resetVideo",e);z.each(function(e){e[t.sInternal].setVideoStream(null)});pe._isFlowing(false);ve._isFlowing(false);he.empty();if(e!==t.sEscalation){Y[t.sInternal].setVideoStream(null);Y[t.sInternal].videoState(t.Modality.State.Disconnected)}}function tt(e){return/\ba=inactive\b/gim.test(e)}function nt(){return Z&&!Z.hasVideo()||ee&&ee.rel=="onlineMeetingInvitation"&&X.meeting.availableModalities.audio()&&!X.meeting.availableModalities.video()}function rt(){return Z&&Z.hasVideo()||ee&&ee.rel=="onlineMeetingInvitation"&&X.meeting.availableModalities.video()}function it(){var e;try{if(L)e=L.invoke("GetDiagnosticsBlob");if(e&&e[0]===0)return e[1]}catch(e){R("GetDiagnosticsBlob FAILURE",e)}}function at(){return!e.Media.useBrowserMedia()?B&&B.mediaCapabilities.installedVersion():void 0}function ot(t){if(!Le)return;R("AudioVideoSession("+Ce+")::postMediaDiagnostics",t);var n=it();if(n){var r={data:{},nobatch:true};r.headers={"X-MS-MediaDiagnostics":n};r.data.callId=Ce;if(t){if(t.code)r.data.errorCode=t.code;if(t.subcode)r.data.errorSubcode=t.subcode}var i=j.send("POST",Le,r);F&&F.monitor(i,e.TelemetryEvent.Call,{action:"postMediaDiagnostics",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:at(),callId:Ce});Le=null}}function st(){if(!Ve)return;var t;try{t=L.invoke("GetQoeXml")}catch(e){R("GetQoeXml FAILURE",e)}if(t&&t[0]===0){if(t.length<3){R("Unexpected GetQoeXml result",t);return}var n=j.send("POST",Ve,{data:{mediaEndpoint:t[1],mediaQualityOfExperience:t[2]},nobatch:true});F&&F.monitor(n,e.TelemetryEvent.Call,{action:"publishCallQualityFeedback",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:at(),callId:Ce});Ve=null}}function ut(e){if(e.hasLink("publishTelemetry")){j.send("POST",e.link("publishTelemetry").href,{nobatch:true,headers:{"Content-Type":"application/json"},data:'{startTime:"\\/Date('+v()+')\\/", '+'endTime:"\\/Date('+(v()+1)+')\\/"}'})}}function ct(e){if(e.mainVideoConfig!=0&&le.video||e.mainVideoConfig==0&&e.audioConfig==3&&le.audio)return h.wait("already started");R("AudioVideoSession("+Ce+")::start",e);i.state(Ge(),false);me=new h("starting a call");var n=e.audioConfig,a=e.video&&e.video.previewContainer,o=e.video&&e.video.container,s=e.mainVideoConfig!=0,u=Me;Me=e.mainVideoConfig;ae=ae||e.remoteUri;e=null;i.state(oe(),[t.Modality.State.Disconnected,t.Modality.State.Notified,t.Modality.State.Connected]);if(oe()==t.Modality.State.Disconnected||oe()==t.Modality.State.Notified){oe(t.Modality.State.Connecting)}if(se()==t.Modality.State.Disconnected||se()==t.Modality.State.Notified){se(t.Modality.State.Connecting);if(!qe()&&z.size()>0)z(0)[t.sInternal].audioState(t.Modality.State.Connecting)}if(!s)ue(t.Modality.State.Disconnected);if(ue()==t.Modality.State.Disconnected&&s||ue()==t.Modality.State.Notified){ue(t.Modality.State.Connecting);if(!qe()&&z.size()>0)z(0)[t.sInternal].videoState(t.Modality.State.Connecting)}var c=He().then(function(){if(!L){L=W.createComponent({type:"AVComponent",hide:true});L.event(Ut,"async");return L.load(ie,qe()?r():ae,X.threadId(),qe(),qe()?V.maxVideoChannelCount():1,V.audioVideoSecurityLevel())}}).then(function(){return we.promise.then(function(){if(s&&se()=="Connected"){if(Ee)throw Te;else we=new h}})}).then(function(){var e=Me!=0&&qe();if(B&&!B.selectedMicrophone())V.setDefaultDevices();L.invoke("SetCallConfig",V.isInternal()?t.MediaEnum.PreferredMediaAddressType.Direct:t.MediaEnum.PreferredMediaAddressType.Relay);Y[t.sInternal].setVideoStream(ve);if(o)pe.source.sink.container(o);if(a)ve.source.sink.container(a);L.invoke("SetMediaConfig",n,Me,e?V.maxVideoChannelCount()-1:0,e?2:0,0);if(se()==t.Modality.State.Connecting&&!qe()&&z.size()>0)z(0)[t.sInternal].audioState(t.Modality.State.Ringing);if(s&&se()=="Connected")yt();me.status("waiting for an OFFER_READY event from the media plugin")});return h.waitAll([c,me.promise]).catch(function(e){R("AudioVideoSession("+Ce+")::start failed",e);if(e==Te&&s&&se()=="Connected"){Me=u;ue(t.Modality.State.Disconnected);if(!qe()&&z.size()>0&&z(0)[t.sInternal].videoState()==t.Modality.State.Connecting)z(0)[t.sInternal].videoState(t.Modality.State.Disconnected);if(me.state()=="pending")me.reject(e);throw e}ot();if(!K){ht(e)}else if(K.hasLink("cancel")){j.send("POST",K.link("cancel").href,{nobatch:true})}else{}if(me.state()=="pending")me.reject(e);if(we.state()=="pending")we.resolve();oe(t.Modality.State.Disconnected);se(t.Modality.State.Disconnected);ue(t.Modality.State.Disconnected);throw e})}function dt(e){o(Z,'This is an outgoing call, so it cannot be "accepted"');o(!qe(),"This is a conference");o(z.size()==1,"The caller is not in participants");R("AudioVideoSession("+Ce+")::accept",e);ge=new h("accepting a call");var n=e&&e.video,r=n&&n.container,i=n&&n.previewContainer;Me=n?t.MediaEnum.enumcastDirection(n.direction):q&&q.supportsVideo==false?0:2;oe(t.Modality.State.Connecting);se(t.Modality.State.Connecting);z(0)[t.sInternal].audioState(t.Modality.State.Connecting);if(Z.hasVideo()){ue(t.Modality.State.Connecting);z(0)[t.sInternal].videoState(t.Modality.State.Connecting)}var a=He().then(function(){if(oe()==t.Modality.State.Disconnected)throw t.EInvitationFailed(oe.reason);o(!L);L=W.createComponent({type:"AVComponent",hide:true});L.event(Ut,"async");return L.load(ie,Z.from.uri(),Z.resource.get("threadId"),false,1,V.audioVideoSecurityLevel())}).then(function(){if(oe()==t.Modality.State.Disconnected)throw t.EInvitationFailed(oe.reason);if(B&&!B.selectedMicrophone())V.setDefaultDevices();Y[t.sInternal].setVideoStream(ve);if(r)pe.source.sink.container(r);if(i)ve.source.sink.container(i);L.invoke("SetCallConfig",V.isInternal()?t.MediaEnum.PreferredMediaAddressType.Direct:t.MediaEnum.PreferredMediaAddressType.Relay);L.invoke("SetAcceptedMedia",3,Me);Wt(Z.offers);ge.status("awaiting an ANSWER_READY event from the media plugin")});return h.waitAll([a,ge.promise]).catch(function(e){R("AudioVideoSession("+Ce+")::accept failed",e);ot();oe(t.Modality.State.Disconnected);se(t.Modality.State.Disconnected);ue(t.Modality.State.Disconnected);ht();if(ge.state()=="pending")ge.reject(e);throw e})}function lt(n){R("AudioVideoSession("+Ce+")::stop",n);if(oe()==t.Modality.State.Connecting){var r=me||ge;if(r){r.promise.cancel();return S.resolve()}else{R("AudioVideoSession("+Ce+"):: stop cannot be called in Connecting state without a pending start or accept");return S.reject(C("stop cannot be called in Connecting state without a pending start or accept"))}}var i=new h;if(n=="video"){if(qe()){z.each(function(e){e.video.channels(0).isStarted(false)})}var a=Ge()?4:3;Me=0;L.invoke("SetMediaConfig",a,Me,qe()?V.maxVideoChannelCount()-1:0,0,0);i.resolve()}else if(n===t.sEscalation||n&&n.code=="NotFound"){ht(n);i.resolve()}else{st();i.from(j.send("GET",J.link("audioVideo").href).then(function(e){var t={query:{reason:"UserInitiatedAction"}};var n=it();if(n)s(t,{headers:{"X-MS-MediaDiagnostics":n}});return j.send("POST",e.link("stopAudioVideo").href,t)}).catch(function(t){F&&F.record(e.TelemetryEvent.Call,{action:"stopAudioVideo",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),reason:t,callId:Ce})}).finally(function(){return ht(n)}))}return i.promise.then(function(){})}function ft(e){if(p(e)){e=e.trim().toLowerCase();e=e.substr(0,1).toUpperCase()+e.substr(1);switch(e){case"*":e="Star";break;case"#":e="Pound";break}if(t.MediaEnum.DtmfTone[e]!==undefined){L.invoke("SendDTMF",t.MediaEnum.DtmfTone[e]);return S.resolve(e)}}throw A("tone","out of range")}function pt(n,r){var i=new S(function(e){if(ue()==t.Modality.State.Connecting){var n=ue.changed(function(r,i,a){if(r!=t.Modality.State.Connecting){n.dispose();e()}})}else e()});return i.then(function(){var i,a;if(ue()!=t.Modality.State.Connected)throw M(ue(),t.Modality.State.Connected);if(Ge()&&!r)throw w("OnHold");R("AudioVideoSession("+Ce+")::showParticipantVideo",n);if(n[t.sInternal].isLocal()){if(n.video.channels(0).isStarted()===false){return we.promise.then(function(){if(Ee)throw Te;we=new h;Me=3;L.invoke("SetMediaConfig",3,Me,qe()?V.maxVideoChannelCount()-1:0,qe()?2:0,0);return yt()}).catch(function(e){R(e);St("reject",e);if(we.state()=="pending")we.resolve();throw e})}return(new h).resolve().promise}else if(qe()){if(!pe._isAttached()){i=pe}else{for(var o=0,s=he();o<s.length;o++){var u=s[o];if(!u._isAttached()){i=u;break}}}if(!i){R("Cannot find available stream");throw I("No available stream")}n[t.sInternal].setVideoStream(i);i._isAttached(true);a=mt(i,false).then(function(){try{L.invoke("Subscribe",i._id(),n[t.sInternal].videoSourceId())}catch(e){R("SUBSCRIBE ERROR: "+e);throw e}}).then(function(){var r=i.source.sink;r._c(r.container.changed(function(e,t,n){if(n)gt(i,false);if(e)mt(i,false)}));r._f(r.format.changed(function(n,a,o){if(n&&i._id()&&r._videoWindow()){L.invoke("SetVideoDisplayOptions",t.MediaEnum.MediaDeviceType.RENDER,r._videoWindow(),r._format(),1);F&&F.record(e.TelemetryEvent.Call,{action:"SetVideoDisplayOptions",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),oldFormat:o,newFormat:n,reason:a,mediaDeviceType:"render",callId:Ce})}}));Qe(n)})}else{a=(new h).reject(C("cannot start remote video in 1:1 conversation")).promise}return a})}function vt(e,n){var r;R("AudioVideoSession("+Ce+")::removeParticipantVideo",e);if(e[t.sInternal].isLocal()){r=we.promise.then(function(){if(Ee)throw Te;we=new h;var e=z(0).video.channels(0);if(!qe()&&!e.isVideoOn())Me=4;else Me=2;L.invoke("SetMediaConfig",3,Me,qe()?V.maxVideoChannelCount()-1:0,qe()?2:0,0);return yt()}).catch(function(e){R(e);St("reject",e);if(we.state()=="pending")we.resolve();throw e})}else if(qe()){r=h.wait(null,"sync").then(function(){var r=e.video.channels(0).stream;var i=r.source.sink;if(i._c())i._c().dispose();if(i._f())i._f().dispose();if(!n)$e(e);if(r._isAttached()){try{L.invoke("Unsubscribe",r._id())}catch(e){R("UNSUBSCRIBE ERROR: "+e)}gt(r,false);r._isAttached(false);e[t.sInternal].setVideoStream(null)}})}else{r=(new h).reject(C("cannot remove remote video in 1:1 conversation")).promise}return r}function ht(n){if(Be()){R("AudioVideoSession("+Ce+")::already cleaned up",n);return}F&&F.record(e.TelemetryEvent.Call,{action:"cleanup",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),reason:n,callId:Ce});var r=t.Modality.State.Disconnected;R("AudioVideoSession("+Ce+")::cleanup",n);if(qe())Fe._set(false);else Fe.set(false);Ge._set(false);Y.audio.isMuted.get();Y.audio.isOnHold.get();Y[t.sInternal].audioOnHold(false);Y[t.sInternal].videoStartedBeforeHold(undefined);j.event.off(Et);if(L){L.event.off(Ut);try{Ze(n);L.invoke("Terminate");L.unload()}catch(e){if(L.state()!=O.State.Unloaded)R("AudioVideoSession("+Ce+"):: AV component cleanup failed",e)}L=null}if(Ne){Ne.dispose();Ne=null}z.each(function(e){e[t.sInternal].setVideoStream(null);if(n!==t.sEscalation){e.video.channels(0)[t.sInternal].isVideoOn(false);e[t.sInternal].setVideoStarted(false)}});if(n!==t.sEscalation){Y.video.channels(0)[t.sInternal].isVideoOn(false);Y[t.sInternal].setVideoStarted(false)}se(r);ue(r,n);if(xe){xe.dispose();xe=null}if(De){De.dispose();De=null}if(Ue){Ue.dispose();Ue=null}Le=null;Ve=null;Ee=false;Be(true)}function mt(e,n){var r=e.source.sink;R("AudioVideoSession("+Ce+")::showVideo:isPreview="+n);if(e._id()&&r.container()){if(r._state()==O.State.Unloaded){return r._init().then(function(){L.invoke("SetVideoWindow",e._id(),n?t.MediaEnum.MediaDeviceType.PREVIEW:t.MediaEnum.MediaDeviceType.RENDER,r._videoWindow(),r._format(),1)})}else{R("AudioVideoSession("+Ce+")::showVideo:sink state:",r._state())}}else{R("AudioVideoSession("+Ce+")::showVideo:stream id:",e._id(),r.container())}return S.resolve()}function gt(e,n){var r=e.source.sink;R("AudioVideoSession("+Ce+")::removeVideo",n);if(e._id()&&r._videoWindow()){L.invoke("RemoveVideoWindow",e._id(),n?t.MediaEnum.MediaDeviceType.PREVIEW:t.MediaEnum.MediaDeviceType.RENDER,r._videoWindow());r._uninit()}else{R("AudioVideoSession("+Ce+")::removeVideo:stream id:",e._id(),r.container())}}function yt(){ye=new h("selfVideo");return ye.promise}function St(e,t){if(ye&&ye.state()=="pending"){if(e=="resolve")ye.resolve();else if(e=="reject")ye.reject(t)}}function bt(){Se=new h(be?"hold":"resume");return Se.promise.then(function(){return be})}function wt(e,t){if(Se&&Se.state()=="pending"){if(e=="resolve")Se.resolve(be);else if(e=="reject")Se.reject(t)}}function Et(e){var t=e.target.rel+" "+e.type;var n=Tt[t];if(n){R("AudioVideoSession("+Ce+")::onServerEvent:",e);n(e.status,e.resource,e)}}var Tt={"audioVideoInvitation started":function(n,r){if(r.get("direction")=="Outgoing"&&r.get("sessionContext")==ne){if(oe()==t.Modality.State.Disconnected){if(r.hasLink("cancel")){var i=j.send("POST",r.link("cancel").href,{nobatch:true});F&&F.monitor(i,e.TelemetryEvent.Call,{action:"cancel",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),callId:Ce})}ht()}else{K=r;if(r.hasLink("reportMediaDiagnostics"))Le=r.link("reportMediaDiagnostics").href;me.status('awaiting "audioVideoNegotiation started or completed" event from UCWA')}}},"conversation added":function(e,t){if(t.get("threadId")==X.threadId())J=t},"audioVideoNegotiation started":function(t,n,r){if(K&&r.sender.href==K.href){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoNegotiationStarted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),hasAnswer:n.hasLink("mediaProvisionalAnswer"),callId:Ce});if(n.hasLink("mediaProvisionalAnswer")){Ft(n.link("mediaProvisionalAnswer").href,n.get("remoteEndpoint"));me.status('awaiting "audioVideoNegotiation completed" event from UCWA')}}},"audioVideoNegotiation completed":function(t,n,r){var i;if(K&&r.sender.href==K.href){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoNegotiationCompleted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:t,reason:r.reason,hasAnswer:n&&n.hasLink("mediaAnswer"),callId:Ce});switch(t){case"Success":i=n.link("audioVideoSession").href;$[i]=$[i]||{};$[i].negotiated=true;Gt(n.link("mediaAnswer").href,n.get("remoteEndpoint"));me.status('awaiting "audioVideoInvitation completed" event from UCWA');break;case"Failure":if(r.reason.subcode!="Ended"&&r.reason.subcode!="ConnectedElsewhere"&&me)me.status(r.reason&&r.reason.message);break}}},"audioVideoSession added":function(t,n){var r=n.href;if(n.get("sessionContext")==ne){$[r]=$[r]||{};$[r].resource=n;if(n.hasLink("publishCallQualityFeedback"))Ve=n.link("publishCallQualityFeedback").href;F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoSessionAdded",type:qe()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",callId:Ce,href:r})}},"audioVideoSession updated":function(e,t){if(t.get("sessionContext")==ne){if(t.hasLink("publishCallQualityFeedback"))Ve=t.link("publishCallQualityFeedback").href}},"audioVideoSession deleted":function(t,n,r){if(r.target.href in $){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoSessionDeleted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:t,reason:r.reason,callId:Ce});delete $[r.target.href];if(ke()==2&&f($)){D.fire("failure");ke(0)}}},"audioVideoInvitation completed":function(n,r,i){if(K&&K.href==r.href&&r.get("direction")=="Incoming"){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoInvitationCompleted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:n,reason:i.reason,sessionContext:r.get("sessionContext",void 0),direction:"Incoming",callId:Ce});if(n=="Success"){try{Xe(r.get("sessionContext"));Ht(n,i.reason);o(!qe());var a=z(0);if(a){a[t.sInternal].audioState(t.Modality.State.Connected);if(ue()==t.Modality.State.Connected){a[t.sInternal].setVideoStream(pe);a[t.sInternal].videoState(t.Modality.State.Connected)}}ge.resolve();oe(t.Modality.State.Connected)}catch(e){ge.reject(e);oe(t.Modality.State.Disconnected)}}else{if(ge)ge.reject(i.reason);oe(t.Modality.State.Disconnected,i.reason)}}},"audioVideoRenegotiation started":function(n,r){if(r.link("audioVideoSession").href in $){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoRenegotiationStarted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:n,hasOffer:r.hasLink("mediaOffer"),direction:r.get("direction",void 0),callId:Ce});if(r.get("direction")=="Incoming"){var i=y(r.link("mediaOffer").href).data;if(!qe()&&z.size()>0){Re=tt(i)?Ae.HoldOffered:Ae.ResumeOffered}Q=r;Ee=true;we.promise.then(function(){jt(i)}).catch(function(e){R(e);ht(e);oe(t.Modality.State.Disconnected,e);Ee=false})}else if(me&&me.state()=="pending"){me.status("Waiting for audioVideoRenegotiation completed event")}else if(ye&&ye.state()=="pending"){ye.status("Waiting for audioVideoRenegotiation completed event")}else if(Se&&Se.state()=="pending"){Se.status("Waiting for audioVideoRenegotiation completed event")}}},"audioVideoRenegotiation completed":function(t,n,r){var i=n.link("audioVideoSession").href;if(i in $){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoRenegotiationCompleted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:t,reason:r.reason,hasAnswer:n.hasLink("mediaAnswer"),operationId:n.get("operationId",void 0),direction:n.get("direction",void 0),callId:Ce});var a;if(n.get("direction")=="Outgoing"){o(n.get("operationId")in re);delete re[n.get("operationId")];try{if(t=="Success"){$[i].renegotiated=true;Gt(n.link("mediaAnswer").href,$[i].resource.get("remoteEndpoint"))}Ht(t,r.reason)}catch(e){t="Failure";a=e}if(t=="Success"){St("resolve");wt("resolve")}else{St("reject",a||r.reason);wt("reject",a||r.reason)}if(me&&me.state()=="pending"){if(t=="Success")me.resolve();else me.reject(a||r.reason)}we.resolve()}else{if(!qe()){if(Re==Ae.HoldAnswered)Re=Ae.HoldCompleted;else if(Re==Ae.ResumeAnswered)Re=Ae.ResumeCompleted}Ht(t,r.reason);Ee=false}}},"audioVideo updated":function(n,r,i){if(K&&K.hasLink("audioVideo")&&r.href==K.link("audioVideo").href){F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoUpdated",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:r.get("state",void 0),status:n,reason:i.reason,callId:Ce});if(r.get("state")=="Disconnected"){ot(i.reason);st();if(K.get("state")=="Connected"){ht();oe(t.Modality.State.Disconnected)}}else if(r.get("state")=="Connected"){if(r.hasLink("reportMediaDiagnostics"))Le=r.link("reportMediaDiagnostics").href;if(qe())ut(r);if(i.reason&&i.reason.subcode=="SessionSwitched"&&r.link("audioVideoSession").href in $){D.fire("success");ke(0)}}}},"participantAudio added":At,"participantAudio updated":At,"participantAudio deleted":At,"participantVideo added":_t,"participantVideo updated":_t,"participantVideo deleted":_t,"escalateAudio deleted":function(e,t,n){if(n.target.href==Pe)Pe=null},"resumeAudio added":xt,"resumeAudioVideo added":xt,"resumeAudio deleted":Dt,"resumeAudioVideo deleted":Dt};function It(e){var r=n(z(),function(n){return n[t.sHref]==e});if(r)return r;if(!qe()&&z.size()==1)return z(0);return j.send("GET",e).then(function(e){return It(e.link("contact").href)})}function Mt(e){var n=e[t.sInternal];return L&&n.isInMediaRoster[L.id()]}function Ct(e,n){try{var r=n=="add"?"AddParticipantInfo":n=="remove"?"RemoveParticipantInfo":n=="update"?"UpdateParticipantInfo":o(false);var i=e[t.sInternal];if(!L)return false;L.invoke(r,i.audioSourceId(),i.videoSourceId(),-1);i.isInMediaRoster[L.id()]=n!="remove";return true}catch(e){R("Media Roster ERROR: "+e);return false}}function At(e,n,r){var i=r["in"];if(J&&r.sender.href==J.href&&i){if(i.rel=="localParticipant"){switch(r.type){case"added":case"updated":if(qe()&&ke()!=1){Y[t.sInternal].setMediaSourceId(r);if(n.has("audioDirection")){}if(n.has("audioMuted")){var a=n.get("audioMuted");Fe.get().then(function(){if(a&&Fe()&&We()){We(false);je(false)}if(a&&!Fe()){Fe._set(a)}if(!a&&Fe()){We(true);je(true)}Y.audio.isMuted.get()})}for(var s=0,u=z();s<u.length;s++){var c=u[s];if(c[t.sInternal].audioSourceId()==-1)kt(c)}}le.audio=true;se(t.Modality.State.Connected);break;case"deleted":le.audio=false;se(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}}else if(i.rel=="participant"){h.wait(It(i.href)).then(function(e){switch(r.type){case"added":case"updated":if(qe()){e[t.sInternal].setMediaSourceId(r);j.send("GET",r.target.href).then(function(n){if(n.has("audioDirection")){e[t.sInternal].audioOnHold(n.get("audioDirection")==_e.Inactive)}if(n.has("audioMuted"))e[t.sInternal].audioMuted(n.get("audioMuted"));if(n.has("audioSourceId"))e[t.sInternal].audioSourceId(+n.get("audioSourceId"))})}e[t.sInternal].audioState(t.Modality.State.Connected);break;case"deleted":e[t.sInternal].audioState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}})}}}function _t(e,n,r){var i=r["in"];if(J&&r.sender.href==J.href&&i){if(i.rel=="localParticipant"){switch(r.type){case"added":case"updated":le.video=true;if(qe()){Y[t.sInternal].setMediaSourceId(r);Ct(Y,Mt(Y)?"update":"add");var a=function(e){if(!Mt(e)){kt(e).then(function(n){if(n!=-1){if(!e.video.channels(0)[t.sInternal].isVideoOn()){Pt(e,"Video").then(function(t){t&&j.send("GET",t).then(function(t){Ot(e,{resource:t},false)})})}Ct(e,"add")}})}};for(var s=0,u=z();s<u.length;s++){var c=u[s];a(c)}Ot(Y,r,true)}else{ue(t.Modality.State.Connected);Y[t.sInternal].videoState(t.Modality.State.Connected)}break;case"deleted":gt(ve,true);le.video=false;if(qe()){if(Mt(Y))Ct(Y,"remove");Y[t.sInternal].setMediaSourceId(r)}Y.video.channels(0)[t.sInternal].isVideoOn(false);Y[t.sInternal].setVideoStarted(false);ue(t.Modality.State.Disconnected);Y[t.sInternal].videoState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}}else if(i.rel=="participant"){h.wait(It(i.href)).then(function(e){switch(r.type){case"added":case"updated":if(qe()){e[t.sInternal].setMediaSourceId(r);Ct(e,Mt(e)?"update":"add");Ot(e,r).then(function(){if(Ge()&&!e.video.channels(0).isVideoOn())$e(e)})}else{e[t.sInternal].setVideoStream(pe);e[t.sInternal].videoState(t.Modality.State.Connected)}break;case"deleted":if(qe()){if(Mt(e))Ct(e,"remove");e[t.sInternal].setMediaSourceId(r);vt(e)}else{e[t.sInternal].setVideoStream(null)}e.video.channels(0)[t.sInternal].isVideoOn(false);e[t.sInternal].setVideoStarted(false);e[t.sInternal].videoState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}})}}}function Rt(e){var n=e.target;if(J&&e.sender.href==J.href&&n.rel=="participant"&&e.type=="deleted"&&!e["in"]){return h.wait(It(n.href)).then(function(n){if(qe()){if(Mt(n))Ct(n,"remove");n[t.sInternal].setMediaSourceId(e);n.video.channels(0)[t.sInternal].isVideoOn(false);n[t.sInternal].setVideoStarted(false);n[t.sInternal].videoState(t.Modality.State.Disconnected);return vt(n)}else{n[t.sInternal].setVideoStream(null)}})}}function Pt(n,r){var i=r.toLowerCase()+"Link";if(n[t.sInternal][i])return S.resolve(n[t.sInternal][i]);if(n[t.sHref]){return j.send("GET",n[t.sHref]).then(function(e){var t="participant"+r;if(e.hasLink(t))return e.link(t).href})}else{F&&F.record(e.TelemetryEvent.Call,{action:"getAudioVideoHref",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),result:"failed",reason:"no href for participant",callId:Ce});return S.resolve()}}function kt(e){var n=e[t.sInternal].audioSourceId()!=-1?S.resolve():Pt(e,"Audio").then(function(e){return e&&j.send("GET",e)}).then(function(n){return n&&n.has("audioSourceId")&&e[t.sInternal].audioSourceId.set(+n.get("audioSourceId"))});return n.then(function(){return e[t.sInternal].audioSourceId()})}function Ot(e,n,r){if(r===void 0){r=false}var i=n.resource;var a=n.target;return h.run(function(){return i&&i.has("videoDirection")?i:a&&j.send("GET",a.href)}).then(function(n){if(n&&n.has("videoSourceId"))e[t.sInternal].videoSourceId(+n.get("videoSourceId"));if(n&&n.has("videoDirection")){var i=n.get("videoDirection");e.video.channels(0)[t.sInternal].isVideoOn(i===_e.SendOnly||i===_e.SendReceive);if(!(i==_e.Inactive||i==_e.Unknown)){if(r)ue(t.Modality.State.Connected);e[t.sInternal].videoState(t.Modality.State.Connected);e[t.sInternal].audioState(t.Modality.State.Connected)}}})}function xt(e,t,n){var r=n["in"],i;if(r&&r.rel=="audioVideoSession"&&r.href in $){i=r.href;$[i].resumeAudioVideoUri=n.target.href;h.wait(null).then(function(){if(!$[i].renegotiated){return j.wait({type:"completed",target:{rel:"audioVideoRenegotiation"},resource:function(e){return e.get("direction")=="Outgoing"&&e.link("audioVideoSession").href in $}})}}).then(function(){Bt()})}}function Dt(e,t,n){var r=n["in"];if(r&&r.rel=="audioVideoSession"&&r.href in $&&n.target.href==$[r.href].resumeAudioVideoUri){delete $[r.href].resumeAudioVideoUri}}function Ut(e){var t=Nt[e.type];if(t){R("AudioVideoSession("+Ce+")::onPluginComponentEvent:",e);t.apply(null,e.args)}}var Nt={CHANNEL_CREATED:function(e,n,r){switch(e){case 1:fe={channelType:e,channelId:n};break;case 2:if(r){
pe._id(n);ve._id(n)}else{he.add(new t.MediaStream({mediaPlugin:W,type:t.MediaEnum.StreamType.Render,id:n}));o(he.size()<V.maxVideoChannelCount());R("Num streams created: "+he.size())}break;default:R("Created a channel of unknown type "+e);break}},CHANNEL_DISCONNECTED:function(e,n,r){if(e===2&&pe._id()===n&&!qe()){Y.video.channels(0)[t.sInternal].isVideoOn(false);z(0).video.channels(0)[t.sInternal].isVideoOn(false);ue(t.Modality.State.Disconnected)}},CHANNEL_DIRECTION_CHANGED:function(e,n,r){if(Re==Ae.HoldCompleted){if(r==4&&!qe())z(0)[t.sInternal].audioOnHold(true);Re=Ae.Unknown}else if(Re==Ae.ResumeCompleted){if(!qe()){z(0)[t.sInternal].audioOnHold(false)}Re=Ae.Unknown}if(e==2&&ve._id()==n){switch(r){case 1:case 3:Y[t.sInternal].setVideoStarted(true);ve._isFlowing(true);Y.video.channels(0)[t.sInternal].isVideoOn(true);break;case 2:case 4:Y[t.sInternal].setVideoStarted(false);ve._isFlowing(false);Y.video.channels(0)[t.sInternal].isVideoOn(false);break;default:Y[t.sInternal].setVideoStarted(false);Y.video.channels(0)[t.sInternal].isVideoOn(false);break}if(!qe()){o(pe._id()==n);Oe(r);switch(r){case 1:case 4:z(0)[t.sInternal].setVideoStarted(false);pe._isFlowing(false);z(0).video.channels(0)[t.sInternal].isVideoOn(false);break;case 2:case 3:z(0)[t.sInternal].setVideoStarted(true);pe._isFlowing(true);z(0).video.channels(0)[t.sInternal].isVideoOn(true);break;default:z(0)[t.sInternal].setVideoStarted(false);z(0).video.channels(0)[t.sInternal].isVideoOn(false);break}}}},MEDIA_CHANGED:function(n,r,i,a){var o;if(n==2){o=t.MediaEnum.enumcastStreamState(a);if(pe._id()==r&&i==2)pe._state(o);else if(ve._id()==r&&i==1){if(o===t.MediaEnum.StreamState.Inactive&&qe()&&z().map(function(e){return e.audio.state()}).filter(function(e){return e===t.Modality.State.Connected}).length===0&&Y.video.channels(0).isVideoOn()){ve._state(t.MediaEnum.StreamState.Active)}else{ve._state(o)}if(1===a){xe=B.selectedCamera.changed(function(e){try{if(e&&L)L.invoke("SetCameraDevice",e.name())}catch(e){R("AudioVideoSession("+Ce+") error handling selectedCamera changed "+e)}},"async")}else if(4===a&&xe){xe.dispose();xe=null}}else{he.each(function(e){if(e._id()==r)e._state(o)})}}else if(n==1&&fe&&r==fe.channelId&&a===2){e.setTimeout(function(){if(i==2){Ue=Ue||B.selectedSpeaker.changed(function(e){try{if(e&&L)L.invoke("SetAudioDevice",t.MediaEnum.MediaDeviceType.SPEAKER,e.name())}catch(e){R("AudioVideoSession("+Ce+") error handling selectedSpeaker changed "+e)}},"async")}else if(i==1){De=De||B.selectedMicrophone.changed(function(e){try{if(e&&L)L.invoke("SetAudioDevice",t.MediaEnum.MediaDeviceType.MIC,e.name())}catch(e){R("AudioVideoSession("+Ce+") error handling selectedMicrophone changed "+e)}},"async")}},500)}},DOMINANT_SPEKAER_CHANGED:function(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}var r=e[1],i,a=de[ce];if(a)a[t.sInternal].isSpeaking(false);if(r==-1){ce=r;return}i=de[r];if(!i){if(Y[t.sInternal].audioSourceId()==r){i=Y}else{z.each(function(e){if(e[t.sInternal].audioSourceId()==r)i=e})}if(i)de[r]=i}if(i){i[t.sInternal].isSpeaking(true);ce=r}},OFFER_READY:function(n,r,i){var a=[];for(var o=3;o<arguments.length;o++){a[o-3]=arguments[o]}F&&F.record(e.TelemetryEvent.Call,{action:"OFFER_READY",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),hasOffer:n,diagCode:r,sdpCount:i,isRenegotiation:!!Ye(),callId:Ce});var s,u=[],c;try{for(s=0;s<i;s++){u.push({sdp:a[s*2],id:a[s*2+1]})}if(u.length==0)throw w("NoSdpOffers",{diagCode:r});c=Ye();if(c){if(!we||we.state()!="pending")we=new h;return S.resolve().then(function(){if(Ee)throw Te;return Vt(u[0].sdp,c)}).catch(function(e){R(e);St("reject",e);wt("reject",e);Ht("Failure",e&&e.code);we.resolve()})}else{me.status("Waiting for audioVideoInvitation completed");Lt(u).then(function(){me.resolve();oe(t.Modality.State.Connected)}).catch(function(e){if(me.state()=="pending")me.reject(e);ht()})}}catch(e){R(e);if(me&&me.state()=="pending")me.reject(e)}},ANSWER_READY:function(t,n){R("SDP Answer:\n"+n);F&&F.record(e.TelemetryEvent.Call,{action:"ANSWER_READY",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),isRenegotiation:!!Q,callId:Ce});if(Q){if(!qe()){if(Re==Ae.HoldOffered)Re=Ae.HoldAnswered;else if(Re==Ae.ResumeOffered)Re=Ae.ResumeAnswered}j.send("POST",Q.link("answer").href,{headers:{"Content-Type":"application/sdp"},data:n,nobatch:true})}else{ge.status("sending answer to UCWA");Z.acceptWithAnswer(n,ne).then(function(){ge.status('awaiting an "audioVideoInvitation completed" event from UCWA')}).catch(function(e){return ge.reject(e)})}},VIDEO_SIZE_CHANGED:function(e,t,n){if(pe.source.sink._videoWindow()==e){pe._setResolution(t,n)}else if(ve.source.sink._videoWindow()==e){ve._setResolution(t,n)}else{for(var r=0,i=he();r<i.length;r++){var a=i[r];if(a.source.sink._videoWindow()==e)a._setResolution(t,n)}}}};function Lt(n){o(n.length>0);function r(e,r,i){var a="9BCE36B8-2C70-44CA-AAA6-D3D332ADBD3F",o,u={nobatch:true};if(qe()){if(Pe){o=t.multipartSDP(n,a);u={headers:{"Content-Type":"multipart/alternative;boundary="+a+';type="application/sdp"',"Content-Length":""+o.length},query:{operationId:te,sessionContext:ne},data:o,nobatch:true}}else{u.data=t.multipartJsonAndSDP({offers:n,boundary:a,operationId:te,sessionContext:ne,threadId:X.threadId(),context:e,contextType:r});u.headers={"Content-Type":"multipart/related;boundary="+a+';type="application/vnd.microsoft.com.ucwa+json"'}}}else{u.data=t.multipartJsonAndSDP({to:i?void 0:ae,offers:n,boundary:a,subject:X.topic(),importance:X.priority(),operationId:te,sessionContext:ne,threadId:X.threadId(),context:e,contextType:r});u.headers={"Content-Type":"multipart/related;boundary="+a+';type="application/vnd.microsoft.com.ucwa+json"'}}if(e!==void 0)s(u.headers,{"X-MS-RequiresMinResourceVersion":2});return u}return a(qt).call(null).then(function(n){var i=r(n.revision>=2?G:void 0,H,n.rel=="addAudioVideo"),a,o;a=j.send("POST",n.href,i).then(function(e){if(!K)K=e}).catch(function(e){R("AudioVideoSession("+Ce+"):sendOffer: startAudioVideo failed",e);if(X.isThreadIdRejectedError(e)){X.resetThreadId();i=r(n.revision>=2?G:void 0,H,n.rel=="addAudioVideo");return j.send("POST",n.href,i)}throw e});o=j.wait({type:"completed",target:{rel:"audioVideoInvitation"},resource:{direction:"Outgoing",threadId:X.threadId(),operationId:te,sessionContext:ne}}).then(function(n){R("AudioVideoSession("+Ce+"):sendOffer: audioVideoInvitation completed",n);F&&F.record(e.TelemetryEvent.Call,{action:"audioVideoInvitationCompleted",type:qe()?"conf":"p2p",modalities:le.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:oe(),status:n.status,reason:n.reason,direction:"Outgoing",callId:Ce});if(n.status=="Failure"){K=n.resource;Ht(n.status,n.reason);throw t.EInvitationFailed(n.reason)}Ht(n.status,n.reason)});return h.waitAll([a,o])})}function Vt(e,t){R("Renegotiation SDP offer:\n",e);var n=r();re[n]="";return j.send("POST",t,{headers:{"Content-Type":"application/sdp"},query:{operationId:n},data:e,nobatch:true})}function Wt(e){o(e.length>=0);var t,n,r=["SetOffer",false,e.length];for(t=0;t<e.length;t++){n=e[t];o("sdp"in n);o("id"in n);r.push(n.sdp);r.push(n.id)}return L.invoke.apply(L,r)}function Bt(){var e=Ge()?4:3;var t=Oe()==4?2:Oe();Me=le.video?Ge()?4:t!=null?t:2:0;var n=Me!=0;L.invoke("SetMediaConfig",e,Me,n?V.maxVideoChannelCount()-1:0,n?2:0,0)}function jt(e){var n="";var r=Ge()?4:3;var i;if(Ge()||!/\bm=video\b/gim.test(e)){i=4}else if(ue()==t.Modality.State.Connected&&(Me==1||Me==3)){i=3}else{i=q&&q.supportsVideo==false?0:2}R("Incoming SDP offer:\n"+e);L.invoke("SetAcceptedMedia",r,i);L.invoke("SetOffer",false,1,e,n)}function Ft(e,t){var n=y(e).data;R("Provisional answer from the remote party:\n"+n);L.invoke("SetProvisionalAnswer",true,true,t,n)}function Gt(e,t){var n=y(e).data;R("Final answer from the remote party:\n"+n);L.invoke("SetFinalAnswer",t,n)}function Ht(e,n){var r;if(L){r=e=="Success"?t.MediaEnum.NegotiationStatus.NS_SUCCESS:n&&n.code=="RemoteFailure"?t.MediaEnum.NegotiationStatus.NS_REMOTE_INTERNAL_ERROR:t.MediaEnum.NegotiationStatus.NS_LOCAL_INTERNAL_ERROR;L.invoke("CompleteNegotiation",r)}}function qt(){if(!J){var e=j.get(j.app.relatedHref("communication")).link("startAudioVideo");e.rel="startAudioVideo";return e}if(Pe)return j.get(Pe);return j.send("GET",J.link("audioVideo").href).then(function(e){var t=e.link("addAudioVideo");t.rel="addAudioVideo";return t})}_(N,t.sInternal,{callId:Ce,onParticipantDeleted:Rt});R("AudioVideoSession("+Ce+") created");return N}return g}();t.AudioVideoSession=x})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.map;var r=e.Utils.async;var i=e.Utils.check;var a=e.Utils.contains;var o=e.Utils.DataUri;var s=e.Utils.HttpHeaders;var u=e.Stack.parseMultipartRelatedResponse;function c(e){var t=e.resource,c=e.ucwa,d=e.from;i.equals(t.rel,"audioVideoInvitation");var l=p();var f={resource:t,acceptWithAnswer:r(v),decline:r(h),offers:l,from:d,hasVideo:function(){return a(l,function(e){return/\bm=video\b/gim.test(e.sdp)})}};function p(){var e,r,i;e=t.relatedHref("mediaOffer");if(!e)return[];r=o(e);try{i=u({status:null,responseText:r.data,headers:{"Content-Type":"multipart/related;boundary="+r.attributes.boundary}});return n(i,function(e){var t=s(e.headers);return{sdp:e.responseText,id:t.get("Content-ID")}})}catch(e){return[{sdp:r.data,id:""}]}}function v(e,n){var r=t.link("acceptWithAnswer").href;return c.send("POST",r,{headers:{"Content-Type":"application/sdp"},query:{sessionContext:n},data:e,nobatch:true})}function h(e){return c.send("POST",t.link("decline").href,{data:{reason:e},nobatch:true})}return f}t.AudioVideoInvitation=c})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t,n,r=window.setTimeout;window.setTimeout=function(e){return e()};var i,a,o;(function(e){var t,n,r,s,u={},c={},d={},l={},f=Object.prototype.hasOwnProperty,p=[].slice,v=/\.js$/;function h(e,t){return f.call(e,t)}function m(e,t){var n,r,i,a,o,s,u,c,l,f,p,h=t&&t.split("/"),m=d.map,g=m&&m["*"]||{};if(e&&e.charAt(0)==="."){if(t){h=h.slice(0,h.length-1);e=e.split("/");o=e.length-1;if(d.nodeIdCompat&&v.test(e[o])){e[o]=e[o].replace(v,"")}e=h.concat(e);for(l=0;l<e.length;l+=1){p=e[l];if(p==="."){e.splice(l,1);l-=1}else if(p===".."){if(l===1&&(e[2]===".."||e[0]==="..")){break}else if(l>0){e.splice(l-1,2);l-=2}}}e=e.join("/")}else if(e.indexOf("./")===0){e=e.substring(2)}}if((h||g)&&m){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(h){for(f=h.length;f>0;f-=1){i=m[h.slice(0,f).join("/")];if(i){i=i[r];if(i){a=i;s=l;break}}}}if(a){break}if(!u&&g&&g[r]){u=g[r];c=l}}if(!a&&u){a=u;s=c}if(a){n.splice(0,s,a);e=n.join("/")}}return e}function g(t,r){return function(){return n.apply(e,p.call(arguments,0).concat([t,r]))}}function y(e){return function(t){return m(t,e)}}function S(e){return function(t){u[e]=t}}function b(n){if(h(c,n)){var r=c[n];delete c[n];l[n]=true;t.apply(e,r)}if(!h(u,n)&&!h(l,n)){throw new Error("No "+n)}return u[n]}function w(e){var t,n=e?e.indexOf("!"):-1;if(n>-1){t=e.substring(0,n);e=e.substring(n+1,e.length)}return[t,e]}r=function(e,t){var n,r=w(e),i=r[0];e=r[1];if(i){i=m(i,t);n=b(i)}if(i){if(n&&n.normalize){e=n.normalize(e,y(t))}else{e=m(e,t)}}else{e=m(e,t);r=w(e);i=r[0];e=r[1];if(i){n=b(i)}}return{f:i?i+"!"+e:e,n:e,pr:i,p:n}};function E(e){return function(){return d&&d.config&&d.config[e]||{}}}s={require:function(e){return g(e)},exports:function(e){var t=u[e];if(typeof t!=="undefined"){return t}else{return u[e]={}}},module:function(e){return{id:e,uri:"",exports:u[e],config:E(e)}}};t=function(t,n,i,a){var o,d,f,p,v,m=[],y=typeof i,w;a=a||t;if(y==="undefined"||y==="function"){n=!n.length&&i.length?["require","exports","module"]:n;for(v=0;v<n.length;v+=1){p=r(n[v],a);d=p.f;if(d==="require"){m[v]=s.require(t)}else if(d==="exports"){m[v]=s.exports(t);w=true}else if(d==="module"){o=m[v]=s.module(t)}else if(h(u,d)||h(c,d)||h(l,d)){m[v]=b(d)}else if(p.p){p.p.load(p.n,g(a,true),S(d),{});m[v]=u[d]}else{throw new Error(t+" missing "+d)}}f=i?i.apply(u[t],m):undefined;if(t){if(o&&o.exports!==e&&o.exports!==u[t]){u[t]=o.exports}else if(f!==e||!w){u[t]=f}}}else if(t){u[t]=i}};i=a=n=function(i,a,o,u,c){if(typeof i==="string"){if(s[i]){return s[i](a)}return b(r(i,a).f)}else if(!i.splice){d=i;if(d.deps){n(d.deps,d.callback)}if(!a){return}if(a.splice){i=a;a=o;o=null}else{i=e}}a=a||function(){};if(typeof o==="function"){o=u;u=c}if(u){t(e,i,a,o)}else{setTimeout(function(){t(e,i,a,o)},4)}return n};n.config=function(e){return n(e)};i._defined=u;o=function(e,t,n){if(!t.splice){n=t;t=[]}if(!h(u,e)&&!h(c,e)){c[e]=[e,t,n]}};o.amd={jQuery:true}})();o("../vendor/almond",function(){});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/constants",["require","exports"],e)}})(function(e,t){t.__esModule=true;t["default"]={MEDIA_STATE:{send:"sendonly",receive:"recvonly",sendReceive:"sendrecv",inactive:"inactive"},MEDIA_DEVICE:{camera:"camera",microphone:"microphone",speaker:"speaker",defaultId:"default"},MEDIA_ERROR:{constraintNotSatisfiedError:"ConstraintNotSatisfiedError",iceConnectionError:"iceConnectionError",srtpError:"srtpError",permissionDeniedError:"permissionDeniedError",internalError:"internalError",sourceUnavailableError:"SourceUnavailableError"},RENEGOTIATION_ERROR:{local:"local",glare:"glare",signaling:"signaling",media:"media",escalation:"escalation"},MSI:{unsubscribe:-1,subscribeAny:-2},MEDIA_LABEL:{audio:"main-audio",video:"main-video",screensharing:"applicationsharing-video"},MEDIA_TYPE:{audio:"audio",video:"video"},MODALITY:{audio:"audio",video:"video",screensharing:"screensharing"},ICE_TRANSPORT_POLICY:{all:"all",relay:"relay"},EXTENSION_TYPE:{dominantSpeakerHistory:"dominantSpeakerHistory"},RENDERER_TYPE:{video:"video",screensharing:"screensharing"}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/utils",["require","exports"],e)}})(function(e,t){function n(e,t){for(var n in e){if(e.hasOwnProperty(n)){t(e[n],n)}}}function r(e,t){var n;e.some(function(r,i){if(t(r,i,e)){n=r;return true}return false});return n}function i(e,t){var n;e.some(function(r,i){if(t(r,i,e)){n=i;return true}return false});return n}function a(e,t){var n=false;for(var r=e.length;r-- >0;){if(t(e[r],r,e)){e.splice(r,1);n=true}}return n}function o(e){var t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push(e[n])}}return t}function s(e){return!Object.keys(e).length}function u(e){var t={};n(e,function(e,n){t[n]=e});return t}function c(e){var t;if(!e||typeof e!=="object"){return e}if(e instanceof Date){t=new Date;t.setTime(e.getTime());return t}if(e instanceof Array){t=[];for(var r=0,i=e.length;r<i;r++){t[r]=c(e[r])}return t}if(e instanceof Object){t={};n(e,function(e,n){t[n]=c(e)});return t}throw new Error("Unable to copy: "+e)}function d(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e()}function l(e,t){var n,r=typeof e,i=typeof t;if(e===t)return true;if(r!==i||r!=="object"&&r!=="function")return false;if(e===null||t===null)return e===t;if(e instanceof Date&&t instanceof Date)return+e==+t;for(n in e){if(!(n in t)||!l(e[n],t[n]))return false}for(n in t){if(!(n in e)||!l(e[n],t[n]))return false}return true}t.__esModule=true;t["default"]={forOwn:n,find:r,findIndex:i,remove:a,values:o,isEmpty:s,shallowClone:u,deepClone:c,uniqueId:d,deepEqual:l}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/helper",["require","exports","./constants","./common/utils"],e)}})(function(e,t){var n=e("./constants");var r=e("./common/utils");function i(e){switch(e){case n["default"].MEDIA_STATE.send:return n["default"].MEDIA_STATE.receive;case n["default"].MEDIA_STATE.receive:return n["default"].MEDIA_STATE.send;default:return e}}function a(e){var t={};var n=i(e.audio);if(n){t.audio=n}var r=i(e.video);if(r){t.video=r}var a=i(e.screensharing);if(a){t.screensharing=a}return t}function o(e){return e===n["default"].MEDIA_STATE.sendReceive?n["default"].MEDIA_STATE.receive:void 0}function s(e){return e===n["default"].MEDIA_STATE.send||e===n["default"].MEDIA_STATE.sendReceive}function u(e){return e===n["default"].MEDIA_STATE.receive||e===n["default"].MEDIA_STATE.sendReceive}function c(e){return e.audio===n["default"].MEDIA_STATE.inactive||e.video===n["default"].MEDIA_STATE.inactive||e.screensharing===n["default"].MEDIA_STATE.inactive}function d(e){var t={};for(var r in n["default"].MEDIA_TYPE){if(n["default"].MEDIA_TYPE.hasOwnProperty(r)){t[n["default"].MEDIA_TYPE[r]]=e}}return t}function l(e,t){var r=s(e)&&s(t),i=u(e)&&u(t);if(r&&i){return n["default"].MEDIA_STATE.sendReceive}else if(r){return n["default"].MEDIA_STATE.send}else if(i){return n["default"].MEDIA_STATE.receive}else if(e===n["default"].MEDIA_STATE.inactive&&t){return n["default"].MEDIA_STATE.inactive}return void 0}function f(e,t){var n={};var r=l(e.audio,t.audio);if(r){n.audio=r}var i=l(e.video,t.video);if(i){n.video=i}var a=l(e.screensharing,t.screensharing);if(a){n.screensharing=a}return n}function p(e,t){return!(!e||!t||e.audio!==t.audio||e.video!==t.video)}function v(e,t,n){function r(e,t,n){var r=s(e)&&s(t)||!s(e)&&!s(n),i=u(e)&&u(t)||!u(e)&&!u(n);return r&&i}return r(e.audio,t.audio,n.audio)&&r(e.video,t.video,n.video)&&r(e.screensharing,t.screensharing,n.screensharing)}function h(e,t){function n(e,t){var n=s(e)===s(t),r=u(e)===u(t);return n&&r}return n(e.audio,t.audio)&&n(e.video,t.video)&&n(e.screensharing,t.screensharing)}function m(){return typeof RTCIceGatherer!=="undefined"}function g(){var e,t,n=true,r=new Promise(function(n,r){e=n;t=r});return{isPending:function(){return n},promise:r,resolve:function(){if(n){e.apply(null,arguments);n=false}},reject:function(e){if(n){t.apply(null,arguments);n=false}}}}function y(e){return new Promise(function(t){setTimeout(t,e)})}function S(e,t,n){var r=new Promise(function(e,r){setTimeout(r.bind(null,new Error("Promise timed out"+(n?": "+n:"")+"after "+t+"ms")),t)});return Promise.race([e,r])}function b(e){var t={dtls:false,sdes:false};t.dtls=!!e.fingerprint;e.media.forEach(function(e){t.dtls=t.dtls||!!e.fingerprint;t.sdes=t.sdes||!!e.crypto});return t}function w(e,t,n){if(!t||r["default"].isEmpty(t)){return e}var i=function(e,r){if(!t[e]){return true}if(n){if(!s(r)&&(!n[e]||n[e]!==r)){return false}}else if(t[e]===r){return false}return true};var a={};r["default"].forOwn(e,function(t,n){if(i(n,t)){a[n]=e[n]}});return a}t.__esModule=true;t["default"]={invertDirectionality:i,invertModalities:a,removeSendDirectionality:o,hasSendDirectionality:s,hasReceiveDirectionality:u,negotiateDirectionality:l,negotiateModalities:f,areModalitiesEqual:p,isOnHold:c,createUniformModalities:d,areNegotiatedDirectionsFulfilled:h,areNegotiatedDirectionsAcceptable:v,isMsBrowser:m,defer:g,delay:y,timeout:S,getSrtpInfo:b,excludePassiveModalities:w}});(function(e){if(typeof exports==="object"&&typeof t!=="undefined"){t.exports=e()}else if(typeof o==="function"&&o.amd){o("microsoft-sdp-transform/lib/sdp-transform",[],e)}else{var n;if(typeof window!=="undefined"){n=window}else if(typeof global!=="undefined"){n=global}else if(typeof self!=="undefined"){n=self}else{n=this}n.sdpTransform=e()}})(function(){var e,t,n;return function e(t,n,r){function i(s,u){if(!n[s]){if(!t[s]){var c=typeof a=="function"&&a;if(!u&&c)return c(s,!0);if(o)return o(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n?n:e)},l,l.exports,e,t,n,r)}return n[s].exports}var o=typeof a=="function"&&a;for(var s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){var r=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w\/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){var t=e.payload==="*"?"%s":"%d";return"rtcp-fb:"+t+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:([\w_\/]*) (\S*)(?: (\S*))?/,names:["value","uri","config"],format:function(e){return e.config!=null?"extmap:%s %s %s":"extmap:%s %s"}},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";t+=e.raddr!=null?" raddr %s rport %d":"%v%v";t+=e.tcptype!=null?" tcptype %s":"%v";if(e.generation!=null){t+=" generation %d"}return t}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="x-candidate-ipv6:%s %d %s %d %s %d typ %s";t+=e.raddr!=null?" raddr %s rport %d":"%v%v";t+=e.tcptype!=null?" tcptype %s":"%v";if(e.generation!=null){t+=" generation %d"}return t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_]*):(.*)/,names:["id","attribute","value"],format:"ssrc:%d %s:%s"},{push:"ssrcGroups",reg:/^ssrc-group:(\w*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/,format:"rtcp-mux"},{name:"rtcpRsize",reg:/^(rtcp-rsize)/,format:"rtcp-rsize"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"label",reg:/^label:(\S*)/,format:"label:%s"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){var t=e.payload==="*"?"%s":"%d";return"x-signaling-fb:"+t+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{push:"invalid",names:["value"]}]};Object.keys(r).forEach(function(e){var t=r[e];t.forEach(function(e){if(!e.reg){e.reg=/(.*)/}if(!e.format){e.format="%s"}})})},{}],2:[function(e,t,n){var r=function(e){return String(Number(e))===e?Number(e):e};var i=function(e,t,n,i){if(i&&!n){t[i]=r(e[1])}else{for(var a=0;a<n.length;a+=1){if(e[a+1]!=null){t[n[a]]=r(e[a+1])}}}};var a=function(e,t,n){var r=e.name&&e.names;if(e.push&&!t[e.push]){t[e.push]=[]}else if(r&&!t[e.name]){t[e.name]={}}var a=e.push?{}:r?t[e.name]:t;i(n.match(e.reg),a,e.names,e.name);if(e.push){t[e.push].push(a)}};var o=e("./grammar");var s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(e){var t={},n=[],r=t;e.split(/(\r\n|\r|\n)/).filter(s).forEach(function(e){var t=e[0];var i=e.slice(2);if(t==="m"){n.push({rtp:[],fmtp:[]});r=n[n.length-1]}for(var s=0;s<(o[t]||[]).length;s+=1){var u=o[t][s];if(u.reg.test(i)){return a(u,r,i)}}});t.media=n;return t};var u=function(e,t){var n=t.split("=");if(n.length===2){e[n[0]]=r(n[1])}return e};n.parseFmtpConfig=function(e){return e.split(/\;\s?/).reduce(u,{})};n.parsePayloads=function(e){return e.split(" ").map(Number)};n.parseRemoteCandidates=function(e){var t=[];var n=e.split(" ").map(r);for(var i=0;i<n.length;i+=3){t.push({component:n[i],ip:n[i+1],port:n[i+2]})}return t}},{"./grammar":1}],3:[function(e,t,n){var r=e("./grammar");var i=/%[sdv%]/g;var a=function(e){var t=1;var n=arguments;var r=n.length;return e.replace(i,function(e){if(t>=r){return e}var i=n[t];t+=1;switch(e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})};var o=function(e,t,n){var r=t.format instanceof Function?t.format(t.push?n:n[t.name]):t.format;var i=[e+"="+r];if(t.names){for(var o=0;o<t.names.length;o+=1){var s=t.names[o];if(t.name){i.push(n[t.name][s])}else{i.push(n[t.names[o]])}}}else{i.push(n[t.name])}return a.apply(null,i)};var s=["v","o","s","i","u","e","p","c","b","t","r","z","a"];var u=["i","c","b","a"];t.exports=function(e,t){t=t||{};if(e.version==null){e.version=0}if(e.name==null){e.name=" "}e.media.forEach(function(e){if(e.payloads==null){e.payloads=""}});var n=t.outerOrder||s;var i=t.innerOrder||u;var a=[];n.forEach(function(t){r[t].forEach(function(n){if(n.name in e&&e[n.name]!=null){a.push(o(t,n,e))}else if(n.push in e&&e[n.push]!=null){e[n.push].forEach(function(e){a.push(o(t,n,e))})}})});e.media.forEach(function(e){a.push(o("m",r.m[0],e));i.forEach(function(t){r[t].forEach(function(n){if(n.name in e&&e[n.name]!=null){a.push(o(t,n,e))}else if(n.push in e&&e[n.push]!=null){e[n.push].forEach(function(e){a.push(o(t,n,e))})}})})});return a.join("\r\n")+"\r\n"}},{"./grammar":1}],"sdp-transform":[function(e,t,n){var r=e("./parser");var i=e("./writer");n.write=i;n.parse=r.parse;n.parseFmtpConfig=r.parseFmtpConfig;n.parsePayloads=r.parsePayloads;n.parseRemoteCandidates=r.parseRemoteCandidates},{"./parser":2,"./writer":3}]},{},[])("sdp-transform")});o("microsoft-sdp-transform",["microsoft-sdp-transform/lib/sdp-transform"],function(e){return e});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/sessionDescriptorUtils",["require","exports","../constants","../common/utils"],e)}})(function(e,t){var n=e("../constants");var r=e("../common/utils");function i(e,t,n){if(e.rtp){e.rtp.some(function(r,i){var a=r.payload;if(t.name.toLowerCase()!==r.codec.toLowerCase()||t.rate!==r.rate||t.encoding!==r.encoding){return false}var o={rtp:r};e.fmtp=e.fmtp||[];var s=e.fmtp.some(function(e){if(r.payload!==e.payload){return false}o.fmtp=e;return true});var u=n(o);if(u===null){e.payloads=e.payloads.toString().split(" ").filter(function(e){return r.payload!==+e}).join(" ");e.fmtp=e.fmtp.filter(function(e){return r.payload!==e.payload});e.rtp.splice(i,1)}else{if(o.rtp.payload!==a){e.payloads=e.payloads.toString().split(" ").map(function(e){return+e===a?o.rtp.payload:+e}).join(" ");if(o.fmtp){o.fmtp.payload=o.rtp.payload}}if(!s&&o.fmtp){e.fmtp.push(o.fmtp)}}return true})}}function a(e,t){var n=-1;e.rtp.forEach(function(e,r){if(t.codec.toLowerCase()===e.codec.toLowerCase()&&t.rate===e.rate&&t.encoding===e.encoding){n=r}});if(n>=0&&e.rtp.length>1){var r=e.rtp[n].payload;e.rtp.splice(n,1);e.payloads=e.payloads.split(" ").filter(function(e){return r!==+e}).join(" ");e.fmtp=e.fmtp.filter(function(e){return r!==e.payload})}}function o(e){if(e.label){if(n["default"].MEDIA_LABEL.audio===e.label){return n["default"].MODALITY.audio}else if(n["default"].MEDIA_LABEL.video===e.label){return n["default"].MODALITY.video}else if(n["default"].MEDIA_LABEL.screensharing===e.label){return n["default"].MODALITY.screensharing}}else{if(n["default"].MEDIA_TYPE.audio===e.type){return n["default"].MODALITY.audio}else if(n["default"].MEDIA_TYPE.video===e.type){return n["default"].MODALITY.video}}return null}function s(e){if(n["default"].MODALITY.audio===e){return n["default"].MEDIA_LABEL.audio}else if(n["default"].MODALITY.video===e){return n["default"].MEDIA_LABEL.video}else if(n["default"].MODALITY.screensharing===e){return n["default"].MEDIA_LABEL.screensharing}return null}function u(e){return e.media.reduce(function(e,t){if(t.port!==0){var r=o(t);if(!(r in e)){var i=t.direction?t.direction.toLowerCase():n["default"].MEDIA_STATE.sendReceive;e[r]=i}}return e},{})}function c(e){return e===n["default"].MODALITY.audio?n["default"].MEDIA_TYPE.audio:n["default"].MEDIA_TYPE.video}function d(e){var t;if(e.groups){var n=r["default"].find(e.groups,function(e){return"BUNDLE"===e.type});if(n){var i=n.mids.split(" ")[0];t=r["default"].find(e.media,function(e){return i===e.mid})}}return t||null}t.__esModule=true;t["default"]={forCodec:i,getModality:o,getModalities:u,removeCodec:a,getLabelForModality:s,getTypeFromModality:c,getBundle:d}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/transform/candidateTransform",["require","exports","../sessionDescriptorUtils"],e)}})(function(e,t){var n=e("../sessionDescriptorUtils");function r(){var e=[{
jsep:"active",msSdp:"tcp-act"},{jsep:"passive",msSdp:"tcp-pass"},{jsep:"so",msSdp:"tcp-so"}];this.fromMsSdp=function(e){e.candidates=e.candidates||[];if(e.xCandidatesIpv6){e.xCandidatesIpv6.forEach(function(t){e.candidates.push(t)});delete e.xCandidatesIpv6}e.candidates.forEach(function(e){r(e,true)})};this.toMsSdp=function(e,n){e.candidates=e.candidates||[];e.candidates.sort(function(t,r){if(t.foundation!==r.foundation){return t.foundation-r.foundation}if(t.component!==r.component){return t.component-r.component}return+a(r,e,n)-+a(t,e,n)});e.candidates=e.candidates.filter(function(t,n){r(t,false);var i=e.candidates[n-1];return!i||i.component!==t.component||i.foundation!==t.foundation});t(e,n)};function t(e,t){if(e.port&&!e.candidates.length){var r=n["default"].getBundle(t);if(r){e.port=r.port;e.connection=r.connection}}}function r(e,t){delete e.generation;if(e.transport.match(/tcp/i)){i(e,t)}}function i(t,n){e.some(function(e){if(n){if(e.msSdp===t.transport.toLowerCase()){t.transport="tcp";t.tcptype=e.jsep;return true}}else if(t.tcptype&&e.jsep===t.tcptype.toLowerCase()){t.transport=e.msSdp;delete t.tcptype;return true}return false})}function a(e,t,n){var r=t.connection||n.connection,i=function(e,t,n){return e.port===n&&e.ip===t};if(!r){return false}if(1===e.component){return i(e,r.ip,t.port)}return t.rtcp?i(e,t.rtcp.ip||r.ip,t.rtcp.port):false}}t.__esModule=true;t["default"]={build:function(){return new r}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/webRtcConstants",["require","exports"],e)}})(function(e,t){t.__esModule=true;t["default"]={STREAM_ID:{audio:"mainAudio",video:"mainVideo",screensharing:"applicationsharingVideo"},STREAM_ID_DELIMITER:"-"}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/transform/streamTransform",["require","exports","../../constants","../../common/utils","../webRtcConstants"],e)}})(function(e,t){var n=e("../../constants");var r=e("../../common/utils");var i=e("../webRtcConstants");var a=[{label:n["default"].MEDIA_LABEL.audio,id:i["default"].STREAM_ID.audio},{label:n["default"].MEDIA_LABEL.video,id:i["default"].STREAM_ID.video},{label:n["default"].MEDIA_LABEL.screensharing,id:i["default"].STREAM_ID.screensharing}].reduce(function(e,t){e[t.label]=t.id;return e},{});var o=r["default"].uniqueId();function s(){this.fromMsSdp=function(i){if(0===i.port){return}if(!u(i)){if(i.ssrcs){n(i.ssrcs,function(e,t){return r(e,t,i.label)})}else{var a=e(i);if(a.length>0){a.forEach(function(e){t(i,e,o,r(a[0],a[0],i.label))})}else if(i.xSsrcRange){t(i,i.xSsrcRange.ssrcMin,o,r(i.xSsrcRange.ssrcMin,i.xSsrcRange.ssrcMin,i.label))}}}delete i.xSsrcRange};this.toMsSdp=function(e){if(0===e.port){return}var t;if(e.ssrcs&&e.ssrcs[0]){t=e.ssrcs[0].id}else if(u(e)){if("audio"===e.type){t=4195875351}else if("video"===e.type){t=1}}if(void 0!==t){e.xSsrcRange={ssrcMin:t,ssrcMax:t}}};function e(e){if(e.ssrcGroups){var t;e.ssrcGroups.some(function(e){if("FID"===e.semantics){t=e;return true}return false});if(t){return t.ssrcs.split(" ").map(function(e){return+e})}}return[]}function t(e,t,n,r){e.ssrcs=e.ssrcs||[];e.ssrcs.push({attribute:"cname",id:t,value:n});e.ssrcs.push({attribute:"msid",id:t,value:r})}function n(e,t){e.filter(function(e){return"msid"===e.attribute}).forEach(function(e){var n=e.value.split(" ");e.value=t(n[0],n[1]||n[0])})}function r(e,t,n){var r=s(n);return r+e+" "+r+t}function s(e){return a[e]?a[e]+i["default"].STREAM_ID_DELIMITER:""}function u(e){return"recvonly"===e.direction}}t.__esModule=true;t["default"]={build:function(){return new s}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/transform/rtcpTransform",["require","exports"],e)}})(function(e,t){function n(){this.toMsSdp=function(e,t,n){if("offer"===n.type){if(e.rtcp){e.rtcp={port:e.port}}}else{delete e.rtcp}}}t.__esModule=true;t["default"]={build:function(){return new n}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/userAgentAdapter",["require","exports"],e)}})(function(e,t){var n=undefined;if(typeof window!=="undefined"&&typeof navigator!=="undefined"){n=window;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;window.MediaStream=window.MediaStream||window.webkitMediaStream||window.mozMediaStream||window.msMediaStream;window.attachMediaStream=function(e,t){if(typeof e.srcObject!=="undefined"){e.srcObject=t}else if(typeof e.src!=="undefined"){e.src=window.URL.createObjectURL(t)}};window.detachMediaStream=function(e){if(typeof e.srcObject!=="undefined"){e.srcObject=null}else if(typeof e.src!=="undefined"){if(e.src){var t=e.src;e.src="";window.URL.revokeObjectURL(t)}}};if(typeof navigator.mozGetUserMedia!=="undefined"&&typeof mozRTCPeerConnection!=="undefined"){window.RTCPeerConnection=mozRTCPeerConnection;window.RTCSessionDescription=mozRTCSessionDescription;var r=function(){var e=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(t){var n=function(e){var t=r.getLocalStreams()||[];return t.find(function(t){var n=("audio"===e.kind?t.getAudioTracks():t.getVideoTracks())||[];return n.some(function(t){return t.id===e.id})})};if("offer"===t.type){var r=this,i=r.getSenders()||[];i.forEach(function(e){var t=e.track,i=n(t);if(i){r.removeTrack(e);r.addTrack(t,i)}})}e.apply(this,arguments)};window.RTCPeerConnection.prototype.getStats=function(){return{}}};r();navigator.getUserMedia=function(e,t,n){return navigator.mozGetUserMedia(e,t,n)}}else if(typeof navigator.webkitGetUserMedia!=="undefined"&&typeof webkitRTCPeerConnection!=="undefined"){window.RTCPeerConnection=webkitRTCPeerConnection;navigator.getUserMedia=function(e,t,n){var r=function(e){if(e&&e.deviceId&&e.deviceId.exact){if(!e.optional){e.optional=[]}e.optional.push({sourceId:e.deviceId.exact});delete e.deviceId}};if(e){r(e.audio);r(e.video)}return navigator.webkitGetUserMedia(e,t,n)}}if(typeof RTCIceGatherer!=="undefined"){var i=function(){return Promise.resolve()};if(!RTCRtpSender.prototype.getStats){RTCRtpSender.prototype.getStats=i}if(!RTCRtpSender.prototype.msGetStats){RTCRtpSender.prototype.msGetStats=i}if(!RTCRtpReceiver.prototype.getStats){RTCRtpReceiver.prototype.getStats=i}if(!RTCRtpReceiver.prototype.msGetStats){RTCRtpReceiver.prototype.msGetStats=i}if(!RTCIceTransport.prototype.getStats){RTCIceTransport.prototype.getStats=i}if(!RTCIceTransport.prototype.msGetStats){RTCIceTransport.prototype.msGetStats=i}if(!RTCRtpReceiver.prototype.getContributingSources){RTCRtpReceiver.prototype.getContributingSources=function(){return[]}}if(!RTCRtpReceiver.prototype.requestSendCSRC){RTCRtpReceiver.prototype.requestSendCSRC=function(){}}}}t.__esModule=true;t["default"]={window:n}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/transform/msSdpTransform",["require","exports","./candidateTransform","./streamTransform","./rtcpTransform","../../helper","../../common/userAgentAdapter","../../constants"],e)}})(function(e,t){var n=e("./candidateTransform");var r=e("./streamTransform");var i=e("./rtcpTransform");var a=e("../../helper");var o=e("../../common/userAgentAdapter");var s=e("../../constants");var u={audio:"main-audio",video:"main-video"};var c={udpTlsRtpSavpf:"UDP/TLS/RTP/SAVPF",rtpSavpf:"RTP/SAVPF",rtpSavp:"RTP/SAVP"};function d(e){this.toMsSdp=h;this.fromMsSdp=m;var t=e.logger,d=e.settings,l=o["default"].window,f=n["default"].build(),p=r["default"].build(),v=i["default"].build();function h(e,n){e.msidSemantic={semantic:"WMS",token:"*"};e.media.forEach(function(r){r.protocol=c.rtpSavp;r.label=r.label||S(r.type);if(r.port===0){for(var i in r){if(r.hasOwnProperty(i)&&["type","port","protocol","payloads"].indexOf(i)<0){delete r[i]}}r.payloads=34}p.toMsSdp(r);if(r.crypto){r.crypto.forEach(function(e){e.config+="|2^31"})}if(r.port!==0&&e.fingerprint){r.fingerprint=e.fingerprint}if(r.fingerprint){if(y(n)){delete r.setup}}f.toMsSdp(r,e);v.toMsSdp(r,e,n);if(r.invalid){t.error("Unknown SDP attributes!",r.invalid);delete r.invalid}g(r,false);if(r.port!==0){if(r.type===s["default"].MEDIA_TYPE.audio&&d.webrtcAudioChannelSignalingFeedback){r.signalingFbXMessage={payload:"*",param:d.webrtcAudioChannelSignalingFeedback}}else if(r.type===s["default"].MEDIA_TYPE.video&&d.webrtcVideoChannelSignalingFeedback){r.signalingFbXMessage={payload:"*",param:d.webrtcVideoChannelSignalingFeedback}}}});delete e.fingerprint;return e}function m(e,t){var n=a["default"].getSrtpInfo(e);for(var r=e.media.length-1;r>=0;--r){var i=e.media[r];if(i.ssrcs&&i.ssrcs[0]||i.xSsrcRange){e.msidSemantic={semantic:"WMS",token:"*"}}i.protocol=c.udpTlsRtpSavpf;if(!n.dtls||n.sdes&&d.preferSdesSrtp){i.protocol=c.rtpSavpf}if(i.port===0){if(!i.direction){i.direction="inactive"}continue}p.fromMsSdp(i);delete i.cryptoscale;if(i.fingerprint){if(y(t)){i.setup="actpass"}}if(i.crypto){for(var o=i.crypto.length-1;o>=0;--o){var s=i.crypto[o];if(s.config.match(/.*\|\d+:\d+/)){i.crypto.splice(o,1);continue}s.config=s.config.replace(/(.*)\|2\^\d+/,"$1")}}if(i.remoteCandidates){delete i.candidates;delete i.xCandidatesIpv6;delete i.remoteCandidates}f.fromMsSdp(i);if(i.rtcpFbXMessage){delete i.rtcpFbXMessage}g(i,true)}return e}function g(e,t){var n=[{name:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",encoded:"http:\\\\www.webrtc.org\\experiments\\rtp-hdrext\\abs-send-time"}];if(e.ext){e.ext.forEach(function(e){n.some(function(n){var r=t?n.encoded:n.name;var i=t?n.name:n.encoded;if(r===e.uri){e.uri=i;return true}return false})})}}function y(e){return"offer"===e.type}function S(e){return u.hasOwnProperty(e)&&u[e]||"undefined"}}t.__esModule=true;t["default"]=d});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/formatParameters",["require","exports","./utils"],e)}})(function(e,t){var n=e("./utils");function r(e){var t={},r=this;this.setIfMissing=function(e,n){if(!r.contains(e)){t[e]=n}};this.get=function(e){return t[e]};this.contains=function(e){return t.hasOwnProperty(e)};this.toString=function(){var e="";n["default"].forOwn(t,function(t,n){e+=(e?";":"")+n;if(typeof t!=="undefined"){e+="="+t}});return e};(function(){if(e){e.split(";").forEach(function(e){var n=e.split("=");t[n[0]]=n[1]})}})()}t.__esModule=true;t["default"]={build:function(e){return new r(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/webRtcSessionDescription",["require","exports","microsoft-sdp-transform","../constants","../helper","./transform/msSdpTransform","../common/formatParameters","./sessionDescriptorUtils"],e)}})(function(e,t){var n=e("microsoft-sdp-transform");var r=e("../constants");var i=e("../helper");var a=e("./transform/msSdpTransform");var o=e("../common/formatParameters");var s=e("./sessionDescriptorUtils");function u(e,t,u,c){var d=e.settings,p=e.mediaManager,v=e.sdpTransform,h=e.logger,m=n.parse(u),g=new a["default"](e),y;this.getModalities=function(){return y||s["default"].getModalities(m)};this.updateModalities=function(e){y=e};this.getSrtpInfo=function(){return i["default"].getSrtpInfo(m)};this.getVideoCodecs=function(){var e=[];m.media.forEach(function(t){if("video"===t.type){e=t.rtp.map(function(e){return e.codec.toLowerCase()})}});return e};function S(e){e.media.forEach(function(e,t){var n=p.getMediaEntity(t);if(r["default"].MEDIA_TYPE.video!==n.getType()){return}s["default"].forCodec(e,{name:"h264",rate:9e4},function(e){var t=n.getVideoCapabilities();if(!t){return}e.fmtp=e.fmtp||{payload:e.rtp.payload};var r=o["default"].build(e.fmtp.config);r.setIfMissing("max-fs",t.getMaxFS());r.setIfMissing("max-fps",t.getMaxFPS());e.fmtp.config=r.toString()});return true})}this.usePrimaryAudioCodecOnly=function(e){var t=["cn","telephone-event"];m.media.forEach(function(n){if(r["default"].MEDIA_TYPE.audio===n.type){var i=n.rtp.filter(function(n){return e.indexOf(n.codec.toLowerCase())!==-1&&t.indexOf(n.codec.toLowerCase())===-1});if(i.length===0){throw new Error("there is no matching primary audio codec")}var a=n.rtp.filter(function(e){return e!==i[0]&&t.indexOf(e.codec.toLowerCase())===-1});a.forEach(function(e){s["default"].removeCodec(n,e)})}})};this.isCodecSwitchSupported=function(){return!m.media.some(function(e){return r["default"].MEDIA_TYPE.audio===e.type&&e.xMediaSettings&&b(e.xMediaSettings,"codecswitchunsupported")})};function b(e,t){return e.some(function(e){return e.settings.indexOf(t)!==-1})}this.toOffer=function(){f(m,function(e,t){l(d,t)});if(p.isEmpty()){p.fromOffer(m,y)}p.syncModalities(y,false);m=v.toOffer(m,p,y);if(!d.disableMsSdp){g.toMsSdp(m,{type:t})}S(m);y=s["default"].getModalities(m);return n.write(m)};this.toAnswer=function(){f(m,function(e,t){l(d,t)});p.syncModalities(y,true);m=v.toAnswer(m,p,y);if(!d.disableMsSdp){g.toMsSdp(m,{type:t})}S(m);y=s["default"].getModalities(m);return n.write(m)};this.toRemote=function(e){y=e;p.fromRemote(m,y);m=v.toRemote(m,p,y);return n.write(m)};this.getVideoRecvCapabilities=function(){var e={};m.media.filter(function(e){return"video"===e.type}).some(function(t){s["default"].forCodec(t,{name:"h264",rate:9e4},function(t){if(t.fmtp){var n=o["default"].build(t.fmtp.config);var r=n.get("max-fs");if(!isNaN(r)&&r){e.maxFS=+r}var i=n.get("max-fps");if(!isNaN(i)&&i){e.maxFPS=+i/100}}});return true});return e};this.needToWaitIceCandidates=function(){if(e.bundled){var t=s["default"].getBundle(m);return t&&t.port===9}return m.media.some(function(e){return e.port===9})};function w(){if("answer"===t&&m.groups){e.bundled=true}}(function(){if(c&&!d.disableMsSdp){g.fromMsSdp(m,{type:t})}w()})()}function c(e,t,r,i){var o=e.settings,s=new a["default"](e),u=n.parse(r);f(u,function(e,t){if(t.port!==0&&!i[e]){d(t)}t.direction="inactive";l(o,t)});if(!o.disableMsSdp){s.toMsSdp(u,{type:t})}return n.write(u)}function d(e){e.port=0;for(var t in e){if(e.hasOwnProperty(t)&&["type","port","protocol","payloads","connection","direction"].indexOf(t)<0){delete e[t];e.direction="inactive"}}}function l(e,t){if(t.candidates&&(e.iceCandidateType||e.iceCandidateTransport)){t.candidates=t.candidates.filter(function(t){var n=true,r=true;if(e.iceCandidateType){n=t.type.match(new RegExp(e.iceCandidateType),"i")}if(e.iceCandidateTransport){r=t.transport.match(new RegExp(e.iceCandidateTransport,"i"))}return n&&r})}}function f(e,t){for(var n=0;n<e.media.length;n++){if(e.media[n].type==="audio"){t(r["default"].MEDIA_TYPE.audio,e.media[n])}else if(e.media[n].type==="video"){t(r["default"].MEDIA_TYPE.video,e.media[n])}}}t.__esModule=true;t["default"]={build:function(e){e=e||{};return{createLocalOffer:function(t){return new u(e,"offer",t)},createRemoteOffer:function(t){return new u(e,"offer",t,true)},createLocalAnswer:function(t){return new u(e,"answer",t)},createRemoteAnswer:function(t){return new u(e,"answer",t,true)},createInactiveOfferSdp:c.bind(null,e,"offer"),createInactiveAnswerSdp:c.bind(null,e,"answer")}}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/adapter/webkitSessionDescription",["require","exports","../../common/userAgentAdapter"],e)}})(function(e,t){var n=e("../../common/userAgentAdapter");var r="rollback";function i(){var e=[].slice.apply(arguments);var t=e[0]&&a(e[0].type);e.splice(0,t?1:0,null);var i=new(Function.prototype.bind.apply(n["default"].window.RTCSessionDescription,e));var o=Object.getOwnPropertyDescriptor(n["default"].window.RTCSessionDescription.prototype,"type");Object.defineProperty(i,"type",{get:function(){return t?r:o.get.call(i)},set:function(e){t=a(e);if(!t){o.set.call(i,e)}}});return i}function a(e){return r===e}t.__esModule=true;t["default"]={build:function(){return i}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/adapter/webkitPeerConnection",["require","exports","microsoft-sdp-transform","../sessionDescriptorUtils","../../common/formatParameters","./webkitSessionDescription","../../common/userAgentAdapter","../../common/utils"],e)}})(function(e,t){var n=e("microsoft-sdp-transform");var r=e("../sessionDescriptorUtils");var i=e("../../common/formatParameters");var a=e("./webkitSessionDescription");var o=e("../../common/userAgentAdapter");var s=e("../../common/utils");var u=[{name:"telephone-event",rate:8e3},{name:"cn",rate:16e3}];function c(e){var t,c,d,l,f=[];l=a["default"].build();t=[].slice.apply(arguments);t.splice(0,1,null);p("iceTransportPolicy","iceTransports");c=new(Function.prototype.bind.apply(o["default"].window.webkitRTCPeerConnection,t));v();function p(e,n){if(t[1]&&t[1][e]){t[1][n]=t[1][e]}}function v(){h();b();S();w();y();g()}function h(){[{name:"createOffer",reverseArgs:true},"createAnswer","setRemoteDescription","setLocalDescription"].forEach(function(e){var t=e.name||e,n=c[t];c[t]=function(){var t=arguments;return new Promise(function(r,i){var a=[r,i];if(t.length>0){a.splice(e.reverseArgs?a.length:0,0,t[0])}n.apply(c,a)})}})}function m(e,t){var n;Object.defineProperty(this,"dtmf",{get:function(){if("audio"===e.kind){n=n||c.createDTMFSender(e);return n}return null}});this.track=e;this._stream=t}function g(){if(c.getSenders&&c.addTrack&&c.removeTrack){return}c.getSenders=function(){return f.slice()};c.addTrack=function(e,t){if(!e||!t){throw new Error("both media track and stream need to be provided")}var n=c.getLocalStreams().some(function(e){return e.id===t.id});if(!n){c.addStream(t)}var r=s["default"].find(f,function(t){return t.track.id===e.id});if(!r){r=new m(e,t);f.push(r)}return r};c.removeTrack=function(e){c.getLocalStreams().filter(function(t){return t.id===e._stream.id}).forEach(c.removeStream.bind(c));s["default"].remove(f,function(t){return t===e})}}function y(){var e=c.createOffer;c.createOffer=function(t){var n=arguments;if(t&&t.offerToReceiveVideo>1){t.offerToReceiveVideo=1}return e.apply(c,n)}}function S(){var e=c.setLocalDescription;c.setLocalDescription=function(t){var n=function(){if(!d||!c.remoteDescription){return Promise.reject(new Error("rollback requires having both remote and local descriptions set"))}var t=new l({type:"answer",sdp:c.remoteDescription.sdp});return e(d).then(function(){return c.setRemoteDescription(t)})};if("rollback"===t.type){if("have-local-offer"===c.signalingState){return n()}return Promise.reject(new Error("rollback is supported only from have-local-offer state"))}if("stable"===c.signalingState&&c.localDescription){d=new l({type:"offer",sdp:c.localDescription.sdp})}return e(t)}}function b(){["createOffer","createAnswer","setLocalDescription"].forEach(function(t){var n=c[t];c[t]=function(){var t=arguments;return e.gather("video").then(function(){return n.apply(n,t)})}});var t=c.setRemoteDescription;c.setRemoteDescription=function(i){return e.gather("video").then(function(e){var a=e.codecs;var o=n.parse(i.sdp);o.media.forEach(function(e){if("video"===e.type){var t=e.rtp.some(function(e){return a.some(function(t){return e.codec.toLowerCase()===t.mimeType})});if(!t){e.port=0}else{E(e)}}if(!T(e)){var n=r["default"].getBundle(o);if(n){e.crypto=n.crypto}else if(!e.port){o.media.some(function(t){if(t.port){e.crypto=t.crypto;return true}return false})}}});i.sdp=n.write(o);return t(i)})}}function w(){var e=c.createAnswer;c.createAnswer=function(){var t=arguments;return e.apply(c,t).then(function(e){if(!c.localDescription||!c.localDescription.sdp){return e}var t=n.parse(c.localDescription.sdp);var i=[];t.media.forEach(function(e){u.forEach(function(t){r["default"].forCodec(e,t,function(e){i.push(e)})})});if(i.length){var a=n.parse(e.sdp);var o=false;a.media.forEach(function(e){i.forEach(function(t){r["default"].forCodec(e,{name:t.rtp.codec,rate:t.rtp.rate},function(e){if(e.rtp.payload!==t.rtp.payload){e.rtp.payload=t.rtp.payload;o=true}})})});if(o){e=new l({type:e.type,sdp:n.write(a)})}}return e})}}function E(e){r["default"].forCodec(e,{name:"h264",rate:9e4},function(e){if(e.fmtp){var t=i["default"].build(),n=i["default"].build(e.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach(function(e){if(n.contains(e)){t.setIfMissing(e,n.get(e))}});e.fmtp.config=t.toString()}})}function T(e){return"RTP/SAVPF"!==e.protocol}return c}t.__esModule=true;t["default"]={build:function(e){return c.bind(null,e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/adapter/webkitCapabilityGatherer",["require","exports","microsoft-sdp-transform","../../common/userAgentAdapter"],e)}})(function(e,t){var n=e("microsoft-sdp-transform");var r=e("../../common/userAgentAdapter");function i(e){var t=this,i=r["default"].window.webkitRTCPeerConnection,a;this.gather=function(e){if("video"!==e&&"audio"!==e){return Promise.reject(new Error("capabilities for "+e+" are not supported"))}if(!a.gatherTask){a.gatherTask=new Promise(function(e,t){var r=new i(null);r.createOffer(function(t){var i={},a=n.parse(t.sdp);a.media.forEach(function(e){i[e.type]=e.rtp.map(function(e){return{mimeType:e.codec.toLowerCase()}})});r.close();return e(i)},function(e){a.gatherTask=null;r.close();t(e)},{offerToReceiveVideo:1,offerToReceiveAudio:1})})}return a.gatherTask.then(function(t){return{codecs:t[e]}})};(function(){a=e.global.webkitCapabilityGatherer=e.global.webkitCapabilityGatherer||{};t.gather("video")})()}t.__esModule=true;t["default"]={build:function(e){return new i(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/transform/webkitSdpTransform",["require","exports","../sessionDescriptorUtils","../../constants","../../common/utils"],e)}})(function(e,t){var n=e("../sessionDescriptorUtils");var r=e("../../constants");var i=e("../../common/utils");function a(){function e(e){n["default"].removeCodec(e,{codec:"g722",rate:8e3,encoding:2})}function t(e){if(!e.groups){return null}return i["default"].find(e.groups,function(e){return e.type==="BUNDLE"})}function a(e,t,n){return{type:e,port:0,label:t,payloads:36,protocol:n}}function o(e,t,o,s){var c=e.getMid();var d=e.getModality();var l=i["default"].deepClone(t);l.label=n["default"].getLabelForModality(d);l.direction=s;l.mid=c;l.ssrcs=[];l.ssrcGroups=[];if(s===r["default"].MEDIA_STATE.send||s===r["default"].MEDIA_STATE.sendReceive){var f=i["default"].find(o,function(e){return e.modality===d});var p=[],v=[];if(f){var h=t.ssrcs.filter(function(e){return e.attribute==="msid"&&f.track===u(e.value)}).map(function(e){return e.id});if(t.ssrcs){p=t.ssrcs.filter(function(e){return h.indexOf(e.id)>-1})}if(t.ssrcGroups){v=t.ssrcGroups.filter(function(e){var t=e.ssrcs.split(" ");return i["default"].find(t,function(e){return h.indexOf(+e)>-1})})}}else if(s===r["default"].MEDIA_STATE.send||s===r["default"].MEDIA_STATE.send){return a(t.type,n["default"].getLabelForModality(d),t.protocol)}l.ssrcs=p;l.ssrcGroups=v}return l}function s(e,s,u,c){var d=i["default"].deepClone(e);var l=i["default"].find(d.media,function(e){return e.type===r["default"].MEDIA_TYPE.audio});var f=i["default"].find(d.media,function(e){return e.type===r["default"].MEDIA_TYPE.video});var p={};p[r["default"].MODALITY.audio]=l;p[r["default"].MODALITY.video]=f;p[r["default"].MODALITY.screensharing]=f;var v={};v[r["default"].MODALITY.audio]=s.getMediaEntitiesByModality(r["default"].MODALITY.audio)[0];v[r["default"].MODALITY.video]=s.getMediaEntitiesByModality(r["default"].MODALITY.video)[0];v[r["default"].MODALITY.screensharing]=s.getMediaEntitiesByModality(r["default"].MODALITY.screensharing)[0];d.media=[];s.getMediaEntities().forEach(function(e){var t;var i=u[e.getModality()];if(e.isEnabled()&&p[e.getModality()].port!==0&&(e===v[e.getModality()]||i!==r["default"].MEDIA_STATE.send)){if(e!==v[e.getModality()]){i=r["default"].MEDIA_STATE.receive}t=o(e,p[e.getModality()],s.getMediaTracks(),i);if(e!==v[e.getModality()]){t.candidates=[]}}else{t=a(e.getType(),n["default"].getLabelForModality(e.getModality()),p[e.getModality()].protocol)}if(t.port===0){e.disable()}d.media.push(t)});var h=t(d);if(h){h.mids=d.media.map(function(e){return e.mid}).filter(function(e){return e}).join(" ")}return d}function u(e){return e.split(" ")[1]}this.toOffer=function(e,t,n){return s(e,t,n,true)};this.toAnswer=function(e,t,n){return s(e,t,n,false)};function c(e,t){if(e===r["default"].MEDIA_STATE.sendReceive||t===r["default"].MEDIA_STATE.sendReceive){return r["default"].MEDIA_STATE.sendReceive}if(e===t){return e}if(e&&t&&e!==t){return r["default"].MEDIA_STATE.sendReceive}return e||t}this.toRemote=function(o,s,u){var d=i["default"].deepClone(o),l=null,f=null,p=t(d);d.media.forEach(function(e,t){var n=s.getMediaEntity(t);if(n.isDisabled()){e.port=0}});if(!p){var v={};d.media.forEach(function(e,t){var n=s.getMediaEntity(t);if(n.getType()in v){n.disable();e.port=0}else{v[n.getType()]=true}})}d.media.forEach(function(e){var t=n["default"].getModality(e);if(u[t]===r["default"].MEDIA_STATE.send){if(!e.direction||e.direction.toLowerCase()!==r["default"].MEDIA_STATE.receive){e.direction=r["default"].MEDIA_STATE.receive}}});var h=i["default"].find(d.media,function(e){return e.type===r["default"].MEDIA_TYPE.audio});if(h){if(h.port!==0){l=i["default"].deepClone(h);l.mid="audio";delete l.label;e(l)}else{l=a(r["default"].MEDIA_TYPE.audio,undefined,h.protocol)}}var m=d.media.filter(function(e){return e.type===r["default"].MEDIA_TYPE.video});if(m.length>0){var g=m.filter(function(e){return e.port!==0});if(g.length>0){f=i["default"].deepClone(g[0]);f.mid="video";f.direction=null;delete f.label;f.ssrcs=[];f.ssrcGroups=[];g.forEach(function(e){if(e.ssrcs){f.ssrcs=f.ssrcs.concat(e.ssrcs)}if(e.ssrcGroups){f.ssrcGroups=f.ssrcGroups.concat(e.ssrcGroups)}f.direction=c(f.direction,e.direction||r["default"].MEDIA_STATE.sendReceive)})}else{f=a(r["default"].MEDIA_TYPE.video,undefined,m[0].protocol)}}d.media=[l,f].filter(function(e){return e});if(s.getMediaEntities()[0].getModality()!==r["default"].MODALITY.audio){d.media.reverse()}if(p){p.mids=d.media.map(function(e){return e.mid}).filter(function(e){return e}).join(" ")}return d}}t.__esModule=true;t["default"]={build:function(){return a}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/adapter/webkitAdapter",["require","exports","./webkitPeerConnection","./webkitSessionDescription","./webkitCapabilityGatherer","../transform/webkitSdpTransform"],e)}})(function(e,t){var n=e("./webkitPeerConnection");var r=e("./webkitSessionDescription");var i=e("./webkitCapabilityGatherer");var a=e("../transform/webkitSdpTransform");function o(e){var t=i["default"].build(e);this.SdpTransform=a["default"].build();this.RTCPeerConnection=n["default"].build(t);this.RTCRtpReceiver={getCapabilities:t.gather};this.RTCSessionDescription=r["default"].build()}t.__esModule=true;t["default"]={build:function(e){return new o(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/adapter/webrtcAdapter",["require","exports","./webkitAdapter","../../common/userAgentAdapter"],e)}})(function(e,t){var n=e("./webkitAdapter");var r=e("../../common/userAgentAdapter");function i(){function e(){throw new Error("unsupported platform")}this.SdpTransform=e;this.RTCPeerConnection=e;this.RTCSessionDescription=e;this.RTCRtpReceiver=e}function a(e,t,n){this.SdpTransform=o;this.RTCPeerConnection=e;this.RTCSessionDescription=t;this.RTCRtpReceiver=n}function o(){function e(e){return e}this.toOffer=e;this.toAnswer=e;this.toRemote=e}function s(){return typeof r["default"].window.webkitRTCPeerConnection!=="undefined"}function u(){return typeof r["default"].window.mozRTCPeerConnection!=="undefined"}t.__esModule=true;t["default"]={build:function(e){if(s()){return n["default"].build(e)}if(u()){return new a(r["default"].window.mozRTCPeerConnection,r["default"].window.RTCSessionDescription,r["default"].window.RTCRtpReceiver)}return new i}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/videoCapabilities",["require","exports"],e)}})(function(e,t){var n=function(){function e(e,t){this.maxFS=e;this.maxFPS=t}e.prototype.setMaxFS=function(e,t){if(this.maxFS!==e){this.maxFS=e;if(t){t(this);return true}}return false};e.prototype.getMaxFS=function(){return this.maxFS};e.prototype.getMaxFPS=function(){return this.maxFPS};return e}();t.VideoCapabilities=n;t.__esModule=true;t["default"]={build:function(e,t){return new n(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/mediaManager",["require","exports","./sessionDescriptorUtils","../constants","../common/utils","./videoCapabilities"],e)}})(function(e,t){var n=e("./sessionDescriptorUtils");var r=e("../constants");var i=e("../common/utils");var a=e("./videoCapabilities");var o=function(){function e(e,t,n,r,i,a,o){this.modality=e;this.mid=t;this.mtype=n;this.streamId=r;this.xSourceStreamId=i;this.renderer=a;this.videoCapabilities=o}e.create=function(t,i,o,s){var u=n["default"].getTypeFromModality(o);var c=null;if(u===r["default"].MEDIA_TYPE.video){c=a["default"].build(t.webrtcVideoCapabilityMaxFS||1200,t.webrtcVideoCapabilityMaxFPS||3e3)}var d=new e(o,s,u,null,null,null,c);i.mediaEntityCreated(d);return d};e.prototype.clone=function(){return new e(this.modality,this.mid,this.mtype,this.streamId,this.xSourceStreamId,this.renderer,this.videoCapabilities)};e.prototype.getModality=function(){return this.modality};e.prototype.getType=function(){return this.mtype};e.prototype.getMid=function(){return this.mid};e.prototype.disable=function(){this.mid=null};e.prototype.enable=function(e,t){this.modality=e;this.mid=t};e.prototype.isDisabled=function(){return!this.mid};e.prototype.isEnabled=function(){return!!this.mid};e.prototype.getVideoCapabilities=function(){return this.videoCapabilities};e.prototype.getRenderer=function(){return this.renderer};e.prototype.setRenderer=function(e){this.renderer=e};e.prototype.getStreamId=function(){return this.streamId};e.prototype.setStreamId=function(e){this.streamId=e};e.prototype.getXSourceStreamId=function(){return this.xSourceStreamId};e.prototype.setXSourceStreamId=function(e){this.xSourceStreamId=e};return e}();t.MediaEntity=o;var s=function(){function e(e,t){this.mediaEntities=[];this.mediaEntitiesBackup=[];this.midId=0;this.mediaTracks=[];this.logger=e.logger;this.settings=e.settings;this.numVideoChannels=e.numVideoChannels;this.listener=t}e.prototype.generateMid=function(e){return"media_"+e};e.prototype.fromOffer=function(e,t){var n=this;e.media.forEach(function(e){
if(e.type===r["default"].MEDIA_TYPE.audio){if(r["default"].MODALITY.audio in t){n.addMediaEntity(r["default"].MODALITY.audio)}}else if(e.type===r["default"].MEDIA_TYPE.video){if(r["default"].MODALITY.video in t){for(var i=0;i<n.numVideoChannels;i++){n.addMediaEntity(r["default"].MODALITY.video)}}if(r["default"].MODALITY.screensharing in t){n.addMediaEntity(r["default"].MODALITY.screensharing)}}})};e.prototype.fromRemote=function(e,t){var r=this;e.media.forEach(function(e,a){var o=n["default"].getModality(e);if(e.port===0||!(o in t)){if(r.mediaEntities[a]){r.mediaEntities[a].disable()}else{r.addDisabledMediaEntity(o)}r.mediaEntities[a].setStreamId(null)}else{if(r.mediaEntities[a]){r.mediaEntities[a].enable(o,e.mid||r.generateMid(a))}else{r.addMediaEntity(o,e.mid||r.generateMid(a))}if(e.ssrcs){var s=i["default"].find(e.ssrcs,function(e){return e.attribute==="msid"});if(!s){r.logger.warn("No ssrc msid for media of type "+e.type+" with mid "+e.mid)}else{r.mediaEntities[a].setStreamId(s.value.split(" ")[0])}}r.mediaEntities[a].setXSourceStreamId(e.xSourceStreamId)}})};e.prototype.isEmpty=function(){return this.mediaEntities.length===0};e.prototype.addMediaEntity=function(e,t){this.mediaEntities.push(o.create(this.settings,this.listener,e,t||this.generateMid(this.mediaEntities.length)))};e.prototype.addDisabledMediaEntity=function(e){this.mediaEntities.push(o.create(this.settings,this.listener,e,null))};e.prototype.getMediaEntities=function(){return this.mediaEntities};e.prototype.getMediaEntity=function(e){return this.mediaEntities[e]};e.prototype.getMediaEntityByMid=function(e){return i["default"].find(this.mediaEntities,function(t){return t.getMid()===e})};e.prototype.getMediaEntitiesByModality=function(e){return this.mediaEntities.filter(function(t){return t.getModality()===e})};e.prototype.getMediaEntitiesByRenderer=function(e){return this.mediaEntities.filter(function(t){return t.getRenderer()===e})};e.prototype.getMediaEntityByStreamId=function(e){return i["default"].find(this.mediaEntities,function(t){return t.getStreamId()===e})};e.prototype.reset=function(){this.mediaEntities=[]};e.prototype.syncModalities=function(e,t){this.disableModalities(e);if(!t){this.enableModalities(e);this.addModalities(e)}};e.prototype.enableModalities=function(e){var t=this;this.mediaEntities.forEach(function(n,r){if(n.getModality()in e&&n.isDisabled()){n.enable(n.getModality(),t.generateMid(r))}})};e.prototype.disableModalities=function(e){this.mediaEntities.forEach(function(t){if(!(t.getModality()in e)){t.disable()}})};e.prototype.addModalities=function(e){var t={};this.mediaEntities.map(function(e){return e.getModality()}).forEach(function(e){t[e]=true});for(var n in e){if(!(n in t)){this.addMediaEntity(n)}}};e.prototype.setMediaTracks=function(e){this.mediaTracks=e};e.prototype.getMediaTracks=function(){return this.mediaTracks};e.prototype.backup=function(){var e=this;this.mediaEntitiesBackup=[];this.mediaEntities.forEach(function(t){e.mediaEntitiesBackup.push(t.clone())})};e.prototype.commit=function(){this.mediaEntitiesBackup=[]};e.prototype.rollback=function(){this.mediaEntities=this.mediaEntitiesBackup};return e}();t.__esModule=true;t["default"]={build:function(e,t){return new s(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/statistics/webrtcStatistics",["require","exports","../../helper"],e)}})(function(e,t){var n=e("../../helper");function r(e,t){var r,i,a,o=false,s=t.logger.createChild("WebrtcStatistics"),u={localStreams:[],remoteStreams:[],webrtc:{CorrelationId:e,Extensions:{WebRTCStats:{},OfferedSrtp:"none",NegotiatedSrtp:"none",IceConnectionState:"none",SignalingState:"none",AudioTransportRecvBitrate:0,AudioTransportSendBitrate:0,AudioPayloadSendBitrate:0,AudioPayloadRecvBitrate:0,VideoPayloadSendBitrate:0,VideoPayloadRecvBitrate:0,TimerAudioTransportRecvBitrate:0,TimerAudioTransportSendBitrate:0,TimerAudioPayloadRecvBitrate:0,TimerAudioPayloadSendBitrate:0,TimerVideoPayloadRecvBitrate:0,TimerVideoPayloadSendBitrate:0,StartTime:(new Date).getTime(),EndTime:(new Date).getTime()}}},c=this;this.setIceConnectionState=function(e){u.webrtc.Extensions.IceConnectionStatePrevious=u.webrtc.Extensions.IceConnectionState;u.webrtc.Extensions.IceConnectionState=e};this.setSignalingConnectionState=function(e){u.webrtc.Extensions.SignalingStatePrevious=u.webrtc.Extensions.SignalingState;u.webrtc.Extensions.SignalingState=e};function d(e){if(!u.webrtc.Extensions.WebRTCStats.ssrc_audio_send||!u.webrtc.Extensions.WebRTCStats.ssrc_audio_recv||!u.webrtc.Extensions.WebRTCStats.ssrc_video_send||!u.webrtc.Extensions.WebRTCStats.ssrc_video_recv){return false}function t(e,t){if(e&&(!t||t!==-1)){return(new Date).getTime()}return 0}u.webrtc.Extensions.TimerAudioPayloadRecvBitrate=n["default"].hasReceiveDirectionality(e.audio)?t(u.webrtc.Extensions.WebRTCStats.ssrc_audio_recv.bytesReceived,u.webrtc.Extensions.TimerAudioPayloadRecvBitrate):-1;u.webrtc.Extensions.TimerAudioPayloadSendBitrate=n["default"].hasSendDirectionality(e.audio)?t(u.webrtc.Extensions.WebRTCStats.ssrc_audio_send.bytesSent,u.webrtc.Extensions.TimerAudioPayloadSendBitrate):-1;u.webrtc.Extensions.TimerVideoPayloadRecvBitrate=n["default"].hasReceiveDirectionality(e.video)?t(u.webrtc.Extensions.WebRTCStats.ssrc_video_recv.bytesReceived,u.webrtc.Extensions.TimerVideoPayloadRecvBitrate):-1;u.webrtc.Extensions.TimerVideoPayloadSendBitrate=n["default"].hasSendDirectionality(e.video)?t(u.webrtc.Extensions.WebRTCStats.ssrc_video_send.bytesSent,u.webrtc.Extensions.TimerVideoSendBitrate):-1;u.webrtc.Extensions.TimerAudioTransportRecvBitrate=n["default"].hasReceiveDirectionality(e.audio)?t(u.webrtc.Extensions.WebRTCStats.ssrc_audio_recv.bytesReceived,u.webrtc.Extensions.TimerAudioTransportRecvBitrate):-1;u.webrtc.Extensions.TimerAudioTransportSendBitrate=n["default"].hasSendDirectionality(e.audio)?t(u.webrtc.Extensions.WebRTCStats.ssrc_audio_send.bytesSent,u.webrtc.Extensions.TimerAudioTransportSendBitrate):-1;if(u.webrtc.Extensions.TimerVideoPayloadRecvBitrate&&u.webrtc.Extensions.TimerVideoPayloadSendBitrate&&u.webrtc.Extensions.TimerAudioPayloadRecvBitrate&&u.webrtc.Extensions.TimerAudioPayloadSendBitrate&&u.webrtc.Extensions.TimerAudioTransportRecvBitrate&&u.webrtc.Extensions.TimerAudioTransportSendBitrate){return true}return false}function l(){return new Promise(function(e){if(r){r.getStats(function(t){u.webrtc.Extensions.WebRTCStats=p(t);e()},function(t){s.error("detectStreamStart getreport getstats failure",t);e()})}else{e()}}).catch(function(e){s.log("detectCallStart error",e)})}var f=void 0;this.startWaitingForStreamStart=function(e,t){if(!a&&!t){f=e}if(a&&!t){return}a=true;l().then(function(){setTimeout(function(){if(d(e)||o){a=false;return}c.startWaitingForStreamStart(f,true)},1e3)}).catch(function(e){s.error("startWaitingForStreamStart error",e)})};this.setNegotiatedModalities=function(e){i=e;f=e};this.setPeerConnection=function(e){r=e};this.setReport=function(e){u=e};this.getCachedReport=function(){return u};this.setTerminated=function(){u.webrtc.Extensions.EndTime=(new Date).getTime();o=true};this.calculateAverages=function(){var e=u.webrtc.Extensions.EndTime;function t(t,n){if(t&&e-n&&n!==-1){return Math.round(t*8/(e-n))}return 0}function n(e,t){return t.split(".").reduce(function(e,t){return typeof e==="undefined"||e===null?e:e[t]},e)}u.webrtc.Extensions.AudioPayloadRecvBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_audio_recv.bytesReceived"),u.webrtc.Extensions.TimerAudioPayloadRecvBitrate);u.webrtc.Extensions.AudioPayloadSendBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_audio_send.bytesSent"),u.webrtc.Extensions.TimerAudioPayloadSendBitrate);u.webrtc.Extensions.VideoPayloadRecvBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_video_recv.bytesReceived"),u.webrtc.Extensions.TimerVideoPayloadRecvBitrate);u.webrtc.Extensions.VideoPayloadSendBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_video_send.bytesSent"),u.webrtc.Extensions.TimerVideoPayloadSendBitrate);u.webrtc.Extensions.AudioTransportRecvBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_audio_send.pair.bytesReceived"),u.webrtc.Extensions.TimerAudioTransportRecvBitrate);u.webrtc.Extensions.AudioTransportSendBitrate=t(n(u.webrtc.Extensions.WebRTCStats,"ssrc_audio_send.pair.bytesSent"),u.webrtc.Extensions.TimerAudioTransportSendBitrate)};function p(e){var t={};function n(e){if(e.result){e.result().forEach(function(e){if(e){e.names().forEach(function(n){t[e.type]=t[e.type]||{};t[e.type][e.id]=t[e.type][e.id]||{};t[e.type][e.id][n]=e.stat(n)});t[e.type][e.id].id=e.id}})}}var r=["codecImplementationName","googFrameHeightReceived","googFrameWidthReceived","googNacksSent","googRenderDelayMs","googTargetDelayMs","googPlisSent","googFrameRateDecoded","googFrameRateOutput","googMinPlayoutDelayMs","googMaxDecodeMs","googFrameRateReceived","googCaptureStartNtpTimeMs","googFirsSent","googDecodeMs","googCodecName","googCurrentDelayMs","audioInputLevel","transportId","audioOutputLevel","id","googCodecName","googEchoCancellationEchoDelayMedian","googEchoCancellationEchoDelayStdDev","googEchoCancellationQualityMin","googEchoCancellationReturnLoss","googEchoCancellationReturnLossEnhancement","googJitterReceived","googRtt","googTypingNoiseState","mediaType","packetsLost","packetsSent","bytesReceived","bytesSent","googAccelerateRate","googCaptureStartNtpTimeMs","googCurrentDelayMs","googDecodingCNG","googDecodingCTN","googDecodingCTSG","googDecodingNormal","googDecodingPLC","googDecodingPLCCNG","googExpandRate","googJitterBufferMs","googPreemptiveExpandRate","googPreferredJitterBufferMs","googSecondaryDecodedRate","googSpeechExpandRate","packetsReceived"];var i=["dtlsCipher","googComponent","id","srtpCipher","selectedCandidatePairId"];var a=["bytesSent","bytesReceived","googActiveConnection","googChannelId","googLocalCandidateType","googReadable","googRemoteCandidateType","id","googRtt","googTransportType","googWritable","packetsDiscardedOnSend","packetsSent"];var o=["googActualEncBitrate","googAvailableReceiveBandwidth","googAvailableSendBandwidth","googBucketDelay","googRetransmitBitrate","googTargetEncBitrate","googTransmitBitrate"];function s(e,t){var n={};for(var r in e){if(e.hasOwnProperty(r)){if(t.indexOf(r)!==-1){n[r]=e[r]}}}return n}function u(e){var n={};n=s(e,r);if(e.hasOwnProperty("transportId")){var o=t["googComponent"][e.transportId];n["transport"]=s(o,i);if(o.hasOwnProperty("selectedCandidatePairId")){var u=t["googCandidatePair"][o.selectedCandidatePairId];n["pair"]=s(u,a)}}return n}n(e);var c={};if(!t["ssrc"]){return{}}for(var d in t["ssrc"]){if(t["ssrc"][d].hasOwnProperty("transportId")){var l=t["ssrc"][d];var f=l.id.replace(/[0-9]+/,l.mediaType||"audio");c[f]=u(l)}}if(t["VideoBwe"]&&t["VideoBwe"]["bweforvideo"]){c["bweStat"]={};var p=s(t["VideoBwe"]["bweforvideo"],o);for(var v in p){if(p.hasOwnProperty(v)){c["bweStat"][v]=p[v]}}}return c}this.getWebrtcReport=function(e){return p(e)};this.setNegotiatedSrtpInfo=function(e){u.webrtc.Extensions.NegotiatedSrtp=v(e)};this.setOfferedSrtpInfo=function(e){u.webrtc.Extensions.OfferedSrtp=v(e)};this.getReport=function(){return new Promise(function(e){if(r){if(i){u.localStreams=h(r.getLocalStreams(),{audio:n["default"].hasSendDirectionality(i.audio),video:n["default"].hasSendDirectionality(i.video)});u.remoteStreams=h(r.getRemoteStreams(),{audio:n["default"].hasReceiveDirectionality(i.audio),video:n["default"].hasReceiveDirectionality(i.video)})}try{r.getStats(function(t){u.webrtc.Extensions.WebRTCStats=p(t);c.calculateAverages();e(u)},function(t){u.webrtc.Extensions.WebRTCStats={getStatsError:t};s.error("getreport getstats resolve error",t);e(u)})}catch(t){u.webrtc.Extensions.WebRTCStats={getStatsError:t};s.error("getreport getstats catch error",t);e(u)}}else{s.log("getreport else resolve");e(u)}})};function v(e){var t="";if(e.dtls){t+="dtls"}if(e.sdes){t+="sdes"}return t}function h(e,t){var n=[];e.forEach(function(e){var r={tracks:[]};n.push(r);e.getTracks().forEach(function(n){if("audio"===n.kind&&t.audio||"video"===n.kind&&t.video){r.tracks.push({stream:e,track:n})}})});return n}}t.__esModule=true;t["default"]={build:function(e,t){return new r(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/dtmfUtils",["require","exports"],e)}})(function(e,t){t.defaultSettings={toneDuration:200,toneGap:100};var n=function(){function e(e){this.queue=[];this.logger=e}e.prototype.cleanup=function(){this.queue.forEach(function(e){e.reject({notSent:e.tones})});this.queue=[]};e.prototype.waitForNotification=function(e){var t=this;if(!e){return Promise.reject(new Error("invalid input"))}this.logger.log("sending dtmf tones: ",e);return new Promise(function(n,r){t.queue.push({tones:e,resolve:n,reject:r})})};e.prototype.toneSent=function(e){if(this.queue[0]){if(e===this.queue[0].tones[0]){this.queue[0].tones=this.queue[0].tones.substr(1);if(this.queue[0].tones===""){this.queue[0].resolve();this.queue.shift()}}else{this.queue[0].reject(new Error("sent tone does not match: expected '"+this.queue[0].tones[0]+"' got '"+e+"'"));this.queue.shift();this.toneSent(e)}}};return e}();t.DTMFQueue=n});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/webRtcDtmfSender",["require","exports","../common/dtmfUtils"],e)}})(function(e,t){var n=e("../common/dtmfUtils");var r=function(){function e(e,t){this.webRtcSender=null;this.queue=new n.DTMFQueue(e);this.settings=t?t:n.defaultSettings}e.prototype.sendDtmf=function(e,t){if(!e||!e.getSenders){return Promise.reject(new Error("bad peerConnection"))}this.syncSender(e);if(!this.webRtcSender){return Promise.reject(new Error("not available"))}this.webRtcSender.ontonechange=this.onToneChange.bind(this);this.webRtcSender.insertDTMF(this.webRtcSender.toneBuffer+t,this.settings.toneDuration,this.settings.toneGap);return this.queue.waitForNotification(t)};e.prototype.canSendDtmf=function(e){if(!e||!e.getSenders){return false}this.syncSender(e);return this.webRtcSender?this.webRtcSender.canInsertDTMF:false};e.prototype.dispose=function(){this.queue.cleanup()};e.prototype.syncSender=function(e){var t=e.getSenders().filter(function(e){return e.dtmf&&e.dtmf.canInsertDTMF})[0];if(this.webRtcSender&&t&&t.dtmf!=this.webRtcSender){this.webRtcSender.ontonechange=null;this.queue.cleanup()}this.webRtcSender=t?t.dtmf:null};e.prototype.onToneChange=function(e){if(e.tone){this.queue.toneSent(e.tone)}};return e}();t.WebRtcDTMFSender=r;t.__esModule=true;t["default"]={build:function(e,t){return new r(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/remoteStreamManager",["require","exports","../constants","../common/utils"],e)}})(function(e,t){var n=e("../constants");var r=e("../common/utils");var i=function(){function e(e){this.listener=e;this.streams={};this.currStream={};for(var t in n["default"].MODALITY){this.streams[t]=[];this.currStream[t]=0}}e.prototype.addStream=function(e,t){if(!t){return}if(this.streams[t].indexOf(e)===-1){this.streams[t].push(e);this.listener.streamAdded(e,t)}};e.prototype.removeStream=function(e){for(var t in this.streams){if(r["default"].remove(this.streams[t],function(t){return t===e})){this.listener.streamRemoved(e,t);return}}};e.prototype.getStream=function(e){var t=this.currStream[e]++%this.streams[e].length;return this.streams[e][t]};return e}();t.RemoteStreamManager=i;t.__esModule=true;t["default"]={build:function(e){return new i(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/device/videoRenderer",["require","exports"],e)}})(function(e,t){function n(e,t){var n=document.createElement("video"),r=0,i=0,a=null,o=function(){if(t&&t.onVideoSizeChanged){var e=n.videoWidth,a=n.videoHeight;if(e<32||a<32){e=a=0}if(r!==e||i!==a){r=e;i=a;t.onVideoSizeChanged(e,a)}}},s=function(){if(t&&t.onError){t.onError(n?n.error:"no video")}};n.autoplay=true;n.muted=true;this.getVideoElement=function(){return n};this.dispose=function(){c();n=null};this.reattachEventListeners=function(){c();u()};this.attachMediaStream=d;function u(){n.addEventListener("loadedmetadata",o);n.addEventListener("timeupdate",o);n.addEventListener("error",s)}function c(){n.removeEventListener("loadedmetadata",o);n.removeEventListener("timeupdate",o);n.removeEventListener("error",s);d(null)}function d(t){if(a===t){return}if(a){if(!t){e.removeChild(n)}window.detachMediaStream(n)}if(t){n.hidden=t.getVideoTracks().length===0;window.attachMediaStream(n,t);if(!a){e.appendChild(n)}}a=t}(function(){u()})()}t.__esModule=true;t["default"]=n});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/webRtcVideoSizeTracker",["require","exports","../common/userAgentAdapter"],e)}})(function(e,t){var n=e("../common/userAgentAdapter");var r=function(e,t){var r=n["default"].window,i,a={width:e.offsetWidth,height:e.offsetHeight};function o(){return a.width!==e.offsetWidth||a.height!==e.offsetHeight}function s(){a.width=e.offsetWidth;a.height=e.offsetHeight}this.onSizeChange=function(n){if(i){return}var a=Math.floor(Math.random()*Math.abs(t.interval.max-t.interval.min))+t.interval.min;i=r.setInterval(function(){if(o()){s();n(e.offsetWidth,e.offsetHeight)}},a)};this.dispose=function(){if(i){r.clearInterval(i)}}};t.__esModule=true;t["default"]={build:function(e,t){return new r(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/resolutionTable",["require","exports"],e)}})(function(e,t){var n=function(){function e(){var e=this;this.MACROBLOCK_SIZE=16;this.resolutions=[{width:320,height:180},{width:426,height:240},{width:640,height:360},{width:960,height:540},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}];this.table=this.resolutions.map(function(t){return{width:t.width,height:t.height,fs:Math.ceil(t.width/e.MACROBLOCK_SIZE)*Math.ceil(t.height/e.MACROBLOCK_SIZE)}})}e.prototype.getResolution=function(e){for(var t=this.table.length-1;t>=0;t--){if(this.table[t].fs<=e){return this.table[t]}}return this.table[0]};e.prototype.getMaxFS=function(e,t){var n=Math.max(e,t);var r=Math.min(e,t);for(var i=0;i<this.table.length;i++){if(this.table[i].width>=n&&this.table[i].height>=r){return this.table[i].fs}}return this.table.slice(-1)[0].fs};e.prototype.getResolutions=function(){return this.resolutions};return e}();t.__esModule=true;t["default"]={build:function(){return new n}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/remoteRendererManager",["require","exports","../constants","../common/utils","../device/videoRenderer","./webRtcVideoSizeTracker","./resolutionTable","../helper"],e)}})(function(e,t){var n=e("../constants");var r=e("../common/utils");var i=e("../device/videoRenderer");var a=e("./webRtcVideoSizeTracker");var o=e("./resolutionTable");var s=e("../helper");function u(e,t){var u=this;var c=e.settings;var d=e.logger;var l=e.streamManager;var f=e.mediaManager;var p=t;var v=o["default"].build();var h=[];var m=function(e,o){i["default"].call(this,e,o);var u=this;var f;var p=this.dispose;var v=null;var m,g;var y;function S(){if(!c.webrtcVideoCapabilityCheckIntervalMin||!c.webrtcVideoCapabilityCheckIntervalMax){d.info("skipping video size tracking");return}f=a["default"].build(u.getVideoElement(),{interval:{min:c.webrtcVideoCapabilityCheckIntervalMin,max:c.webrtcVideoCapabilityCheckIntervalMax}});f.onSizeChange(function(e,n){console.log("video renderer size changed, updating capabilities");m=e;g=n;t.rendererSizeChanged(u,e,n)})}this._updateStream=function(){if(!y){return}var e=l.getStream(y);u.attachMediaStream(e);if(v){v.resolve();v=null}};this._rejectPendingSubscription=function(){if(v){v.reject(new Error("renderer subscription rejected"));v=null}t.rendererUnsubscribed(u)};this.subscribeVideoAsync=function(e,r){d.info("subscribeVideoAsync","msi:",e);y=r?n["default"].RENDERER_TYPE.screensharing:n["default"].RENDERER_TYPE.video;return new Promise(function(e){u._rejectPendingSubscription();if(h.indexOf(u)===-1){h.push(u);t.rendererSubscribed(u)}S();var n=l.getStream(y);if(!n){d.warn("subscribeVideoAsync","could not get stream","rendererType",y);v=s["default"].defer();e(v.promise)}else{u.attachMediaStream(n);d.info("subscribeVideoAsync","subscribed","rendererType",y,"streamId:",n.id);e()}})};this.dispose=function(){if(f){f.dispose()}this._rejectPendingSubscription();r["default"].remove(h,function(e){return e===u});p()};this.getModality=function(){return y};this.getWidth=function(){return m};this.getHeight=function(){return g}};this.unsubscribeAll=function(){h.forEach(function(e){e._rejectPendingSubscription()});h=[]};this.stopRenderers=function(){h.forEach(function(e){e._updateStream()})};this.stopVideoRenderers=function(e){h.filter(function(t){return t.getModality()===e}).forEach(function(e){e._updateStream()})};this.startVideoRenderers=function(e){h.filter(function(t){return t.getModality()===e}).forEach(function(e){e._updateStream()})};this.createRemoteRenderer=function(e,t){return new m(e,t)};this.getRenderersByModality=function(e){return h.filter(function(t){return t.getModality()===e})||[]}}t.__esModule=true;t["default"]={build:function(e,t){return new u(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/extensions/dominantSpeakerHistoryExtension",["require","exports"],e)}})(function(e,t){var n="DominantSpeakerInfo";var r=function(){function e(){this.notificationType=n;this.manager=null;this.callback=null}e.prototype.initialize=function(e,t){if(!e){return}this.manager=e;this.manager.addNotificationListener(this,this.notificationType);if(t&&t.callback){this.callback=t.callback}};e.prototype.dispose=function(){this.manager.removeNotificationListener(this,this.notificationType);this.manager=null;this.callback=null};e.prototype.onNotification=function(e){var t=e;this.processInfo(t)};e.prototype.processInfo=function(e){if(!this.callback){return}this.callback(e.previousDominantSpeakerHistory)};return e}();t.__esModule=true;t["default"]=r});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/extensions/extensionFactory",["require","exports","./dominantSpeakerHistoryExtension","../constants"],e)}})(function(e,t){var n=e("./dominantSpeakerHistoryExtension");var r=e("../constants");var i=function(){function e(){}e.getExtension=function(e){if(e=r["default"].EXTENSION_TYPE.dominantSpeakerHistory){return new n["default"]}throw new Error("Extension of type "+e+" is not found")};return e}();t.__esModule=true;t["default"]=i});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/extensions/extensionsManager",["require","exports","./extensionFactory"],e)}})(function(e,t){var n=e("./extensionFactory");var r=function(){function e(){this.extensions=[];this.listeners={}}e.prototype.dispose=function(){this.extensions=null;this.listeners=null};e.prototype.addExtension=function(e,t){var r=n["default"].getExtension(e);r.initialize(this,t);this.extensions.push(r)};e.prototype.processNotification=function(e,t){var n=this.listeners[e];if(n){n.forEach(function(e){e.onNotification(t)})}};e.prototype.addNotificationListener=function(e,t){if(!this.listeners[t]){this.listeners[t]=[]}this.listeners[t].push(e)};e.prototype.removeNotificationListener=function(e,t){var n=this.listeners[t];if(!n){return}var r=n.indexOf(e);if(r>=0){n.splice(r,1)}if(!n.length){delete this.listeners[t]}};return e}();t.__esModule=true;t["default"]=r});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/activeSpeaker/activeSpeakerManager",["require","exports"],e)}})(function(e,t){var n=function(){function e(e,t){this.onActiveSpeakersChanged=e;this.onDominantSpeakersChanged=t}e.prototype.setStrategy=function(e){this.dshStrategy=e;if(this.dshStrategy){this.dshStrategy.setOnDominantSpeakerChanged(this.onDominantSpeakerHistoryChanged.bind(this))}};e.prototype.onContributingSourcesChanged=function(e){this.onActiveSpeakersChanged(e);if(this.dshStrategy){this.dshStrategy.setSources(e)}};e.prototype.onDominantSpeakerHistoryChanged=function(e){this.onDominantSpeakersChanged(e)};e.prototype.dispose=function(){if(this.dshStrategy){this.dshStrategy.dispose();this.dshStrategy=null}this.onActiveSpeakersChanged=null;this.onDominantSpeakersChanged=null};return e}();t.ActiveSpeakerManager=n});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/render/audioRenderer",["require","exports","../../common/userAgentAdapter","../../common/utils"],e)}})(function(e,t){var n=e("../../common/userAgentAdapter");var r=e("../../common/utils");var i=function(){function e(e){this.window=n["default"].window;this.logger=e.logger.createChild("audio")}e.prototype.play=function(e){if(!this.audio){this.audio=document.createElement("audio");document.body.appendChild(this.audio);this.audio.autoplay=true;this.audio.addEventListener("error",this.onAudioError)}else{this.window.detachMediaStream(this.audio)}this.logger.log("starting playout");this.window.attachMediaStream(this.audio,e);this.stream=e};e.prototype.stop=function(){if(this.audio){this.logger.log("stopping playout");this.audio.removeEventListener("error",this.onAudioError);document.body.removeChild(this.audio);this.window.detachMediaStream(this.audio);this.audio=null;this.stream=null}};e.prototype.getStream=function(){return this.stream};e.prototype.dispose=function(){this.stop()};e.prototype.onAudioError=function(e){if(e){this.logger.error("error event occured:",this.toString(e))}else{this.logger.error("error event occured","error:",this.audio?this.audio.error:"<no audio element>")}};e.prototype.toString=function(e){if(e){var t={};r["default"].forOwn(e,function(e,n){try{t[n]=typeof e==="function"?t[n]=e():t[n]=e}catch(e){t[n]="error: "+e}});return JSON.stringify(t)}};return e}();t.__esModule=true;t["default"]=i});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/webrtc/webRtcSession",["require","exports","../constants","../helper","./webRtcSessionDescription","./adapter/webrtcAdapter","./mediaManager","./statistics/webrtcStatistics","../common/utils","./webRtcDtmfSender","./remoteStreamManager","./remoteRendererManager","./resolutionTable","../extensions/extensionsManager","../common/activeSpeaker/activeSpeakerManager","./render/audioRenderer"],e)}})(function(e,t){var n=e("../constants");var r=e("../helper");var i=e("./webRtcSessionDescription");var a=e("./adapter/webrtcAdapter");var o=e("./mediaManager");var s=e("./statistics/webrtcStatistics");var u=e("../common/utils");var c=e("./webRtcDtmfSender");var d=e("./remoteStreamManager");var l=e("./remoteRendererManager");var f=e("./resolutionTable");var p=e("../extensions/extensionsManager");var v=e("../common/activeSpeaker/activeSpeakerManager");var h=e("./render/audioRenderer");var m=function(e,t,m){this.configureModalitiesAsync=ge;this.createOfferAsync=Se;this.processOfferAsync=we;this.createAnswerAsync=Te;this.processAnswerAsync=Me;this.completeNegotiationAsync=Ce;this.rejectNegotiationAsync=Ae;this.createRemoteRenderer=_e;this.getStatsAsync=De;this.terminate=Pe;this.sendDtmf=Ue;this.canSendDtmf=Ne;this.onNegotiationRequired=null;this.onSessionErrorOccurred=null;this.getExtensionsManager=Le;this._deviceSelectionChanged=Re;this._onTerminated=null;var g=this;var y=e.maContext.settings;var S=e.getLogger().createChild("webrtc");var b=e.getDeviceManager();var w=a["default"].build({global:e.maContext});var E=o["default"].build({logger:S,settings:y,numVideoChannels:e.config&&e.config.isConference&&y.numVideoChannelsGvc?y.numVideoChannelsGvc:1},{mediaEntityCreated:te});var T=f["default"].build();var I=i["default"].build({sdpTransform:new w.SdpTransform,mediaManager:E,settings:y,logger:S});var M=null;var C;var A=null;var _=null;var R=r["default"].defer();var P=false;var k=true;var O=false;var x;var D={};var U;var N;var L;var V=null;var W=s["default"].build(t,{logger:S});var B=Promise.resolve({});var j=false;var F=false;var G=c["default"].build(S,y.dtmf);var H=d["default"].build({streamAdded:re,streamRemoved:ie});var q=l["default"].build({settings:y,logger:S,streamManager:H,mediaManager:E,session:this},{rendererSubscribed:$,rendererUnsubscribed:Z,rendererSizeChanged:ee});var z=Promise.resolve();var Y=e.config.passiveModalities;var X={};var J=null;var K=new v.ActiveSpeakerManager(m.onContributingSourcesChanged,m.onDominantSpeakerChanged);var Q=new h["default"]({logger:S});function $(e){var t=E.getMediaEntitiesByModality(e.getModality())[0];if(t){t.setRenderer(e)}}function Z(e){var t=E.getMediaEntitiesByRenderer(e)[0];if(t){t.setRenderer(null)}}function ee(e,t,n){var r=T.getMaxFS(t,n);var i=E.getMediaEntitiesByRenderer(e)[0];if(!i||!i.getVideoCapabilities()){S.warn("no capabilities for provided modality:",e.getModality());return}i.getVideoCapabilities().setMaxFS(r,function(){me(true)})}function te(e){var t=q.getRenderersByModality(e.getModality())[0];e.setRenderer(t);if(t){ee(t,t.getWidth(),t.getHeight())}}function ne(e){S.error("Media error occurred","type:",e.type,"detail:",e.detail);if(g.onSessionErrorOccurred){g.onSessionErrorOccurred(e)}}function re(e,t){if(n["default"].MODALITY.audio===t){Q.play(e)}else if(n["default"].MODALITY.video===t||n["default"].MODALITY.screensharing===t){q.startVideoRenderers(t)}else{S.warn("unsupported stream modality:",t)}}function ie(e,t){if(n["default"].MODALITY.audio===t){if(Q.getStream()===e){Q.stop()}}else if(n["default"].MODALITY.video===t||n["default"].MODALITY.screensharing===t){q.stopVideoRenderers(t)}else{S.warn("unsupported stream modality:",t)}}function ae(e){D=e;W.setNegotiatedModalities(e)}function oe(){S.log("reset candidate gathering");R.promise.then(function(){},function(){});R.reject(new Error("reset candidate gathering"));R=r["default"].defer()}function se(){R.resolve()}function ue(){S.log("reset peer connection");q.stopRenderers();Q.dispose();if(G){G.dispose();G=null}if(M){M.close()}ke();M=null;C=null;oe();k=true;D={}}function ce(){if(!y.iceDisconnectedTimeoutMs){return}V=setTimeout(function(){S.error("ice disconnected for ",y.iceDisconnectedTimeoutMs,"ms. Raise CONSTANTS.MEDIA_ERROR.iceConnectionError");ne({type:n["default"].MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"})},y.iceDisconnectedTimeoutMs)}function de(){if(V){clearTimeout(V);V=null}}function le(e){return e.reduce(function(e,t){t.addresses.map(function(n){function r(e,r){return{urls:t.type+":"+n+":"+e+(r?"?transport="+r:""),credential:t.password,
username:t.username}}if(t.udpPort===t.tcpPort){e.push(r(t.udpPort))}else{e.push(r(t.udpPort,"udp"));e.push(r(t.tcpPort,"tcp"))}});return e},[])}function fe(e){var t;if(x){var n=x.getSrtpInfo();W.setOfferedSrtpInfo(n);t=!n.dtls||n.sdes&&y.preferSdesSrtp}else{t=y.preferSdesSrtp}if(t){S.log("configuring peer connection to use sdes");e.optional=[{DtlsSrtpKeyAgreement:false}]}W.setNegotiatedSrtpInfo({dtls:!t,sdes:!!t})}function pe(){if(!C){C=e.maContext.getRelayManager().queryRelaysAsync("turn",e.config.isRemoteClientLync).then(function(t){var r={};fe(r);S.log("create peer connection");M=new w.RTCPeerConnection({iceServers:le(t),rtcpMuxPolicy:"require",iceTransportPolicy:e.config.iceTransportPolicy?e.config.iceTransportPolicy:n["default"].ICE_TRANSPORT_POLICY.all},r);W.setPeerConnection(M);M.onnegotiationneeded=function(e){var t=e.target;S.log("onnegotiationneeded","signalingState:",t.signalingState)};M.onsignalingstatechange=function(e){var t=e.target;W.setSignalingConnectionState(t.signalingState);S.log("onsignalingstatechange","signalingState:",t.signalingState)};M.onaddstream=function(e){S.log("onaddstream","stream:",e.stream);var t=E.getMediaEntityByStreamId(e.stream.id);if(t){H.addStream(e.stream,t.getModality())}else{S.error("Can not find media entity with stream id "+e.stream.id)}};M.ontrack=function(e){S.log("ontrack","track:",e.track)};M.onremovestream=function(e){S.log("onremovestream","stream:",e.stream);H.removeStream(e.stream)};M.onicecandidate=function(e){S.log("onicecandidate","candidate:",e.candidate);if(!e.candidate){se()}};M.onicegatheringstatechange=function(e){var t=e.target;S.log("onicegatheringstatechange","iceGatheringState:",t.iceGatheringState)};M.oniceconnectionstatechange=function(e){var t=e.target;W.setIceConnectionState(t.iceConnectionState);S.log("oniceconnectionstatechange","iceConnectionState:",t.iceConnectionState,"pc.signalingState:",t.signalingState);if(t.iceConnectionState==="failed"){ne({type:n["default"].MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"})}if(t.iceConnectionState==="disconnected"){ce()}else{de()}}})}return C}function ve(e){if(!N){throw new Error(e)}}function he(e){function t(e){return!!e&&(r["default"].hasReceiveDirectionality(e)||e==="inactive")}return{offerToReceiveAudio:+t(e.audio),offerToReceiveVideo:+t(e.video)+ +t(e.screensharing)}}function me(e){if(k){k=false;P=false;S.log("triggering renegotiation");E.backup();if(g.onNegotiationRequired){g.onNegotiationRequired()}}else if(e){S.log("renegotiation postponed");P=true}}function ge(e){var t=z.then(function(){return new Promise(function(t){if(!e||!e.audio&&!e.video&&!e.screensharing){throw new Error("Invalid parameters!"+JSON.stringify(e))}var n=!N||!r["default"].areNegotiatedDirectionsFulfilled(e,D);N=e;S.log("configure modalities","audio:",e.audio,"video:",e.video,"screensharing",e.screensharing,"peerconnection:",!!M,"pc.signalingState:",!!M?M.signalingState:"-","needNewRenegotiation:",n);if(n){me()}t(N)})});z=t.catch(function(e){S.warn("Error during configuring modalities: ",e)});return t}function ye(e,t,i){var a=r["default"].hasSendDirectionality(D.audio),o=r["default"].hasSendDirectionality(D.video),s=r["default"].hasSendDirectionality(D.screensharing),u=r["default"].isOnHold(D),c=r["default"].hasSendDirectionality(e.audio),d=r["default"].hasSendDirectionality(e.video),l=r["default"].hasSendDirectionality(e.screensharing),f=r["default"].isOnHold(e);return pe().then(function(){S.log("updatePeerConnectionStreamsAsync","pc state",M.signalingState,"hold","[",u,"->",f,"]","audio","[",a,"->",c,"]","video","[",o,"->",d,"]","screensharing","[",s,"->",l,"]");if(u!==f){if(A){A.setHold(f)}if(_){_.setHold(f)}if(f){return}}if(a!==c||o!==d||s!==l||O){if(i){O=false}var e=function(){r();p();if(M.getSenders().length){throw new Error("not all tracks were removed")}};var r=function(){v(n["default"].MODALITY.audio);v(n["default"].MODALITY.video)};var p=function(){v(n["default"].MODALITY.screensharing)};var v=function(e){if(e in X){S.log("remove sender","track kind:",X[e].track.kind,"track id:",X[e].track.id);M.removeTrack(X[e]);delete X[e]}};var h=function(e,t,n){if(!e){return}S.log("add media track","kind:",e.kind,"id:",e.id);if(X[n]){throw new Error("track already created, modality:"+n+", kind:"+e.kind+", id:"+e.id)}X[n]=M.addTrack(e,t)};if(t){S.log("not using any media(track api) track, remove all senders");e();if(!i||!c&&!d){Oe()}if(!i||!l){xe()}}if(i){var m=[];if(c||d){var g=b._getMediaStream({audio:c,video:d});m.push(g.start().then(function(){try{h(g.getObject().getAudioTracks()[0],g.getObject(),n["default"].MODALITY.audio);h(g.getObject().getVideoTracks()[0],g.getObject(),n["default"].MODALITY.video);if(t){Oe()}g.onApplyConstraints=function(e){if(A===g){var t=A.getObject();S.log("remove media stream","audio tracks:",t.getAudioTracks(),"video tracks:",t.getVideoTracks());r()}e.then(function(){if(A===g){h(g.getObject().getAudioTracks()[0],g.getObject(),n["default"].MODALITY.audio);h(g.getObject().getVideoTracks()[0],g.getObject(),n["default"].MODALITY.video)}})};A=g}catch(e){r();Oe();g.dispose();throw e}}))}if(l){var y=b._getMediaStream({video:true});m.push(y.start().then(function(){try{h(y.getObject().getVideoTracks()[0],y.getObject(),n["default"].MODALITY.screensharing);if(t){xe()}_=y}catch(e){p();xe();y.dispose();throw e}}))}return Promise.all(m)}}})}function Se(){return new Promise(function(e){S.log("create [offer] configured:",N);F=true;ve("no configured modalities to create offer for");k=false;L=r["default"].excludePassiveModalities(N,Y,U);U=L;var t=r["default"].negotiateModalities(U,L);if(!r["default"].isOnHold(t)){e(ye(U,true,true).then(function(){var e=he(U);S.log("create [offer]","offered:",U,"constraints:",e);return M.createOffer(e)}).then(function(e){S.debug("create [offer] offer from peer connection","sdp:",e.sdp);var t=I.createLocalOffer(e.sdp);if(t.needToWaitIceCandidates()){oe()}W.startWaitingForStreamStart(U);var n=new w.RTCSessionDescription({sdp:e.sdp,type:"offer"});return Promise.all([M.setLocalDescription(n),R.promise])}).then(function(){var e=I.createLocalOffer(M.localDescription.sdp);e.updateModalities(U);E.setMediaTracks(be());var n=e.toOffer();S.debug("CREATE OFFER","sdp:",n);return{blob:n,modalities:t}}))}else{e(ye(U,true,true).then(function(){var e=I.createInactiveOfferSdp(M.localDescription.sdp,U);S.debug("CREATE OFFER hold","sdp:",e);return{blob:e,modalities:t}}))}})}function be(){var e=[];u["default"].forOwn(X,function(t,n){e.push({track:t.track.id,modality:n})});return e}function we(e){return new Promise(function(t){var n=e.blob;S.debug("process [offer]","sdp:",n);F=false;x=I.createRemoteOffer(n);k=false;U=r["default"].invertModalities(x.getModalities());var i=Promise.resolve(U);if(r["default"].hasSendDirectionality(U.video)||r["default"].hasReceiveDirectionality(U.video)){var a=x.getVideoCodecs();i=w.RTCRtpReceiver.getCapabilities("video").then(function(e){var t=e.codecs.some(function(e){return a.some(function(t){return e.mimeType===t})});if(!t){S.warn("offer doesn't contain any supported video codecs");var n=u["default"].shallowClone(U);n.video=void 0;return n}return U}).catch(function(e){S.error("failed to get video capability",e);return U})}t(i.then(function(e){S.log("process [offer]","offered:",U,"acceptable:",e);return e}))})}function Ee(e){if(y.enableLocalVideoConstraints&&A&&A.hasVideo()){var t=e.getVideoRecvCapabilities();if(t.maxFS&&t.maxFPS){return A.applyConstraints(t)}S.error("remote endpoint didn't specify video receive capability")}return Promise.resolve(false)}function Te(e){return new Promise(function(t){if(e){t({});return}S.log("create [answer]","offered:",U,"configured:",N);ve("no configured modalities to create answer for");L=r["default"].excludePassiveModalities(N,Y,U);var n=r["default"].negotiateModalities(U,L);if(!r["default"].isOnHold(n)){t(ye(n,true,false).then(function(){return Ee(x)}).then(function(){return Ie()}).then(function(){var e=x.toRemote(n);S.log("create [answer] set remote description","negotiated:",n,"sdp:",e);return M.setRemoteDescription(new w.RTCSessionDescription({sdp:e,type:"offer"}))}).then(function(){return ye(n,false,true)}).then(function(){return M.createAnswer()}).then(function(e){S.debug("create [answer] answer from peer connection","sdp:",e.sdp);var t=I.createLocalAnswer(e.sdp);if(t.needToWaitIceCandidates()){oe()}W.startWaitingForStreamStart(n);var r=new w.RTCSessionDescription({sdp:e.sdp,type:"answer"});return Promise.all([M.setLocalDescription(r),R.promise])}).then(function(){var e=I.createLocalAnswer(M.localDescription.sdp);e.updateModalities(n);E.setMediaTracks(be());var t=e.toAnswer();n=e.getModalities();ae(n);S.debug("CREATE ANSWER","sdp:",t);return{blob:t,modalities:D}}))}else{t(ye(n,true,true).then(function(){ae(n);var e=I.createInactiveAnswerSdp(M.localDescription.sdp,D);S.debug("CREATE ANSWER hold","sdp:",e);return{blob:e,modalities:D}}))}})}function Ie(){if(x.isCodecSwitchSupported()){return Promise.resolve()}return w.RTCRtpReceiver.getCapabilities(n["default"].MEDIA_TYPE.audio).then(function(e){var t=e.codecs.map(function(e){return e.mimeType});x.usePrimaryAudioCodecOnly(t)}).catch(function(e){S.error("failed to set primary codec based on audio capability",e)})}function Me(e,t){return new Promise(function(n){var i=e.blob;S.debug(t?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",i);if(t){S.log("process [pranswer]");n({});return}var a=I.createRemoteAnswer(i);var o=r["default"].invertModalities(a.getModalities());ae(o);if(!r["default"].isOnHold(D)){var s=a.toRemote(D);S.log("process [answer] set remote description","negotiated:",D,"sdp:",s);n(M.setRemoteDescription(new w.RTCSessionDescription({sdp:s,type:"answer"})).then(function(){return D}).then(function(){return Ee(a)}).then(function(e){if(e){me(true)}}).then(function(){return D}))}else{n(D)}})}function Ce(){return new Promise(function(e){E.commit();var t=r["default"].excludePassiveModalities(N,Y,U);var n=O&&!r["default"].isOnHold(D)||!r["default"].areNegotiatedDirectionsAcceptable(t,L,D)||P,i=!n;k=true;S.log("negotiation completed","isComplete:",i,"configured:",N,"negotiating:",L,"offered:",U,"negotiated:",D);if(n){me()}e({isComplete:i,activeModalities:D,offeredModalities:U,attemptedModalities:L,configuredModalities:N,initiator:F})})}function Ae(e,t){return new Promise(function(r){E.rollback();var i=e===n["default"].RENEGOTIATION_ERROR.local;var a=Promise.resolve();S.warn("negotiation rejected","isComplete:",i,"error:",e,"configured:",N,"negotiating:",L,"offered:",U,"negotiated:",D);if(M){if("have-local-offer"===M.signalingState){S.log("rolling back local description");a=M.setLocalDescription(new w.RTCSessionDescription({type:"rollback"}))}else{S.error("cannot rollback local description in currrent state:",M.signalingState)}}r(a.then(function(){if(t){S.log("retrying failed negotiation");me()}return{isComplete:i,activeModalities:D,offeredModalities:U,attemptedModalities:L,configuredModalities:N,initiator:F}}))})}function _e(e,t){return q.createRemoteRenderer(e,t)}function Re(){if(M){if(!r["default"].isOnHold(D)){O=true;me()}}}function Pe(){S.log("terminate");W.setTerminated();if(J){J.dispose();J=null}return De().then(function(){j=true;q.unsubscribeAll();ue();de();if(g._onTerminated){g._onTerminated(g)}})}function ke(){Oe();xe()}function Oe(){if(A){A.dispose();A=null}}function xe(){if(_){_.dispose();_=null}}function De(){if(!j){B=B.then(function(){return W.getReport()}).then(function(e){return e}).catch(function(e){S.error("getting statistics should never fail:",e);return{}})}return B}function Ue(e){return G.sendDtmf(M,e)}function Ne(){return G.canSendDtmf(M)}function Le(){if(!J){J=new p["default"];J.addExtension(n["default"].EXTENSION_TYPE.dominantSpeakerHistory,{callback:K.onDominantSpeakerHistoryChanged.bind(K)})}return J}};t.__esModule=true;t["default"]={build:function(e,t,n){return new m(e,t,n)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcTransport",["require","exports","../constants","../helper","../common/utils"],e)}})(function(e,t){var n=e("../constants");var r=e("../helper");var i=e("../common/utils");function a(e,t,i,a,o,s,u){var c=this;var d=r["default"].defer();var l;var f;this.nominatedCandidatePair=null;t.log("create RTCIceGatherer","options:",JSON.stringify(o.iceGathererOptions));if(!s){this.iceGatherer=new RTCIceGatherer(o.iceGathererOptions)}else{this.iceGatherer=s.createAssociatedGatherer()}t.log("create RTCIceTransport");if(!u){this.iceTransport=new RTCIceTransport}else{this.iceTransport=u.createAssociatedTransport()}this.getLocalCandidatesAsync=function(){return d.promise};this.start=function(e,n){if(f){throw new Error("already started!")}f=true;l=i.createCb(o.iceRole);t.log("RTCIceTransport setRemoteCandidates","candidates:",JSON.stringify(e));c.iceTransport.setRemoteCandidates(e);t.log("RTCIceTransport start","remoteIceParams:",JSON.stringify(n),"role:",o.iceRole);c.iceTransport.start(c.iceGatherer,n,o.iceRole);t.log("RTCIceTransport start","role:",c.iceTransport.role)};this.dispose=function(){t.log("dispose");c.iceTransport.stop();c.iceTransport=null;c.iceGatherer=null;if(d.isPending()){d.reject(new Error("operation canceled due to stop"))}if(l){l.dispose()}};this.iceGatherer.onlocalcandidate=function(e){t.log("RTCIceGatherer.onlocalcandidate","candidate:",JSON.stringify(e.candidate));if(Object.keys(e.candidate).length===0){d.resolve()}};this.iceGatherer.onerror=function(e){t.error("RTCIceGatherer.onerror","event:",e);d.reject(new Error("IceGatherer failed!"))};this.iceTransport.onicestatechange=function(){if(c.iceTransport){t.log("RTCIceTransport.onicestatechange","state:",c.iceTransport.state);if(c.iceTransport.state==="completed"){t.log("pair:",JSON.stringify(c.iceTransport.getNominatedCandidatePair()));c.nominatedCandidatePair=c.iceTransport.getNominatedCandidatePair();l.iceCompleted()}if(e==="audio"&&c.iceTransport.state==="disconnected"){t.error("audio ICE transport disconnected, ending call!");a({type:n["default"].MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"})}}};this.iceTransport.oncandidatepairchange=function(e){t.log("RTCIceTransport.oncandidatepairchange","event:",e)}}function o(e,t,r){var i=this;var a=false;this.dtlsTransport=new RTCDtlsTransport(t);this.dtlsTransport.ondtlsstatechange=function(){e.log("RTCDtlsTransport.ondtlsstatechange","state:",event.state,"role:",i.dtlsTransport?i.dtlsTransport.getLocalParameters().role:"")};this.dtlsTransport.onerror=function(t){e.error("RTCDtlsTransport.onerror","event:",t);r({type:n["default"].MEDIA_ERROR.srtpError,detail:t})};this.startAsync=function(t){if(a){throw new Error("already started!")}a=true;e.log("RTCDtlsTransport.start","params:",JSON.stringify(t));i.dtlsTransport.start(t);return Promise.resolve()};this.dispose=function(){if(a){i.dtlsTransport.stop()}i.dtlsTransport=null}}function s(e,t,r,i,s,u){var c,d,l;var f=false;c=new a(e,t.createChild("IceT"),r,i,s);l=new o(t.createChild("DtlsT"),c.iceTransport,i);if(u){d=new a(e,t.createChild("RtcpIceT"),r,i,s,c.iceGatherer,c.iceTransport)}Object.defineProperty(this,"iceTransport",{get:function(){return c.iceTransport}});Object.defineProperty(this,"dtlsTransport",{get:function(){return l?l.dtlsTransport:null}});function p(e){var t=e;if(s.iceCandidateType||s.iceCandidateTransport){t=t.filter(function(e){var t=true,n=true;if(s.iceCandidateType){t=e.type.match(new RegExp(s.iceCandidateType),"i")}if(s.iceCandidateTransport){n=e.protocol.match(new RegExp(s.iceCandidateTransport,"i"))}return t&&n})}if(s.iceGathererOptions.gatherPolicy===n["default"].ICE_TRANSPORT_POLICY.relay){t.forEach(function(e){e.relatedAddress=e.ip;e.relatedPort=e.port})}return t}function v(){return{iceParams:c.iceGatherer.getLocalParameters(),iceCandidates:p(c.iceGatherer.getLocalCandidates()),iceCandidatePair:c.nominatedCandidatePair,dtlsParams:l?l.dtlsTransport.getLocalParameters():null,rtcpIceParams:d?d.iceGatherer.getLocalParameters():null,rtcpIceCandidates:d?p(d.iceGatherer.getLocalCandidates()):null,rtcpIceCandidatePair:d?d.nominatedCandidatePair:null}}this.getLocalParamsAsync=function(){var e;if(d){e=Promise.all([c.getLocalCandidatesAsync(),d.getLocalCandidatesAsync()])}else{e=c.getLocalCandidatesAsync()}return e.then(function(){return v()})};this.startAsync=function(e){if(f){throw new Error("already started!")}var t=Promise.resolve();f=true;c.start(e.iceCandidates,e.iceParams);if(d){if(!e.doRtcpMux){d.start(e.rtcpIceCandidates,e.rtcpIceParams)}else{d.dispose();d=null}}if(e.enableDtls){t=l.startAsync(e.dtlsParams)}return t};this.dispose=function(){t.log("dispose");c.dispose();c=null;if(d){d.dispose();d=null}if(l){l.dispose();l=null}}}function u(e,t){var n=[];var a=false;var o=r["default"].defer();var s=0;function u(r){this.dispose=function(){i["default"].remove(n,function(e){return e===this})};this.gotCallback=false;this.iceCompleted=function(){this.gotCallback=true;this.gotCallbackFromControlling=r==="controlling";var i=0;var u=0;for(var c=0;c<n.length;c++){if(n[c].gotCallback){i++}if(n[c].gotCallbackFromControlling){u++}}if(u&&u===s&&!a){e.log("IceCompletionMonitor REINVITE");a=true;t.triggerIceReinvite()}if(i&&i===n.length){e.log("IceCompletionMonitor ALL COMPLETE");o.resolve()}}}this.createCb=function(e){var t=new u(e);n.push(t);if(e==="controlling"){a=false;s++}o.reject(undefined);o=r["default"].defer();return t};this.waitAllCallbacksAsync=function(){return o.promise}}function c(e,t,r,i,a,o,c){var d,l,f;var p=[false,false];var o=o?o:n["default"].ICE_TRANSPORT_POLICY.all;var v=new u(e,r);var h;Object.defineProperty(this,"audioTransport",{get:function(){return d?d:null}});Object.defineProperty(this,"videoTransport",{get:function(){return l?l:null}});Object.defineProperty(this,"screensharingTransport",{get:function(){return f?f:null}});function m(){if(!h){h=i.queryRelaysAsync("msturn",a)}return h}this.assureInitAsync=function(n,i){return new Promise(function(a){e.log("assureInitAsync");var u=m().then(function(a){var u={iceRole:n,iceCandidateType:t.iceCandidateType,iceCandidateTransport:t.iceCandidateTransport,iceGathererOptions:{gatherPolicy:o,iceServers:a.reduce(function(e,t){t.addresses.map(function(n){e.push({urls:t.type+":"+n+":"+t.udpPort+"?transport=udp",credential:t.password,username:t.username});e.push({urls:t.type+":"+n+":"+t.tcpPort+"?transport=tcp",credential:t.password,username:t.username})});return e},[])}};if(!d&&i[0]){e.log("assureInitAsync AUDIO "+u.iceRole);d=new s("audio",e.createChild("AT"),v,r.raiseError,u,c)}if(!l&&i[1]){e.log("assureInitAsync VIDEO "+u.iceRole);l=new s("video",e.createChild("VT"),v,r.raiseError,u,c)}if(!f&&i[2]){e.log("assureInitAsync SCREENSHARING "+u.iceRole);f=new s("video",e.createChild("ST"),v,r.raiseError,u,c)}});a(u)})};this.getLocalParamsAsync=function(){e.log("getLocalParamsAsync");return new Promise(function(e){var t=Promise.resolve(),n=Promise.resolve(),r=Promise.resolve();if(d){t=d.getLocalParamsAsync()}if(l){n=l.getLocalParamsAsync()}if(f){r=f.getLocalParamsAsync()}e(Promise.all([t,n,r]))})};this.waitIceCompletionIfNeededAsync=function(t){return new Promise(function(n){var r="";if(t[0]&&t[0].iceCandidatePair||t[1]&&t[1].iceCandidatePair){e.log("waiting ICE completed state!");r=v.waitAllCallbacksAsync()}n(r)})};this.configureTransportAsync=function(e,t){return new Promise(function(n){var r=Promise.resolve(),i=Promise.resolve(),a=Promise.resolve();if(t[0]&&!p[0]){r=d.startAsync(e[0])}else if(!t[0]&&p[0]){d.dispose();d=null}if(t[1]&&!p[1]){i=l.startAsync(e[1])}else if(!t[1]&&p[1]){l.dispose();l=null}if(t[2]&&!p[2]){a=f.startAsync(e[2])}else if(!t[2]&&p[2]){f.dispose();f=null}p=t;n(Promise.all([r,i,a]))})};this.stop=function(){if(d){d.dispose();d=null}if(l){l.dispose();l=null}if(f){f.dispose();f=null}}}t.__esModule=true;t["default"]=c});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcHelper",["require","exports","../constants","../helper","../common/utils"],e)}})(function(e,t){var n=e("../constants");var r=e("../helper");var i=e("../common/utils");function a(e,t){return e.toLowerCase()===t.toLowerCase()}function o(e){if(e.enabled){if(e.send&&e.recv){return n["default"].MEDIA_STATE.sendReceive}else if(e.send){return n["default"].MEDIA_STATE.send}else if(e.recv){return n["default"].MEDIA_STATE.receive}else{return n["default"].MEDIA_STATE.inactive}}else{return null}}function s(e){var t;if(e===n["default"].MEDIA_LABEL.audio){return 0}if(e===n["default"].MEDIA_LABEL.video){return 1}if(e===n["default"].MEDIA_LABEL.screensharing){return 2}throw new Error("unsupported label: "+e)}function u(e){if(e===n["default"].MEDIA_LABEL.audio){return n["default"].MEDIA_TYPE.audio}if(e===n["default"].MEDIA_LABEL.video){return n["default"].MEDIA_TYPE.video}if(e===n["default"].MEDIA_LABEL.screensharing){return n["default"].MEDIA_TYPE.video}throw new Error("unsupported label: "+e)}function c(e,t){return{enabled:!!e,type:u(t),label:t,send:r["default"].hasSendDirectionality(e),recv:r["default"].hasReceiveDirectionality(e)}}function d(e,t){for(var n=0;n<e.length;n++){if(e[n].descr.label===t){return e[n].descr}}return{enabled:false,type:u(t),label:t,send:false,recv:false}}function l(e){var t={};var r=d(e,n["default"].MEDIA_LABEL.audio);var i=d(e,n["default"].MEDIA_LABEL.video);var a=d(e,n["default"].MEDIA_LABEL.screensharing);if(r.enabled){t.audio=o(r)}if(i.enabled){t.video=o(i)}if(a.enabled){t.screensharing=o(a)}return t}function f(e,t){return i["default"].find(t,function(t,n,r){if(t.preferredPayloadType===+e){return true}})}function p(e,t){return i["default"].findIndex(t,function(t,n,r){if(t.preferredPayloadType===e){return true}})}function v(e,t){return i["default"].find(t,function(t,n,r){if(a(t.name,e)){return true}})}function h(e,t){return f(e,t).name}function m(e,t,n,r){var o=[];if(e&&t){e.filter(function(e){return!a(e.name,"rtx")}).forEach(function(e){for(var s=0;s<t.length;s++){var u=t[s];if(a(e.name,u.name)&&a(e.kind,u.kind)&&e.numChannels===u.numChannels&&e.clockRate===u.clockRate){var c=i["default"].shallowClone(r?u:e);c.preferredPayloadType=n?e.preferredPayloadType:u.preferredPayloadType;o.push(c);break}}});e.filter(function(e){return a(e.name,"rtx")}).forEach(function(s){for(var u=0;u<t.length;u++){var c=t[u];if(a(s.name,c.name)&&a(s.kind,c.kind)&&s.numChannels===c.numChannels&&s.clockRate===c.clockRate&&a(h(s.parameters.apt,e),h(c.parameters.apt,t))){var d=i["default"].shallowClone(r?c:s);d.preferredPayloadType=n?s.preferredPayloadType:c.preferredPayloadType;d.parameters.apt=v(f(s.parameters.apt,e).name,o).preferredPayloadType;o.push(d);break}}});return o}}function g(e,t){function n(e,t){var n=e.keyParams[0];var r=t.keyParams[0];return e.cryptoSuite===t.cryptoSuite&&n.mkiLength===r.mkiLength&&n.mkiValue===r.mkiValue}for(var r=0;r<t.length;++r){var a=t[r];for(var o=0;o<e.length;++o){var s=e[o];if(n(a,s)){return{localSdesParams:i["default"].shallowClone(s),remoteSdesParams:i["default"].shallowClone(a)}}}}return null}function y(e,t){var n=[];if(e&&t){e.forEach(function(e){for(var r=0;r<t.length;r++){var i=t[r];if(e.kind===i.kind&&e.uri===i.uri){n.push(e)}}})}return n}function S(e,t,n,r){var i=null;if(e&&t){i={codecs:m(e.codecs,t.codecs,n,r),headerExtensions:y(e.headerExtensions,t.headerExtensions),fecMechanisms:e.fecMechanisms.filter(function(e){return t.fecMechanisms.indexOf(e)!==-1})}}return i}function b(e,t,n,r,i,a){return M("",E(e.codecs),T(e.headerExtensions),I(t,a),_(n,"",r,i))}function w(e,t,n,r,i,a){return b(e,t,n,r,i,a)}function E(e){var t=[];e.forEach(function(e){t.push(C(e.name,e.preferredPayloadType,e.clockRate,e.numChannels,e.rtcpFeedback,e.parameters,e.ptime,e.maxptime))});return t}function T(e){var t=[];e.forEach(function(e){t.push(A(e.uri,e.preferredId,e.preferredEncrypt))});return t}function I(e,t){var n=[];n.push(k(e,0,0,t,1));return n}function M(e,t,n,r,i){return{muxId:e||"",codecs:t,headerExtensions:n,encodings:r,rtcp:i,degradationPreference:"balanced"}}function C(e,t,n,r,i,a,o,s){return{name:e,payloadType:t,clockRate:n,numChannels:r,rtcpFeedback:i,parameters:a,ptime:o,maxptime:s}}function A(e,t,n){return{uri:e,id:t,encrypt:n}}function _(e,t,n,r){return{ssrc:e,cname:t,reducedSize:n,mux:r}}function R(e){return e.some(function(e){return a(e.name,"rtx")})}function P(e,t,n,r){return R(e.codecs)?r?t.rtxSsrc:n.rtxSsrc:0}function k(e,t,n,r,i,a,o,s,u,c,d,l,f,p){return{ssrc:e.min,ssrcRange:e,codecPayloadType:t,fec:n,rtx:r?{ssrc:r}:0,priority:i||1,maxBitrate:a,minQuality:o||0,framerateBias:s||.5,resolutionScale:u||1,framerateScale:c||1,active:l||true,encodingId:f,dependencyEncodingId:p}}t.__esModule=true;t["default"]={getStateFromDescr:o,getDescrFromState:c,getCodecIndexByPayload:p,findDescrFromMedia:d,getModalitiesFromMedia:l,findMatchingSdesParams:g,matchRtpCaps:S,getSendParams:b,getRecvParams:w,getTransportIdxForLabel:s,RTCRtpCodecParameters:C,RTCRtpHeaderExtensionParameters:A,RTCRtcpParameters:_,hasRtx:R,getRtxSsrc:P,RTCRtpEncodingParameters:k}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcChannelStats",["require","exports","../helper","../common/utils"],e)}})(function(e,t){var n=e("../helper");var r=e("../common/utils");function i(e,t,i,a){var o=e.logger.createChild("ChannelStats");this.getReport=function(){var e={};e.extended={mediaDiagnostic:{reason:s()}};function u(t,i,a){if(!t){return}var s=i+"."+(a?"msGetStats":"getStats");var u=new Promise(function(e){o.log(s,"start");e(a?t.msGetStats():t.getStats())}).then(function(t){o.log(s,"complete");e[i]=e[i]||{};r["default"].forOwn(t,function(t){e[i][t.type||t.msType]=t})}).catch(function(e){o.warn(s,"failed:",e)});return n["default"].timeout(u,5e3,s).catch(function(e){o.warn(s,"failed:",e)})}return new Promise(function(n){Promise.all([u(t,"iceTransport",false),u(t,"iceTransport",true),u(i,"sender",false),u(i,"sender",true),u(a,"receiver",false),u(a,"receiver",true)]).then(function(){n(e)}).catch(function(t){o.error("getting statistics should never fail",t);n(e)})})};function s(){if(!t){return"CheckNotCompleted"}var e=t.state;if(e==="new"||e==="checking"||e==="connected"){return"CheckNotCompleted"}if(e==="completed"){return"CheckSucceed"}if(e==="failed"){return"CheckFailed"}if(e==="disconnected"||e==="closed"){return"MediaTimeout"}return"Unknown DiagnosticReason"}}t.__esModule=true;t["default"]={build:function(e,t,n,r){return new i(e,t,n,r)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcDtmfSender",["require","exports","../common/dtmfUtils"],e)}})(function(e,t){var n=e("../common/dtmfUtils");var r=function(){function e(e,t){this.queue=new n.DTMFQueue(e);this.settings=t?t:n.defaultSettings}e.prototype.sendDtmf=function(e,t){if(!e){return Promise.reject(new Error("bad sender"))}this.syncSender(e);if(!this.ortcSender.canInsertDTMF){return Promise.reject(new Error("not available"))}this.ortcSender.insertDTMF(this.ortcSender.toneBuffer+t,this.settings.toneDuration,this.settings.toneGap);return this.queue.waitForNotification(t)};e.prototype.canSendDtmf=function(e){if(!e){return false}this.syncSender(e);return this.ortcSender?this.ortcSender.canInsertDTMF:false};e.prototype.dispose=function(){this.queue.cleanup()};e.prototype.syncSender=function(e){if(!this.ortcSender||this.ortcSender.sender!==e){if(this.ortcSender){this.ortcSender.ontonechange=null;this.queue.cleanup();this.ortcSender=null}this.ortcSender=new RTCDtmfSender(e);this.ortcSender.ontonechange=this.onToneChange.bind(this)}};e.prototype.onToneChange=function(e){if(e.tone){this.queue.toneSent(e.tone)}};return e}();t.OrtcDTMFSender=r;t.__esModule=true;t["default"]={build:function(e,t){return new r(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcMediaChannel",["require","exports","./ortcHelper","../constants","./ortcChannelStats","../common/utils","./ortcDtmfSender"],e)}})(function(e,t){var n=e("./ortcHelper");var r=e("../constants");var i=e("./ortcChannelStats");var a=e("../common/utils");var o=e("./ortcDtmfSender");function s(e,t,s,u,c,d,l){var f=this;var p=null;var v=null;var h=null;var m=null;var g=null;var y=null;var S=false;var b=false;var w;var E;var T=1e3;var I=[];var M=o["default"].build(e,t.dtmf);this.type=s;this.label=u;this.subscribedMsi=r["default"].MSI.unsubscribe;this.onContributingSourcesChanged=null;if(!t.disableSdes){y=RTCSrtpSdesTransport.getLocalParameters().filter(A)}function C(){var n=RTCRtpReceiver.getCapabilities(s);var i;if(n.codecs){if(s===r["default"].MEDIA_TYPE.audio&&t.audioCodec){var o=["cn","red"];a["default"].remove(n.codecs,function(e){var n=e.name.toLowerCase();return n!==t.audioCodec.toLowerCase()&&o.indexOf(n)===-1})}else if(s===r["default"].MEDIA_TYPE.video&&t.videoCodec){a["default"].remove(n.codecs,function(e){return e.name.toLowerCase()!==t.videoCodec.toLowerCase()})}}if(s===r["default"].MEDIA_TYPE.audio){for(i=n.codecs.length-1;i>=0;i--){if(n.codecs[i].preferredPayloadType===106){n.codecs[i].preferredPayloadType=111;e.log("Opus payloadType fix, change payload type 106->111 for",n.codecs[i].name)}}}return n}function A(e){return e.cryptoSuite!=="SCALE_AES_CM_128_HMAC_SHA1_80"}this.getLocalParameters=function(){var e=C();var t={sdesParamsList:y,rtpCaps:e,rtxSsrc:n["default"].hasRtx(e.codecs)?d.min+50:0,ssrcRange:d};return{sender:t,receiver:a["default"].deepClone(t)}};function _(t){var n,r,i;if(P()){r=m.getObject().getAudioTracks()[0];n=t.getObject().getAudioTracks()}else{r=m.getObject().getVideoTracks()[0];n=t.getObject().getVideoTracks()}i=n.length?n[0]:null;if(i===null){e.error("media track is not available");return}var a=r.getSettings().deviceId;var o=i.getSettings().deviceId;if(a!==o){e.log("replacing media track","currDevID:",a,"newDevID:",o,"currTrackID:",r.id,"newTrackID:",i.id);p.setTrack(i);m.dispose();m=t.clone()}else{e.log("NOT replacing media track","currDevID:",a,"newDevID:",o,"currTrackID:",r.id,"newTrackID:",i.id)}}function R(t,n){if(!g){e.debug("RTCSrtpSdesTransport","local:",JSON.stringify(n.sdesParamsList[0]),"remote:",JSON.stringify(n.remoteSdesParams));g=new RTCSrtpSdesTransport(t,n.sdesParamsList[0],n.remoteSdesParams);g.onerror=function(t){e.log("RTCSrtpSdesTransport.onerror","event:",t);c({type:r["default"].MEDIA_ERROR.srtpError,detail:t})}}}function P(){return s===r["default"].MEDIA_TYPE.audio}function k(){return s===r["default"].MEDIA_TYPE.video}function O(){if(g){g=null}}function x(){if(b&&v){var t;try{t=v.getContributingSources()}catch(t){e.error("failed to retrieve contributing sources from receiver","error:",t);return}if(!t){e.warn("could not retrieve contributing sources from receiver");return}t=t.map(function(e){return e.csrc});var n=I.length===t.length&&t.every(function(e,t){return e===I[t]});if(!n){e.debug("contributing sources changed","sources:",t);if(f.onContributingSourcesChanged){f.onContributingSourcesChanged(t)}}I=t;setTimeout(x,T)}else{e.debug("receiver is missing, stop polling for contributing sources")}}function D(t){if(b&&v){e.log("_requestSendCsrc","csrc:",t);try{v.requestSendCSRC(t)}catch(t){e.error("failed to request send csrc","error:",t)}return true}return false}function U(t,n){e.log("_rtpReceiver create");if(n.enableDtls){if(n.rtcpMux){v=new RTCRtpReceiver(t.dtlsTransport,s)}else{throw new Error("rtcpMux=false not supported with dtls!")}}else{R(t.iceTransport,n);v=new RTCRtpReceiver(g,s)}h=v.track;v.onerror=function(t){e.error("_rtpReceiver.onerror","event:",t);c({type:r["default"].MEDIA_ERROR.internalError,detail:t})}}function N(t,n,i){var a
;if(P()){a=n.getObject().getAudioTracks()[0]}else{a=n.getObject().getVideoTracks()[0]}e.log("_rtpSender create trackID:",a.id);if(i.enableDtls){if(i.rtcpMux){p=new RTCRtpSender(a.clone(),t.dtlsTransport)}else{throw new Error("rtcpMux=false not supported with dtls!")}}else{R(t.iceTransport,i);p=new RTCRtpSender(a.clone(),g)}if(P()){n.onMute=function(e){if(p){p.track.enabled=!e}}}p.onerror=function(t){e.error("_rtpSender.onerror","event:",t);c({type:r["default"].MEDIA_ERROR.internalError,detail:t})};p.onssrcconflict=function(t){e.error("_rtpSender.onssrcconflict","event:",t)}}function L(e){var t=n["default"].getRecvParams(e.rtpCaps,e.remoteSsrcRange,d.min,e.rtcpReducedSize,e.rtcpMux,e.rtxSsrc);if(l){t.degradationPreference="maintain-resolution"}t.encodings[0].active=b;return t}function V(e){var t=n["default"].getSendParams(e.rtpCaps,d,e.remoteSsrcRange.min,e.rtcpReducedSize,e.rtcpMux,e.rtxSsrc);t.encodings[0].active=S;return t}function W(t,n,i){if(v&&H(n.remoteSsrcRange,E)){e.log("SSRC changed, resetting receiver");B()}if(!v){U(i,n);E=n.remoteSsrcRange}b=!!t.recv;var a=L(n);e.debug("_rtpReceiver.receive:",JSON.stringify(a));v.receive(a);if(b){if(P()){x()}else if(f.subscribedMsi!==r["default"].MSI.unsubscribe){D(f.subscribedMsi)}}}function B(){if(v){e.log("_rtpReceiver stop & destroy");b=false;h=null;v.stop();v=null}}function j(t,n,r,i){if(p&&H(n.remoteSsrcRange,w)){e.log("SSRC changed, resetting sender");F()}S=!!t.send;if(S){if(m){_(i)}else{m=i.clone()}if(!p){N(r,m,n);w=n.remoteSsrcRange}var a=V(n);e.debug("_rtpSender.send:",JSON.stringify(a));p.send(a)}else{F();G()}}function F(){if(M){M.dispose();M=null}if(p){e.log("_rtpSender stop & destroy");S=false;p.stop();p=null}}function G(){if(m){m.dispose();m=null}}function H(e,t){return t&&e&&(e.min!==t.min||e.max!==t.max)}function q(){B();F();G();O()}this.configureChannel=function(t,n,r){e.log("configureChannel","type:",s,"descr:",JSON.stringify(t.descr));if(t.descr.enabled){W(t.descr,t.receiver,n);j(t.descr,t.sender,n,r)}else{q()}};this.updateLocalMediaStream=function(e){if(p){_(e)}};this.canSubscribe=function(){return b&&v&&f.subscribedMsi===r["default"].MSI.unsubscribe&&k()};this.subscribe=function(e){if(f.subscribedMsi===r["default"].MSI.unsubscribe&&k()){f.subscribedMsi=e;return D(f.subscribedMsi)}throw new Error("invalid call for subscribe:"+f.subscribedMsi+"type:"+s)};this.unsubscribe=function(){if(f.subscribedMsi===r["default"].MSI.unsubscribe||!k()){throw new Error("invalid call for unsubscribe:"+f.subscribedMsi+"type:"+s)}f.subscribedMsi=r["default"].MSI.unsubscribe;D(f.subscribedMsi)};this.getReportsAsync=function(){var t=b?v:null,n=S?p:null;var r=t?t.transport.transport:n?n.transport.transport:null;var a=i["default"].build({logger:e},r,n,t);return a.getReport()};this.getSendTrack=function(){return S&&p?p.track:null};this.getRecvTrack=function(){return b&&v?h:null};this.terminate=function(){q();e.log("termiated")};this.sendDtmf=function(e){return M.sendDtmf(p,e)};this.canSendDtmf=function(){return M.canSendDtmf(p)}}t.__esModule=true;t["default"]=s});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcNegotiation",["require","exports","./ortcHelper","../constants","../common/utils"],e)}})(function(e,t){var n=e("./ortcHelper");var r=e("../constants");var i=e("../common/utils");function a(e,t,a){this.processOffer=c;this.createMediaDescriptorsForAnswer=l;this.createAnswer=h;this.createMediaDescriptorsForOffer=m;this.createOffer=g;this.processAnswer=y;this.completeNegotiation=T;var o=null;var s=null;var u=null;function c(t){o=t;e.debug("PROCESS OFFER","params:",JSON.stringify(o))}function d(e,t){if(!t){t={enabled:true,send:true,recv:true}}var n=e.send&&e.enabled&&t.recv&&t.enabled;var r=e.recv&&e.enabled&&t.send&&t.enabled;var i=e.enabled&&t.enabled&&(n||r||!e.send&&!e.recv||!t.send&&!t.recv);return{enabled:i,type:e.type,label:e.label,send:n,recv:r}}function l(e){if(u&&u.media.length>o.media.length){throw new Error("Invalid remote offer - removed media lines")}var t=[];var i;var s=false,c=false;var l=0;for(var f=0;f<o.media.length;f++){if(u&&u.media[f]){if(u.media[f].type!==o.media[f].type){throw new Error("Changing media type not supported")}if(u.media[f].label&&o.media[f].label&&u.media[f].label!==o.media[f].label){throw new Error("Changing media label not supported")}}if(o.media[f].descr.label===r["default"].MEDIA_LABEL.audio&&!s){i=d(n["default"].getDescrFromState(e.audio,r["default"].MEDIA_LABEL.audio),o.media[f].descr);t.push(i);s=true}else if(o.media[f].descr.label===r["default"].MEDIA_LABEL.video&&l<a){i=d(n["default"].getDescrFromState(e.video,r["default"].MEDIA_LABEL.video),o.media[f].descr);if(l>0){i.send=false}t.push(i);l++}else if(o.media[f].descr.label===r["default"].MEDIA_LABEL.screensharing&&!c){i=d(n["default"].getDescrFromState(e.screensharing,r["default"].MEDIA_LABEL.screensharing),o.media[f].descr);t.push(i);c=true}else{t.push({enabled:false,type:o.media[f].descr.type,label:u&&u.media[f]?u.media[f].descr.label:o.media[f].descr.label})}}return t}function f(e,n){var r=n?n.transportParams:[];for(var i=0;i<e.length;i++){if(e[i]){e[i].doRtcpMux=r[i]&&!r[i].doRtcpMux?false:true}if(e[i]&&r[i]){var a=false;for(var o=0;!t.disableSdes&&o<n.media.length;o++){if(n.media[o].receiver&&n.media[o].receiver.sdesParamsList&&n.media[o].receiver.sdesParamsList.length){a=true}}if(r[i].doRtcpMux){e[i].rtcpIceParams=null;e[i].rtcpIceCandidates=null}if(e[i].dtlsParams&&r[i].dtlsParams){e[i].dtlsParams.role=r[i].dtlsParams.role==="client"?"server":"client"}if(a||!r[i].dtlsParams){e[i].dtlsParams=null}}else{if(e[i]&&e[i].dtlsParams){e[i].dtlsParams.role=null}}}return e}function p(e,t,r,i){var a;var o=i?e.sender:e.receiver;var s=i?t.receiver:t.sender;if(o.sdesParamsList&&s.sdesParamsList){a=n["default"].findMatchingSdesParams(o.sdesParamsList,s.sdesParamsList)}var u=[];var c;if(a){u.push(a.localSdesParams);c=a.remoteSdesParams}var d=n["default"].matchRtpCaps(o.rtpCaps,s.rtpCaps,r,i);return{ssrcRange:o.ssrcRange,remoteSsrcRange:s.ssrcRange,rtxSsrc:n["default"].getRtxSsrc(d,o,s,i),sdesParamsList:u,remoteSdesParams:c,rtpCaps:d}}function v(e,t,n,r,i){if(!e.enabled){return{descr:e}}else{var a=t;a.sender.rtcpReducedSize=i;a.receiver.rtcpReducedSize=i;a.descr=e;a.justAdded=n;a.bundledWithOther=r;return a}}function h(t,a,u,c){var d={isOffer:false,sessionVersion:o.sessionVersion,transportParams:f(a,o),media:[]};var l=false;for(var h=0;h<t.length;h++){var m=l&&t[h].label===r["default"].MEDIA_LABEL.video;if(t[h].label===r["default"].MEDIA_LABEL.video){l=true}var g={};var y=i["default"].shallowClone(t[h]);if(y.enabled){var b=n["default"].getTransportIdxForLabel(y.label);var w=d.transportParams[b];var T=p(u[h],o.media[h],false,false);var I=p(u[h],o.media[h],false,true);if(T.sdesParamsList.length&&T.remoteSdesParams){T.sdesParamsList[0].tag=T.remoteSdesParams.tag}if(I.sdesParamsList.length&&I.remoteSdesParams){I.sdesParamsList[0].tag=I.remoteSdesParams.tag}g.receiver=T;g.sender=I;if(!S(y,w,g.receiver)||!S(y,w,g.sender)){y.enabled=false;e.warn("Rejecting media since unable to match parameters")}}d.media.push(v(y,g,false,m,o.media[h].receiver.rtcpReducedSize))}e.debug(c?"CREATE PRANSWER":"CREATE ANSWER","params:",JSON.stringify(d));if(!c){s=E(d,o,false)}return d}function m(e){var t=[];var i;var o=false,s=false;var c=0;if(u){for(var d=0;d<u.media.length;d++){if(u.media[d].descr.label===r["default"].MEDIA_LABEL.audio&&!o){i=n["default"].getDescrFromState(e.audio,r["default"].MEDIA_LABEL.audio);t.push(i);o=true}else if(u.media[d].descr.label===r["default"].MEDIA_LABEL.video&&c<a){i=n["default"].getDescrFromState(e.video,r["default"].MEDIA_LABEL.video);if(c>0){i.send=false}t.push(i);c++}else if(u.media[d].descr.label===r["default"].MEDIA_LABEL.screensharing&&!s){i=n["default"].getDescrFromState(e.screensharing,r["default"].MEDIA_LABEL.screensharing);t.push(i);s=true}else{t.push({enabled:false,type:u.media[d].descr.type,label:u.media[d].descr.label})}}}if(!o&&e.audio){i=n["default"].getDescrFromState(e.audio,r["default"].MEDIA_LABEL.audio);t.push(i)}if(!s&&e.screensharing){i=n["default"].getDescrFromState(e.screensharing,r["default"].MEDIA_LABEL.screensharing);t.push(i)}for(var l=c;l<a&&e.video;l++){i=n["default"].getDescrFromState(e.video,r["default"].MEDIA_LABEL.video);if(l>0){i.send=false}t.push(i)}return t}function g(t,n,i){var a={isOffer:true,sessionVersion:u?u.sessionVersion:0,transportParams:f(n,u),media:[]};var s=false;for(var c=0;c<t.length;c++){var d=u&&u.media[c]&&u.media[c].descr.enabled;var l=!d&&t[c].enabled;var p;if(l){p=i[c]}else{p=u.media[c]}var h=s&&t[c].label===r["default"].MEDIA_LABEL.video;if(t[c].label===r["default"].MEDIA_LABEL.video){s=true}a.media.push(v(t[c],p,l,h,true))}o=a;e.debug("CREATE OFFER","params:",JSON.stringify(o));return o}function y(t){e.debug("PROCESS ANSWER","params:",JSON.stringify(t));s=E(o,t,true)}function S(t,n,r){if(t.enabled){if(!r.sdesParamsList.length||!r.remoteSdesParams){if(!n.dtlsParams){e.warn("no sdes nor dtls params:",r.sdesParamsList,r.remoteSdesParams,n.dtlsParams);return false}}if(!r.rtpCaps.codecs.length){e.warn("no common codecs!",r.rtpCaps);return false}}return true}function b(e,t){var n=[];for(var r=0;r<Math.max(e.length,t.length);r++){var a=null;if(e[r]&&t[r]){a=i["default"].shallowClone(t[r]);a.doRtcpMux=e[r].doRtcpMux&&t[r].doRtcpMux;a.enableDtls=e[r].dtlsParams&&t[r].dtlsParams}n.push(a)}return n}function w(e,t,r,i){function a(n){var r=n?e.sender:e.receiver;var a=n?t.sender:t.receiver;var o=p(e,t,i,n);o.rtcpMux=c.doRtcpMux;o.rtcpReducedSize=r.rtcpReducedSize&&a.rtcpReducedSize;o.enableDtls=c.enableDtls;return o}var o=d(e.descr,t.descr);var s={descr:o};if(o.enabled){var u=n["default"].getTransportIdxForLabel(o.label);var c=r[u];s.descr=o;s.sender=a(true);s.receiver=a(false);if(!S(o,c,s.sender)||!S(o,c,s.receiver)){throw new Error("Failed to verify negotiated parameters!")}}return s}function E(e,t,n){if(e.media.length!==t.media.length){throw new Error("Number of media lines doesn't match in offer & answer l:"+e.media.length+" r: "+t.media.length)}var r={sessionVersion:n?e.sessionVersion:t.sessionVersion,transportParams:b(e.transportParams,t.transportParams),media:[]};for(var i=0;i<e.media.length;i++){r.media.push(w(e.media[i],t.media[i],r.transportParams,n))}return r}function T(){s.sessionVersion++;u=s;e.debug("NEGOTIATED","params:",JSON.stringify(u));return u}}t.__esModule=true;t["default"]=a});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcSdp",["require","exports","microsoft-sdp-transform","../constants","./ortcHelper","../common/utils","../common/formatParameters"],e)}})(function(e,t){var n=e("microsoft-sdp-transform");var r=e("../constants");var i=e("./ortcHelper");var a=e("../common/utils");var o=e("../common/formatParameters");function s(){function e(e,t){return t?e.replace(/\\/g,"/"):e.replace(/\//g,"\\")}function t(e,t){return e.toLowerCase()===t.toLowerCase()}function s(e){return e.indexOf(":")===-1}function u(e){var t=e.iceCandidates.slice(0).sort(function(e,t){return t.priority-e.priority});for(var n=0;n<t.length;n++){if(t[n].type==="host"){return t[n].ip}}return"0.0.0.0"}function c(e,t){if(e&&t){return"sendrecv"}else if(e){return"sendonly"}else if(t){return"recvonly"}else{return"inactive"}}function d(e,t){var n=e.toUpperCase();if(n==="TCP"){switch(t.toLowerCase()){case"active":return"TCP-ACT";case"passive":return"TCP-PASS";case"so":return"TCP-SO"}}return n}function l(e,n,r){r.push({foundation:e.foundation,component:n,transport:d(e.protocol,e.tcpType),priority:e.priority,ip:e.ip,port:e.port,type:e.type,raddr:!t(e.type,"host")?e.relatedAddress:void 0,rport:!t(e.type,"host")?e.relatedPort:void 0})}function f(e,t,n,r){if(e){e.forEach(function(e){if(s(e.ip)){l(e,t,n)}else{l(e,t,r)}})}}function p(e){if(e.iceCandidatePair){return{0:e.iceCandidatePair.local,1:e.rtcpIceCandidatePair?e.rtcpIceCandidatePair.local:null}}else{var t=e.iceCandidates.slice(0).sort(function(e,t){return t.priority-e.priority});var n=t[0];var r=null;if(e.rtcpIceCandidates){for(var i=0;i<e.rtcpIceCandidates.length;++i){var a=e.rtcpIceCandidates[i];if(a.foundation===n.foundation){r=a;break}}}return{0:n,1:r}}}function v(n,i,o,u){var d=i.receiver;var l={rtp:[],fmtp:[],rtcpFb:[],ext:[],type:i.descr.type,port:0,protocol:"RTP/SAVP",payloads:"",cryptoscale:[],crypto:[],candidates:[],xCandidatesIpv6:[]};if(!i.descr.enabled){if(l.type===r["default"].MEDIA_TYPE.video){l.payloads="34"}else{l.payloads="9"}return l}var v=p(n);var h=v[0];var m=v[1];l.port=h.port;if(u.ip!==h.ip){l.connection={version:s(h.ip)?4:6,ip:h.ip}}l.iceUfrag=n.iceParams.usernameFragment;l.icePwd=n.iceParams.password;if(l.type===r["default"].MEDIA_TYPE.audio){var g=C(d.rtpCaps.codecs);l.maxptime=g.maxptime;l.ptime=g.ptime}l.direction=c(i.descr.send,i.descr.recv);l.xSsrcRange={ssrcMin:d.ssrcRange.min,ssrcMax:d.ssrcRange.max};l.ssrcGroups=I(i.sender.rtxSsrc,i.sender.ssrcRange.min);l.label=i.descr.label;if(!i.bundledWithOther){l.xSource=i.descr.label}if(d.rtcpReducedSize){l.rtcpRsize=true}if(o&&i.justAdded){if(n.doRtcpMux){l.rtcpMux=true}l.rtcp={port:m&&m.port||l.port+1}}else{if(n.doRtcpMux){l.rtcpMux=true}else{l.rtcp={port:m&&m.port||l.port+1}}}var y=null;if(d.rtpCaps&&d.rtpCaps.codecs){d.rtpCaps.codecs.forEach(function(e){l.rtp.push({payload:e.preferredPayloadType,codec:e.name,rate:e.clockRate,encoding:e.numChannels>1?e.numChannels:void 0});var n="";a["default"].forOwn(e.parameters,function(e,t){if(n!==""){n+=";"}n+=t==="events"?e:t+"="+e});if(n!==""){l.fmtp.push({payload:e.preferredPayloadType,config:n})}l.payloads+=(l.payloads?" ":"")+e.preferredPayloadType;for(var r=0;r<e.rtcpFeedback.length;r++){if(t(e.rtcpFeedback[r].type,"x-message")){y=e.rtcpFeedback[r].parameter}else{l.rtcpFb.push({payload:e.preferredPayloadType,type:e.rtcpFeedback[r].type,subtype:e.rtcpFeedback[r].parameter})}}});if(y){l.rtcpFb.push({payload:"*",type:"x-message",subtype:y})}}if(d.rtpCaps&&d.rtpCaps.headerExtensions){d.rtpCaps.headerExtensions.forEach(function(t){l.ext.push({value:t.preferredId,uri:e(t.uri,false)})})}function S(e){return e.mkiLength!==0?"|"+e.mkiValue+":"+e.mkiLength:""}if(d.sdesParamsList){for(var b=0;b<d.sdesParamsList.length;++b){var w=d.sdesParamsList[b];if(t(w.cryptoSuite,"AES_CM_128_HMAC_SHA1_80")){l.crypto.push({id:w.tag,suite:"AES_CM_128_HMAC_SHA1_80",config:w.keyParams[0].keyMethod+":"+w.keyParams[0].keySalt+"|"+w.keyParams[0].lifetime+S(w.keyParams[0])})}else if(t(w.cryptoSuite,"SCALE_AES_CM_128_HMAC_SHA1_80")){l.cryptoscale.push({id:w.tag,flavor:"client",suite:"AES_CM_128_HMAC_SHA1_80",config:w.keyParams[0].keyMethod+":"+w.keyParams[0].keySalt+"|"+w.keyParams[0].lifetime+S(w.keyParams[0])})}}}if(!i.bundledWithOther){if(n.iceCandidatePair){f([n.iceCandidatePair.local],1,l.candidates,l.xCandidatesIpv6);if(n.rtcpIceCandidatePair&&!n.doRtcpMux){f([n.rtcpIceCandidatePair.local],2,l.candidates,l.xCandidatesIpv6)}l.remoteCandidates="1 "+n.iceCandidatePair.remote.ip+" "+n.iceCandidatePair.remote.port;if(!n.doRtcpMux){l.remoteCandidates+=" 2 "+n.rtcpIceCandidatePair.remote.ip+" "+n.rtcpIceCandidatePair.remote.port}else{l.remoteCandidates+=" 2 "+n.iceCandidatePair.remote.ip+" "+n.iceCandidatePair.remote.port}}else{f(n.iceCandidates,1,l.candidates,l.xCandidatesIpv6);if(o&&i.justAdded||!n.doRtcpMux){f(n.rtcpIceCandidates,2,l.candidates,l.xCandidatesIpv6)}}l.candidates.sort(function(e,t){return+e.foundation-+t.foundation||e.foundation===t.foundation&&e.component-t.component});l.xCandidatesIpv6.sort(function(e,t){return+e.foundation-+t.foundation||e.foundation===t.foundation&&e.component-t.component});if(n.dtlsParams){l.fingerprint={type:n.dtlsParams.fingerprints[0].algorithm,hash:n.dtlsParams.fingerprints[0].value};switch(n.dtlsParams.role){case"auto":l.setup="actpass";break;case"client":l.setup="active";break;case"server":l.setup="passive";break}}}return l}this.paramsToSdp=function(e){var t={},a=e.transportParams[0]||e.transportParams[1]||e.transportParams[2],o=u(a),c=p(a),d=c[0];t.version=0;t.origin={username:"-",sessionId:0,sessionVersion:e.sessionVersion,netType:"IN",ipVer:s(o)?4:6,address:o};t.bandwidth=[{type:"CT",limit:99980}];t.timing={start:0,stop:0};t.name="session";t.connection={version:s(d.ip)?4:6,ip:d.ip};t.xMediaBw={label:r["default"].MEDIA_LABEL.video,sendBw:8100,receiveBw:8e3};t.media=[];for(var l=0;l<e.media.length;l++){var f=i["default"].getTransportIdxForLabel(e.media[l].descr.label);var h=e.transportParams[f];t.media.push(v(h,e.media[l],e.isOffer,d))}return n.write(t)};function h(e){var t=e.toLowerCase();switch(t){case"tcp-act":case"tcp-pass":case"tcp-so":return"tcp";default:return t}}function m(e){switch(e.toLowerCase()){case"tcp-act":return"active";case"tcp-pass":return"passive";case"tcp-so":return"so";default:return void 0}}function g(e){var n={foundation:e.foundation,priority:e.priority,ip:e.ip,protocol:h(e.transport),port:e.port,type:e.type};if(!t(e.type,"host")){n.tcpType=m(e.transport);n.relatedAddress=e.raddr;n.relatedPort=e.rport}return n}function y(e,t,n){if(e.candidates){e.candidates.forEach(function(e){if(e.component===t){n.push(g(e))}})}if(e.xCandidatesIpv6){e.xCandidatesIpv6.forEach(function(e){if(e.component===t){n.push(g(e))}})}}function S(e){var t=/(\w+):([a-zA-Z0-9+\/]+={0,2})(\|([0-9\^]+))?(\|([0-9]+):([0-9]+))?/;var n=e.match(t);if(!n){return void 0}var r={keyMethod:n[1],keySalt:n[2],mkiValue:0,mkiLength:0};if(typeof n[4]!=="undefined"){r.lifetime=n[4]}if(typeof n[7]!=="undefined"){r.mkiValue=+n[6];r.mkiLength=+n[7]}return r}function b(e,t){var n={};n.iceParams={usernameFragment:t.iceUfrag,password:t.icePwd};n.iceCandidates=[];y(t,1,n.iceCandidates);n.doRtcpMux=!!t.rtcpMux;if(!t.rtcpMux){n.rtcpIceParams={usernameFragment:t.iceUfrag,password:t.icePwd};n.rtcpIceCandidates=[];y(t,2,n.rtcpIceCandidates);if(e.icelite){n.rtcpIceParams.iceLite=true}}if(t.remoteCandidates){n.iceCandidatePair={}}if(e.fingerprint||t.fingerprint){var r=t.fingerprint?t.fingerprint:e.fingerprint;var i=t.setup?t.setup:e.setup;var a="auto";switch(i){case"actpass":a="auto";break;case"active":a="client";break;case"passive":a="server";break}n.dtlsParams={role:a,fingerprints:[{algorithm:r.type,value:r.hash}]}}if(e.icelite){n.iceParams.iceLite=true}return n}function w(t){var n=[];var a=[];t.rtp.forEach(function(e){var i={name:e.codec,kind:t.type,clockRate:e.rate,preferredPayloadType:e.payload,numChannels:e.encoding?e.encoding:1,rtcpFeedback:[]};if(t.type===r["default"].MEDIA_TYPE.audio){i.ptime=t.ptime;i.maxptime=t.maxptime}n.push(i)});if(t.fmtp){t.fmtp.forEach(function(e){var t=o["default"].build(e.config);if(t.contains("apt")){var r=i["default"].getCodecIndexByPayload(e.payload,n);n[r].parameters={apt:t.get("apt")}}})}if(t.ext){t.ext.forEach(function(n){a.push({kind:t.type,uri:e(n.uri,true),preferredId:n.value})})}return{codecs:n,headerExtensions:a,fecMechanisms:[]}}function E(e){if(!e.direction){e.direction="sendrecv"}var t=e.direction.toLowerCase();var n=parseInt(e.port,10)!==0;var i=function(){if(n&&!e.label){if(r["default"].MEDIA_TYPE.audio===e.type){return r["default"].MEDIA_LABEL.audio}if(r["default"].MEDIA_TYPE.video===e.type){return r["default"].MEDIA_LABEL.video}}return e.label};return{enabled:n,type:e.type,label:i(),send:n?t==="sendrecv"||t==="sendonly":false,recv:n?t==="sendrecv"||t==="recvonly":false}}function T(e){if(e){var t=a["default"].find(e,function(e){return e.semantics==="FID"});if(t){return+t.ssrcs.split(" ")[1]}}return 0}function I(e,t){if(e){return[{semantics:"FID",ssrcs:t+" "+e}]}return[]}function M(e){var n=[];function r(e,t,r,i){n.push({tag:e,cryptoSuite:t,keyParams:r,sessionParams:i})}var i=E(e);if(!i.enabled){var o={rtpCaps:null,ssrcRange:null,rtcpReducedSize:false};return{descr:i,receiver:o,sender:o}}else{if(e.cryptoscale){e.cryptoscale.forEach(function(e){var n=t(e.flavor,"server")?S(e.config):void 0;if(n){r(e.id,"SCALE_"+e.suite,[n],[])}})}if(e.crypto){e.crypto.forEach(function(e){var t=S(e.config);if(t){r(e.id,e.suite,[t],[])}})}var s={rtpCaps:w(e),sdesParamsList:n,ssrcRange:{min:e.xSsrcRange?e.xSsrcRange.ssrcMin:0,max:e.xSsrcRange?e.xSsrcRange.ssrcMax:0},rtxSsrc:T(e.ssrcGroups),rtcpReducedSize:e.rtcpRsize?true:false};return{descr:E(e),receiver:s,sender:a["default"].deepClone(s)}}}function C(e){if(e.length===0){return{ptime:0,maxptime:0}}var t=e[0].ptime;var n=e[0].maxptime;e.forEach(function(e){if(n>e.maxptime&&e.maxptime>0){n=e.maxptime}});return{ptime:t,maxptime:n}}this.sdpToParams=function(e){var t=n.parse(e);var r={sessionVersion:t.origin.sessionVersion,transportParams:[],media:[]};for(var a=0;a<t.media.length;a++){var o=t.media[a];var s=M(o);r.media.push(s);if(s.descr.enabled){var u=i["default"].getTransportIdxForLabel(s.descr.label);if(!r.transportParams[u]){r.transportParams[u]=b(t,o)}}}return r}}t.__esModule=true;t["default"]=s});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcSsrcGenerator",["require","exports"],e)}})(function(e,t){function n(){var e=4294967040;var t=Math.floor(Math.random()*(e-1))+1;this.nextAudioStreamSsrc=function(){return n(0)};this.nextVideoStreamSsrc=function(){return n(99)};function n(n){var r;do{r=t;t=(t+n+1)%e;if(t===0){t=1}}while(r+n>e);return{min:r,max:r+n}}}t.__esModule=true;t["default"]={build:function(){return new n}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcVideoRendererGroup",["require","exports","../device/videoRenderer","../common/utils","../constants","../helper"],e)}})(function(e,t){var n=e("../device/videoRenderer");var r=e("../common/utils");var i=e("../constants");var a=e("../helper");function o(e){var t=e.logger.createChild("OrtcVideoRendererGroup"),o=[],s=[];this.create=function(e,t){return new u(e,t)};this.update=function(e){s=e;o.forEach(function(e){e.update()})};this.terminate=function(){o.forEach(function(e){e.dispose()})};function u(e,u){n["default"].call(this,e,u);var c=this,d=this.dispose,l=false,f=a["default"].defer(),p,v;this.updateRecvTrack=function(e,n){t.log("renderer.updateRecvTrack - attachMediaStream","msi:",e,"track:",n);v=e;c.attachMediaStream(n?new MediaStream([n]):null)};this.subscribeVideoAsync=function(e,n){t.info("subscribeVideoAsync","msi:",e);var r=n?i["default"].RENDERER_TYPE.screensharing:i["default"].RENDERER_TYPE.video;return new Promise(function(t){if(typeof e==="undefined"){e=i["default"].MSI.subscribeAny}if(!l){var n=v!==e;if(n){h()}if(f.isPending()){f.resolve();f=a["default"].defer()}if(e===i["default"].MSI.unsubscribe||!n){f.resolve()}else{m(r,e)}}t(f.promise)})};this.dispose=function(){t.debug("disposing remote renderer");h();if(f.isPending()){f.reject(new Error("disposing renderer"))}l=true;d()};function h(){if(p){p.remove(c);p=void 0}v=void 0}function m(e,t){if(!g(e,t)){var n=a["default"].defer(),i=[],s,u=false,d=null,l=function(){if(!u){i=[];if(n.isPending()){n.reject(new Error("disposing renderer"))}if(s){s.unsubscribe()}r["default"].remove(o,function(n){return n.rendererType===e&&n.msi===t});u=true}},v=function(){if(n.isPending()){var r=y(e);if(r){r.subscribe(t);s=r;n.resolve()}}if(s){var a=s.getRecvTrack();if(a!==d){d=a;i.forEach(function(e){e.updateRecvTrack(t,d)})}}};o.push({rendererType:e,msi:t,add:function(e,t){n.promise.then(t.resolve,t.reject);i.push(e);v()},remove:function(e){r["default"].remove(i,function(t){return t===e});if(i.length===0){l()}},update:v,dispose:l})}p=g(e,t);p.add(c,f)}function g(e,t){return r["default"].find(o,function(n){return n.rendererType===e&&n.msi===t})}function y(e){return r["default"].find(s,function(t){return t.canSubscribe()&&t.label===S(e)})}function S(e){switch(e){case i["default"].MODALITY.video:return i["default"].MEDIA_LABEL.video;case i["default"].MODALITY.screensharing:return i["default"].MEDIA_LABEL.screensharing}}}}t.__esModule=true;t["default"]={build:function(e){return new o(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/activeSpeaker/dshGeneratingStrategy",["require","exports","../utils"],e)}})(function(e,t){var n=e("../utils");var r=3e3;var i=function(){function e(e){this.id=e;this.startTimestamp=0;this.totalTime=0}return e}();var a=function(){function e(e){this.sources=[];this.timeToPromote=e&&e.timeToPromote||r}e.prototype.setSources=function(e){e=e||[];var t=e.map(this.getOrCreateSource.bind(this));var n=this.excludeSources(this.sources,t);t.forEach(this.updateSourceTimestamp.bind(this,true));n.forEach(this.updateSourceTimestamp.bind(this,false));if(!this.ping){this.ping=this.setupTimer()}};e.prototype.setOnDominantSpeakerChanged=function(e){this.callback=e};e.prototype.dispose=function(){this.clearTimer();this.sources=null;this.callback=null};e.prototype.excludeSources=function(e,t){return e.filter(function(e){return!t.some(function(t){return e.id===t.id})})};e.prototype.setupTimer=function(){var e=this;var t=function(){var t=e.arrangeSources().map(e.toSourceId);if(t.length&&!n["default"].deepEqual(e.candidates,t)){e.candidates=t;if(e.callback){e.callback(t)}}e.resetTimers();e.ping=null};return setTimeout(t,this.timeToPromote)};e.prototype.clearTimer=function(){if(this.ping){clearTimeout(this.ping);this.ping=null}};e.prototype.resetTimers=function(){this.sources.forEach(function(e){e.totalTime=0})};e.prototype.getOrCreateSource=function(e){if(!this.isExist(e)){var t=new i(e);this.sources.push(t);return t}else{return this.sourceById(e)}};e.prototype.isExist=function(e){return this.sources.some(function(t){return e===t.id})};e.prototype.sourceById=function(e){return n["default"].find(this.sources,function(t){return e===t.id})};e.prototype.updateSourceTimestamp=function(e,t){if(e){if(!t.startTimestamp){t.startTimestamp=Date.now()}}else{if(t.startTimestamp){t.totalTime+=Date.now()-t.startTimestamp;t.startTimestamp=0}}};e.prototype.arrangeSources=function(){var e=function(e,t){return t.totalTime-e.totalTime};return this.sources.sort(e)};e.prototype.toSourceId=function(e){return e.id};return e}();t.DHSGeneratingStategy=a});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/ortc/ortcSession",["require","exports","./ortcTransport","./ortcMediaChannel","./ortcNegotiation","./ortcSdp","./ortcSsrcGenerator","./ortcVideoRendererGroup","./ortcHelper","../constants","../helper","../common/utils","../extensions/extensionsManager","../common/activeSpeaker/activeSpeakerManager","../common/activeSpeaker/dshGeneratingStrategy"],e)}})(function(e,t){var n=e("./ortcTransport");var r=e("./ortcMediaChannel");var i=e("./ortcNegotiation");var a=e("./ortcSdp");var o=e("./ortcSsrcGenerator");var s=e("./ortcVideoRendererGroup");var u=e("./ortcHelper");var c=e("../constants");var d=e("../helper");var l=e("../common/utils");var f=e("../extensions/extensionsManager");var p=e("../common/activeSpeaker/activeSpeakerManager");var v=e("../common/activeSpeaker/dshGeneratingStrategy");function h(){var e=this;this.STABLE="stable";this.NEGOTIATION_REQUESTED="negotiation_requested";this.HAVE_LOCAL_OFFER="have_local_offer";this.HAVE_REMOTE_PRANSWER="have_remote_pranswer";this.HAVE_REMOTE_ANSWER="have_remote_answer";this.HAVE_REMOTE_OFFER="have_remote_offer";this.HAVE_LOCAL_PRANSWER="have_local_pranswer";this.HAVE_LOCAL_ANSWER="have_local_answer";this.TERMINATED="terminated";this.state=e.STABLE;this.changing=false;function t(t){throw new Error("Invalid state change:"+e.state+" "+t+" changing: "+e.changing)}this.change=function(n,r){if(e.busy){t(n)}if(r){e.changing=r}switch(n){case e.STABLE:if(e.state!==e.HAVE_REMOTE_ANSWER&&e.state!==e.HAVE_LOCAL_ANSWER){t(n)}break;case e.NEGOTIATION_REQUESTED:if(e.state!==e.STABLE){t(n)}break;case e.HAVE_LOCAL_OFFER:if(e.state!==e.STABLE&&e.state!==e.NEGOTIATION_REQUESTED){t(n)}break;case e.HAVE_REMOTE_PRANSWER:case e.HAVE_REMOTE_ANSWER:if(e.state!==e.HAVE_LOCAL_OFFER&&e.state!==e.HAVE_REMOTE_PRANSWER){t(n)}break;case e.HAVE_REMOTE_OFFER:if(e.state!==e.STABLE&&e.state!==e.NEGOTIATION_REQUESTED){t(n)}break;case e.HAVE_LOCAL_PRANSWER:case e.HAVE_LOCAL_ANSWER:if(e.state!==e.HAVE_REMOTE_OFFER&&e.state!==e.HAVE_LOCAL_PRANSWER){t(n)}break;case e.TERMINATED:break;default:t(n)}e.state=n};this.complete=function(){e.changing=false}}function m(e,t,m){this.configureModalitiesAsync=ee;this.processOfferAsync=te;this.createAnswerAsync=ne;this.createOfferAsync=re;this.processAnswerAsync=ie;this.completeNegotiationAsync=oe;this.rejectNegotiationAsync=ue;this.createRemoteRenderer=ce;this.sendDtmf=he;this.canSendDtmf=me;this.getStatsAsync=le;this.terminate=ve;this._deviceSelectionChanged=de;this._onTerminated=null;this.onNegotiationRequired=null;this.onContributingSourcesChanged=null;this.onSessionErrorOccurred=null;this.getExtensionsManager=ge;var g=e.maContext.settings;var y=e.config.iceTransportPolicy?e.config.iceTransportPolicy:c["default"].ICE_TRANSPORT_POLICY.all;var S=e.config.isConference&&g.numVideoChannelsGvc?g.numVideoChannelsGvc:1;var b=e.getLogger().createChild("ortc");var w=e.getDeviceManager();var E=this;var T=true;var I=null;var M=new i["default"](b,g,S);var C=null;var A=new a["default"];var _=new h;var R=[];var P={};var k;var O;var x;var D=false;var U=false;var N={triggerIceReinvite:function(){if(g.disableIceReinvite){b.log("ICE-reinvite disabled - triggerIceReinvite skipped");return}b.log("triggerIceReinvite");Z(true)},raiseError:X};var L=new n["default"](b,g,N,e.maContext.getRelayManager(),e.config.isRemoteClientLync,y,T);var V=Promise.resolve({});var W=s["default"].build({logger:b});var B=o["default"].build();var j=Promise.resolve();var F=e.config.passiveModalities;var G=new f["default"];var H=new p.ActiveSpeakerManager(m.onContributingSourcesChanged,m.onDominantSpeakerChanged);H.setStrategy(new v.DHSGeneratingStategy(e.maContext.settings.activeSpeaker));b.log("create session","config:",e.config);function q(e){var t=0;for(var n=0;n<e.length;n++){if(e[n].label===c["default"].MEDIA_LABEL.audio&&!R[n]){R[n]=new r["default"](b.createChild("AStrm:"),g,e[n].type,e[n].label,X,B.nextAudioStreamSsrc(),false)}else if(e[n].label===c["default"].MEDIA_LABEL.video){if(!R[n]){R[n]=new r["default"](b.createChild("VStrm"+t+":"),g,e[n].type,e[n].label,X,B.nextVideoStreamSsrc(),false)}t++}else if(e[n].label===c["default"].MEDIA_LABEL.screensharing){if(!R[n]){var i=!e[n].send;R[n]=new r["default"](b.createChild("SSStrm:"),g,e[n].type,e[n].label,X,B.nextVideoStreamSsrc(),i)}}if(R[n]&&R[n].type!==e[n].type){throw new Error("Error in media descriptors ch.type: "+R[n].type+" descr.type: "+e[n].type)}if(R[n]&&R[n].label!==e[n].label){throw new Error("Error in media descriptors ch.label: "+R[n].label+" descr.label: "+e[n].label)}}}function z(e,t){for(var n=0;n<e.length;n++){if(e[n].label===t){return e[n]}}return null}function Y(){var e=[];for(var t=0;t<R.length;t++){if(R[t]){e[t]=R[t].getLocalParameters()}}return e}function X(e){b.error("Media error occurred","type:",e.type,"detail:",e.detail);if(E.onSessionErrorOccurred){E.onSessionErrorOccurred(e)}}function J(e){if(e){var t={};l["default"].forOwn(e,function(e,n){try{t[n]=typeof e==="function"?t[n]=e():t[n]=e}catch(e){t[n]="error: "+e}});return JSON.stringify(t)}}function K(e){if(e){b.error("_audio.onerror",J(e))}else{b.error("_audio.onerror","error:",C?C.error:"<no audio element>")}}function Q(e){if(!C){C=document.createElement("audio");document.body.appendChild(C);C.autoplay=true;C.addEventListener("error",K)}else{C.removeEventListener("error",K);C.addEventListener("error",K);window.detachMediaStream(C)}
var t=new MediaStream([e]);window.attachMediaStream(C,t)}function $(){if(C){C.removeEventListener("error",K);document.body.removeChild(C);window.detachMediaStream(C);C=null}}function Z(e){if(_.state===_.STABLE&&!_.changing){_.change(_.NEGOTIATION_REQUESTED);b.log("triggerNegotiation","mods:",JSON.stringify(k),"force:",e);D=false;if(E.onNegotiationRequired){E.onNegotiationRequired()}}else{if(e){D=true}}}function ee(e){var t=j.then(function(){return new Promise(function(t){if(!e||!e.audio&&!e.video&&!e.screensharing){throw new Error("Invalid parameters!"+JSON.stringify(e))}var n=!k||!d["default"].areNegotiatedDirectionsFulfilled(e,P);k=e;if(n){Z()}t(k)})});j=t.catch(function(e){b.warn("Error during configuring modalities: ",e)});return t}function te(e){return new Promise(function(t){U=false;var n=e.blob;b.debug("PROCESS OFFER","sdp:",n);_.change(_.HAVE_REMOTE_OFFER);var r;r=A.sdpToParams(n);M.processOffer(r);I=r.transportParams;O=d["default"].invertModalities(u["default"].getModalitiesFromMedia(r.media));t(O)})}function ne(e){return new Promise(function(t){if(e){_.change(_.HAVE_LOCAL_PRANSWER,true);x={audio:"sendrecv",video:"sendrecv",screensharing:"sendrecv"}}else{_.change(_.HAVE_LOCAL_ANSWER,true);if(!k){throw new Error("Modalities not configured for answer")}x=d["default"].excludePassiveModalities(k,F,O)}var n=M.createMediaDescriptorsForAnswer(x);function r(e,t){return t.label===e&&t.enabled}var i=n.some(r.bind(null,c["default"].MEDIA_LABEL.audio));var a=n.some(r.bind(null,c["default"].MEDIA_LABEL.video));var o=n.some(r.bind(null,c["default"].MEDIA_LABEL.screensharing));var s=L.assureInitAsync("controlled",[i,a,o]).then(function(){return L.waitIceCompletionIfNeededAsync(I).then(function(){return L.getLocalParamsAsync().then(function(t){q(n);var r=M.createAnswer(n,t,Y(),e);_.complete();var i=A.paramsToSdp(r);b.debug(e?"CREATE PRANSWER":"CREATE ANSWER","sdp:",i);return{blob:i,modalities:x}})})});t(s)})}function re(){return new Promise(function(e){U=true;_.change(_.HAVE_LOCAL_OFFER,true);x=d["default"].excludePassiveModalities(k,F,O);O=x;if(d["default"].hasSendDirectionality(x.screensharing)&&!g.allowSendScreensharing){throw new Error("unsupported shreensharing send directionality in _negotiatingModalities"+JSON.stringify(x))}var t=M.createMediaDescriptorsForOffer(x);var n=L.assureInitAsync("controlling",[!!x.audio,!!x.video,!!x.screensharing]).then(function(){return L.getLocalParamsAsync().then(function(e){q(t);var n=M.createOffer(t,e,Y());_.complete();var r=A.paramsToSdp(n);b.debug("CREATE OFFER","sdp:",r);return{blob:r,modalities:x}})});e(n)})}function ie(e,t){return new Promise(function(n){var r=e.blob;b.debug(t?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",r);if(t){_.change(_.HAVE_REMOTE_PRANSWER);b.log("ignoring provisional answer");n()}else{_.change(_.HAVE_REMOTE_ANSWER);var i;i=A.sdpToParams(r);M.processAnswer(i);n(d["default"].invertModalities(u["default"].getModalitiesFromMedia(i.media)))}})}function ae(e,t,n){return e||t||n?w._getMediaStream({audio:e,video:t||n}):null}function oe(){return new Promise(function(e){_.change(_.STABLE,true);var t=M.completeNegotiation();var n=t.media;var r=u["default"].findDescrFromMedia(n,c["default"].MEDIA_LABEL.audio);var i=u["default"].findDescrFromMedia(n,c["default"].MEDIA_LABEL.video);var a=u["default"].findDescrFromMedia(n,c["default"].MEDIA_LABEL.screensharing);var o=ae(r.send,i.send,a.send);var s=function(e){var t=arguments[1];if(o){o.dispose()}if(e){return t}throw t};e(Promise.all([L.configureTransportAsync(t.transportParams,[r.enabled,i.enabled,a.enabled]),o?o.start():Promise.resolve()]).then(function(){pe();for(var e=0;e<n.length;e++){if(n[e].descr.label===c["default"].MEDIA_LABEL.audio){var t=R[e].getRecvTrack();R[e].configureChannel(n[e],L.audioTransport,o);if(R[e].getRecvTrack()&&R[e].getRecvTrack()!==t){Q(R[e].getRecvTrack());R[e].onContributingSourcesChanged=H.onContributingSourcesChanged.bind(H)}else if(!R[e].getRecvTrack()&&t){$();R[e].onContributingSourcesChanged=null}}else if(n[e].descr.label===c["default"].MEDIA_LABEL.video){R[e].configureChannel(n[e],L.videoTransport,o)}else if(n[e].descr.label===c["default"].MEDIA_LABEL.screensharing){R[e].configureChannel(n[e],L.screensharingTransport,o)}}se();_.complete();P=u["default"].getModalitiesFromMedia(n);var r=d["default"].excludePassiveModalities(k,F,O);var i=D||!d["default"].areNegotiatedDirectionsAcceptable(r,x,P);if(i){Z()}b.log("_completeNegotiationAsync: configured:",JSON.stringify(k),"_negotiatingModalities:",JSON.stringify(x),"activeModalities:",JSON.stringify(P));return{isComplete:!i,activeModalities:P,offeredModalities:O,attemptedModalities:x,configuredModalities:k,initiator:U}}).then(s.bind(null,true),s.bind(null,false)))})}function se(){W.update(R.filter(function(e){return c["default"].MEDIA_LABEL.video===e.label||c["default"].MEDIA_LABEL.screensharing===e.label}))}function ue(e,t){return new Promise(function(n){var r=e===c["default"].RENEGOTIATION_ERROR.local;_.state=_.STABLE;b.error("negotiation failed","error:",e);if(t){b.log("retrying failed negotiation");Z()}n({isComplete:r,activeModalities:P,offeredModalities:O,attemptedModalities:x,configuredModalities:k,initiator:U})})}function ce(e,t){return W.create(e,t)}function de(){b.log("_deviceSelectionChanged");var e=d["default"].hasSendDirectionality(P.audio);var t=d["default"].hasSendDirectionality(P.video);if(!fe()&&(e||t)){var n=w._getMediaStream({audio:e,video:t});n.start().then(function(){var r;if(e){r=z(R,c["default"].MEDIA_LABEL.audio);r.updateLocalMediaStream(n)}if(t){r=z(R,c["default"].MEDIA_LABEL.video);r.updateLocalMediaStream(n)}n.dispose()}).catch(function(e){X({type:c["default"].MEDIA_ERROR.internalError,detail:e});n.dispose()})}}function le(){if(fe()){return V}V=new Promise(function(e){var n={localStreams:[{tracks:[]}],remoteStreams:[{tracks:[]}]};var r=z(R,c["default"].MEDIA_LABEL.audio);var i=z(R,c["default"].MEDIA_LABEL.video);var a=z(R,c["default"].MEDIA_LABEL.screensharing);if(r&&r.getSendTrack()){n.localStreams[0].tracks.push({stream:null,track:r.getSendTrack()})}if(i&&i.getSendTrack()){n.localStreams[0].tracks.push({stream:null,track:i.getSendTrack()})}if(a&&a.getSendTrack()){n.localStreams[0].tracks.push({stream:null,track:a.getSendTrack()})}if(r&&r.getRecvTrack()){n.remoteStreams[0].tracks.push({stream:null,track:r.getRecvTrack()})}if(i&&i.getRecvTrack()){n.remoteStreams[0].tracks.push({stream:null,track:i.getRecvTrack()})}if(a&&a.getRecvTrack()){n.remoteStreams[0].tracks.push({stream:null,track:a.getRecvTrack()})}Promise.all([r?r.getReportsAsync():{},i?i.getReportsAsync():{},a?a.getReportsAsync():{}]).then(function(r){n.ortc={CorrelationId:t,mainAudio:r[0],mainVideo:r[1],appsharingVideo:r[2]};e(n)}).catch(function(t){b.error("getting statistics should never fail:",t);e(n)})});return V}function fe(){return _.state===_.TERMINATED}function pe(){if(fe()){throw new Error("session is already terminated")}}function ve(){b.log("terminate");G.dispose();return le().then(function(){_.change(_.TERMINATED);L.stop();$();W.terminate();R.forEach(function(e){e.terminate()});if(E._onTerminated){E._onTerminated(E)}})}function he(e){var t=z(R,c["default"].MEDIA_LABEL.audio);if(t){return t.sendDtmf(e)}return Promise.reject(new Error("no audio channel"))}function me(){var e=z(R,c["default"].MEDIA_LABEL.audio);if(e){return e.canSendDtmf()}return false}function ge(){return G}}t.__esModule=true;t["default"]={build:function(e,t,n){return new m(e,t,n)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/statistics/sessionStatistics",["require","exports"],e)}})(function(e,t){function n(){var e=(new Date).getTime(),t,n,r=0,i=false,a=false,o,s=0,u=0,c="0",d=0,l={type:"none",detail:"none"},f=0,p=0;this.negotiation={offering:v(),answering:h(),current:g()};this.terminated=function(){u=(new Date).getTime();s=(new Date).getTime()-e};this.setMultiParty=function(){a=true};this.setMediaLegId=function(e){o=e};this.setId=function(e){c=e};this.setError=function(e){l.type=e.type||"internalError";l.detail=e.detail||e.toString()};this.dtmfResult=function(e){e?++f:++p};this.getReport=function(){return{CorrelationId:c,CallNumber:0,RetargetCount:0,CreationTime:y(e),InitTime:y(e),TerminationTime:y(u),CallDuration:y(s),InitialNegotiationType:t||"none",InitialNegotiationCompleted:i,NegotiationCount:r,RejectedNegotiationCount:d,MediaLegId:o,MultiParty:a,ErrorType:l.type,ErrorDetail:l.detail,DtmfSuccess:f,DtmfFailure:p}};function v(){return{started:function(){n="Offering";m()}}}function h(){return{started:function(){n="Answering";m()}}}function m(){t=t||n;++r}function g(){return{completed:function(){if(r===1){i=true}},rejected:function(){++d}}}function y(e){return e*1e4}}t.__esModule=true;t["default"]={build:function(){return new n}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/statistics/mediaLegId",["require","exports","../common/utils"],e)}})(function(e,t){var n=e("../common/utils");function r(){var e;this.process=function(t){if(!e){e=t||n["default"].uniqueId().toUpperCase()}return e}}t.__esModule=true;t["default"]={build:function(){return new r}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/session",["require","exports","./webrtc/webRtcSession","./ortc/ortcSession","./statistics/sessionStatistics","./statistics/mediaLegId","./constants"],e)}})(function(e,t){var n=e("./webrtc/webRtcSession");var r=e("./ortc/ortcSession");var i=e("./statistics/sessionStatistics");var a=e("./statistics/mediaLegId");var o=e("./constants");function s(e,t,n,r){var s=this,u=i["default"].build(),c=a["default"].build(),d=t.maContext.settings,l=0;u.setId(n);if(t.config.isConference){u.setMultiParty()}this.createOfferAsync=function(){u.negotiation.offering.started();return e.createOfferAsync.apply(e,arguments).then(function(e){e.mediaLegId=c.process(e.mediaLegId);return e}).catch(function(e){u.setError(e);throw e})};this.processOfferAsync=function(t){u.negotiation.answering.started();c.process(t.mediaLegId);return e.processOfferAsync.apply(e,arguments).catch(function(e){u.setError(e);throw e})};this.processAnswerAsync=function(){return e.processAnswerAsync.apply(e,arguments).catch(function(e){u.setError(e);throw e})};this.completeNegotiationAsync=function(){l=0;return e.completeNegotiationAsync.apply(e,arguments).then(function(e){u.negotiation.current.completed();return e}).catch(function(e){u.setError(e);throw e})};this.rejectNegotiationAsync=function(t){var n=++l<=d.renegotiationAttempts&&f(t);u.negotiation.current.rejected();return e.rejectNegotiationAsync(t,n).catch(function(e){u.setError(e);throw e})};this.terminate=function(){u.terminated();return e.terminate.apply(e,arguments)};this.getStatsAsync=function(){return e.getStatsAsync.apply(e,arguments).then(function(e){u.setMediaLegId(c.process());e.metrics=u.getReport();return e})};this.createAnswerAsync=function(){return e.createAnswerAsync.apply(e,arguments).then(function(e){e.mediaLegId=c.process(e.mediaLegId);return e}).catch(function(e){u.setError(e);throw e})};this.configureModalitiesAsync=e.configureModalitiesAsync;this.createRemoteRenderer=e.createRemoteRenderer;this._deviceSelectionChanged=e._deviceSelectionChanged;this._onTerminated=null;this.sendDtmf=function(t){return e.sendDtmf(t).then(function(e){u.dtmfResult(true);return e}).catch(function(e){u.dtmfResult(false);throw e})};this.canSendDtmf=function(){return e.canSendDtmf()};this.getExtensionsManager=function(){return e.getExtensionsManager()};e.onNegotiationRequired=r.onNegotiationRequired;e.onSessionErrorOccurred=function(t){u.setError(t);r.onSessionErrorOccurred.apply(e,arguments)};e._onTerminated=function(){if(s._onTerminated){s._onTerminated.apply(e,arguments)}};function f(e){return o["default"].RENEGOTIATION_ERROR.signaling===e||o["default"].RENEGOTIATION_ERROR.media===e}}t.__esModule=true;t["default"]={build:function(e,t,i){var a=typeof RTCIceGatherer==="undefined"?n["default"]:r["default"];return new s(a.build.apply(this,arguments),e,t,i)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/device/deviceEnumerator",["require","exports","../constants","../common/utils","../common/userAgentAdapter"],e)}})(function(e,t){var n=e("../constants");var r=e("../common/utils");var i=e("../common/userAgentAdapter");function a(e){var t=this,a=i["default"].window,o=e.logger.createChild("DeviceEnumerator"),s=e.settings,u,c,d=3e3,l={},f=Promise.resolve(),p;l[n["default"].MEDIA_DEVICE.microphone]={id:"default_audio_device",label:"Default audio device",kind:n["default"].MEDIA_DEVICE.microphone};l[n["default"].MEDIA_DEVICE.camera]={id:"default_video_device",label:"Default video device",kind:n["default"].MEDIA_DEVICE.camera};this.onDevicesChanged=void 0;this.enumerateDevices=function(){if(!a.navigator.mediaDevices||!a.navigator.mediaDevices.enumerateDevices){return Promise.reject(new Error("device enumeration unsupported"))}f=f.then(function(){return a.navigator.mediaDevices.enumerateDevices()}).then(function(e){return v(e)});return f};this.getDefaultDevices=function(){return l};this.getDeviceName=function(e){if(e===l[n["default"].MEDIA_DEVICE.microphone].id){return Promise.resolve(l[n["default"].MEDIA_DEVICE.microphone].label)}if(e===l[n["default"].MEDIA_DEVICE.camera].id){return Promise.resolve(l[n["default"].MEDIA_DEVICE.camera].label)}var r=u[e],i=r.kind===n["default"].MEDIA_DEVICE.microphone?{audio:{deviceId:e},video:true}:{audio:true,video:{deviceId:e}};return a.navigator.mediaDevices.getUserMedia(i).then(function(){return t.enumerateDevices()}).then(function(t){return t[e].label})};this.startDevicePolling=function(){var e=typeof s.devicePollingInterval!=="undefined"?s.devicePollingInterval:d;if(e===0||p||c){return}function n(){t.enumerateDevices().then(function(){c=a.setTimeout(n,e)})}o.log("starting device polling");c=a.setTimeout(n,e)};this.stopDevicePolling=function(){if(c){o.log("stopping device polling");a.clearTimeout(c);c=void 0}};function v(e){var t=h(e);return m(t)}function h(e){var t={};e.forEach(function(e){switch(e.kind){case"audioinput":if(e.deviceId!==n["default"].MEDIA_DEVICE.defaultId){t[e.deviceId]={id:e.deviceId,label:e.label,kind:n["default"].MEDIA_DEVICE.microphone}}t[l[n["default"].MEDIA_DEVICE.microphone].id]=l[n["default"].MEDIA_DEVICE.microphone];break;case"videoinput":t[l[n["default"].MEDIA_DEVICE.camera].id]=l[n["default"].MEDIA_DEVICE.camera];t[e.deviceId]={id:e.deviceId,label:e.label,kind:n["default"].MEDIA_DEVICE.camera};break}});return t}function m(e){var n=false;if(u){r["default"].forOwn(u,function(t,r){if(!e.hasOwnProperty(r)){n=true;o.log("media device removed","kind:",t.kind,"id:",t.id,"label:",t.label)}else if(t.label!==e[r].label){n=true;o.log("media device label was updated")}});r["default"].forOwn(e,function(e,t){if(!u.hasOwnProperty(t)){n=true;o.log("media device added","kind:",e.kind,"id:",e.id,"label:",e.label)}})}u=e;if(n&&t.onDevicesChanged){t.onDevicesChanged(u)}return u}function g(){p=true;t.stopDevicePolling()}if(a.navigator.mediaDevices){a.navigator.mediaDevices.ondevicechange=function(){g();t.enumerateDevices()}}}t.__esModule=true;t["default"]={build:function(e){return new a(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/device/mediaStream",["require","exports","../constants","../helper","../webrtc/resolutionTable","../common/utils","../common/userAgentAdapter"],e)}})(function(e,t){var n=e("../constants");var r=e("../helper");var i=e("../webrtc/resolutionTable");var a=e("../common/utils");var o=e("../common/userAgentAdapter");function s(e){var t=this,n=e;this.onApplyConstraints=null;this.onMute=null;this.dispose=function(){return n.dispose(this)};this.clone=function(){return n.getClient()};this.getObject=function(){return n.getObject()};this.applyConstraints=function(e){return n.applyConstraints(e)};this.setMute=function(e){n.setMute(e)};this.setHold=function(e){n.setHold(e)};this.start=function(){return n.start()};this.hasAudio=function(){return n.hasAudio()};this.hasVideo=function(){return n.hasVideo()};this.getConstraints=function(){return n.getConstraints()}}function u(e,t){var u=this,c=o["default"].window,d=e.logger.createChild("MediaStream"),l=[],f,p,v=false,h=false,m=i["default"].build(),g;var y={};this.getObject=function(){return f};this.applyConstraints=function(e){if(f&&e.maxFS&&e.maxFPS){var t=m.getResolution(e.maxFS);if(y.width!==t.width||y.height!==t.height||y.fps!==e.maxFPS){y.width=t.width;y.height=t.height;y.fps=e.maxFPS;return S().then(function(){return true})}}return Promise.resolve(false)};this.getClient=function(){var e=new s(this);l.push(e);return e};this.setMute=function(e){v=e;l.forEach(function(t){if(t.onMute){t.onMute(e)}});b()};this.setHold=function(e){h=e;b()};this.dispose=function(e){if(l.indexOf(e)>=0){a["default"].remove(l,function(t){return t===e});if(l.length===0){if(u.onDisposed){u.onDisposed()}return I()}}return Promise.resolve()};this.start=function(){if(!p){p=w(t)}return p};this.hasAudio=function(){return!!f&&f.getAudioTracks().length!==0};this.hasVideo=function(){return!!f&&f.getVideoTracks().length!==0};this.getConstraints=function(){return t};function S(){return new Promise(function(e){d.log("applying stream constraints:",JSON.stringify(y));var t=r["default"].defer();l.forEach(function(e){if(e.onApplyConstraints){e.onApplyConstraints(t.promise)}});e(T(function(){M();var e=C();p=E(e[0]());e.slice(1).forEach(function(e){p=p.catch(function(t){if(n["default"].MEDIA_ERROR.constraintNotSatisfiedError===t.type){d.warn("could not obtain constrained media stream, will attempt weaker policy");return E(e())}throw t})});return p}).then(t.resolve).catch(function(e){d.error("failed to apply constraints:",JSON.stringify(y),"error:",e);t.reject(e);throw e}))})}function b(){if(f){f.getTracks().forEach(function(e){if(typeof e.enabled!=="undefined"){e.enabled=!(e.kind==="audio"&&v)&&!h;d.log("control media stream track","kind:",e.kind,"enabled:",e.enabled,"muted:",e.muted)}})}}function w(e){d.log("queueing media stream update to:",JSON.stringify(e));return T(function(){return E(e)})}function E(e){return new Promise(function(t,n){d.log("querying user media for stream:",JSON.stringify(e));c.navigator.getUserMedia(e,t,n)}).catch(function(e){if("SourceUnavailableError"===e.name){e={type:n["default"].MEDIA_ERROR.sourceUnavailableError,detail:"media device is already used by another process: "+e.toString()}}else if("ConstraintNotSatisfiedError"===e.name){e={type:n["default"].MEDIA_ERROR.constraintNotSatisfiedError,detail:"could not obtain constrained media stream: "+e.toString()}}else{e={type:n["default"].MEDIA_ERROR.permissionDeniedError,detail:"permission to use media device was denied: "+e.toString()}}throw e}).then(function(e){f=e;b();d.log("media stream updated")})}function T(e){g.gumSerializer=g.gumSerializer||Promise.resolve();var t=g.gumSerializer.then(e);g.gumSerializer=t.catch(function(e){d.warn("previous gum operation failed:",e)});return t}function I(){if(!p){return Promise.resolve()}d.log("queueing media stream stop");return T(M)}function M(){if(f){try{f.getTracks().forEach(function(e){e.stop()});d.log("media stream stopped")}catch(e){d.warn("failed to stop media stream:",e)}}}function C(){var e=m.getResolutions().filter(function(e){return e.width<=y.width&&e.height<=y.height}).reverse().map(function(e){return function(){return A({maxWidth:y.width,minWidth:e.width,maxHeight:y.height,minHeight:e.height,maxFrameRate:y.fps})}});e.push(function(){delete t.video.mandatory;return t});return e}function A(e){if(e){d.log("Setting mandatory constraints",JSON.stringify(e))}if(y.width&&y.height&&y.fps){if(typeof t.video!=="object"){t.video={}}t.video.mandatory=e}else{delete t.video.mandatory}return t}(function(){g=e.global.mediaStream=e.global.mediaStream||{}})()}t.__esModule=true;t["default"]={build:function(e,t){return new u(e,t)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/device/deviceManager",["require","exports","../constants","./deviceEnumerator","./mediaStream","../common/utils","./videoRenderer"],e)}})(function(e,t){var n=e("../constants");var r=e("./deviceEnumerator");var i=e("./mediaStream");var a=e("../common/utils");var o=e("./videoRenderer");var s=function(e,t){this.enumerateDevicesAsync=w;this.getDeviceNameAsync=S;this.selectDevices=E;this.getSelectedDevices=T;this.muteInputAsync=P;this.unmuteInputAsync=k;this.createPreviewRenderer=I;this._getMediaStream=_;var s=this;var u=e.logger;var c={};var d=r["default"].build({logger:u,settings:e.settings});d.onDevicesChanged=function(e){c=e;f.forEach(function(t){t.outdateIfAnyDeviceRemoved(e)});if(t.onDevicesChanged){t.onDevicesChanged(a["default"].values(e))}};var l={microphone:d.getDefaultDevices()[n["default"].MEDIA_DEVICE.microphone].id,camera:d.getDefaultDevices()[n["default"].MEDIA_DEVICE.camera].id};var f=[];var p=0;var v=[];var h=true;function m(){if(v.length){var e=_({audio:true,video:true});return e.start().then(function(){v.forEach(function(t){t._attachMediaStreamRef(e)})})}return Promise.resolve()}this.Renderer=o["default"];function g(e,t){var n=a["default"].values(c);if(e.getSettings){var r=e.getSettings().deviceId;return a["default"].find(n,function(e){return e.kind===t&&e.id===r})}return a["default"].find(n,function(n){return n.kind===t&&n.label===e.label})}this.getDefaultDevices=function(){var e=_({audio:true,video:true});return e.start().catch(function(e){u.error("Could not start stream")}).then(function(){return w()}).then(function(){var t=d.getDefaultDevices();var r=e.getObject();if(r){var i=r.getAudioTracks()[0];var o=r.getVideoTracks()[0];if(i){var s=g(i,n["default"].MEDIA_DEVICE.microphone);if(s){t[n["default"].MEDIA_DEVICE.microphone]=s}}if(o){var u=g(o,n["default"].MEDIA_DEVICE.camera);if(u){t[n["default"].MEDIA_DEVICE.camera]=u}}}e.dispose();return a["default"].values(t)},function(t){e.dispose();throw t})};var y=function(e,t){o["default"].call(this,e,t);var n=this,r=this.dispose,i=null,s=false;this._attachMediaStreamRef=function(e){try{if(i){this.reattachEventListeners();i.dispose();i=null}e.onApplyConstraints=function(t){n.attachMediaStream(null);t.then(function(){n.attachMediaStream(e.getObject())})};this.attachMediaStream(e.getObject());i=e}catch(t){e.dispose();throw t}};this.dispose=function(){s=true;a["default"].remove(v,function(e){return e===n});r();if(i){i.dispose();i=null}};this.startVideoAsync=function(){var e=_({audio:true,video:true});return e.start().then(function(){if(s){e.dispose();throw new Error("disposed")}n._attachMediaStreamRef(e);v.push(n)})}};function S(e){if(window.RTCIceGatherer){return d.getDeviceName(e)}return Promise.resolve(c[e].label)}function b(e,t){return JSON.stringify(e)===JSON.stringify(t)}function w(){return d.enumerateDevices().then(function(e){c=e;return a["default"].values(e)})}function E(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){var r=e[n];if(c.hasOwnProperty(r)){t[n]=r}else{u.warn("device selection is invalid","kind:",n,"id:",r)}}}if(!b(l,t)){var i="camera"in l^"camera"in t||"microphone"in l^"microphone"in t;l=t;if(s._deviceSelectionChanged){if(!i){s._deviceSelectionChanged()}}m()}}function T(){return l}function I(e,t){return new y(e,t)}function M(t,r,o){var s=!!t.audio,c=!!t.video,l=false,v={getStream:function(){return g},isSuitable:function(e,t){return!l&&(e.audio===s&&e.video===c&&(!e.audio||r===t.microphone)&&(!e.video||o===t.camera))},outdateIfAnyDeviceRemoved:function(e){if(!l){l=!e[r]||!e[o]}}},m=p++,g=i["default"].build({global:e,logger:u},t);g.onDisposed=function(){u.log("release media stream","generation:",m,"cached:",f.length,"audio:",s,"video:",c);a["default"].remove(f,function(e){return e===v});if(!f.length){d.stopDevicePolling()}};g.start().then(function(){g.setMute(!h);s=g.hasAudio();c=g.hasVideo();u.log("created media stream","generation:",m,"cached:",f.length,"audio:",s,"video:",c);C(true,true)}).catch(function(e){if(e&&e.type===n["default"].MEDIA_ERROR.permissionDeniedError){C(g.hasAudio(),g.hasVideo())}a["default"].remove(f,function(e){return e===v});if(!f.length){d.stopDevicePolling()}});d.startDevicePolling();f.push(v);return v}function C(e,n){if(t.onDevicesPermissionChanged){t.onDevicesPermissionChanged({hasMicrophonePermission:e,hasCameraPermission:n})}}function A(e){return a["default"].find(f,function(t){return t.isSuitable(e,l)})}function _(e){u.log("retrieving media stream: ",JSON.stringify(e));var t=A(e);if(!t){var r={};if(e.audio){if(l.microphone){if(l.microphone===d.getDefaultDevices()[n["default"].MEDIA_DEVICE.microphone].id){r.audio=true}else{r.audio={deviceId:{exact:l.microphone}}}}else{u.warn("ignoring audio modality due to missing microphone selection")}}if(e.video){if(l.camera){if(l.camera===d.getDefaultDevices()[n["default"].MEDIA_DEVICE.camera].id){r.video=true}else{r.video={deviceId:{exact:l.camera}}}}else{u.warn("ignoring video modality due to missing camera selection")}}if(!r.audio&&!r.video){throw new Error("requesting nothing")}return M(r,l.microphone,l.camera).getStream().getClient()}return t.getStream().getClient()}function R(e){h=e;f.forEach(function(t){t.getStream().setMute(!e)});return Promise.resolve()}function P(){return R(false)}function k(){return R(true)}};t.__esModule=true;t["default"]=s});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/common/capabilities",["require","exports","./userAgentAdapter"],e)}})(function(e,t){var n=e("./userAgentAdapter");var r=function(){function e(e){this.window=n["default"].window;this.overrides=this.getCapabilityOverrides(e.settings);this.audio=this.getCapability("audio");this.video=this.getCapability("video");this.screensharing=this.getCapability("screensharing")}e.prototype.hasWebRtc=function(){return typeof this.window.RTCPeerConnection!=="undefined"};e.prototype.hasOrtc=function(){return typeof this.window.RTCIceGatherer!=="undefined"};e.prototype.hasMediaCapture=function(){return!!this.window.navigator.getUserMedia};e.prototype.getCapabilityOverrides=function(e){var t;if(e.capabilities){if(this.hasOrtc()){t=e.capabilities.ortc}else if(this.hasWebRtc()){t=e.capabilities.webrtc}}return t||{}};e.prototype.getCapability=function(e){if(typeof this.overrides[e]!=="undefined"){return!!this.overrides[e]}return this.hasMediaCapture()&&(this.hasOrtc()||this.hasWebRtc())};return e}();t.__esModule=true;t["default"]={build:function(e){return new r(e)}}});(function(e){if(typeof t==="object"&&typeof t.exports==="object"){var n=e(a,exports);if(n!==undefined)t.exports=n}else if(typeof o==="function"&&o.amd){o("../components/media-agent/lib/mediaAgent",["require","exports","./session","./device/deviceManager","./common/utils","./common/capabilities","./constants","./helper"],e)}})(function(e,t){var n=e("./session");var r=e("./device/deviceManager");var i=e("./common/utils");var a=e("./common/capabilities");var o=e("./constants");var s=e("./helper");var u=function(e,t){var o=e.getLogger().createChild("MA",undefined,e.settings.debug),s=o.createChild("DeviceManager"),u=new r["default"]({logger:s,settings:e.settings},t),c=[],d=a["default"].build({settings:e.settings});u._deviceSelectionChanged=function(){c.forEach(function(e){e._deviceSelectionChanged()})};function l(){return u}this.createSession=function(t,r,a){var s=o.createChild("Session",r),u={getDeviceManager:l,getLogger:function(){return s},maContext:e,config:a?a:{}},d=n["default"].build(u,r,t);d._onTerminated=function(e){i["default"].remove(c,function(t){return t===e})};c.push(d);return d};this.getDeviceManager=l;this.getCapabilities=function(){return d};this.getScreenSharingManager=function(){return{onScreensChanged:function(){return{dispose:function(){}}},enumerateScreensAsync:function(){return Promise.resolve([])},enumerateApplicationsAsync:function(){return Promise.resolve([])}}}};t.__esModule=true;t["default"]={build:function(e,t){return new u(e,t)},isPlatformSupported:function(){return navigator.getUserMedia&&(typeof RTCPeerConnection!=="undefined"||typeof RTCIceGatherer!=="undefined")},constants:o["default"],helper:s["default"]}});n=i;n(["../components/media-agent/lib/mediaAgent"]);e.MediaAgent=n("../components/media-agent/lib/mediaAgent")["default"];window.setTimeout=r})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.inherit;var r=e.Utils.isFunction;var i=e.Utils.URI;var a=e.Utils.Http;var o=e.Utils.Event;var s=e.Utils.WeakMap;var u=e.Stack.XHR;var c=function(){function n(n,r){var o=n.get(n.app.relatedHref("communication"));var s=n.get(o.link("mediaRelayAccessToken").href);var c=n.get({rel:"root"},null)?!!n.get({rel:"root"}).get("internal",false):false;var d;var l=false;var f=[];var p=[];var v=[{addresses:["coturn-mdn.cloudapp.net"],udpPort:3478,tcpPort:3478,username:"HxZMPT6f",password:"3F7PkZG8tJKnMIpi",type:"turn"}];var h;var m=0;function g(t){t=t>2?t-2:0;return e.Date.now()+t*6e4}function y(){var a;p=[];f=[];if(t.isOrtc()){a=n.send("GET",{rel:"mediaRelayAccessToken"}).then(function(){var e=s.get("userName");var t=s.get("password");var r=s.links("mediaRelay");for(var i=0,a=r;i<a.length;i++){var o=a[i];var u=n.get(o.href);if(!c&&u.get("location")=="Internet"||c&&u.get("location")=="Intranet"){p.push({addresses:[u.get("host")],udpPort:u.get("udpPort"),tcpPort:u.get("tcpPort"),password:t,username:e,type:"msturn"})}}m=g(s.get("duration"))}).catch(function(n){t.log("UcwaRelayManager::getMediaRelayAccessToken error: ",n);r&&r.record(e.TelemetryEvent.Call,{action:"getMediaRelayAccessToken",mediaType:t.useBrowserMedia()?"pluginless":"plugin",result:"failed",reason:n})})}else{a=n.send("GET",i.mergeQuery(o.link("mediaRelayAccessToken").href,{mrasType:"ietf"})).then(function(){var e=s.links("mediaRelay");var t=n.get(e[0].href);d="https://"+t.get("host")+"/relay";f.push({addresses:[],udpPort:t.get("udpPort"),tcpPort:t.get("tcpPort"),password:s.get("password"),username:s.get("userName"),type:"turn"});m=g(s.get("duration"))}).catch(function(n){t.log("UcwaRelayManager::cannot get an IETF TURN relay redirector; using a test one, err: "+n);l=true;m=0;r&&r.record(e.TelemetryEvent.Call,{action:"getIETFTurnRelayRedirector",mediaType:t.useBrowserMedia()?"pluginless":"plugin",result:"failed",reason:n})})}return a}h=y();return{queryRelaysAsync:function(n){if(n===void 0){n="msturn"}return h.then(function(){if(!l&&e.Date.now()>m){h=y();return h}}).then(function(){if(n=="msturn")return p;if(l)return v;var e=new u;return e.send({type:"GET",url:d,headers:{Accept:"application/json; charset=utf-8"}}).then(function(e){t.log("GET "+d+" returned "+e.status+" "+e.responseText);if(a.isSuccess(e.status)){var n=JSON.parse(e.responseText);f[0].addresses=[n.relay];return f}else{t.log("Cannot get an IETF TURN relay; using a test one, err: "+e.status+" "+e.statusText);return v}})})}}}return n}();var d=function(){function e(n){if(n===void 0){n={}}var i=function(){var e=n.namespace;var t=r(e)?e():e||"";return t+":"};var a=function(){var e=[];for(var n=0;n<arguments.length;n++){e[n]=arguments[n]}return t.log.apply(t,[i()].concat(e))};this.log=a;this.info=a;this.warn=a;this.error=a;this.debug=n.debug?a:function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}}
;this.createChild=function(t,r){if(r===void 0){r=n.debug}return new e({namespace:t,debug:r})}}return e}();t.MaxVideoChannels=t.isWebRtc()?1:6;var l=new s;function f(r,i){if(!l.has(r)){var a=new d({namespace:"MA",debug:true});var s=new c(r,i);var u={getLogger:function(){return a},getRelayManager:function(){return s},settings:{debug:true,preferSdesSrtp:true,enableLocalVideoConstraints:true,iceDisconnectedTimeoutMs:3e4,webrtcVideoCapabilityMaxFS:1200,webrtcVideoCapabilityMaxFPS:3e3,webrtcVideoCapabilityCheckIntervalMin:2e4,webrtcVideoCapabilityCheckIntervalMax:3e4,webrtcAudioChannelSignalingFeedback:"app recv:dsh",webrtcVideoChannelSignalingFeedback:"app recv:csrc,src",numVideoChannelsGvc:t.MaxVideoChannels}};var f=new o;var p=new o;var v={onDevicesChanged:function(e){f.fire(e)},onDevicesPermissionChanged:function(e){p.fire(e)}};var h=e.Settings.mediaAgent&&e.Settings.mediaAgent(u,v);var m=n(h||t.MediaAgent.build(u,v),{devicesChanged:f.observer,permissionsChanged:p.observer,deviceManagerCallback:v});l.set(r,m)}return l.get(r)}t.getMediaAgent=f})(t=e.Media||(e.Media={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.Model;var r=e.Utils.Property;var i=e.Utils.setHiddenProperty;var a=function(){function a(){var a=r();var o=new t.MediaStream;var s=new t.VideoChannel({name:"ActiveSpeaker Channel",isLocal:false});s.stream.setSource(o);var u=n({channel:s,participant:a.asReadOnly()});i(u,t.sInternal,{participant:a,setVideoStream:function(t){var n=s.stream,r=n.source.sink.format(),i=n.source.sink.container();n.setSource(t||o);n.source.sink.format(r);n.source.sink.container(i);e.Media.log("WebRtcActiveSpeaker::SetVideoStream  stream %c"+(t&&t._id()),"color:green;font-weight:bold")},setVideoStarted:function(e){return s.isStarted._set(e)}});return u}return a}();t.WebRtcActiveSpeaker=a})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.find;var r=e.Utils.guid;var i=e.Utils.check;var a=e.Utils.async;var o=e.Utils.assert;var s=e.Utils.extend;var u=e.Utils.random;var c=e.Utils.values;var d=e.Utils.filter;var l=e.Utils.foreach;var f=e.Utils.isEmptyObject;var p=e.Utils.isNotEmptyString;var v=e.Utils.Task;var h=e.Utils.Event;var m=e.Utils.Command;var g=e.Utils.DataUri;var y=e.Utils.Promise;var S=e.Utils.Property;var b=e.Utils.Exception;var w=e.Utils.Collection;var E=e.Utils.StringEnum;var T=e.Utils.EDoesNotExist;var I=e.Utils.EInvalidState;var M=e.Utils.ENotSupported;var C=e.Utils.EInvalidArgument;var A=e.Utils.setHiddenProperty;var _=e.Media.log;var R=e.Media.watch;var P=function(){function P(P){var k=new h,O=new h,x={},D=P.devices,U=P.ucwa,N=P.context,L=P.contextType,V=P.settings,W=P.tm,B=P.participants,j=P.selfParticipant,F=P.conversation,G=P.rConversation,H=P.rAVInvitation,q,z={},Y=P.invitation,X=P.rInvitation,J=P.operationId||r(),K=P.sessionContext||r(),Q={},$,Z=P.escalateAudioVideoUri,ee=S({value:Z?2:0}),te=S(),ne=Z?t.sEscalation:void 0,re=S({value:Y||X&&X.rel=="onlineMeetingInvitation"?t.Modality.State.Notified:t.Modality.State.Disconnected,reason:ne}),ie=S({value:$e()||Ze()?t.Modality.State.Notified:t.Modality.State.Disconnected,reason:ne}),ae=S({value:Ze()?t.Modality.State.Notified:t.Modality.State.Disconnected,reason:ne}),oe=S({value:""}),se=null,ue={},ce=P.activeSpeaker,de={audio:false,video:false},le=new t.WebRtcRemoteMediaStream,fe=new t.WebRtcLocalMediaStream,pe=w(),ve,he,me,ge=false,ye,Se,be,we={},Ee=null,Te=0,Ie=P.callId||u(),Me={Unknown:0,HoldOffered:1,HoldAnswered:2,HoldCompleted:3,ResumeOffered:4,ResumeAnswered:5,ResumeCompleted:6},Ce=E("Inactive","ReceiveOnly","SendOnly","SendReceive","Unknown"),Ae=Me.Unknown,_e=j.audio.isUnmuteRequested,Re=S({value:false}),Pe=Le(),ke,Oe,xe=D["_dm"].map(function(e){return!!e});o(F);function De(e){if(!xe())return;var t=D["_dm"]();return e?t.muteInputAsync():t.unmuteInputAsync()}var Ue=S({value:false,get:function(){return Ue()},set:m(function(n,r){var i;if(ze()&&r!==t.sEscalation){var a=n?"muteAudio":"unmuteAudio",o=U.get(j[t.sInternal].audioLink);if(!n&&_e()){_e(false);i=De(n).then(function(){return n})}else{i=v.run(function(){if(!o||!o.hasLink(a))return U.send("GET",j[t.sInternal].audioLink);else return o}).then(function(e){return U.send("POST",e.link(a).href)}).then(function(){if(!n&&_e())_e(false);return n})}}else{i=De(n).then(function(){return n})}W&&W.monitor(i,e.TelemetryEvent.Call,{action:n?"muteAudio":"unmuteAudio",type:ze()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",callId:Ie},{sendEndEventOnly:true});return i},xe)});var Ne=S({value:false,get:function(){return Ne()},set:function(e){if(!ze()&&B.size()>0){if(B(0).audio.isOnHold()&&!Ne())return e}var n=e?4:3;Te=de.video?e?4:j[t.sInternal].videoStartedBeforeHold()?3:2:0;be=e;j[t.sInternal].videoStartedBeforeHold(e?j.video.channels(0).isStarted():undefined);j[t.sInternal].audioOnHold(e);return v.run(function(){return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(n),video:t.MediaEnum.enumcastMediaConfig(Te)}))}).then(function(){return Be()}).then(function(){return Fe(e)}).then(function(){return e})}});P=null;U.event(mt);R("WebRtcAudioVideoSession("+Ie+")::state:",re);R("WebRtcAudioVideoSession("+Ie+")::audioState:",ie);R("WebRtcAudioVideoSession("+Ie+")::videoState:",ae);re.when(t.Modality.State.Connected,function(e){return ie(t.Modality.State.Connected,e)});re.when(t.Modality.State.Disconnected,function(e){ie(t.Modality.State.Disconnected,e);ae(t.Modality.State.Disconnected,e)});ae.when(t.Modality.State.Disconnected,Ke);S.observe([re,ae,oe],function(e,n,r){if(e==t.Modality.State.Connected&&n==t.Modality.State.Connected)tt(r)});oe.changed(function(e){if(!ze()&&B.size()==1){B(0).video.channels(0)[t.sInternal].isVideoOn(e==t.MediaEnum.enumcastMediaConfig(3)||e==t.MediaEnum.enumcastMediaConfig(2));te(t.MediaEnum.enumcastDirection(e))}});B.removed(function(n){var r=n[t.sInternal].audioSourceId();if(e.Media.isWebRtc()){if(se&&se[t.sInternal].audioSourceId()==r)se=null}else{delete ue[r];He(n)}});s(x,{state:re.asReadOnly(),audioState:ie.asReadOnly(),videoState:ae.asReadOnly(),start:a(at),stop:a(st),cleanup:pt,sendDtmf:ut,escalated:k.observer,errorOccured:O.observer,muted:Ue,onHold:Ne,selfVideoStream:fe,showParticipantVideo:ct,removeParticipantVideo:dt,showActiveSpeakerVideo:lt,removeActiveSpeakerVideo:ft,removeVideo:a(Je),escalationState:ee,preEscalationVideoConfig:te,isClean:Re.asReadOnly()});if(Y){s(x,{from:Y.from,accept:a(ot)})}function Le(){me=new v;me.resolve();Oe={onNegotiationRequired:function(){var e="skipping outgoing renegotiation because of pending incoming renegotiation";var t=b(e);var n=Ye();var r=false;if(n){_("RENEGO REQUIRED");me.promise.then(function(){if(ge)throw t;me=new v;return ke.createOfferAsync()}).then(function(e){r=true;if(ge)throw t;return Pt(e.blob,n)}).catch(function(e){_(e);We("reject",e);je("reject",e);y.resolve().then(function(){if(r)return ke.rejectNegotiationAsync("local",false)}).finally(function(){if(me.state()=="pending")me.resolve()})})}else{_("NEGO REQUIRED")}},onContributingSourcesChanged:rt,onDominantSpeakerChanged:function(e){},onSessionErrorOccurred:function(t){W&&W.record(e.TelemetryEvent.Call,{action:"mediaSessionError",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),reason:t,callId:Ie});var n=t.type+": "+t.detail;_("WebRtcAudioVideoSession("+Ie+")::onSessionErrorOccured",n);O.fire(n)}};return e.Media.getMediaAgent(U,W)}function Ve(){ye=new v("selfVideo");return ye.promise}function We(e,t){if(ye&&ye.state()=="pending"){if(e=="resolve")ye.resolve();else if(e=="reject")ye.reject(t)}}function Be(){Se=new v(be?"hold":"resume");return Se.promise.then(function(){return be})}function je(e,t){if(Se&&Se.state()=="pending"){if(e=="resolve")Se.resolve(be);else if(e=="reject")Se.reject(t)}}function Fe(e){var t=[];if(e){for(var n in we){var r=dt(we[n],true);t.push(r)}}else{for(var n in we){var r=ct(we[n],true);t.push(r)}}return v.waitAll(t)}function Ge(e){o(e);we[e[t.sHref]]=e}function He(e){o(e);delete we[e[t.sHref]]}function qe(e){function t(e){return e!==""}for(var n in e){if(!t(e[n])){delete e[n]}}return e}function ze(){var e=G&&G.get("state","");return e=="Conferencing"||e=="Conferenced"}function Ye(){var e,t,n=d(c(z),function(e){return e.negotiated});if(n.length>0){o(n.length==1);t=n[0];e=t.resumeAudioVideoUri||t.resource.link("renegotiations").href;o(e)}return e}function Xe(e){l(z,function(t){if(t.resource.get("sessionContext")==e)t.negotiated=true})}function Je(e){_("WebRtcAudioVideoSession("+Ie+")::removeAllVideo",e);ht(le);ht(fe);if(e!==t.sEscalation){j[t.sInternal].setVideoStream(null)}if(B.size()>0){B(0)[t.sInternal].setVideoStream(null);B(0)[t.sInternal].setVideoStarted(void 0)}}function Ke(e){_("WebRtcAudioVideoSession("+Ie+")::resetVideo",e);B.each(function(e){var n=e.video.channels(0).stream;ht(n);e[t.sInternal].setVideoStream(null)});pe.empty();if(e!==t.sEscalation){j[t.sInternal].setVideoStream(null);j[t.sInternal].videoState(t.Modality.State.Disconnected);oe("")}if(ce&&ze()){ce[t.sInternal].setVideoStream(null);le._isAttached(false);ce[t.sInternal].setVideoStarted(false)}}function Qe(e){return/\ba=inactive\b/gim.test(e)}function $e(){return Y&&!Y.hasVideo()||X&&X.rel=="onlineMeetingInvitation"&&F.meeting.availableModalities.audio()&&!F.meeting.availableModalities.video()}function Ze(){return Y&&Y.hasVideo()||X&&X.rel=="onlineMeetingInvitation"&&F.meeting.availableModalities.video()}function et(t){var n;v.run(function(){return ke.getStatsAsync()}).then(function(r){n=r&&JSON.stringify(r);_("WebRtcAudioVideoSession("+Ie+")::postMediaDiagnostics",t,n);if(n){W&&W.record(e.TelemetryEvent.Call,{action:"postMediaDiagnostics",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",mediaStats:n,reason:t,callId:Ie})}}).catch(function(e){_("WebRtcAudioVideoSession("+Ie+")::getStats failed",e)})}function tt(e){function t(e){e.local?vt(fe):ht(fe);if(!ze()){e.remote?vt(le):ht(le)}}switch(e){case"sendonly":t({local:true,remote:false});break;case"recvonly":t({local:false,remote:true});break;case"sendrecv":t({local:true,remote:true});break;case"inactive":case"":t({local:false,remote:false});break}}function nt(e){oe(e.activeModalities.video||"")}function rt(e){var n=[];for(var r in ue){var i=e.indexOf(+r);if(i!=-1)e.splice(i,1);else n.push(r)}for(var a=0,o=n;a<o.length;a++){var r=o[a];ue[r][t.sInternal].isSpeaking(false);delete ue[r]}for(var s=0,u=e;s<u.length;s++){var r=u[s];var c=void 0;if(j[t.sInternal].audioSourceId()==r){c=j}else{for(var d=0,l=B();d<l.length;d++){var f=l[d];if(f[t.sInternal].audioSourceId()==r){c=f;break}}}if(c){c[t.sInternal].isSpeaking(true);ue[r]=c}}}function it(e){if(e&&/^(Devices)?NotFoundError$/.test(e.name)&&(!D.selectedMicrophone()||ae()!="Disconnected"&&!D.selectedCamera()))e=b.call("The requested media stream could not be found, check your camera or microphone devices","DeviceNotFound",{reason:e});return e}function at(e){if(e.mainVideoConfig!=0&&de.video||e.mainVideoConfig==0&&e.audioConfig==3&&de.audio)throw b("AlreadyStarted");_("WebRtcAudioVideoSession("+Ie+")::start",e);i.state(Ne(),false);var n=e.audioConfig,a=e.video&&e.video.previewContainer,o=e.video&&e.video.container,s=e.mainVideoConfig!=0,u=Te;Te=e.mainVideoConfig;$=$||e.remoteUri;e=null;i.state(re(),[t.Modality.State.Disconnected,t.Modality.State.Notified,t.Modality.State.Connected]);if(re()==t.Modality.State.Disconnected||re()==t.Modality.State.Notified){re(t.Modality.State.Connecting)}if(ie()==t.Modality.State.Disconnected||ie()==t.Modality.State.Notified){ie(t.Modality.State.Connecting);if(!ze()&&B.size()>0)B(0)[t.sInternal].audioState(t.Modality.State.Connecting)}if(!s)ae(t.Modality.State.Disconnected);if(ae()==t.Modality.State.Disconnected&&s||ae()==t.Modality.State.Notified){ae(t.Modality.State.Connecting);if(!ze()&&B.size()>0)B(0)[t.sInternal].videoState(t.Modality.State.Connecting)}if(ie()==t.Modality.State.Connected&&ae()==t.Modality.State.Connecting){return v.run(function(){return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(n),video:t.MediaEnum.enumcastMediaConfig(Te)}))}).then(function(){return Ve()}).catch(function(e){Te=u;if(!ze()&&B.size()>0&&B(0)[t.sInternal].videoState()==t.Modality.State.Connecting){B(0)[t.sInternal].videoState(t.Modality.State.Disconnected)}ae(t.Modality.State.Disconnected);throw e})}ve=new v("starting a call");var c=v.run(function(){if(!ke){ke=Pe.createSession(Oe,r(),{isRemoteClientLync:true,isConference:ze()});le._mediaSession(ke);fe._deviceManager(Pe.getDeviceManager())}return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(n),video:t.MediaEnum.enumcastMediaConfig(Te)}))}).then(function(){j[t.sInternal].setVideoStream(fe);if(o)le.source.sink.container(o);if(a)fe.source.sink.container(a);if(ie()==t.Modality.State.Connecting&&!ze()&&B.size()>0)B(0)[t.sInternal].audioState(t.Modality.State.Ringing);return ke.createOfferAsync()}).then(function(e){return Rt([{sdp:e.blob,id:1}])}).then(function(){re(t.Modality.State.Connected);ae(oe()==""?t.Modality.State.Disconnected:t.Modality.State.Connected);return ve.resolve().promise}).catch(function(e){_("WebRtcAudioVideoSession("+Ie+")::start failed",e);e=it(e);if(e&&!e.code&&e.type)e.code=e.type;et(e);if(!H){pt(e)}else{if(H.hasLink("cancel"))U.send("POST",H.link("cancel").href,{nobatch:true});if(H["eventRecv"])pt()}if(ve.state()=="pending")ve.reject(e);re(t.Modality.State.Disconnected,e);throw e});return v.waitAll([c,ve.promise]).then(function(){})}function ot(n){o(Y,'This is an outgoing call, so it cannot be "accepted"');o(!ze(),"This is a conference");o(B.size()==1,"The caller is not in participants");_("WebRtcAudioVideoSession("+Ie+")::accept",n);var i=n&&n.video,a=i&&i.container,s=i&&i.previewContainer;Te=i?t.MediaEnum.enumcastDirection(i.direction):V&&V.supportsVideo==false?0:2;re(t.Modality.State.Connecting);ie(t.Modality.State.Connecting);B(0)[t.sInternal].audioState(t.Modality.State.Connecting);if(Y.hasVideo()){ae(t.Modality.State.Connecting);B(0)[t.sInternal].videoState(t.Modality.State.Connecting)}he=new v("accepting a call");var u;var c=v.run(function(){if(re()==t.Modality.State.Disconnected)throw t.EInvitationFailed(re.reason);j[t.sInternal].setVideoStream(fe);if(a)le.source.sink.container(a);if(s)fe.source.sink.container(s);ke=Pe.createSession(Oe,r(),{isRemoteClientLync:true,isConference:ze()});le._mediaSession(ke);fe._deviceManager(Pe.getDeviceManager());if(Y.offers.length>1)_("WebRtcAudioVideoSession("+Ie+")::accept:number of offers:",Y.offers.length);Y.offers.sort(function(e,t){var n=/\ba=label\b/gi;return n.test(e.sdp)?-1:n.test(t.sdp)?1:0});return function t(n){u=xt(Y.offers[n].sdp);return ke.processOfferAsync({blob:Y.offers[n].sdp}).catch(function(r){if(!(r&&r.code=="Canceled")){W&&W.record(e.TelemetryEvent.Call,{action:"processOfferAsync",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),reason:r,offerId:n,callId:Ie});return ke.rejectNegotiationAsync("local",false).then(function(){if(++n<Y.offers.length)return t(n);throw r}).catch(function(e){throw e})}throw r})}(0)}).then(function(e){return ke.configureModalitiesAsync(qe(!e.video?e:{audio:e.audio,video:t.MediaEnum.enumcastMediaConfig(u)}))}).then(function(){return ke.createAnswerAsync(false)}).then(function(e){return Y.acceptWithAnswer(e.blob,K)}).catch(function(e){_("WebRtcAudioVideoSession("+Ie+")::accept failed",e);if(e&&!e.code&&e.type)e.code=e.type;re(t.Modality.State.Disconnected,e);ae(t.Modality.State.Disconnected);et(e);pt(e);if(he.state()=="pending")he.reject(e);throw e});return v.waitAll([c,he.promise])}function st(n){_("WebRtcAudioVideoSession("+Ie+")::stop",n);if(re()==t.Modality.State.Connecting){var r=ve||he;if(r){r.promise.cancel();return y.resolve()}else{_("WebRtcAudioVideoSession("+Ie+")::stop cannot be called in Connecting state without a pending start or accept");return y.reject(M("stop cannot be called in Connecting state without a pending start or accept"))}}var i;if(n=="video"){if(ze()){B.each(function(e){e.video.channels(0).isStarted(false)})}var a=Ne()?4:3;Te=0;i=v.run(function(){return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(a),video:t.MediaEnum.enumcastMediaConfig(Te)}))})}else if(n===t.sEscalation||n&&n.code=="NotFound"){pt(n);i=y.resolve()}else{et(n);i=U.send("GET",G.link("audioVideo").href).then(function(e){return U.send("POST",e.link("stopAudioVideo").href,{query:{reason:n||"UserInitiatedAction"}})}).catch(function(t){_("WebRtcAudioVideoSession("+Ie+")::stop",t);W&&W.record(e.TelemetryEvent.Call,{action:"stopAudioVideo",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),reason:t,callId:Ie})}).finally(function(){return pt(n)})}return i.then(function(){})}function ut(e){if(p(e)){e=e.trim().toLowerCase();e=e.substr(0,1).toUpperCase()+e.substr(1);switch(e){case"Star":e="*";break;case"Pound":e="#";break}if(t.MediaEnum.DtmfTone[e]!==undefined){return v.run(function(){return ke.sendDtmf(e)})}}throw C("tone","out of range")}function ct(n,r){var i=new y(function(e){if(ae()==t.Modality.State.Connecting){var n=ae.changed(function(r,i,a){if(r!=t.Modality.State.Connecting){n.dispose();e()}})}else e()});return i.then(function(){var i,a;if(ae()!=t.Modality.State.Connected)throw I(ae(),t.Modality.State.Connected);if(Ne()&&!r)throw b("OnHold");_("WebRtcAudioVideoSession("+Ie+")::showParticipantVideo",n);if(n[t.sInternal].isLocal()){if(n.video.channels(0).isStarted()===false){Te=3;return v.run(function(){return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(3),video:t.MediaEnum.enumcastMediaConfig(Te)}))}).then(function(){return Ve()})}return(new v).resolve().promise}else if(ze()){if(!le._isAttached()){i=le}else{for(var o=0,s=pe();o<s.length;o++){var u=s[o];if(!u._isAttached()){i=u;break}}}if(!i){if(pe.size()<e.Media.MaxVideoChannels-1){i=new t.WebRtcRemoteMediaStream({mediaSession:ke});pe.add(i)}else{_("Cannot find available stream");throw T("No available stream")}}n[t.sInternal].setVideoStream(i);a=i._id.set(n[t.sInternal].videoSourceId()).then(function(){return i._isAttached.set(true)}).then(function(){return vt(i)}).then(function(){return Ge(n)})}else{a=(new v).reject(M("cannot start remote video in 1:1 conversation")).promise}return a})}function dt(e,n){var r;_("WebRtcAudioVideoSession("+Ie+")::removeParticipantVideo",e);if(e[t.sInternal].isLocal()){Te=2;if(!ze()){var i=B(0).video.channels(0);if(!i.isVideoOn()){Te=4}}r=v.run(function(){return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(3),video:t.MediaEnum.enumcastMediaConfig(Te)}))}).then(function(){return Ve()})}else if(ze()){r=v.wait(null,"sync").then(function(){var r=e.video.channels(0).stream;var i=r.source.sink;if(i._c()){i._c().dispose();i._c(null)}if(!n)He(e);if(r._isAttached()){return ht(r).then(function(){return r._isAttached.set(false)}).then(function(){return r._id.set(-1)}).then(function(){return e[t.sInternal].setVideoStream(null)})}})}else{r=(new v).reject(M("cannot remove remote video in 1:1 conversation")).promise}return r}function lt(){if(Ne())throw b("OnHold");o(ce);o(!le._isAttached());ce[t.sInternal].setVideoStream(le);var e=ce.channel.stream;e._id(-2);e._isAttached(true);return vt(e)}function ft(){if(Ne())throw b("OnHold");o(ce);return v.wait(null,"sync").then(function(){var e=ce.channel.stream;var n=e.source.sink;if(n._c()){n._c().dispose();n._c(null)}if(e._isAttached()){ht(e);e._isAttached(false);e._id(-2);ce[t.sInternal].setVideoStream(null)}})}function pt(n){if(Re()){_("WebRtcAudioVideoSession("+Ie+")::already cleaned up",n);return}W&&W.record(e.TelemetryEvent.Call,{action:"cleanup",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),reason:n,callId:Ie});var r=t.Modality.State.Disconnected;_("WebRtcAudioVideoSession("+Ie+")::cleanup",n);var i=y.resolve();if(ze()&&n!==t.sEscalation)Ue._set(false);else i=Ue.set(false,n);Ne._set(false);i.finally(function(){j.audio.isMuted.get();j.audio.isOnHold.get();Re(true)});j[t.sInternal].audioOnHold(false);j[t.sInternal].videoStartedBeforeHold(undefined);U.event.off(mt);Je(n);Ke(n);if(ke){ke.terminate();ke=null}B.each(function(e){e[t.sInternal].setVideoStream(null);if(n!==t.sEscalation){e.video.channels(0)[t.sInternal].isVideoOn(false);e[t.sInternal].setVideoStarted(false)}});if(n!==t.sEscalation){j.video.channels(0)[t.sInternal].isVideoOn(false);j[t.sInternal].setVideoStarted(false)}ie(r);ae(r,n);oe("")}function vt(e){return e._isRendering.set(true)}function ht(e){return e._isRendering.set(false)}function mt(e){var t=e.target.rel+" "+e.type;var n=gt[t];if(n){_("WebRtcAudioVideoSession("+Ie+")::onServerEvent: "+t);n(e.status,e.resource,e)}}var gt={"audioVideoInvitation started":function(n,r){if(r.get("direction")=="Outgoing"&&r.get("sessionContext")==K){if(re()==t.Modality.State.Disconnected){if(r.hasLink("cancel")){var i=U.send("POST",r.link("cancel").href,{nobatch:true});W&&W.monitor(i,e.TelemetryEvent.Call,{action:"cancel",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),callId:Ie})}pt()}else{H=r;H["eventRecv"]=true;ve.status('awaiting "audioVideoNegotiation started or completed" event from UCWA')}}},"conversation added":function(e,t){if(t.get("threadId")==F.threadId())G=t},"audioVideoNegotiation started":function(t,n,r){if(H&&r.sender.href==H.href){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoNegotiationStarted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),hasAnswer:n.hasLink("mediaProvisionalAnswer"),callId:Ie});if(n.hasLink("mediaProvisionalAnswer")){Dt(n.link("mediaProvisionalAnswer").href).catch(function(e){return _("Error setting provisional answer: ",e)});ve.status('awaiting "audioVideoNegotiation completed" event from UCWA')}}},"audioVideoNegotiation completed":function(t,n,r){var i;if(H&&r.sender.href==H.href){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoNegotiationCompleted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:t,reason:r.reason,hasAnswer:n&&n.hasLink("mediaAnswer"),callId:Ie});switch(t){case"Success":i=n.link("audioVideoSession").href;z[i]=z[i]||{};z[i].negotiated=true;Ee=Ut(n.link("mediaAnswer").href);ve.status('awaiting "audioVideoInvitation completed" event from UCWA');break;case"Failure":if(r.reason.subcode!="Ended"&&r.reason.subcode!="ConnectedElsewhere"&&ve)ve.status(r.reason&&r.reason.message);break}}},"audioVideoSession added":function(t,n){var r=n.href;if(n.get("sessionContext")==K){z[r]=z[r]||{};z[r].resource=n;W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoSessionAdded",type:ze()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",callId:Ie,href:r})}},"audioVideoSession deleted":function(t,n,r){if(r.target.href in z){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoSessionDeleted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:t,reason:r.reason,callId:Ie});delete z[r.target.href];if(ee()==2&&f(z)){k.fire("failure");ee(0)}}},"audioVideoInvitation completed":function(n,r,i){if(H&&H.href==r.href&&r.get("direction")=="Incoming"){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoInvitationCompleted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:n,reason:i.reason,sessionContext:r.get("sessionContext",void 0),direction:"Incoming",callId:Ie});if(n=="Success"){Xe(r.get("sessionContext"));ke.completeNegotiationAsync().then(function(e){nt(e);o(!ze());var n=B(0);if(n){n[t.sInternal].audioState(t.Modality.State.Connected);if(oe()!=""){n[t.sInternal].setVideoStream(le);n[t.sInternal].videoState(t.Modality.State.Connected)}}he.resolve();re(t.Modality.State.Connected);ae(oe()==""?t.Modality.State.Disconnected:t.Modality.State.Connected)}).catch(function(e){if(he){e=it(e);he.reject(e)}pt();re(t.Modality.State.Disconnected,e)})}else{if(he)he.reject(i.reason);pt();re(t.Modality.State.Disconnected,i.reason)}}},"audioVideoRenegotiation started":function(n,r){if(r.link("audioVideoSession").href in z){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoRenegotiationStarted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:n,hasOffer:r.hasLink("mediaOffer"),direction:r.get("direction",void 0),callId:Ie});var i="Waiting for audioVideoRenegotiation completed event";if(r.get("direction")=="Incoming"){var a=g(r.link("mediaOffer").href).data;if(!ze()&&B.size()>0){Ae=Qe(a)?Me.HoldOffered:Me.ResumeOffered}q=r;ge=true;me.promise.then(function(){return Ot(a)}).catch(function(e){_(e);pt(e);re(t.Modality.State.Disconnected,e);ge=false})}else if(ve&&ve.state()=="pending"){ve.status(i)}else if(ye&&ye.state()=="pending"){ye.status(i)}else if(Se&&Se.state()=="pending"){Se.status(i)}}},"audioVideoRenegotiation completed":function(n,r,i){var a=r.link("audioVideoSession").href;if(a in z){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoRenegotiationCompleted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:n,reason:i.reason,hasAnswer:r.hasLink("mediaAnswer"),operationId:r.get("operationId",void 0),direction:r.get("direction",void 0),callId:Ie});var s,u;if(r.get("direction")=="Outgoing"){o(r.get("operationId")in Q);delete Q[r.get("operationId")];if(n=="Success"){z[a].renegotiated=true;u=Ut(r.link("mediaAnswer").href).then(function(){return ke.completeNegotiationAsync()}).then(function(e){nt(e);ae(oe()==""?t.Modality.State.Disconnected:t.Modality.State.Connected);We("resolve");je("resolve")})}else{u=v.run(function(){return ke.rejectNegotiationAsync("signaling",false)});s=i.reason;We("reject",s);je("reject",s)}u.catch(function(e){n="Failure";s=e;We("reject",s);je("reject",s)}).finally(function(){if(ve&&ve.state()=="pending"){n=="Success"?ve.resolve():ve.reject(s||i.reason)}if(me.state()=="pending")me.resolve()})}else{if(n=="Success"){if(!ze()){if(Ae==Me.HoldAnswered)Ae=Me.HoldCompleted;else if(Ae==Me.ResumeAnswered)Ae=Me.ResumeCompleted}u=y.resolve(null,"sync").then(function(){return ke.completeNegotiationAsync()}).then(function(e){if(!ze()){if(Ae==Me.HoldCompleted&&e.activeModalities.audio=="inactive"){B(0)[t.sInternal].audioOnHold(true);B(0).video.channels(0)[t.sInternal].isVideoOn(false)}else if(Ae==Me.ResumeCompleted){B(0)[t.sInternal].audioOnHold(false)}Ae=Me.Unknown}nt(e);ae(oe()==""?t.Modality.State.Disconnected:t.Modality.State.Connected)})}else{u=y.resolve(null,"sync").then(function(){return ke.rejectNegotiationAsync("signaling",false)})}u.catch(_).finally(function(){return ge=false})}}},"audioVideo updated":function(n,r,i){if(H&&H.hasLink("audioVideo")&&r.href==H.link("audioVideo").href){W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoUpdated",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:r.get("state",void 0),status:n,reason:i.reason,callId:Ie});if(r.get("state")=="Disconnected"){et(i.reason);if(H.get("state")=="Connected"){pt();re(t.Modality.State.Disconnected)}}else if(r.get("state")=="Connected"&&i.reason&&i.reason.subcode=="SessionSwitched"&&r.link("audioVideoSession").href in z){k.fire("success");ee(0)}}},"participantAudio added":St,"participantAudio updated":St,"participantAudio deleted":St,"participantVideo added":bt,"participantVideo updated":bt,"participantVideo deleted":bt,"escalateAudio deleted":function(e,t,n){if(n.target.href==Z)Z=null},"resumeAudio added":Mt,"resumeAudioVideo added":Mt,"resumeAudio deleted":Ct,"resumeAudioVideo deleted":Ct,"dominantSpeakers added":_t,"dominantSpeakers updated":_t,"currentVideo added":At,"currentVideo updated":At};function yt(e){var r=n(B(),function(n){return n[t.sHref]==e});if(r)return r;if(!ze()&&B.size()==1)return B(0);return U.send("GET",e).then(function(e){return yt(e.link("contact").href)})}function St(e,n,r){var i=r["in"];if(G&&r.sender.href==G.href&&i){if(i.rel=="localParticipant"){switch(r.type){case"added":case"updated":if(ze()&&ee()!=1){j[t.sInternal].setMediaSourceId(r);if(n.has("audioDirection")){}if(n.has("audioMuted")){var a=n.get("audioMuted");Ue.get().then(function(){if(a&&Ue()&&_e()){_e(false);De(false)}if(a&&!Ue()){Ue._set(a)}if(!a&&Ue()){_e(true);De(true)}j.audio.isMuted.get()})}for(var s=0,u=B();s<u.length;s++){var c=u[s];if(c[t.sInternal].audioSourceId()==-1)Tt(c)}}de.audio=true;break;case"deleted":de.audio=false;break;default:o(false,"unexpected event type")}}else if(i.rel=="participant"){v.wait(yt(i.href)).then(function(e){switch(r.type){case"added":case"updated":if(ze()){e[t.sInternal].setMediaSourceId(r);U.send("GET",r.target.href).then(function(n){if(n.has("audioDirection")){e[t.sInternal].audioOnHold(n.get("audioDirection")==Ce.Inactive)}if(n.has("audioMuted"))e[t.sInternal].audioMuted(n.get("audioMuted"));if(n.has("audioSourceId"))e[t.sInternal].audioSourceId(+n.get("audioSourceId"))})}e[t.sInternal].audioState(t.Modality.State.Connected);break;case"deleted":e[t.sInternal].audioState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}})}}}function bt(e,n,r){var i=r["in"];if(G&&r.sender.href==G.href&&i){if(i.rel=="localParticipant"){switch(r.type){case"added":case"updated":de.video=true;if(ze()){j[t.sInternal].setMediaSourceId(r);var a=function(e){Tt(e).then(function(n){if(n!=-1){if(!e.video.channels(0)[t.sInternal].isVideoOn()){Et(e,"Video").then(function(t){t&&U.send("GET",t).then(function(t){It(e,{resource:t},false)})})}}})};for(var s=0,u=B();s<u.length;s++){var c=u[s];a(c)}}break;case"deleted":ht(fe);de.video=false;if(ze())j[t.sInternal].setMediaSourceId(r);j.video.channels(0)[t.sInternal].isVideoOn(false);j[t.sInternal].setVideoStarted(false);ae(t.Modality.State.Disconnected);j[t.sInternal].videoState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}}else if(i.rel=="participant"){v.wait(yt(i.href)).then(function(e){switch(r.type){case"added":case"updated":if(ze()){e[t.sInternal].setMediaSourceId(r);It(e,r).then(function(){if(Ne()&&!e.video.channels(0).isVideoOn())He(e)})}else{e[t.sInternal].setVideoStream(le);e[t.sInternal].videoState(t.Modality.State.Connected)}break;case"deleted":if(ze()){e[t.sInternal].setMediaSourceId(r);dt(e)}else{e[t.sInternal].setVideoStream(null)}e.video.channels(0)[t.sInternal].isVideoOn(false);e[t.sInternal].setVideoStarted(false);e[t.sInternal].videoState(t.Modality.State.Disconnected);break;default:o(false,"unexpected event type")}})}}}function wt(e){var n=e.target;if(G&&e.sender.href==G.href&&n.rel=="participant"&&e.type=="deleted"&&!e["in"]){return v.wait(yt(n.href)).then(function(n){if(ze()){n[t.sInternal].setMediaSourceId(e);n.video.channels(0)[t.sInternal].isVideoOn(false);n[t.sInternal].setVideoStarted(false);n[t.sInternal].videoState(t.Modality.State.Disconnected);return dt(n)}else{n[t.sInternal].setVideoStream(null)}})}}function Et(n,r){var i=r.toLowerCase()+"Link";if(n[t.sInternal][i])return y.resolve(n[t.sInternal][i]);if(n[t.sHref]){return U.send("GET",n[t.sHref]).then(function(e){var t="participant"+r;if(e.hasLink(t))return e.link(t).href})}else{W&&W.record(e.TelemetryEvent.Call,{action:"getAudioVideoHref",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),result:"failed",
reason:"no href for participant",callId:Ie});return y.resolve()}}function Tt(e){var n=e[t.sInternal].audioSourceId()!=-1?y.resolve():Et(e,"Audio").then(function(e){return e&&U.send("GET",e)}).then(function(n){return n&&n.has("audioSourceId")&&e[t.sInternal].audioSourceId.set(+n.get("audioSourceId"))});return n.then(function(){return e[t.sInternal].audioSourceId()})}function It(e,n,r){if(r===void 0){r=false}var i=n.resource;var a=n.target;return v.run(function(){return i&&i.has("videoDirection")?i:a&&U.send("GET",a.href)}).then(function(n){var i,a;if(n&&n.has("videoSourceId")){i=+n.get("videoSourceId");e[t.sInternal].videoSourceId(i)}if(n&&n.has("videoDirection")){a=n.get("videoDirection");e.video.channels(0)[t.sInternal].isVideoOn(a===Ce.SendOnly||a===Ce.SendReceive);if(!(a==Ce.Inactive||a==Ce.Unknown)){if(r)ae(t.Modality.State.Connected);e[t.sInternal].videoState(t.Modality.State.Connected);e[t.sInternal].audioState(t.Modality.State.Connected)}}_("WebRtcAudioVideoSession("+Ie+"):updateVideoState: ",e.displayName(),i,a)})}function Mt(e,t,n){var r=n["in"],i;if(r&&r.rel=="audioVideoSession"&&r.href in z){i=r.href;z[i].resumeAudioVideoUri=n.target.href;v.run(function(){if(!z[i].renegotiated){return U.wait({type:"completed",target:{rel:"audioVideoRenegotiation"},resource:function(e){return e.get("direction")=="Outgoing"&&e.link("audioVideoSession").href in z}})}}).then(kt).catch(_)}}function Ct(e,t,n){var r=n["in"];if(r&&r.rel=="audioVideoSession"&&r.href in z&&n.target.href==z[r.href].resumeAudioVideoUri){delete z[r.href].resumeAudioVideoUri}}function At(n,r,i){if(!e.Media.isWebRtc())return;var a=i["in"];if(a&&G&&i.sender.href==G.href&&a.href==G.link("audioVideo").href){var o=void 0;var s=F.videoService.activeSpeaker;var u=r.get("currentVideoId");if(j[t.sInternal].videoSourceId()==u)o=j;else{for(var c=0,d=B();c<d.length;c++){var l=d[c];if(l[t.sInternal].videoSourceId()==u){o=l;s.channel[t.sInternal].isVideoOn(true);break}}}s[t.sInternal].participant(o)}}function _t(n,r,i){if(!e.Media.isWebRtc())return;var a=i["in"];if(a&&G&&i.sender.href==G.href&&a.href==G.link("audioVideo").href){var o=void 0;var s=r.get("dominantSpeakerId");if(j[t.sInternal].audioSourceId()==s)o=j;else{for(var u=0,c=B();u<c.length;u++){var d=c[u];if(d[t.sInternal].audioSourceId()==s){o=d;break}}}se&&se[t.sInternal].isSpeaking(false);if(o){se=o;se[t.sInternal].isSpeaking(true)}}}function Rt(n){o(n.length>0);function r(e,r,i){var a="9BCE36B8-2C70-44CA-AAA6-D3D332ADBD3F",o,u={nobatch:true};if(ze()){if(Z){o=t.multipartSDP(n,a);u={headers:{"Content-Type":"multipart/alternative;boundary="+a+';type="application/sdp"',"Content-Length":""+o.length},query:{operationId:J,sessionContext:K},data:o,nobatch:true}}else{u.data=t.multipartJsonAndSDP({offers:n,boundary:a,operationId:J,sessionContext:K,threadId:F.threadId(),context:e,contextType:r});u.headers={"Content-Type":"multipart/related;boundary="+a+';type="application/vnd.microsoft.com.ucwa+json"'}}}else{u.data=t.multipartJsonAndSDP({to:i?void 0:$,offers:n,boundary:a,subject:F.topic(),importance:F.priority(),operationId:J,sessionContext:K,threadId:F.threadId(),context:e,contextType:r});u.headers={"Content-Type":"multipart/related;boundary="+a+';type="application/vnd.microsoft.com.ucwa+json"'}}if(e!==void 0)s(u.headers,{"X-MS-RequiresMinResourceVersion":2});return u}return a(Nt).call(null).then(function(n){var i=r(n.revision>=2?N:void 0,L,n.rel=="addAudioVideo"),a,o;a=U.send("POST",n.href,i).then(function(e){if(!H)H=e}).catch(function(e){_("WebRtcAudioVideoSession("+Ie+"):sendOffer: startAudioVideo failed",e);if(F.isThreadIdRejectedError(e)){F.resetThreadId();i=r(n.revision>=2?N:void 0,L,n.rel=="addAudioVideo");return U.send("POST",n.href,i)}throw e});o=U.wait({type:"completed",target:{rel:"audioVideoInvitation"},resource:{direction:"Outgoing",threadId:F.threadId(),operationId:J,sessionContext:K}}).then(function(n){_("WebRtcAudioVideoSession("+Ie+"):sendOffer: audioVideoInvitation completed",n);W&&W.record(e.TelemetryEvent.Call,{action:"audioVideoInvitationCompleted",type:ze()?"conf":"p2p",modalities:de.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",state:re(),status:n.status,reason:n.reason,direction:"Outgoing",callId:Ie});if(n.status=="Failure"){H=n.resource;H["eventRecv"]=true;throw t.EInvitationFailed(n.reason)}else{return Ee.then(function(){return ke.completeNegotiationAsync()}).catch(function(e){_("Error setting final answer: ",e);return y.resolve(null,"sync").then(function(){return ke.rejectNegotiationAsync("local",false)}).finally(function(){throw e})}).then(nt)}});return v.waitAll([a,o])})}function Pt(e,t){_("Renegotiation SDP offer:\n",e);var n=r();Q[n]="";return U.send("POST",t,{headers:{"Content-Type":"application/sdp"},query:{operationId:n},data:e,nobatch:true})}function kt(){var e=Ne()?4:3;var n=te()==4?2:te();Te=de.video?Ne()?4:n!=null?n:2:0;return ke.configureModalitiesAsync(qe({audio:t.MediaEnum.enumcastMediaConfig(e),video:t.MediaEnum.enumcastMediaConfig(Te)}))}function Ot(e){var n=xt(e);_("Incoming SDP offer:\n"+e);return ke.processOfferAsync({blob:e}).then(function(e){return ke.configureModalitiesAsync(qe(!e.video?e:{audio:e.audio,video:t.MediaEnum.enumcastMediaConfig(n)}))}).then(function(){return ke.createAnswerAsync(false)}).then(function(e){if(!ze()){if(Ae==Me.HoldOffered)Ae=Me.HoldAnswered;else if(Ae==Me.ResumeOffered)Ae=Me.ResumeAnswered}return U.send("POST",q.link("answer").href,{headers:{"Content-Type":"application/sdp"},data:e.blob,nobatch:true})})}function xt(e){var n;if(Ne()||!/\bm=video\b/gim.test(e)){n=4}else if((ae()==t.Modality.State.Connected||ae()==t.Modality.State.Connecting)&&(Te==1||Te==3)){n=3}else{n=V&&V.supportsVideo==false?0:2}return n}function Dt(e){var t=g(e).data;_("Provisional answer from the remote party:\n"+t);return v.run(function(){return ke.processAnswerAsync({blob:t},true)})}function Ut(e){var t=g(e).data;_("Final answer from the remote party:\n"+t);return v.run(function(){return ke.processAnswerAsync({blob:t},false)})}function Nt(){if(!G){var e=U.get(U.app.relatedHref("communication")).link("startAudioVideo");e.rel="startAudioVideo";return e}if(Z)return U.get(Z);return U.send("GET",G.link("audioVideo").href).then(function(e){var t=e.link("addAudioVideo");t.rel="addAudioVideo";return t})}A(x,t.sInternal,{callId:Ie,onParticipantDeleted:wt});_("WebRtcAudioVideoSession("+Ie+") created");return x}return P}();t.WebRtcAudioVideoSession=P})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.find;var r=e.Utils.check;var i=e.Utils.async;var a=e.Utils.assert;var o=e.Utils.extend;var s=e.Utils.random;var u=e.Utils.isArray;var c=e.Utils.contains;var d=e.Utils.isPrimitive;var l=e.Utils.setHiddenProperty;var f=e.Utils.Task;var p=e.Utils.Model;var v=e.Utils.Command;var h=e.Utils.Promise;var m=e.Utils.Property;var g=e.Utils.Exception;var y=e.Utils.EInvalidArgument;var S=e.Media.log;var b=e.Media.watch;var w=function(){function w(w){var E=p(),T=w.ucwa,I=w.participants,M=w.guestName,C=w.selfParticipant,A=w.settings,_=w.me.id()||"",R=w.mediaPlugin,P=w.devices,k=w.tm,O=w.conversation,x=e.Media.useBrowserMedia()?t.WebRtcAudioVideoSession:t.AudioVideoSession;var D=w.rInvitation,U=w.rConversation,N,L,V,W,B=s(),j={},F,G,H,q,z,Y,X;fe();var J=m({value:z||G?t.Modality.State.Notified:t.Modality.State.Disconnected}),K=m({value:z||H?t.Modality.State.Notified:t.Modality.State.Disconnected}),Q=m({value:z&&z.hasVideo()||q?t.Modality.State.Notified:t.Modality.State.Disconnected});a(O);if(!z&&!G)D=null;w=null;var $,Z;var ee=m({value:false,get:function(){return L?L.muted.get():ee()},set:function(n){var r;if(n){r=$;if(!r){var i=Z?Z:h.resolve();r=$=i.then(function(){return L.muted.set(n)}).then(function(){return n});$.finally(function(){$=null})}}else{r=Z;if(!r){var i=$?$:h.resolve();r=Z=i.then(function(){return L.muted.set(n)}).then(function(){return n});Z.finally(function(){Z=null})}}k&&k.monitor(r,e.TelemetryEvent.Call,{action:n?"muteAudio":"unmuteAudio",type:le()?"conf":"p2p",modalities:O.activeModalities.video()?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",callId:L[t.sInternal].callId});return r}});var te,ne;var re=m({value:false,get:function(){return L.onHold.get()},set:function(n){var r;if(n){r=te;if(!r){var i=ne?ne:h.resolve();r=te=i.then(function(){return L.onHold.set(n)}).then(function(){return n});te.finally(function(){te=null})}}else{r=ne;if(!r){var i=te?te:h.resolve();r=ne=i.then(function(){return L.onHold.set(n)}).then(function(){return n});ne.finally(function(){ne=null})}}k&&k.monitor(r,e.TelemetryEvent.Call,{action:n?"hold":"resume",type:le()?"conf":"p2p",modalities:O.activeModalities.video()?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",callId:L[t.sInternal].callId});return r}});var ie=m({value:null});var ae=e.Media.isWebRtc()?se():void 0;var oe=m.readonly(e.Media.isWebRtc()?"ActiveSpeaker":"MultiView");function se(){function e(e){var t=e?L.showActiveSpeakerVideo():L.removeActiveSpeakerVideo();return t.then(function(){return e})}var n=m();var r=new t.WebRtcActiveSpeaker;r.channel.isStarted=m({value:false,set:v(e,n)});var i=O.state.equalsAny(t.Conversation.State.Conferenced,t.Conversation.State.Conferencing);var a={};var o=m.numeric(0);function s(e){var n=r.participant();if(n&&n[t.sHref]==e[t.sHref]){r.channel.isStarted(false);r.channel[t.sInternal].isVideoOn(false);r[t.sInternal].participant(void 0)}}m.observe([Q,i,o],function(e,i,a){var o=e==t.Modality.State.Connected&&i&&a>0;if(!o&&r.channel.isStarted())r.channel.isStarted(false);n(o);r.channel[t.sInternal].isVideoOn(o)});I.added(function(e){a[e[t.sHref]]=e.video.channels(0).isVideoOn.changed(function(t,n,r){if(r!==void 0){t?o.inc():o.dec();if(!t)s(e)}})});I.removed(function(e){var n=a[e[t.sHref]];n&&n.dispose();delete a[e[t.sHref]];s(e)});return r}function ue(){b("AudioVideoModality("+B+")::state:",J);b("AudioVideoModality("+B+")::audioState:",K);b("AudioVideoModality("+B+")::videoState:",Q);J.when(t.Modality.State.Disconnected,function(e,n){if(n!=t.Modality.State.Disconnected)ce(e)});O.state.when(t.Conversation.State.Disconnected,function(e){if(e&&e.code=="NotFound")U=null;J(t.Modality.State.Disconnected,e)});O.activeModalities.audio.when(true,Se);O.activeModalities.video.when(true,Se);K.when(t.Modality.State.Connected,function(){ie(new e.Date);S("%c Call connected "+ie(),"color:green;font-weight:bold")});K.changed(C[t.sInternal].audioState);Q.changed(C[t.sInternal].videoState);o(E,{state:J.asReadOnly(),audioState:K.asReadOnly(),videoState:Q.asReadOnly(),connectedAt:ie.asReadOnly(),videoMode:oe,activeSpeaker:ae,muted:ee,onHold:re,showParticipantVideo:we,removeParticipantVideo:Ee});if(z){E.from=z.from;k&&k.record(e.TelemetryEvent.Call,{action:"audioVideoInvitation",type:O.isGroupConversation()?"conf":"p2p",hasVideo:z.hasVideo(),mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye()})}T.event(ve);S("AudioVideoModality("+B+") created")}function ce(e){var n=B+(L?":"+L[t.sInternal].callId:"");S("AudioVideoModality("+n+")::reset",e);a(J()==t.Modality.State.Disconnected,"reset should be called with Disconnected state");if(L){L.state.changed.off(J);L.audioState.changed.off(K);L.videoState.changed.off(Q);if(L._onSessionError){L._onSessionError.dispose();L._onSessionError=null}if(e&&e.code=="NotFound")L.stop(e);else{V=L}}K(t.Modality.State.Disconnected,e);Q(t.Modality.State.Disconnected,e);if(!le()&&I(0)){I(0)[t.sInternal].audioState(t.Modality.State.Disconnected);I(0)[t.sInternal].videoState(t.Modality.State.Disconnected)}D=null;fe();L&&L.isClean.once(true,function(){L=null})}function de(e,t,n){var r=m();E[e]=v(i(n),r);J.changed(function(e){var n=c(t,function(t){return u(t)?e==t[0]&&J.reason===t[1]:e==t});r(n)})}function le(){var e=U&&U.get("state","");return e=="Conferencing"||e=="Conferenced"}function fe(){F=D&&D.rel=="audioVideoInvitation";G=D&&D.rel=="onlineMeetingInvitation"&&O.meeting&&O.meeting.state()=="Notified"&&(O.meeting.availableModalities.audio()||O.meeting.availableModalities.video());H=A&&A.supportsAudio==false?false:G&&O.meeting.availableModalities.audio();q=A&&A.supportsVideo==false?false:G&&O.meeting.availableModalities.video();z=F&&t.AudioVideoInvitation({resource:D,ucwa:T,from:me(D)});Y=F&&D}function pe(e){var n;if(e=="success"){n=L.muted();S("AudioVideoModality("+B+") escalation success: old AVS("+L[t.sInternal].callId+"), new AVS("+W[t.sInternal].callId+")");L.state.changed.off(J);L.audioState.changed.off(K);L.videoState.changed.off(Q);if(L._onSessionError){L._onSessionError.dispose();L._onSessionError=null}L.stop(t.sEscalation);L=W;if(W._onSessionError){W._onSessionError.dispose();W._onSessionError=null}W.escalated.off(pe);L.state.changed(J);L.audioState.changed(K);L.videoState.changed(Q);L._onSessionError=L.errorOccured(function(e){L.stop(e).finally(function(){return J(t.Modality.State.Disconnected)})});W=null;if(n)L.muted(n)}else if(e=="failure"){S("AudioVideoModality("+B+") escalation failure: old AVS("+L[t.sInternal].callId+"), new AVS("+W[t.sInternal].callId+")");W.escalated.off(pe);if(W._onSessionError){W._onSessionError.dispose();W._onSessionError=null}W.stop();W=null}else{a(false)}}function ve(e){var n=e.target.rel+" "+e.type;var r=e.resource;switch(n){case"conversation added":if(r.get("threadId")==O.threadId())U=r;break;case"conversation deleted":if(U&&U.href==e.target.href)U=null;break;case"escalateAudio added":if(U&&e.sender.href==U.href)Te({uri:e.target.href});break;case"escalateAudioVideo added":if(U&&e.sender.href==U.href)Te({uri:e.target.href,video:true});break;case"audioVideoInvitation completed":if(!L&&Y&&Y.href==r.href&&r.get("direction")=="Incoming"){if(e.status=="Failure")J(t.Modality.State.Disconnected,e.reason);if(e.status=="Success"&&J()==t.Modality.State.Notified&&!J.reason)J(t.Modality.State.Disconnected,"AcceptedByOtherInstance")}break;case"audioVideoInvitation started":if(r.has("direction")&&r.get("direction")=="Incoming"){U=he();if(U&&U.href==r.link("conversation").href){Y=r;z=t.AudioVideoInvitation({resource:r,ucwa:T,from:me(r)});J(t.Modality.State.Notified);if(z.hasVideo())Q(t.Modality.State.Notified);K(t.Modality.State.Notified)}}break;case"onlineMeetingInvitation started":if(r.get("direction","")=="Incoming"){U=he();if(U&&U.href==r.link("conversation").href){D=r;fe();J(t.Modality.State.Notified);q&&Q(t.Modality.State.Notified);H&&K(t.Modality.State.Notified)}}break;case"onlineMeetingInvitation completed":if(r.get("direction","")=="Incoming"){U=he();if(!L&&U&&U.href==r.link("conversation").href&&J()==t.Modality.State.Notified&&!J.reason){if(e.status=="Success"){J(t.Modality.State.Disconnected,"AcceptedByOtherInstance")}else if(e.reason&&e.reason.subcode=="ConnectedElsewhere"){J(t.Modality.State.Disconnected,e.reason)}}}break}}function he(){var e=O[t.sHref];return e?T.get(e):null}function me(e){var r=n(I(),function(n){return n[t.sHref]==e.link("from").href}),i,a;if(!r){i=T.get(e.link("from").href);a=i.get("uri");I.each(function(e){if(e.person.id()==a)r=e})}return r}function ge(e){return L&&L[t.sInternal].onParticipantDeleted(e)}function ye(){return!e.Media.useBrowserMedia()?P&&P.mediaCapabilities.installedVersion():void 0}function Se(){if(le()&&E.start.enabled()&&O.chatService.state()!=t.Modality.State.Disconnected&&O.meeting.state()==t.OnlineMeeting.State.Connected){if(O.activeModalities.video()&&Q()==t.Modality.State.Disconnected&&K()!=t.Modality.State.Connected){J(t.Modality.State.Notified,j);Q(t.Modality.State.Notified);K(t.Modality.State.Notified);if(!z)z={hasVideo:function(){return true}}}else if(O.activeModalities.audio()&&K()==t.Modality.State.Disconnected){J(t.Modality.State.Notified,j);K(t.Modality.State.Notified);if(!z)z={hasVideo:function(){return false}}}}}function be(e){if(!e)return;e=e===true?{direction:"sendrecv"}:e;if(!e.direction)o(e,{direction:"sendrecv"});if(e&&P&&P.cameras().length==0){if(O.isGroupConversation()){switch(e.direction){case"sendonly":e.direction="";break;case"inactive":break;default:e.direction="recvonly"}}else{e.direction="recvonly"}}return e}de("start",[t.Modality.State.Connected,[t.Modality.State.Notified,j],t.Modality.State.Disconnected],function(n){var i=O.isGroupConversation();var a;n=n||{};N=n.to;S("AudioVideoModality("+B+")::start",n);var o=n.context===void 0?void 0:d(n.context)?n.contextType||"text/plain":"text/json";var s=d(n.context)?n.context:JSON.stringify(n.context);if(!i){if(!N)N=I(0).uri();else r(I.size()==0,"ambiguous remote party in 1:1 call");r(N,"the remote participant URI is not specified")}if(!L){if(V){S("AudioVideoModality("+B+")::cleanup session:"+V[t.sInternal].callId);V.cleanup();V=null}L=new x({ucwa:T,mediaPlugin:R,devices:P,tm:k,localUri:_,context:s,contextType:o,invitation:z,rInvitation:D,conversation:O,rConversation:U,participants:I,selfParticipant:C,activeSpeaker:ae,settings:A,callId:n.callId,operationId:n.operationId,sessionContext:n.sessionContext});L.state.changed(J);L.audioState.changed(K);L.videoState.changed(Q);L._onSessionError=L.errorOccured(function(e){L.stop(e).finally(function(){return J(t.Modality.State.Disconnected)})})}a=f.wait(null).then(function(){if(O.meeting){if(O.meeting.state()==t.Modality.State.Created){return O.meeting.start({name:M&&M(),uri:O.uri()})}}else if(i){return O.addMeeting().start({name:M&&M(),uri:O.uri()})}}).then(function(){return P&&P.init().catch()}).then(function(){n.video=be(n.video);var e=n.video&&t.MediaEnum.enumcastDirection(n.video.direction);return L.start({remoteUri:N,audioConfig:3,mainVideoConfig:e||0,video:n.video})}).then(function(){if(le()&&U.hasLink("addParticipant"))O[t.sInternal].inviteParticipants()});if(J()!==t.Modality.State.Notified)k&&k.monitor(a,e.TelemetryEvent.Call,{action:K()==="Disconnected"?"start":"addVideo",modalities:n.video?"av":"audio",type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),joinType:O.isGroupConversation()&&M&&M()?"anon":undefined,callId:L[t.sInternal].callId,contextType:o});return a});de("stop",[t.Modality.State.Connected,t.Modality.State.Connecting],function(n){if(!L)return;if(X)return X;var r=[],i="stop";var a=L[t.sInternal].callId;S("AudioVideoModality("+B+")::stop",n);if(J()==t.Modality.State.Connecting){X=L.stop()}else if(n=="video"){i="stopVideo";r.push(L.stop(n));if(W)r.push(W.stop(n));X=f.waitAll(r)}else if(!n){r.push(L.stop());if(W){W.escalated.off(pe);r.push(W.stop())}X=f.waitAll(r).finally(function(){return J(t.Modality.State.Disconnected)})}else{throw y("modality","must be omitted or contain `video`")}k&&k.monitor(X,e.TelemetryEvent.Call,{action:i,type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),joinType:O.isGroupConversation()&&M&&M()?"anon":undefined,callId:a,callState:J()});X.finally(function(){X=null});return X});de("accept",[t.Modality.State.Notified],function(n){var r;n=n||{};J(t.Modality.State.Notified,j);S("AudioVideoModality("+B+")::accept",n);if(G){n.callId=s();r=O.meeting.accept().then(function(){return E.start(n)})}else if(O.meeting&&O.meeting.state()=="Connected"){return E.start(n)}else{a(!L);if(V){S("AudioVideoModality("+B+")::cleanup session:"+V[t.sInternal].callId);V.cleanup();V=null}L=new x({ucwa:T,mediaPlugin:R,devices:P,tm:k,localUri:_,rAVInvitation:Y,conversation:O,rConversation:U,participants:I,selfParticipant:C,activeSpeaker:ae,invitation:z,settings:A});L.state.changed(J);L.audioState.changed(K);L.videoState.changed(Q);L._onSessionError=L.errorOccured(function(e){L.stop(e).finally(function(){return J(t.Modality.State.Disconnected)})});var i=P?P.init().catch():h.resolve();r=i.then(function(){n.video=be(n.video);return L.accept(n)})}k&&k.monitor(r,e.TelemetryEvent.Call,{action:"accept",type:O.isGroupConversation()?"conf":"p2p",modalities:n.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),hasVideo:z.hasVideo?z.hasVideo():void 0,sdpCount:z.offers&&z.offers.length,callId:n.callId||L&&L[t.sInternal].callId});return r});de("decline",[t.Modality.State.Notified],function(n){if(n===void 0){n="Global"}if(O.meeting&&O.meeting.state()=="Connected"){J(t.Modality.State.Disconnected);return}var r=G?O.meeting.decline(n):z.decline(n);S("AudioVideoModality("+B+")::decline",w);r.then(function(){J(t.Modality.State.Disconnected)});k&&k.monitor(r,e.TelemetryEvent.Call,{action:"decline",type:O.isGroupConversation()?"conf":"p2p",modalities:z.hasVideo()?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),callId:L&&L[t.sInternal].callId});return r});de("sendDtmf",[t.Modality.State.Connected],function(n){var r=L.sendDtmf(n);k&&k.monitor(r,e.TelemetryEvent.Call,{action:"sendDtmf",type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),callId:L[t.sInternal].callId});return r});de("transfer",[t.Modality.State.Connected],function(n){var r=T.get(O[t.sHref]);var i=T.get(r.link("audioVideo").href);var a=s();var o=T.send("POST",i.link("transfer").href,{revision:2,data:{to:n,operationId:a}}).then(function(){return T.wait({type:"completed",target:{rel:"transfer"},resource:function(e){return e.get("operationId",null)==a}}).then(function(e){if(e.status!="Success")throw g("TransferFailed",{reason:e.reason})})});k&&k.monitor(o,e.TelemetryEvent.Call,{action:"transfer",type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),callId:L[t.sInternal].callId});return o});function we(n){var r=L.showParticipantVideo(n);k&&k.monitor(r,e.TelemetryEvent.Call,{action:"showParticipantVideo",isLocal:n[t.sInternal].isLocal(),type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),callId:L[t.sInternal].callId});return r}function Ee(n){var r=L.removeParticipantVideo(n);k&&k.monitor(r,e.TelemetryEvent.Call,{action:"removeParticipantVideo",isLocal:n[t.sInternal].isLocal(),type:O.isGroupConversation()?"conf":"p2p",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),callId:L[t.sInternal].callId});return r}function Te(n){var r;a(!W);a(le());S("AudioVideoModality("+B+")::startEscalation");W=new x({ucwa:T,mediaPlugin:R,devices:P,tm:k,localUri:_,conversation:O,rConversation:U,participants:I,selfParticipant:C,activeSpeaker:ae,escalateAudioVideoUri:n.uri,settings:A});W.escalated(pe);L.escalationState(1);W.preEscalationVideoConfig(L.preEscalationVideoConfig());W._onSessionError=W.errorOccured(function(e){W.stop(e)});if(n.video)L.removeVideo();r=W.start({remoteUri:N,audioConfig:4,mainVideoConfig:n.video?4:0,video:n.video});k&&k.monitor(r,e.TelemetryEvent.Call,{action:"escalate",type:"conf",modalities:n.video?"av":"audio",mediaType:e.Media.useBrowserMedia()?"pluginless":"plugin",pluginVersion:ye(),oldCallId:L[t.sInternal].callId,callId:W[t.sInternal].callId});return r}ue();l(E,t.sInternal,{onParticipantDeleted:ge});return E}return w}();t.AudioVideoModality=w})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.guid;var r=e.Utils.Model;var i=e.Utils.Command;var a=e.Utils.Promise;var o=e.Utils.Property;var s=e.Utils.DisabledAsyncCommand;var u=function(){function e(e){var u=e.tm,c=e.ucwa,d=e.name,l=e.invitation,f=e.conversation;var p=o.just(l?t.Modality.State.Notified:t.Modality.State.Disconnected);function v(e){p(t.Modality.State.Connecting);var r=n();return a.resolve().then(function(){if(f.meeting&&f.meeting.state()==t.OnlineMeeting.State.Created){return f.meeting.start({name:d(),uri:f.uri()})}if(f.isGroupConversation()&&!f.meeting){return f.addMeeting().start({name:d(),uri:f.uri()})}}).then(function(){var e=f[t.sHref];if(e){var n=g().link("addPhoneAudio");n.rel="addPhoneAudio";return n}else{var n=c.get(c.app.relatedHref("communication")).link("startPhoneAudio");n.rel="startPhoneAudio";return n}}).then(function(t){return c.send("POST",t.href,{data:{operationId:r,threadId:f.threadId(),phoneNumber:e&&e.teluri||f.selfParticipant.person.workPhone(),to:f.isGroupConversation()?void 0:t.rel=="addPhoneAudio"?void 0:f.participants(0).person.id()}})}).then(function(){return c.wait({type:"completed",target:{rel:"phoneAudioInvitation"},resource:function(e){return e.get("operationId",null)==r}}).then(function(e){if(e.status!="Success")throw t.EInvitationFailed(e.reason)})}).then(function(){p(t.Modality.State.Connected)},function(e){p(t.Modality.State.Disconnected,e);throw e})}function h(){p(t.Modality.State.Disconnecting);return a.resolve().then(function(){var e=g().link("stopPhoneAudio").href;return c.send("POST",e)}).then(function(){p(t.Modality.State.Disconnected)},function(e){p(t.Modality.State.Disconnected,e);throw e})}function m(e){if(e===void 0){e="Global"}p(t.Modality.State.Disconnecting);return a.resolve().then(function(){var t=l.link("decline").href;return c.send("POST",t,{data:{reason:e}})}).then(function(){p(t.Modality.State.Disconnected)},function(e){p(t.Modality.State.Disconnected,e);throw e})}function g(){var e=f[t.sHref];if(!e)throw Error("rel=conversation does not exist yet");return c.get(c.get(e).link("phoneAudio").href)}function y(e,t){return u?u.monitored("pstn",{action:t})(e):e}c.observe("phoneAudio updated",function(e){var n=e.sender,r=e.resource;if(n.href==f[t.sHref]&&r.get("state")=="Disconnected"&&p()==t.Modality.State.Connected){p(t.Modality.State.Disconnected)}});return r({state:p.asReadOnly(),start:i.async(y(v,"start"),p.equals(t.Modality.State.Disconnected)),stop:i.async(y(h,"stop"),p.equals(t.Modality.State.Connected)),accept:s(),reject:i.async(y(m,"reject"),p.equals(t.Modality.State.Notified))})}return e}();t.PhoneAudio=u})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){var t=function(){function t(t,n){return e.ObservableResource(t,n,function(e){e.property("conferenceId");e.property("externalDirectoryUri");e.property("internalDirectoryUri");e.property("isAudioConferenceProviderEnabled");e.property("participantPassCode");e.property("tollNumber");e.property("tollFreeNumbers");e.member("defaultRegion",function(e){e.property("name");e.property("number");e.property("languages")})})}return t}();e.PhoneDialInInformation=t})(t=e.Internal||(e.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.assert;var i=e.Utils.extend;function a(e){var t=e.offers,r=e.boundary,a=e.subject,s=e.importance,u=e.operationId,c=e.threadId,d=e.sessionContext||n(),l=e.context,f=e.contextType,p="D63E5F1E-56D8-4EC4-B51B-02762CEA97D9",v="4EFFF0D8-65D2-4E52-9A1B-0FA835D4B478",h="2CAE7DF5 -0185-4FB8-84E7-AA6C57F10432",m="--"+r+"\r\n",g=m,y,S,b;y={operationId:u,threadId:c,subject:a,importance:s,sessionContext:d,mediaOffer:"cid:"+v};if(l!==void 0)i(y,{customContent:"cid:"+h});if(e.to){y.to=e.to}else{y.telemetryId=n();y.joinAudioMuted=false;y.joinVideoMuted=false}S=JSON.stringify(y);g+="Content-Type: application/vnd.microsoft.com.ucwa+json\r\n"+"Content-Length: "+S.length+"\r\n"+"\r\n"+S+"\r\n";g+=m;b=o(t,p);g+="Content-ID: "+v+"\r\n"+"Content-Type: multipart/alternative;boundary="+p+';type="application/sdp"\r\n'+"Content-Length: "+b.length+"\r\n"+b;if(l!==void 0){g+="\r\n";g+=m;g+="Content-ID: "+h+"\r\n"+"Content-Type:"+f+"\r\n"+"Content-Disposition: render; handling=optional"+"\r\n"+"\r\n"+l}return g+"\r\n--"+r+"--\r\n"}t.multipartJsonAndSDP=a;function o(e,t){var n="\r\n",r;for(r=0;r<e.length;++r)n+=s(e[r],t);n+="\r\n--"+t+"--\r\n";return n}t.multipartSDP=o;function s(e,t){r(e&&e.sdp&&e.id&&t);return"\r\n"+"--"+t+"\r\n"+"Content-Type: application/sdp\r\n"+"Content-ID: "+e.id+"\r\n"+"Content-Length: "+e.sdp.length+"\r\n"+"\r\n"+e.sdp}})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.assert;var i=e.Utils.extend;var a=e.Utils.Event;var o=e.Utils.Property;var s=e.Media.log;var u=e.Media.PluginComponent;var c=function(){function e(e){var c=e.channelId,d=e.mediaPlugin,l=e.container||o(),f=o({value:u.State.Unloaded}),p=new a,v=null,h=null,m=new t.VideoChannel({name:"local"});function g(e){if(arguments.length==0){return c}else{c=e;return this}}function y(e){r(!v);e=e||l();r(e);v=d.createComponent({type:"VideoUI",hide:false});v.state.changed(I);v.event(b,"async");v.setContainer(e);return v.load().then(function(){v.invoke("CreateVideoUI",false);h=E("GetRenderWindow")})}function S(){if(v){v.invoke("DestroyVideoWindows");v.unload();v.event.off(b);v.state.changed.off(I);f(u.State.Unloaded);v=null;h=null}}function b(e){if(e.type=="VIDEO_SIZE_CHANGED"){p.fire({width:e.args[0],height:e.args[1]})}}function w(){return h=h||E("GetRenderWindow")}function E(e){r(e=="GetRenderWindow");if(v){var t=v.invoke(e);if(t.succeeded)return t[1]}return null}function T(e){if(e===void 0){e=l()}r(e);v.invoke("ResizeWindow",e.clientWidth,e.clientHeight)}function I(e){s("Video channel "+c+" "+v.id()+" pcVideoUI.state = "+e);if(e==u.State.Unloading)e=u.State.Unloaded;f(e)}return{container:l,channelId:g,createVideoWindow:n(y),destroyVideoWindow:S,videoWindow:w,resizeVideoWindow:T,videoWindowState:f.asReadOnly(),resized:p.observer,channel:i(m,{isStarted:o({value:false,set:function(e){return l.set(e?m.stream.source.sink.container():null).then(function(){return e})}})})}}return e}();t.LocalVideoChannel=c})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.check;var i=e.Utils.assert;var a=e.Utils.foreach;var o=e.Utils.Model;var s=e.Utils.Property;var u=e.Utils.Collection;var c=e.Utils.ConstProperty;var d=e.Media.PluginManager;var l=function(){function l(l){var f=l.mediaPlugin,p=l.msi,v=l.pkg,h=l.dmg,m=l.tm;var g=null;var y=d.State.Uninitialized;var S;var b;var w=u({subscribed:x,get:x});var E=u({subscribed:x,get:x});var T=u({subscribed:x,get:x});var I=s({set:function(e){L(M(),e);return e}});var M=s({set:function(e){L(e,I());return e}});var C=s({set:function(e){if(e)g.invoke("SetSelectedVideoDevice",e.id());return e}});var A=s({value:!!e.Media.MediaAgent.isPlatformSupported()});var _=u();if(p)_.add(p,"msi");if(v)_.add(v,"pkg");if(h)_.add(h,"dmg");var R=s.bool(true);var P=s.bool(true);var k={isPluginInstalled:d().isPluginInstalled,installedVersion:d().installedVersion,isBrowserMediaSupported:A.asReadOnly(),pluginDownloadLinks:_.size()?_.asReadOnly():d().pluginDownloadLinks,isMicrophoneEnabled:R.asReadOnly(),isCameraEnabled:P.asReadOnly()};var O=new t.LocalVideoChannel({mediaPlugin:f,container:s({value:null,set:function(e){if(y!=d.State.Initialized&&!e){i(this()===null);return this()}return x().then(function(){if(!O.videoWindow()&&e)return O.createVideoWindow(e)}).then(function(){if(e){r(C(),"No video camera");g.invoke("StartVideoPreview",O.videoWindow(),C().name());O.resized(N)}else{g.invoke("StopVideoPreview");O.destroyVideoWindow();O.resized.off(N)}return e})}})});function x(){m&&m.record(e.TelemetryEvent.DevicesInit,{action:"init",state:y});S=S||d().state.changed(function(e,t,n){if(e==d.State.Uninitialized){D()}});if(y==d.State.Uninitialized){y=d.State.Initializing;b=f.initMedia().then(function(){g=f.createComponent({type:"TuningWizard",hide:true});g.event(U,"async");return g.load().then(function(){V(g.invoke("GetAudioRenderDevicesDescription"));W(g.invoke("GetAudioCaptureDevicesDescription"))
;B(g.invoke("GetVideoDevicesDescription"));y=d.State.Initialized})}).catch(function(t){m&&m.record(e.TelemetryEvent.DevicesInit,{action:"initDevicesMgrFailed",state:y,reason:t});D()});m&&m.monitor(b,e.TelemetryEvent.DevicesInit,{action:"initDevicesMgr",state:y})}return b}function D(){if(g){g.event.off(U);g=null}if(S){S.dispose();S=null}O.destroyVideoWindow();O.resized.off(N);y=d.State.Uninitialized}function U(e){if(y!=d.State.Initialized)return;if(e.type=="AUDIO_DEVICES_CHANGED"){V(g.invoke("GetAudioRenderDevicesDescription"));W(g.invoke("GetAudioCaptureDevicesDescription"))}else if(e.type=="VIDEO_DEVICES_CHANGED"){B(g.invoke("GetVideoDevicesDescription"))}}function N(e){g.invoke("ResizeWindow",O.videoWindow(),e.width,e.height)}function L(e,t){if(e&&t)g.invoke("SetSelectedAudioDevices",e.id(),t.id())}function V(e){i(e.succeeded);var t,n,r=[],a;for(t=1;t<e.length-1;t++){a=o({id:c(e[t]),name:c(e[t]),type:c("Speaker")});r.push(a)}n=r[e[e.length-1]];j(E,r);M(n||null,s.sUpdated)}function W(e){i(e.succeeded);var t,n,r=[],a;for(t=1;t<e.length-1;t++){a=o({id:c(e[t]),name:c(e[t]),type:c("Microphone")});r.push(a)}n=r[e[e.length-1]];j(w,r);I(n||null,s.sUpdated)}function B(e){i(e.succeeded);var t,n,r=[],a;for(t=1;t<e.length-1;t++){a=o({id:c(e[t]),name:c(e[t]),type:c("Camera"),localVideoChannel:O.channel});r.push(a)}n=r[e[e.length-1]];j(T,r);C(n||null,s.sUpdated)}function j(e,t){var n=[];e.each(function(e,r){var i=false,a;for(a=0;a<t.length;a++){if(e.id()==t[a].id()){i=true;t.splice(a,1);break}}if(!i)n.push(r)});a(n,function(t){e.remove(t)});a(t,function(t){e.add(t)})}return o({init:n(x),uninit:n(D),speakers:E.asReadOnly(),microphones:w.asReadOnly(),cameras:T.asReadOnly(),selectedSpeaker:M,selectedMicrophone:I,selectedCamera:C,mediaCapabilities:k,localVideoChannel:O.channel})}return l}();t.PluginDevicesManager=l})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.Model;var r=e.Utils.Property;var i=e.Utils.SourcedModel;var a=e.Utils.ConstProperty;var o=e.Utils.setHiddenProperty;var s=e.Media.log;var u=function(){function u(u){if(u===void 0){u={}}var c=u.name,d=u.isLocal,l=r(),f=r(),p=r({value:false}),v=e.Media.useBrowserMedia()?d?new t.WebRtcLocalMediaStream:new t.WebRtcRemoteMediaStream:new t.MediaStream,h=i(v);var m=n({camera:a("unknown"),stream:h,isStarted:l,isVideoOn:p.asReadOnly(),isOnHold:f});h.setSource(v);h.state.changed(function(n,r,i){s("VideoChannel "+c+" ("+"): stream state: %c"+i+" -> "+n,"color:green;font-weight:bold","Reason: ",r);if(e.Media.useBrowserMedia()){switch(n){case t.MediaEnum.StreamState.Active:m.isStarted._set(true);break;case t.MediaEnum.StreamState.Stopped:m.isStarted._set(false);break}if(d)p(n==t.MediaEnum.StreamState.Active||n==t.MediaEnum.StreamState.Inactive)}});o(m,t.sInternal,{isVideoOn:p});return m}return u}();t.VideoChannel=u})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.async;var r=e.Utils.assert;var i=e.Utils.Model;var a=e.Utils.Command;var o=e.Utils.Property;var s=e.Utils.EnabledCommand;var u=e.Utils.EInvalidArgument;var c=e.Media.log;var d=e.Media.PluginComponent;var l=function(){function e(e){if(e===void 0){e={}}var l=e.mediaPlugin,f=o({value:d.State.Unloaded}),p=o({value:e.container,set:a(function(e){return e},f.equalsAny(d.State.Unloaded,d.State.Loaded))}),v=o({value:t.MediaEnum.VideoFormat.Fit,set:a(function(e){return e},f.equalsAny(d.State.Unloaded,d.State.Loaded)),check:function(e){if(!(e in t.MediaEnum.VideoFormat))throw u("format","`format` value is Fit, Crop or Stretch.")}}),h=o({value:{}}),m=o(),g=null;e=null;function y(e){return{Fit:0,Crop:1,Stretch:2}[e]}function S(){r(!g);r(p());g=l.createComponent({type:"VideoUI",hide:false});g.state.changed(I);g.event(T,"async");g.setContainer(p());return g.load().then(function(){var e;g.invoke("CreateVideoUI",false);e=g.invoke("GetRenderWindow");m(e[1])})}function b(){if(g){g.invoke("DestroyVideoWindows");g.unload();if(g){E()}}}function w(){r(p());g.invoke("ResizeWindow",p().clientWidth,p().clientHeight)}function E(){g.event.off(T);g.state.changed.off(I);f(d.State.Unloaded);g=null;m(null)}function T(e){if(e.type=="VIDEO_SIZE_CHANGED"){h({width:e.args[0],height:e.args[1]})}}function I(e){c("Video sink "+g.id()+" pcVideoUI.state = "+e);if(e==d.State.Unloading)e=d.State.Unloaded;if(e===d.State.Unloaded&&f()!==d.State.Unloaded&&g){E()}else{f(e)}}return i({container:p,format:v,_format:v.map(y),_init:s(n(S)),_uninit:s(b),_resize:s(w),_videoWindow:m.asReadOnly(),_state:f.asReadOnly(),_size:h.asReadOnly(),_c:o({value:null}),_f:o({value:null})})}return e}();t.VideoSink=l})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.setHiddenProperty;var r=e.Utils.Model;var i=e.Utils.Property;var a=e.Utils.BoolProperty;var o=e.Media.log;var s=function(){function e(e){if(e===void 0){e={}}var s=i({value:t.MediaEnum.StreamState.Stopped}),u=r({sink:new t.VideoSink(e)}),c=i({value:0}),d=i({value:0}),l=a(false),f=i({value:e.id}),p=i({value:false});var v=r({state:s.asReadOnly(),source:u,width:c.asReadOnly(),height:d.asReadOnly(),_id:f,_isAttached:p});n(v,"_state",s);n(v,"_isFlowing",l);n(v,"_setResolution",function(e,t){});s.changed(function(e,t,n){o("MediaStream ("+f()+"): stream state: %c"+n+" -> "+e,"color:green;font-weight:bold","Reason: ",t)});return v}return e}();t.MediaStream=s})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n;(function(t){"use strict";var n=e.Utils.Enum;var r=e.Utils.StringEnum;t.PreferredMediaAddressType=n("None","Direct","Relay");t.MediaDeviceType=n("MIC","SPEAKER","PREVIEW","RENDER");t.VideoFormat=r("Fit","Crop","Stretch");t.NegotiationStatus=n("NS_SUCCESS","NS_LOCAL_INTERNAL_ERROR","NS_REMOTE_INTERNAL_ERROR","NS_OFFER_NOT_ACCEPTABLE","NS_OFFER_DECLINED","NS_LOCAL_CANCEL","NS_REMOTE_CANCEL","NS_REMOTE_MIME_UNSPPORTED");t.MediaEvent=r("OFFER_READY","CHANNEL_CREATED","CHANNEL_DELETED","ANSWER_READY","CONNECTIVITY_CHECK_STATUS","MEDIA_CHANGED","INVALID_PROXY_CREDENTIAL");t.AVEvent=r("DEVICE_INTENSITY_CHANGED","VIDEO_SIZE_CHANGED","NEG_STATUS","CHANNEL_DIRECTION_CHANGED","CHANNEL_DISCONNECTED","QUALITY_CHANGED","AUDIO_DEVICE_CHANGED","VIDEO_DEVICE_CHANGED","DOMINANT_SPEKAER_CHANGED","SUBSCRIPTION_STATE_CHANGED","CONTRIBUTING_SOURCES_CHANGED","VIDEO_CAPABILITY_CHANGED");t.StreamState=r("Stopped","Started","Inactive","Active");t.StreamType=n("Preview","MainRender","Render");t.DtmfTone=n("0","1","2","3","4","5","6","7","8","9","Star","Pound","A","B","C","D","Flash","*","#");function i(e){var t;(function(e){e[e[""]=0]="";e[e["sendonly"]=1]="sendonly";e[e["recvonly"]=2]="recvonly";e[e["sendrecv"]=3]="sendrecv";e[e["inactive"]=4]="inactive"})(t||(t={}));return t[e]}t.enumcastDirection=i;function a(e){return["","sendonly","recvonly","sendrecv","inactive"][e]}t.enumcastMediaConfig=a;function o(e){var n=t.StreamState,r;switch(e){case 1:r=n.Started;break;case 2:r=n.Active;break;case 3:r=n.Inactive;break;case 4:r=n.Stopped;break}return r}t.enumcastStreamState=o})(n=t.MediaEnum||(t.MediaEnum={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.setHiddenProperty;var r=e.Utils.Task;var i=e.Utils.Model;var a=e.Utils.Symbol;var o=e.Utils.Promise;var s=e.Utils.Command;var u=e.Utils.Property;var c=e.Media.log;var d=a("tmpStopped");var l=function(){function e(e){if(e===void 0){e={}}var n=u({value:e.container});var r=u({value:t.MediaEnum.VideoFormat.Fit,set:function(e){return t.MediaEnum.VideoFormat.Fit}});return i({container:n,format:r,_c:u({value:null})})}return e}();t.LetterboxedVideoSink=l;var f=function(){function e(e){if(e===void 0){e={}}var a=u({value:t.MediaEnum.StreamState.Stopped}),f=i({sink:new l}),p=u({value:0}),v=u({value:0}),h=u({value:e.mediaSession}),m,g=u({value:-2}),y=u({value:false}),S=u({value:false,set:s(I,h.map(function(e){return!!e}))}),b=false;var w=i({state:a.asReadOnly(),source:f,width:p.asReadOnly(),height:v.asReadOnly(),_id:g,_isRendering:S,_isAttached:y});var E={onVideoSizeChanged:function(e,n){c("WebRtcRemoteMediaStream: onVideoSizeChanged "+e+" X "+n);if(e&&n)a(t.MediaEnum.StreamState.Active);p(e);v(n)}};n(w,"_state",a);n(w,"_mediaSession",h);a.changed(function(e,t,n){c("MediaStream ("+g()+"): stream state: %c"+n+" -> "+e,"color:green;font-weight:bold","Reason: ",t)});function T(e){return function(t,n,r){if(S()||b){var i=e(r)?S.set(false,d):o.resolve(false);if(e(t))i.then(function(){return S.set(true)});else i.then(function(){return b=true})}}}g.changed(T(function(e){return e>0}));f.sink.container.changed(T(function(e){return!!e}));function I(e,n){b=false;if(e){if(!f.sink.container()||g()===-1){b=true;return o.resolve(!e)}m=m||h().createRemoteRenderer(f.sink.container(),E);var i=m.getVideoElement();i.style.width="100%";i.style.height="100%";return r.run(function(){var e=m.subscribeVideoAsync(g());if(a()==t.MediaEnum.StreamState.Stopped)a(t.MediaEnum.StreamState.Started);return e}).then(function(){if(a()!=t.MediaEnum.StreamState.Active)a(t.MediaEnum.StreamState.Inactive);return e}).catch(function(n){a(t.MediaEnum.StreamState.Stopped,n);return!e})}else{m&&m.dispose();m=null;a(n===d?t.MediaEnum.StreamState.Inactive:t.MediaEnum.StreamState.Stopped);return o.resolve(e)}}return w}return e}();t.WebRtcRemoteMediaStream=f;var p=function(){function e(e){if(e===void 0){e={}}var a=u({value:t.MediaEnum.StreamState.Stopped}),f=i({sink:new l}),p=u({value:0}),v=u({value:0}),h=u({value:e.deviceManager}),m,g=u({value:e.deviceId}),y=u({value:false}),S=u({value:false,set:s(T,h.map(function(e){return!!e}))}),b=false;var w=i({state:a.asReadOnly(),source:f,width:p.asReadOnly(),height:v.asReadOnly(),_id:g,_isRendering:S,_isAttached:y});var E={onVideoSizeChanged:function(e,n){c("WebRtcLocalMediaStream: onVideoSizeChanged "+e+" X "+n);if(e&&n)a(t.MediaEnum.StreamState.Active);p(e);v(n)}};n(w,"_state",a);n(w,"_deviceManager",h);a.changed(function(e,t,n){c("MediaStream ("+g()+"): stream state: %c"+n+" -> "+e,"color:green;font-weight:bold","Reason: ",t)});f.sink.container.changed(function(e,t,n){if(S()||b){var r=n?S.set(false,d):o.resolve(false);if(e)r.then(function(){return S.set(true)});else r.then(function(){return b=true})}});function T(e,n){b=false;if(e){if(!f.sink.container()){b=true;return o.resolve(!e)}m=m||h().createPreviewRenderer(f.sink.container(),E);var i=m.getVideoElement();i.style.width="100%";i.style.height="100%";return r.run(function(){var e=m.startVideoAsync();if(a()==t.MediaEnum.StreamState.Stopped)a(t.MediaEnum.StreamState.Started);return e}).then(function(){if(a()!=t.MediaEnum.StreamState.Active)a(t.MediaEnum.StreamState.Inactive);return e}).catch(function(n){a(t.MediaEnum.StreamState.Stopped,n);return!e})}else{m&&m.dispose();m=null;a(n===d?t.MediaEnum.StreamState.Inactive:t.MediaEnum.StreamState.Stopped);return o.resolve(e)}}return w}return e}();t.WebRtcLocalMediaStream=p})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.Model;var i=e.Utils.Property;var a=e.Media.log;var o=function(){function e(e){var o=e.devicesManager,s=e.parentDevice,u=i({value:s.name()||s.id()}),c=i({value:false,set:p}),d=i(),l=new t.WebRtcLocalMediaStream({deviceId:s.id()});var f=r({camera:u.asReadOnly(),stream:l,isStarted:c,isVideoOn:c.asReadOnly(),isOnHold:d});n(o);l.state.changed(function(e,t,n){a("VideoChannel "+u()+" ("+l["_id"]()+"): stream state: %c"+n+" -> "+e,"color:green;font-weight:bold","Reason: ",t)});function p(e){if(e){var t=o.selectedCamera();if(t&&t.id()!=s.id()){var r=o.cameras.filter(function(e){return e.id()==s.id()});n(r.size()==1);o.selectedCamera(r(0))}l._deviceManager(o["_dm"]())}return l._isRendering.set(e)}return f}return e}();t.WebRtcLocalVideoChannel=o})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.find;var r=e.Utils.async;var i=e.Utils.inherit;var a=e.Utils.foreach;var o=e.Utils.Task;var s=e.Utils.Model;var u=e.Utils.Promise;var c=e.Utils.Property;var d=e.Utils.Collection;var l=e.Utils.ConstProperty;var f=e.Utils.setHiddenProperty;var p=e.Media.log;var v=function(){function e(e,t){var n=c({value:e.label});function r(e){return e[0].toUpperCase()+e.substr(1).toLowerCase()}t.then(function(e){return n(e)});return s({id:l(e.id),name:n.asReadOnly(),type:l(r(e.kind))})}return e}();t.WebRtcDevice=v;var h=function(){function h(h){var m=d({subscribed:L,get:L});var g=d({subscribed:L,get:L});var y=d({subscribed:L,get:L});var S=c({set:function(e){W(e,b());return e}});var b=c({set:function(e){W(S(),e);return e}});var w=l({id:l("default_speaker"),name:l("Default Speaker"),type:l("Speaker"),readOnly:true});g.add(s({id:l("default_speaker"),name:l("Default Speaker"),type:l("Speaker")}));var E;var T;var I;var M;var C=c();var A=c();var _=c({value:!!e.Media.MediaAgent.isPlatformSupported()});var R=c({value:void 0,reason:"NotNeeded"});var P=c({value:void 0,reason:"NotNeeded"});var k=c.bool(false);var O=c.bool(false);var x=d();var D={isBrowserMediaSupported:_.asReadOnly(),isPluginInstalled:R.asReadOnly(),installedVersion:P.asReadOnly(),pluginDownloadLinks:x.asReadOnly(),isMicrophoneEnabled:k.asReadOnly(),isCameraEnabled:O.asReadOnly()};var U=c();var N;function L(){if(!E){E=e.Media.getMediaAgent(h);T=E.getDeviceManager();U(T);if(!I){I=E.devicesChanged(function(e){return B(e)})}if(!M){M=E.permissionsChanged(function(e){e&&k(e.hasMicrophonePermission);e&&O(e.hasCameraPermission)})}return u.resolve().then(function(){return T.getDefaultDevices()}).then(function(e){var t=n(e,function(e){return e.kind=="microphone"});var r=n(e,function(e){return e.kind=="camera"});if(!t||!r)throw"No default device found";var i=t.id;var a=r.id;T.selectDevices({microphone:i,camera:a});if(i!="default"&&i!="default_audio_device")C(i);if(a!="default"&&a!="default_video_device")A(a)}).catch(function(e){return p("Cannot get device ID from track!",e)}).then(function(){return T.enumerateDevicesAsync()}).then(function(e){return B(e)}).then(function(){})}}function V(){for(var e=0,t=y();e<t.length;e++){var n=t[e];n.localVideoChannel.isStarted(false)}if(I){I.dispose();I=null}if(M){M.dispose();M=null}E=null;T=null;return U.set(null)}function W(e,t){if(e&&t){T.selectDevices({microphone:e.id(),camera:t.id()});C(e.id());A(t.id())}}function B(e){var n=[],r=[],a=[];var s=function(e){var s=o.run(function(){return T.getDeviceNameAsync(e.id)});var u=new v(e,s);a.push(s);if(u.type()=="Camera"&&u.id()!="default_video_device"&&u.id()!="default"){var c=i(u,{localVideoChannel:new t.WebRtcLocalVideoChannel({devicesManager:N,parentDevice:u})});r.push(c)}else if(u.type()=="Microphone"&&u.id()!="communications"&&u.id()!="default_audio_device"&&u.id()!="default"){n.push(u)}};for(var c=0,d=e;c<d.length;c++){var l=d[c];s(l)}return u.all(a).then(function(){F(m,n);F(y,r);j(m,S,C);j(y,b,A)})}function j(e,t,n){var r;if(n()){e.each(function(e,t){if(e.id()==n()){r=e}});if(!r){t(void 0,c.sUpdated);n(void 0)}else if(!t()||t().id()!=r.id()){t(r,c.sUpdated)}}else if(e.size()==1){t(e(0),c.sUpdated);n(e(0).id())}}function F(e,t){var n=[];e.each(function(e,r){var i=false;for(var a=0;a<t.length;a++){if(e.id()==t[a].id()){i=true;t.splice(a,1);break}}if(!i)n.push(r)});a(n,function(t){return e.remove(t)});a(t,function(t){return e.add(t)})}N=s({init:r(L),uninit:r(V),speakers:g.asReadOnly(),microphones:m.asReadOnly(),cameras:y.asReadOnly(),selectedSpeaker:w,selectedMicrophone:S,selectedCamera:b,mediaCapabilities:D});f(N,"_dm",U);return N}return h}();t.WebRtcDevicesManager=h})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";"use strict";"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.foreach;var r=e.Utils.batched;var i=e.Utils.deepEqual;var a=e.Utils.isArray;var o=e.Utils.isFunction;var s=e.Utils.isProperty;var u=e.Utils.setHiddenProperty;var c=e.Utils.Model;var d=e.Utils.Symbol;var l=e.Utils.Command;var f=e.Utils.Property;var p=e.Utils.Exception;var v=e.Utils.Collection;var h=e.Utils.ConstProperty;var m=e.Utils.ENotSupported;var g=e.Stack.Resource;var y=d("updated");var S=d("hidden");var b=function(){function e(t){var n=this;this.properties={};this.commands={};this.collections={};this.members={};t({member:function(t,r){n.members[t]=new e(r)},command:function(e){n.commands[e]={}},property:function(e,t){n.properties[e]=t||{}},collection:function(t,r){n.collections[t]=a(r)?r[0]:new e(r)}})}return e}();function w(e,a,d){var E;var T=c();var I={};var M={};var C={};var A={};var _=f({value:false,reason:p("Disconnected")});var R=o(d)?new b(d):d;var P=f({value:null,get:function(){return P()||e.init().then(function(){return s(a)?a.get():a}).then(function(t){return e.get(t)})}});var k=r(function(t){var r=P();var a=r.getSnapshot();var o={};var s=false;for(var u=0,c=t;u<c.length;u++){var d=c[u],l=d[0],f=d[1];var p=M[l];var v=p[S];var h=a[l];var m=v.convert?v.convert(f):f;if(!i(m,h)){s=true;a[l]=m}}if(s){n(a,function(e,t){var n=M[t];var r=n&&n[S];o[t]=r&&r.prepare?r.prepare(r.parse(e)):e});return e.send("PUT",r.href,{data:o})}},Infinity);function O(){var t=E||P.get().then(function(t){return e.send("GET",t.href)});E=t;E.then(null,function(){E=null});return t}n(R.collections,function(e,t){var n=v({subscribed:O,get:function(){return P.get().then(function(e){return O()}).then(function(e){return null})}});n[S]=e;I[t]=n;T[t]=n.asReadOnly()});n(R.properties,function(e,t){var n=o(e)?{parse:e}:e;if(!n.parse)n.parse=function(e){return e};var r=f({subscribed:O,get:function(){return P.get().then(function(e){return e.has(t)?r():O().then(function(){return r()})})}});var i=function(e){return!P()?e:P.get().then(function(n){return k([t,e],0)}).then(function(){return r()})};r[S]=n;M[t]=r;var a=n.readOnly?h(false):n.canInit?f.computed([P,_],function(e,t){return!e||t}):_;T[t]=r.fork(l(i,a))});n(R.commands,function(e,t){var n=f({get:function(){return P.get().then(function(e){return!e.hasLink(t)&&O()}).then(function(e){return e.hasLink(t)})}});C[t]={enabled:n};T[t]=l(function(){throw m()},n.asReadOnly())});n(R.members,function(t,n){var r=f({get:function(){return r()||O().then(function(e){return e.link(n).href})}});A[n]=r;T[n]=w(e,r.asReadOnly(),t)});e.init().then(function(){if(a instanceof g)P(a);else if(s(a))a.changed(function(t){return P(e.get(t))});else if(e.exists(a))P(e.get(a))});P.once(function(e){return!!e},function(){var r=P();u(T,t.sHref,r.href);r.updated(function(){_(r.has("etag"),p("ETagMissing"));n(I,function(t,n){for(var i=0,a=r.links(n);i<a.length;i++){var s=a[i];if(!t(s.href)){var u=t[S];var c=o(u)?u(s.href):w(e,s.href,u);t.add(c,s.href)}}});n(M,function(e,t){var n=e[S].parse;var i=r.has(t)?n(r.get(t)):void 0;e(i,y)});n(C,function(e,t){e.enabled(r.hasLink(t))});n(A,function(e,t){if(r.hasLink(t))e(r.link(t).href)})});r.dirty.when(true,function(){E=null})});return T}t.ObservableResource=w})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){"use strict"})(t=e.Internal||(e.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){"use strict";var t=function(){function t(t){return e.ObservableResource(t,{rel:"policies"},function(e){e.property("audioOnlyOnWifi");e.property("callLogArchiving");e.property("customerExperienceImprovementProgram");e.property("emergencyDialMask");e.property("emergencyDialString");e.property("emoticons");e.property("clientExchangeConnectivity");e.property("exchangeUnifiedMessaging");e.property("htmlMessaging");e.property("logging");e.property("loggingLevel");e.property("messageArchiving");e.property("messagingUrls");e.property("multiViewJoin");e.property("onlineFeedbackUrl");e.property("photos");e.property("saveCallLogs");e.property("saveCredentials");e.property("saveMessagingHistory");e.property("sendFeedbackUrl");e.property("sharingOnlyOnWifi");e.property("softwareQualityMetrics");e.property("telephonyMode");e.property("videoOnlyOnWifi");e.property("voicemailUri");e.property("showNotification");e.property("redirectClient");e.property("updateClient")})}return t}();e.GeneralPolicies=t})(t=e.Internal||(e.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.Model;var r=e.Utils.Command;var i=e.Utils.EnabledCommand;var a=e.Utils.Task;var o=e.Utils.Property;var s=e.Utils.BoolProperty;var u=e.Utils.ConstProperty;var c=e.Utils.Promise;var d=e.Utils.Collection;var l=e.Utils.StringEnum;var f=e.Utils.map;var p=e.Utils.sha256Hash;var v=e.Utils.isVoid;var h=e.Utils.isNotEmptyString;var m=e.Utils.foreach;var g=e.Utils.extend;var y=e.Utils.async;var S=e.Utils.bind;var b=e.Utils.EInvalidArgument;var w=function(){function e(){var e=l("AddressBook","SkypeDirectory","All");var t=o({value:1,check:function(e){if(!(e>0&&(e|0)==e))throw b("limit","`limit` must be a positive integer")}});var r=o({check:function(e){if(!h(e))throw b("text","`text` must be set as a no empty query string before searching.")}});var i=o({value:e.AddressBook,check:function(t){if(!(t in e))throw b("sources","`sources` must be set as AddressBook, SkypeDirectory, or All.")}});return n({text:r,limit:t,sources:i})}return e}();t.SearchQuery=w;var E=function(){function i(i){var a=i.ucwa;var l=i.type;var f=i.remoteOnly;var v=i.contactmgr;var h=i.me;var S=new w;var b=d();var E=d();var T=d();var I=o({value:false});var M=s(true);var C=i.tm;var A={emailSearchUsesCache:i.settings?i.settings.emailSearchUsesCache:false};b.add("id");function _(){var r=a.get({rel:"people"}).link("search");var i=E["id"]||S.text()&&S.text().slice(0,3).toLowerCase()=="id:"&&S.text().slice(3);var o={};var s=[];function d(e){try{return e.properties["uri"].toLowerCase()===h.id().toLowerCase()}catch(e){return false}}function g(e){var t=n({result:e,matches:{},relevance:u(null)});T.add(t);s.push(t)}M(false);if(i&&i.length>=1){if(r.revision>=2){o.headers={"X-MS-RequiresMinResourceVersion":2};o.query={mail:i}}else{o.query={query:i,limit:1}}}else{o.query={query:S.text(),limit:S.limit()};if(C)C.excluded[S.text()]=true}if(S.limit()===1){var y=i&&i.length>=1&&!A.emailSearchUsesCache?null:i||S.text();if(y){var b=v.getTransientContact(y);if(b){C&&C.record(e.TelemetryEvent.Search,{source:"cached_contact"});g(b);I(false);return c.resolve(s)}}}var w=a.send("GET",r.href,o).then(function(e){var n=Object.keys(e.embedded).length;m(e.embedded,function(e){if(l=="person"&&e.rel=="contact"){if(f===false||!d(e)){var r=v.get(e.href,false);if(n===1)v.cacheTransientContact(r);g(r)}}else if(l=="group"&&e.rel=="distributionGroup"){var i=new t.Group({ucwa:a,contactmgr:v,source:e.href,tm:C});g(i)}});I(!!e.get("moreResultsAvailable",false));return s}).catch(function(e){M(true);throw e});C&&C.monitor(w,e.TelemetryEvent.Search,{query:o.query&&p(o.query.mail||o.query.query),type:o.query&&o.query.mail?"mail":"query"});return w}return g(S,{supportedKeywords:b.asReadOnly(),keywords:E,moreResultsAvailable:I.asReadOnly(),getMore:r(y(_),M),results:T.asReadOnly()})}return i}();t.PersonOrGroupSearchQuery=E;var T=function(){function e(e){e.type="person";return new E(e)}return e}();t.PersonSearchQuery=T;var I=function(){function e(e){e.type="group";return new E(e)}return e}();t.GroupSearchQuery=I;var M=function(){function e(e){var t=new w;var r=d();var o=d();var s=n();var c={};var l=[{key:"uri",call:function(e,t){return p(e.uri.get(),t)}},{key:"topic",call:function(e,t){return p(e.topic.get(),t)}},{key:"participant",call:function(e,t){return h(e.participants().concat([e.selfParticipant]),t,function(e,t){return p(t.name.get(),e)})}},{key:"group",call:function(e,t){return a.wait(e.isGroupConversation()!=t).then(function(e){if(e)throw c})}}];function p(e,t){return a.waitAll([e,t]).then(function(e){if(e[0].toLowerCase().indexOf(e[1].toLowerCase())<0)throw c})}function h(e,t,n){return a.waitAll([e,t]).then(function(e){if(e[0].length==0)throw c;return a.waitAny(f(e[0],S(n,e[1])))})}function b(e){var n=a.waitAny(f(l,function(n){return n.call(e,t.text())}));var r=a.waitAll(f(l,function(t){if(!v(s[t.key])){return t.call(e,s[t.key])}}));return a.waitAll([n,r])}function E(){var t=[];var n=e();var i=f(n,function(e){return b(e).then(function(){var n={result:e,matches:{},relevance:u(null)};r.add(n);t.push(n)},function(e){if(e!=c)throw e})});return a.waitAll(i).then(function(){return t})}m(l,function(e){o.add(e.key)});return g(t,{supportedKeywords:o.asReadOnly(),keywords:s,limit:u(null),moreResultsAvailable:u(false),getMore:i(y(E)),results:r.asReadOnly()})}return e}();t.ConversationSearchQuery=M})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.assert;var r=e.Utils.Command;var i=e.Utils.BoolProperty;var a=e.Utils.extend;var o=e.Utils.setHiddenProperty;var s=e.Utils.isNotEmptyString;var u=e.Utils.isObject;var c=e.Utils.isPromise;var d=e.Utils.foreach;var l=e.Utils.Property;var f=e.Utils.NumProperty;var p=e.Utils.ConstProperty;var v=e.Utils.ComputedProperty;var h=e.Utils.Collection;var m=e.Utils.EInvalidArgument;var g=e.Utils.EDoesNotExist;var y=e.Utils.ENotSupported;var S=e.Utils.Task;var b=e.Utils.filter;var w=e.Utils.Model;var E=function(){function E(T){var I=T.ucwa;var M=T.source;var C=T.contactmgr;var A=T.subscribe;var _=T.unsubscribe;var R=M&&!c(M)&&I.get(M);var P=w();var k={};var O=T.groupMemberships;var x=T.tm;var D=f();var U=i(false);var N=i(false);var L=v([D,U,N],function(e){return e>=2||!e&&!U()&&N()});var V=h({get:re,subscribed:G,unsubscribed:H});var W=h({get:re,subscribed:G,unsubscribed:H});var B={group:"Custom",defaultGroup:"Others",pinnedGroup:"Favorites",distributionGroup:"Distribution",myPrivacyRelationship:"PrivacyRelationship"};var j;var F;function G(){if(A)A();re()}function H(){if(_)_()}function q(e){d(e.related.contact||[],function(e){if(!V(e.href))V.add(C.get(e.href),e.href)})}function z(e){d(e.links("distributionGroup"),function(e){if(!W(e.href)){var t=new E({source:e.href,ucwa:I,contactmgr:C,subscribe:A,unsubscribe:_,tm:x});W.add(t,e.href)}})}function Y(e){if(!e||!(u(e)||s(e)))throw m("contact","the given value is not a Person model or valid URI");return S.wait(null).then(function(){return e.id?e.id.get():e})}function X(t){var n=Y(t).then(function(e){return S.wait(null).then(function(){return P.id.get()}).then(function(){return R.get("id")}).then(function(t){return Z().then(function(){return I.send("POST",{rel:"myGroupMemberships"},{headers:{"X-MS-RequiresMinResourceVersion":2},query:R.rel=="defaultGroup"?{contactUri:e}:{groupId:t,contactUri:e}})})},function(e){throw y(e)})});x&&x.monitor(n,e.TelemetryEvent.ContactAdd);return n}function J(e){return b(O.links("myGroupMembership"),function(t){var n=I.get(t.href);return n.hasLink(R.rel)&&n.link(R.rel).href==R.href&&n.link("contact").href==e})}function K(e){if(!e||!e.id)throw m("contact","the given value is not a Person model");return I.send("GET",O.href).then(function(){var n=J(e[t.sHref]);if(n.length!=1){if(R.rel=="distributionGroup"||R.rel=="myPrivacyRelationship"){throw y(g(e))}else{throw g(e)}}return n[0].href})}function Q(t){var n=K(t).then(function(e){return Z().then(function(){return I.send("DELETE",e,{headers:{"X-MS-RequiresMinResourceVersion":2}})})});x&&x.monitor(n,e.TelemetryEvent.ContactRemove);return n}function $(t){x&&x.record(e.TelemetryEvent.GroupRename);if(!s(t))throw m("name","The new name must be a non empty string.");return!R?t:ne().then(function(){return Z()}).then(function(){return I.send("PUT",R.href,{headers:{"X-MS-RequiresMinResourceVersion":2},data:a(R.getSnapshot(),{name:t})}).then(function(){return R.get("name")})})}function Z(){return I.getRevisionOf(O).then(function(){U(true);if(!L())throw y()})}function ee(){if(R.hasLink("groupContacts"))return I.send("GET",R.link("groupContacts").href);if(R.hasLink("expandDistributionGroup"))return I.send("GET",R.link("expandDistributionGroup").href);return(new S).reject(new Error("Missing the group expansion link.")).promise}function te(e,t){n(!P[e]);var r=l({subscribed:ne,get:function(){return ne().then(function(){return r()})},set:t});k[e]=r;P[e]=t?r:r.asReadOnly()}function ne(){return S.wait(M).then(function(e){j=j||I.send("GET",e);return j})}function re(){F=F||ne().then(function(){q(R);z(R);if(R.rel!="myPrivacyRelationship"&&R.rel!="myContacts"){return ee().then(function(e){q(e);z(e)})}});return F}function ie(e){var t=e["in"]||{};var n=e.target||{};if(t.href==R.href){if(e.type=="deleted"){V.remove(n.href)}if(e.type=="added"){if(!V(n.href))V.add(C.get(n.href),n.href)}}}te("name",$);te("uri");te("relationshipLevel");te("id");S.wait(M,"sync").then(function(e){N(true);R=R||I.get(e);if(R.rel!="myPrivacyRelationship")k.relationshipLevel("None");R.updated(function(){d(k,function(e,t){if(t in R.properties)e(R.properties[t],l.sUpdated)})});O=O||I.get({rel:"myGroupMemberships"});O.updated(function(){var e=O.link("self").revision;D(+e)});I.event(ie);R.deleted(function(){I.event.off(ie)});try{q(R)}catch(e){t.log("Failed to import persons for "+R.href+": "+e)}try{z(R)}catch(e){t.log("Failed to import groups for "+R.href+": "+e)}try{q(I.get(R.link("groupContacts").href))}catch(e){}o(P,t.sHref,R.href)});return a(P,{avatarUrl:p(null),type:p(B[R&&R.rel||"group"]),groups:W.asReadOnly(),persons:V.asWritable({add:r(X,L),remove:r(Q,L)})})}return E}();t.Group=E})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.Command;var r=e.Utils.EnabledCommand;var i=e.Utils.DisabledCommand;var a=e.Utils.BoolProperty;var o=e.Utils.indexOf;var s=e.Utils.foreach;var u=e.Utils.NumProperty;var c=e.Utils.ConstProperty;var d=e.Utils.ComputedProperty;var l=e.Utils.Collection;var f=e.Utils.EInvalidArgument;var p=e.Utils.isNotEmptyString;var v=e.Utils.ENotSupported;var h=e.Utils.Exception;var m=e.Utils.Task;var g=e.Utils.findIndex;var y=e.Utils.Model;var S=e.Utils.debounced;var b=function(){function b(b){var w=b.ucwa,E=b.contactmgr,T=b.tm,I=b.autoPopulate;var M=["group","pinnedGroup","distributionGroup","defaultGroup"];var C=l({get:H,subscribed:function(){return G(H)},unsubscribed:Z});var A=l({get:q,subscribed:function(){return G(q)},unsubscribed:Z});var _=u();var R=a(false);var P=a(false);var k=d([_,R,P],function(e){return e>=2||!e&&!R()&&P()});var O=[];var x=[];var D;var U;var N;var L;var V;var W;var B=30;var j=0;function F(e){return new t.Group({source:e,ucwa:w,contactmgr:E,subscribe:$,unsubscribe:Z,groupMemberships:U,tm:T})}function G(e){$().then(function(){if(D.get("state")=="Connected")e()})}function H(){var t=w.init().then(function(){return w.send("GET",{rel:"myContacts"}).then(z)});T&&T.monitor(t,e.TelemetryEvent.ContactsLoad,function(){return{nContacts:C.size()}});t.then(function(){I(C.size(),function(e){C.add(E.get(e,true,{isOrgContact:true}),e)})});return t}function q(){return w.init().then(function(){
return m.waitAll([w.send("GET",{rel:"myGroups"}).then(Y),w.send("GET",{rel:"myPrivacyRelationships"}).then(X)]).then(function(){T&&T.record(e.TelemetryEvent.GroupsLoad,{nGroups:A.size()});return})})}function z(e){s(e.related.contact||[],function(e){if(!C(e.href))C.add(E.get(e.href),e.href)})}function Y(e){s(M,function(t){s(e.links(t),function(e){if(!A(e.href))A.add(F(e.href),e.href)})})}function X(e){s(e.links("myPrivacyRelationship"),function(e){if(!A(e.href))A.add(F(e.href),e.href)})}function J(){throw v()}function K(t){var n=m.wait(typeof t==="string"?t:t.id.get()).then(function(e){return w.send("GET",U.href).then(function(){return se()}).then(function(){return w.send("POST",U.link("removeContactFromAllGroups").href,{query:{contactUri:e},headers:{"X-MS-RequiresMinResourceVersion":2}})})});T&&T.monitor(n,e.TelemetryEvent.ContactRemove);return n}function Q(e){return w.exists({rel:e})?m.wait({href:w.get({rel:e}).href}):w.send("GET",D.href).then(function(t){return t.link(e)})}function $(){j++;if(j>1)return m.run(function(){throw h("AlreadySubscribed")});return w.init().then(function(){return Q("startOrRefreshSubscriptionToContactsAndGroups")}).then(function(t){var n=S(function(){return w.send("POST",t.href,{query:{duration:B}})});n();W=e.setInterval(function(){n().then(null,Z)},B*60*1e3)})}function Z(){if(j==0)return;j--;if(j>0)return;w.init().then(function(){e.clearInterval(W);Q("stopSubscriptionToContactsAndGroups").then(function(e){return w.send("POST",e.href)})})}function ee(){T&&T.record(e.TelemetryEvent.GroupCreate);var t=new m,n=F(t.promise);O.push(t);x.push(n);return n}function te(t){var n=t.name();if(!p(n))throw f("name","The group name must be a non empty string.");return se().then(function(){var r=w.send("POST",{rel:"myGroups"},{data:{displayName:n},headers:{"X-MS-RequiresMinResourceVersion":2}});T&&T.monitor(r,e.TelemetryEvent.GroupAdd,{type:t.type()});return r})}function ne(n){var r=w.get(n[t.sHref]).link("addToContactList");var i=w.send("POST",r.href);T&&T.monitor(i,e.TelemetryEvent.GroupAdd,{type:n.type()});return i}function re(e){return e.type()=="Distribution"?ne(e):te(e)}function ie(n){return se().then(function(){var r=w.send("DELETE",n[t.sHref],{headers:{"X-MS-RequiresMinResourceVersion":2}});T&&T.monitor(r,e.TelemetryEvent.GroupRemove,{type:n.type()});return r})}function ae(n){var r=w.get(n[t.sHref]).link("removeFromContactList");var i=w.send("POST",r.href);T&&T.monitor(i,e.TelemetryEvent.GroupRemove,{type:n.type()});return i}function oe(e){var n=w.get(e[t.sHref]).rel;if(n=="group")return ie(e);else if(n=="distributionGroup")return ae(e);else throw v({groupType:n})}function se(){return w.getRevisionOf(U).then(function(){R(true);U.set("qqq",true);if(!k())throw v()})}function ue(e){if(A(e))return;if(x.length>0){m.wait(null).then(function(){if(!w.get(e).has("name"))return w.send("GET",e)}).then(function(){var t=g(x,function(t){return t.name()==w.get(e).get("name")});if(t>=0){O[t].promise.then(function(e){var t=g(x,function(t){return t.name()==w.get(e).get("name")});x[t]&&A.add(x[t],e);x.splice(t,1);O.splice(t,1)});O[t].resolve(e)}else{A.add(F(e),e)}})}else{A.add(F(e),e)}}w.init().then(function(){P(true);U=w.get({rel:"myGroupMemberships"},null);D=w.get({rel:"myContactsAndGroupsSubscription"},null);N=w.get({rel:"myContacts"},null);L=w.get({rel:"myGroups"},null);V=w.get({rel:"myPrivacyRelationships"},null);if(N)z(N);if(L)Y(L);if(V)X(V);if(U){U.updated(function(){var e=U.link("self").revision;_(+e)})}});w.event(function(e){var t=e["in"]||{},n=e.target,r=n.href;if(o(M,n.rel)>=0){if(t.rel=="myGroups"){if(e.type=="deleted"){A.remove(r)}else if(e.type=="added"){ue(r)}}else if(n.rel=="group"&&e.type=="updated"&&A(r)){w.send("GET",r)}}if(t.rel=="myContacts"){if(e.type=="added"&&!C(r)){C.add(E.get(r),r)}else if(e.type=="deleted"){C.remove(r)}}});return y({id:c(null),name:c(null),uri:c(null),avatarUrl:c(null),type:c("Root"),relationshipLevel:c("None"),createGroup:r(ee),persons:C.asWritable({add:i(J),remove:n(K,k)}),groups:A.asWritable({add:n(re,k),remove:n(oe,k)})})}return b}();t.RootGroup=b;(function(e){})(b=t.RootGroup||(t.RootGroup={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.sdist;var r=e.Utils.Model;var i=e.Utils.Exception;var a=e.Utils.EnabledCommand;var o=e.Utils.EnabledAsyncCommand;var s=function(){function s(s){var u=s.ucwa,c=s.psm,d=s.contactmgr,l=s.me,f=s.remoteSearchResultsOnly,p=s.tm,v=s.settings;var h=new t.RootGroup({ucwa:u,contactmgr:d,tm:p,autoPopulate:S});function m(){return new t.PersonSearchQuery({ucwa:u,psm:c,contactmgr:d,remoteOnly:f,me:l,settings:v?v.searchSettings:{},tm:p})}function g(){return new t.GroupSearchQuery({ucwa:u,psm:c,contactmgr:d,tm:p})}function y(e){if(!e)throw i("NoSipUri");e=e.toLowerCase();var t=function(t){return(t||"").toLowerCase()==e};for(var r=0,a=d.get();r<a.length;r++){var o=a[r];if(t(o.id()))return o}var s=m();s.text(e);s.limit(1);return s.getMore().then(function(){var r=s.results(0);if(!r)throw i("NotFound",{sipuri:e});var a=s.results(0).result;if(t(a.id()))return a;throw i("NotMatched",{sipuri:e,sdist:n(e,a.id()||"")})})}function S(n,r){u.init().then(function(){if(!v||!v.getContactsFromGraph||n>v.getContactsFromGraphLowerLimit)return;u.graph.getTopNContacts(10).then(function(i){for(var a=0,o=i;a<o.length;a++){var s=o[a];if(!s.personType||!s.personType.class||s.personType.class!="Person")continue;var u=m();u.text(s.scoredEmailAddresses[0].address);u.getMore().then(function(e){if(!e[0])return;var n=e[0].result;r(n[t.sHref]);n.displayName.get()})}p&&p.record(e.TelemetryEvent.ContactsAutoPopulate,{numberOfExistingContacts:n,autoPopulateContactLowerLimit:v.getContactsFromGraphLowerLimit,numberOfContactsToPopulate:i&&i.length})}).catch(function(t){p&&p.record(e.TelemetryEvent.ContactsAutoPopulate,{result:"failed",reason:t})})})}return r({mePerson:l,all:h,createPersonSearchQuery:a(m),createGroupSearchQuery:a(g),lookupPersonById:o(y),createGroup:h.createGroup})}return s}();t.PersonsAndGroupsManager=s})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.values;var r=e.Utils.max;var i=function(){function i(e){this.contacts={};this.contactExpiryTimers={};this.settings={};this.count=0;this.ucwa=e.ucwa;this.psm=e.psm;this.tm=e.tm;e.settings=e.settings||{};this.settings.maxCacheCount=e.settings.maxCacheCount||1e3;this.settings.useCacheForTransientContacts=e.settings.useCacheForTransientContacts!==void 0?e.settings.useCacheForTransientContacts:false;this.settings.contactExpiryThreshold=e.settings.contactExpiryThreshold||60*60*1e3;this.settings.linkedPropFetchInterval=e.settings.linkedPropFetchInterval;this.settings.enableGetSubscribedProps=e.settings.enableGetSubscribedProps}i.prototype.getTimeRemainingToExpiry=function(t){return r(+t.expires()-e.Date.now()-this.settings.contactExpiryThreshold,0)};i.prototype.addToCache=function(t,n){var r=this;if(this.count<this.settings.maxCacheCount){this.contacts[t]=n;this.count++;var i=function(){if(!r.contacts[t])return;var n=r.getTimeRemainingToExpiry(r.contacts[t]);if(n>0)r.contactExpiryTimers[t]=e.setTimeout(i,n);else r.deleteFromCache(t)};n.expires.once(function(e){return!!e},function(){r.contactExpiryTimers[t]=e.setTimeout(i,r.getTimeRemainingToExpiry(n))})}else{this.tm&&this.tm.record(e.TelemetryEvent.ContactManager,{result:"cache_full",count:this.count})}};i.prototype.deleteFromCache=function(t){if(!this.contacts[t])return;delete this.contacts[t];e.clearTimeout(this.contactExpiryTimers[t]);delete this.contactExpiryTimers[t];this.count--;this.tm&&this.tm.record(e.TelemetryEvent.ContactManager,{action:"cached_contact_delete",count:this.count})};i.prototype.get=function(e,r,i){var a=this;if(!e)return n(this.contacts);var o=function(){return new t.Person({href:e,name:r&&r.name,sipuri:r&&r.sipuri,photo:r&&r.photo,ucwa:a.ucwa,psm:a.psm,linkedPropFetchInterval:a.settings.linkedPropFetchInterval,enableGetSubscribedProps:a.settings.enableGetSubscribedProps,isOrgContact:i&&i.isOrgContact})};if(typeof e==="string"){if(this.contacts[e])return this.contacts[e];var s=o();if(r!==false)this.addToCache(e,s);return s}else{return o()}};i.prototype.getTransientContact=function(e){if(!e)return;e=e.toLowerCase();if(!this.settings.useCacheForTransientContacts)return;for(var t in this.contacts){if((this.contacts[t].id()||"").toLowerCase()===e)return this.contacts[t]}};i.prototype.cacheTransientContact=function(e){var n=e[t.sHref];if(this.settings.useCacheForTransientContacts&&n&&!this.contacts[n])this.addToCache(n,e)};return i}();t.ContactManager=i})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.sleep;var r=e.Utils.repeat;var i=e.Utils.Http;var a=e.Utils.Task;var o=e.Utils.NumProperty;var s=function(){function t(e,t,n,r){if(n===void 0){n=25}this.ucwa=e;this.uris=t;this.duration=n;this.tm=r;this._size=o();this.active={};this.size=this._size.asReadOnly();this._size(t.length);for(var i=0,a=t;i<a.length;i++){var s=a[i];this.active[s]=true}this.init()}t.prototype.init=function(){var t=this;this.dfd=a.wait(null,"sync").then(function(){var n=t.ucwa.get({rel:"presenceSubscriptions"});var r=t.ucwa.send("POST",n.href,{data:{duration:t.duration,uris:t.uris}});t.tm&&t.tm.monitor(r,e.TelemetryEvent.PresenceSubscribe,{nUris:t._size()});return r}).then(function(e){t.rSubscription=e;t.rep=r(function(){return n((t.duration-1)*60).then(function(){return t.extendDuration()})}).catch(function(e){if(e&&e.code=="RequestFailed"&&e.rsp.status==404)t.init();throw e});t.rSubscription.dirty.when(true,function(){return t.extendDuration()});t.rSubscription.deleted(function(){t.stop();t._size(0);t.active={}})}).finally(function(){t.dfd=null})};t.prototype.extendDuration=function(){return this.ucwa.send("POST",this.rSubscription.href,{query:{duration:this.duration}})};t.prototype.stop=function(){if(this.rep){this.rep.cancel();this.rep=null}};t.prototype.add=function(e){if(this.active[e]){}else{this.active[e]=true;this._size.inc()}};t.prototype.remove=function(e){if(this.active[e]){this.active[e]=false;this._size.dec();if(this._size()==0){if(this.rSubscription){this.stop();this.ucwa.send("DELETE",this.rSubscription.href)}else if(this.dfd)try{this.dfd.cancel()}catch(e){}}}};return t}();t.PresenceSubscription=s})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.batched;var r=e.Utils.Subscription;var i=function(){function e(e,r){var i=this;this.subs={};this.refs={};this.dfds={};var a=r&&r.maxBatchSize,o=r&&r.duration,s=r&&r.tm;this._subscribe=n(function(n){var r=new t.PresenceSubscription(e,n,o,s);r.size.when(0,function(){for(var e=0,t=n;e<t.length;e++){var r=t[e];i.remove(r)}});return r},a||75)}e.prototype.unsubscribe=function(e){var n=this.refs;var r=this.subs;var i=this.dfds;n[e]--;if(n[e]==0){if(r[e]){r[e].remove(e)}else{try{i[e].cancel()}catch(n){t.log("unsubscribe("+e+") failed",n&&n.stack||n)}this.remove(e)}}};e.prototype.remove=function(e){delete this.dfds[e];delete this.refs[e];delete this.subs[e]};e.prototype.subscribe=function(e){var t=this;var n=this.refs;var i=this.subs;var a=this.dfds;var o=false;if(a[e]){n[e]++}else if(i[e]){n[e]++;i[e].add(e)}else{n[e]=1;a[e]=this._subscribe(e).then(function(t){i[e]=t;a[e]=null})}return new r(function(){if(!o){o=true;t.unsubscribe(e)}})};return e}();t.PresenceSubscriptionManager=i})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.async;var i=e.Utils.check;var a=e.Utils.assert;var o=e.Utils.indexOf;var s=e.Utils.Task;var u=e.Utils.Event;var c=e.Utils.Model;var d=e.Utils.Property;var l=e.Utils.StringEnum;var f=e.Utils.BoolProperty;var p=function(){function e(l){var p=l.ucwa,v=l.rInvitation,h=l.rMeeting,m=l.from,g=l.threadId,y=l.subject,S=l.priority,b=l.conversation,w=l.contactManager;var E=d();var T=d();var I=d();var M=d();var C=d();var A=new u;var _=new s;var R=d({get:function(){return _.promise}});R.changed(function(e){return _.resolve(e)});var P={start:r(N),accept:r(L),decline:r(V),acknowledge:r(W)};var k=d({get:function(){return h.link("phoneDialInInformation").href}});var O=c({from:m,changed:A.observer,dialin:t.PhoneDialInInformation&&new t.PhoneDialInInformation(p,k),state:E.asReadOnly(),subject:T.asReadOnly(),uri:I.asReadOnly(),priority:C.asReadOnly(),joinUrl:M.asReadOnly(),availableModalities:c({messaging:x("Messaging"),audio:x("Audio"),video:x("Video"),appSharing:x("ApplicationSharing")})});if(v){a(m);E(e.State.Notified);O.accept=P.accept;O.decline=P.decline;O.acknowledge=P.acknowledge;v.updated(D)}else if(h){E(e.State.Connected);h.updated(D)}else{a(g);E(e.State.Created);T(y);C(S);O.start=P.start}O.creator=w.get(R);p.event(function(e){var n=e.target;var r=e.resource;var i=e["in"];if(e.type=="added"&&n.rel=="onlineMeeting"&&i&&b[t.sHref]==i.href&&!h){h=r;h.updated(D)}});p.event(function(n){var r=n.target;var i=n.resource;if(n.type=="completed"&&r.rel=="onlineMeetingInvitation"&&i.link("conversation").href==b[t.sHref]&&i.get("state")=="Connected"){E(e.State.Connected)}});function x(e){var t=f(false);if(v){v.updated(function(){var n=v.get("availableModalities",[]);var r=o(n,e)>=0;t(r)})}return t.asReadOnly()}function D(){var t=h||v;T(t.get("subject",""));I(t.get("onlineMeetingUri",""));M(t.get("joinUrl",""));C(t.get("importance",""));if(t.hasLink("organizer"))R(t.link("organizer").href);var n=t.has("state")&&t.get("state");if(n=="Connected")E(e.State.Connected);else if(n=="Failed")E(e.State.Disconnected)}function U(e,t){if(!t)return;var n=p.exists({rel:"application"})&&p.get({rel:"application"});if(n&&n.hasLink("sendClientErrorReport")){return p.send("POST",{rel:"sendClientErrorReport"},{data:{description:t.reason?t.reason.message:"Failed to join conference",conferenceUri:e,clientErrorCode:t.reason?t.reason.code:"FAILURE",rel:t.target.rel},nobatch:true})}}function N(r){var i=r&&r.uri;var o=r&&r.name;return s.run(function(){var r=n(),u,c,d,l;E(e.State.Connecting);delete O.start;A.fire();if(i){u=p.send("POST",{rel:"joinOnlineMeeting"},{data:{operationId:r,threadId:g,anonymousDisplayName:o,onlineMeetingUri:i}})}else{u=p.send("POST",{rel:"startOnlineMeeting"},{data:{operationId:r,threadId:g,subject:y||"",importance:S||"Normal"}})}c=p.wait({type:"started",target:{rel:"onlineMeetingInvitation"},resource:{operationId:r}}).then(function(e){a(!v);v=e.resource;v.updated(D)});d=p.wait({type:"completed",target:{rel:"onlineMeetingInvitation"},resource:{operationId:r}}).then(function(e){if(e.status!="Success"){U(i,e);throw t.EInvitationFailed(e.reason)}});l=p.wait({type:"added",target:{rel:"onlineMeeting"},resource:function(e){return v&&e.link("conversation").href==v.link("conversation").href}}).then(function(e){v.updated.off(D);if(!h){h=e.resource;h.updated(D)}});return s.waitAll([u,c,d,l])}).then(function(){E(e.State.Connected)}).catch(function(t){O.start=P.start;E(e.State.Created,t);A.fire();throw t})}function L(){i.state(E(),e.State.Notified);E(e.State.Connecting);return s.run(function(){var e;var n;var r;r=p.send("POST",v.link("accept").href);e=p.wait({type:"added",target:{rel:"onlineMeeting"},resource:function(e){return e.link("conversation").href==v.link("conversation").href}}).then(function(e){v.updated.off(D);if(!h){h=e.resource;h.updated(D)}});n=p.wait({type:"completed",target:{rel:"onlineMeetingInvitation",href:v.href}}).then(function(e){if(e.status!="Success"){var n=e.resource.has("onlineMeetingUri")&&e.resource.get("onlineMeetingUri");U(n,e);throw t.EInvitationFailed(e.reason)}});return s.waitAll([r,e,n])}).then(function(){delete O.accept;delete O.decline;E(e.State.Connected);A.fire()}).catch(function(t){E(e.State.Disconnected,t);throw t})}function V(t){if(t===void 0){t="Global"}i.state(E(),e.State.Notified);return p.send("POST",v.link("decline").href,{data:{reason:t}}).then(function(){return E(e.State.Disconnected)})}function W(){return p.send("POST",v.link("acknowledge").href).then(function(){E(e.State.Disconnected)})}return O}return e}();t.OnlineMeeting=p;(function(e){e.State=l("Created","Notified","Connecting","Connected","Disconnected");e.AccessLevel=l("Everyone","Invited","Locked","SameEnterprise");e.AutomaticLeaderAssignment=l("Disabled","Everyone","SameEnterprise");e.EntryExitAnnouncement=l("Disabled","Enabled");e.LobbyBypassForPhoneUsers=l("Disabled","Enabled");e.PhoneUserAdmission=l("Disabled","Enabled")})(p=t.OnlineMeeting||(t.OnlineMeeting={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.dateToTimeStamp;var r=e.Utils.timeStampToDate;var i=e.Utils.Property;var a=function(){function a(a,o){var s=o===void 0?{}:o,u=s.href,c=s.tm;var d=i({value:u,get:function(){var t=a.send("POST",{rel:"myOnlineMeetings"},{data:l.toJSON()}).then(function(t){c&&c.record(e.TelemetryEvent.ScheduleMeeting,{onlineMeetingId:t.get("onlineMeetingId",void 0)});return t.href},function(e){throw e});c&&c.monitor(t,e.TelemetryEvent.ScheduleMeeting,{},{timeout:5e3});return t}});var l=t.ObservableResource(a,d,function(e){e.property("accessLevel",{canInit:true});e.property("attendees",{canInit:true});e.property("automaticLeaderAssignment",{canInit:true});e.property("description",{canInit:true});e.property("entryExitAnnouncement",{canInit:true});e.property("expirationTime",{canInit:true,parse:r,convert:n,prepare:function(e){return e&&e.toJSON()}});e.property("joinUrl",{readOnly:true});e.property("leaders",{canInit:true});e.property("lobbyBypassForPhoneUsers",{canInit:true});e.property("onlineMeetingId",{readOnly:true});e.property("onlineMeetingUri",{readOnly:true});e.property("organizerUri",{readOnly:true});e.property("phoneUserAdmission",{canInit:true});e.property("subject",{canInit:true})});return l}return a}();t.MyOnlineMeeting=a})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.isString;var r=e.Utils.setHiddenProperty;var i=e.Utils.sanitizeHtml;var a=e.Utils.convertHtmlToText;var s=e.Utils.convertTextToHtml;var u=e.Utils.disableHtmlInText;var c=e.Utils.Property;var d=e.Utils.BaseModel;var l=e.Utils.Collection;var f=e.Utils.ConstProperty;function p(e){var t=/^\s*<div>([\s\S]*)<\/div>\s*$/i;return t.test(e)?p(e.replace(t,"$1")):e.trim()}var v=function(d){o(v,d);function v(o){var h=o.ucwa,m=o.href,g=m===void 0?"":m,y=o.sender,S=o.status,b=S===void 0?v.Status.Succeeded:S,w=o.time,E=w===void 0?new e.Date:w,T=o.participants,I=o.ndrs,M=o.text,C=o.html,A=o.direction;var _=d.call(this)||this;_.isEdited=f(false);_.isDeleted=f(false);M=(M||"").trim();C=(C||"").trim();if(C&&!M){try{M=a(C)}catch(e){M=""}}if(M&&!C){try{C=s(M)}catch(e){C=""}}var R=!g||n(g)?f(g):g;var P=n(b)?c({value:b}):b;R.changed(function(e){return r(_,t.sHref,e)});var k=l();function O(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];for(var a=0,o=T();a<o.length;a++){var s=o[a];if(s[t.sHref]==i.href&&!k(i.href))k.add(s,i.href)}}}if(I&&T)O(I);if(P()!=v.Status.Succeeded){h.wait({type:"completed",target:{rel:"message"},resource:function(e){return e.href==R()}}).then(function(e){P(e.status=="Success"?v.Status.Succeeded:v.Status.Failed,e.reason);if(T)O(e.resource.links("failedDeliveryParticipant"))})}_.sender=y;_.text=f(M&&u(M).trim());_.html=f(C&&p(i(C)));_.timestamp=f(E);_.direction=f(A||(R()||R()==""?v.Direction.Incoming:v.Direction.Outgoing));_.status=P.asReadOnly();_.failedDeliveryParticipants=k.asReadOnly();return _}return v}(d);t.Message=v;(function(e){var t;(function(e){e.Pending="Pending";e.Succeeded="Succeeded";e.Failed="Failed"})(t=e.Status||(e.Status={}));var n;(function(e){e.Incoming="Incoming";e.Outgoing="Outgoing"})(n=e.Direction||(e.Direction={}))})(v=t.Message||(t.Message={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.random;var r=e.Utils.inherit;var i=e.Utils.Property;var a=e.Utils.BoolProperty;var o=e.Utils.ConstProperty;var s=e.Utils.Model;var u=function(){function t(t,u,c){var d=i();if(c.status)c.status.changed(function(e,t){return d(t)});return r(s(c),{type:o(t),key:o(u||n()),timestamp:o(new e.Date),status:o("Succeeded"),reason:d.asReadOnly(),isRead:a(false)},"append")}return t}();t.ActivityItem=u})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.map;var r=e.Utils.keys;var i=e.Utils.take;var a=e.Utils.async;var o=e.Utils.assert;var s=e.Utils.extend;var u=e.Utils.foreach;var c=e.Utils.inherit;var d=e.Utils.indexOf;var l=e.Utils.isArray;var f=e.Utils.isModel;var p=e.Utils.isProperty;var v=e.Utils.isCollection;var h=e.Utils.isEmptyObject;var m=e.Utils.timeStampToDate;var g=e.Utils.isNotEmptyString;var y=e.Utils.setHiddenProperty;var S=e.Utils.disableHtmlInText;var b=e.Utils.URI;var w=e.Utils.Model;var E=e.Utils.Property;var T=e.Utils.Collection;var I=e.Utils.StringEnum;var M=e.Utils.Subscription;var C=e.Utils.ConstProperty;var A="Phone";var _=function(){function a(f){var p=f.href,v=f.ucwa,b=f.name,M=f.sipuri,_=f.photo,R=f.psm||new t.PresenceSubscriptionManager(v),P,k={},O=f.linkedPropFetchInterval!=void 0?f.linkedPropFetchInterval*60*1e3:0,x=f.enableGetSubscribedProps!=void 0?f.enableGetSubscribedProps:true,D=I("direct","linked","photo"),U=0,N,L=!!f.isOrgContact,V=(typeof p==="string"?C(p):p).map(function(e){return v.get(e)}),W=w(),B=c(W);f=null;var j={};H();function F(t){var n=j[t];return V.get().then(function(e){var t=n.type==D.direct?e.has(n.internalName):e.hasLink(n.internalName);if(!t)return Y()}).then(function(){switch(n.type){case D.linked:return X(n.link).then(function(t){n.lastFetched=e.Date.now();n.dirty=false;ee(n,t)});case D.photo:return J()}}).then(function(){return n.property()})}function G(t,n){o(g(t));o(!n||D[n.type]);var r=(n&&n.isCollection?T:E)({value:n&&n.value,get:function(){var n=j[t].lastFetched;if(j[t].observed){if(x||n==void 0)return F(t);else return r()}else if(n!=void 0&&n>e.Date.now()-O)return r();else return F(t)},subscribed:function(){q(j[t])},unsubscribed:function(){z(j[t])}});j[t]={internalName:n&&n.internal||t,modelName:t,type:n&&n.type||D.direct,field:n&&n.field,element:n&&n.element,observed:false,dirty:false,link:n&&n.link||null,transform:n&&n.transform,lastFetched:null,property:r};return j[t].property.asReadOnly()}function H(){B.id=G("id",{internal:"uri",type:D.direct,value:M});B.sourceNetwork=G("sourceNetwork");B.company=G("company");B.department=G("department");B.office=G("office");B.title=G("title");B.expires=G("expires",{transform:m,type:D.direct});B.emails=G("emails",{internal:"emailAddresses",type:D.direct,isCollection:true,transform:function(e){return n(e||[],function(e){return w({type:C(null),emailAddress:C(e)})})}});B.phoneNumbers=G("phoneNumbers",{internal:["workPhoneNumber","homePhoneNumber","mobilePhoneNumber","otherPhoneNumber"],type:D.direct,isCollection:true,transform:function(e){var t={workPhoneNumber:"Work",homePhoneNumber:"Home",mobilePhoneNumber:"Cell",otherPhoneNumber:"Other"};return(e||[]).filter(function(e){var n=null,i=null,a=r(e);if(a.length==1){if(a[0]in t){n=t[a[0]];i=e[a[0]]}}return n&&i}).map(function(e){var n=r(e)[0],i=e[n],o=a.extractPhoneNumber(i);return w({type:C(t[n]),telUri:C(i),displayString:C(o)})})}}).sort(function(e,t){return e.type()<t.type()});B.workPhone=G("workPhone",{internal:"workPhoneNumber",type:D.direct});B.homePhone=G("homePhone",{internal:"homePhoneNumber",type:D.direct});B.mobilePhone=G("mobilePhone",{internal:"mobilePhoneNumber",type:D.direct});B.otherPhone=G("otherPhone",{internal:"otherPhoneNumber",type:D.direct});B.type=G("type",{type:D.direct,value:/;user=phone$/.test(M)?"Phone":undefined});B.displayName=G("displayName",{internal:"name",type:D.direct,value:b,transform:S});B.avatarUrl=G("avatarUrl",{internal:"contactPhoto",type:D.photo,link:_});B.status=G("status",{internal:"contactPresence",type:D.linked,field:"availability",transform:a.fixStatus});B.endpointType=G("endpointType",{internal:"contactPresence",type:D.linked,field:"deviceType",transform:a.fixDeviceType});B.lastSeenAt=G("lastSeenAt",{internal:"contactPresence",type:D.linked,field:"lastActive",transform:m});B.activity=G("activity",{internal:"contactPresence",type:D.linked,field:"activity",transform:S});B.relationship=G("relationship",{internal:"contactPrivacyRelationship",type:D.linked,field:"relationshipLevel"});B.location=G("location",{internal:"contactLocation",type:D.linked,field:"location",transform:S});s(B.location,{type:C(null),street:C(null),city:C(null),state:C(null),country:C(null),postalCode:C(null)});B.note=w({type:G("note.type",{internal:"contactNote",type:D.linked,field:"type"}),text:G("note.text",{internal:"contactNote",type:D.linked,field:"message",transform:S})});B.capabilities=w({chat:G("capabilities.chat",{internal:"contactSupportedModalities",type:D.linked,field:"modalities",element:"Messaging"}),audio:G("capabilities.audio",{internal:"contactSupportedModalities",type:D.linked,field:"modalities",element:"Audio"}),video:G("capabilities.video",{internal:"contactSupportedModalities",type:D.linked,field:"modalities",element:"Video"}),screenSharing:G("capabilities.screenSharing",{internal:"contactSupportedModalities",type:D.linked,field:"modalities",element:"ApplicationSharing"}),dataCollaboration:G("capabilities.dataCollaboration",{internal:"contactSupportedModalities",type:D.linked,field:"modalities",element:"DataCollaboration"})});B.isBlocked=C(false,{code:"NotSupported"});B._isOrganizationContact=C(L);V.once(function(e){return!!e},function(){var e=V();y(W,t.sHref,e.href);e.updated(function(){u(j,function(t){var n=t.internalName;var r;if(a()){j["capabilities.audio"].property(true)}if(t.type!=D.direct){t.link=e.relatedHref(n);return}r=s(o());if(!e.dirty()||r!==undefined){t.property(r)}function a(){return n==="type"&&e.properties[n]===A}function o(){if(!l(n))return e.properties[n];return n.filter(function(t){return e.properties[t]}).map(function(t){return i(e.properties,t)})}function s(e){if(t.transform)return t.transform(e);return e}})})});v.restored(function(){for(var e=0,t=["status"];e<t.length;e++){var n=t[e];var r=j[n];if(r.observed)r.property.get()}});v.event($);Z();J()}function q(e){e.observed=true;switch(e.type){case D.direct:V.get().then(function(t){if(!t.has(e.internalName))Y()});break;case D.linked:K(e);break;case D.photo:e.property.get();break}}function z(e){e.observed=false;if(e.type==D.linked)Q()}function Y(){if(!P){P=V.get().then(function(e){return v.send("GET",e.href)});P.then(null,function(){P=null})}return P}function X(e){if(!k[e]){k[e]=v.send("GET",e).finally(function(){k[e]=null})}return k[e]}function J(){var e=j["avatarUrl"];if(e.link){return a.getPhotoUrl({ucwa:v,path:e.link}).then(function(t){e.property(t)})}}function K(e){U++;if(U==1){j["id"].property.get().then(function(e){N=R.subscribe(e)})}else if(e.dirty){F(e.modelName)}}function Q(){U--;if(U==0&&N){N.dispose();N=null}}function $(e){var t=V();var n=e.target;var r=e["in"];if(n&&e.type=="updated"&&r&&t&&r.href==t.href){u(j,function(e){if(e.type==D.linked&&n.rel==e.internalName){if(e.observed){F(e.modelName)}else{e.dirty=true}}})}}function Z(){var e=[];u(j,function(t){var n;if(t.type==D.linked&&t.link){n=v.get(t.link);if(!h(n.properties))ee(t,n);else e.push(t)}});return e}function ee(e,t){var n=!e.field?t.get():e.element?d(t.get(e.field),e.element)>=0:t.properties[e.field];e.property(e.transform?e.transform(n):n)}return s(B,a.prototype,{firstName:C(null),lastName:C(null)})}a.prototype.subscribe=function(){var e=[],t=this;u(t,function t(n){if(p(n)||v(n)){if(n.observed())e.push(n.subscribe())}if(f(n))u(n,t)});return new M(function(){for(var t=0,n=e;t<n.length;t++){var r=n[t];r.dispose()}e=[]})};return a}();t.Person=_;(function(e){var t;(function(e){e.Away="Away";e.Busy="Busy";e.DoNotDisturb="DoNotDisturb";e.Offline="Offline";e.Online="Online"})(t=e.Status||(e.Status={}));function n(e){return{PC:"Desktop",Mobile:"Mobile",Web:"Web"}[e]||"Unknown"}e.fixDeviceType=n;function r(t){return e.Status[t]||{BeRightBack:e.Status.Away,Idle:e.Status.Away,IdleOnline:e.Status.Away,IdleBusy:e.Status.Away,Unknown:e.Status.Offline}[t]||e.Status.Offline}e.fixStatus=r;function i(e){return(e||"").replace(/^(.+:)?(.+)$/,"$2")}e.extractPhoneNumber=i;e.getPhotoUrl=a(function(e){var t=e.ucwa,n=e.path;var r=t.get({rel:"applications"});var i=new b(r.href).path(n).query("");return i+""})})(_=t.Person||(t.Person={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.map;var r=e.Utils.clone;var i=e.Utils.assert;var a=e.Utils.extend;var o=e.Utils.batched;var s=e.Utils.foreach;var u=e.Utils.inherit;var c=e.Utils.debounce;var d=e.Utils.isEmptyObject;var l=e.Utils.timeStampToDate;var f=e.Utils.setHiddenProperty;var p=e.Utils.disableHtmlInText;var v=e.Utils.Enum;var h=e.Utils.Task;var m=e.Utils.Model;var g=e.Utils.Property;var y=e.Utils.Exception;var S=e.Utils.Collection;var b=e.Utils.ConstProperty;var w=e.Utils.SequentialStateMachine;var E=function(){function E(E,T){var I=g.bool(false);var M=g.bool(false);var C=I.or(M);var A=g.bool(false);var _=g.bool(false);var R=g.bool(false);var P=g.bool(false);var k=T&&T.supportsConferencing||b(false);var O=T&&T.guestName;var x=T&&T.reportMyActivityInterval||3*60*1e3;var D=T&&T.meActiveChangedDelay||1e4;var U=g.bool(true);var N=y("Reconnecting");var L;var V=v("Unavailable","Available");var W=w(V.Unavailable);var B={};var j={};var F=m();var G=u(F);var H=T&&T.tm;var q=T&&T.sendActivityTelemetry;var z=T&&T.preferredDesktopEndpoint;var Y=function(){return G._clientUpdatePolicy()==="redirectClient"||G._clientUpdatePolicy()==="updateClient"};var X=function(){return G._clientUpdatePolicy()!==""};T=null;var J=E.init().then(function(){var e=E.get({rel:"me"});return d(e.properties)?E.send("GET",{rel:"me"}).then(function(){return e}):e});W.defineState(V.Available,function(){return ne().then(function(){re();E.restored(function(){Q(false,N);if(Y())return;ne().then(function(){Q(true)}).finally(function(){return ee()})});E.connected.when(false,function(){Q(false)})})});$("id",{source:"uri"});$("displayName",{source:"name",parse:p});$("endpointUri",{source:"endpointUri"});$("title",{source:"title"});$("department",{source:"department"});$("emails",{source:"emailAddresses",isCollection:true,parse:function(e){return n(e||[],function(e){return m({type:b(null),emailAddress:b(e)})})}});$("email",{source:"emailAddresses",parse:function(e){return e&&e[0]||""}});G.phoneNumbers=Z("phoneNumbers",{source:"phones",isCollection:true,parse:function(e){return n(e||[],function(e){var n=e.properties,r=n&&n.type&&n.type.charAt(0).toUpperCase()+n.type.slice(1),i=n&&n.number,a=t.Person.extractPhoneNumber(i);return{type:b(r),telUri:b(i),displayString:b(a)}})},fetchAll:function(e){return h.waitAll(n(e.links("phone"),function(e){return E.send("GET",e.href)}))}});G.note=m({text:Z("note.text",{source:"note",fetchOnce:true,parse:function(e){return p(e&&e.message)},compose:function(e){return e&&e.message?r(e):{message:e,type:G.note.type()||"Personal"}}}),type:Z("note.type",{
source:"note",parse:function(e){return e&&e.type}}).asReadOnly()});G.location=Z("location",{source:"location",fetchOnce:true,parse:function(e){return p(e&&e.location)},compose:function(e){return{location:e}}});a(G.location,{type:b("Unknown"),street:b(null),city:b(null),state:b(null),country:b(null),postalCode:b(null)});G.status=Z("status",{source:"presence",value:"Offline",fetchOnce:true,parse:function(e){return e?t.Person.fixStatus(e.availability):"Offline"},compose:function(e){var t={};t.availability=e;return t}});G.activity=Z("activity",{source:"presence",parse:function(e){return p(e&&e.activity)}}).asReadOnly();G.endpointType=Z("endpointType",{source:"presence",parse:function(e){return t.Person.fixDeviceType(e&&e.deviceType)}}).asReadOnly();G.isBlocked=b(false);G.lastSeenAt=Z("lastSeenAt",{source:"presence",parse:function(e){return e&&l(e.lastActive)}}).asReadOnly();G.note.reset=function(){return W.advanceTo(V.Available).then(function(){return E.send("POST",{rel:"note"},{priority:100,data:{}})}).then(function(e){return null})};G.status.reset=function(){return W.advanceTo(V.Available).then(function(){return E.send("POST",{rel:"presence"},{priority:100,data:{}})}).then(function(e){return null})};G.location.reset=function(){return W.advanceTo(V.Available).then(function(){return E.send("POST",{rel:"location"},{priority:100,data:{}})}).then(function(e){return null})};var K=$("avatarUrl",{source:"photo"});var Q=g.bool(false);G.available=Q.fork(function(e){if(Q()&&!e)throw new Error("cannot downgrade the availability by calling me.available(false)");if(!Q()&&e){return W.advanceTo(V.Available).then(function(){Q(e);return e})}return e});G.active=g.bool(true);G.account=b(null);G._clientUpdatePolicy=g.just("");G.capabilities=m({chat:a(C,{text:I.fork(U),html:M.fork(U)}),pstn:_.fork(U),audio:A.fork(U),video:R.fork(U),screenSharing:P.fork(U),dataCollaboration:b(false),conferencing:k});function $(e,t){i(!G[e]);var n=t&&t.source;var r=t&&t.parse||function(e){return e};var a=(t&&t.isCollection?S:g)({get:function(){if(!L){L=J.then(function(){return E.send("GET",{rel:"me"})}).finally(function(){L=null})}return L.then(function(){return a()})}});a.fetchOnce=false;j[e]=a;G[e]=a.asReadOnly();J.then(function(e){e.updated(function(){if(e.has(n))a(r(e.get(n)))});e.deleted(function(){a(r(void 0))})});return a}function Z(t,n){i(!G[t]);var r=n.source;var a={rel:r};var o=n.parse;var s=n.compose;var u=n.fetchAll;var c=n.fetchOnce;var l={};var f=(n&&n.isCollection?S:g)({subscribed:m,value:n.value,get:function(){return J.then(function(){return E.exists(a)?v():m()})},set:function(t){if(t===l){l={};return t}H&&H.record(e.TelemetryEvent.MeSet,{rel:r});return W.advanceTo(V.Available).then(function(){return te(r,s(t))}).then(function(){return f()})}});function p(e){l=e;f(e);return e}function v(){B[r]=B[r]||E.send("GET",a).finally(function(){B[r]=null});return B[r].then(function(e){return h.wait(u?u(e):e.properties).then(o).then(p)})}function m(){return W.advanceTo(V.Available).then(v)}E.event(function(e){if(e.type in{updated:1,added:1}&&e.target&&e.target.rel==a.rel)v();else if(e.type=="deleted"&&e.target&&e.target.rel==a.rel){p(o(void 0))}});J.then(function(){if(E.exists(a)){if(!d(E.get(a).properties)){p(o(E.get(a).properties))}else if(c){v()}}});f.fetchOnce=c;j[t]=f;return f}function ee(){for(var e in j){if(j[e].fetchOnce)j[e].get()}}function te(e,t){var n=E.get({rel:e});te[e]=te[e]||o(function(t){var i=r(n.properties);s(t,function(e){a(i,e)});return E.send("POST",{rel:e},{data:i,priority:100,nobatch:true})},Infinity);return te[e](t,0)}function ne(){var t=Q.reason===N;var n=X();if(!n){var r=function(e){var t=[];for(var n=1;n<arguments.length;n++){t[n-1]=arguments[n]}return function(e){return t.indexOf(e)>=0}};G._clientUpdatePolicy.once(r(G._clientUpdatePolicy,"showNotification","redirectClient","updateClient","none"),function(){return ne()})}return J.then(function(r){var i=[];var a=[];if(I())i.push("Plain");if(M())i.push("Html");if(C())a.push("Messaging");if(_())a.push("PhoneAudio");if(A())a.push("Audio");if(R())a.push("Video");if(P())a.push("ApplicationSharing");if(n&&!Y()&&(t||!E.exists({rel:"reportMyActivity"}))){U(false);var o=h.run(function(){if(!r.hasLink("makeMeAvailable")){if(O&&O()){var t=E.get({rel:"communication"});var n=t.has("supportedMessageFormats");if(!n||n&&t.get("supportedMessageFormats")!=i){var o=t.get();o["supportedMessageFormats"]=i;var s=E.send("PUT",{rel:"communication"},{data:o,priority:100,nobatch:true});H&&H.monitor(s,e.TelemetryEvent.Communication,{supportedFormats:i&&i.join()},{sendEndEventOnly:true});return s}}return}var u=E.send("POST",r.link("makeMeAvailable").href,{data:{SupportedModalities:a,SupportedMessageFormats:i,preferredDesktopEndpoint:z},priority:100,nobatch:true});H&&H.monitor(u,e.TelemetryEvent.MeMakeAvailable,{supportedModalities:a&&a.join(),supportedFormats:i&&i.join(),preferredDesktopEndpoint:z},{sendEndEventOnly:true});return u});return o.finally(function(){return E.send("GET",{rel:"me"},{nobatch:true})})}})}function re(){var n;var r=function(){if(E.connected()&&!E.appDeleted()){if(!E.exists({rel:"reportMyActivity"}))return;var r=E.send("POST",{rel:"reportMyActivity"},{priority:100,nobatch:true}).catch(function(r){if(r&&r.code=="RequestFailed"&&r.rsp&&r.rsp.status==409)return;H&&H.record(e.TelemetryEvent.ReportActivityStopped,{reason:r});t.log("%c reportMyActivity stopped","color:red;font-weight:bold",r);e.clearInterval(n)});if(q){H&&H.monitor(r,e.TelemetryEvent.Activity,{action:"report",doc_hidden:document&&document.hidden,doc_visibility_state:document&&document.visibilityState},{sendEndEventOnly:true})}}};var i=function(t,i,a){if(q){H&&H.record(e.TelemetryEvent.Activity,{action:"user",active:t,doc_hidden:document&&document.hidden,doc_visibility_state:document&&document.visibilityState})}e.clearInterval(n);if(t&&X()&&!Y()){r();n=e.setInterval(r,x)}};G.active.changed(c(D,i))}if(O)O.changed(j.displayName);J.then(function(e){f(F,t.sHref,e.href);e.updated(function n(){if(e.hasLink("photo")&&!K()){e.updated.off(n);t.Person.getPhotoUrl({ucwa:E,path:e.link("photo").href}).catch(function(){return e.link("photo").href}).then(function(e){K(e)})}})});try{var ie=E.get(E.app.relatedHref("communication"));var ae=ie.get("supportedModalities",[]);var oe=ie.get("supportedMessageFormats",[]);if(oe.indexOf("Plain")>=0)I(true);if(oe.indexOf("Html")>=0)M(true);if(ae.indexOf("PhoneAudio")>=0)_(true);if(ae.indexOf("Audio")>=0)A(true);if(ae.indexOf("Video")>=0)R(true);if(ae.indexOf("ApplicationSharing")>=0)P(true)}catch(e){}return a(G,t.Person.prototype,{preferences:S.empty,firstName:b(null),lastName:b(null),office:b(null),company:b(null)})}return E}();t.MePerson=E})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.map;var r=e.Utils.find;var i=e.Utils.guid;var a=e.Utils.clone;var o=e.Utils.async;var s=e.Utils.check;var u=e.Utils.assert;var c=e.Utils.extend;var d=e.Utils.random;var l=e.Utils.indexOf;var f=e.Utils.inherit;var p=e.Utils.isArray;var v=e.Utils.isString;var h=e.Utils.contains;var m=e.Utils.isPrimitive;var g=e.Utils.isDictionary;var y=e.Utils.timeStampToDate;var S=e.Utils.convertHtmlToText;var b=e.Utils.convertTextToHtml;var w=e.Utils.disableHtmlInText;var E=e.Utils.Task;var T=e.Utils.Model;var I=e.Utils.SipUri;var M=e.Utils.Symbol;var C=e.Utils.Command;var A=e.Utils.DataUri;var _=e.Utils.Property;var R=e.Utils.Collection;var P=e.Utils.StringEnum;var k=e.Utils.ConstProperty;var O=e.Utils.EAlreadyExists;var x=e.Utils.EInvalidArgument;var D=t.Modality.State.Created;var U=t.Modality.State.Notified;var N=t.Modality.State.Connected;var L=t.Modality.State.Connecting;var V=t.Modality.State.Disconnected;var W=M("status");var B=M("starting");function j(e,t,n,r,i){var a="367A2DAE00F7417FB5CEFE6364C97D31";var o=JSON.stringify(c({},e,{customContent:"CID:"+a}));var s=["--"+i,"Content-Type: application/vnd.microsoft.com.ucwa+json","Content-Length: "+o.length,"",o,"--"+i,"Content-Type: "+n,"Content-Id: "+a,"Content-Disposition: render; handling=optional","",t,"--"+i+"--",""].join("\r\n");return{headers:{"Content-Type":"multipart/related;boundary="+i+';type="application/vnd.microsoft.com.ucwa+json"',"Content-Length":s.length,"X-MS-RequiresMinResourceVersion":r},data:s}}var F=function(){function M(M){var F=M.ucwa,G=M.conversation,H=M.rInvitation,q=M.guestName,z=M.tm,Y=M.settings;var X=G.participants;var J=G.selfParticipant;var K=G.topic;var Q=G.priority;var $=G.threadId;var Z=R();var ee=R();var te=R();var ne;var re=_();var ie=P("Unknown","UserAccepted","AutoAccepted","ConnectedElsewhere","Other");var ae=_(ie.Unknown);var oe=0;var se;var ue;var ce;var de;var le;var fe;var pe;var ve;var he=q&&q();var me=R({get:function(){var e=ne.get("negotiatedMessageFormats");var t=n(e,function(e){return e=="Plain"?"Text":e});return P.apply(null,t)}});var ge=T({state:re.asReadOnly(),acceptType:ae.asReadOnly(),messages:Z.asReadOnly(),shouldNotify:function(){return true},supportedMessageFormats:me.asReadOnly(),typingParticipantNames:te.asReadOnly(),typingParticipants:ee.asReadOnly()});function ye(e){return r(G.participants(),function(n){return n[t.sHref]==e})}function Se(t,n){try{return A(t.relatedHref(n)||"data:,").data||""}catch(t){z&&z.record(e.TelemetryEvent.ChatMessageDecodingError,{reason:t});return"□"}}function be(e){try{return l(ne.get("negotiatedMessageFormats"),e)>=0}catch(e){return false}}function we(e){le=null;fe=null;de=null;if(e&&e.code=="NotFound"||G.state()=="Disconnected"&&!G[t.sHref]){ne=null;H=null}}function Ee(e){if("html"in e)return be("Html")||!ne?{type:"text/html",data:e.html+""}:{type:"text/plain",data:S(e.html+"")};if("text"in e)return be("Plain")||!be("Html")?{type:"text/plain",data:e.text+""}:{type:"text/html",data:b(e.text+"")};throw x("message","must contain either `text` or `html` format")}function Te(n){var r=n.link("participant").href;var i=n.link("participant").title;var a=ye(r);var o=a&&a.person;if(i&&o&&o.displayName()!=i){o=f(o);o.displayName=k(w(i))}var s=new t.Message({href:n.href,participants:X,sender:o,text:Se(n,"plainMessage"),html:Se(n,"htmlMessage"),direction:t.Message.Direction.Incoming,ucwa:F});if(!Ie(s)){Z.add(s);z&&z.record(e.TelemetryEvent.Chat,{action:"receiveMessage",type:G.isGroupConversation()?"conf":"p2p",format:n.hasLink("htmlMessage")?"html":"plain",joinType:he&&"anon",callId:pe,remoteType:o&&o.type()})}else{le&&le.timestamp._set(s.timestamp());fe&&fe(n.href)}de=s}function Ie(e){return le&&le===de&&de.direction()==e.direction()}function Me(){var n=A(H.relatedHref("message")||"data:,");var r=n.mime=="text/plain"?n.data:"";var i=n.mime=="text/html"?n.data:"";var a=Oe()?X(0):J;fe=_();var o=new t.Message({href:fe,sender:a.person,participants:X,text:r,html:i,direction:t.Message.Direction.Incoming,ucwa:F});if(r||i){de=le=o;Z.add(o)}ge.toast=T({sender:a,text:o.text,html:o.html,priority:k(H.get("importance",void 0)),subject:k(w(H.get("subject",void 0)))});z&&z.record(e.TelemetryEvent.Chat,{action:"receiveMessage",type:G.isGroupConversation()?"conf":"p2p",format:i?"html":"plain",joinType:he&&"anon",callId:pe,isInvitation:true,remoteType:a.person&&a.person.type()})}function Ce(e){var n=new t.Message({href:e.href,participants:X,sender:J.person,ndrs:e.ndrs,text:e.text,html:e.html,status:e.status,time:e.timestamp,direction:t.Message.Direction.Outgoing,ucwa:F});Z.add(n,e.id||i());return n}F.observe("message completed",function(n){var i=n.resource;if(ne&&i.link("messaging").href==ne.href){if(i.get("direction")=="Incoming"){oe++;Te(i)}else{var a=r(Z(),function(e){return e[t.sHref]==i.href});if(!a){Ce({href:i.href,text:Se(i,"plainMessage"),html:Se(i,"htmlMessage"),ndrs:i.links("failedDeliveryParticipant"),status:n.status=="Success"?t.Message.Status.Succeeded:t.Message.Status.Failed,timestamp:y(i.get("timeStamp",null))||new e.Date})}}}});function Ae(){u(ne,"rel=messaging must be known before starting observing its state");ne.updated(function(){var e=ne.get("state","");if(e=="Disconnected")re(t.Modality.State.Disconnected);else if(e=="Connected")re(t.Modality.State.Connected);me.get()})}function _e(){var e=G[t.sHref];return e?F.get(e):null}function Re(){var e=_e();return e&&e.get("state","")=="Conferenced"}function Pe(){var e=_e();var t=e&&e.hasLink("messaging")&&e.link("messaging").href;var n=t&&F.exists(t)&&F.get(t);return n&&n.get("state",null)=="Connected"}function ke(){return G.meeting&&G.meeting.state()=="Notified"&&G.meeting.availableModalities.messaging()}function Oe(){return H?H.get("direction")=="Incoming":false}F.event(function(e){var t=e.target;var n=e["in"]||{};if(ne&&ne.hasLink("typingParticipants")&&n.href==ne.link("typingParticipants").href){if(e.type=="deleted"){ee.remove(t.href);te.remove(t.title)}else if(e.type=="added"){var r=ye(t.href);if(r&&!ee(t.href))ee.add(r,t.href);if(t.title&&!te(t.title))te.add(t.title,t.title)}}});F.event(function(e){var n=e.resource;var r=e.target;if(e.type=="started"&&r.rel=="messagingInvitation"&&n.link("conversation").href==G[t.sHref]){H=n;Le()}});F.event(function(n){var r=n.resource;var a=n.target;if(a.rel==="onlineMeeting"&&n.type==="added"&&r.hasLink("conversation")&&r.link("conversation").href===G[t.sHref]){if(ve===false){pe=i();z&&z.record(e.TelemetryEvent.Chat,{action:"escalate",type:"conf",joinType:he&&"anon",callId:pe,remoteType:X(0)&&X(0).person.type()})}}});F.event(function(n){var r=n.resource;var i=n.target;if(i.rel==="onlineMeetingInvitation"&&n.type==="completed"&&r.hasLink("conversation")&&r.link("conversation").href===G[t.sHref]){if(n.reason&&n.reason.subcode==="AutoAccepted"){ae(ie.AutoAccepted);z&&z.record(e.TelemetryEvent.Chat,{action:"accept",by:"auto",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,result:"succeeded",remoteType:X(0)&&X(0).person.type()})}else if(n.reason&&n.reason.subcode==="ConnectedElsewhere"){ae(ie.ConnectedElsewhere);z&&z.record(e.TelemetryEvent.Chat,{action:"accept",by:"other",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,result:"succeeded",remoteType:X(0)&&X(0).person.type()})}else{ae(ie.Other)}}});function xe(e){ne=e;ne.deleted(function(){return ne=null})}function De(e){xe(F.get(e));Ae()}function Ue(){var e=_e();if(!ne&&e.hasLink("messaging")){De(e.link("messaging").href);e.updated.off(Ue)}}function Ne(e,t,n){var r=_();ge[e]=C(o(n),r);re.changed(function(e){var n=h(t,function(t){return p(t)?e==t[0]&&re.reason===t[1]:e==t});r(n)})}Ne("start",[D,[L,B],V],function(n){n=n||{};var r=n.message;he=n.name||q&&q();var a=n.to;var o=n.context===void 0?void 0:m(n.context)?n.contextType||"text/plain":"text/json";var u=m(n.context)?n.context:JSON.stringify(n.context);var l=n.timestamp;var f=n.boundary;var p=n.operationId||i();var h=n.sessionContext||i();var y=re()===L&&re.reason===B;n=null;if(a&&!I.test(a))throw Error(".to must be a valid SIP URI");if(r&&!v(r)&&!g(r))throw Error('.message must be a string or a { text: "...", html: "..." } object');var S;var b;var w=G.isGroupConversation();ve=w;if(v(r))r={text:r};if(!w){if(!a)a=X(0).uri();else s(X.size()==0,"ambiguous remote party in 1:1 call");s(a,"the remote participant URI is not specified")}re(t.Modality.State.Connecting);ue=E.run(function(){if(G.meeting){if(G.meeting.state()==t.OnlineMeeting.State.Created){return G.meeting.start({name:he,uri:G.uri()})}}else if(w){return G.addMeeting().start({name:he,uri:G.uri()})}}).then(function(){var e=_e();if(!e){var t=F.get(F.app.relatedHref("communication")).link("startMessaging");t.rel="startMessaging";return t}var n=F.get(e.link("messaging").href);if(n.hasLink("addMessaging")){var t=n.link("addMessaging");t.rel="addMessaging";return t}else{return F.send("GET",n.href).then(function(e){var t=e.link("addMessaging");t.rel="addMessaging";return t})}}).then(function(e){var n={operationId:p,threadId:$()};if(!Re()){c(n,{to:e.rel=="addMessaging"?void 0:a,importance:Q(),subject:K(),sessionContext:h})}if(r){var i=Ee(r);n.message="data:"+i.type+","+A.encodeData(i.data);b=_();b(t.Message.Status.Pending);var s=_();F.wait({type:"started",target:{rel:"message"},sender:function(e){return H&&H.link("conversation").href==e.href}}).then(function(e){s(e.target.href)});S=Ce({id:r.id,href:s.asReadOnly(),text:r.text,html:r.html,timestamp:l,status:b})}function v(){var t=u!==void 0&&e.revision>=2?j(n,u,o,2,f||d()):{data:n};t.nobatch=true;return t}var m=v();var g=F.send("POST",e.href,m).catch(function(t){if(G.isThreadIdRejectedError(t)){G.resetThreadId();n.threadId=$();m=v();return F.send("POST",e.href,m)}throw t});var y=F.wait({type:"started",target:{rel:"messagingInvitation"},resource:function(e){return e.get("operationId","")==p||e.get("threadId","")==$()}}).then(function(e){H=e.resource});var w=F.wait({type:"completed",target:{rel:"messagingInvitation"},resource:function(e){return e.get("operationId","")==p||e.get("threadId","")==$()}}).then(function(e){if(e.status=="Failure")throw t.EInvitationFailed(e.reason,e.debug);H=e.resource;xe(F.get(H.link("messaging").href));if(Re()&&H.hasLink("acceptedByParticipant"))F.send("GET",H.link("acceptedByParticipant").href)});return E.waitAll([g,y,w])}).then(function(){if(b)b(t.Message.Status.Succeeded);Ae();if(Re())G[t.sInternal].inviteParticipants();re(t.Modality.State.Connected);return S}).catch(function(e){re(t.Modality.State.Disconnected,e);if(b)b(t.Message.Status.Failed,e);if(H&&H.hasLink("cancel"))F.send("POST",H.link("cancel").href);throw e}).finally(function(){ue=null});if(!y){pe=i();z&&z.monitor(ue,e.TelemetryEvent.Chat,{action:"start",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,contextType:o,remoteType:X(0)&&X(0).person.type()})}return ue});Ne("sendMessage",[D,U,L,N,V],function(n,r){if(v(n)){n=r&&r.toLowerCase()=="html"?{html:n}:{text:n}}var o=n[W]||_({value:"Pending"});var s=n[t.sHref]||_();var u=n.id||i();if(re()!=N){return E.run(function(){if(!(ue||ce||re()==U)){var i=ge.start({message:n});z&&z.monitor(i,e.TelemetryEvent.Chat,{action:"sendMessage",type:G.isGroupConversation()?"conf":"p2p",format:r?r.toLowerCase():"plain",joinType:he&&"anon",callId:pe,remoteType:X(0)&&X(0).person.type()});return i}if(Z(u))throw O("message.id = "+u);Ce({id:u,href:s,text:n.text,html:n.html,status:o});return(ue||ce||ge.accept()).then(function(){return ge.sendMessage(c(n,(e={id:u},e[t.sHref]=s,e[W]=o,e)));var e}).catch(function(e){o(t.Message.Status.Failed,e);throw e})})}if(Z(u)&&!n[t.sHref])throw O("message.id = "+u);var d=Ee(n);if(X(0)&&X(0).person.type&&X(0).person.type()=="ReplayBot"){try{d=Ee(c(a(n),{text:"*****",html:"*****"}))}catch(e){}}var l=Z(u)||Ce({id:u,href:s,text:n.text,html:n.html,status:o});var f=E.wait(se).then(function(){return F.send("POST",ne.link("sendMessage").href,{headers:{"Content-Type":d.type},data:d.data,nobatch:true})});se=f.finally(function(){return se=null});f.then(function(e){s(e.href)}).catch(function(e){o(t.Message.Status.Failed,e)});z&&z.monitor(f,e.TelemetryEvent.Chat,{action:"sendMessage",type:G.isGroupConversation()?"conf":"p2p",format:r?r.toLowerCase():"plain",joinType:he&&"anon",callId:pe,remoteType:X(0)&&X(0).person.type()});return f.then(function(){return l})});Ne("stop",[t.Modality.State.Connected,t.Modality.State.Connecting],function(){if(ue){ue.cancel();return}re(t.Modality.State.Disconnecting);var n=F.send("POST",ne.link("stopMessaging").href).then(function(){re(t.Modality.State.Disconnected)}).catch(function(e){re(t.Modality.State.Connected);throw e});z&&z.monitor(n,e.TelemetryEvent.Chat,{action:"stop",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,remoteType:X(0)&&X(0).person.type()});return n});Ne("reject",[t.Modality.State.Notified],function(n){if(n===void 0){n="Global"}re(t.Modality.State.Disconnecting);var r=E.wait().then(function(){return ke()?G.meeting.decline(n):F.send("POST",H.link("decline").href,{data:{reason:n}})}).then(function(){re(t.Modality.State.Disconnected)});z&&z.monitor(r,e.TelemetryEvent.Chat,{action:"decline",joinType:he&&"anon",type:G.isGroupConversation()?"conf":"p2p",callId:pe,remoteType:X(0)&&X(0).person.type()});return r});Ne("accept",[t.Modality.State.Notified],function(n){ae(n&&n.acceptType||ie.UserAccepted);re(t.Modality.State.Connecting);ve=G.isGroupConversation();ce=E.wait(null).then(function(){if(ke()){return G.meeting.accept().then(function(){re(t.Modality.State.Connecting,B);return ge.start(n)})}var e=F.send("POST",H.link("accept").href);var r=F.wait({type:"completed",target:{rel:"messagingInvitation",href:H.href}}).then(function(){xe(F.get(H.link("messaging").href))});return E.waitAll([e,r]).then(function(){Ae();re(t.Modality.State.Connected)})}).catch(function(e){re(t.Modality.State.Disconnected,e);throw e}).finally(function(){ce=null});z&&z.monitor(ce,e.TelemetryEvent.Chat,{action:"accept",by:"user",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,remoteType:X(0)&&X(0).person.type()});return ce});Ne("sendIsTyping",[t.Modality.State.Connected],function(){return F.send("POST",ne.link("setIsTyping").href,{nobatch:true})});function Le(){if(Oe()){pe=i();ae(ie.Unknown);Me();re(U)}else{if(H.hasLink("messaging"))xe(F.get(H.link("messaging").href));re(L)}F.wait({type:"completed",status:"Failure",target:{rel:"messagingInvitation",href:H.href}}).then(function(n){re(t.Modality.State.Disconnected,n.reason);if(Oe()&&n.reason&&n.reason.subcode==="ConnectedElsewhere"){ae(ie.ConnectedElsewhere);z&&z.record(e.TelemetryEvent.Chat,{action:"accept",by:"other",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,result:"succeeded",remoteType:X(0)&&X(0).person.type()})}else if(Oe()){ae(ie.Other)}});F.wait({type:"completed",status:"Success",target:{rel:"messagingInvitation",href:H.href}}).then(function(n){if(re()==U||re()==L&&!Oe()){De(H.link("messaging").href);re(t.Modality.State.Connected,n.reason)}if(Oe()&&n.reason&&n.reason.subcode==="AutoAccepted"){ae(ie.AutoAccepted);z&&z.record(e.TelemetryEvent.Chat,{action:"accept",by:"auto",type:G.isGroupConversation()?"conf":"p2p",joinType:he&&"anon",callId:pe,result:"succeeded",remoteType:X(0)&&X(0).person.type()});if(!G.isGroupConversation()&&X(0)&&X(0).person.type&&X(0).person.type()=="ReplayBot"&&G.acknowledge.enabled()){G.acknowledge()}}else if(Oe()){ae(ie.Other)}}).catch(function(e){re(t.Modality.State.Disconnected,e)})}function Ve(){pe=i();ae(ie.Unknown);re(t.Modality.State.Notified);G.meeting.state.when(t.OnlineMeeting.State.Connected,function(){var e=_e();if(!ne&&!ue&&!ce){if(e.hasLink("messaging"))De(e.link("messaging").href);else e.updated(Ue)}});G.meeting.state.when(t.OnlineMeeting.State.Disconnected,function(){return re(t.Modality.State.Disconnected)})}if(Pe()){re(t.Modality.State.Connected);De(_e().link("messaging").href);pe=i()}else if(H){Le();if(Y&&Y.replayBot&&X(0)&&X(0).uri()&&X(0).uri().toLowerCase().indexOf(Y.replayBot.sipUri||"replaybot@domain.com")>=0){e.setTimeout(function(){ge.accept({acceptType:ie.AutoAccepted})},2e3)}}else if(!ke()){re(t.Modality.State.Created)}re.when(t.Modality.State.Disconnected,we);G.state.when(t.Conversation.State.Disconnected,function(e){return re(t.Modality.State.Disconnected,e)});if(G.changed){G.changed(function(){if(ke())Ve()})}t.watch("ChatService::state",re);return ge}return M}();t.ChatService=F;(function(e){var t;(function(e){})(t=e.Options||(e.Options={}))})(F=t.ChatService||(t.ChatService={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.bind;var r=e.Utils.assert;var i=e.Utils.foreach;var a=e.Utils.inherit;var o=e.Utils.isString;var s=e.Utils.isEmptyObject;var u=e.Utils.disableHtmlInText;var c=e.Utils.setHiddenProperty;var d=e.Utils.Enum;var l=e.Utils.Task;var f=e.Utils.Model;var p=e.Utils.Command;var v=e.Utils.Property;var h=e.Utils.Exception;var m=e.Utils.Collection;var g=e.Utils.BoolProperty;var y=e.Utils.ConstProperty;var S=e.Utils.EDoesNotExist;var b=e.Utils.EInvalidArgument;var w=e.Utils.SequentialStateMachine;var E=function(){function E(T){var I=T.contactManager;var M=T.ucwa;var C=T.tm;var A=o(T.href)?y(T.href):T.href;var _=T.name;var R=T.uri;var P=y(!!T.isLocal);var k=T.convState||y(null);var O=A()&&M.get(A());var x=d("PureHref","Fetched");var D=w(x.PureHref);var U=v({value:false});var N=v({value:t.Modality.State.Disconnected});var L=v({value:E.State.Disconnected});var V=T.inConference;var W=g();var B={};var j={};var F=0;var G=v({value:t.Modality.State.Disconnected}),H=v({value:false}),q=v({value:false}),z=v({value:false}),Y=v();var X=v({value:R,set:function(e){if(e&&oe(e))return e;throw b("endpoint","the given value is not a valid uri")}});var J=v({value:t.Modality.State.Disconnected}),K=t.MediaStream&&new t.MediaStream,Q=m(),$;var Z=v({value:-1}),ee=v({value:-1}),te={};var ne=v({value:se(void 0),get:function(){return ne()||de().then(function(){return ne()})}});var re=a(T.person||I.get(ne()||ne));var ie=f();var ae=a(ie,{state:L.asReadOnly(),person:re,screenSharing:f({state:y(t.Modality.State.Disconnected),isControlling:y(false),stream:f({state:y("Stopped"),width:y(0),height:y(0),source:f({sink:f({container:y(null)})})})}),chat:f({isTyping:U.asReadOnly(),state:N.asReadOnly()}),audio:f({state:G.asReadOnly(),isMuted:H.fork(p(Se,V)),isOnHold:q.asReadOnly(),isSpeaking:z.asReadOnly(),endpoint:X,isUnmuteRequested:v({value:false})}),video:f({state:J.asReadOnly(),channels:Q,_videoSourceId:ee.asReadOnly()}),isJoined:W.asReadOnly(),reset:fe});T=null;if(t.VideoChannel){$=new t.VideoChannel({name:P()?"Self Channel":"Render Channel",isLocal:P()});$.stream.setSource(K);Q.add($)}pe("displayName");pe("name");pe("role");pe("uri");pe("sourceNetwork");pe("workPhoneNumber");pe("otherPhoneNumber");pe("isAnonymous","anonymous");pe("organizer");ve("admit");ve("reject");ve("eject");ve("promote");ve("demote");function oe(e){e=e.toLowerCase();return B.uri()&&B.uri().toLowerCase()==e||B.workPhoneNumber()&&B.workPhoneNumber().toLowerCase()==e||B.otherPhoneNumber()&&B.otherPhoneNumber().toLowerCase()==e||re.phoneNumbers.contains(function(t){return t.telUri()&&t.telUri.toLowerCase()==e})}function se(e){return O&&O.hasLink("contact")&&O.link("contact").href||e}function ue(){return A.get().then(function(){ce();return O})}function ce(){if(!M.exists(A()))throw S(A());if(O)return;c(ie,t.sHref,A());O=M.get(A());O.updated(function(){W(true);i(O.properties,function(e,t){if(t in B)B[t](e)});i(j,function(e,t){e.enabled(O.hasLink(t))});ne(se(ne()));if(O.hasLink("participantMessaging")){N(t.Modality.State.Connected)}if(O.hasLink("participantAudio")){ae[t.sInternal].audioLink=O.link("participantAudio").href}});O.deleted(le);O.memberships.changed(function(){var e=O.memberships.contains(function(e){return e.rel=="typingParticipants"});U(e)});O.dirty.changed(he)}function de(){return ue().then(function(){var e=D.advanceTo(x.Fetched);e.then();return e.then()})}function le(e){L(E.State.Disconnected,e);N(t.Modality.State.Disconnected,e);W(false,e);for(var n in j)j[n].enabled(false,e)}function fe(e){le(e);U(false,e);G(t.Modality.State.Disconnected,e);H(false,e);q(false,e);z(false,e);Y(undefined,e);ae.audio.isUnmuteRequested(false,e);J(t.Modality.State.Disconnected,e);Z(-1,e);ee(-1,e);te={}}function pe(e,t){t=t||e;var n=v({get:function(){return de().then(function(){return n()})},unsubscribed:ye,subscribed:function(){ge();ue().then(function(){if(!O.has(t))D.advanceTo(x.Fetched)})}});B[t]=n;ae[e]=n.asReadOnly()}function ve(e){var t=v({unsubscribed:ye,subscribed:function(){ge();ue().then(function(){if(!O.hasLink(e))D.advanceTo(x.Fetched)})},get:function(){return ue().then(function(){return O.hasLink(e)||D.advanceTo(x.Fetched).then(function(){return t()})})}});j[e]={enabled:t};ae[e]=p(n(me,e),t)}function he(){if(O.dirty()&&F>0)M.send("GET",O.href)}function me(e){return M.send("POST",O.link(e).href)}function ge(){F++}function ye(){F--}function Se(n){var r=n?"muteAudio":"unmuteAudio",i=M.get(ae[t.sInternal].audioLink);return l.run(function(){if(!i||!i.hasLink(r))return M.send("GET",ae[t.sInternal].audioLink);else return i}).then(function(e){if(!e)throw h("CannotMuteUnmuteRemoteParticipant",{reason:"AudioResourceNotFound",type:r});else if(!e.hasLink(r)){throw h("CannotMuteUnmuteRemoteParticipant",{reason:"LinkNotPresent",type:r})}return M.send("POST",e.link(r).href)}).then(function(){return n}).catch(function(t){C&&C.record(e.TelemetryEvent.AudioMuteUnmuteRemoteFailed,{reason:t,type:r});throw t})}function be(e){var n=e.target,r=e.resource,i=n.rel,a=e["in"],o=a&&a.rel,s=e.type,u,c,d=-1,l;c=/^participant(Audio|Video)$/.exec(i);if(!c)return;u=c[1];if(s=="added"||s=="updated"){c=/^(local)?participant$/i.exec(o);if(!c)return;l=c[1]!="local"?+n.title:u=="Audio"?+r.get("audioSourceId",-1):+r.get("videoSourceId",-1);if(isNaN(l))l=d;if(u=="Audio"){ae[t.sInternal].audioLink=n.href;Z(l)}else{ae[t.sInternal].videoLink=n.href;ee(l)}}else if(s=="deleted"&&u=="Video"){Z(d);ee(d)}}function we(e,n){e.changed(function(e,r,i){t.log("Participant ("+(B.displayName()||B.uri()||"")+")::"+n+"::",i+"=>"+e,r)})}c(ie,t.sInternal,{state:L,audioState:G,videoState:J,isSpeaking:z,audioSourceId:Z,videoSourceId:ee,isInMediaRoster:te,setMediaSourceId:be,isLocal:P,audioOnHold:q,audioMuted:H,videoStartedBeforeHold:Y,setVideoStarted:function(e){r($.isStarted);$.isStarted._set(e)},setVideoStream:function(t){var n=$.stream,r=n.source.sink.format(),i=n.source.sink.container();n.setSource(t||K);e.Media.log("Participant::SetVideoStream  stream %c"+(t&&t._id())+", "+B.displayName(),"color:green;font-weight:bold");if(t){t.source.sink.format(r);t.source.sink.container(i)}else{n.source.sink.format(r);n.source.sink.container(i)}}});we(Z,"audioSourceId");we(ee,"videoSourceId");we(L,"state");we(G,"audio state");we(J,"video state");if(_)B.name(_);if(R)B.uri(R);B.uri.changed(X);v.observe([re.displayName||y(null),B.name,B.uri],function(e,t,n){return B.displayName(t||e||n||"")});re.displayName=B.displayName.asReadOnly().map(u);v.observe([re.id||y(null),B.uri],function(e,t){return B.uri(t||e)});re.id=B.uri.asReadOnly();D.defineState(x.Fetched,function(){if(s(O.properties))return M.send("GET",O.href)});A.changed(function(){O=null;c(ie,t.sHref,A());D.reset();if(!A())A.get().then(ce);else try{ce()}catch(e){}});v.observe([N,G,J,k],function(e,n,r,i){L(i==t.Conversation.State.InLobby?E.State.InLobby:e==t.Modality.State.Connected||n==t.Modality.State.Connected?E.State.Connected:E.State.Disconnected)});M.observe("participantMessaging deleted",function(e){var n=e["in"];if(n&&n.href==A())N(t.Modality.State.Disconnected)});return ae}return E}();t.Participant=E;(function(e){var t;(function(e){e.Connected="Connected";e.Disconnected="Disconnected";e.InLobby="InLobby"})(t=e.State||(e.State={}))})(E=t.Participant||(t.Participant={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.guid;var r=e.Utils.Radix;var i=e.Utils.Base64;var a=new e.Date("1601-01-01T00:00:00Z");var o=1e-4;var s=o*(1<<16);var u=s*(1<<2);var c=u*(1<<5);var d=2147483648;var l=new r(256);var f=function(){function t(t,r){if(t===void 0||t instanceof e.Date){this.time=t||new e.Date;this.guid=r||n();this.next=[]}else if(typeof t==="string"){var o=i.decodeBytes(t);if(o.length<22||(o.length-22)%5!=0)throw SyntaxError("Invalid threadId: "+t);var f=o.slice(1,6).reverse().concat([1]);var p=l.number(f)*s+ +a;this.time=new e.Date(e.Math.round(p));this.guid=n.parse(o.slice(6,22));this.next=[];for(var v=22,h=this.time;v<o.length;v+=5){var m=l.number(o.slice(v,v+4).reverse());var g=m>=d?(m-d)*c:m*u;var y=new e.Date(+h+g);var S=o[v+4]&15;var b=o[v+4]>>4;this.next.push({time:y,seqn:S,rand:b});h=y}}}t.prototype.toString=function(){var t=[1];t.push.apply(t,l.digits((+this.time-+a)/s).slice(0,5).reverse().map(function(e){return e|0}));t.push.apply(t,n.bytes(this.guid));var r=this.time
;for(var o=0,f=this.next;o<f.length;o++){var p=f[o];var v=+p.time-+r;var h=l.digits(v/u<e.Math.pow(2,31)?e.Math.round(v/u):e.Math.round(v/c)+d);for(var m=3;m>=0;m--)t.push(h[m]||0);t.push((p.rand&15)<<4|p.seqn&15);r=p.time}return i.encodeBytes(t)};t.prototype.push=function(t,n,r){if(t===void 0){t=new e.Date}if(n===void 0){n=e.Math.random()*16|0}if(r===void 0){r=this.next.length}this.next.push({time:t,rand:n,seqn:r})};t.prototype.pop=function(){this.next.pop()};return t}();t.ThreadId=f})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.AsyncCommand;var r=e.Utils.DataUri;var i=e.Utils.Exception;var a=e.Utils.isPrimitive;var o=e.Utils.Model;var s=e.Utils.Property;var u=e.Utils.setHiddenProperty;var c=function(){function c(c){var d=c.rExtension;var l=c.ucwa;var f=c.tm;var p=s({value:true});var v=s();var h=s();var m=s();var g="4f97946f-dfe1-4954-aa51-7cff2c83f070";var y="3cd718e7-a311-4775-8178-e028bb921daa";function S(){var e=r(d.relatedHref("content")||"data:,");v.set(e.mime);h.set(e.data);m.set(d.get("serviceName"))}function b(t,n,o){if(t==void 0)throw i("ContentRequired");if(n==void 0)throw i("ContentTypeRequired");t=a(t)?t:JSON.stringify(t);var s=w(o||y,t,n);var u=l.send("POST",d.href,s).then(function(e){var t=r(e.relatedHref("result")||"data:,");return{content:t.data,contentType:t.mime}});f&&f.monitor(u,e.TelemetryEvent.ConversationExtension,{action:"send_data",href:d.href});return u}function w(e,t,n){var r=["--"+e,"Content-Type: application/vnd.microsoft.com.ucwa+json","",JSON.stringify({input:"CID:"+g}),"--"+e,"Content-Type: "+n,"Content-Id: "+g,"",t,"--"+e+"--",""].join("\r\n");return{headers:{"Content-Type":"multipart/related;boundary="+e+';type="application/vnd.microsoft.com.ucwa+json"'},data:r}}d.updated(function(){S();f&&f.record(e.TelemetryEvent.ConversationExtension,{action:"ucwa_updated"})});var E=o({content:h.asReadOnly(),contentType:v.asReadOnly(),serviceName:m.asReadOnly(),sendData:n(b,p)});u(E,t.sHref,d.href);return E}return c}();t.ConversationExtension=c})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.find;var r=e.Utils.guid;var i=e.Utils.size;var a=e.Utils.check;var o=e.Utils.sleep;var s=e.Utils.assert;var u=e.Utils.extend;var c=e.Utils.random;var d=e.Utils.foreach;var l=e.Utils.indexOf;var f=e.Utils.inherit;var p=e.Utils.contains;var v=e.Utils.debounced;var h=e.Utils.decorated;var m=e.Utils.getOption;var g=e.Utils.disableHtmlInText;var y=e.Utils.setHiddenProperty;var S=e.Utils.Task;var b=e.Utils.Event;var w=e.Utils.Model;var E=e.Utils.Command;var T=e.Utils.DataUri;var I=e.Utils.WeakMap;var M=e.Utils.Promise;var C=e.Utils.Property;var A=e.Utils.Exception;var _=e.Utils.Collection;var R=e.Utils.NumProperty;var P=e.Utils.BoolProperty;var k=e.Utils.AsyncCommand;var O=e.Utils.ConstProperty;var x=e.Utils.ENotSupported;var D=e.Utils.EnabledCommand;var U=e.Utils.DisabledAsyncCommand;var N=e.Utils.ConstCollection;var L=e.Utils.SourcedProperty;var V=e.Utils.ComputedProperty;var W=e.Utils.EInvalidArgument;var B=e.Utils.EnabledAsyncCommand;var j=function(){function j(F){var G=F.ucwa;var H=F.me;var q=F.href;var z=F.clt;var Y=F.contactManager;var X=F.mediaPlugin;var J=F.devices;var K=F.sharedResources;var Q=F.rInvitation;var $=F.guestName;var Z=F.muteNdrForMeeting;var ee=false;var te=C({value:F.threadId||new t.ThreadId+""});var ne=C({value:F.topic||""});var re=C({value:F.priority||"Normal"});var ie=C({value:F.uri||null});var ae;var oe=F.tm;var se=F.settings;var ue=F.participants||_({get:function(){return S.run(function(){return G.send("GET",ve.link("participants").href).then(function(e){var t=e.links("participant").map(function(e){return G.get(e.href)});var n=t.map(function(e){return G.send("GET",e.href).catch()});return S.waitAll(n).then(function(){return rt(t)})})}).catch()}});var ce=Q?Q.rel=="onlineMeetingInvitation":"isConference"in F?!!m(F,"isConference"):true;var de=P(ce);s(de()||ue.size()<2);F=null;var le=C({value:j.State.Created});var fe=_();var pe=new b({added:function(e){return e()}});var ve;var he=C({value:false});var me=C({value:false});var ge=C({value:false});var ye=C({value:false});var Se=C({value:false});var be=C({value:false});var we=C.just(false);var Ee=C.just(false);var Te=C.just(false);var Ie=C.just(false);var Me=C.just(false);var Ce=le.equalsAny(j.State.Conferenced,j.State.Conferencing);var Ae=_();var _e;var Re=_({get:function(){return S.run(function(){if(!ve.hasLink("conversationExtensions"))return;var n=G.send("GET",ve.link("conversationExtensions").href).then(function(e){var n=e.links("conversationExtension").map(function(e){return e.href});Re.removeAll(function(e){return n.indexOf(e[t.sHref])<0});ot(n)});oe&&oe.monitor(n,e.TelemetryEvent.Conversation,{action:"getConvExtensions",href:ve.link("conversationExtensions").href});return n}).catch()}});var Pe=w();var ke=f(Pe,{id:O(r()),threadId:te.asReadOnly(),changed:pe.observer,state:le.asReadOnly(),isJoiningEnabled:O(true),topic:ne.fork(E(function(e){return e},le.equals("Created"))),priority:re.asReadOnly(),uri:ie.asReadOnly(),context:nt(),attachConvLog:Ze,modalities:u(fe.asReadOnly(),{chat:we.asReadOnly(),audio:Ee.asReadOnly(),video:Te.asReadOnly(),screenSharing:Ie.asReadOnly(),dataCollaboration:Me.asReadOnly()}),activeModalities:w({chat:he.asReadOnly(),audio:me.asReadOnly(),video:ge.asReadOnly(),screenSharing:ye.asReadOnly(),dataCollaboration:Se.asReadOnly()}),isGroupConversation:de.asReadOnly(),acknowledge:k(v(St),be),confirm:B(h([oe&&oe.monitored(e.TelemetryEvent.ConfAck)],function(){return ke.meeting.acknowledge()})),addModality:Et,addMeeting:Tt,forceDisconnectConversation:dt,resetThreadId:ut,isThreadIdRejectedError:ct,leave:k(It,le.map(function(e){return e!="Created"&&e!="Disconnected"})),createParticipant:D(ht),participantsCount:ue.size,participants:ue.fork({add:E(mt,le.equalsAny(j.State.Created,j.State.Connected,j.State.Conferenced,j.State.Disconnected)),remove:k(gt,ue.reduce(function(e,t){return e||t.eject&&t.eject.enabled()||t.state&&t.state()=="Disconnected"},false))}),avatarUrlSmall:O(null),avatarUrlLarge:O(null),createInvitation:function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}return void 0},pendingInvitations:_.empty,spawnedConversation:O(null),extensions:Re.asReadOnly()});var Oe=[];var xe=new I;var De=R();var Ue=R(0);var Ne=P(false);var Le=V([Ce,De,Ue,Ne],function(e,t,n,r){return e&&(n>t||r)});var Ve=new S;var We=C({get:function(){return We()||Ve.promise}});We.changed(function(e){if(e&&Ve){Ve.resolve(e);Ve=null}});var Be;var je=C({value:false});var Fe=C({value:false});var Ge;function He(e,n,r,i,a){var o=n.person;var s=new t.ActivityItem(e,i,{author:o,persons:N([o]),context:O(void 0,x()),status:O(r?"Failed":"Succeeded",a||r)});s.isRead(true);Ae.add(s)}function qe(e){le.when("Conferenced",function(){He("ParticipantJoined",e);le.once("Disconnected",function(t){He("ParticipantLeft",e,null,null,t)})});ue.added(function(e){e.isJoined.changed(function(t){if(Le())He(t?"ParticipantJoined":"ParticipantLeft",e)})})}function ze(n){var r,i,a,o,s,u;function c(e,n,r){var i=new t.ActivityItem(e,null,{direction:O(n),duration:O(r||null)});i.isRead(true);Ae.add(i);return i}function d(e){if(e!="AcceptedByOtherInstance"&&!(e&&e.subcode=="ConnectedElsewhere"))c("CallMissed","Incoming");r=null}function l(){u=c("CallStarted",ee?"Incoming":"Outgoing");if(a){a.dispose();a=null}i=null;o=n.once("Connecting",p);s=n.once("Disconnected",v)}function f(){if(i){i.dispose();i=null}}function p(){if(s){s.dispose();s=null}o=null}function v(){c("CallEnded",ee?"Incoming":"Outgoing",e.Math.round((e.Date.now()-u.timestamp())/1e3));if(o){o.dispose();o=null}s=null}n.when("Notified",function(){r=n.once("Disconnected",d)});n.when("Connecting",function(){if(r){r.dispose();r=null}i=n.once("Connected",l);a=n.once("Disconnected",f)})}function Ye(){var e;var t=L();de.when(false,function(){e=ue.size.when(1,function(){return t.setSource(ue(0).person.avatarUrl)})});de.when(true,function(){t.setSource(O(null));if(e){e.dispose();e=null}});return t.asReadOnly()}function Xe(e){Q=e;ee=Q.get("direction")=="Incoming";ft(G.get(Q.link("conversation").href));te.set(Q.get("threadId")+"");ke.context=nt();if(Q.hasLink("from")&&ee){var n=Q.link("from").href;var r=G.get(n).get("name",void 0);vt(n,r)}else if(Q.hasLink("to")&&!ee){var i=Q.link("to").href;var a=ue.filter(function(e){return e.person[t.sHref]==i});if(a.size()==0){var o=Y.get(i);var s=ht(o);mt(s)}}le(ee?j.State.Incoming:j.State.Connecting);if(Q.rel=="onlineMeetingInvitation"){ke.meeting=new t.OnlineMeeting({ucwa:G,rInvitation:Q,from:ee?ue(0):ae,conversation:ke,contactManager:Y});pe.fire()}}function Je(){return S.run(function(){var e=ve.link("participants").href;return G.send("GET",e).then(function(e){var r=[];ue.each(function(i,a){var o=i[t.sHref];var s=n(e.links("participant"),function(e){return e.href==o});if(o&&!s)r.push(a)});for(var i=0,a=r;i<a.length;i++){var o=a[i];ue.remove(o)}})})}function Ke(){y(Pe,t.sHref,q);y(Pe,t.sInternal,{inviteParticipants:bt,processInvitation:Xe});ke.participants.sync=Je;if(q){ft(G.get(q));te.set(ve.get("threadId",te()));rt();it();at()}ae=tt({href:We.asReadOnly(),person:H,convState:le,isLocal:true});ke.selfParticipant=ae;if(Q){Xe(Q)}else if(ie()){ke.meeting=new t.OnlineMeeting({ucwa:G,threadId:te(),subject:ne(),priority:re(),conversation:ke,contactManager:Y})}if(ke.meeting)ke.meeting.uri.changed(ie);_e=new t.ChatService({ucwa:G,guestName:$,conversation:ke,rInvitation:Q&&Q.rel=="messagingInvitation"&&Q,tm:oe,settings:se});ke.chatService=_e;ae.chat.state=_e.state.map(function(e){return e=="Created"?"Disconnected":e});var n=R(0);var r=C({value:new e.Date});var i=c();var a=function(e){return i+":"+e};_e.messages.added(function(e,t){return $e(e,a(t))});_e.messages.removed(function(e,t){return Ae.remove(a(t))});Ae.added(function(e){if(!e.isRead()){n.inc();e.isRead.once(true,function(){return n.dec()})}if(e.timestamp()>r())r(e.timestamp())});ke.historyService=w({activityItems:Ae.sort(function(e,t){return e.timestamp()<t.timestamp()}),unreadActivityItemsCount:n.asReadOnly(),isHistoryDisclosed:O(false),getMoreActivityItems:k(v(et),V([de,ue.size],function(e,t){return!e&&t==1&&!!z})),markAllAsRead:B(function(){return Ae.each(function(e){return e.isRead(true)})}),removeAll:B(function(){return Ae.empty()}),addCustomActivityItem:D(function(e,n){return void Ae.add(new t.ActivityItem(e,null,n))}),removeCustomActivityItem:D(function(e){return void Ae.removeAll(function(t){return t.type()==e})})});y(ke,"addMessageActivityItem",$e);ke.lastModificationTimestamp=r.asReadOnly();ke.phoneAudioService=t.PhoneAudio&&new t.PhoneAudio({tm:oe,ucwa:G,name:$,invitation:Q&&Q.rel=="phoneAudioInvitation"?Q:null,conversation:ke});Be=t.AudioVideoModality&&new t.AudioVideoModality({ucwa:G,guestName:$,mediaPlugin:X,devices:J,participants:ue.asReadOnly(),selfParticipant:ae,conversation:ke,rConversation:ve,me:H,rInvitation:Q,tm:oe,settings:se});ke.audioService=Be&&w({callConnected:Be.connectedAt,state:Be.audioState,start:E(Be.start,V([H.capabilities.audio,Be.audioState,Be.start.enabled],function(e,n,r){return e&&(n==t.Modality.State.Disconnected||n==t.Modality.State.Notified&&r)})),stop:E(Be.stop,je),accept:E(Be.accept,V([H.capabilities.audio,Be.audioState],function(e,n){return e&&n==t.Modality.State.Notified})),reject:E(Be.decline,Be.audioState.equals(t.Modality.State.Notified)),transfer:Be.transfer,sendDtmf:Be.sendDtmf});ke.videoService=Be&&w({state:Be.videoState,start:k(function(e){return Be.start(u(e,{video:true},"append"))},V([H.capabilities.video,Be.audioState,Be.videoState,Be.start.enabled],function(e,n,r,i){t.log("me.capabilities.video = "+e+", avm.audioState = "+n+", avm.videoState = "+r+", avm.start.enabled = "+i);return e&&(r==t.Modality.State.Disconnected||r==t.Modality.State.Notified&&i)&&(n==t.Modality.State.Connected||n==t.Modality.State.Disconnected||n==t.Modality.State.Notified&&i)})),stop:k(function(){return Be.stop("video")},Fe),accept:k(function(e){return Be.accept(u(e,{video:true}))},V([H.capabilities.video,Be.videoState],function(e,n){return e&&n==t.Modality.State.Notified})),reject:E(Be.decline,Be.videoState.equals(t.Modality.State.Notified)),maxVideos:O(null),videoMode:Be&&Be.videoMode,activeSpeaker:Be&&Be.activeSpeaker});ke.screenSharingService=w({sharer:O(null),sharedResources:_.empty,controller:O(null),controlRequesters:_.empty,requestControl:U(),releaseControl:U(),acceptControlRequest:U(),rejectControlRequest:U(),start:U(),stop:U(),accept:U(),reject:U()});ke.fileTransferService=w({files:_.empty,send:U()});Be&&u(ae.audio,{isMuted:Be.muted,isOnHold:Be.onHold,isUnmuteRequested:C({value:false})});ke.creator=ke.meeting?ke.meeting.creator:ee?ue(0).person:Q?ae.person:q?st():ae.person;le.changed(function(){switch(le()){case j.State.Connecting:case j.State.Connected:de(false);break;case j.State.Conferencing:case j.State.Conferenced:de(true);break}});ie.changed(function(){if(!!ie())de(true)});ue.size.changed(function(){switch(le()){case j.State.Created:case j.State.Disconnected:de(ue.size()>1||ce);break}});qe(ae);ze(ae.audio.state);ke.avatarUrl=Ye();he.when(true,Mt);ge.when(true,Ct);if(Be){Ge=V([Be.state,Be.audioState],function(e,n){return e==t.Modality.State.Connected&&n==t.Modality.State.Connected});Ge.when(true,Ct)}Be&&Qe()}function Qe(){var e,n,r=[Be.audioState,Be.videoState];if(!Ce()){e=C();n=C();ae.audio.state.changed(e);ae.video.state.changed(n);r.push(e);r.push(n)}C.observe(r,function(e,n,r,i){var a=[t.Modality.State.Connected,t.Modality.State.Connecting];var o=p(a,function(t){return e==t});if(!Ce()&&r)o=o&&p(a,function(e){return r==e});var s=p(a,function(e){return n==e});if(!Ce()&&i)s=s&&p(a,function(e){return i==e});je(o);Fe(s)})}function $e(e,n){var r=e;if(Z&&e.direction()=="Outgoing"&&ke.isGroupConversation()){r=f(e,{status:e.status.map(function(t){if(t=="Failed"&&e.status.reason&&e.status.reason["code"]=="RemoteFailure"){return"Succeeded"}return t})})}var i=new t.ActivityItem("TextMessage",n,r);if(e.direction()=="Outgoing")i.isRead(true);Ae.add(i,n);return i}function Ze(e){Oe.push(e);var t={Messaging:we,Audio:Ee,Video:Te,ApplicationSharing:Ie,DataCollaboration:Me};for(var n in t)if((e.modalities()||[]).indexOf(n)>=0)t[n].set(true)}function et(){function e(e,t){var n=ke.historyService.activityItems();for(var r=0;r<n.length;r++){var i=n[r];if(i.type()==t&&i.direction()==e.direction()){var a=+i.timestamp()-+e.timestamp();if(a==0){return false}else if(a>0){if(!i.sender&&a<6e4){return false}break}}}return true}function n(e){for(var t=0,n=Ae();t<n.length;t++){var r=n[t];if(r.type()!="TextMessage")continue;var i=r;if(i.text()==e.text()&&i.direction()==e.direction())return false}return true}var r=Oe.map(function(r){return r.conversationLogTranscripts.conversationLogTranscript.get().then(function(i){for(var a=0,o=i;a<o.length;a++){var s=o[a];var u=s.timeStamp();var c=s.contact.href();if(z.test("AudioLog")){var d=s.audioTranscript.status();if(d){var l=d=="Ended"?"CallEnded":d=="Connected"?"CallStarted":"";var f=new t.ActivityItem(l,null,{direction:C.readonly(r.direction()),duration:C.readonly(+s.audioTranscript.duration()||null),timestamp:C.readonly(u),sender:c?Y.get(c):H});if(e(f,l)){Ae.add(f);f.isRead(true)}}}if(z.test("MessageLog")){var p=s.messageTranscript;var v=p.htmlMessage.href();var h=p.plainMessage.href();if(v||h){var m=new t.Message({ucwa:G,sender:c?Y.get(c):H,participants:ue.asReadOnly(),time:u,text:h,html:(v||"").replace(/style="[^"]+"[^"]+""/gim,""),direction:c?"Incoming":"Outgoing"});if(n(m))$e(m).isRead(true)}}}}).catch()});Oe.length=0;return M.all(r).then(function(){})}function tt(e){u(e,{ucwa:G,tm:oe,contactManager:Y,inConference:de.asReadOnly()});var n=new t.Participant(e),r=C(),i=C({value:false});var a;var o,s,c,d;function l(e){if(e){if(!o){var t=s?s:M.resolve();c=o=t.then(function(){return Be.showParticipantVideo(n)}).then(function(){return e});o.finally(function(){o=null})}return c}else{if(!s){var t=o?o:M.resolve();d=s=t.then(function(){return Be.removeParticipantVideo(n)}).then(function(){return e});s.finally(function(){s=null})}return d}}function f(){return Be&&Be.videoMode()!="ActiveSpeaker"}if(n.video.channels(0)){if(e.isLocal){a=n.video.state.map(function(e){return e==t.Modality.State.Connected});n.video.channels(0).isStarted=C({value:false,set:E(l,a)})}else{n.video.state.changed(function(e){return r(e)});C.observe([Ce,r],function(e,n){return i(f()&&e&&n==t.Modality.State.Connected)});n.video.channels(0).isStarted=C({value:false,set:E(l,i)})}}return n}function nt(){if(Q&&Q.rel=="onlineMeetingInvitation"){var e=O(Q.get("subject",""));e.type=O(void 0);return e}else{var t=Q&&Q.relatedHref("customContent");var n,r=T(t||"data:,");n=O(r.mime==="text/json"||r.mime==="application/json"?JSON.parse(r.data):r.data);n.type=O(r.mime);return n}}function rt(e){e=e||G.find(function(e){return e.rel=="participant"&&e.hasLink("conversation")&&e.link("conversation").href==ve.href});e.forEach(function(e){if(e.get("local",false))We(e.href);else vt(e.href,e.get("name",void 0))})}function it(){if(ve.hasLink("onlineMeeting")){ke.meeting=new t.OnlineMeeting({ucwa:G,rMeeting:G.get(ve.link("onlineMeeting").href),conversation:ke,contactManager:Y})}}function at(){var e=G.get({rel:"conversationExtensions"},null);if(e&&ve.hasLink("conversationExtensions")&&ve.link("conversationExtensions").href==e.href&&e.hasLink("conversationExtension")){ot(e.links("conversationExtension").map(function(e){return e.href}))}}function ot(e){d(e,function(e){var n=Re.index(e);if(n<0||n==void 0){var r=new t.ConversationExtension({ucwa:G,rExtension:G.get(e),tm:oe});Re.add(r,e)}})}function st(){var e=G.find(function(e){return/Invitation$/.test(e.rel)&&e.hasLink("conversation")&&e.get("direction")=="Incoming"&&e.link("conversation").href==ve.href});return e.length>0?ue(0).person:ke.selfParticipant.person}function ut(){var n=te();te.set(new t.ThreadId+"");var r=[];for(var i in ke.activeModalities){if(ke.activeModalities[i]())r.push(i)}oe&&oe.record(e.TelemetryEvent.Conversation,{action:"reset_thread_id",threadId:n,newThreadId:te(),type:de()?"conf":"p2p",modalities:JSON.stringify(r)})}function ct(e){return e&&e.rsp&&e.rsp.status==400&&e.rsp.data&&e.rsp.data.subcode=="ParameterValidationFailure"&&e.rsp.data.parameters&&e.rsp.data.parameters[0]&&e.rsp.data.parameters[0].name=="threadId"}function dt(e){lt(e);he(false,e);me(false,e);ge(false,e);ye(false,e);Se(false,e);be(false,e);ke.selfParticipant.reset(e);for(var t=0,n=ue();t<n.length;t++){var r=n[t];r.reset(e)}}function lt(e){ke[t.sHref]=null;q=null;ve=null;Q=null;try{var n=new t.ThreadId(te());n.push();te.set(n+"")}catch(e){}for(var r=0,i=ue();r<i.length;r++){var a=i[r];xe.get(a).set(null)}if(de())ue.empty();De(void 0);Ue(0);delete ke.meeting;pe.fire();le(j.State.Disconnected,e);ee=false}function ft(e){q=e.href;ve=e;y(ke,t.sHref,q);ve.deleted(lt);ve.updated(function(){function e(e,t,n){if(ve.has(e)&&!(n&&ve.get(e)==n))t(g(""+ve.get(e)))}e("state",le,"Disconnected");e("importance",re);e("subject",ne)});ve.updated(function(){var e=ve.get("activeModalities",[]);he(l(e,"Messaging")>=0);me(l(e,"Audio")>=0);ge(l(e,"Video")>=0);ye(l(e,"ApplicationSharing")>=0);Se(l(e,"DataCollaboration")>=0)});ve.updated(function(){be(ve.hasLink("userAcknowledged"))});var n=ve.updated(function(){if(ve.has("participantCount"))De(+ve.get("participantCount"))});De.once(function(e){return e>0&&(ie()=="adhoc"||!ie())},function(){return n.dispose()});Ne(false);o(10).then(function(){return Ne(true)})}G.event(function(e){var n=e.sender;var r=e.target;var i=e["in"];if(n.href==q&&/^(localParticipant|participant)$/.test(r.rel)){if(!i){if(e.type=="deleted"){if(Ce()&&r.rel=="participant"){S.run(function(){return Be[t.sInternal].onParticipantDeleted(e)}).finally(function(){var e=ue.removeAll(function(e){return e[t.sHref]==r.href});if(e==0){}})}}else if(e.type=="added"){Ue.inc();if(r.rel=="localParticipant"){We(r.href)}else{var a=/\/(\w+@\w+\.\w+)$/.exec(r.href);vt(r.href,r.title||a&&a[1])}}}else if(e.type=="added"&&i.rel=="lobby"){var o=pt(r.href);o[t.sInternal].state("InLobby")}}});G.event(function(e){var n=e.target;var r=e["in"]||{};if(e.type=="added"&&n.rel=="onlineMeeting"&&r.href==q){if(!ke.meeting){ke.meeting=new t.OnlineMeeting({ucwa:G,rMeeting:e.resource,conversation:ke,contactManager:Y});ke.creator=ke.meeting.creator;ke.meeting.uri.changed(ie);pe.fire()}}});G.event(function(e){if(e.type=="completed"&&e.target.rel=="onlineMeetingInvitation"&&e.status=="Success"&&e.resource.link("conversation").href==q)G.send("GET",q)});G.event(function(e){var t=e.resource;if(t&&t.rel=="conversation"&&t.get("threadId","")==te()&&!ve)ft(t)});G.event(function(e){var t=e.resource;if(!q&&e.type=="started"&&t.get("threadId","")==te()&&/Invitation$/.test(t.rel)&&t.get("direction","")=="Incoming")Xe(t)});G.event(function(e){var n=e.sender;var r=e.target;var i=e["in"]||{};if(n.href==q&&Ce()&&i.rel=="participant"&&/^participant(Audio|Video)$/.test(r.rel)){var a=pt(i.href);if(a){if(e.type=="added"||e.type=="updated"||!ge())a[t.sInternal].setMediaSourceId(e);var o=e.type=="deleted"?t.Modality.State.Disconnected:t.Modality.State.Connected;if(r.rel=="participantAudio")a[t.sInternal].audioState(o);else a[t.sInternal].videoState(o)}}});G.event(function(n){var r=n.sender;var i=n.target;var a=n.resource;if(r.href==q&&i.rel=="conversationExtension"){switch(n.type){case"added":var o=new t.ConversationExtension({ucwa:G,rExtension:a,tm:oe});Re.add(o,i.href);oe&&oe.record(e.TelemetryEvent.ConversationExtension,{action:"ucwa_added"});break;case"deleted":Re.remove(i.href);break}}});le.when("Conferenced",function(e,t){if(ee)Je()});function pt(e){return n(ue(),function(n){return n[t.sHref]==e})}function vt(e,n){return S.run(function(){var n={};for(var r=0,a=ue();r<a.length;r++){var o=a[r];if(o[t.sHref]==e)return o;if(!o[t.sHref]){var u=o.person[t.sHref];var c=o.person.id();s(u||c,"either /contact.href or uri must be known");n[u||c.toLowerCase()]=o}}if(i(n)==0)return null;if(ue.size()==1&&!de())return ue(0);var d={};function l(){var t=G.get(e);var r=t.hasLink("contact")&&t.link("contact");var i=t.has("uri")&&t.get("uri")||"";var a=r&&n[r.href]||n[i.toLowerCase()];if(a)return a;if(r&&i)throw d}return S.run(function(){return l()||G.send("GET",e).then(l)}).catch(function(e){if(e===d)return null;throw e})}).then(function(t){if(t){var r=xe.get(t);r(e)}else{var i=C({value:e});s(!G.get(e).get("local",false));t=tt({href:i.asReadOnly(),name:n});ue.add(t);xe.set(t,i)}})}function ht(e){var n=new S;n.promise.then();var r=C({get:function(){if(r())return r();if(!n){n=new S;n.promise.then()}return n.promise}});r.changed(function(e){if(e&&n){n.resolve(e);n=null}});if(typeof e==="object"){s(e[t.sHref],"rel=contact is unknown")}var i=tt((a={href:r.asReadOnly()},a[typeof e==="object"?"person":"uri"]=e,a));xe.set(i,r);return i;var a}function mt(e){if(typeof e==="string")e=ht(e);if(typeof e==="object"){if(!xe.has(e))throw W("participant","is not created by this conversation");ue.add(e);if(le()=="Connected"||le()=="Conferenced")return wt(e)}}function gt(e){if(typeof e==="string"){e=n(ue(),function(t){var n=(t.uri()+"").toLowerCase();var r=(e+"").toLowerCase();return n==r})}if(typeof e==="object"){if(ue.contains(function(t){return t===e})){return S.run(function(){if(e.eject.enabled())return e.eject();if(e.state()=="Disconnected")return;throw A("InvalidState")}).then(function(){ue.removeAll(function(t){return t===e});xe.delete(e)})}}throw A("InvalidState")}function yt(e){return G.send("POST",ve.link("addParticipant").href,{data:{to:e}}).then(function(e){return G.wait({type:"completed",target:{rel:"participantInvitation",href:e.href}})}).then(function(e){if(e.status!="Success")throw t.EInvitationFailed(e.reason)})}function St(){return G.send("POST",ve.link("userAcknowledged").href)}function bt(){ue.each(function(e){if(!e[t.sHref]&&e.state()=="Disconnected")wt(e)})}function wt(e){s(!e[t.sHref]&&e.state()=="Disconnected");e[t.sInternal].state("Connecting");return yt(e.person.id()).then(function(n){return e[t.sInternal].state("Connected")},function(n){e[t.sInternal].state("Disconnected",n);He("ParticipantJoinFailed",e,n);ue.removeAll(function(t){return e===t});xe.delete(e)})}function Et(e,n){a(e==j.ModalityType.AppSharing,"NotImplemented",{modality:e});s(!fe(e),"AlreadyExists",{item:e});var r;n=n||{};u(n,{ucwa:G,contactManager:Y,participants:ue.asReadOnly(),threadId:te(),rConversation:ve,me:H,topic:ne(),priority:re()});if(n.resource){n.invitation=t.AppSharingInvitation({resource:n.resource,createParticipant:function(e){return new t.Participant({href:e.href,ucwa:G,tm:oe,contactManager:Y,inConference:de.asReadOnly()})},ucwa:G})}n.mediaPlugin=X;n.sharedResources=K;r=t.AppSharingModality(n);fe.add(r,e);r.state.when("Disconnected",function(){fe.remove(e)});return r}function Tt(){s(!ke.meeting);ke.meeting=new t.OnlineMeeting({ucwa:G,threadId:te(),subject:ne(),priority:re(),conversation:ke,contactManager:Y});ke.meeting.uri.changed(ie);pe.fire();return ke.meeting}function It(){var e=[];if(le()==j.State.Disconnected)return;if(ke.phoneAudioService)e.push(ke.phoneAudioService.stop().catch());for(var t=0,n=fe();t<n.length;t++){var r=n[t];e.push(r.stop().catch())}e.push(_e.stop().catch());if(ke.audioService)e.push(ke.audioService.stop().catch());return S.waitAll(e).then(function(){if(ve)return G.send("DELETE",ve.href)})}function Mt(){if((!se||se.supportsMessaging!==false)&&Ce()&&ke.meeting){ke.meeting.state.once(t.OnlineMeeting.State.Connected,function(){if(he()&&ke.chatService.start.enabled()&&Be.state()!=t.Modality.State.Disconnected)ke.chatService.start()})}}function Ct(){if((!se||se.supportsVideo!==false)&&Ce()&&ke.meeting){ke.meeting.state.once(t.OnlineMeeting.State.Connected,function(){if(ge()&&ke.videoService.start.enabled()&&(Be.state()==t.Modality.State.Connected||Be.state()==t.Modality.State.Connecting)){e.setTimeout(function(){ke.videoService.start({video:{direction:"recvonly"}})},0)}})}}Ke();return ke}return j}();t.Conversation=j;(function(e){var t;(function(e){e.Created="Created";e.Conferenced="Conferenced";e.Conferencing="Conferencing";e.Connected="Connected";e.Connecting="Connecting";e.Disconnected="Disconnected";e.Disconnecting="Disconnecting";e.Incoming="Incoming";e.InLobby="InLobby"})(t=e.State||(e.State={}));var n;(function(e){e.AppSharing="AppSharing"})(n=e.ModalityType||(e.ModalityType={}))})(j=t.Conversation||(t.Conversation={}))})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.find;var r=e.Utils.hash;var o=e.Utils.assert;var s=e.Utils.extend;var u=e.Utils.filter;var c=e.Utils.isVoid;var d=e.Utils.foreach;var l=e.Utils.isString;var f=e.Utils.debounced;var p=e.Utils.decorated;var v=e.Utils.getOption;var h=e.Utils.isDictionary;var m=e.Utils.isNotEmptyString;var g=e.Utils.disableHtmlInText;var y=e.Utils.Task;var S=e.Utils.Model;var b=e.Utils.Promise;var w=e.Utils.Property;var E=e.Utils.Exception;var T=e.Utils.Collection;var I=e.Utils.NumProperty;var M=e.Utils.AsyncCommand;var C=e.Utils.ConstProperty;var A=e.Utils.EnabledCommand;var _=function(){function _(_){var R=_.ucwa,P=_.me,k=_.gcs,O=_.contactManager,x=_.convLogSettings,D=_.mediaPlugin,U=_.devices,N=_.sharedResources,L=_.guestName,V=_.muteNdrForMeeting,W=_.tm,B=_.settings;var j=this;var F=T({subscribed:function(){return F.get()},get:function(){return R.send("GET",{rel:"conversations"}).then(function(e){var n=function(e){return F.contains(function(n){return n[t.sHref]==e})};var r=e.links("conversation").filter(function(e){return!n(e.href)}).map(function(e){return R.send("GET",e.href).then(function(e){return y.waitAll([R.send("GET",e.link("localParticipant").href),R.send("GET",e.link("messaging").href),e.hasLink("onlineMeeting")&&R.send("GET",e.link("onlineMeeting").href).then(function(e){var n=F().filter(function(e){return!e[t.sHref]&&!!e.uri()}).map(function(e){return e.uri().toLowerCase()});var r=e.get("onlineMeetingUri","").toLowerCase();if(n.indexOf(r)>=0)throw r})])}).then(function(){if(n(e.href))throw e;var t=Y({href:e.href,threadId:R.get(e.href).get("threadId")});ie(t);return t.participants.get()}).catch()});return y.waitAll(r).then(function(){return null})})}});var G=t.ObservableResource(R,{rel:"myOnlineMeetings"},function(e){e.collection("myOnlineMeeting",[function(e){return new t.MyOnlineMeeting(R,{href:e,tm:W})}])}).myOnlineMeeting;var H=(k?k.conversationHistory:C(null)).map(function(e){return e=="Enabled"},function(e){return e?"Enabled":"Disabled"});var q=w({value:true});var z=I(0);function Y(e){s(e,{ucwa:R,me:P,clt:ee,guestName:L,sharedResources:N,contactManager:O,mediaPlugin:D,devices:U,muteNdrForMeeting:V,tm:W,settings:B});return new t.Conversation(e)}R.init().then(function(){R.restored(function(){X()});var e=R.find({rel:"conversation"}).filter(function(e){return e.get("state","")in{Connected:1,Conferenced:1}});d(e,function(e){var t=Y({href:e.href,threadId:e.get("threadId")});ie(t)})});function X(){R.send("GET",{rel:"conversations"}).then(function(n){var r=n.links("conversation").map(function(e){return e.href});for(var i=0,a=F();i<a.length;i++){var o=a[i];if(r.indexOf(o[t.sHref])===-1&&o.state()!=t.Conversation.State.Disconnected&&o.state()!=t.Conversation.State.Created){var s=[];for(var u in o.activeModalities){if(o.activeModalities[u]())s.push(u)}o.forceDisconnectConversation(E("NotFound"));W&&W.record(e.TelemetryEvent.Conversation,{action:"force_disconnect",threadId:o.threadId(),type:o.isGroupConversation()?"conf":"p2p",modalities:JSON.stringify(s)})}}})}function J(e){o(c(e)||h(e));e=e||{};var t=Y({isConference:v(e,"isConference",true),threadId:e.threadId,topic:e.topic,priority:e.priority,participants:e.participants});ie(t);return t}function K(i,a){o(m(i));var s=n(F(),function(e){return e.uri()==i});if(!s){var u=void 0;if(a&&a.wac&&i){var c=a.timeStamp||new e.Date;c.setHours(0,0,0,0);u=new t.ThreadId(c,r(i))+""}s=Y({uri:i,threadId:u});ie(s)}return s}function Q(e,n){o(c(n)||h(n));n=n||{};var r=u(F(),function(n){return n.participants.size()==1&&!n.isGroupConversation()&&(l(e)?n.participants(0).person.id().toLowerCase()===e.toLowerCase():n.participants(0).person[t.sHref]==e[t.sHref])});if(r.length>0)return r[0];var i=Y({isConference:false,threadId:n.threadId,topic:n.topic,priority:n.priority});ie(i);var a=i.createParticipant(e);i.participants.add(a);if(typeof e=="object"&&e[t.sHref])O.cacheTransientContact(e);return i}function $(){if(x){re=true;var n=R.get(k[t.sHref]);n.updated(function e(){if(!k.conversationLogs[t.sHref])return;n.updated.off(e);te()});if(x.poll!==0)e.setInterval(te,(x.poll||3600)*1e3)}return F.get().then(function(){q(false)})}var Z={};var ee=x&&new RegExp(x.type||"^(Audio|Message)Log$");var te=p([f,W&&W.monitored(e.TelemetryEvent.ConvLogs)],function(){return i(j,void 0,b,function(){var n=this;var r,o,s,u,c,d,l,f,p;return a(this,function(v){switch(v.label){case 0:r=k.conversationLogs[t.sHref];r&&R.get(r).dirty(true);v.label=1;case 1:v.trys.push([1,3,,7]);return[4,k.conversationLogs.conversationLog.get()];case 2:v.sent();return[3,7];case 3:o=v.sent();if(!o||o.code!="RequestFailed"||o.rsp.status!=409)throw o;R.get(k[t.sHref]).dirty(true);return[4,k.conversationHistory.get()];case 4:if(v.sent()=="Enabled")throw o;return[4,k.conversationHistory.set("Enabled")];case 5:v.sent();R.get(r).dirty(true);return[4,k.conversationLogs.conversationLog.get()];case 6:v.sent();return[3,7];case 7:s=[];u=R.get({rel:"conversationLogs"}).links("conversationLog");c=u.slice(0,x.size||20).map(function(e){return k.conversationLogs.conversationLog(e.href)});d=function(r){if(Z[r[t.sHref]])return"continue";Z[r[t.sHref]]=true;var o=function(){return i(n,void 0,b,function(){var e,n,i,o,s,u,c,d,l
;return a(this,function(i){switch(i.label){case 0:n=(e=ee).test;return[4,r.type.get()];case 1:if(!n.apply(e,[i.sent()]))return[2];return[4,r.conversationLogRecipient.get()];case 2:o=i.sent();if(o.length!=1)return[2];s=o[0];return[4,s.contact.href.get()];case 3:u=i.sent();c=O.get(u,{sipuri:s.sipUri(),name:s.displayName(),photo:s.contactPhoto.href()});d=new t.ThreadId(r.threadId());d.push();l=Q(c,{threadId:d+"",topic:(r.subject()||"").replace(/^(Missed )?Conversation with (.*)$/i,"")});l.attachConvLog(r);return[2]}})})}();o.catch(function(n){W&&W.record(e.TelemetryEvent.ConvLogs,{result:"failed",reason:n,href:r[t.sHref]})});s.push(o)};for(l=0,f=c.reverse();l<f.length;l++){p=f[l];d(p)}return[4,b.all(s)];case 8:v.sent();return[2]}})})});if(x){var ne=0;var re=false;R.observe("missedItems updated",function(e){var t=e.resource;var n=t.get("conversationLogsCount",0);if(n>ne){ne=n;if(re)te()}})}R.event(function(r){var i=r.resource;if(r.type=="started"&&/^(messaging|audioVideo|phoneAudio|onlineMeeting|applicationSharing)Invitation$/.test(i.rel)){var a=i.get("threadId")+"";var o=i.get("direction")=="Incoming";var s=n(F(),function(e){return e.threadId()==a});if(!s){var u=F().filter(function(e){return e.state()==t.Conversation.State.Disconnected||e.state()==t.Conversation.State.Created});if(i.rel=="onlineMeetingInvitation"){var c=i.get("onlineMeetingUri","").toLowerCase();s=n(u,function(e){return(e.uri()+"").toLowerCase()==c})}else{s=n(u,function(e){if(e.isGroupConversation()||e.participants.size()!=1)return false;var n=e.participants(0).person;if(o){var r=R.get(i.link("from").href);return(n.id()+"").toLowerCase()==(r.get("uri")+"").toLowerCase()||n[t.sHref]==r.link("contact").href}else{return n[t.sHref]==i.link("to").href}})}if(s)s[t.sInternal].processInvitation(i)}if(!s){s=Y({rInvitation:i,threadId:a,topic:g(i.get("subject","")),priority:i.get("importance","Normal")});ie(s)}if(i.rel=="applicationSharingInvitation"&&!e.Settings.mediaAgent)s.addModality(t.Conversation.ModalityType.AppSharing,{resource:i})}});function ie(e){if(!F(e.id()))F.add(e,e.id());e.historyService.unreadActivityItemsCount.changed(function(){z(F().filter(function(e){return e.historyService.unreadActivityItemsCount()>0}).length)})}function ae(e){return e.leave().catch().then(function(){return F.remove(e.id())})}return S({conversations:F.asWritable({add:A(ie),remove:A(ae)}),unreadConversationsCount:z.asReadOnly(),isHistoryEnabled:s(H,{auto:w.bool(true)}),createConversation:A(J),getConversation:A(Q),getConversationByUri:A(K),getMoreConversations:M(f($),q),syncConversationLogs:te,createMeeting:A(function(){return new t.MyOnlineMeeting(R,{tm:W})}),meetings:G.asReadOnly(),createSearchQuery:A(function(){return new t.ConversationSearchQuery(F)})})}return _}();t.ConversationsManager=_})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){"use strict";var n=e.Utils.timeStampToDate;var r=e.Utils.DataUri;var i=function(){function e(e){return t.ObservableResource(e,{rel:"communication"},function(e){e.member("conversationLogs",function(e){e.collection("conversationLog",function(e){e.collection("conversationLogRecipient",function(e){e.property("sipUri");e.property("displayName");e.member("contact",function(e){return e.property("href")});e.member("contactPhoto",function(e){return e.property("href")})});e.member("conversationLogTranscripts",function(e){e.collection("conversationLogTranscript",function(e){e.member("audioTranscript",function(e){e.property("status");e.property("duration")});e.member("messageTranscript",function(e){e.member("htmlMessage",function(e){return e.property("href",function(e){return r(e).data})});e.member("plainMessage",function(e){return e.property("href",function(e){return r(e).data})})});e.member("contact",function(e){return e.property("href")});e.property("timeStamp",n)})});e.property("type");e.property("subject");e.property("threadId");e.property("direction");e.property("modalities");e.property("creationTime",n);e.property("totalRecipientsCount")})});e.property("conversationHistory");e.property("audioPreference");e.property("phoneNumber");e.property("voipFallbackToPhoneAudioTimeOut");e.command("joinOnlineMeeting")})}return e}();t.Communication=i})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n=t.clone;var r={InvalidSetup:{identifier:"InvalidSetup",description:"Please check with the administrator of your tenant."},InternalError:{identifier:"InternalError",description:"An internal error occured. This may be a transient error. Please use exponential retry to try again. Stop retrying after 3 attempts."},Unauthorized:{identifier:"Unauthorized",description:"The user is unauthorized. Make sure the user is authenticated with a valid access token before making the request."}};var i={28e3:{code:28e3,message:"The user does not have a valid Skype for Business Online license assigned.",category:r["InvalidSetup"].identifier},28001:{code:28001,message:"Internal error while processing Windows authentication or authorization.",category:r["InternalError"].identifier},28032:{code:28032,message:"The web ticket is invalid.",category:r["Unauthorized"].identifier},28033:{code:28033,message:"The web ticket has expired.",category:r["Unauthorized"].identifier},28055:{code:28055,message:"The OAuth token is invalid.",category:r["Unauthorized"].identifier},28056:{code:28056,message:"The OAuth token has expired.",category:r["Unauthorized"].identifier},28072:{code:28072,message:"The ticket presented could not be verified, a new ticket is required.",category:r["Unauthorized"].identifier},28077:{code:28077,message:"Invalid Audience in the web ticket.",category:r["Unauthorized"].identifier},28081:{code:28081,message:"No user principal name is found in JWT security token.",category:r["Unauthorized"].identifier}};var a={1:{code:1,message:"The user appears to be homed on premise. Make sure to home the user online to use this service.",category:r["InvalidSetup"].identifier}};t.errorMapper={map:function(t,n,r,i){var a=null;if(!r||r.status<400||r.status===401){return}a=u(c(r));if(!a){a=s(n,r)}o(a,t);if(!a){i.record(e.TelemetryEvent.UnmappedError,{diagCode:c(r),diagHeader:r.headers&&r.headers["X-Ms-Diagnostics"],code:r.data&&r.data.code,subcode:r.data&&r.data.subcode,status:r.status})}}};function o(e,t){if(e){t.errorDetails=e}}function s(e,t){var i=null;if(t.status==404&&e&&/\/autodiscoverservice\.svc\/root\/oauth\/user/i.test(e.url)){i=n(a["1"]);i.category=r[a["1"].category]}return i}function u(e){var t=null;if(e){if(i[e]){t=n(i[e]);t.category=r[t.category]}}return t}function c(e){var t=e.headers["X-Ms-Diagnostics"]||"";return parseInt(t.split(";")[0],10)||null}})(t=e.Utils||(e.Utils={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){"use strict";var n=e.Utils.errorMapper;t.customAuth={wrap:function(e,t){var i=function(i,a){var o=function(e){r(e,t);return a(e).then(function(r){n.map(r,e,r,t);return r})};return e(i,o)};return i}};function r(t,n){var r=t.headers["Authorization"],i=r&&r.replace("Bearer ","");if(i&&!n.defaults.sdk_user_domain){try{var a=JSON.parse(atob(i.split(".")[1]));var o=/([\w+-.%]+)@(.*)/i.exec(a.upn);if(o&&o.length==3){n.defaults.sdk_user_alias=[o[1],e.TelemetryRecorder.PIIType.Identity];n.defaults.sdk_user_domain=n.oiiPropertyValue(o[2])}}catch(e){}}}})(t=e.Auth||(e.Auth={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(e){var t;(function(t){var n;(function(t){var n=e.Utils.guid;var r=e.Utils.keys;var i=e.Utils.hash;var a=e.Utils.async;var o=e.Utils.sleep;var s=e.Utils.extend;var u=e.Utils.indexOf;var c=e.Utils.isString;var d=e.Utils.getOption;var l=e.Utils.sha256Hash;var f=e.Utils.errorMapper;var p=e.Utils.debug.debugInfo;var v=e.Utils.repeatAndExit;var h=e.Utils.setHiddenProperty;var m=e.Utils.Task;var g=e.Utils.Model;var y=e.Utils.Symbol;var S=e.Utils.Command;var b=e.Utils.EnvInfo;var w=e.Utils.Property;var E=e.Utils.Exception;var T=e.Utils.StringEnum;var I=e.Utils.EnabledCommand;var M=e.Utils.DisabledCommand;var C=e.Utils.EInvalidArgument;var A=e.Stack.UCWA;var _=e.Auth.customAuth;var R="ucwa";var P=y("apps");var k=y("contactmanager");var O=864e5;var x=function(){function f(y){if(y===void 0){y={}}if(e.ls.bp.ctor.get())debugger;var x=w();var U=s(y.settings,e.ls.ctor.get());var N=g();var L=y.ConversationsManager||t.ConversationsManager;var V=y.telemetryManager;var W=U.cafeTenantToken;var B=!!U.muteNdrForMeeting;U.showTeamsAlert=U.showTeamsAlert||false;var j=new e.TelemetryRecorder(V,W,U.telemetry===false?{"*":{}}:U.telemetry&&U.telemetry.disabled,U.telemetry&&U.telemetry.ttt,U.tzip_url||"https://swx.cdn.skype.com/jLync/tzip/index.html");var F=w();var G=n();var H;var q=false;var z=y.initParams;var Y=y.ucwa||new A({tm:j,logs:U.logs&&U.logs.ucwa});var X;var J;var K;var Q;var $=T("showNotification","redirectClient","updateClient","none");p.api_key=U.apiKey||z&&z.apiKey;if(j&&U.apiKey)j.defaults.api_key=U.apiKey;p.sdk_session=G;p.correlation_ids=z&&z.correlationIds||{};if(j){if(U.ttt)j.defaults.ttt=true;j.defaults.sdk_session=G;j.addCorrelationIds(z)}if(U.logs){if(U.logs.saveConsole)e.Settings.saveConsole=U.logs.saveConsole;if(U.logs.size)e.Settings.logSize=U.logs.size}if(e.Settings.logHttp)w.srcheck=true;function Z(){x(f.State.SignedOut);N.suspended=Y.suspended;h(N,R,Y);var n=new t.Communication(Y);var r=new t.MePerson(Y,{guestName:F.asReadOnly(),supportsConferencing:n.joinOnlineMeeting.enabled.asReadOnly(),reportMyActivityInterval:U.reportMyActivityInterval,sendActivityTelemetry:!!U.sendActivityTelemetry,meActiveChangedDelay:U.meActiveChangedDelay,preferredDesktopEndpoint:U.pde,tm:j});var i=new t.PresenceSubscriptionManager(Y,{maxBatchSize:U.presenceSubscriptionsBatchSize,duration:U.presenceSubscriptionDuration,tm:j});var a=new t.ContactManager({ucwa:Y,psm:i,settings:U.contactManager,tm:j});h(N,k,a);var s=t.MediaPlugin&&new t.MediaPlugin(Y,j,U);var u=e.Media&&e.Media.useBrowserMedia()?t.WebRtcDevicesManager&&new t.WebRtcDevicesManager(Y):t.PluginDevicesManager&&new t.PluginDevicesManager({mediaPlugin:s,msi:U["plugin"]&&U["plugin"].download&&U["plugin"].download.msi,pkg:U["plugin"]&&U["plugin"].download&&U["plugin"].download.pkg,dmg:U["plugin"]&&U["plugin"].download&&U["plugin"].download.dmg,tm:j});var c=t.SharedResources&&t.SharedResources(s);var d=new t.PersonsAndGroupsManager({ucwa:Y,psm:i,contactmgr:a,remoteSearchResultsOnly:U.remoteSearchResultsOnly,me:r,tm:j,settings:U.pgm});Q=new L({ucwa:Y,me:r,gcs:n,guestName:F.asReadOnly(),mediaPlugin:s,contactManager:a,devices:u,sharedResources:c,convLogSettings:U.convLogSettings,muteNdrForMeeting:B,tm:j,settings:U});N.mediaPolicies=t.MediaPolicies&&new t.MediaPolicies(Y);N.personsAndGroupsManager=d;N.conversationsManager=Q;N.windows=c&&c.windows;N.monitors=c&&c.monitors;N.policies=new t.GeneralPolicies(Y);N.devicesManager=u;N.connected=Y.connected;N.collectOII=w({value:j&&j.collectOII,set:function(e){j.collectOII=e;return e}});x.when(f.State.SignedIn,function(){if(j&&U.heartbeat){e.setInterval(function(){j.record(e.TelemetryEvent.Heartbeat)},U.heartbeat*1e3)}e.setTimeout(function(){if(!Y.connected()){j&&j.record(e.TelemetryEvent.EventChannel,{result:"timeout",timeout:60,status:Y.ecstatus(),reason:Y.connected.reason})}},60*1e3);e.setTimeout(function(){if(!Y.connected()){j&&j.record(e.TelemetryEvent.EventChannel,{result:"timeout",timeout:300,status:Y.ecstatus(),reason:Y.connected.reason})}},300*1e3);Y.connected.when(true,function(){j&&j.record(e.TelemetryEvent.EventChannel,{result:"connected"})});var t=Y.connected.when(false,function(t,n){if(x()!==f.State.SigningOut&&n){j&&j.record(e.TelemetryEvent.EventChannel,{result:"lost",state:x(),reason:t});D(t,U.signIn,j);x(f.State.SignedOut,t)}});Y.appDeleted.once(true,function(e){D(e,U.signIn,j);x(f.State.SignedOut,e)});if(U.events!==false)r.available(true);if(j){j.defaults.signed_in_at=(new e.Date).toISOString();r.id.changed(function(t,n,r){t=/^sip(?:%3A|:)/i.test(t)?t.substring(4):t;j.defaults.sdk_user_id=t?l(t):void 0;var i=/([\w+-.%]+)@(.*)/i.exec(t);if(i&&i.length==3){j.defaults.sdk_user_alias=[i[1],e.TelemetryRecorder.PIIType.Identity];j.defaults.sdk_user_domain=j.oiiPropertyValue(i[2]);p.sdk_user_domain=i[2]}})}try{var n=Y.get({rel:"ms:rtc:saas:discover"});var i=n.get("conferenceId");Q.getConversationByUri(i)}catch(e){}le();if(!U.disableConversationHistory&&!H&&U.events!==false){Q.isHistoryEnabled.set.enabled.once(true,function(){if(!Q.isHistoryEnabled.auto())return;var e=q?U.replayBot.convHistoryEnableDelay||960:4.12;v(function(t){return o(e).then(function(){e*=2;return Q.isHistoryEnabled.set(true).then(t,function(e){var t=e.code=="RequestFailed"&&e.rsp.status==412;if(!t)throw e})})})})}x.once(f.State.SignedOut,function(e){le();u&&u.uninit();s&&s.uninitMedia();j&&delete j.defaults.sdk_user_id;t.dispose();Y.uninit(e)})})}function ee(e,t){var n=w();var r=S(t,n);x.changed(function(t){n(u(e,t)>=0)});return r}function te(e,t){return ee(e,a(t))}var ne=U.supportsSignIn===false?M(E("ECS")):te([f.State.SignedOut],function(t){s(t,U.signIn);if(U.onprem!==undefined)t.eopd=U.onprem;if(t.cors=="test"){t.cors=["outlook.office.com","outlook.office365.com"].indexOf(location.hostname)>=0&&["Chrome","Safari","Firefox"].indexOf(b.getBrowserName())>=0}if(location){if(/\.force\.com$/.test(location.hostname)){t.id="f07523aa-0781-4a59-9628-07c4f659c65c";t.ssrels="applications|root|xframe"}else if(/\.homedepot\.com$/.test(location.hostname)){t.origins=t.origins||[];if(c(t.origins))t.origins=[t.origins];t.origins.push("webdir3a.online.lync.com")}}if(j&&t.version)j.defaults.appVersion=t.version;p.client_id=t.client_id;if(j&&t.client_id)j.defaults.client_id=t.client_id;if(j){j.defaults.signInType=t.client_id||t.get_oauth_token?"online":"onprem";p.signin_type=j.defaults.signInType}if(j&&t.ecws)j.defaults.ecws=t.ecws;if(U.retry)t.retry=U.retry;H=!!(t.meeting||t.name);if(t.name)F(t.name);if(t.meeting){if(!t.name)throw C("name","Default display name in anonymous meetings is required.");delete t.name}if(U.lockEndpointId){if(t.id)throw new Error(".id cannot be set as it is computed automatically");if(!t.version)throw new Error(".version is mandatory");t.id=i(t.version)}if(t.auth){t.auth=_.wrap(t.auth,j)}var n=N.personsAndGroupsManager.mePerson.capabilities;if(U.enableInternalNS!==undefined)t.enableInternalNS=U.enableInternalNS;n.chat.text(r());n.chat.html(a());n.audio(o(U.supportsAudio,t.supportsAudio,t.enableInternalNS));n.video(o(U.supportsVideo,t.supportsVideo,t.enableInternalNS));n.screenSharing(o(U.supportsSharing,t.supportsSharing,t.enableInternalNS));function r(){return d(U,"supportsText",o(U.supportsMessaging,t.supportsMessaging,true))}function a(){return d(U,"supportsHtml",o(U.supportsMessaging,t.supportsMessaging,true))}function o(e,t,n){var r=typeof e!=="undefined";var i=typeof t!=="undefined";if(r&&i){return e&&t}if(r&&!i){return e}if(i){return t}return n}if(U.remotePresenceOnlyMode)U.events=false;if(U.events!==undefined)t.events=U.events;t.user=t.user||{isActive:N.personsAndGroupsManager.mePerson.active.asReadOnly(),inactivityTimeout:U.userInactivityTimeout||9e5};t.supportsWebRtc=e.Media&&e.Media.isWebRtc();var u=z&&z.correlationIds&&z.correlationIds.hostProperty||V&&V.hostname;u&&(t.hostProperty=u);p.host_property=u;x(f.State.SigningIn);var l={};K=new m("Checking client policy");function v(){var n;var r=U.checkClientPolicyInterval||O;var i=function(){e.clearInterval(n);try{if(N.personsAndGroupsManager.mePerson._clientUpdatePolicy()===$.redirectClient||N.personsAndGroupsManager.mePerson._clientUpdatePolicy()===$.updateClient)return}catch(e){if(e.message==="Disconnected")return;throw e}Y.send("GET",{rel:"policies"},{nobatch:true}).then(function(e){if(e.has($.showNotification)&&e.has($.updateClient)&&e.has($.redirectClient)){var n=e.get($.showNotification)==="Enabled";var r=e.get($.updateClient)==="Enabled";var i=e.get($.redirectClient)==="Enabled";if(r||i){Y.removeEventChannel();Y.deleteAppTemp().then(function(){t.events=false;t.ecws=false;U.events=false;Y.init(t).then(function(){Y.removeEventChannel();N.personsAndGroupsManager.mePerson._clientUpdatePolicy($.redirectClient);N.personsAndGroupsManager.mePerson.active._set(false);N.personsAndGroupsManager.mePerson.status._set("Offline");K.resolve()})})}else{N.personsAndGroupsManager.mePerson._clientUpdatePolicy(n?$.showNotification:$.none);K.resolve()}}else{N.personsAndGroupsManager.mePerson._clientUpdatePolicy($.none);K.resolve()}},function(e){D(e,U.signIn,j);x(f.State.SignedOut,e);throw e});n=e.setInterval(i,r)};i()}X=Y.init(t).then(function(e){if(U.showTeamsAlert)v();else{N.personsAndGroupsManager.mePerson._clientUpdatePolicy($.none);K.resolve()}return K.promise.then(function(){x(f.State.SignedIn);if(t.name){if(t.join_url){l.anon_join_type="onprem"}else if(t.root&&(t.token||t.auth)){var e=Y.exists({rel:"ms:rtc:saas:discover"});l.anon_join_type=e?"resource_forest":"p2p"}}})},function(e){D(e,U.signIn,j);x(f.State.SignedOut,e);throw e});if(j){for(var h in t){var g=t[h];var y=typeof g;l["sp_"+h]=/number|boolean/.test(y)?g:y=="string"?"<hash:"+i(g)+">":"<type:"+y+">"}j.monitor(X,e.TelemetryEvent.SignIn,l,{timeout:3*60*1e3})}return X});var re=te(r(f.State),function(){switch(x()){case f.State.SignedOut:return;case f.State.SigningIn:x(f.State.SigningOut);X.cancel(E("SignedOut"));return X.catch();case f.State.SigningOut:return J;case f.State.SignedIn:x(f.State.SigningOut);J=Y.deleteApp().then(function(e){x(f.State.SignedOut)},function(e){x(f.State.SignedOut,e);throw e});j&&j.monitor(J,e.TelemetryEvent.SignOut,{timeout:1e4});return J}});var ie=te([f.State.SignedIn],function(e){var t=N.conversationsManager.createConversation({isConference:false,topic:e.topic,priority:e.priority,threadId:e.threadId});var n=t.chatService;return n.start({to:e.to,message:e.message,context:e.context,contextType:e.contextType,boundary:e.boundary,operationId:e.operationId,sessionContext:e.sessionContext}).then(function(){return t})});var ae=te([f.State.SignedIn],function(e){var t=N.conversationsManager.createConversation({isConference:false,threadId:e.threadId});var n=e.video?t.videoService.start(e):t.audioService.start(e);return n.then(function(){return t})});var oe=te([f.State.SignedIn],function(e){var n=N.conversationsManager.createConversation({isConference:false,threadId:e.threadId});var r=n.addModality(t.Conversation.ModalityType.AppSharing);return r.start(e).then(function(){return n})});var se=te([f.State.SignedIn],function(e){if(e===void 0){e={}}var t=N.conversationsManager.createConversation({isConference:true,topic:e.topic,priority:e.priority,threadId:e.threadId});return t.addMeeting().start({uri:e.uri,name:e.name}).then(function(){return t.chatService.start()}).then(function(){return t})});var ue=ee([f.State.SignedIn],function(){return Y.getSnapshot()});function ce(){var e=JSON.stringify({session:G,logs:U.logs&&U.logs.ucwa&&Y.logs,snapshot:U.logs&&U.logs.ucwa&&Y.getSnapshot()});e=e.replace(/([-\.\w]+@[-\.\w]+)/gim,"<<$1>>");e=e.replace(/\x22(data:text\/\w+(?:;charset=utf-8)?,)(.+?)\x22/gim,'"$1<<$2>>"');e=e.replace(/(\/messages\x22\],\[\x22)(.+?)(\x22\])/gim,"$1<<$2>>$3");e=e.replace(/\x22(name|title|department|company|workPhoneNumber|subject)\x22:\x22(.*?)\x22/gim,'"$1":"<<$2>>"');var t={},n=0;return e.replace(/<<(.+?)>>/gim,function(e,r){return"PII-"+(t[r]=t[r]||++n)})}var de=w({value:false});function le(){if(!U.replayBot){de(false,E("DisabledByECS"));return}if(x()!=f.State.SignedIn){de(false,E("NotSignedIn"));return}if(!Y.exists({rel:"replayMessage"})){de(false,E("Unsupported"));return}if(Q.isHistoryEnabled()){de(false,E("ConversationHistoryEnabled"));return}try{if(e.localStorage.getItem(U.replayBot.key)){de(false,E("AlreadyReplayed-LS"));return}}catch(e){}try{var t=new RegExp("\\breplaybot="+U.replayBot.key,"i");if(t.test(document.cookie)){de(false,E("AlreadyReplayed-Cookie"));return}}catch(e){de(false,E("CookieReadFailure"));return}de(true,"NoPriorState");q=true}var fe=S(function(t,n,r,i){var a=["--ef12279a-4107-40f9-8191-3765f3ebb9b1","Content-Type: application/json","",JSON.stringify({idleTimeoutInSeconds:U.replayBot.idleTimeoutInSeconds,replayDisplayName:t,replayMessage:"CID:1",terminationMessage:"CID:2",toastMessage:i}),"--ef12279a-4107-40f9-8191-3765f3ebb9b1","Content-Type: text/html","Content-Id: 1","",n,"--ef12279a-4107-40f9-8191-3765f3ebb9b1","Content-Type: text/html","Content-Id: 2","",r,"--ef12279a-4107-40f9-8191-3765f3ebb9b1--",""].join("\r\n");var o=Y.send("POST",{rel:"replayMessage"},{headers:{"Content-Type":'multipart/related;boundary=ef12279a-4107-40f9-8191-3765f3ebb9b1;type="application/json"'},data:a}).then(function(t){try{e.localStorage.setItem(U.replayBot.key,"true")}catch(e){}try{document.cookie="replaybot="+U.replayBot.key+";max-age=15552000"}catch(e){}}).finally(le);j&&j.monitor(o,e.TelemetryEvent.ReplayMessage,{displayName:t});return o},de);if(!e.isUnitTested){if(!e.window[P]){h(e.window,P,[])}e.window[P].push(N)}Z();return s(N,{signInManager:g({state:x.asReadOnly(),createPasswordSignInParameter:I(function(e){return s(e,{type:"Password"})}),createImplicitOAuthSignInParameter:I(function(e){return s(e,{type:"ImplicitOAuth"})}),signIn:ne,signOut:re}),startMessaging:ie,startAudioVideo:ae,startAppSharing:oe,startMeeting:se,getSnapshot:ue,getErrorReport:ce,conversationsManager:Q,replayMessage:fe})}return f}();t.Application=x;(function(e){var t;(function(e){})(t=e.Options||(e.Options={}));var n;(function(e){e.SignedOut="SignedOut";e.SignedIn="SignedIn";e.SigningOut="SigningOut";e.SigningIn="SigningIn"})(n=e.State||(e.State={}))})(x=t.Application||(t.Application={}));function D(e,t,n){if(e&&typeof e=="object"){var r=e.rsp||e.response||{};var i=t&&t.noretry;var a=i&&i.indexOf("onprem")>=0&&r.data&&r.data.code=="NotFound"&&r.status==404&&e.req&&/\/autodiscoverservice\.svc\/root\/oauth\/user/i.test(e.req.url);var o=i&&i.indexOf("notsfbuser")>=0&&r&&r.headers&&/^28000/.test(r.headers["X-Ms-Diagnostics"]);var u=i&&i.indexOf("403crossdomain")>=0&&r&&r.status==403&&r.headers&&/^28070/.test(r.headers["X-Ms-Diagnostics"]);s(e,{debug:{code:r.data&&r.data.code,subcode:r.data&&r.data.subcode,status:r.status,diag:r.headers&&r.headers["X-Ms-Diagnostics"],isRetryable:!(a||o||u)}});f.map(e,e.req,e.rsp||e.response,n)}}})(n=t.Internal||(t.Internal={}))})(t=e.Model||(e.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));(function(e){var t;(function(t){var n;(function(n){if(e.ttt)e.ttt.ctor=n.Internal.Application;n.Application=t.isUnitTested?n.Internal.Application:function t(r){try{var i=e.$window.localStorage;var a="lwsdk.ttt";var o="ecs";if(/^(null|ecs)$/.test(i.getItem(a))){if(r&&r.settings&&r.settings.ttt)i.setItem(a,o);else if(i.getItem(a)==o)i.removeItem(a)}}catch(e){}return e.ttt?e.ttt.root(r):new n.Internal.Application(r)}})(n=t.Model||(t.Model={}))})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict";var t;(function(e){var t;(function(t){var n=t.Utils.extend;var r=t.Utils.isObject;function i(){try{e.onExperienceLoaded({init:function(e,i){i&&i({application:function(i){if(i===void 0){i={}}var a=e.config||{};var o=e.initParams||{};var s=r(i.settings)?i.settings:{};n(s,a);n(s,a.jLync);delete s.jLync;if(a.telemetry){s.cafeTenantToken=a.telemetry.cafeTenantToken;delete s.telemetry.cafeTenantToken}if(o.apiKey)s.apiKey=o.apiKey;n(i,{settings:s});n(i,{initParams:o});return new t.Model.Internal.Application(i)}})}})}catch(e){}}t.onLoaded=i;i()})(t=e.Web||(e.Web={}))})(t||(t={}));"use strict"}(Skype=window.Skype||{});